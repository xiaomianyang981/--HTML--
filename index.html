<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>芋圆机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!--
    ============================================================
    项目架构说明 - UI主题管理系统
    ============================================================
    
    【当前UI主题】iPhone风格模拟器
    
    【全局UI管理】
    - UI_CONFIG: 位于 <script> 顶部，集中配置UI主题和类名
    - UIManager: 全局UI管理器，提供统一的UI元素生成方法
    - CSS变量系统: :root 中定义了30+个颜色变量
    - CSS分段注释: 按功能模块分段（iPhone特定/通用组件/聊天消息等）
    
    【页面/视图列表】（11个弹窗 + 1个主屏幕）
    1. 主屏幕 (home-screen) - 好友卡片、天气小部件
    2. API设置 (apiModal) - API配置和模型选择
    3. API预设 (apiPresetModal) - 保存和加载API预设
    4. 好友列表 (friendListModal) - 好友管理
    5. 添加好友 (addFriendModal) - 创建新好友
    6. 聊天界面 (chatModal) - 主要对话界面
    7. 语音输入 (voiceModal) - 语音转文本
    8. 相机描述 (cameraDescModal) - 上传图片描述
    9. 图片查看 (imageDescModal) - 查看AI生成图片
    10. 删除确认 (confirmDeleteModal) - 删除好友确认
    11. 心声历史 (heartVoiceHistoryModal) - 查看历史心声
    12. 心声删除 (hvDeleteModal) - 删除心声确认
    
    【如何添加新页面】
    使用 UIManager 创建统一的UI组件：
    
    ```javascript
    // 1. 创建状态栏（永远保持现有格式）
    const statusBar = UIManager.createStatusBar();
    
    // 2. 创建各种按钮
    const primaryButton = UIManager.createButton('确认', { type: 'primary' });
    const backButton = UIManager.createBackButton({ onclick: 'goBack()' });
    const closeButton = UIManager.createCloseButton({ onclick: 'closeModal()' });
    const iconButton = UIManager.createIconButton('fas fa-heart', '喜欢');
    
    // 3. 创建输入框
    const textInput = UIManager.createInput({ placeholder: '请输入内容', id: 'myInput' });
    const chatInput = UIManager.createInput({ style: 'chat', placeholder: '发送消息...' });
    const textarea = UIManager.createTextarea({ placeholder: '多行文本', rows: 5 });
    
    // 4. 创建卡片
    const settingsCard = UIManager.createCard('设置内容', { type: 'settings' });
    const friendCard = UIManager.createCard('好友信息', { type: 'friend' });
    const gameCard = UIManager.createCard('游戏内容', { type: 'game' });
    
    // 5. 创建列表
    const friendsList = UIManager.createList(friendItems, { type: 'friends' });
    const modelPickerList = UIManager.createList(modelItems, { type: 'model-picker' });
    const listItem = UIManager.createListItem('列表项内容', { type: 'friend' });
    
    // 6. 创建桌面图标
    const appIcon = UIManager.createDesktopIcon('fas fa-chat', '聊天', { onclick: 'openChat()' });
    const dockIcon = UIManager.createDesktopIcon('fas fa-home', '', { type: 'dock' });
    
    // 示例：创建完整页面
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            ${UIManager.createStatusBar()}
            <div class="modal-header">
                ${UIManager.createBackButton({ onclick: 'closeModal()' })}
                <h1>页面标题</h1>
                ${UIManager.createCloseButton()}
            </div>
            <div class="modal-body">
                ${UIManager.createInput({ placeholder: '搜索...', id: 'searchInput' })}
                ${UIManager.createCard('卡片内容', { type: 'settings' })}
            </div>
            <div class="modal-footer">
                ${UIManager.createButton('取消', { type: 'secondary' })}
                ${UIManager.createButton('确认', { type: 'primary' })}
            </div>
        </div>
    `;
    ```
    
    【支持的组件类型】
    - 状态栏：createStatusBar() - 永远保持现有格式不变
    - 按钮：createButton(), createIconButton(), createBackButton(), createCloseButton()
    - 输入框：createInput(), createTextarea() - 支持default和chat样式
    - 卡片：createCard() - 支持settings/friend/game/summary/worldbook等类型
    - 列表：createList(), createListItem() - 支持friends/model-picker等类型  
    - 桌面：createDesktopIcon() - 支持app/dock两种类型
    
    【如何切换UI主题】（例如：iPhone → Android）
    步骤1: 修改 UI_CONFIG.theme = 'android'
    步骤2: 找到CSS中的 "iPhone特定UI样式" 分段注释
    步骤3: 替换/禁用iPhone特定样式（.notch, .iphone-container等）
    步骤4: 添加Android风格样式（状态栏、导航栏等）
    步骤5: UIManager 会自动应用新配置
    
    【代码组织】
    - 第1-3500行: HTML结构和CSS样式
    - 第3500-4400行: 所有弹窗的HTML模板
    - 第4400-12450行: JavaScript逻辑（UI_CONFIG在最开头）
    
    ============================================================
    -->
    
    <style>
        :root {
            /* ========== 全局高度适配变量 ========== */
            /* 顶部栏高度定义 */
            --status-bar-height: 50px;
            --status-bar-height-hidden: 0px;
            --header-base-height: 40px;
            --header-base-height-hidden: 36px;
            --header-height-normal: calc(var(--header-base-height) + env(safe-area-inset-top, 0px));
            --header-height-hidden: calc(var(--header-base-height-hidden) + env(safe-area-inset-top, 0px));

            /* 计算内容区和底部区的高度 */
            --total-header-height: calc(var(--status-bar-height) + var(--header-height-normal));
            --total-header-height-hidden: calc(var(--status-bar-height-hidden) + var(--header-height-hidden));

            /* ========== 低饱和度冷色调配色方案 ========== */
            /* 品牌/主题色 - 低饱和冷调 */
            --color-primary: #d4e3f0;           /* 浅蓝主色 */
            --color-secondary: #dfe8f0;         /* 浅灰蓝次要色 */
            --color-accent: #c8dce8;            /* 浅青强调色 */

            /* 背景色 - 干净冷调 */
            --color-background: #f5f8fa;        /* 主背景：极浅灰蓝 */
            --color-bg-white: #fafbfc;          /* 白色背景：微带蓝调 */
            --color-widget-bg: #f0f4f7;         /* 小部件背景 */
            --color-bg-hover: #eef2f5;          /* 悬停背景 */
            --color-bg-active: #e5ebf0;         /* 激活背景 */
            --color-bg-pressed: #dce3e8;        /* 按下背景 */
            --color-bg-light: #f7f9fb;          /* 浅背景 */
            --color-bg-input: #f3f6f9;          /* 输入框背景 */
            --color-bg-selected: #eef5fa;       /* 选中背景 */
            --color-bg-disabled: #e8ecf0;       /* 禁用背景 */
            --color-bg-user-msg: #e8f2f7;       /* 用户消息背景 */
            --color-bg-ai-msg: #e6f0f5;         /* AI消息背景 */

            /* 文字颜色 - 柔和不刺眼 */
            --color-text: #6b7d8f;              /* 主文字：柔和灰蓝 */
            --color-text-darker: #3d4d5c;       /* 最深文字 */
            --color-text-dark: #4a5968;         /* 深色文字 */
            --color-text-medium: #7a8a9a;       /* 中性文字 */
            --color-text-light: #9aa8b5;        /* 浅灰文字 */
            --color-text-lighter: #b5c1cc;      /* 更浅文字 */
            --color-text-muted: #c5d0da;        /* 最淡文字 */
            --color-text-placeholder: #8b99a8;  /* 占位符文字 */

            /* 边框/分割线 - 轻盈纤细 */
            --color-border: #e0e7ed;            /* 标准边框 */
            --color-border-light: #eaeef2;      /* 浅边框 */
            --color-border-lighter: #f0f3f6;    /* 更浅边框/分割线 */
            --color-border-widget: #e8edf2;     /* 小部件边框 */
            --color-border-input: #dce3e9;      /* 输入框边框 */

            /* 状态色 - 低饱和度版本 */
            --color-success: #7fbf9f;           /* 成功绿色 */
            --color-error: #d89595;             /* 错误红色 */
            --color-danger: #c58585;            /* 危险红色 */
            --color-warning-bg: #faf5e6;        /* 警告背景 */
            --color-warning-border: #e5d9b3;    /* 警告边框 */
            --color-warning-text: #998866;      /* 警告文字 */

            /* 柔和阴影 - 玻璃拟态 */
            --box-shadow: 0 8px 32px rgba(107, 125, 143, 0.06);
            --box-shadow-hover: 0 12px 40px rgba(107, 125, 143, 0.08);
            --box-shadow-light: 0 4px 16px rgba(107, 125, 143, 0.04);
            
            /* 玻璃拟态效果 */
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-blur: blur(20px);
        }

        /* ============================================================
           全局基础样式
           ============================================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(135deg, 
                #f5f8fa 0%, 
                #eef4f8 50%, 
                #f0f6fa 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ============================================================
           动画效果定义
           ============================================================ */

        @keyframes fade-in-scale {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s ease-out forwards;
            will-change: transform, opacity;
        }

        .widget {
            border-radius: 26px;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: var(--box-shadow);
        }

        /* ============================================================
           iPhone特定UI样式 - 刘海、圆角、状态栏等
           如需切换到其他UI风格，重点修改此部分
           ============================================================ */

        .iphone-container {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            background-color: var(--color-background);
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            height: 50px;
            background: rgba(250, 251, 252, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 26px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #6b7d8f;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid rgba(224, 231, 237, 0.25);
            position: sticky;
            top: 0;
            z-index: 101;
        }

        /* 非主屏幕页面的状态栏统一与返回栏保持玻璃拟态 */
        /* 使用通用选择器确保所有弹窗页面的状态栏都是玻璃拟态，无需手动添加 */
        .modal .status-bar {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
        }

        .time {
            font-weight: 700;
        }

        .status-icons i {
            margin-left: 6px;
        }

        .main-content {
            flex: 1;
            padding: 20px 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-overflow-scrolling: touch;
        }

        .home-screen {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding-bottom: 20px;
        }

        .frost-widget {
            width: 88%;
            height: 120px;
            background: var(--color-widget-bg);
            padding: 16px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 26px;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: var(--box-shadow);
        }

        .widget-left {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: var(--color-text);
        }

        .widget-weather {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .widget-weather i {
            color: var(--color-secondary);
            font-size: 22px;
        }

        .widget-temp {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-secondary);
        }

        .widget-greeting {
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.6);
            transition: background 0.2s ease, color 0.2s ease;
        }

        .widget-greeting:focus {
            outline: none;
            background: var(--color-bg-white);
            color: var(--color-text);
        }


        .home-header {
            width: 88%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .home-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        .avatar-section {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            z-index: 2;
        }

        .avatar {
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid white;
            box-shadow: 0 6px 16px rgba(120, 119, 133, 0.12);
            z-index: 3;
            overflow: hidden;
        }

        .avatar i {
            font-size: 40px;
            color: white;
        }

        .info-card {
            width: 90%;
            height: 100px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            position: absolute;
            top: 40px;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 15px;
        }

        .user-info {
            text-align: left;
        }

        .user-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .user-status {
            font-size: 14px;
            color: var(--color-primary);
            font-weight: 500;
        }

        .icons-section {
            width: 90%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }

        .left-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 8px 20px rgba(240, 214, 215, 0.3);
            color: white;
            font-size: 28px;
            cursor: pointer;
        }

        .right-icons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 15px;
            width: 130px;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }

        .app-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-grid {
            width: 88%;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-auto-rows: 100px;
            gap: 16px;
            justify-items: center;
            align-items: start;
        }

        .app-grid-offset {
            margin-top: 24px;
        }

        .app-item {
            width: 100%;
            max-width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        .app-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
        }

        .app-item:hover .app-icon {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-name {
            font-size: 12px;
            color: var(--color-text);
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }



        .message-icon {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
        }

        .feixin-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
        }

        .book-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        }

        .settings-icon {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent) 100%);
        }

        .brush-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
        }

        .dock {
            height: 96px;
            min-height: 96px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%, rgba(255, 255, 255, 0.75) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid rgba(120, 119, 133, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 24px 16px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 -8px 24px rgba(120, 119, 133, 0.06);
        }

        .dock-icon {
            width: 75px;
            height: 75px;
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            color: white;
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
            transition: transform 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }

        .dock-icon:hover {
            transform: scale(1.05);
        }

        .phone-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
        }

        .novel-icon {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
        }

        .forum-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        }

        /* ============================================================
           通用组件样式 - 模态窗口、弹窗、小部件等
           这些样式可跨UI主题复用
           ============================================================ */

        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        /* API 配置弹窗全屏（手机内）样式 */
        #apiModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #apiModal .modal-header {
            border-bottom: 1px solid var(--color-border-lighter);
            /* padding由统一适配逻辑控制 */
        }

        #apiModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 22px 26px;
        }

        #apiModal .form-control {
            border-radius: 14px;
        }

        #apiModal .btn {
            border-radius: 14px;
        }

        .model-picker {
            position: relative;
            width: 100%;
        }

        .model-picker-button {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border: 1px solid var(--color-border);
            border-radius: 14px;
            background: var(--color-bg-white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: var(--color-text-dark);
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .model-picker-button:focus-visible {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(240, 214, 215, 0.12);
        }

        .model-picker-button .caret {
            margin-left: 10px;
            font-size: 12px;
            color: var(--color-text-light);
        }

        .model-picker-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            max-height: 260px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-light);
            border-radius: 14px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .model-picker-list.is-open {
            display: block;
        }

        .model-picker-item {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            font-size: 14px;
            color: var(--color-text-dark);
            cursor: pointer;
        }

        .model-picker-item:hover {
            background: var(--color-widget-bg);
        }

        .model-picker-item.is-selected {
            background: rgba(240, 214, 215, 0.2);
            color: var(--color-primary);
            font-weight: 600;
        }

        /* 聊天模态窗口全屏样式 */
        #chatModal {
            position: fixed;
            background-color: transparent;
            justify-content: center;
            align-items: center;
        }

        #chatModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg-white);
            animation: none;
            overflow: hidden;
            position: relative;
        }

        #chatModal .modal-header {
            background-color: var(--color-bg-white);
            border-bottom: 1px solid var(--color-widget-bg);
            display: flex;
            align-items: center;
            /* padding和height由统一适配逻辑控制 */
        }

        #chatModal .modal-header h3 {
            flex: 1;
            text-align: center;
            margin: 0;
            color: var(--color-text);
            font-size: 18px;
            font-weight: 600;
        }

        /* API警告样式 */
        .api-warning {
            background-color: var(--color-warning-bg);
            border-bottom: 1px solid var(--color-warning-border);
            padding: 12px 20px;
            color: var(--color-warning-text);
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }

        .preset-drawer-item:hover {
            background: var(--color-bg-disabled) !important;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--color-text-dark);
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--color-text-light);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-close:hover {
            background-color: var(--color-bg-light);
        }

        /* 自定义错误弹窗样式 */
        #customErrorModal .modal-content {
            width: 80%;
            max-width: 350px;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            animation: fade-in-scale 0.3s ease-out forwards;
        }

        #customErrorModal h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 12px;
        }

        #customErrorModal p {
            font-size: 14px;
            color: var(--color-text-medium);
            margin-bottom: 24px;
            word-break: break-all;
        }

        #customErrorModal .btn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
        }

        .cute-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: cute-toast-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cute-toast-pop {
            from {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .cute-toast-content {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(222, 190, 235, 0.25);
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .cute-toast-content p {
            color: var(--color-bg-white);
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 消息通知横幅 */
        .msg-notif-banner {
            position: fixed;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 400px;
            background: var(--color-bg-white);
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            padding: 12px 14px;
            gap: 12px;
            z-index: 10000;
            transition: top 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .msg-notif-banner.is-visible {
            top: 36px;
        }

        .msg-notif-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: var(--color-bg-white);
            font-size: 16px;
        }

        .msg-notif-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .msg-notif-body {
            flex: 1;
            min-width: 0;
        }

        .msg-notif-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-darker);
            line-height: 1.3;
        }

        .msg-notif-text {
            font-size: 13px;
            color: var(--color-text-placeholder);
            line-height: 1.3;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 聊天窗口按钮样式 */
        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button id="backToFriendList"><i class="fas fa-chevron-left"></i></button> */
        #backToFriendList {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--color-text);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            margin-right: 10px;
        }


        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            height: 48px;
            padding: 0 18px;
            border: 1.5px solid rgba(224, 231, 237, 0.6);
            border-radius: 16px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #4a5968;
            font-weight: 400;
        }

        textarea.form-control {
            height: auto;
            padding: 14px 18px;
            min-height: 48px;
            resize: none;
        }

        #modelSelect {
            height: 48px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .form-control:focus {
            outline: none;
            border-color: rgba(212, 227, 240, 0.8);
            box-shadow: 0 4px 16px rgba(107, 125, 143, 0.08);
            background: rgba(255, 255, 255, 0.75);
        }

        /* 占位符样式 */
        .form-control::placeholder,
        .form-control::-webkit-input-placeholder {
            color: #9aa8b5;
            opacity: 0.7;
            font-weight: 300;
        }

        .form-control::-moz-placeholder {
            color: #9aa8b5;
            opacity: 0.7;
            font-weight: 300;
        }

        .input-hint {
            margin-top: 6px;
            color: var(--color-text-light);
            font-size: 12px;
        }

        .btn {
            padding: 14px 24px;
            height: 50px;
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg, 
                rgba(200, 220, 240, 0.7) 0%, 
                rgba(212, 227, 240, 0.7) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: rgba(74, 89, 104, 0.9);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 125, 143, 0.12);
            background: linear-gradient(135deg, 
                rgba(200, 220, 240, 0.85) 0%, 
                rgba(212, 227, 240, 0.85) 100%);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-secondary {
            background: rgba(240, 244, 247, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: #7a8a9a;
        }

        .btn-secondary:hover {
            background: rgba(240, 244, 247, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(107, 125, 143, 0.08);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
            white-space: nowrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* 状态消息样式 */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background-color: rgba(72, 187, 120, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(72, 187, 120, 0.2);
            display: block;
        }

        .status-message.error {
            background-color: rgba(245, 101, 101, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(245, 101, 101, 0.2);
            display: block;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-widget-bg);
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 聊天界面样式 */
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-widget-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--color-bg-white);
            /* 禁用系统长按菜单和文本选择 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        /* ============================================================
           聊天消息样式
           消息气泡、图片、语音等核心聊天功能样式
           ============================================================ */

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 70%;
            word-wrap: break-word;
            word-break: break-word;
            font-size: 15px;
            line-height: 1.5;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            animation: messageAppear 0.3s ease-out;
            height: auto;
            min-height: auto;
            overflow: visible;
            /* 禁用文本选择和系统菜单 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 禁用消息容器的文本选择和系统菜单 */
        .message.user,
        .message.ai {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .message.user {
            background-color: var(--color-bg-user-msg) !important;
            color: var(--color-text-darker);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.ai,
        .message.assistant {
            background-color: var(--color-bg-ai-msg) !important;
            color: var(--color-text-darker);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }

        .reply-quote {
            max-width: 80%;
            font-size: 12px;
            color: var(--color-text-medium);
            background: rgba(0, 0, 0, 0.06);
            padding: 6px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid rgba(0, 0, 0, 0.12);
            word-break: break-word;
            /* 禁用长按菜单 */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .reply-quote.user {
            margin-left: auto;
        }

        .reply-quote.ai {
            margin-right: auto;
        }

        .reply-preview {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            background: var(--color-bg-light);
            color: var(--color-text-medium);
            font-size: 12px;
            margin-bottom: 8px;
        }

        .reply-preview-text {
            flex: 1;
            white-space: normal;
            overflow: visible;
            word-break: break-word;
        }

        .reply-preview-close {
            border: none;
            background: transparent;
            color: var(--color-text-light);
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .image-upload-pill {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: var(--color-widget-bg);
            color: var(--color-primary);
            font-size: 12px;
            margin-bottom: 8px;
            border: 1px dashed rgba(240, 214, 215, 0.35);
        }

        .image-upload-thumb {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .image-upload-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-upload-close {
            border: none;
            background: transparent;
            color: var(--color-primary);
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .message-image {
            display: block;
            width: 100%;
            max-width: 220px;
            border-radius: 12px;
            margin-top: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .message-image-wrap {
            position: relative;
            display: inline-block;
            margin-top: 6px;
            border-radius: 12px;
            overflow: hidden;
        }

        .message-image-wrap.user {
            margin-left: auto;
        }

        .message-image-wrap.ai {
            margin-right: auto;
        }

        .message-image.desc-thumb {
            width: 120px;
            height: 120px;
            max-width: none;
            object-fit: cover;
            border-radius: 12px;
        }

        .message-image-hint {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
            pointer-events: none;
        }

        .image-desc-box {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 12px;
            resize: none;
            height: 110px;
            font-size: 14px;
            font-family: inherit;
            background: var(--color-bg-hover);
            color: var(--color-text-dark);
        }

        .image-confirm-popover {
            position: fixed;
            display: none;
            z-index: 2300;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            font-size: 12px;
            color: var(--color-text-dark);
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .image-confirm-actions {
            display: flex;
            gap: 8px;
        }

        .image-confirm-btn {
            border: none;
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .image-confirm-btn.yes {
            background: var(--color-primary);
            color: var(--color-bg-white);
        }

        .image-confirm-btn.no {
            background: var(--color-border-lighter);
            color: var(--color-text-medium);
        }

        .message-recalled-wrapper {
            display: flex;
            justify-content: center;
        }

        .message-recalled {
            font-size: 12px;
            color: var(--color-text-light);
            background: rgba(0, 0, 0, 0.06);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .message-action-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2200;
            background: rgba(0, 0, 0, 0.05);
        }

        .message-action-menu {
            position: absolute;
            display: flex;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.14);
            transform: scale(0.96);
            opacity: 0;
            transition: transform 0.16s ease, opacity 0.16s ease;
        }

        .message-action-menu.is-open {
            transform: scale(1);
            opacity: 1;
        }

        .message-action-item {
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: var(--color-text-dark);
            border-radius: 12px;
            padding: 6px 8px;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }

        .message-action-item i {
            font-size: 16px;
        }

        .message-action-item:active {
            transform: scale(0.95);
        }

        .message-action-item.is-disabled {
            opacity: 0.45;
            pointer-events: none;
        }

        /* ========== 多选模式样式 ========== */
        .multi-select-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        .multi-select-header .multi-select-count {
            flex: 1;
            text-align: center;
            color: var(--color-text);
            font-size: 16px;
            font-weight: 600;
        }

        .multi-select-header .multi-select-cancel-btn {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .multi-select-header .multi-select-cancel-btn:active {
            background-color: var(--color-widget-bg);
        }

        .multi-select-footer {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px 12px 20px;
            background-color: var(--color-bg-white);
            border-top: 1px solid var(--color-widget-bg);
            flex-shrink: 0;
        }

        .multi-select-delete-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: var(--color-widget-bg);
            color: var(--color-danger);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(120, 119, 133, 0.1);
        }

        .multi-select-delete-btn:active {
            transform: scale(0.93);
            background-color: #efe8e6;
        }

        .multi-select-checkbox {
            display: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--color-border-input);
            background-color: var(--color-bg-white);
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            align-self: center;
        }

        .multi-select-checkbox.is-checked {
            border-color: var(--color-primary);
            background-color: var(--color-primary);
        }

        .multi-select-checkbox.is-checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
            color: var(--color-bg-white);
        }

        body.multi-select-active #chatMessages>div[data-msg-id] {
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px;
            cursor: pointer;
        }

        body.multi-select-active #chatMessages>div[data-msg-id] .multi-select-checkbox {
            display: flex;
        }

        .multi-select-confirm-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2001;
            background-color: rgba(0, 0, 0, 0.3);
            justify-content: center;
            align-items: center;
        }

        .multi-select-confirm-box {
            background-color: white;
            border-radius: 30px;
            padding: 20px 25px;
            width: 75%;
            max-width: 260px;
            box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2);
            text-align: center;
        }

        .multi-select-confirm-box h3 {
            margin: 0 0 10px 0;
            color: var(--color-text);
            font-size: 15px;
            font-weight: 600;
        }

        .multi-select-confirm-box p {
            margin: 0 0 15px 0;
            color: var(--color-text);
            font-size: 13px;
        }

        .multi-select-confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .multi-select-confirm-actions button {
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            min-width: 70px;
            transition: all 0.2s ease;
        }

        #multiSelectConfirmYes {
            background-color: var(--color-danger);
            color: white;
            border: none;
        }

        #multiSelectConfirmNo {
            background-color: white;
            color: var(--color-text);
            border: 1px solid var(--color-widget-bg);
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input-area-wrap.chat-extra-open .chat-input-row {
            display: none !important;
        }

        .chat-input-area-wrap.chat-extra-open .chat-function-row {
            display: none !important;
        }

        .chat-extra-panel {
            display: none;
            margin-top: 8px;
            padding: 12px 10px;
            border-radius: 14px;
            background: #f6f6f7;
            border: 1px solid var(--color-border-light);
        }

        .chat-extra-panel.is-open {
            display: block;
        }

        .chat-extra-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px 10px;
        }

        .chat-extra-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 6px;
            border-radius: 14px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-lighter);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .chat-extra-item.is-placeholder {
            background: var(--color-bg-hover);
            border-style: dashed;
            color: var(--color-text-muted);
            cursor: default;
            box-shadow: none;
        }

        .chat-extra-item.is-placeholder .chat-extra-icon {
            background: #f1f1f1;
            color: var(--color-text-muted);
        }

        .chat-extra-item:active {
            transform: scale(0.98);
        }

        .chat-extra-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: var(--color-bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--color-text-medium);
        }

        .chat-extra-label {
            font-size: 12px;
            color: var(--color-text-medium);
            text-align: center;
            line-height: 1.2;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 20px;
        }

        .chat-send-btn {
            padding: 0 20px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        /* 刘海模拟 */
        .notch {
            display: none;
        }

        /* 好友列表样式 */
        .friend-list {
            max-height: 100%;
            overflow-y: auto;
            padding: 16px !important;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 12px;
            background: var(--color-bg-white);
            backdrop-filter: none;
            box-shadow: 0 2px 8px rgba(120, 119, 133, 0.05);
            cursor: pointer;
            transition: background 0.15s ease;
            border: none;
        }

        .friend-item:hover {
            background: var(--color-widget-bg);
            transform: none;
            box-shadow: 0 2px 12px rgba(120, 119, 133, 0.08);
        }

        .friend-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(240, 214, 215, 0.1);
        }

        .friend-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            margin-right: 14px;
            overflow: hidden;
            box-shadow: none;
            flex-shrink: 0;
            border: none;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 2px;
            font-size: 15px;
            letter-spacing: 0;
        }

        .friend-persona {
            color: var(--color-text);
            font-size: 13px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            overflow: hidden;
            line-height: 1.3;
        }

        .no-friends {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 40px 20px;
            text-align: center;
        }

        /* 头像上传样式 */
        .avatar-upload-preview {
            width: 84px;
            height: 84px;
            border: 2px dashed var(--color-primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: var(--color-bg-hover);
            transition: border-color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
            margin: 0 auto 15px;
            color: var(--color-primary);
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .avatar-upload-preview:hover {
            border-color: var(--color-primary);
            background-color: var(--color-widget-bg);
            transform: scale(1.05);
        }

        .avatar-upload-preview i {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .avatar-upload-preview p {
            font-size: 12px;
            margin: 0;
            text-align: center;
        }

        .avatar-upload-preview.has-image {
            background-color: transparent;
            border-color: transparent;
        }

        .avatar-upload-preview.has-image i,
        .avatar-upload-preview.has-image p {
            display: none;
        }

        .profile-widget-card {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.2s ease;
        }

        .profile-widget-feedback {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .profile-widget-feedback.is-active {
            opacity: 1;
        }

        .settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: linear-gradient(180deg, var(--color-bg-white) 0%, var(--color-widget-bg) 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .settings-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 16px;
            border-bottom: 1px solid rgba(224, 231, 237, 0.35);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .settings-title {
            font-size: 17px;
            font-weight: 600;
            color: #4a5968;
            letter-spacing: 0.3px;
        }

        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button class="settings-back"><i class="fas fa-chevron-left"></i></button> */
        .settings-back {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 18px;
            color: #7a8a9a;
            cursor: pointer;
            width: 34px;
            height: 34px;
            border-radius: 12px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-back:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateX(-2px);
            box-shadow: 0 4px 12px rgba(107, 125, 143, 0.08);
            color: #6b7d8f;
        }


        .settings-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* 页面提示词统一样式 */
        .page-hint {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }

        /* 页面内容容器统一样式 */
        .page-content-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ========== 页面布局规范化文档 ==========
           所有新页面必须遵循以下结构以确保整齐对齐：
           
           <div class="settings-screen" style="display: flex; flex-direction: column;">
               <div class="status-bar">...</div>
               <div class="settings-nav">
                   <button class="settings-back">...</button>
                   <div class="settings-title">标题</div>
                   <button class="settings-back">...</button>
               </div>
               <div class="settings-scroll">
                   <div class="page-hint">提示词（可选）</div>
                   <div class="page-content-list">
                       <!-- 内容列表 -->
                   </div>
               </div>
           </div>
           
           关键要点：
           1. 使用 .settings-screen 作为主容器（display: flex; flex-direction: column）
           2. status-bar 放在顶部
           3. settings-nav 放在导航栏（左、中、右三列布局）
           4. 内容区使用 .settings-scroll（自动处理 padding 和 overflow）
           5. 提示词使用 .page-hint 类
           6. 内容列表使用 .page-content-list 类
           这样所有页面都能自动对齐和规范化。
        ========== */

        /* 聊天页面导航栏适配 */
        #chatModal .modal-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0;
            padding-right: 16px;
            border-bottom: 1px solid var(--color-widget-bg);
            background: var(--color-bg-white);
            flex-shrink: 0;
            min-height: 50px;
            padding-left: 0;
            position: relative;
        }

        #chatModal .modal-header #backToFriendList {
            flex-shrink: 0;
            padding-left: 0;
            font-size: 22px;
        }

        #chatModal .modal-header h3 {
            flex: 1;
            margin: 0;
            color: var(--color-text);
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 30px;
        }

        #chatModal .modal-header>div {
            flex-shrink: 0;
            padding-right: 0;
        }



        .friend-list-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background: var(--color-bg-white);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 8px;
        }

        .friend-list-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--color-text);
            font-size: 12px;
            flex: 1;
        }

        .friend-list-nav-item i {
            font-size: 24px;
        }

        .friend-list-nav-item.active {
            color: var(--color-primary);
        }

        .friend-list-nav-item:active {
            opacity: 0.7;
        }

        .settings-card {
            background: var(--color-bg-white);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid var(--color-border-lighter);
            min-height: 68px;
        }

        .settings-card:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
        }

        .settings-card-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        .settings-card-desc {
            font-size: 12px;
            color: var(--color-text);
        }

        .friend-settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: var(--color-widget-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .friend-settings-nav {
            background: var(--color-bg-white);
            padding-right: 16px;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-border-light);
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .friend-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            flex: 1;
            text-align: center;
        }

        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button class="friend-settings-back"><i class="fas fa-chevron-left"></i></button> */
        .friend-settings-back {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--color-text);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            padding: 0;
        }


        .friend-settings-spacer {
            width: 32px;
            height: 32px;
        }

        .friend-settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .friend-settings-card {
            background: var(--color-bg-white);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .friend-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .friend-settings-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .friend-settings-desc {
            font-size: 12px;
            color: var(--color-text);
        }

        .friend-settings-input,
        .friend-settings-select,
        .friend-settings-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            font-size: 14px;
            background: var(--color-bg-white);
        }

        .friend-settings-textarea {
            resize: vertical;
            min-height: 110px;
        }

        .friend-settings-details {
            border: 1px solid var(--color-border-light);
            border-radius: 12px;
            padding: 10px 12px;
            background: var(--color-bg-hover);
        }

        .friend-settings-details summary {
            list-style: none;
            cursor: pointer;
            font-size: 13px;
            color: var(--color-text-medium);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .friend-settings-details summary::-webkit-details-marker {
            display: none;
        }

        .friend-settings-details summary::after {
            content: '›';
            transform: rotate(90deg);
            font-size: 16px;
            color: var(--color-text-lighter);
        }

        .friend-settings-details[open] summary::after {
            transform: rotate(-90deg);
        }

        .voice-status {
            font-size: 12px;
            color: var(--color-primary);
            background: rgba(240, 214, 215, 0.12);
            padding: 4px 10px;
            border-radius: 999px;
        }

        /* 世界书挂载按钮样式 */
        .wb-mount-btn {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 16px;
            background: var(--color-widget-bg);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(120, 119, 133, 0.05);
        }

        .wb-mount-btn:hover {
            background: var(--color-bg-active);
            box-shadow: 0 4px 12px rgba(120, 119, 133, 0.1);
        }

        .wb-mount-btn:active {
            background: var(--color-bg-pressed);
            transform: scale(0.98);
        }

        .worldbook-mount-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--color-bg-white);
            border: 1.5px solid var(--color-border-lighter);
            border-radius: 18px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .worldbook-mount-item:hover {
            background: var(--color-bg-selected);
            border-color: var(--color-primary);
        }

        .worldbook-mount-item input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .worldbook-mount-item-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-dark);
        }

        /* 小结卡片 */
        .summary-card {
            background: var(--color-bg-white);
            border-radius: 18px;
            padding: 14px 16px;
            box-shadow: 0 4px 14px rgba(120, 119, 133, 0.07);
            border: 1px solid #f5f0f0;
            transition: box-shadow 0.2s ease;
        }

        .summary-card:hover {
            box-shadow: 0 6px 20px rgba(120, 119, 133, 0.12);
        }

        .summary-card-body {
            font-size: 13.5px;
            color: #555;
            line-height: 1.65;
            max-height: 100px;
            overflow-y: auto;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .summary-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .summary-card-time {
            font-size: 11px;
            color: #c8c0c0;
        }

        .summary-card-actions {
            display: flex;
            gap: 4px;
        }

        .summary-card-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 10px;
            background: #faf5f5;
            color: #c0b0b0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .summary-card-btn:hover {
            background: #f5eaea;
            color: #a08888;
        }

        .summary-card-processed {
            opacity: 0.55;
            border-style: dashed;
        }

        /* 悬浮球 */
        .summary-fab {
            position: absolute;
            bottom: 28px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), #e8c4d0);
            color: var(--color-bg-white);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(240, 200, 210, 0.45);
            z-index: 100;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            user-select: none;
            touch-action: none;
        }

        .summary-fab:active {
            transform: scale(0.92);
        }

        .summary-fab-panel {
            display: none;
            position: absolute;
            bottom: 86px;
            right: 20px;
            background: var(--color-bg-white);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 6px 24px rgba(120, 119, 133, 0.15);
            border: 1px solid #f5f0f0;
            z-index: 101;
            min-width: 130px;
        }

        .summary-fab-panel.is-open {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-fab-action {
            padding: 10px 14px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .summary-fab-action:hover {
            background: #faf5f5;
        }

        .ios-switch {
            position: relative;
            width: 44px;
            height: 26px;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #d1d5db;
            border-radius: 999px;
            transition: 0.2s ease;
        }

        .ios-slider::before {
            position: absolute;
            content: '';
            height: 22px;
            width: 22px;
            left: 2px;
            top: 2px;
            background: var(--color-bg-white);
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: 0.2s ease;
        }

        .ios-switch input:checked+.ios-slider {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
        }

        .ios-switch input:checked+.ios-slider::before {
            transform: translateX(18px);
        }

        .friend-avatar-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-bottom: 10px;
        }

        .friend-avatar-display {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fff 0%, #fff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #d0d0d8;
            font-size: 40px;
            border: 4px solid #fff;
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.08);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-avatar-display:hover {
            transform: scale(1.08);
            box-shadow: 0 12px 28px rgba(120, 119, 133, 0.12);
        }

        .friend-avatar-display::after {
            content: '点击更换';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--color-text-light);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .friend-avatar-display:hover::after {
            opacity: 1;
        }

        .friend-avatar-display.has-image i {
            display: none;
        }

        .friend-avatar-btn {
            padding: 8px 20px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-light);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-medium);
        }

        .friend-avatar-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .settings-card-meta {
            display: flex;
            gap: 14px;
            font-size: 12px;
            color: var(--color-text-light);
        }

        .settings-status {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-error);
        }

        .settings-status.ok {
            color: var(--color-success);
        }

        .settings-arrow {
            font-size: 16px;
            color: var(--color-text-muted);
        }

        .data-manage-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .data-manage-item {
            width: 100%;
            padding: 12px 14px;
            background: var(--color-bg-white);
            border-radius: 12px;
            border: 1px solid var(--color-border-light);
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: var(--color-text-dark);
        }

        .data-manage-item:hover {
            background: #f7f7fb;
        }

        #triggerAiBtn:hover {
            transform: scale(1.08);
            background-color: #f6f2f1 !important;
        }

        #triggerAiBtn:active {
            transform: scale(0.95);
        }

        /* 心声弹窗样式 */
        .heart-voice-popup {
            position: absolute;
            top: 91px;
            right: 12px;
            width: 320px;
            height: auto;
            max-height: 520px;
            max-width: calc(100% - 24px);
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(120, 119, 133, 0.1), inset 0 1px 2px rgba(255, 255, 255, 0.8);
            padding: 0;
            z-index: 2100;
            display: none;
            border: 0.5px solid rgba(255, 255, 255, 0.9);
            flex-direction: column;
            transform-origin: top right;
            animation: hv-popup-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        @keyframes hv-popup-out {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            100% {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
        }

        .heart-voice-popup.closing {
            animation: hv-popup-out 0.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            pointer-events: none;
        }

        @keyframes hv-popup-in {
            0% {
                opacity: 0;
                transform: scale(0.92) translateY(-8px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .heart-voice-popup.is-open {
            display: flex;
        }

        /* 核心叙事面板 - 自适应高度 */
        .heart-voice-core-panel {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 24px 24px 0 24px;
            background: linear-gradient(180deg, rgba(250, 245, 248, 0.5) 0%, rgba(255, 255, 255, 0.3) 100%);
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-core-panel::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-core-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-core-panel::-webkit-scrollbar-thumb {
            background: rgba(120, 119, 133, 0.15);
            border-radius: 2px;
        }

        /* 心声和神态的容器 */
        .heart-voice-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heart-voice-label {
            font-size: 12px;
            color: #8a7f8c;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .heart-voice-text {
            font-size: 15px;
            color: #4a4654;
            line-height: 1.6;
            word-wrap: break-word;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-height: 180px;
            min-height: 80px;
            overflow-y: auto;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(250, 230, 235, 0.4);
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-text::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-text::-webkit-scrollbar-thumb {
            background: rgba(120, 119, 133, 0.2);
            border-radius: 2px;
        }

        .heart-voice-status {
            display: none;
        }

        /* 次要信息面板 - 占约20%高度 */
        .heart-voice-footer-panel {
            flex: 0 0 auto;
            padding: 20px 24px 24px 24px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, rgba(250, 245, 248, 0.5) 100%);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* 心情值包装器 */
        .heart-voice-mood-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heart-voice-mood-label-text {
            font-size: 12px;
            color: #8a7f8c;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .heart-voice-demeanor {
            font-size: 13px;
            color: #6d6578;
            line-height: 1.6;
            font-style: normal;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 500;
            max-height: 140px;
            min-height: 60px;
            overflow-y: auto;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            border: 1px solid rgba(250, 230, 235, 0.4);
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-demeanor::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-demeanor::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-demeanor::-webkit-scrollbar-thumb {
            background: rgba(120, 119, 133, 0.2);
            border-radius: 2px;
        }

        .heart-voice-mood-bar {
            height: 6px;
            background: rgba(246, 242, 241, 0.6);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 0.5px 1px rgba(255, 255, 255, 0.5);
        }

        .heart-voice-mood-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
        }

        .heart-voice-mood-label {
            font-size: 12px;
            color: #8a7f8c;
            text-align: left;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 历史记录按钮 */
        .heart-voice-history-btn {
            align-self: flex-end;
            font-size: 13px;
            color: #d4a5cc;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .heart-voice-history-btn:hover {
            color: var(--color-secondary);
        }

        .heart-voice-history-btn i {
            font-size: 10px;
        }

        .hv-label {
            color: #5c5765;
            font-weight: 600;
            margin-right: 4px;
        }

        /* 心声历史页面底纹 */
        #heartVoiceHistoryList {
            background: repeating-linear-gradient(135deg,
                    transparent,
                    transparent 20px,
                    rgba(222, 190, 235, 0.03) 20px,
                    rgba(222, 190, 235, 0.03) 40px);
            padding-top: 8px;
            padding-bottom: 16px;
        }

        /* 心声历史标题：艺术字体 */
        .hv-history-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 50%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 14px 0 0;
            letter-spacing: 1px;
        }

        /* 标题下划线 */
        .hv-history-title-line {
            width: 60px;
            height: 1px;
            margin: 6px auto 15px;
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
            border-radius: 1px;
        }

        /* 心声历史卡片：玻璃外观 */
        .hv-history-item {
            padding: 16px 18px;
            margin: 0 16px 10px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.15) 0%, rgba(200, 220, 240, 0.1) 100%), rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(200, 170, 210, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .hv-history-item.selected {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.25) 0%, rgba(222, 190, 235, 0.15) 100%), var(--color-bg-white);
            box-shadow: 0 4px 16px rgba(240, 214, 215, 0.25);
        }

        .hv-history-item.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            color: var(--color-primary);
            font-weight: bold;
            font-size: 14px;
        }

        .hv-history-item:active {
            transform: scale(0.97);
        }

        .hv-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hv-history-time {
            font-size: 12px;
            color: #a09caa;
            font-weight: 500;
        }

        .hv-history-mood {
            font-size: 11px;
            color: #debeeb;
            background: linear-gradient(135deg, rgba(222, 190, 235, 0.18), rgba(240, 214, 215, 0.18));
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
            border: 1px solid rgba(222, 190, 235, 0.2);
        }

        .hv-history-content {
            font-size: 14px;
            color: #5c5b66;
            line-height: 1.7;
            letter-spacing: 0.02em;
        }

        /* 超小屏幕适配 */
        @media (max-width: 375px) {
            .iphone-container {
                max-width: 100%;
                height: 100vh;
            }

            .frost-widget {
                width: 95%;
                height: auto;
                padding: 12px;
            }
        }

        /* 移动端全屏适配 (PWA/Add to Home Screen) */
        @media screen and (max-width: 500px) {
            body {
                padding: 0;
                background: var(--color-background);
                align-items: flex-start;
            }

            .iphone-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                background-color: var(--color-background);
            }

            .status-bar {
                padding-top: env(safe-area-inset-top);
                height: auto;
                min-height: 44px;
                padding-bottom: 5px;
            }

            .dock {
                padding-bottom: env(safe-area-inset-bottom);
                height: auto;
                min-height: 90px;
                border-radius: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            /* 修复模态框在移动端的显示 - 仿照主页面大小 */
            .modal {
                padding: 0;
                background-color: transparent;
            }

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            #profileModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                max-height: none;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }

            /* 显示状态栏时的导航栏样式（紧贴状态栏） */
            body:not(.hide-status-bar) #chatModal .modal-header,
            body:not(.hide-status-bar) #apiModal .modal-header,
            body:not(.hide-status-bar) .settings-nav,
            body:not(.hide-status-bar) .friend-settings-nav {
                padding: 0 !important;
                padding-top: 0px !important;
                padding-bottom: 10px !important;
                padding-left: 16px !important;
                padding-right: 16px !important;
                box-sizing: border-box !important;
                height: 40px !important;
                min-height: 40px !important;
                transition: height 0.3s ease, min-height 0.3s ease;
            }

            /* 隐藏状态栏时的导航栏样式（考虑安全区） */
            body.hide-status-bar #chatModal .modal-header,
            body.hide-status-bar #apiModal .modal-header,
            body.hide-status-bar .settings-nav,
            body.hide-status-bar .friend-settings-nav {
                padding: 0 !important;
                padding-top: calc(0px + env(safe-area-inset-top, 0px)) !important;
                padding-bottom: 10px !important;
                padding-left: 16px !important;
                padding-right: 16px !important;
                box-sizing: border-box !important;
                height: var(--header-height-hidden) !important;
                min-height: var(--header-height-hidden) !important;
                transition: height 0.3s ease, min-height 0.3s ease;
            }
        }

        /* 非移动端：弹窗页面仿照主页面大小 */
        @media screen and (min-width: 501px) {

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            #profileModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 430px;
                height: 90vh;
                max-height: 932px;
                border-radius: 40px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            }
        }

        /* 隐藏状态栏功能 */
        body.hide-status-bar .status-bar {
            display: none !important;
            /* 完全不占位空间 */
        }

        /* ========== 统一页面适配逻辑 ========== */
        /* 设计原则：使用通用选择器 .modal 替代硬编码页面ID */
        /* 优势：所有新增弹窗页面自动继承统一样式，无需手动添加 */
        /* 主屏幕不受影响（在 .iphone-container 内，不在 .modal 内） */

        /* 1. 所有弹窗页面添加box-sizing，防止margin-top额外撑开高度 */
        .modal .modal-content,
        .modal .settings-screen,
        .modal .friend-settings-screen {
            /* 通用选择器确保所有弹窗页面统一 */
            box-sizing: border-box;
            margin-top: 0;
        }

        /* 2. 状态栏显示/隐藏联动（仅作用于弹窗页面） */
        /* 显示状态栏时：所有弹窗页面的.status-bar显示 */
        body:not(.hide-status-bar) .modal .status-bar {
            visibility: visible !important;
        }

        /* 隐藏状态栏时：所有弹窗页面的.status-bar隐藏且不占位 */
        body.hide-status-bar .modal .status-bar {
            display: none !important;
        }



        /* 3. 统一顶部栏位置（含安全区） */
        /* 显示状态栏时的导航栏样式（紧贴状态栏） */
        body:not(.hide-status-bar) .modal .modal-header,
        body:not(.hide-status-bar) .modal .settings-nav,
        body:not(.hide-status-bar) .modal .friend-settings-nav {
            /* 通用选择器自动应用到所有弹窗页面 */
            padding: 0 !important;
            padding-top: 0px !important;
            padding-bottom: 10px !important;
            padding-left: 16px !important;
            padding-right: 16px !important;
            box-sizing: border-box !important;
            height: 40px !important;
            min-height: 40px !important;
            transition: height 0.3s ease, min-height 0.3s ease;
        }

        /* 隐藏状态栏时的导航栏样式（考虑安全区） */
        body.hide-status-bar .modal .modal-header,
        body.hide-status-bar .modal .settings-nav,
        body.hide-status-bar .modal .friend-settings-nav {
            /* 通用选择器自动应用到所有弹窗页面 */
            padding: 0 !important;
            padding-top: calc(0px + env(safe-area-inset-top, 0px)) !important;
            padding-bottom: 10px !important;
            padding-left: 16px !important;
            padding-right: 16px !important;
            box-sizing: border-box !important;
            height: var(--header-height-hidden) !important;
            min-height: var(--header-height-hidden) !important;
            transition: height 0.3s ease, min-height 0.3s ease;
        }

        /* 4. 主屏幕不受影响 */
        .home-screen {
            margin-top: 0 !important;
        }

        /* 5. 弹窗页面无顶部空白 */
        .modal .modal-content {
            /* 通用选择器确保所有弹窗页面统一 */
            padding-top: 0;
        }

        /* 所有返回按钮确保可点击和高层级 */
        .settings-back,
        .friend-settings-back,
        #backToFriendList,
        #charSettingsBack,
        #settingsBack,
        #worldbookBack,
        #closeFriendListModal,
        #closeApiModal {
            z-index: 999 !important;
            pointer-events: auto !important;
            position: relative !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
        }


        /* ========== 统一页面适配逻辑结束 ========== */

        /* 全局适配优化 */
        .iphone-container,
        .modal .settings-screen,
        .modal .friend-settings-screen,
        .modal .modal-content {
            /* 通用选择器确保所有弹窗页面统一 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 确保移动端全屏无滚动 */
        html,
        body {
            overflow: hidden;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* 统一焦点样式 */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus {
            outline: none;
        }

        /* 优化触摸反馈 */
        .btn:active,
        .settings-card:active,
        .friend-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        /* 全局隐藏滚动条（保持可滚动） */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        *::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        /* 心声按钮脉动动画 */
        @keyframes heartVoicePulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(240, 214, 215, 0.4);
                background-color: rgba(240, 214, 215, 0.1);
            }

            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(240, 214, 215, 0.2);
                background-color: rgba(240, 214, 215, 0.25);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(240, 214, 215, 0);
                background-color: rgba(240, 214, 215, 0.1);
            }
        }

        #heartVoiceBtn.pulse-active {
            animation: heartVoicePulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
            border-radius: 50% !important;
            padding: 6px !important;
        }

        .hover-text-style:hover {
            color: #999;
        }

        /* ========== 个人资料页面样式 - 清透玻璃拟态 ========== */
        .profile-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--status-bar-height) - 50px);
            background: linear-gradient(135deg, 
                #f5f8fa 0%, 
                #eef4f8 35%, 
                #e8f2f7 65%, 
                #f0f6fa 100%);
            overflow-y: auto;
        }

        .profile-header {
            position: relative;
            width: 100%;
            padding: 48px 24px 32px;
            text-align: center;
            overflow: hidden;
        }

        .profile-bg-gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(212, 227, 240, 0.15) 0%,
                rgba(200, 220, 232, 0.2) 25%,
                rgba(224, 240, 248, 0.15) 50%,
                rgba(232, 242, 247, 0.2) 75%,
                rgba(240, 248, 252, 0.15) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
        }

        .profile-avatar-section {
            position: relative;
            z-index: 2;
            margin-bottom: 24px;
        }

        .profile-avatar {
            position: relative;
            width: 110px;
            height: 110px;
            margin: 0 auto 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(200, 220, 240, 0.5) 0%, 
                rgba(220, 235, 245, 0.5) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: rgba(107, 125, 143, 0.7);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px rgba(107, 125, 143, 0.08),
                        0 2px 8px rgba(107, 125, 143, 0.04);
        }

        .profile-avatar:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(107, 125, 143, 0.12),
                        0 4px 12px rgba(107, 125, 143, 0.06);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .avatar-edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(107, 125, 143, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: rgba(255, 255, 255, 0.95);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-avatar:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .profile-level-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #8b4513;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.5);
        }

        .profile-basic-info {
            position: relative;
            z-index: 2;
        }

        .profile-name-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .profile-name-section h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 600;
            color: #4a5968;
            letter-spacing: 0.3px;
        }

        .profile-gender-icon {
            font-size: 20px;
            color: #9aa8b5;
            opacity: 0.8;
        }

        .profile-id {
            font-size: 14px;
            color: #7a8a9a;
            margin-bottom: 14px;
            font-weight: 400;
        }

        .profile-signature {
            font-size: 14px;
            color: #8b99a8;
            font-style: normal;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.6;
            font-weight: 300;
        }

        /* 编辑表单样式 - 玻璃拟态 */
        .profile-edit-form {
            padding: 28px 24px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 32px 32px 0 0;
            margin-top: -10px;
            position: relative;
            z-index: 3;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-bottom: none;
        }

        .profile-form-section {
            margin-bottom: 24px;
        }

        .profile-form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #6b7d8f;
            margin-bottom: 10px;
            letter-spacing: 0.2px;
        }

        .profile-gender-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .gender-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 14px;
            border-radius: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gender-option:hover {
            background: rgba(212, 227, 240, 0.15);
        }

        .gender-option input[type="radio"] {
            display: none;
        }

        .gender-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: rgba(255, 255, 255, 0.95);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
        }

        .gender-icon.female {
            background: linear-gradient(135deg, 
                rgba(180, 200, 220, 0.65) 0%, 
                rgba(200, 215, 230, 0.65) 100%);
        }

        .gender-icon.male {
            background: linear-gradient(135deg, 
                rgba(160, 190, 215, 0.65) 0%, 
                rgba(180, 205, 225, 0.65) 100%);
        }

        .gender-icon.other {
            background: linear-gradient(135deg, 
                rgba(170, 185, 210, 0.65) 0%, 
                rgba(190, 200, 220, 0.65) 100%);
        }

        .gender-option input[type="radio"]:checked + .gender-icon {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(107, 125, 143, 0.12);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .form-help-text {
            font-size: 12px;
            color: #9aa8b5;
            margin-top: 8px;
            font-weight: 300;
        }

        .profile-form-actions {
            display: flex;
            gap: 16px;
            margin-top: 36px;
            padding-top: 24px;
            border-top: 1px solid rgba(212, 227, 240, 0.25);
        }

        .profile-form-actions .btn {
            flex: 1;
            padding: 14px;
            border-radius: 28px;
            font-weight: 500;
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        /* 功能卡片样式 - 玻璃拟态 */
        .profile-cards-section {
            padding: 0 24px 32px;
            background: transparent;
            position: relative;
            z-index: 3;
        }

        .profile-card {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 24px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 4px 16px rgba(107, 125, 143, 0.05);
        }

        .profile-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px rgba(107, 125, 143, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.8);
        }

        .card-icon {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 19px;
            color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
        }

        .profile-card:nth-child(1) .card-icon {
            background: linear-gradient(135deg, 
                rgba(180, 200, 220, 0.7) 0%, 
                rgba(200, 215, 230, 0.7) 100%);
        }

        .profile-card:nth-child(2) .card-icon {
            background: linear-gradient(135deg, 
                rgba(160, 195, 210, 0.7) 0%, 
                rgba(180, 210, 225, 0.7) 100%);
        }

        .profile-card:nth-child(3) .card-icon {
            background: linear-gradient(135deg, 
                rgba(170, 200, 220, 0.7) 0%, 
                rgba(190, 215, 235, 0.7) 100%);
        }

        .profile-card:nth-child(4) .card-icon {
            background: linear-gradient(135deg, 
                rgba(190, 205, 220, 0.7) 0%, 
                rgba(205, 220, 230, 0.7) 100%);
        }

        .card-content {
            flex: 1;
        }

        .card-title {
            font-size: 15px;
            font-weight: 500;
            color: #4a5968;
            margin-bottom: 4px;
            letter-spacing: 0.2px;
        }

        .card-desc {
            font-size: 13px;
            color: #7a8a9a;
            font-weight: 300;
        }

        .profile-card i.fa-chevron-right {
            color: #b5c1cc;
            font-size: 13px;
        }

        /* 顶部编辑按钮样式 */
        .profile-edit-btn {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #7a8a9a;
            font-size: 17px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-edit-btn:hover {
            background: rgba(255, 255, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 125, 143, 0.1);
            color: #6b7d8f;
        }

        /* 个人资料页按“页面切换”呈现，不使用弹窗动画 */
        #profileModal {
            background-color: rgba(0, 0, 0, 0.5);
        }

        #profileModal .modal-content {
            animation: none;
        }

        /* 响应式调整 */
        @media (max-width: 400px) {
            .profile-content {
                height: calc(100vh - var(--status-bar-height) - 45px);
            }
            
            .profile-header {
                padding: 40px 20px 28px;
            }
            
            .profile-avatar {
                width: 95px;
                height: 95px;
                font-size: 45px;
            }
            
            .profile-name-section h2 {
                font-size: 22px;
            }
            
            .profile-cards-section {
                padding: 0 20px 28px;
            }
        }
    </style>
    <style>
        /* 图片描述弹窗文本区域滚动条美化 */
        #imageDescText::-webkit-scrollbar {
            width: 4px;
        }

        #imageDescText::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        #imageDescText::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 4px;
        }

        #imageDescText::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        .worldbook-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px 0;
            border-radius: 28px;
            /* 大圆角 */
            font-size: 15px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 130px;
            /* 保证等高 */
        }

        .worldbook-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }

        .worldbook-icon {
            color: #444;
        }

        /* 世界书玻璃按钮样式 */
        .wb-glass-btn {
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.3) 0%, rgba(200, 220, 240, 0.2) 100%), rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 8px 20px rgba(200, 170, 210, 0.25);
        }

        .wb-glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.15);
        }

        .wb-glass-btn:active {
            transform: translateY(-1px);
        }

        .hg-glass-btn {
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.3) 0%, rgba(200, 220, 240, 0.2) 100%), rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 8px 20px rgba(200, 170, 210, 0.25);
        }

        .hg-glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.15);
        }

        .hg-glass-btn:active {
            transform: translateY(-1px);
        }

        /* 世界书卡片样式 */
        .wb-card {
            background-color: #FFFFFF;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(200, 170, 210, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: box-shadow 0.2s ease;
        }

        .wb-card:hover {
            box-shadow: 0 6px 16px rgba(200, 170, 210, 0.15);
        }

        .wb-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .wb-card-preview {
            font-size: 13px;
            color: #999;
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }

        .wb-card-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .wb-card-btn {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.2) 0%, rgba(200, 220, 240, 0.15) 100%), rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .wb-card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(200, 170, 210, 0.2);
        }

        .wb-card-btn:active {
            transform: translateY(0);
        }

        /* HTML游戏卡片样式 (复用世界书样式) */
        .hg-card {
            background-color: #FFFFFF;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(200, 170, 210, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: box-shadow 0.2s ease;
        }

        .hg-card:hover {
            box-shadow: 0 6px 16px rgba(200, 170, 210, 0.15);
        }

        .hg-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .hg-card-preview {
            font-size: 13px;
            color: #999;
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }

        .hg-card-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .hg-card-btn {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.2) 0%, rgba(200, 220, 240, 0.15) 100%), rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .hg-card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(200, 170, 210, 0.2);
        }

        .hg-card-btn:active {
            transform: translateY(0);
        }
    </style>

</head>

<body>
    <div class="iphone-container">
        <!-- 刘海模拟 -->
        <div class="notch"></div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <div id="statusTime" class="time">14:30</div>
            <div class="status-icons">
                <i id="statusSignal" class="fas fa-signal"></i>
                <i id="statusWifi" class="fas fa-wifi"></i>
                <i id="statusBattery" class="fas fa-battery-three-quarters"></i>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="home-screen">
                <!-- 可自定义个人资料小组件 -->
                <div class="w-full flex justify-center">
                    <div id="profileWidgetV2"
                        class="w-[88%] h-[340px] bg-white rounded-[32px] shadow-[0_15px_40px_rgba(0,0,0,0.08)] flex flex-col overflow-hidden relative mx-auto transition-all duration-300">
                        <!-- 顶部背景图区域 -->
                        <div id="profileWidgetCover"
                            class="w-full h-[45%] bg-zinc-200 bg-cover bg-center relative cursor-pointer group">
                            <div
                                class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors flex items-center justify-center">
                                <i
                                    class="fas fa-image text-white/0 group-hover:text-white/60 transition-all text-2xl drop-shadow-md"></i>
                            </div>
                        </div>

                        <!-- 底部内容区域 -->
                        <div id="profileWidgetBottom"
                            class="flex-1 bg-white bg-cover bg-center relative flex flex-col items-center pt-[52px] pb-5 px-6 cursor-pointer group/bottom transition-all duration-300">
                            <div
                                class="absolute inset-0 bg-black/0 group-hover/bottom:bg-black/5 transition-colors pointer-events-none">
                            </div>

                            <!-- 头像 (悬浮在交界处) -->
                            <div class="absolute -top-[46px] left-1/2 -translate-x-1/2 z-20">
                                <button id="editProfileAvatarImage" data-no-bg-change
                                    class="w-[92px] h-[92px] rounded-full border-[5px] border-white bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-purple-100 overflow-hidden transition-transform active:scale-95"
                                    aria-label="编辑头像图片">
                                    <div class="w-full h-full rounded-full overflow-hidden relative bg-zinc-50">
                                        <img id="profileAvatarImage" src="" alt="Avatar"
                                            class="w-full h-full object-cover hidden" />
                                        <div id="profileAvatarImagePlaceholder"
                                            class="w-full h-full bg-purple-200 flex items-center justify-center"
                                            style="background-image: radial-gradient(#fff 15%, transparent 16%), radial-gradient(#fff 15%, transparent 16%); background-size: 10px 10px; background-position: 0 0, 5px 5px;">
                                            <i class="fas fa-user text-white text-3xl drop-shadow-sm"></i>
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <!-- 姓名 -->
                            <div data-no-bg-change
                                class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-1">
                                <div id="profileName" contenteditable="true"
                                    class="text-[22px] font-bold text-zinc-800 truncate tracking-tight outline-none cursor-text">
                                </div>
                            </div>

                            <!-- Handle -->
                            <div data-no-bg-change
                                class="w-full text-center rounded-lg px-2 py-0.5 hover:bg-gray-50/50 transition-colors relative z-10 mb-4">
                                <div id="profileHandle" contenteditable="true"
                                    class="text-[13px] text-gray-400 font-medium truncate outline-none cursor-text">
                                </div>
                            </div>

                            <!-- 状态/Bio -->
                            <div data-no-bg-change
                                class="w-full text-center rounded-xl px-2 py-1 hover:bg-gray-50/50 transition-colors relative z-10 mb-auto">
                                <div id="profileStatus" contenteditable="true"
                                    class="text-[14px] text-zinc-600 leading-relaxed line-clamp-2 outline-none cursor-text">
                                </div>
                            </div>

                            <!-- 定位 (装饰性) -->
                            <div data-no-bg-change
                                class="w-full flex items-center gap-1.5 text-zinc-300 text-xs font-semibold mt-4 select-none hover:text-purple-300 transition-colors relative z-10 justify-center">
                                <i class="fas fa-map-marker-alt"></i>
                                <span id="profileLocation" contenteditable="true"
                                    class="outline-none min-w-[20px] cursor-text">Seoul</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 应用入口区域 -->
                <div id="appGrid" class="app-grid app-grid-offset"></div>

            </div>
        </div>

        <!-- Dock栏 -->
        <div class="dock">
            <div class="dock-icon phone-icon" id="phoneIcon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="dock-icon novel-icon" id="novelIcon">
                <i class="fas fa-book"></i>
            </div>
            <div class="dock-icon forum-icon" id="forumIcon">
                <i class="fas fa-comments"></i>
            </div>
        </div>
    </div>

    <!-- 可爱提示框 -->
    <div class="cute-toast" id="cuteToast" style="display: none;">
        <div class="cute-toast-content">
            <p>等我⌯･3･⌯ಣ</p>
        </div>
    </div>

    <!-- 消息通知横幅 -->
    <div class="msg-notif-banner" id="msgNotifBanner">
        <div class="msg-notif-avatar" id="msgNotifAvatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="msg-notif-body">
            <div class="msg-notif-name" id="msgNotifName"></div>
            <div class="msg-notif-text" id="msgNotifText"></div>
        </div>
    </div>

    <!-- API配置弹窗 -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="apiStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="apiStatusSignal" class="fas fa-signal"></i>
                    <i id="apiStatusWifi" class="fas fa-wifi"></i>
                    <i id="apiStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="modal-header">
                <h3>API 配置</h3>
                <button class="modal-close" id="closeApiModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiUrl">API 地址</label>
                    <input type="url" id="apiUrl" class="form-control" placeholder="https://api.openai.com/v1"
                        value="https://api.openai.com/v1">
                </div>

                <div class="form-group">
                    <label for="apiKey">API 密钥</label>
                    <input type="password" id="apiKey" class="form-control" placeholder="请输入您的 API 密钥">
                </div>

                <div class="form-group">
                    <label>模型选择</label>
                    <div class="form-row">
                        <div class="form-group">
                            <button id="fetchModels" class="btn btn-secondary btn-small">
                                <span id="fetchBtnText">拉取模型列表</span>
                                <span id="fetchLoading" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <div class="model-picker">
                                <button type="button" id="modelPickerButton" class="model-picker-button" disabled>
                                    <span id="modelPickerText">请先拉取模型列表</span>
                                    <i class="fas fa-chevron-down caret"></i>
                                </button>
                                <div id="modelPickerList" class="model-picker-list" role="listbox"></div>
                            </div>
                            <select id="modelSelect" class="form-control" disabled style="display: none;">
                                <option value="">请先拉取模型列表</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="apiStatus" class="status-message"></div>

                <div class="form-actions">
                    <button id="saveApi" class="btn btn-primary">保存配置</button>
                </div>

                <!-- API预设管理 -->
                <div id="apiPresetSection" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #E8E4E9;">
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-weight: 600; color: #787785; margin-bottom: 10px; font-size: 14px;">API预设管理</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="presetName" class="form-control" placeholder="输入预设名称"
                                style="flex: 1; font-size: 14px;">
                            <button id="savePreset" class="btn btn-secondary" style="white-space: nowrap;">保存预设</button>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 6px;">给当前配置起个名字，方便下次快速切换</div>
                    </div>

                    <div style="margin-top: 16px;">
                        <label
                            style="display: block; font-weight: 600; color: #787785; margin-bottom: 10px; font-size: 14px;">API预设列表</label>
                        <div id="presetListContainer"
                            style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">
                            <!-- 按钮由 JS 动态生成 -->
                        </div>
                    </div>

                    <!-- API预设选择弹窗 -->
                    <div id="apiPresetModal" class="modal" style="display: none;">
                        <div class="modal-content"
                            style="width: 260px; height: 280px; max-width: 260px; max-height: 280px; border-radius: 14px; padding: 0; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 10px 12px; border-bottom: 1px solid #E8E4E9; flex-shrink: 0;">
                                <h3
                                    style="margin: 0; font-size: 13px; color: #333; text-align: center; font-weight: 600;">
                                    选择API预设</h3>
                            </div>
                            <div id="apiPresetDrawerList"
                                style="padding: 6px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; flex: 1;">
                                <!-- 预设列表项将动态生成 -->
                            </div>
                            <div
                                style="padding: 8px 10px; border-top: 1px solid #E8E4E9; display: flex; gap: 8px; justify-content: center; flex-shrink: 0;">
                                <button id="closeApiPresetModal" type="button"
                                    style="padding: 4px 20px; background: #F5F3F6; border: none; border-radius: 6px; cursor: pointer; color: #666; font-size: 12px; font-weight: 500;">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友列表弹窗 -->
    <div class="modal" id="friendListModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendListStatusSignal" class="fas fa-signal"></i>
                    <i id="friendListStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeFriendListModal">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">好友列表</div>
                <button class="settings-back"
                    style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: #f0d6d7; width: 42px; text-align: center;"
                    id="addFriendFromList">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="settings-scroll">
                <div id="friendList" class="friend-list" style="padding: 16px 20px;">
                    <!-- 好友列表将动态生成 -->
                </div>
                <div id="noFriends" class="no-friends">
                    <div class="page-hint" style="margin-bottom: 0;">暂无好友，点击右上角 + 添加好友</div>
                </div>
            </div>
            <div class="friend-list-nav">
                <div class="friend-list-nav-item active" data-nav="messages">
                    <i class="fas fa-comment"></i>
                    <span>消息</span>
                </div>
                <div class="friend-list-nav-item" data-nav="moments">
                    <i class="fas fa-circle"></i>
                    <span>动态</span>
                </div>
                <div class="friend-list-nav-item" data-nav="me">
                    <i class="fas fa-user-circle"></i>
                    <span>我</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友弹窗 -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加好友</h3>
                <button class="modal-close" id="closeAddFriendModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <div class="form-group" style="width: auto; text-align: center;">
                        <div id="avatarPreview" class="avatar-upload-preview">
                            <i class="fas fa-user"></i>
                            <p>点击添加</p>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">点击头像选择</div>
                        <input type="file" id="avatarInput" class="form-control" accept="image/*"
                            style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="friendName">昵称</label>
                    <input type="text" id="friendName" class="form-control" placeholder="输入好友昵称">
                </div>

                <div class="form-group">
                    <label for="friendPersona">人设</label>
                    <textarea id="friendPersona" class="form-control"
                        placeholder="比如：傲娇还有点毒舌的青梅竹马，喜欢吃甜食却不承认，遇事会先嘴硬后关心人。" rows="3" style="resize: vertical;"
                        minlength="0" maxlength="5000"></textarea>
                    <div class="input-hint">0-5000字，描述性格、背景或说话风格</div>
                </div>

                <div id="addFriendStatus" class="status-message"></div>

                <div class="form-actions">
                    <button id="cancelAddFriend" class="btn btn-secondary">取消</button>
                    <button id="confirmAddFriend" class="btn btn-primary">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天弹窗 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="chatStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="chatStatusSignal" class="fas fa-signal"></i>
                    <i id="chatStatusWifi" class="fas fa-wifi"></i>
                    <i id="chatStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- 导航栏 -->
            <div class="modal-header" style="position: relative;">
                <button id="backToFriendList">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="chatTitle"
                    style="margin: 0; color: #787785; font-size: 18px; font-weight: 600; display: flex; align-items: center; justify-content: center; text-align: center;">
                    芋圆</h3>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="heartVoiceBtn"
                        style="background: none; border: none; font-size: 18px; color: #f0d6d7; cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                        aria-label="心声">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="charSettingsBtn"
                        style="background: none; border: none; font-size: 20px; color: #787785; cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <!-- 多选模式顶部栏 -->
                <div id="multiSelectHeader" class="multi-select-header">
                    <div style="width: 32px;"></div>
                    <span id="multiSelectCount" class="multi-select-count">已选中 0 条</span>
                    <button id="multiSelectCancelBtn" class="multi-select-cancel-btn" type="button">取消</button>
                </div>
            </div>

            <div id="apiWarning" class="api-warning"
                style="display: none; background-color: #f6f2f1; border-bottom: 1px solid #debb7b; padding: 12px 20px; color: #debb7b; font-size: 13px; text-align: center;">
                ⚠️ 未配置API，请先进行API配置
            </div>

            <!-- 心声弹窗 -->
            <div id="heartVoicePopup" class="heart-voice-popup">
                <!-- 核心叙事面板：心声 + 神态 -->
                <div class="heart-voice-core-panel">
                    <div class="heart-voice-section">
                        <div class="heart-voice-label">心　声</div>
                        <div id="heartVoiceText" class="heart-voice-text"></div>
                    </div>
                    <div class="heart-voice-section">
                        <div class="heart-voice-label">神　态</div>
                        <div id="heartVoiceDemeanor" class="heart-voice-demeanor"></div>
                    </div>
                </div>

                <!-- 次要信息面板：心情值 + 历史记录 -->
                <div class="heart-voice-footer-panel">
                    <div class="heart-voice-mood-wrapper">
                        <div class="heart-voice-mood-label-text">心情值</div>
                        <div class="heart-voice-mood-bar">
                            <div id="heartVoiceMoodFill" class="heart-voice-mood-fill"></div>
                        </div>
                        <div id="heartVoiceMoodLabel" class="heart-voice-mood-label"></div>
                    </div>
                    <button id="heartVoiceHistoryBtn" class="heart-voice-history-btn">
                        查看历史 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="chat-messages" id="chatMessages"
                style="flex: 1; overflow-y: auto; border: none; padding: 15px 12px; background-color: #FFFFFF;">
                <div class="message ai">
                    你好！我是AI助手，请问有什么可以帮助你的吗？
                </div>
            </div>

            <!-- 输入框区域 -->
            <div
                style="background-color: #FFFFFF; border-top: 1px solid #f6f2f1; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom, 0px);">
                <div id="chatInputAreaWrap" class="chat-input-area-wrap" style="padding: 8px 12px 2px;">
                    <div id="replyPreview" class="reply-preview">
                        <span id="replyPreviewText" class="reply-preview-text"></span>
                        <button id="replyPreviewClose" class="reply-preview-close" type="button">×</button>
                    </div>
                    <div id="imageUploadPill" class="image-upload-pill">
                        <img id="imageUploadThumb" class="image-upload-thumb" alt="图片预览" />
                        <span id="imageUploadName" class="image-upload-name">已选择图片</span>
                        <button id="imageUploadClose" class="image-upload-close" type="button">×</button>
                    </div>
                    <!-- 功能栏 -->
                    <div class="chat-function-row"
                        style="display: flex; justify-content: space-around; padding: 4px 0 2px;">
                        <button id="voiceInputBtn"
                            style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-microphone"></i></button>
                        <button id="imageUploadBtn"
                            style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-image"></i></button>
                        <button id="cameraInputBtn"
                            style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-camera"></i></button>
                        <button
                            style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-laugh"></i></button>
                        <button id="chatPlusBtn"
                            style="background: none; border: none; color: #787785; font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-plus-circle"></i></button>
                    </div>

                    <div class="chat-input-row"
                        style="display: flex; gap: 8px; margin-bottom: 2px; align-items: flex-end;">
                        <button id="triggerAiBtn"
                            style="width: 38px; height: 38px; padding: 0; border-radius: 50%; flex-shrink: 0; background: #f6f2f1; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(120,119,133,0.05); display: flex; align-items: center; justify-content: center; color: #debeeb;"
                            aria-label="呼唤AI">
                            <i class="fas fa-wand-magic-sparkles" style="font-size: 18px;"></i>
                        </button>
                        <textarea class="chat-input" id="chatInput" placeholder="输入消息..." rows="1"
                            style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; resize: none; font-size: 14px;"></textarea>
                        <button class="chat-send-btn" id="sendMessage"
                            style="width: 40px; height: 40px; padding: 0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="chatExtraPanel" class="chat-extra-panel" aria-hidden="true">
                        <div class="chat-extra-grid">
                            <button type="button" class="chat-extra-item" id="chatSummaryBtn" aria-label="总结">
                                <span class="chat-extra-icon"><i class="fas fa-clipboard-list"></i></span>
                                <span class="chat-extra-label">总结</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="红包">
                                <span class="chat-extra-icon"><i class="fas fa-gift"></i></span>
                                <span class="chat-extra-label">红包</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="转账">
                                <span class="chat-extra-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span class="chat-extra-label">转账</span>
                            </button>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                        </div>
                    </div>
                    <input id="imageInput" type="file" accept="image/*" style="display: none;" />
                    <div id="imageConfirmPopover" class="image-confirm-popover">
                        <span>发送图片？</span>
                        <div class="image-confirm-actions">
                            <button id="imageConfirmYes" class="image-confirm-btn yes" type="button">是</button>
                            <button id="imageConfirmNo" class="image-confirm-btn no" type="button">否</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 多选模式底部栏 -->
            <div id="multiSelectFooter" class="multi-select-footer">
                <button id="multiSelectDeleteBtn" class="multi-select-delete-btn" type="button">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div id="chatStatus" class="status-message" style="margin: 0; border-radius: 0;"></div>
        </div>
    </div>

    <!-- 消息长按操作菜单 -->
    <div id="messageActionOverlay" class="message-action-overlay">
        <div id="messageActionMenu" class="message-action-menu">
            <button class="message-action-item" id="messageActionCopy" type="button">
                <i class="fas fa-copy"></i>
                <span>复制</span>
            </button>
            <button class="message-action-item" id="messageActionDelete" type="button">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </button>
            <button class="message-action-item" id="messageActionRecall" type="button">
                <i class="fas fa-rotate-left"></i>
                <span>撤回</span>
            </button>
            <button class="message-action-item" id="messageActionReply" type="button">
                <i class="fas fa-reply"></i>
                <span>引用</span>
            </button>
            <button class="message-action-item" id="messageActionMultiSelect" type="button">
                <i class="fas fa-check-double"></i>
                <span>多选</span>
            </button>
            <button class="message-action-item" id="messageActionRegenerate" type="button">
                <i class="fas fa-magic"></i>
                <span>修正</span>
            </button>
        </div>
    </div>

    <!-- 多选确认删除弹窗 -->
    <div id="multiSelectConfirmOverlay" class="multi-select-confirm-overlay">
        <div class="multi-select-confirm-box">
            <h3>确认批量删除？</h3>
            <p id="multiSelectConfirmText">将删除已选中的 0 条消息，删除后无法恢复</p>
            <div class="multi-select-confirm-actions">
                <button id="multiSelectConfirmYes" type="button">确认删除</button>
                <button id="multiSelectConfirmNo" type="button">取消</button>
            </div>
        </div>
    </div>

    <!-- 语音输入模态框 -->
    <div class="modal" id="voiceModal" style="display: none; z-index: 2000;">
        <div
            style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeVoiceModal"
                style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">语音输入</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="voiceText" placeholder="输入或说出的文字..."
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelVoiceInput"
                    style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmVoiceInput"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片描述模态框 -->
    <div class="modal" id="cameraDescModal" style="display: none; z-index: 2000;">
        <div
            style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeCameraDescModal"
                style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: #787785; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: #787785; font-size: 16px; font-weight: 600;">图片描述</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="cameraDescText" placeholder="描述图片内容..."
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelCameraDesc"
                    style="flex: 1; padding: 10px; background-color: #f6f2f1; border: none; border-radius: 8px; cursor: pointer; color: #787785; font-weight: 500;">取消</button>
                <button id="confirmCameraDesc"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片内容弹窗 -->
    <div class="modal" id="imageDescModal" style="display: none; z-index: 2000; background-color: rgba(0, 0, 0, 0.5);">
        <div
            style="background-color: white; border-radius: 18px; width: 90%; max-width: 380px; max-height: 80vh; padding: 24px 24px 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative; display: flex; flex-direction: column; gap: 16px;">
            <button id="closeImageDescModal"
                style="position: absolute; top: 14px; right: 14px; background: none; border: none; font-size: 20px; color: #ccc; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; z-index: 1;"
                class="hover-text-style">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0; color: #333; font-size: 17px; font-weight: 600; flex-shrink: 0;">图片描述</h3>

            <div id="imageDescText"
                style="color: #333; font-size: 14.5px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; overflow-y: auto; padding: 16px; background-color: #f9f9f9; border-radius: 12px; border: 1px solid #eee; flex: 1; min-height: 60px; max-height: calc(80vh - 140px); -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
            </div>

            <button id="imageDescOkBtn" class="btn btn-primary"
                style="width: 100%; height: 44px; border-radius: 12px; flex-shrink: 0;">确定</button>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div class="modal" id="confirmDeleteModal"
        style="z-index: 2001; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: white; border-radius: 30px; padding: 20px 25px; width: 75%; max-width: 240px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #787785; font-size: 15px; font-weight: 600;">确认删除？</h3>
            <p style="margin: 0 0 15px 0; color: #787785; font-size: 13px;">删除后将无法恢复</p>

            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmDeleteYes"
                    style="padding: 10px 25px; background-color: #d32f2f; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">是</button>
                <button id="confirmDeleteNo"
                    style="padding: 10px 25px; background-color: white; color: #787785; border: 1px solid #f6f2f1; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">否</button>
            </div>
        </div>
    </div>

    <!-- 心声历史弹窗 -->
    <div class="modal" id="heartVoiceHistoryModal">
        <div class="modal-content" style="height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="heartVoiceHistoryTitle">心声历史</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="hv-delete-select-btn" title="选择删除"
                        style="background: linear-gradient(135deg, #f0d6d7, #ffc4d0); border: none; color: #fff; cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(240, 214, 215, 0.3); transition: all 0.2s; font-weight: bold;">
                        删
                    </button>
                    <button id="hv-export-select-btn" title="选择导出"
                        style="background: linear-gradient(135deg, #debeeb, #d4a5e0); border: none; color: #fff; cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(222, 190, 235, 0.3); transition: all 0.2s; font-weight: bold;">
                        导
                    </button>
                    <button class="modal-close" id="closeHeartVoiceHistoryModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="heartVoiceHistoryList">
                    <!-- 历史记录将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 心声删除确认弹窗 -->
    <div class="modal" id="hvDeleteModal" style="z-index: 2200; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: white; border-radius: 24px; padding: 24px; width: 70%; max-width: 260px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); text-align: center; animation: fade-in-scale 0.2s ease-out;">
            <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px; font-weight: 600;">删除这条心声？</h3>
            <p style="margin: 0 0 20px 0; color: #999; font-size: 13px;">删除后无法找回哦</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="hvDeleteConfirm"
                    style="flex: 1; padding: 10px 0; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">删除</button>
                <button id="hvDeleteCancel"
                    style="flex: 1; padding: 10px 0; background-color: #f6f2f1; color: #787785; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">取消</button>
            </div>
        </div>
    </div>

    <!-- 好友设置弹窗 -->
    <div class="modal" id="charSettingsModal">
        <div class="modal-content friend-settings-screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendSettingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendSettingsStatusSignal" class="fas fa-signal"></i>
                    <i id="friendSettingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendSettingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="friend-settings-nav">
                <button id="charSettingsBack" class="friend-settings-back" aria-label="返回">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="friend-settings-title">好友设置</div>
                <span class="friend-settings-spacer"></span>
            </div>
            <div class="friend-settings-body">
                <div class="friend-avatar-wrap">
                    <div id="charAvatarDisplay" class="friend-avatar-display" aria-label="头像">
                        <i class="fas fa-user"></i>
                    </div>
                    <input type="file" id="charAvatarInput" accept="image/*" style="display: none;">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">好友昵称</div>
                    <input id="charNameInput" class="friend-settings-input">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">人设</div>
                    <textarea id="charPersonaInput" class="friend-settings-textarea"
                        placeholder="描述性格、背景或说话风格"></textarea>
                </div>

                <div class="friend-settings-card" style="padding: 20px;">
                    <div class="friend-settings-label" style="margin-bottom: 16px;">挂载模块</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="wb-mount-btn" id="worldbookMountBtn">世界书</button>
                        <button class="wb-mount-btn" id="htmlGameMountBtn">HTML游戏</button>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">对话界面展示</div>
                            <div class="friend-settings-desc">自定义聊天界面显示内容</div>
                        </div>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">对话时间</div>
                        <label class="ios-switch">
                            <input id="chatShowTimeToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">已读</div>
                        <label class="ios-switch">
                            <input id="chatReadToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">隐藏头像</div>
                        <label class="ios-switch">
                            <input id="chatHideAvatarToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">语音 ID</div>
                            <div class="friend-settings-desc">用于语音合成，未填写则自动</div>
                        </div>
                        <span id="voiceIdStatus" class="voice-status">未设置</span>
                    </div>
                    <input id="voiceIdInput" class="friend-settings-input" placeholder="输入语音ID">
                    <select id="voiceIdMode" class="friend-settings-select">
                        <option value="auto">自动选择</option>
                        <option value="fixed">固定使用此ID</option>
                        <option value="random">随机切换</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveCharSettingsBtn"
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">保存</button>
                    <button id="deleteCharBtn"
                        style="flex: 1; padding: 12px; background-color: #f6f2f1; color: #d32f2f; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">删除好友</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置全屏页面 -->
    <div class="modal" id="settingsModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="settingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="settingsStatusSignal" class="fas fa-signal"></i>
                    <i id="settingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="settingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="settingsBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">设置</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll">
                <div id="settingsApiCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">API设置</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="configStatus" class="settings-status">未配置</span>
                        <i class="fas fa-chevron-right settings-arrow"></i>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">隐藏状态栏</div>
                        <div class="settings-card-desc">隐藏所有页面顶部的状态栏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="hideStatusBarToggle">
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">记忆对话条数</div>
                        <div class="settings-card-desc">角色每次回复时参考最近N条对话，数值越大角色记忆越久但响应可能变慢</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="memoryChatCountInput"
                            style="width: 60px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; text-align: center;"
                            min="1" max="999" value="50">
                        <span style="font-size: 14px; color: #787785;">条</span>
                    </div>
                </div>

                <div id="settingsDataCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">数据管理</div>
                        <div class="settings-card-desc">导入导出、备份与恢复</div>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像选择弹窗 -->
    <div class="modal" id="avatarPickerModal" style="z-index: 2105; display: none; background-color: rgba(0,0,0,0.35);">
        <div
            style="background-color: #FFFFFF; border-radius: 20px; width: 86%; max-width: 320px; padding: 18px; box-shadow: 0 14px 40px rgba(120,119,133,0.2);">
            <h3 style="margin: 0 0 12px 0; color: #787785; font-size: 16px; font-weight: 600; text-align: center;">更换头像
            </h3>
            <div id="charAvatarModalPreview"
                style="width: 74px; height: 74px; border-radius: 50%; background: #f6f2f1; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: #787785; font-size: 26px; background-size: cover; background-position: center;">
                <i class="fas fa-user"></i>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input id="charAvatarUrlModalInput" type="text" placeholder="粘贴头像图片URL"
                    style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;">
                <label
                    style="display: block; width: 100%; padding: 10px 12px; border: 1px dashed #f0d6d7; border-radius: 12px; font-size: 14px; color: #f0d6d7; text-align: center; cursor: pointer;">
                    选择本地图片
                    <input id="charAvatarFileModalInput" type="file" accept="image/*" style="display: none;">
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button id="cancelAvatarPicker"
                    style="flex: 1; padding: 10px; background: #f6f2f1; border: none; border-radius: 12px; cursor: pointer; color: #787785; font-weight: 600;">取消</button>
                <button id="confirmAvatarPicker"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); border: none; border-radius: 12px; cursor: pointer; color: #fff; font-weight: 600;">确定</button>
            </div>
        </div>
    </div>

    <!-- 数据管理二级菜单 -->
    <div class="modal" id="dataManageModal">
        <div class="modal-content" style="max-width: 360px; border-radius: 18px;">
            <div class="modal-header">
                <h3>数据管理</h3>
                <button class="modal-close" id="closeDataManageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="data-manage-list">
                    <button id="exportAllData" class="data-manage-item">导出全部数据</button>
                    <button id="importAllData" class="data-manage-item">导入数据（覆盖当前）</button>
                    <button id="exportFriendsData" class="data-manage-item">仅备份好友数据</button>
                    <button id="exportChatsData" class="data-manage-item">仅备份聊天记录</button>
                </div>
                <input type="file" id="importFileInput" accept="application/json" style="display: none;" />
            </div>
        </div>
    </div>

    <!-- 个人资料小组件编辑弹窗 -->
    <div id="profileWidgetModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="profileWidgetModalTitle"
        style="z-index: 3000;">
        <div id="profileWidgetModalContent" class="modal-content" style="max-width: 320px;">
            <div class="modal-header">
                <h3 id="profileWidgetModalTitle">编辑</h3>
                <button class="modal-close" id="closeProfileWidgetModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="profileWidgetImageEditor" style="display: none;" class="space-y-4">
                    <img id="profileWidgetImagePreview" src="" alt="预览"
                        class="w-full h-48 object-contain rounded-lg bg-gray-100 hidden" />
                    <div class="form-group">
                        <label for="profileWidgetImageUrlInput">图片链接</label>
                        <input id="profileWidgetImageUrlInput" type="text" class="form-control"
                            placeholder="https://example.com/image.png" />
                    </div>
                    <div class="relative flex items-center" style="margin: 10px 0;">
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                        <span style="margin: 0 10px; color: #999; font-size: 12px;">或</span>
                        <div style="flex: 1; border-top: 1px solid #ddd;"></div>
                    </div>
                    <div class="form-group">
                        <input type="file" accept="image/*" id="profileWidgetFileInput" class="form-control"
                            style="display: none;" aria-hidden="true" />
                        <button id="profileWidgetUploadButton" class="btn btn-secondary"
                            style="width: 100%;">选择图片</button>
                    </div>
                </div>

                <div id="profileWidgetTextEditor" style="display: none;">
                    <input id="profileWidgetTextInput" type="text" class="form-control" />
                </div>

                <div id="profileWidgetTextareaEditor" style="display: none;">
                    <textarea id="profileWidgetTextareaInput" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-actions">
                    <button id="profileWidgetCancelButton" type="button" class="btn btn-secondary">取消</button>
                    <button id="profileWidgetSaveButton" type="button" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 世界书挂载弹窗 -->
    <div id="worldbookMountModal" class="modal"
        style="display: none; z-index: 2100; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: #FFFFFF; border-radius: 30px; width: 85%; max-width: 340px; padding: 24px 20px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); animation: fadeInScale 0.3s ease-out;">
            <!-- 弹窗标题 -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #333; letter-spacing: 0.3px;">选择世界书</h3>
            </div>

            <!-- 世界书卡片列表 -->
            <div id="worldbookMountList"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 8px 0;">
                <!-- 卡片将动态插入 -->
            </div>

            <!-- 底部按钮 -->
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button id="worldbookMountCancel"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background-color: #f6f2f1; color: #666; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">取消</button>
                <button id="worldbookMountSave"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: #fff; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">保存</button>
            </div>
        </div>
    </div>

    <!-- HTML游戏挂载弹窗 -->
    <div id="htmlGameMountModal" class="modal"
        style="display: none; z-index: 2100; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: #FFFFFF; border-radius: 30px; width: 85%; max-width: 340px; padding: 24px 20px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); animation: fadeInScale 0.3s ease-out;">
            <!-- 弹窗标题 -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #333; letter-spacing: 0.3px;">选择HTML游戏
                </h3>
            </div>

            <!-- HTML游戏卡片列表 -->
            <div id="htmlGameMountList"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 8px 0;">
                <!-- 卡片将动态插入 -->
            </div>

            <!-- 底部按钮 -->
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button id="htmlGameMountCancel"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background-color: #f6f2f1; color: #666; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">取消</button>
                <button id="htmlGameMountSave"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%); color: #fff; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">保存</button>
            </div>
        </div>
    </div>

    <!-- 个人资料页面弹窗 -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="profileStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="profileStatusSignal" class="fas fa-signal"></i>
                    <i id="profileStatusWifi" class="fas fa-wifi"></i>
                    <i id="profileStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- 顶部导航 -->
            <div class="settings-nav">
                <button class="settings-back" id="closeProfileModal">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">个人资料</div>
                <button class="profile-edit-btn" id="profileEditBtn">
                    <i class="fas fa-edit"></i>
                </button>
            </div>

            <!-- 个人资料内容 -->
            <div class="profile-content">
                <!-- 头部背景区域 -->
                <div class="profile-header">
                    <div class="profile-bg-gradient"></div>
                    
                    <!-- 头像区域 -->
                    <div class="profile-avatar-section">
                        <div class="profile-avatar" id="profileAvatar">
                            <i class="fas fa-user-circle"></i>
                            <div class="avatar-edit-overlay" id="avatarEditOverlay" style="display: none;">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 基本信息 -->
                    <div class="profile-basic-info">
                        <div class="profile-name-section">
                            <h2 id="profileDisplayName">芋圆</h2>
                            <span class="profile-gender-icon">
                                <i class="fas fa-venus" id="profileGenderIcon"></i>
                            </span>
                        </div>
                        <div class="profile-id">QQ号：<span id="profileIdDisplay">1234567890</span></div>
                        <div class="profile-signature" id="profileSignatureDisplay">这个人很懒，什么都没有留下~</div>
                    </div>
                </div>

                <!-- 编辑表单区域 -->
                <div class="profile-edit-form" id="profileEditForm" style="display: none;">
                    <div class="profile-form-section">
                        <label class="profile-form-label">昵称</label>
                        <input type="text" id="profileNameInput" class="form-control" placeholder="请输入昵称" maxlength="20">
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">甜聊号</label>
                        <input type="text" id="profileIdInput" class="form-control" placeholder="请输入甜聊号" maxlength="15">
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">性别</label>
                        <div class="profile-gender-selector">
                            <label class="gender-option">
                                <input type="radio" name="gender" value="female" checked>
                                <span class="gender-icon female"><i class="fas fa-venus"></i></span>
                                <span>女</span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="male">
                                <span class="gender-icon male"><i class="fas fa-mars"></i></span>
                                <span>男</span>
                            </label>
                            <label class="gender-option">
                                <input type="radio" name="gender" value="other">
                                <span class="gender-icon other"><i class="fas fa-genderless"></i></span>
                                <span>其他</span>
                            </label>
                        </div>
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">个性签名</label>
                        <textarea id="profileSignatureInput" class="form-control" rows="3" placeholder="写点什么吧..." maxlength="100"></textarea>
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">角色人设</label>
                        <textarea id="profilePersonalityInput" class="form-control" rows="5" placeholder="描述一下你的性格、爱好、特点等..." maxlength="500"></textarea>
                        <div class="form-help-text">用于AI更好地理解你的个性</div>
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">生日</label>
                        <input type="date" id="profileBirthdayInput" class="form-control">
                    </div>

                    <div class="profile-form-section">
                        <label class="profile-form-label">所在地</label>
                        <input type="text" id="profileLocationInput" class="form-control" placeholder="你在哪个城市呢？" maxlength="50">
                    </div>

                    <!-- 保存按钮 -->
                    <div class="profile-form-actions">
                        <button class="btn btn-secondary" id="profileCancelBtn">取消</button>
                        <button class="btn btn-primary" id="profileSaveBtn">保存</button>
                    </div>
                </div>

                <!-- 功能卡片区域 -->
                <div class="profile-cards-section" id="profileCardsSection">
                    <div class="profile-card" onclick="alert('收藏功能开发中...')">
                        <div class="card-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="card-content">
                            <div class="card-title">我的收藏</div>
                            <div class="card-desc">保存喜欢的内容</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="profile-card" onclick="alert('相册功能开发中...')">
                        <div class="card-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <div class="card-content">
                            <div class="card-title">我的相册</div>
                            <div class="card-desc">美好回忆存储</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="profile-card" onclick="alert('钱包功能开发中...')">
                        <div class="card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="card-content">
                            <div class="card-title">我的钱包</div>
                            <div class="card-desc">余额和消费记录</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>

                    <div class="profile-card" onclick="openSettingsModal()">
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="card-content">
                            <div class="card-title">设置</div>
                            <div class="card-desc">应用设置和偏好</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { appManager } from './app-manager.js';
        window.appManager = appManager;
    </script>

    <script>
        (() => {
            /**
             * UI配置对象 - 便于未来切换不同UI风格
             * @type {Object}
             */
            const UI_CONFIG = {
                theme: 'iphone',  // 当前主题：iphone | android | desktop
                classes: {
                    // 设备特定UI元素
                    notch: 'notch',
                    statusBar: 'status-bar',
                    homeIndicator: 'home-indicator',
                    // 容器类
                    screen: 'screen',
                    container: 'container',
                    // 聊天相关
                    message: 'message',
                    messageUser: 'user',
                    messageAi: 'ai',
                    // 按钮类
                    btnPrimary: 'btn btn-primary',
                    btnSecondary: 'btn btn-secondary',
                    btnSmall: 'btn btn-small',
                    btnGlass: 'wb-glass-btn',
                    btnClose: 'modal-close',
                    btnBack: 'settings-back',
                    // 输入框类
                    formInput: 'form-control',
                    textArea: 'form-control',
                    chatInput: 'chat-input',
                    // 卡片类
                    cardBase: 'card',
                    cardSettings: 'settings-card',
                    cardFriend: 'friend-settings-card',
                    cardSummary: 'summary-card',
                    cardWorldbook: 'wb-card',
                    cardGame: 'hg-card',
                    cardInfo: 'info-card',
                    cardProfile: 'profile-widget-card',
                    // 列表类
                    listBase: 'list',
                    listFriends: 'friend-list',
                    listItems: 'list-items',
                    listModelPicker: 'model-picker-list',
                    listDataManage: 'data-manage-list',
                    listPageContent: 'page-content-list',
                    // 列表项类
                    itemBase: 'item',
                    itemFriend: 'friend-item',
                    itemMessage: 'message-action-item',
                    itemExtra: 'chat-extra-item',
                    itemNavigation: 'friend-list-nav-item',
                    // 桌面/图标类
                    dockIcon: 'dock-icon',
                    appGrid: 'app-grid',
                    appIcon: 'app-icon',
                    // 可在此扩展更多类名...
                },
                layout: {
                    // 布局相关配置
                    showNotch: true,           // 是否显示刘海
                    showHomeIndicator: true,   // 是否显示Home指示器
                    roundedCorners: true,      // 是否启用圆角
                },
                // 状态栏配置 - 永远保持现有格式不变
                statusBar: {
                    showTime: true,
                    showSignal: true,
                    showWifi: true,
                    showBattery: true,
                },
                // 按钮配置
                buttons: {
                    // 按钮尺寸
                    sizes: {
                        small: { padding: '8px 15px', fontSize: '13px' },
                        normal: { padding: '12px 20px', fontSize: '14px' },
                        large: { padding: '16px 24px', fontSize: '16px' }
                    },
                    // 按钮样式
                    styles: {
                        primary: { 
                            background: 'linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%)',
                            color: 'white'
                        },
                        secondary: {
                            background: 'var(--color-widget-bg)',
                            color: 'var(--color-text)'
                        },
                        danger: {
                            background: 'var(--color-danger)',
                            color: 'white'
                        }
                    }
                },
                // 输入框配置
                inputs: {
                    styles: {
                        default: {
                            borderRadius: '12px',
                            border: '1px solid var(--color-border)',
                            padding: '0 15px',
                            fontSize: '14px'
                        },
                        chat: {
                            borderRadius: '20px', 
                            border: '1px solid #ddd',
                            padding: '10px 12px',
                            fontSize: '14px'
                        }
                    },
                    sizes: {
                        small: { height: '36px' },
                        normal: { height: '44px' },
                        large: { height: '52px' }
                    }
                },
                // 卡片配置
                cards: {
                    styles: {
                        default: {
                            borderRadius: '16px',
                            background: 'var(--color-bg-white)',
                            padding: '16px',
                            boxShadow: '0 2px 8px rgba(120, 119, 133, 0.05)'
                        },
                        settings: {
                            borderRadius: '16px',
                            background: 'var(--color-bg-white)',
                            padding: '16px 20px'
                        }
                    }
                },
                // 列表配置
                lists: {
                    styles: {
                        default: {
                            background: 'transparent',
                            padding: '8px 0'
                        },
                        friends: {
                            maxHeight: '100%',
                            overflowY: 'auto',
                            padding: '16px'
                        }
                    }
                }
            };

            /**
             * UI管理器 - 全局UI元素生成和控制
             * 让所有页面/弹窗都能复用统一的UI组件
             */
            const UIManager = {
                config: UI_CONFIG,

                /**
                 * 生成状态栏HTML - 永远保持现有格式不变
                 * @param {Object} options - 可选配置 { showTime, showSignal, showWifi, showBattery }
                 * @returns {string} 状态栏HTML字符串
                 */
                createStatusBar(options = {}) {
                    const { showTime, showSignal, showWifi, showBattery } = {
                        ...this.config.statusBar,
                        ...options
                    };
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const time = `${hours}:${minutes}`;

                    return `
                        <div class="${this.config.classes.statusBar}">
                            ${showTime ? `<span class="time">${time}</span>` : '<span></span>'}
                            <div class="status-icons">
                                ${showSignal ? '<i class="fas fa-signal"></i>' : ''}
                                ${showWifi ? '<i class="fas fa-wifi"></i>' : ''}
                                ${showBattery ? '<i class="fas fa-battery-full"></i>' : ''}
                            </div>
                        </div>
                    `;
                },

                /**
                 * 创建按钮HTML
                 * @param {string} text - 按钮文字
                 * @param {Object} options - 配置 { type: 'primary'|'secondary'|'danger', size: 'small'|'normal'|'large', id, className, onclick }
                 * @returns {string} 按钮HTML字符串
                 */
                createButton(text, options = {}) {
                    const { type = 'primary', size = 'normal', id = '', className = '', onclick = '', disabled = false } = options;
                    
                    const baseClasses = type === 'close' ? this.config.classes.btnClose : 
                                       type === 'back' ? this.config.classes.btnBack :
                                       type === 'glass' ? this.config.classes.btnGlass :
                                       `btn btn-${type}`;
                    
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';
                    const disabledAttr = disabled ? 'disabled' : '';

                    return `<button ${idAttr} class="${allClasses}" ${onclickAttr} ${disabledAttr}>${text}</button>`;
                },

                /**
                 * 创建带图标的按钮HTML
                 * @param {string} icon - Font Awesome图标类名 (如：'fas fa-times')
                 * @param {string} text - 按钮文字（可选）
                 * @param {Object} options - 同createButton的配置
                 * @returns {string} 按钮HTML字符串
                 */
                createIconButton(icon, text = '', options = {}) {
                    const iconHtml = `<i class="${icon}"></i>`;
                    const content = text ? `${iconHtml} <span>${text}</span>` : iconHtml;
                    return this.createButton(content, options);
                },

                /**
                 * 创建返回按钮
                 * @param {Object} options - 配置选项
                 * @returns {string} 返回按钮HTML
                 */
                createBackButton(options = {}) {
                    return this.createIconButton('fas fa-chevron-left', '', { 
                        type: 'back', 
                        className: this.config.classes.btnBack,
                        ...options 
                    });
                },

                /**
                 * 创建关闭按钮
                 * @param {Object} options - 配置选项
                 * @returns {string} 关闭按钮HTML
                 */
                createCloseButton(options = {}) {
                    return this.createIconButton('fas fa-times', '', { 
                        type: 'close', 
                        className: this.config.classes.btnClose,
                        ...options 
                    });
                },

                /**
                 * 创建输入框HTML
                 * @param {Object} options - 配置 { type: 'text'|'password'|'email'|'url', placeholder, value, id, className, size, style }
                 * @returns {string} 输入框HTML字符串
                 */
                createInput(options = {}) {
                    const { type = 'text', placeholder = '', value = '', id = '', className = '', size = 'normal', style = 'default' } = options;
                    
                    const baseClasses = style === 'chat' ? this.config.classes.chatInput : this.config.classes.formInput;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const placeholderAttr = placeholder ? `placeholder="${placeholder}"` : '';
                    const valueAttr = value ? `value="${value}"` : '';

                    return `<input type="${type}" ${idAttr} class="${allClasses}" ${placeholderAttr} ${valueAttr} />`;
                },

                /**
                 * 创建文本域HTML
                 * @param {Object} options - 配置 { placeholder, value, id, className, rows, maxlength }
                 * @returns {string} 文本域HTML字符串
                 */
                createTextarea(options = {}) {
                    const { placeholder = '', value = '', id = '', className = '', rows = 3, maxlength = '' } = options;
                    
                    const baseClasses = this.config.classes.textArea;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const placeholderAttr = placeholder ? `placeholder="${placeholder}"` : '';
                    const rowsAttr = `rows="${rows}"`;
                    const maxlengthAttr = maxlength ? `maxlength="${maxlength}"` : '';

                    return `<textarea ${idAttr} class="${allClasses}" ${placeholderAttr} ${rowsAttr} ${maxlengthAttr}>${value}</textarea>`;
                },

                /**
                 * 创建卡片HTML
                 * @param {string} content - 卡片内容
                 * @param {Object} options - 配置 { type: 'default'|'settings'|'friend', id, className, onclick }
                 * @returns {string} 卡片HTML字符串
                 */
                createCard(content, options = {}) {
                    const { type = 'default', id = '', className = '', onclick = '' } = options;
                    
                    let baseClasses;
                    switch(type) {
                        case 'settings': baseClasses = this.config.classes.cardSettings; break;
                        case 'friend': baseClasses = this.config.classes.cardFriend; break;
                        case 'summary': baseClasses = this.config.classes.cardSummary; break;
                        case 'worldbook': baseClasses = this.config.classes.cardWorldbook; break;
                        case 'game': baseClasses = this.config.classes.cardGame; break;
                        case 'info': baseClasses = this.config.classes.cardInfo; break;
                        case 'profile': baseClasses = this.config.classes.cardProfile; break;
                        default: baseClasses = this.config.classes.cardBase || 'card';
                    }
                    
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `<div ${idAttr} class="${allClasses}" ${onclickAttr}>${content}</div>`;
                },

                /**
                 * 创建列表HTML
                 * @param {string} items - 列表项内容
                 * @param {Object} options - 配置 { type: 'default'|'friends', id, className }
                 * @returns {string} 列表HTML字符串
                 */
                createList(items, options = {}) {
                    const { type = 'default', id = '', className = '' } = options;
                    
                    let baseClasses;
                    switch(type) {
                        case 'friends': baseClasses = this.config.classes.listFriends; break;
                        case 'model-picker': baseClasses = this.config.classes.listModelPicker; break;
                        case 'data-manage': baseClasses = this.config.classes.listDataManage; break;
                        case 'page-content': baseClasses = this.config.classes.listPageContent; break;
                        default: baseClasses = this.config.classes.listBase || 'list';
                    }
                    
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';

                    return `<div ${idAttr} class="${allClasses}">${items}</div>`;
                },

                /**
                 * 创建列表项HTML
                 * @param {string} content - 列表项内容
                 * @param {Object} options - 配置 { type: 'default'|'friend'|'message', id, className, onclick }
                 * @returns {string} 列表项HTML字符串
                 */
                createListItem(content, options = {}) {
                    const { type = 'default', id = '', className = '', onclick = '' } = options;
                    
                    let baseClasses;
                    switch(type) {
                        case 'friend': baseClasses = this.config.classes.itemFriend; break;
                        case 'message': baseClasses = this.config.classes.itemMessage; break;
                        case 'extra': baseClasses = this.config.classes.itemExtra; break;
                        case 'navigation': baseClasses = this.config.classes.itemNavigation; break;
                        default: baseClasses = this.config.classes.itemBase || 'item';
                    }
                    
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `<div ${idAttr} class="${allClasses}" ${onclickAttr}>${content}</div>`;
                },

                /**
                 * 创建桌面图标HTML
                 * @param {string} icon - Font Awesome图标类名
                 * @param {string} label - 图标标签
                 * @param {Object} options - 配置 { type: 'dock'|'app', id, className, onclick }
                 * @returns {string} 桌面图标HTML字符串
                 */
                createDesktopIcon(icon, label, options = {}) {
                    const { type = 'app', id = '', className = '', onclick = '' } = options;
                    
                    const baseClasses = type === 'dock' ? this.config.classes.dockIcon : this.config.classes.appIcon;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `
                        <div ${idAttr} class="${allClasses}" ${onclickAttr}>
                            <i class="${icon}"></i>
                            ${label ? `<span>${label}</span>` : ''}
                        </div>
                    `;
                },

                /**
                 * 更新所有状态栏的时间显示 - 保持原有逻辑不变
                 */
                updateAllStatusBarTimes() {
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const time = `${hours}:${minutes}`;
                    document.querySelectorAll('.time').forEach(el => {
                        el.textContent = time;
                    });
                },

                /**
                 * 获取UI类名
                 * @param {string} key - 类名键
                 * @returns {string} 对应的CSS类名
                 */
                getClass(key) {
                    return this.config.classes[key] || key;
                },

                /**
                 * 获取按钮样式配置
                 * @param {string} type - 按钮类型
                 * @param {string} size - 按钮尺寸
                 * @returns {Object} 样式对象
                 */
                getButtonStyle(type, size = 'normal') {
                    return {
                        ...this.config.buttons.sizes[size],
                        ...this.config.buttons.styles[type]
                    };
                },

                /**
                 * 获取输入框样式配置
                 * @param {string} style - 输入框样式类型
                 * @param {string} size - 输入框尺寸
                 * @returns {Object} 样式对象
                 */
                getInputStyle(style = 'default', size = 'normal') {
                    return {
                        ...this.config.inputs.sizes[size],
                        ...this.config.inputs.styles[style]
                    };
                },

                /**
                 * 获取卡片样式配置
                 * @param {string} type - 卡片类型
                 * @returns {Object} 样式对象
                 */
                getCardStyle(type = 'default') {
                    return this.config.cards.styles[type] || this.config.cards.styles.default;
                },

                /**
                 * 获取列表样式配置
                 * @param {string} type - 列表类型
                 * @returns {Object} 样式对象
                 */
                getListStyle(type = 'default') {
                    return this.config.lists.styles[type] || this.config.lists.styles.default;
                },

                /**
                 * 初始化UI管理器
                 */
                init() {
                    // 每分钟更新一次所有状态栏时间
                    setInterval(() => this.updateAllStatusBarTimes(), 60000);
                    console.log('[UIManager] 已初始化，当前主题:', this.config.theme);
                    console.log('[UIManager] 可用组件类型:', Object.keys(this.config.classes));
                },

                /**
                 * 显示UI组件测试界面
                 * 用法：在浏览器控制台输入 UIManager.showUIDemo()
                 */
                showUIDemo() {
                    if (document.getElementById('ui-demo-modal')) {
                        document.getElementById('ui-demo-modal').style.display = 'block';
                        return;
                    }

                    const modal = document.createElement('div');
                    modal.id = 'ui-demo-modal';
                    modal.classList.add('modal');
                    modal.style.display = 'block';
                    modal.style.zIndex = '10000';
                    
                    const demoItems = [
                        this.createListItem('好友列表项示例', { type: 'friend' }),
                        this.createListItem('消息操作项示例', { type: 'message' }),
                        this.createListItem('导航列表项示例', { type: 'navigation' }),
                    ].join('');

                    const demoCards = [
                        this.createCard('<h4>设置卡片</h4><p>这是设置类型的卡片</p>', { type: 'settings' }),
                        this.createCard('<h4>好友卡片</h4><p>这是好友类型的卡片</p>', { type: 'friend' }),
                        this.createCard('<h4>游戏卡片</h4><p>这是游戏类型的卡片</p>', { type: 'game' }),
                    ].join('');

                    const demoIcons = [
                        this.createDesktopIcon('fas fa-message', '聊天'),
                        this.createDesktopIcon('fas fa-cog', '设置'),
                        this.createDesktopIcon('fas fa-heart', '收藏'),
                        this.createDesktopIcon('fas fa-home', '', { type: 'dock' }),
                        this.createDesktopIcon('fas fa-user', '', { type: 'dock' }),
                    ].join('');

                    modal.innerHTML = `
                        <div class="modal-content">
                            ${this.createStatusBar()}
                            <div class="modal-header">
                                ${this.createBackButton({ onclick: 'UIManager.hideUIDemo()' })}
                                <h1>UI组件测试</h1>
                                ${this.createCloseButton({ onclick: 'UIManager.hideUIDemo()' })}
                            </div>
                            <div class="modal-body" style="padding: 20px; max-height: 600px; overflow-y: auto;">
                                <h3>按钮组件</h3>
                                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${this.createButton('主要按钮', { type: 'primary' })}
                                    ${this.createButton('次要按钮', { type: 'secondary' })}
                                    ${this.createButton('危险按钮', { type: 'danger' })}
                                    ${this.createIconButton('fas fa-heart', '图标按钮')}
                                    ${this.createButton('禁用按钮', { disabled: true })}
                                </div>
                                
                                <h3>输入框组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${this.createInput({ placeholder: '默认输入框', style: 'default' })}
                                    <br><br>
                                    ${this.createInput({ placeholder: '聊天输入框', style: 'chat' })}
                                    <br><br>
                                    ${this.createTextarea({ placeholder: '多行文本输入框', rows: 3 })}
                                </div>
                                
                                <h3>卡片组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${demoCards}
                                </div>
                                
                                <h3>列表组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${this.createList(demoItems, { type: 'friends' })}
                                </div>
                                
                                <h3>桌面图标组件</h3>
                                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                                    ${demoIcons}
                                </div>
                                
                                <div style="margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                                    <h4>测试方法</h4>
                                    <p>在浏览器控制台中可以使用：</p>
                                    <code style="display: block; background: rgba(0,0,0,0.2); padding: 10px; margin: 5px 0; border-radius: 4px;">
UIManager.createButton('测试', {type: 'primary'})<br>
UIManager.createInput({placeholder: '测试输入'})<br>
UIManager.createCard('内容', {type: 'settings'})<br>
UIManager.showUIDemo() // 显示此测试页面<br>
UIManager.hideUIDemo() // 隐藏此测试页面
                                    </code>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                },

                /**
                 * 隐藏UI组件测试界面
                 */
                hideUIDemo() {
                    const modal = document.getElementById('ui-demo-modal');
                    if (modal) {
                        modal.style.display = 'none';
                        // modal.remove(); // 不删除，下次显示更快
                    }
                }
            };

            /**
             * ============================================================
             * UIManager 使用指南
             * ============================================================
             * 
             * 【创建新弹窗页面】
             * ```javascript
             * const modal = document.createElement('div');
             * modal.className = 'modal';
             * modal.innerHTML = `
             *     <div class="modal-content">
             *         ${UIManager.createStatusBar()}
             *         <div class="modal-header">
             *             ${UIManager.createBackButton({ id: 'backBtn' })}
             *             <span>页面标题</span>
             *             ${UIManager.createCloseButton({ id: 'closeBtn' })}
             *         </div>
             *         <div class="modal-body">
             *             ${UIManager.createButton('保存', { type: 'primary', id: 'saveBtn' })}
             *             ${UIManager.createButton('取消', { type: 'secondary', id: 'cancelBtn' })}
             *         </div>
             *     </div>
             * `;
             * ```
             * 
             * 【按钮创建方法】
             * - UIManager.createButton('文字', {type: 'primary|secondary|danger', size: 'small|normal|large'})
             * - UIManager.createIconButton('fas fa-heart', '喜欢', {type: 'primary'})
             * - UIManager.createBackButton({id: 'backBtn'}) 
             * - UIManager.createCloseButton({id: 'closeBtn'})
             * 
             * 【获取统一样式】
             * - element.className = UIManager.getClass('btnPrimary')
             * - const style = UIManager.getButtonStyle('primary', 'large')
             * 
             * 【未来切换UI主题步骤】
             * 1. 修改 UI_CONFIG.theme 为 android 或 desktop
             * 2. 修改 UI_CONFIG.buttons 中的样式配置
             * 3. 在CSS找到 "iPhone特定UI样式" 分段注释
             * 4. 替换对应的样式（如 .notch, .iphone-container）
             * 5. UIManager 会自动使用新的类名和配置
             * 
             * ============================================================
             */

            let friendSystem;
            let apiService;
            let chatSession;
            let profileWidget;
            let heartVoiceSystem;

            /**
             * JSON清洗与修复层
             * 处理API返回的可能包含非JSON内容（如杂散引号、纯文本、错误标记）的响应
             */
            const JSONCleaningLayer = {
                /**
                 * 清洗原始文本，移除前缀杂余内容
                 * @param {string} text - 原始文本
                 * @returns {string} - 清洗后的文本
                 */
                sanitizeRawText(text) {
                    if (!text) return '';

                    // 移除<think>推理块（DeepSeek/Gemini/Claude等模型的思考过程）
                    let cleaned = text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                    // 移除文本开头的markdown代码块标记
                    cleaned = cleaned.replace(/^```(?:json)?\s*\n?/, '').trim();
                    // 移除文本末尾的markdown代码块标记
                    cleaned = cleaned.replace(/\n?```\s*$/, '').trim();
                    // 移除常见的前缀（如 json, JSON等）
                    cleaned = cleaned.replace(/^["']?(?:json|JSON)["']?\s*:\s*/, '').trim();
                    // 移除开头的emoji、锁符号、加密标识等前缀标记
                    cleaned = cleaned.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();
                    cleaned = cleaned.replace(/^(?:encrypted|ENCRYPTED|locked|LOCKED|加密|锁定)[\s：:]*/, '').trim();

                    return cleaned;
                },

                /**
                 * 提取JSON字符串（从混合文本中）
                 * @param {string} text - 可能包含非JSON内容的文本
                 * @returns {string|null} - 提取的JSON字符串，或null如果找不到
                 */
                extractJSON(text) {
                    if (!text) return null;

                    // 使用括号匹配来正确提取JSON对象
                    let braceCount = 0;
                    let startIndex = -1;
                    let inString = false;
                    let escaped = false;

                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];

                        // 处理转义字符
                        if (escaped) {
                            escaped = false;
                            continue;
                        }

                        if (char === '\\') {
                            escaped = true;
                            continue;
                        }

                        // 处理字符串边界
                        if (char === '"' && !escaped) {
                            inString = !inString;
                            continue;
                        }

                        // 如果在字符串内，跳过括号计数
                        if (inString) continue;

                        // 计数大括号
                        if (char === '{') {
                            if (startIndex === -1) startIndex = i;
                            braceCount++;
                        } else if (char === '}') {
                            braceCount--;
                            // 当括号匹配完成时，提取这个JSON对象
                            if (braceCount === 0 && startIndex !== -1) {
                                return text.slice(startIndex, i + 1);
                            }
                        }
                    }

                    // 如果没有找到完整的JSON对象，尝试找JSON数组
                    let bracketCount = 0;
                    startIndex = -1;
                    inString = false;
                    escaped = false;

                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];

                        if (escaped) {
                            escaped = false;
                            continue;
                        }

                        if (char === '\\') {
                            escaped = true;
                            continue;
                        }

                        if (char === '"' && !escaped) {
                            inString = !inString;
                            continue;
                        }

                        if (inString) continue;

                        if (char === '[') {
                            if (startIndex === -1) startIndex = i;
                            bracketCount++;
                        } else if (char === ']') {
                            bracketCount--;
                            if (bracketCount === 0 && startIndex !== -1) {
                                return text.slice(startIndex, i + 1);
                            }
                        }
                    }

                    return null;
                },

                /**
                 * 修复常见的JSON格式错误
                 * @param {string} jsonStr - 可能有格式错误的JSON字符串
                 * @returns {string} - 修复后的JSON字符串
                 */
                fixJSONErrors(jsonStr) {
                    if (!jsonStr) return '';

                    let fixed = jsonStr;

                    // 第一步：移除可能混入的前缀标记（如【inner_voice】等）以及emoji、加密标识
                    fixed = fixed.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s【]*(?:inner_voice|心声|神态|JSON|json|数据|encrypted|ENCRYPTED|locked|LOCKED)[\s】：:]*/gu, '').trim();
                    fixed = fixed.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();

                    // 修复单引号为双引号（但保留中文引号）
                    // 只替换成对的英文单引号
                    fixed = fixed.replace(/([^\\])'([^']*)'([^\\])/g, '$1"$2"$3');
                    fixed = fixed.replace(/^'([^']*)'/, '"$1"');

                    // 修复未闭合的字符串（尾部的杂散引号）
                    // 计算引号数量，如果是奇数则删除最后的引号
                    const quoteCount = (fixed.match(/"/g) || []).length;
                    if (quoteCount % 2 !== 0) {
                        fixed = fixed.trimEnd();
                        if (fixed.endsWith('"')) {
                            fixed = fixed.slice(0, -1);
                        } else {
                            fixed += '"';
                        }
                    }

                    // 修复末尾缺少的大括号
                    if (fixed.trim().startsWith('{') && !fixed.trim().endsWith('}')) {
                        fixed = fixed.trimEnd() + '}';
                    }

                    // 修复末尾缺少的方括号
                    if (fixed.trim().startsWith('[') && !fixed.trim().endsWith(']')) {
                        fixed = fixed.trimEnd() + ']';
                    }

                    // 修复多余的逗号（JSON末尾）
                    fixed = fixed.replace(/,\s*([}\]])/g, '$1');

                    // 移除控制字符和不可见字符
                    fixed = fixed.replace(/[\x00-\x1F\x7F]/g, '');

                    return fixed;
                },

                /**
                 * 主清洗与修复函数
                 * @param {string} rawText - API返回的原始文本
                 * @returns {object|null} - 解析后的对象，或null如果失败
                 */
                cleanAndParse(rawText) {
                    if (!rawText || typeof rawText !== 'string') {
                        console.warn('[JSON清洗层] 输入无效，跳过清洗');
                        return null;
                    }

                    try {
                        // 步骤1: 清洗前缀杂余
                        let cleaned = this.sanitizeRawText(rawText);

                        // 步骤2: 提取JSON部分
                        let jsonStr = this.extractJSON(cleaned);
                        if (!jsonStr) {
                            console.warn('[JSON清洗层] 未能提取JSON结构');
                            return null;
                        }

                        // 步骤3: 修复常见格式错误
                        jsonStr = this.fixJSONErrors(jsonStr);

                        // 调试输出
                        console.log('[JSON清洗层] 修复后的JSON（前200字）:', jsonStr.slice(0, 200));

                        // 步骤4: 尝试解析
                        const result = JSON.parse(jsonStr);
                        console.log('[JSON清洗层] 成功解析JSON', {
                            original_length: rawText.length,
                            cleaned_length: jsonStr.length,
                            keys: Object.keys(result)
                        });
                        return result;
                    } catch (error) {
                        console.error('[JSON清洗层] 最终解析失败:', error.message);
                        console.error('[JSON清洗层] 原始文本（前300字）:', rawText.slice(0, 300));
                        return null;
                    }
                },

                /**
                 * 验证并获取安全的值
                 * @param {object} obj - 解析的对象
                 * @param {string} key - 键名
                 * @param {*} defaultValue - 默认值
                 * @returns {*} - 对象中的值或默认值
                 */
                safeGet(obj, key, defaultValue = null) {
                    return obj && typeof obj === 'object' && obj.hasOwnProperty(key) ? obj[key] : defaultValue;
                }
            };

            // 可爱提示框函数
            function showCuteToast(message = '等我⌯･3･⌯ಣ', type = 'default') {
                const cuteToast = document.getElementById('cuteToast');
                if (!cuteToast) return;

                const contentEl = cuteToast.querySelector('.cute-toast-content p');
                if (contentEl) {
                    contentEl.textContent = message;
                }

                cuteToast.style.display = 'block';
                setTimeout(() => {
                    cuteToast.style.display = 'none';
                }, 2000);
            }
            window.showCuteToast = showCuteToast;

            // 自定义错误弹窗函数
            function showCustomErrorModal(errorCode) {
                const customErrorModal = document.getElementById('customErrorModal');
                const customApiErrorText = document.getElementById('customApiErrorText');
                const customErrorOkButton = document.getElementById('customErrorOkButton');

                if (!customErrorModal || !customApiErrorText) return;

                // 格式化错误信息
                let errorMessage = 'API请求失败：';
                if (typeof errorCode === 'object' && errorCode.status) {
                    // 如果是response对象
                    errorMessage += errorCode.status;
                    if (errorCode.message) {
                        errorMessage += ' - ' + errorCode.message;
                    }
                } else if (typeof errorCode === 'number') {
                    // HTTP状态码
                    errorMessage += errorCode;
                } else if (typeof errorCode === 'string') {
                    // 错误信息字符串
                    errorMessage += errorCode;
                } else {
                    errorMessage += '未知错误';
                }

                customApiErrorText.textContent = errorMessage;
                customErrorModal.style.display = 'flex';

                // 移除旧的事件监听器并添加新的
                if (customErrorOkButton) {
                    const newButton = customErrorOkButton.cloneNode(true);
                    customErrorOkButton.parentNode.replaceChild(newButton, customErrorOkButton);

                    // 重新获取克隆后的按钮
                    const clonedButton = document.getElementById('customErrorOkButton');
                    if (clonedButton) {
                        clonedButton.addEventListener('click', function () {
                            customErrorModal.style.display = 'none';
                        });
                    }
                }

                // 点击背景关闭（只添加一次）
                customErrorModal.onclick = function (e) {
                    if (e.target === customErrorModal) {
                        customErrorModal.style.display = 'none';
                    }
                };
            }


            // 重写 alert 函数
            window.alert = function (message) {
                showCuteToast();
            };

            // 消息通知横幅
            let _notifTimer = null;
            function showMsgNotification(friendName, content, avatarUrl, onTap) {
                const banner = document.getElementById('msgNotifBanner');
                if (!banner) return;

                // 设置头像
                const avatarEl = document.getElementById('msgNotifAvatar');
                if (avatarEl) {
                    if (avatarUrl) {
                        avatarEl.innerHTML = '<img src="' + avatarUrl + '" alt="' + friendName + '">';
                    } else {
                        avatarEl.innerHTML = '<i class="fas fa-user"></i>';
                    }
                }

                // 设置名称和内容
                const nameEl = document.getElementById('msgNotifName');
                const textEl = document.getElementById('msgNotifText');
                if (nameEl) nameEl.textContent = friendName || '';
                if (textEl) {
                    const preview = (content || '').replace(/\s+/g, ' ').trim();
                    textEl.textContent = preview.length > 30 ? preview.substring(0, 30) + '...' : preview;
                }

                // 清除之前的定时器
                if (_notifTimer) clearTimeout(_notifTimer);

                // 移除旧的点击事件
                const newBanner = banner.cloneNode(true);
                banner.parentNode.replaceChild(newBanner, banner);

                // 绑定点击事件
                if (onTap) {
                    newBanner.addEventListener('click', () => {
                        newBanner.classList.remove('is-visible');
                        if (_notifTimer) clearTimeout(_notifTimer);
                        onTap();
                    });
                }

                // 显示横幅
                requestAnimationFrame(() => {
                    newBanner.classList.add('is-visible');
                });

                // 自动隐藏
                _notifTimer = setTimeout(() => {
                    newBanner.classList.remove('is-visible');
                }, 4000);
            }

            // 基础功能
            const statusTimeEl = document.getElementById('statusTime');
            const statusSignalEl = document.getElementById('statusSignal');
            const statusWifiEl = document.getElementById('statusWifi');
            const statusBatteryEl = document.getElementById('statusBattery');
            const chatStatusTime = document.getElementById('chatStatusTime');
            const chatStatusSignal = document.getElementById('chatStatusSignal');
            const chatStatusWifi = document.getElementById('chatStatusWifi');
            const chatStatusBattery = document.getElementById('chatStatusBattery');
            const friendSettingsStatusTime = document.getElementById('friendSettingsStatusTime');
            const friendSettingsStatusSignal = document.getElementById('friendSettingsStatusSignal');
            const friendSettingsStatusWifi = document.getElementById('friendSettingsStatusWifi');
            const friendSettingsStatusBattery = document.getElementById('friendSettingsStatusBattery');
            const worldbookStatusTime = document.getElementById('worldbookStatusTime');
            const settingsStatusTime = document.getElementById('settingsStatusTime');
            const friendListStatusTime = document.getElementById('friendListStatusTime');
            const profileStatusTime = document.getElementById('profileStatusTime');
            const profileStatusSignal = document.getElementById('profileStatusSignal');
            const profileStatusWifi = document.getElementById('profileStatusWifi');
            const profileStatusBattery = document.getElementById('profileStatusBattery');
            const apiStatusSignal = document.getElementById('apiStatusSignal');
            const apiStatusWifi = document.getElementById('apiStatusWifi');
            const apiStatusBattery = document.getElementById('apiStatusBattery');

            function setStatusIcon(el, iconClass) {
                if (!el || !iconClass) return;
                el.className = `fas ${iconClass}`;
            }

            function applyStatusBar(status) {
                if (!status) return;
                if (statusTimeEl && status.time) {
                    statusTimeEl.textContent = status.time;
                }
                setStatusIcon(statusSignalEl, status.signal);
                setStatusIcon(statusWifiEl, status.wifi);
                setStatusIcon(statusBatteryEl, status.battery);

                // 更新聊天页状态栏图标
                setStatusIcon(chatStatusSignal, status.signal);
                setStatusIcon(chatStatusWifi, status.wifi);
                setStatusIcon(chatStatusBattery, status.battery);

                // 更新好友设置页状态栏图标
                setStatusIcon(friendSettingsStatusSignal, status.signal);
                setStatusIcon(friendSettingsStatusWifi, status.wifi);
                setStatusIcon(friendSettingsStatusBattery, status.battery);

                // 更新个人资料页状态栏图标
                setStatusIcon(profileStatusSignal, status.signal);
                setStatusIcon(profileStatusWifi, status.wifi);
                setStatusIcon(profileStatusBattery, status.battery);

                // 更新API配置页状态栏图标
                setStatusIcon(apiStatusSignal, status.signal);
                setStatusIcon(apiStatusWifi, status.wifi);
                setStatusIcon(apiStatusBattery, status.battery);

                // 更新世界书页面状态栏图标
                const wbListStatusSignal = document.getElementById('wbListStatusSignal');
                const wbListStatusWifi = document.getElementById('wbListStatusWifi');
                const wbListStatusBattery = document.getElementById('wbListStatusBattery');
                const wbEditStatusSignal = document.getElementById('wbEditStatusSignal');
                const wbEditStatusWifi = document.getElementById('wbEditStatusWifi');
                const wbEditStatusBattery = document.getElementById('wbEditStatusBattery');

                setStatusIcon(wbListStatusSignal, status.signal);
                setStatusIcon(wbListStatusWifi, status.wifi);
                setStatusIcon(wbListStatusBattery, status.battery);
                setStatusIcon(wbEditStatusSignal, status.signal);
                setStatusIcon(wbEditStatusWifi, status.wifi);
                setStatusIcon(wbEditStatusBattery, status.battery);

                // 更新HTML游戏页面状态栏图标
                const hgListStatusSignal = document.getElementById('hgListStatusSignal');
                const hgListStatusWifi = document.getElementById('hgListStatusWifi');
                const hgListStatusBattery = document.getElementById('hgListStatusBattery');
                const hgEditStatusSignal = document.getElementById('hgEditStatusSignal');
                const hgEditStatusWifi = document.getElementById('hgEditStatusWifi');
                const hgEditStatusBattery = document.getElementById('hgEditStatusBattery');

                setStatusIcon(hgListStatusSignal, status.signal);
                setStatusIcon(hgListStatusWifi, status.wifi);
                setStatusIcon(hgListStatusBattery, status.battery);
                setStatusIcon(hgEditStatusSignal, status.signal);
                setStatusIcon(hgEditStatusWifi, status.wifi);
                setStatusIcon(hgEditStatusBattery, status.battery);
            }

            // 更新时间（北京时间实时更新）
            function updateTime() {
                // 获取北京时间（UTC+8）
                const now = new Date();
                const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
                const h = String(beijingTime.getHours()).padStart(2, '0');
                const m = String(beijingTime.getMinutes()).padStart(2, '0');
                const timeStr = `${h}:${m}`;

                // 更新主页面时间
                if (statusTimeEl) {
                    statusTimeEl.textContent = timeStr;
                }

                // 更新聊天页面时间
                if (chatStatusTime) {
                    chatStatusTime.textContent = timeStr;
                }

                // 更新好友设置页面时间
                if (friendSettingsStatusTime) {
                    friendSettingsStatusTime.textContent = timeStr;
                }

                // 更新世界书页面时间
                if (worldbookStatusTime) {
                    worldbookStatusTime.textContent = timeStr;
                }

                // 更新世界书列表页时间
                const wbListStatusTime = document.getElementById('wbListStatusTime');
                if (wbListStatusTime) {
                    wbListStatusTime.textContent = timeStr;
                }

                // 更新世界书编辑页时间
                const wbEditStatusTime = document.getElementById('wbEditStatusTime');
                if (wbEditStatusTime) {
                    wbEditStatusTime.textContent = timeStr;
                }

                // 更新HTML游戏列表页时间
                const hgListStatusTime = document.getElementById('hgListStatusTime');
                if (hgListStatusTime) {
                    hgListStatusTime.textContent = timeStr;
                }

                // 更新HTML游戏编辑页时间
                const hgEditStatusTime = document.getElementById('hgEditStatusTime');
                if (hgEditStatusTime) {
                    hgEditStatusTime.textContent = timeStr;
                }

                // 更新设置页面时间
                if (settingsStatusTime) {
                    settingsStatusTime.textContent = timeStr;
                }

                // 更新好友列表页面时间
                if (friendListStatusTime) {
                    friendListStatusTime.textContent = timeStr;
                }

                // 更新API配置页面时间
                const apiStatusTime = document.getElementById('apiStatusTime');
                if (apiStatusTime) {
                    apiStatusTime.textContent = timeStr;
                }

                // 更新个人资料页面时间
                const profileStatusTime = document.getElementById('profileStatusTime');
                if (profileStatusTime) {
                    profileStatusTime.textContent = timeStr;
                }

                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({ time: timeStr });
                }
            }
            updateTime();
            if (window.appManager && typeof window.appManager.on === 'function') {
                window.appManager.on('status-change', applyStatusBar);
                if (typeof window.appManager.getStatus === 'function') {
                    applyStatusBar(window.appManager.getStatus());
                }
            }
            setInterval(updateTime, 1000);



            function launchApp(appId) {
                if (!window.appManager || typeof window.appManager.launch !== 'function') return;
                try {
                    window.appManager.launch(appId);
                } catch (e) {
                    console.warn('APP 启动失败:', e);
                }
            }


            // 图标元素
            const phoneIcon = document.getElementById('phoneIcon');
            const novelIcon = document.getElementById('novelIcon');
            const forumIcon = document.getElementById('forumIcon');
            const appGrid = document.getElementById('appGrid');

            // 模态窗口元素
            const apiModal = document.getElementById('apiModal');
            const chatModal = document.getElementById('chatModal');
            const settingsModal = document.getElementById('settingsModal');
            const friendListModal = document.getElementById('friendListModal');
            const addFriendModal = document.getElementById('addFriendModal');

            // API配置相关元素
            const apiUrlInput = document.getElementById('apiUrl');
            const apiKeyInput = document.getElementById('apiKey');
            const fetchModelsBtn = document.getElementById('fetchModels');
            const fetchBtnText = document.getElementById('fetchBtnText');
            const fetchLoading = document.getElementById('fetchLoading');
            const modelSelect = document.getElementById('modelSelect');
            const modelPickerButton = document.getElementById('modelPickerButton');
            const modelPickerText = document.getElementById('modelPickerText');
            const modelPickerList = document.getElementById('modelPickerList');
            const saveApiBtn = document.getElementById('saveApi');
            const apiStatus = document.getElementById('apiStatus');

            // 设置显示元素
            const configStatus = document.getElementById('configStatus');

            // 好友列表相关元素
            const friendListElement = document.getElementById('friendList');
            const noFriends = document.getElementById('noFriends');
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarInput = document.getElementById('avatarInput');
            const friendName = document.getElementById('friendName');
            const friendPersona = document.getElementById('friendPersona');
            const confirmAddFriend = document.getElementById('confirmAddFriend');
            const cancelAddFriend = document.getElementById('cancelAddFriend');
            const addFriendStatus = document.getElementById('addFriendStatus');
            const closeFriendListModal = document.getElementById('closeFriendListModal');
            const closeAddFriendModal = document.getElementById('closeAddFriendModal');

            // 聊天相关元素
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessage');
            const chatMessages = document.getElementById('chatMessages');
            const chatStatus = document.getElementById('chatStatus');
            const chatTitle = document.getElementById('chatTitle');

            const replyPreview = document.getElementById('replyPreview');
            const replyPreviewText = document.getElementById('replyPreviewText');
            const replyPreviewClose = document.getElementById('replyPreviewClose');

            const imageUploadPill = document.getElementById('imageUploadPill');
            const imageUploadThumb = document.getElementById('imageUploadThumb');
            const imageUploadName = document.getElementById('imageUploadName');
            const imageUploadClose = document.getElementById('imageUploadClose');
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            const imageInput = document.getElementById('imageInput');
            const imageConfirmPopover = document.getElementById('imageConfirmPopover');
            const imageConfirmYes = document.getElementById('imageConfirmYes');
            const imageConfirmNo = document.getElementById('imageConfirmNo');
            const chatPlusBtn = document.getElementById('chatPlusBtn');
            const chatExtraPanel = document.getElementById('chatExtraPanel');
            const chatInputAreaWrap = document.getElementById('chatInputAreaWrap');
            const chatInputRow = document.querySelector('.chat-input-row');

            const messageActionOverlay = document.getElementById('messageActionOverlay');
            const messageActionMenu = document.getElementById('messageActionMenu');
            const messageActionCopy = document.getElementById('messageActionCopy');
            const messageActionDelete = document.getElementById('messageActionDelete');
            const messageActionRecall = document.getElementById('messageActionRecall');
            const messageActionReply = document.getElementById('messageActionReply');

            const triggerAiBtn = document.getElementById('triggerAiBtn');
            // 关闭按钮
            const closeApiModal = document.getElementById('closeApiModal');
            const backToFriendList = document.getElementById('backToFriendList');
            const closeSettingsModal = document.getElementById('settingsBack');
            const openApiConfig = document.getElementById('openApiConfig');
            const settingsApiCard = document.getElementById('settingsApiCard');
            const settingsDataCard = document.getElementById('settingsDataCard');
            const dataManageModal = document.getElementById('dataManageModal');
            const closeDataManageModal = document.getElementById('closeDataManageModal');
            const exportAllDataBtn = document.getElementById('exportAllData');
            const importAllDataBtn = document.getElementById('importAllData');
            const exportFriendsDataBtn = document.getElementById('exportFriendsData');
            const exportChatsDataBtn = document.getElementById('exportChatsData');
            const importFileInput = document.getElementById('importFileInput');

            // 个人资料小组件（新）
            class ProfileWidget {
                constructor() {
                    this.storageKey = 'profileWidgetV2Data';
                    this.data = {
                        avatarImage: '',
                        bodyImage: '',
                        bottomImage: '',
                        name: 'FirstSnow_',
                        handle: '@Sovow1212',
                        status: '会在初雪日再次相遇(*^. ^*)',
                        location: 'Seoul'
                    };
                    this.currentField = null;
                    this.tempValue = '';
                    this.els = {
                        widget: document.getElementById('profileWidgetV2'),
                        cover: document.getElementById('profileWidgetCover'),
                        bottom: document.getElementById('profileWidgetBottom'),
                        avatarImage: document.getElementById('profileAvatarImage'),
                        avatarImagePlaceholder: document.getElementById('profileAvatarImagePlaceholder'),
                        name: document.getElementById('profileName'),
                        handle: document.getElementById('profileHandle'),
                        status: document.getElementById('profileStatus'),
                        location: document.getElementById('profileLocation'),
                        modal: document.getElementById('profileWidgetModal'),
                        modalContent: document.getElementById('profileWidgetModalContent'),
                        modalTitle: document.getElementById('profileWidgetModalTitle'),
                        imageEditor: document.getElementById('profileWidgetImageEditor'),
                        textEditor: document.getElementById('profileWidgetTextEditor'),
                        textareaEditor: document.getElementById('profileWidgetTextareaEditor'),
                        imagePreview: document.getElementById('profileWidgetImagePreview'),
                        imageUrlInput: document.getElementById('profileWidgetImageUrlInput'),
                        textInput: document.getElementById('profileWidgetTextInput'),
                        textareaInput: document.getElementById('profileWidgetTextareaInput'),
                        fileInput: document.getElementById('profileWidgetFileInput'),
                        saveButton: document.getElementById('profileWidgetSaveButton'),
                        cancelButton: document.getElementById('profileWidgetCancelButton'),
                        uploadButton: document.getElementById('profileWidgetUploadButton'),
                        closeButton: document.getElementById('closeProfileWidgetModal')
                    };
                }

                load() {
                    try {
                        const saved = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
                        Object.assign(this.data, saved || {});
                    } catch (e) {
                        // ignore
                    }
                }

                save() {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                }

                updateUI() {
                    Object.keys(this.data).forEach((key) => {
                        const el = this.els[key];
                        if (key === 'bodyImage') {
                            if (this.els.cover) {
                                if (this.data.bodyImage) {
                                    this.els.cover.style.backgroundImage = `url('${this.data.bodyImage}')`;
                                } else {
                                    this.els.cover.style.backgroundImage = '';
                                }
                            }
                            return;
                        }
                        if (key === 'bottomImage') {
                            if (this.els.bottom) {
                                if (this.data.bottomImage) {
                                    this.els.bottom.style.backgroundImage = `url('${this.data.bottomImage}')`;
                                } else {
                                    this.els.bottom.style.backgroundImage = '';
                                }
                            }
                            return;
                        }
                        if (!el) return;
                        if (key === 'avatarImage') {
                            const placeholder = this.els[key + 'Placeholder'];
                            if (this.data[key]) {
                                el.src = this.data[key];
                                el.classList.remove('hidden');
                                if (placeholder) placeholder.classList.add('hidden');
                            } else {
                                el.classList.add('hidden');
                                if (placeholder) placeholder.classList.remove('hidden');
                            }
                        } else {
                            if (key === 'handle') {
                                el.textContent = this.data.handle.startsWith('@')
                                    ? this.data.handle
                                    : `@${this.data.handle}`;
                            } else {
                                el.textContent = this.data[key];
                            }
                        }
                    });
                }

                openModal(field, type, label) {
                    this.currentField = field;
                    this.tempValue = this.data[field] || '';
                    if (this.els.modalTitle) {
                        this.els.modalTitle.textContent = `编辑${label}`;
                    }

                    if (this.els.imageEditor) this.els.imageEditor.style.display = 'none';
                    if (this.els.textEditor) this.els.textEditor.style.display = 'none';
                    if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'none';

                    if (type === 'image') {
                        if (this.els.imageEditor) this.els.imageEditor.style.display = 'block';
                        if (this.els.imageUrlInput) {
                            this.els.imageUrlInput.value = this.tempValue.startsWith('data:') ? '' : this.tempValue;
                        }
                        if (this.els.imagePreview) {
                            this.els.imagePreview.src = this.tempValue;
                            this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                        }
                    } else if (type === 'text') {
                        if (this.els.textEditor) this.els.textEditor.style.display = 'block';
                        if (this.els.textInput) this.els.textInput.value = this.tempValue;
                    } else if (type === 'textarea') {
                        if (this.els.textareaEditor) this.els.textareaEditor.style.display = 'block';
                        if (this.els.textareaInput) this.els.textareaInput.value = this.tempValue;
                    }

                    if (this.els.modal) this.els.modal.style.display = 'flex';
                    if (this.els.modalContent) this.els.modalContent.classList.add('animate-fade-in-scale');
                }

                closeModal() {
                    if (this.els.modalContent) this.els.modalContent.classList.remove('animate-fade-in-scale');
                    if (this.els.modal) this.els.modal.style.display = 'none';
                    this.currentField = null;
                    this.tempValue = '';
                    if (this.els.fileInput) this.els.fileInput.value = '';
                }

                saveChanges() {
                    if (this.currentField) {
                        // 只有在tempValue不为空时才保存，避免清空现有数据
                        if (this.tempValue) {
                            this.data[this.currentField] = this.tempValue;
                            this.save();
                            this.updateUI();
                        }
                    }
                    this.closeModal();
                }

                bindEvents() {
                    const editProfileAvatarImage = document.getElementById('editProfileAvatarImage');
                    if (editProfileAvatarImage) {
                        editProfileAvatarImage.addEventListener('click', () => this.openModal('avatarImage', 'image', '头像图片'));
                    }

                    const setupInlineEdit = (key) => {
                        const el = this.els[key];
                        if (!el) return;

                        el.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                el.blur();
                            }
                        });

                        el.addEventListener('blur', () => {
                            let val = el.textContent.trim();
                            if (key === 'handle' && val && !val.startsWith('@')) {
                                val = '@' + val;
                            }
                            this.data[key] = val;
                            this.save();
                            this.updateUI();
                        });
                    };

                    ['name', 'handle', 'status', 'location'].forEach(key => setupInlineEdit(key));

                    if (this.els.cover) {
                        this.els.cover.addEventListener('click', (event) => {
                            if (event.target.closest('[data-no-bg-change]')) return;
                            this.openModal('bodyImage', 'image', '背景图片');
                        });
                    }

                    if (this.els.bottom) {
                        this.els.bottom.addEventListener('click', (event) => {
                            if (event.target.closest('[data-no-bg-change]')) return;
                            this.openModal('bottomImage', 'image', '底部背景');
                        });
                    }

                    if (this.els.saveButton) {
                        this.els.saveButton.addEventListener('click', () => this.saveChanges());
                    }
                    if (this.els.cancelButton) {
                        this.els.cancelButton.addEventListener('click', () => this.closeModal());
                    }
                    if (this.els.closeButton) {
                        this.els.closeButton.addEventListener('click', () => this.closeModal());
                    }
                    if (this.els.modal) {
                        this.els.modal.addEventListener('click', (e) => {
                            if (e.target === this.els.modal) this.closeModal();
                        });
                    }

                    if (this.els.imageUrlInput) {
                        this.els.imageUrlInput.addEventListener('input', (e) => {
                            this.tempValue = e.target.value;
                            if (this.els.imagePreview) {
                                this.els.imagePreview.src = this.tempValue;
                                this.els.imagePreview.classList.toggle('hidden', !this.tempValue);
                            }
                        });
                    }
                    if (this.els.textInput) {
                        this.els.textInput.addEventListener('input', (e) => {
                            this.tempValue = e.target.value;
                        });
                    }
                    if (this.els.textareaInput) {
                        this.els.textareaInput.addEventListener('input', (e) => {
                            this.tempValue = e.target.value;
                        });
                    }

                    if (this.els.uploadButton && this.els.fileInput) {
                        this.els.uploadButton.addEventListener('click', () => this.els.fileInput.click());
                        this.els.fileInput.addEventListener('change', async (event) => {
                            const file = event.target.files && event.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = () => {
                                this.tempValue = String(reader.result || '');
                                if (this.els.imageUrlInput) this.els.imageUrlInput.value = '';
                                if (this.els.imagePreview) {
                                    this.els.imagePreview.src = this.tempValue;
                                    this.els.imagePreview.classList.remove('hidden');
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                }

                init() {
                    this.load();
                    this.updateUI();
                    this.bindEvents();
                }
            }

            // ========== APP入口清单（集中管理） ==========
            const APP_ENTRY_POINTS = {
                home: ['message', 'feixin', 'worldbook', 'settings', 'phone', 'forum'],
                dock: ['phone', 'novel', 'forum']
            };

            function openAppWithNotice(appId, name, notice) {
                launchApp(appId);
                if (notice) alert(notice);
            }

            const APP_HANDLERS = {
                message: () => openAppWithNotice('message', '消息', '消息功能开发中...'),
                feixin: () => {
                    launchApp('feixin');
                    friendListModal.style.display = 'flex';
                    renderFriendList();
                },
                worldbook: () => {
                    launchApp('worldbook');
                    const worldbookModal = document.getElementById('worldbookModal');
                    if (worldbookModal) {
                        worldbookModal.style.display = 'flex';
                    }
                },
                settings: () => {
                    launchApp('settings');
                    settingsModal.style.display = 'flex';
                    if (apiService) apiService.updateSettingsDisplay();
                },
                beautify: () => openAppWithNotice('beautify', '美化', '美化功能开发中...'),
                phone: () => openAppWithNotice('phone', '手机', '手机功能开发中...'),
                novel: () => openAppWithNotice('novel', '小说', '小说功能开发中...'),
                forum: () => openAppWithNotice('forum', '论坛', '论坛功能开发中...')
            };

            // ========== 图标点击事件 ==========
            function handleAppClick(appId) {
                const handler = APP_HANDLERS[appId];
                if (handler) {
                    handler();
                    return;
                }
                launchApp(appId);
                alert('功能开发中...');
            }

            // Dock栏图标
            if (phoneIcon) {
                phoneIcon.addEventListener('click', () => handleAppClick('phone'));
            }

            if (novelIcon) {
                novelIcon.addEventListener('click', () => handleAppClick('novel'));
            }

            if (forumIcon) {
                forumIcon.addEventListener('click', () => handleAppClick('forum'));
            }

            // ========== 模态窗口控制 ==========

            closeApiModal.addEventListener('click', () => {
                apiModal.style.display = 'none';
                apiStatus.style.display = 'none';
                settingsModal.style.display = 'flex';
            });

            backToFriendList.addEventListener('click', () => {
                if (chatSession && chatSession.multiSelect && chatSession.multiSelect.active) {
                    chatSession.exitMultiSelectMode();
                }
                chatModal.style.display = 'none';
                chatStatus.style.display = 'none';
                if (heartVoiceSystem) heartVoiceSystem.closePopup();
                friendListModal.style.display = 'flex';
                renderFriendList();
            });

            closeSettingsModal.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });


            if (settingsApiCard) {
                settingsApiCard.addEventListener('click', () => {
                    settingsModal.style.display = 'none';
                    apiModal.style.display = 'flex';

                    if (!apiService) return;
                    const config = apiService.getConfig();
                    if (config.apiUrl) {
                        apiUrlInput.value = config.apiUrl;
                    }
                    if (config.apiKey) {
                        apiKeyInput.value = config.apiKey;
                    }
                    if (config.models && config.models.length > 0) {
                        apiService.updateModelSelect(config.models);
                    }
                    // 打开模态框时重新渲染预设列表
                    apiService.renderPresetList();
                });
            }

            if (settingsDataCard) {
                settingsDataCard.addEventListener('click', () => {
                    dataManageModal.style.display = 'flex';
                });
            }

            if (closeDataManageModal) {
                closeDataManageModal.addEventListener('click', () => {
                    dataManageModal.style.display = 'none';
                });
            }

            closeFriendListModal.addEventListener('click', () => {
                friendListModal.style.display = 'none';
            });

            // 好友列表导航栏事件处理
            const navItems = document.querySelectorAll('.friend-list-nav-item');
            if (navItems.length > 0) {
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const navType = item.dataset.nav;
                        navItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');

                        if (navType === 'messages') {
                            // 当前已是消息列表，无需做额外处理
                            console.log('显示消息列表');
                        } else if (navType === 'moments') {
                            alert('动态功能开发中...');
                        } else if (navType === 'me') {
                            // 切页到“我”：隐藏好友列表，避免叠层弹出感
                            friendListModal.style.display = 'none';
                            openProfileModal({ from: 'friendList' });
                        }
                    });
                });
            }

            // 好友列表中的添加好友按钮
            const addFriendFromList = document.getElementById('addFriendFromList');
            if (addFriendFromList) {
                addFriendFromList.addEventListener('click', () => {
                    addFriendModal.style.display = 'flex';
                    resetAddFriendForm();
                });
            }

            closeAddFriendModal.addEventListener('click', () => {
                addFriendModal.style.display = 'none';
                resetAddFriendForm();
            });

            // 个人资料小组件交互（新）由 ProfileWidget 统一管理

            // 好友设置相关
            const charSettingsModal = document.getElementById('charSettingsModal');
            const charSettingsBtn = document.getElementById('charSettingsBtn');
            const charSettingsBack = document.getElementById('charSettingsBack');
            const charNameInput = document.getElementById('charNameInput');
            const charPersonaInput = document.getElementById('charPersonaInput');
            const charAvatarDisplay = document.getElementById('charAvatarDisplay');
            const charAvatarInput = document.getElementById('charAvatarInput');
            const voiceIdInput = document.getElementById('voiceIdInput');
            const voiceIdMode = document.getElementById('voiceIdMode');
            const voiceIdStatus = document.getElementById('voiceIdStatus');
            const chatShowTimeToggle = document.getElementById('chatShowTimeToggle');
            const chatReadToggle = document.getElementById('chatReadToggle');
            const chatHideAvatarToggle = document.getElementById('chatHideAvatarToggle');
            const avatarPickerModal = document.getElementById('avatarPickerModal');
            const charAvatarUrlModalInput = document.getElementById('charAvatarUrlModalInput');
            const charAvatarFileModalInput = document.getElementById('charAvatarFileModalInput');
            const charAvatarModalPreview = document.getElementById('charAvatarModalPreview');
            const cancelAvatarPicker = document.getElementById('cancelAvatarPicker');
            const confirmAvatarPicker = document.getElementById('confirmAvatarPicker');
            const saveCharSettingsBtn = document.getElementById('saveCharSettingsBtn');
            const deleteCharBtn = document.getElementById('deleteCharBtn');
            let pendingCharAvatar = '';
            let modalAvatarTemp = '';

            function updateVoiceStatus(value) {
                if (!voiceIdStatus) return;
                const hasValue = !!value;
                voiceIdStatus.textContent = hasValue ? '已设置' : '未设置';
            }

            function setCharAvatarDisplay(avatarUrl) {
                if (!charAvatarDisplay) return;
                if (avatarUrl) {
                    charAvatarDisplay.style.backgroundImage = `url('${avatarUrl}')`;
                    charAvatarDisplay.classList.add('has-image');
                } else {
                    charAvatarDisplay.style.backgroundImage = '';
                    charAvatarDisplay.classList.remove('has-image');
                }
            }

            function setAvatarModalPreview(avatarUrl) {
                if (!charAvatarModalPreview) return;
                if (avatarUrl) {
                    charAvatarModalPreview.style.backgroundImage = `url('${avatarUrl}')`;
                    charAvatarModalPreview.innerHTML = '';
                } else {
                    charAvatarModalPreview.style.backgroundImage = '';
                    charAvatarModalPreview.innerHTML = '<i class="fas fa-user"></i>';
                }
            }

            // 打开好友设置
            charSettingsBtn.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);

                    if (friend) {
                        charNameInput.value = friend.name;
                        charPersonaInput.value = friend.persona || '';
                        pendingCharAvatar = friend.avatar || '';
                        setCharAvatarDisplay(pendingCharAvatar);
                        if (voiceIdInput) {
                            voiceIdInput.value = friend.voiceId || '';
                            updateVoiceStatus(voiceIdInput.value.trim());
                        }
                        if (voiceIdMode) {
                            voiceIdMode.value = friend.voiceIdMode || 'auto';
                        }
                        if (chatShowTimeToggle) {
                            chatShowTimeToggle.checked = friend.chatShowTime ?? true;
                        }
                        if (chatReadToggle) {
                            chatReadToggle.checked = friend.chatReadStatus ?? true;
                        }
                        if (chatHideAvatarToggle) {
                            chatHideAvatarToggle.checked = friend.chatHideAvatar ?? false;
                        }
                        if (charAvatarInput) {
                            charAvatarInput.value = '';
                        }
                        modalAvatarTemp = pendingCharAvatar || '';
                        charSettingsModal.style.display = 'flex';
                    }
                }
            });

            // 关闭好友设置
            if (charSettingsBack) {
                charSettingsBack.addEventListener('click', () => {
                    charSettingsModal.style.display = 'none';
                });
            }

            // 点击背景关闭
            charSettingsModal.addEventListener('click', (e) => {
                if (e.target === charSettingsModal) {
                    charSettingsModal.style.display = 'none';
                }
            });

            // 更换头像
            function openAvatarPicker() {
                if (!avatarPickerModal) return;
                modalAvatarTemp = pendingCharAvatar || '';
                if (charAvatarUrlModalInput) {
                    charAvatarUrlModalInput.value = modalAvatarTemp && !modalAvatarTemp.startsWith('data:') ? modalAvatarTemp : '';
                }
                if (charAvatarFileModalInput) {
                    charAvatarFileModalInput.value = '';
                }
                setAvatarModalPreview(modalAvatarTemp);
                avatarPickerModal.style.display = 'flex';
            }

            if (charAvatarDisplay) {
                charAvatarDisplay.addEventListener('click', openAvatarPicker);
            }

            if (charAvatarUrlModalInput) {
                charAvatarUrlModalInput.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    modalAvatarTemp = url;
                    setAvatarModalPreview(url);
                });
            }

            if (voiceIdInput) {
                voiceIdInput.addEventListener('input', (e) => {
                    updateVoiceStatus(e.target.value.trim());
                });
            }

            if (charAvatarFileModalInput) {
                charAvatarFileModalInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        modalAvatarTemp = imageUrl;
                        // 立即更新到pendingCharAvatar，实现即时预览
                        pendingCharAvatar = imageUrl;
                        setAvatarModalPreview(imageUrl);
                        setCharAvatarDisplay(imageUrl);
                        if (charAvatarUrlModalInput) {
                            charAvatarUrlModalInput.value = '';
                        }

                        // Safari兼容性：强制重绘
                        if (charAvatarDisplay) {
                            void charAvatarDisplay.offsetWidth;
                            charAvatarDisplay.style.opacity = '0.99';
                            setTimeout(() => {
                                charAvatarDisplay.style.opacity = '1';
                            }, 10);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (cancelAvatarPicker && avatarPickerModal) {
                cancelAvatarPicker.addEventListener('click', () => {
                    avatarPickerModal.style.display = 'none';
                });
            }

            if (confirmAvatarPicker && avatarPickerModal) {
                confirmAvatarPicker.addEventListener('click', () => {
                    const urlValue = charAvatarUrlModalInput ? charAvatarUrlModalInput.value.trim() : '';
                    // 优先使用URL输入，其次使用已上传的文件（pendingCharAvatar已在文件选择时更新）
                    if (urlValue) {
                        pendingCharAvatar = urlValue;
                    } else if (!pendingCharAvatar && modalAvatarTemp) {
                        pendingCharAvatar = modalAvatarTemp;
                    }
                    // 如果pendingCharAvatar已有值（文件上传时设置），则保持不变
                    setCharAvatarDisplay(pendingCharAvatar);
                    avatarPickerModal.style.display = 'none';
                });
            }

            if (avatarPickerModal) {
                avatarPickerModal.addEventListener('click', (e) => {
                    if (e.target === avatarPickerModal) {
                        avatarPickerModal.style.display = 'none';
                    }
                });
            }

            // 保存好友设置
            saveCharSettingsBtn.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                const newName = charNameInput.value.trim();

                if (!newName) {
                    showCuteToast('请输入好友昵称');
                    return;
                }

                const updated = friendSystem ? friendSystem.updateFriend(currentFriendId, {
                    name: newName,
                    persona: charPersonaInput.value.trim(),
                    avatar: pendingCharAvatar || null,
                    voiceId: voiceIdInput ? voiceIdInput.value.trim() : '',
                    voiceIdMode: voiceIdMode ? voiceIdMode.value : 'auto',
                    chatShowTime: chatShowTimeToggle ? chatShowTimeToggle.checked : true,
                    chatReadStatus: chatReadToggle ? chatReadToggle.checked : true,
                    chatHideAvatar: chatHideAvatarToggle ? chatHideAvatarToggle.checked : false
                }) : null;
                if (updated) {
                    charSettingsModal.style.display = 'none';
                    if (chatSession) {
                        // 更新聊天对话框标题
                        chatTitle.textContent = newName;

                        // 更新聊天界面头像
                        const chatHeader = chatModal.querySelector('.modal-header');
                        const existingAvatar = document.getElementById('chatFriendAvatarIcon');

                        if (existingAvatar) {
                            existingAvatar.remove();
                        }

                        if (pendingCharAvatar && chatHeader) {
                            const avatarIcon = document.createElement('div');
                            avatarIcon.id = 'chatFriendAvatarIcon';
                            avatarIcon.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center;';

                            const avatarImg = document.createElement('img');
                            avatarImg.src = pendingCharAvatar;
                            avatarImg.alt = newName;
                            avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                            avatarImg.onerror = () => {
                                avatarIcon.innerHTML = '<i class="fas fa-user" style="font-size: 16px; color: #999;"></i>';
                            };

                            avatarIcon.appendChild(avatarImg);
                            chatHeader.insertBefore(avatarIcon, chatTitle);
                        }

                        chatSession.showChatStatus('好友设置已保存', 'success');
                    }
                    // 刷新好友列表
                    renderFriendList();
                }
            });

            // 删除好友
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const confirmDeleteYes = document.getElementById('confirmDeleteYes');
            const confirmDeleteNo = document.getElementById('confirmDeleteNo');

            deleteCharBtn.addEventListener('click', () => {
                confirmDeleteModal.style.display = 'flex';
            });

            confirmDeleteYes.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                const removed = friendSystem ? friendSystem.deleteFriend(currentFriendId) : null;

                if (removed && currentFriendId) {
                    // 清除该好友的所有相关数据
                    // 1. 删除好友的聊天历史
                    localStorage.removeItem(`chat_${currentFriendId}`);

                    // 2. 删除好友的人设数据
                    localStorage.removeItem(`persona_${currentFriendId}`);

                    // 3. 删除好友的心声数据
                    localStorage.removeItem(`heartvoice_${currentFriendId}`);

                    // 4. 删除好友的其他相关配置
                    const allKeys = Object.keys(localStorage);
                    allKeys.forEach(key => {
                        if (key.includes(currentFriendId)) {
                            localStorage.removeItem(key);
                        }
                    });

                    confirmDeleteModal.style.display = 'none';
                    charSettingsModal.style.display = 'none';
                    chatModal.style.display = 'none';
                    if (chatSession) chatSession.setCurrentFriendId(null);
                    friendListModal.style.display = 'flex';
                    renderFriendList();
                }
            });

            confirmDeleteNo.addEventListener('click', () => {
                confirmDeleteModal.style.display = 'none';
            });

            // ========== 世界书挂载模块 ==========
            const worldbookMountBtn = document.getElementById('worldbookMountBtn');
            const worldbookMountModal = document.getElementById('worldbookMountModal');
            const worldbookMountList = document.getElementById('worldbookMountList');
            const worldbookMountCancel = document.getElementById('worldbookMountCancel');
            const worldbookMountSave = document.getElementById('worldbookMountSave');

            // 初始化世界书列表
            function initWorldbookMountList() {
                const worldBookSystem = window.worldBookSystem;
                if (!worldBookSystem) return;

                const books = worldBookSystem.books || [];
                worldbookMountList.innerHTML = '';

                if (books.length === 0) {
                    worldbookMountList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">还没有世界书</div>';
                    return;
                }

                // 获取当前好友已挂载的世界书列表
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                let mountedBooks = [];
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);
                    if (friend && friend.mountedWorldBooks) {
                        mountedBooks = Array.isArray(friend.mountedWorldBooks) ?
                            friend.mountedWorldBooks.map(id => String(id)) : [];
                    }
                }

                books.forEach(book => {
                    const label = document.createElement('label');
                    label.className = 'worldbook-mount-item';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = book.id;
                    checkbox.dataset.bookId = book.id;
                    // 恢复之前的勾选状态
                    checkbox.checked = mountedBooks.includes(String(book.id));

                    const text = document.createElement('span');
                    text.className = 'worldbook-mount-item-text';
                    text.textContent = book.title;

                    label.appendChild(checkbox);
                    label.appendChild(text);

                    // 点击卡片任意位置都能切换勾选框
                    label.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                    });

                    worldbookMountList.appendChild(label);
                });
            }

            // 打开世界书挂载弹窗
            if (worldbookMountBtn) {
                worldbookMountBtn.addEventListener('click', () => {
                    initWorldbookMountList();
                    worldbookMountModal.style.display = 'flex';
                });
            }

            // 关闭弹窗（取消）
            if (worldbookMountCancel) {
                worldbookMountCancel.addEventListener('click', () => {
                    worldbookMountModal.style.display = 'none';
                });
            }

            // 保存选中的世界书
            if (worldbookMountSave) {
                worldbookMountSave.addEventListener('click', () => {
                    const checkboxes = worldbookMountList.querySelectorAll('input[type="checkbox"]');
                    const selectedBooks = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    // 保存到当前好友
                    const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                    if (currentFriendId && friendSystem) {
                        friendSystem.updateFriend(currentFriendId, {
                            mountedWorldBooks: selectedBooks
                        });
                        showCuteToast('保存成功');
                    }

                    worldbookMountModal.style.display = 'none';
                });
            }

            // 点击弹窗背景关闭
            if (worldbookMountModal) {
                worldbookMountModal.addEventListener('click', (e) => {
                    if (e.target === worldbookMountModal) {
                        worldbookMountModal.style.display = 'none';
                    }
                });
            }

            // ========== HTML游戏挂载模块 ==========
            const htmlGameMountBtn = document.getElementById('htmlGameMountBtn');
            const htmlGameMountModal = document.getElementById('htmlGameMountModal');
            const htmlGameMountList = document.getElementById('htmlGameMountList');
            const htmlGameMountCancel = document.getElementById('htmlGameMountCancel');
            const htmlGameMountSave = document.getElementById('htmlGameMountSave');

            // 初始化HTML游戏列表
            function initHtmlGameMountList() {
                const htmlGameSystem = window.htmlGameSystem;
                if (!htmlGameSystem) return;

                const games = htmlGameSystem.games || [];
                htmlGameMountList.innerHTML = '';

                if (games.length === 0) {
                    htmlGameMountList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">还没有HTML游戏</div>';
                    return;
                }

                // 获取当前好友已挂载的HTML游戏列表
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                let mountedGames = [];
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);
                    if (friend && friend.mountedHtmlGames) {
                        mountedGames = Array.isArray(friend.mountedHtmlGames) ?
                            friend.mountedHtmlGames.map(id => String(id)) : [];
                    }
                }

                games.forEach(game => {
                    const label = document.createElement('label');
                    label.className = 'worldbook-mount-item';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = game.id;
                    checkbox.dataset.gameId = game.id;
                    // 恢复之前的勾选状态
                    checkbox.checked = mountedGames.includes(String(game.id));

                    const text = document.createElement('span');
                    text.className = 'worldbook-mount-item-text';
                    text.textContent = game.title;

                    label.appendChild(checkbox);
                    label.appendChild(text);

                    // 点击卡片任意位置都能切换勾选框
                    label.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                    });

                    htmlGameMountList.appendChild(label);
                });
            }

            // 打开HTML游戏挂载弹窗
            if (htmlGameMountBtn) {
                htmlGameMountBtn.addEventListener('click', () => {
                    initHtmlGameMountList();
                    htmlGameMountModal.style.display = 'flex';
                });
            }

            // 关闭弹窗（取消）
            if (htmlGameMountCancel) {
                htmlGameMountCancel.addEventListener('click', () => {
                    htmlGameMountModal.style.display = 'none';
                });
            }

            // 保存选中的HTML游戏
            if (htmlGameMountSave) {
                htmlGameMountSave.addEventListener('click', () => {
                    const checkboxes = htmlGameMountList.querySelectorAll('input[type="checkbox"]');
                    const selectedGames = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    // 保存到当前好友
                    const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                    if (currentFriendId && friendSystem) {
                        friendSystem.updateFriend(currentFriendId, {
                            mountedHtmlGames: selectedGames
                        });
                        showCuteToast('保存成功');
                    }

                    htmlGameMountModal.style.display = 'none';
                });
            }

            // 点击弹窗背景关闭
            if (htmlGameMountModal) {
                htmlGameMountModal.addEventListener('click', (e) => {
                    if (e.target === htmlGameMountModal) {
                        htmlGameMountModal.style.display = 'none';
                    }
                });
            }

            function downloadJson(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }

            function collectOtherSettings() {
                const otherSettings = {};
                const reservedPrefixes = ['chat_'];
                const reservedKeys = new Set([
                    'apiConfig',
                    'friends',
                    'profileWidgetV2Data',
                    'homeGreeting'
                ]);
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key) continue;
                    if (reservedKeys.has(key)) continue;
                    if (reservedPrefixes.some(prefix => key.startsWith(prefix))) continue;
                    try {
                        otherSettings[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        otherSettings[key] = localStorage.getItem(key);
                    }
                }
                return otherSettings;
            }

            function collectChatHistories(friendsList = []) {
                const chatHistories = {};
                friendsList.forEach(friend => {
                    if (!friend || !friend.id) return;
                    chatHistories[friend.id] = friendSystem
                        ? friendSystem.getFriendChatHistory(friend.id)
                        : [];
                });
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (!key || !key.startsWith('chat_')) continue;
                    const friendId = key.replace('chat_', '');
                    if (!chatHistories[friendId]) {
                        try {
                            chatHistories[friendId] = JSON.parse(localStorage.getItem(key)) || [];
                        } catch (e) {
                            chatHistories[friendId] = [];
                        }
                    }
                }
                return chatHistories;
            }

            function buildExportPayload(customData = {}) {
                return {
                    exportVersion: '1.0',
                    exportTime: new Date().toISOString(),
                    data: customData
                };
            }

            function exportAllData() {
                const friends = friendSystem ? friendSystem.getFriends() : [];
                const payload = buildExportPayload({
                    apiConfig: apiService ? apiService.getConfig() : {},
                    friends: friends,
                    chatHistories: collectChatHistories(friends),
                    profileWidget: friendSystem ? friendSystem.getStorage('profileWidgetV2Data', {}) : {},
                    homeGreeting: friendSystem ? friendSystem.getStorage('homeGreeting', '') : '',
                    otherSettings: collectOtherSettings()
                });
                downloadJson(payload, `app_backup_all_${Date.now()}.json`);
            }

            function exportFriendsData() {
                const friends = friendSystem ? friendSystem.getFriends() : [];
                const payload = buildExportPayload({
                    friends: friends
                });
                downloadJson(payload, `app_backup_friends_${Date.now()}.json`);
            }

            function exportChatsData() {
                const friends = friendSystem ? friendSystem.getFriends() : [];
                const payload = buildExportPayload({
                    chatHistories: collectChatHistories(friends)
                });
                downloadJson(payload, `app_backup_chats_${Date.now()}.json`);
            }

            function applyImportPayload(payload) {
                if (!payload || !payload.data || typeof payload.data !== 'object') {
                    throw new Error('数据格式不正确');
                }

                const data = payload.data;
                localStorage.clear();

                if (data.apiConfig) {
                    localStorage.setItem('apiConfig', JSON.stringify(data.apiConfig));
                }
                if (data.friends) {
                    localStorage.setItem('friends', JSON.stringify(data.friends));
                }
                if (data.profileWidget) {
                    localStorage.setItem('profileWidgetV2Data', JSON.stringify(data.profileWidget));
                }
                if (data.homeGreeting !== undefined) {
                    localStorage.setItem('homeGreeting', JSON.stringify(data.homeGreeting));
                }
                if (data.chatHistories && typeof data.chatHistories === 'object') {
                    Object.keys(data.chatHistories).forEach(friendId => {
                        localStorage.setItem(`chat_${friendId}`, JSON.stringify(data.chatHistories[friendId] || []));
                    });
                }
                if (data.otherSettings && typeof data.otherSettings === 'object') {
                    Object.keys(data.otherSettings).forEach(key => {
                        localStorage.setItem(key, JSON.stringify(data.otherSettings[key]));
                    });
                }

                if (friendSystem) friendSystem.init();
                if (apiService) apiService.updateSettingsDisplay();
                if (profileWidget) {
                    profileWidget.load();
                    profileWidget.updateUI();
                }
                renderFriendList();
            }

            function handleImportFile(file) {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const payload = JSON.parse(String(reader.result || '{}'));
                        const confirmImport = confirm('导入将覆盖当前所有数据，是否继续？');
                        if (!confirmImport) return;
                        applyImportPayload(payload);
                        alert('导入完成');
                    } catch (e) {
                        alert('导入失败：JSON 格式不正确');
                    }
                };
                reader.readAsText(file);
            }

            if (exportAllDataBtn) {
                exportAllDataBtn.addEventListener('click', exportAllData);
            }
            if (exportFriendsDataBtn) {
                exportFriendsDataBtn.addEventListener('click', exportFriendsData);
            }
            if (exportChatsDataBtn) {
                exportChatsDataBtn.addEventListener('click', exportChatsData);
            }
            if (importAllDataBtn && importFileInput) {
                importAllDataBtn.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (file) {
                        handleImportFile(file);
                    }
                    importFileInput.value = '';
                });
            }

            // 点击模态窗口外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === apiModal) {
                    apiModal.style.display = 'none';
                    apiStatus.style.display = 'none';
                    settingsModal.style.display = 'flex';
                }
                if (e.target === chatModal) {
                    chatModal.style.display = 'none';
                    chatStatus.style.display = 'none';
                }
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
                if (e.target === friendListModal) {
                    friendListModal.style.display = 'none';
                }
                if (e.target === addFriendModal) {
                    addFriendModal.style.display = 'none';
                    resetAddFriendForm();
                }
                if (e.target === dataManageModal) {
                    dataManageModal.style.display = 'none';
                }
            });

            // ========== 好友管理功能 ==========
            class FriendSystem {
                constructor() {
                    this.cache = new Map();
                    this.lastSnapshot = '';
                    this.syncTimer = null;
                    this.CHECK_INTERVAL = 5000;
                    this.listeners = new Set();
                }

                parsePersonaText(text) {
                    const raw = (text || '').trim();
                    if (!raw) {
                        return {
                            raw: '',
                            summary: '',
                            keywords: [],
                            likes: [],
                            dislikes: []
                        };
                    }

                    const sentences = raw.split(/[。！？\n]+/).map(s => s.trim()).filter(Boolean);
                    const summary = sentences[0] || raw;

                    const keywords = Array.from(new Set((raw.match(/[\u4e00-\u9fa5]{2,}/g) || []).slice(0, 20)));
                    const likes = [];
                    const dislikes = [];

                    const likeMatches = raw.match(/喜欢([^，。！？\n]+)/g) || [];
                    likeMatches.forEach(m => {
                        const item = m.replace('喜欢', '').trim();
                        if (item) likes.push(item);
                    });
                    const dislikeMatches = raw.match(/(讨厌|不喜欢)([^，。！？\n]+)/g) || [];
                    dislikeMatches.forEach(m => {
                        const item = m.replace('讨厌', '').replace('不喜欢', '').trim();
                        if (item) dislikes.push(item);
                    });

                    return {
                        raw,
                        summary,
                        keywords,
                        likes,
                        dislikes
                    };
                }

                getStorage(key, defaultValue = null) {
                    const saved = localStorage.getItem(key);
                    if (!saved) return defaultValue;
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        console.error('读取本地存储失败:', e);
                        return defaultValue;
                    }
                }

                setStorage(key, value) {
                    // 同步写入localStorage，确保立即可读
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                    } catch (e) {
                        console.error('保存到localStorage失败:', e);
                    }
                }

                rebuildCacheFromFriends(friends) {
                    this.cache.clear();
                    friends.forEach(friend => {
                        const personaText = friend.persona || '';
                        this.cache.set(friend.id, {
                            id: friend.id,
                            name: friend.name || '',
                            raw: personaText,
                            parsed: this.parsePersonaText(personaText),
                            updatedAt: Date.now()
                        });
                    });
                    this.lastSnapshot = JSON.stringify(friends);
                    this.emitChange({ type: 'friends', friends });
                }

                ensureSync() {
                    const saved = localStorage.getItem('friends') || '';
                    if (!saved && this.lastSnapshot) {
                        this.cache.clear();
                        this.lastSnapshot = '';
                        return;
                    }
                    if (saved && saved !== this.lastSnapshot) {
                        try {
                            const friends = JSON.parse(saved);
                            this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
                        } catch (e) {
                            console.error('同步人设缓存失败:', e);
                        }
                    }
                }

                init() {
                    this.ensureSync();
                    if (this.syncTimer) {
                        clearInterval(this.syncTimer);
                    }
                    this.syncTimer = setInterval(() => this.ensureSync(), this.CHECK_INTERVAL);
                }

                getPersona(id) {
                    if (!id) return null;
                    this.ensureSync();
                    return this.cache.get(id) || null;
                }

                syncFromFriends(friends) {
                    this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
                }

                onChange(handler) {
                    if (typeof handler === 'function') {
                        this.listeners.add(handler);
                    }
                    return () => this.listeners.delete(handler);
                }

                emitChange(payload) {
                    this.listeners.forEach(handler => {
                        try {
                            handler(payload);
                        } catch (e) {
                            console.error('人设变化回调异常:', e);
                        }
                    });
                }

                getFriends() {
                    const friends = this.getStorage('friends', []);
                    return Array.isArray(friends) ? friends : [];
                }

                saveFriends(friends) {
                    this.setStorage('friends', friends);
                    this.syncFromFriends(friends);
                }

                getFriendById(friendId) {
                    const friends = this.getFriends();
                    return friends.find(friend => friend.id === friendId) || null;
                }

                addFriend(friend) {
                    const friends = this.getFriends();
                    friends.push(friend);
                    this.saveFriends(friends);
                    return friend;
                }

                updateFriend(friendId, updates = {}) {
                    const friends = this.getFriends();
                    const index = friends.findIndex(friend => friend.id === friendId);
                    if (index === -1) return null;
                    friends[index] = { ...friends[index], ...updates };
                    this.saveFriends(friends);
                    return friends[index];
                }

                deleteFriend(friendId) {
                    const friends = this.getFriends();
                    const index = friends.findIndex(friend => friend.id === friendId);
                    if (index === -1) return null;
                    const [removed] = friends.splice(index, 1);
                    this.saveFriends(friends);
                    return removed;
                }

                getFriendChatHistory(friendId) {
                    // 每次都从localStorage直接读取，确保获取最新数据
                    const history = this.getStorage(`chat_${friendId}`, []);
                    return Array.isArray(history) ? history : [];
                }

                saveFriendChatHistory(friendId, messages) {
                    this.setStorage(`chat_${friendId}`, messages);
                }

                // 清理定时器，防止内存泄漏
                destroy() {
                    if (this.syncTimer) {
                        clearInterval(this.syncTimer);
                        this.syncTimer = null;
                    }
                    this.cache.clear();
                    this.listeners.clear();
                }
            }

            // 渲染好友列表
            function renderFriendList() {
                const friends = friendSystem ? friendSystem.getFriends() : [];
                friendListElement.innerHTML = '';

                if (friends.length === 0) {
                    noFriends.style.display = 'flex';
                    return;
                }

                noFriends.style.display = 'none';

                friends.forEach(friend => {
                    const friendItem = document.createElement('div');
                    friendItem.className = 'friend-item';

                    // 创建头像元素
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'friend-avatar';
                    if (friend.avatar) {
                        const img = document.createElement('img');
                        img.src = friend.avatar;
                        img.alt = friend.name;

                        // 图片加载失败时显示默认图标
                        img.onerror = () => {
                            avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
                        };

                        // Safari兼容性：确保图片加载后立即显示
                        img.onload = () => {
                            void avatarDiv.offsetWidth;
                        };

                        avatarDiv.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-user';
                        avatarDiv.appendChild(icon);
                    }

                    // 创建信息元素
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'friend-info';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'friend-name';
                    nameDiv.textContent = friend.name;

                    // 获取最后一条消息（不管是谁发的）
                    let lastMessageText = '暂无消息';
                    if (friendSystem && typeof friendSystem.getFriendChatHistory === 'function') {
                        try {
                            const history = friendSystem.getFriendChatHistory(friend.id) || [];
                            if (Array.isArray(history) && history.length > 0) {
                                // 倒序查找，获取最后一条未删除、未撤回的消息
                                for (let i = history.length - 1; i >= 0; i--) {
                                    const msg = history[i];
                                    if (!msg.isDeletedLocal && !msg.isRecalled) {
                                        // 处理不同类型的消息
                                        if (msg.isVoice) {
                                            lastMessageText = '[语音]';
                                        } else if (msg.imageData) {
                                            lastMessageText = '[图片]';
                                        } else if (msg.content) {
                                            // 截断长消息，显示前40个字符
                                            const preview = msg.content.trim();
                                            lastMessageText = preview.length > 40
                                                ? preview.substring(0, 40) + '...'
                                                : preview;
                                        }
                                        break;
                                    }
                                }
                            }
                        } catch (e) {
                            lastMessageText = '暂无消息';
                        }
                    }

                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'friend-persona';
                    messageDiv.textContent = lastMessageText;

                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(messageDiv);

                    friendItem.appendChild(avatarDiv);
                    friendItem.appendChild(infoDiv);

                    friendItem.addEventListener('click', () => {
                        friendListModal.style.display = 'none';
                        if (chatSession) chatSession.openChatWithFriend(friend);
                    });

                    friendListElement.appendChild(friendItem);
                });
            }

            // 将 renderFriendList 暴露到全局作用域，以便在聊天时实时更新
            window.updateFriendList = renderFriendList;

            // 打开与好友的聊天由 ChatSession 统一处理

            // 重置添加好友表单
            function resetAddFriendForm() {
                friendName.value = '';
                friendPersona.value = '';
                pendingAddFriendAvatar = '';
                avatarPreview.style.backgroundImage = '';
                avatarPreview.classList.remove('has-image');
                addFriendStatus.style.display = 'none';
                avatarInput.value = '';
            }

            // 显示添加好友状态
            function showAddFriendStatus(message, type) {
                addFriendStatus.textContent = message;
                addFriendStatus.className = `status-message ${type}`;
                addFriendStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        resetAddFriendForm();
                        addFriendModal.style.display = 'none';
                        renderFriendList();
                    }, 1500);
                }
            }

            // 头像上传处理
            let pendingAddFriendAvatar = '';

            avatarPreview.addEventListener('click', () => {
                avatarInput.click();
            });

            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        pendingAddFriendAvatar = imageUrl;
                        avatarPreview.style.backgroundImage = `url('${imageUrl}')`;
                        avatarPreview.classList.add('has-image');

                        // Safari兼容性：强制重绘确保图片显示
                        void avatarPreview.offsetWidth;
                        avatarPreview.style.opacity = '0.99';
                        setTimeout(() => {
                            avatarPreview.style.opacity = '1';
                        }, 10);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 添加好友
            confirmAddFriend.addEventListener('click', () => {
                const name = friendName.value.trim();
                const persona = friendPersona.value.trim();
                const avatar = pendingAddFriendAvatar || '';

                if (!name) {
                    showAddFriendStatus('请输入昵称', 'error');
                    return;
                }

                if (!persona) {
                    showAddFriendStatus('请输入人设', 'error');
                    return;
                }

                if (persona.length > 5000) {
                    showAddFriendStatus('人设最多5000字', 'error');
                    return;
                }

                // 生成唯一ID：时间戳后4位 + 4位随机数（共8字符），检查重复
                let friendId = '';
                let isUnique = false;
                while (!isUnique) {
                    friendId = Date.now().toString().slice(-4) + Math.random().toString(36).substring(2, 6);
                    const existingFriends = friendSystem ? friendSystem.getFriends() : [];
                    isUnique = !existingFriends.some(f => f.id === friendId);
                }

                const newFriend = {
                    id: friendId,
                    name: name,
                    persona: persona,
                    avatar: avatar || null,
                    createdAt: new Date().toISOString()
                };

                if (friendSystem) friendSystem.addFriend(newFriend);

                showAddFriendStatus('好友添加成功！', 'success');
            });

            cancelAddFriend.addEventListener('click', () => {
                addFriendModal.style.display = 'none';
                resetAddFriendForm();
            });

            // ========== API配置功能 ==========
            class ApiService {
                constructor(friendSystemInstance) {
                    this.friendSystem = friendSystemInstance;
                }

                getConfig() {
                    const defaultConfig = {
                        apiUrl: '',
                        apiKey: '',
                        model: '',
                        models: [],
                        memoryChatCount: 50
                    };
                    const config = this.friendSystem
                        ? this.friendSystem.getStorage('apiConfig', defaultConfig)
                        : defaultConfig;
                    return config && typeof config === 'object' ? { ...defaultConfig, ...config } : defaultConfig;
                }

                saveConfig(config) {
                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiConfig', config);
                    } else {
                        localStorage.setItem('apiConfig', JSON.stringify(config));
                    }
                    this.updateSettingsDisplay();
                }

                updateSettingsDisplay() {
                    const config = this.getConfig();

                    if (config.apiUrl && config.apiKey) {
                        configStatus.textContent = '已配置';
                        configStatus.classList.add('ok');
                    } else {
                        configStatus.textContent = '未配置';
                        configStatus.classList.remove('ok');
                    }
                }

                showApiStatus(message, type) {
                    apiStatus.textContent = message;
                    apiStatus.className = `status-message ${type}`;
                    apiStatus.style.display = 'block';

                    if (type === 'success') {
                        setTimeout(() => {
                            apiStatus.style.display = 'none';
                        }, 3000);
                    }
                }

                updateModelSelect(models) {
                    modelSelect.innerHTML = '';

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '请选择模型';
                    modelSelect.appendChild(defaultOption);

                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });

                    modelSelect.disabled = false;

                    if (modelPickerButton) {
                        modelPickerButton.disabled = false;
                    }

                    const config = this.getConfig();
                    if (config.model) {
                        modelSelect.value = config.model;
                    }

                    this.updateModelPicker(models);
                }

                updateModelPicker(models) {
                    if (!modelPickerList || !modelPickerText) return;
                    modelPickerList.innerHTML = '';

                    const config = this.getConfig();
                    const currentId = config.model || modelSelect.value || '';

                    let currentName = '请选择模型';
                    models.forEach(model => {
                        if (model.id === currentId) {
                            currentName = model.name;
                        }
                    });
                    modelPickerText.textContent = currentName;

                    models.forEach(model => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'model-picker-item';
                        if (model.id === currentId) {
                            item.classList.add('is-selected');
                        }
                        item.textContent = model.name;
                        item.dataset.modelId = model.id;

                        item.addEventListener('click', () => {
                            modelSelect.value = model.id;
                            modelPickerText.textContent = model.name;
                            modelPickerList.classList.remove('is-open');

                            modelPickerList.querySelectorAll('.model-picker-item').forEach(el => {
                                el.classList.remove('is-selected');
                            });
                            item.classList.add('is-selected');
                        });

                        modelPickerList.appendChild(item);
                    });
                }

                async fetchModels() {
                    let apiUrl = apiUrlInput.value.trim();
                    const apiKey = apiKeyInput.value.trim();

                    if (!apiUrl) {
                        this.showApiStatus('请输入API地址', 'error');
                        return;
                    }

                    if (!apiKey) {
                        this.showApiStatus('请输入API密钥', 'error');
                        return;
                    }

                    if (apiUrl.endsWith('/')) {
                        apiUrl = apiUrl.slice(0, -1);
                    }

                    fetchBtnText.textContent = '拉取中...';
                    fetchLoading.style.display = 'inline-block';
                    fetchModelsBtn.disabled = true;

                    try {
                        const endpoints = [
                            '/models',
                            '/v1/models',
                            '/api/v1/models',
                            '/v1beta/models'
                        ];

                        let response = null;

                        for (const endpoint of endpoints) {
                            try {
                                let url = apiUrl;
                                if (url.endsWith('/v1') && endpoint.startsWith('/v1')) {
                                    url = url.replace(/\/v1$/, '');
                                }

                                const fullUrl = url + endpoint;
                                console.log('尝试端点:', fullUrl);

                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 10000);

                                response = await fetch(fullUrl, {
                                    headers: {
                                        'Authorization': `Bearer ${apiKey}`,
                                        'Content-Type': 'application/json'
                                    },
                                    signal: controller.signal
                                });

                                clearTimeout(timeoutId);

                                if (response.ok) {
                                    break;
                                }
                            } catch (err) {
                                console.log(`端点 ${endpoint} 失败:`, err.message);
                                continue;
                            }
                        }

                        if (!response || !response.ok) {
                            throw new Error('无法连接到API服务，请检查地址和密钥');
                        }

                        const data = await response.json();
                        console.log('API响应:', data);

                        let models = [];

                        if (data.data && Array.isArray(data.data)) {
                            models = data.data.map(model => ({
                                id: model.id,
                                name: model.id.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else if (Array.isArray(data)) {
                            models = data.map(model => ({
                                id: model.id || model,
                                name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else if (data.models && Array.isArray(data.models)) {
                            models = data.models.map(model => ({
                                id: model.id || model,
                                name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else {
                            throw new Error('无法解析模型列表');
                        }

                        if (models.length === 0) {
                            throw new Error('未找到可用模型');
                        }

                        models.sort((a, b) => a.name.localeCompare(b.name));

                        const config = this.getConfig();
                        config.models = models;
                        this.saveConfig(config);

                        this.updateModelSelect(models);

                        this.showApiStatus(`成功拉取 ${models.length} 个模型`, 'success');
                    } catch (error) {
                        console.error('拉取模型失败:', error);

                        let errorMessage = error.message;
                        if (error.name === 'AbortError') {
                            errorMessage = '请求超时，请检查网络连接';
                        } else if (error.message.includes('Failed to fetch')) {
                            errorMessage = '网络连接失败，请检查API地址';
                        } else if (error.message.includes('401')) {
                            errorMessage = 'API密钥无效或已过期';
                        } else if (error.message.includes('请求失败:')) {
                            // 提取HTTP状态码
                            errorMessage = error.message.replace('请求失败:', '').trim();
                        }

                        // 显示自定义错误弹窗
                        showCustomErrorModal(errorMessage);

                        const exampleModels = [
                            { id: 'gpt-3.5-turbo', name: 'GPT 3.5 Turbo' },
                            { id: 'gpt-4', name: 'GPT 4' },
                            { id: 'gpt-4-turbo', name: 'GPT 4 Turbo' },
                            { id: 'claude-3-haiku', name: 'Claude 3 Haiku' },
                            { id: 'gemini-pro', name: 'Gemini Pro' }
                        ];

                        this.updateModelSelect(exampleModels);
                    } finally {
                        fetchBtnText.textContent = '拉取模型列表';
                        fetchLoading.style.display = 'none';
                        fetchModelsBtn.disabled = false;
                    }
                }

                saveConfiguration() {
                    const apiUrl = apiUrlInput.value.trim();
                    const apiKey = apiKeyInput.value.trim();
                    const model = modelSelect.value;

                    if (!apiUrl) {
                        this.showApiStatus('请输入API地址', 'error');
                        return;
                    }

                    if (!apiKey) {
                        this.showApiStatus('请输入API密钥', 'error');
                        return;
                    }

                    if (!model) {
                        this.showApiStatus('请选择模型', 'error');
                        return;
                    }

                    const config = this.getConfig();
                    config.apiUrl = apiUrl;
                    config.apiKey = apiKey;
                    config.model = model;

                    this.saveConfig(config);
                    this.showApiStatus('配置已保存！', 'success');

                    setTimeout(() => {
                        apiModal.style.display = 'none';
                        apiStatus.style.display = 'none';
                    }, 2000);
                }

                // ========== API预设管理 ==========
                getPresets() {
                    const defaultPresets = [];
                    const presetsStr = this.friendSystem
                        ? this.friendSystem.getStorage('apiPresets', JSON.stringify(defaultPresets))
                        : localStorage.getItem('apiPresets') || JSON.stringify(defaultPresets);
                    try {
                        return JSON.parse(presetsStr);
                    } catch {
                        return defaultPresets;
                    }
                }

                savePreset(name, preset) {
                    const presets = this.getPresets();
                    // 检查是否已存在同名预设，若有则更新
                    const existingIndex = presets.findIndex(p => p.name === name);
                    if (existingIndex >= 0) {
                        presets[existingIndex] = { name, ...preset, savedTime: new Date().toISOString() };
                    } else {
                        presets.push({ name, ...preset, savedTime: new Date().toISOString() });
                    }

                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiPresets', JSON.stringify(presets));
                    } else {
                        localStorage.setItem('apiPresets', JSON.stringify(presets));
                    }
                }

                deletePreset(name) {
                    const presets = this.getPresets();
                    const filteredPresets = presets.filter(p => p.name !== name);
                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiPresets', JSON.stringify(filteredPresets));
                    } else {
                        localStorage.setItem('apiPresets', JSON.stringify(filteredPresets));
                    }
                }

                loadPreset(name) {
                    const presets = this.getPresets();
                    const preset = presets.find(p => p.name === name);
                    if (preset) {
                        apiUrlInput.value = preset.apiUrl;
                        apiKeyInput.value = preset.apiKey;
                        if (preset.model && modelSelect.value !== preset.model) {
                            // 如果有保存的模型，尝试设置（但不强制）
                            const options = Array.from(modelSelect.options);
                            const matchingOption = options.find(opt => opt.value === preset.model);
                            if (matchingOption) {
                                modelSelect.value = preset.model;
                            }
                        }
                        this.showApiStatus(`已加载预设: ${name}`, 'success');
                    }
                }

                renderPresetList() {
                    const container = document.getElementById('presetListContainer');
                    const drawerList = document.getElementById('apiPresetDrawerList');
                    const presets = this.getPresets();

                    if (!container) return;

                    // 主列表始终显示按钮
                    container.innerHTML = '<button id="apiPresetDrawerBtn" type="button" style="color: #333; font-size: 12px; padding: 8px; text-align: center; background: #F5F3F6; border-radius: 8px; border: none; cursor: pointer; font-weight: 500;">点击选择API预设</button>';
                    this.setupDrawerButton();

                    // 填充抽屉列表
                    if (drawerList) {
                        if (presets.length === 0) {
                            drawerList.innerHTML = '<div style="color: #999; font-size: 11px; padding: 10px; text-align: center;">暂无预设</div>';
                        } else {
                            drawerList.innerHTML = presets.map(preset => `
                                <div style="display: flex; gap: 6px; align-items: center; padding: 5px 6px;">
                                    <button data-preset-name="${preset.name}" class="preset-drawer-item" type="button" style="flex: 1; padding: 5px 6px; background: #F5F3F6; border: none; border-radius: 6px; cursor: pointer; text-align: left; font-size: 11px; color: #333; transition: background 0.2s;">
                                        <div style="font-weight: 500; font-size: 11px;">${preset.name}</div>
                                        <div style="font-size: 9px; color: #999; margin-top: 1px;">${preset.apiUrl.substring(0, 25)}...</div>
                                    </button>
                                    <button data-preset-name="${preset.name}" class="preset-delete-drawer-btn" type="button" style="width: 24px; height: 24px; min-width: 24px; padding: 0; background: #F5F3F6; border: none; border-radius: 4px; cursor: pointer; color: #999; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">×</button>
                                </div>
                            `).join('');

                            // 绑定抽屉项的点击事件
                            drawerList.querySelectorAll('.preset-drawer-item').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const name = btn.dataset.presetName;
                                    this.loadPreset(name);
                                    this.closeApiPresetDrawer();
                                });
                            });

                            // 绑定删除按钮事件
                            drawerList.querySelectorAll('.preset-delete-drawer-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const name = btn.dataset.presetName;
                                    this.deletePreset(name);
                                    this.renderPresetList();
                                });
                                // 添加hover效果
                                btn.addEventListener('mouseenter', () => {
                                    btn.style.background = '#E8E4E9';
                                    btn.style.color = '#666';
                                });
                                btn.addEventListener('mouseleave', () => {
                                    btn.style.background = '#F5F3F6';
                                    btn.style.color = '#999';
                                });
                            });
                        }
                    }
                }

                setupDrawerButton() {
                    const drawerBtn = document.getElementById('apiPresetDrawerBtn');
                    if (drawerBtn && !drawerBtn.hasListener) {
                        drawerBtn.addEventListener('click', () => this.openApiPresetDrawer());
                        drawerBtn.hasListener = true;
                    }
                }

                openApiPresetDrawer() {
                    const modal = document.getElementById('apiPresetModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                }

                closeApiPresetDrawer() {
                    const modal = document.getElementById('apiPresetModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            }

            // ========== 心声系统 ==========
            class HeartVoiceSystem {
                constructor(friendSystemInstance, apiServiceInstance) {
                    this.friendSystem = friendSystemInstance;
                    this.apiService = apiServiceInstance;
                    this.popup = document.getElementById('heartVoicePopup');
                    this.textEl = document.getElementById('heartVoiceText');
                    this.statusEl = document.getElementById('heartVoiceStatus');
                    this.moodFillEl = document.getElementById('heartVoiceMoodFill');
                    this.moodLabelEl = document.getElementById('heartVoiceMoodLabel');
                    this.demeanorEl = document.getElementById('heartVoiceDemeanor');
                    this.btn = document.getElementById('heartVoiceBtn');

                    this.historyBtn = document.getElementById('heartVoiceHistoryBtn');
                    this.historyModal = document.getElementById('heartVoiceHistoryModal');
                    this.historyList = document.getElementById('heartVoiceHistoryList');
                    this.closeHistoryBtn = document.getElementById('closeHeartVoiceHistoryModal');

                    this.deleteModal = document.getElementById('hvDeleteModal');
                    this.deleteConfirmBtn = document.getElementById('hvDeleteConfirm');
                    this.deleteCancelBtn = document.getElementById('hvDeleteCancel');
                    this.pendingDeleteIndex = -1;
                    this.selectedItems = new Set();

                    // 多选模式状态
                    this.isMultiSelectMode = false;
                    this.multiSelectItems = new Map(); // 存储选中的项 {time -> true}

                    this.initEvents();
                }

                initEvents() {
                    if (this.btn) {
                        this.btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.togglePopup();
                        });
                    }

                    if (this.historyBtn) {
                        this.historyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openHistory();
                        });
                    }

                    if (this.closeHistoryBtn) {
                        this.closeHistoryBtn.addEventListener('click', () => {
                            if (this.historyModal) this.historyModal.style.display = 'none';
                        });
                    }

                    if (this.deleteCancelBtn) {
                        this.deleteCancelBtn.addEventListener('click', () => {
                            if (this.deleteModal) this.deleteModal.style.display = 'none';
                        });
                    }

                    if (this.deleteConfirmBtn) {
                        this.deleteConfirmBtn.addEventListener('click', () => {
                            this.performDelete();
                        });
                    }

                    // 多选模式按钮
                    const deleteSelectBtn = document.getElementById('hv-delete-select-btn');
                    const exportSelectBtn = document.getElementById('hv-export-select-btn');

                    if (deleteSelectBtn) {
                        deleteSelectBtn.addEventListener('click', () => {
                            if (this.isMultiSelectMode) {
                                // 已在多选模式，点击按钮执行删除
                                this.confirmMultiDelete();
                            } else {
                                // 进入多选模式
                                this.enterMultiSelectMode('delete');
                            }
                        });
                    }

                    if (exportSelectBtn) {
                        exportSelectBtn.addEventListener('click', () => {
                            if (this.isMultiSelectMode) {
                                // 已在多选模式，点击按钮执行导出
                                this.confirmMultiExport();
                            } else {
                                // 进入多选模式
                                this.enterMultiSelectMode('export');
                            }
                        });
                    }

                    // 点击外部关闭
                    document.addEventListener('click', (e) => {
                        if (this.popup && this.popup.classList.contains('is-open')) {
                            if (!this.popup.contains(e.target) && e.target !== this.btn && !this.btn.contains(e.target)) {
                                this.closePopup();
                            }
                        }
                        if (this.historyModal && this.historyModal.style.display === 'flex') {
                            if (e.target === this.historyModal) {
                                this.historyModal.style.display = 'none';
                            }
                        }
                        if (this.deleteModal && this.deleteModal.style.display === 'flex') {
                            if (e.target === this.deleteModal) {
                                this.deleteModal.style.display = 'none';
                            }
                        }
                    });
                }

                getStorageKey(friendId) {
                    return `heartvoice_${friendId}`;
                }

                getData(friendId) {
                    const raw = localStorage.getItem(this.getStorageKey(friendId));
                    try {
                        return raw ? JSON.parse(raw) : null;
                    } catch {
                        return null;
                    }
                }

                saveData(friendId, data) {
                    localStorage.setItem(this.getStorageKey(friendId), JSON.stringify(data));
                }

                togglePopup() {
                    if (!this.popup) return;
                    const isOpen = this.popup.classList.toggle('is-open');
                    if (isOpen && chatSession && chatSession.getCurrentFriendId()) {
                        const friendId = chatSession.getCurrentFriendId();
                        console.log('[心声系统] 打开心声面板 - 好友ID:', friendId);
                        this.render(friendId);
                    }
                }

                closePopup() {
                    if (this.popup) {
                        this.popup.classList.remove('is-open');
                    }
                }

                openHistory() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    // 关闭小弹窗
                    if (this.popup) this.popup.classList.remove('is-open');

                    // 动态设置弹窗标题为「xxの心声」
                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const titleEl = document.getElementById('heartVoiceHistoryTitle');
                    if (titleEl) titleEl.textContent = `${friend?.name || ''}の心声`;

                    this.selectedItems.clear();
                    this.renderHistory(friendId);
                    if (this.historyModal) this.historyModal.style.display = 'flex';
                }

                renderHistory(friendId) {
                    if (!this.historyList) return;
                    this.historyList.innerHTML = '';

                    const data = this.getData(friendId);
                    const history = (data && data.history) ? data.history : [];

                    // 过滤无效项：只保留心声长度 >= 6 的有效记录
                    const validHistory = history.filter(item => {
                        const voiceText = String(item.voice || '').trim();
                        return voiceText.length >= 6;
                    });

                    const sorted = [...validHistory].reverse();

                    // 顶部工具栏（多选模式下显示）
                    if (this.isMultiSelectMode && sorted.length > 0) {
                        const toolbarHtml = `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(245, 245, 250, 0.5)); border-radius: 12px; margin-bottom: 12px; gap: 8px;">
                                <span style="color: #8b7d9c; font-size: 12px; font-weight: 600;">已选 <span id="hv-multi-count">${this.multiSelectItems.size}</span> 项</span>
                                <div style="display: flex; gap: 8px;">
                                    <button id="hv-multi-delete-btn" style="padding: 6px 16px; background: linear-gradient(135deg, #f0d6d7, #ffc4d0); color: #fff; border: none; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(240, 214, 215, 0.3); transition: all 0.2s;">删除</button>
                                    <button id="hv-multi-export-btn" style="padding: 6px 16px; background: linear-gradient(135deg, #debeeb, #d4a5e0); color: #fff; border: none; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(222, 190, 235, 0.3); transition: all 0.2s;">导出</button>
                                    <button id="hv-multi-cancel-btn" style="padding: 6px 16px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">取消</button>
                                </div>
                            </div>
                        `;
                        this.historyList.insertAdjacentHTML('beforeend', toolbarHtml);

                        // 绑定多选模式按钮事件
                        setTimeout(() => {
                            const deleteBtn = this.historyList.querySelector('#hv-multi-delete-btn');
                            const exportBtn = this.historyList.querySelector('#hv-multi-export-btn');
                            const cancelBtn = this.historyList.querySelector('#hv-multi-cancel-btn');

                            if (deleteBtn) deleteBtn.addEventListener('click', () => this.confirmMultiDelete());
                            if (exportBtn) exportBtn.addEventListener('click', () => this.confirmMultiExport());
                            if (cancelBtn) cancelBtn.addEventListener('click', () => this.exitMultiSelectMode());
                        }, 0);
                    }

                    // 列表顶部插入艺术标题
                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const titleHtml = `<div class="hv-history-title">${friend?.name || ''}の心声</div><div class="hv-history-title-line"></div>`;
                    this.historyList.insertAdjacentHTML('beforeend', titleHtml);

                    if (sorted.length === 0) {
                        this.historyList.insertAdjacentHTML('beforeend', '<div class="page-hint" style="margin-bottom: 0; color: #a09caa; font-size: 14px; min-height: 200px; display: flex; align-items: center; justify-content: center;">暂无历史心声</div>');
                        return;
                    }

                    sorted.forEach((item, i) => {
                        const el = document.createElement('div');
                        el.className = 'hv-history-item';
                        if (this.multiSelectItems.has(item.time)) {
                            el.classList.add('selected');
                        }
                        const date = new Date(item.time);
                        const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                        // 多选模式下显示复选框
                        const checkboxHtml = this.isMultiSelectMode ? `<div style="display: flex; align-items: center; margin-right: 8px; flex-shrink: 0;"><input type="checkbox" class="hv-item-checkbox" style="width: 18px; height: 18px; cursor: pointer;" ${this.multiSelectItems.has(item.time) ? 'checked' : ''}></div>` : '';

                        el.innerHTML = `
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                            ${checkboxHtml}
                            <div style="flex: 1;">
                                <div class="hv-history-header">
                                    <span class="hv-history-time">${timeStr}</span>
                                    <span class="hv-history-mood">心情 ${item.mood}%</span>
                                </div>
                                <div class="hv-history-content"></div>
                            </div>
                            <button class="hv-delete-btn" style="background: none; border: none; color: #f0d6d7; cursor: pointer; font-size: 14px; padding: 4px 8px; flex-shrink: 0; display: flex; align-items: center; opacity: 0.7; transition: opacity 0.2s; ${this.isMultiSelectMode ? 'display: none;' : ''}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;

                        // 使用textContent安全地设置心声内容
                        const contentDiv = el.querySelector('.hv-history-content');
                        if (contentDiv) {
                            contentDiv.textContent = item.voice;
                        }
                        // 绑定复选框事件（多选模式）
                        if (this.isMultiSelectMode) {
                            const checkbox = el.querySelector('.hv-item-checkbox');
                            if (checkbox) {
                                checkbox.addEventListener('change', (e) => {
                                    if (e.target.checked) {
                                        // 检查是否超过5条限制
                                        if (this.multiSelectItems.size >= 5) {
                                            e.target.checked = false;
                                            showCuteToast('最多只能选择5条记录');
                                            return;
                                        }
                                        this.multiSelectItems.set(item.time, true);
                                        el.classList.add('selected');
                                    } else {
                                        this.multiSelectItems.delete(item.time);
                                        el.classList.remove('selected');
                                    }
                                    // 更新计数
                                    const countEl = this.historyList.querySelector('#hv-multi-count');
                                    if (countEl) countEl.textContent = this.multiSelectItems.size;
                                });
                            }

                            // 点击项也能切换选中
                            el.addEventListener('click', (e) => {
                                if (!e.target.closest('input[type="checkbox"]')) {
                                    const checkbox = el.querySelector('.hv-item-checkbox');
                                    if (checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                                    }
                                }
                            });
                        } else {
                            // 正常模式下的删除按钮
                            const originalIndex = history.length - 1 - i;
                            const deleteBtn = el.querySelector('.hv-delete-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    this.pendingDeleteIndex = originalIndex;
                                    if (this.deleteModal) this.deleteModal.style.display = 'flex';
                                });

                                // 悬停效果
                                deleteBtn.addEventListener('mouseenter', () => {
                                    deleteBtn.style.opacity = '1';
                                });
                                deleteBtn.addEventListener('mouseleave', () => {
                                    deleteBtn.style.opacity = '0.7';
                                });
                            }

                            // 绑定长按删除
                            this.attachLongPress(el, originalIndex);

                            // 点击选择（按钮点击不触发）
                            el.addEventListener('click', (e) => {
                                if (e.target.closest('.hv-delete-btn')) return;
                                if (this.isLongPressTriggered) return;
                                if (this.selectedItems.has(item.time)) {
                                    this.selectedItems.delete(item.time);
                                    el.classList.remove('selected');
                                } else {
                                    this.selectedItems.add(item.time);
                                    el.classList.add('selected');
                                }
                            });
                        }

                        this.historyList.appendChild(el);
                    });
                }

                attachLongPress(el, index) {
                    let timer;
                    this.isLongPressTriggered = false;

                    const start = () => {
                        this.isLongPressTriggered = false;
                        timer = setTimeout(() => {
                            this.isLongPressTriggered = true;
                            if (navigator.vibrate) navigator.vibrate(50);
                            this.pendingDeleteIndex = index;
                            if (this.deleteModal) this.deleteModal.style.display = 'flex';
                        }, 600);
                    };
                    const end = () => clearTimeout(timer);

                    el.addEventListener('touchstart', start, { passive: true });
                    el.addEventListener('touchend', end);
                    el.addEventListener('touchmove', end);
                    el.addEventListener('mousedown', start);
                    el.addEventListener('mouseup', end);
                    el.addEventListener('mouseleave', end);
                }

                performDelete() {
                    if (this.pendingDeleteIndex === -1 || !chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    data.history.splice(this.pendingDeleteIndex, 1);
                    this.saveData(friendId, data);

                    if (this.deleteModal) this.deleteModal.style.display = 'none';
                    this.renderHistory(friendId);

                    // 如果删除的是最新一条，更新主界面
                    if (this.pendingDeleteIndex === data.history.length) { // 刚删掉的是原来的最后一条
                        this.render(friendId);
                    }
                }

                // ========== 多选模式函数 ==========
                enterMultiSelectMode(mode) {
                    this.isMultiSelectMode = true;
                    this.multiSelectItems.clear();
                    this.currentMultiSelectMode = mode;
                    if (chatSession) {
                        this.renderHistory(chatSession.getCurrentFriendId());
                    }
                }

                exitMultiSelectMode() {
                    this.isMultiSelectMode = false;
                    this.multiSelectItems.clear();
                    this.currentMultiSelectMode = null;
                    if (chatSession) {
                        this.renderHistory(chatSession.getCurrentFriendId());
                    }
                }

                confirmMultiDelete() {
                    if (this.multiSelectItems.size === 0) {
                        showCuteToast('请先选择要删除的记录');
                        return;
                    }

                    // 显示确认框
                    const confirmOverlay = document.createElement('div');
                    confirmOverlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;padding:24px;';
                    confirmOverlay.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 245, 255, 0.9)); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); max-width: 300px; text-align: center; border: 1px solid rgba(245, 220, 250, 0.5);">
                            <h3 style="color: #4a4858; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">确认删除</h3>
                            <p style="color: #8b7d9c; font-size: 14px; margin: 0 0 24px 0;">确认删除选中的 ${this.multiSelectItems.size} 条记录吗？</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button id="hv-multi-delete-yes" style="padding: 10px 24px; background: linear-gradient(135deg, #f0d6d7, #ffc4d0); color: #fff; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(240, 214, 215, 0.3);">删除</button>
                                <button id="hv-multi-delete-no" style="padding: 10px 24px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 20px; font-weight: 600; cursor: pointer;">取消</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmOverlay);

                    const yesBtn = confirmOverlay.querySelector('#hv-multi-delete-yes');
                    const noBtn = confirmOverlay.querySelector('#hv-multi-delete-no');

                    yesBtn.addEventListener('click', () => {
                        this.performMultiDelete();
                        confirmOverlay.remove();
                    });

                    noBtn.addEventListener('click', () => {
                        confirmOverlay.remove();
                    });

                    confirmOverlay.addEventListener('click', (e) => {
                        if (e.target === confirmOverlay) confirmOverlay.remove();
                    });
                }

                performMultiDelete() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    // 删除选中的项（按时间戳匹配）
                    data.history = data.history.filter(item => !this.multiSelectItems.has(item.time));
                    this.saveData(friendId, data);

                    showCuteToast(`已删除 ${this.multiSelectItems.size} 条记录`);
                    this.exitMultiSelectMode();
                    this.render(friendId);
                }

                confirmMultiExport() {
                    if (this.multiSelectItems.size === 0) {
                        showCuteToast('请先选择要导出的记录');
                        return;
                    }

                    // 显示确认框
                    const confirmOverlay = document.createElement('div');
                    confirmOverlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;padding:24px;';
                    confirmOverlay.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 245, 255, 0.9)); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); max-width: 300px; text-align: center; border: 1px solid rgba(245, 220, 250, 0.5);">
                            <h3 style="color: #4a4858; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">确认导出</h3>
                            <p style="color: #8b7d9c; font-size: 14px; margin: 0 0 24px 0;">确认导出选中的 ${this.multiSelectItems.size} 条记录吗？</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button id="hv-multi-export-yes" style="padding: 10px 24px; background: linear-gradient(135deg, #debeeb, #d4a5e0); color: #fff; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(222, 190, 235, 0.3);">导出</button>
                                <button id="hv-multi-export-no" style="padding: 10px 24px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 20px; font-weight: 600; cursor: pointer;">取消</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmOverlay);

                    const yesBtn = confirmOverlay.querySelector('#hv-multi-export-yes');
                    const noBtn = confirmOverlay.querySelector('#hv-multi-export-no');

                    yesBtn.addEventListener('click', async () => {
                        await this.performMultiExport();
                        confirmOverlay.remove();
                    });

                    noBtn.addEventListener('click', () => {
                        confirmOverlay.remove();
                    });

                    confirmOverlay.addEventListener('click', (e) => {
                        if (e.target === confirmOverlay) confirmOverlay.remove();
                    });
                }

                async performMultiExport() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    // 获取选中的记录
                    const selectedHistory = data.history.filter(item => this.multiSelectItems.has(item.time));
                    if (selectedHistory.length === 0) return;

                    // 调用导出函数
                    await this.generateExportImageFromItems(selectedHistory, friendId);
                    showCuteToast(`正在导出 ${selectedHistory.length} 条记录`);
                    this.exitMultiSelectMode();
                }

                async generateExportImageFromItems(historyItems, friendId) {
                    if (historyItems.length === 0) return;

                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const friendName = friend?.name || '未知角色';
                    const friendAvatar = friend?.avatar || null;

                    const scale = 2;
                    const w = 450;
                    const pad = 28;
                    const lineH = 26;
                    const cardGap = 14;
                    const headerH = 150;
                    const cardPad = 16;
                    const cardRadius = 16;

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    ctx.font = `${15 * scale}px sans-serif`;
                    const textW = w - pad * 2 - cardPad * 2;
                    let totalH = headerH;
                    for (const item of historyItems) {
                        const th = this.measureTextHeight(ctx, item.voice, textW * scale, lineH * scale);
                        totalH += th / scale + cardPad * 2 + 24 + cardGap;
                    }
                    totalH += 40;

                    canvas.width = w * scale;
                    canvas.height = totalH * scale;
                    ctx.scale(scale, scale);

                    const bgGrad = ctx.createLinearGradient(0, 0, w, totalH);
                    bgGrad.addColorStop(0, '#fdf2f8');
                    bgGrad.addColorStop(0.5, '#fef7fb');
                    bgGrad.addColorStop(1, '#f5f3ff');
                    ctx.fillStyle = bgGrad;
                    ctx.fillRect(0, 0, w, totalH);

                    const drawGlowSpot = (x, y, r, color) => {
                        const glow = ctx.createRadialGradient(x, y, 0, x, y, r);
                        glow.addColorStop(0, color);
                        glow.addColorStop(1, 'transparent');
                        ctx.fillStyle = glow;
                        ctx.fillRect(x - r, y - r, r * 2, r * 2);
                    };
                    drawGlowSpot(w * 0.15, totalH * 0.2, 120, 'rgba(255, 230, 240, 0.2)');
                    drawGlowSpot(w * 0.85, totalH * 0.35, 100, 'rgba(240, 230, 255, 0.18)');
                    drawGlowSpot(w * 0.5, totalH * 0.7, 150, 'rgba(250, 240, 255, 0.15)');
                    drawGlowSpot(w * 0.2, totalH * 0.85, 80, 'rgba(255, 245, 250, 0.18)');

                    ctx.globalAlpha = 0.03;
                    for (let i = 0; i < w * totalH * 0.008; i++) {
                        const nx = Math.random() * w;
                        const ny = Math.random() * totalH;
                        ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#f0e8f5';
                        ctx.fillRect(nx, ny, 1, 1);
                    }
                    ctx.globalAlpha = 1;

                    const roundRect = (x, y, rw, rh, r) => {
                        ctx.beginPath();
                        ctx.moveTo(x + r, y);
                        ctx.lineTo(x + rw - r, y);
                        ctx.quadraticCurveTo(x + rw, y, x + rw, y + r);
                        ctx.lineTo(x + rw, y + rh - r);
                        ctx.quadraticCurveTo(x + rw, y + rh, x + rw - r, y + rh);
                        ctx.lineTo(x + r, y + rh);
                        ctx.quadraticCurveTo(x, y + rh, x, y + rh - r);
                        ctx.lineTo(x, y + r);
                        ctx.quadraticCurveTo(x, y, x + r, y);
                        ctx.closePath();
                    };

                    const imgSize = 72;
                    const cx = w / 2, cy = 24 + imgSize / 2;
                    let avatarImg = null;
                    if (friendAvatar) {
                        try {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.src = friendAvatar;
                            await new Promise(r => { img.onload = r; img.onerror = r; if (img.complete) r(); });
                            if (img.naturalWidth > 0) avatarImg = img;
                        } catch (_) { }
                    }

                    ctx.save();
                    const glowGrad = ctx.createRadialGradient(cx, cy, imgSize / 2 - 2, cx, cy, imgSize / 2 + 12);
                    glowGrad.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                    glowGrad.addColorStop(0.5, 'rgba(240, 220, 250, 0.3)');
                    glowGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = glowGrad;
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2 + 12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    ctx.save();
                    ctx.shadowColor = 'rgba(220, 210, 230, 0.3)';
                    ctx.shadowBlur = 16;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#fef7fb';
                    ctx.fill();
                    ctx.restore();

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();
                    ctx.fillStyle = '#fef7fb';
                    ctx.fillRect(cx - imgSize / 2, cy - imgSize / 2, imgSize, imgSize);
                    if (avatarImg) {
                        ctx.drawImage(avatarImg, cx - imgSize / 2, cy - imgSize / 2, imgSize, imgSize);
                    } else {
                        ctx.fillStyle = '#8b7d9c';
                        ctx.font = 'bold 32px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(friendName[0] || '♥', cx, cy);
                    }
                    ctx.restore();

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    const borderGrad = ctx.createLinearGradient(cx - imgSize / 2, cy - imgSize / 2, cx + imgSize / 2, cy + imgSize / 2);
                    borderGrad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                    borderGrad.addColorStop(0.5, 'rgba(240, 220, 250, 0.5)');
                    borderGrad.addColorStop(1, 'rgba(255, 255, 255, 0.7)');
                    ctx.strokeStyle = borderGrad;
                    ctx.lineWidth = 2.5;
                    ctx.stroke();
                    ctx.restore();

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'alphabetic';
                    ctx.font = 'bold 18px sans-serif';

                    ctx.save();
                    ctx.shadowColor = 'rgba(220, 210, 230, 0.25)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 2;
                    ctx.fillStyle = '#706680';
                    ctx.fillText(`${friendName}の心声`, w / 2, cy + imgSize / 2 + 28);
                    ctx.restore();

                    const ulW = 60;
                    const ulGrad = ctx.createLinearGradient(w / 2 - ulW / 2, 0, w / 2 + ulW / 2, 0);
                    ulGrad.addColorStop(0, 'rgba(240, 220, 250, 0.2)');
                    ulGrad.addColorStop(0.3, 'rgba(240, 220, 250, 0.7)');
                    ulGrad.addColorStop(0.7, 'rgba(255, 230, 240, 0.7)');
                    ulGrad.addColorStop(1, 'rgba(255, 230, 240, 0.2)');
                    ctx.fillStyle = ulGrad;
                    roundRect(w / 2 - ulW / 2, cy + imgSize / 2 + 32, ulW, 2, 1);
                    ctx.fill();

                    let curY = headerH;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'alphabetic';

                    for (const item of historyItems) {
                        ctx.font = '15px sans-serif';
                        const th = this.measureTextHeight(ctx, item.voice, textW, lineH);
                        const boxH = th + cardPad * 2 + 24;

                        ctx.save();
                        ctx.shadowColor = 'rgba(220, 210, 230, 0.2)';
                        ctx.shadowBlur = 15;
                        ctx.shadowOffsetY = 6;
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.01)';
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        const cardGrd = ctx.createLinearGradient(pad, curY, w - pad, curY + boxH);
                        cardGrd.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                        cardGrd.addColorStop(0.5, 'rgba(255, 255, 255, 0.85)');
                        cardGrd.addColorStop(1, 'rgba(255, 255, 255, 0.88)');
                        ctx.fillStyle = cardGrd;
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad + 2, curY + 2, w - pad * 2 - 4, boxH * 0.4, cardRadius - 2);
                        const shineGrd = ctx.createLinearGradient(pad, curY, pad, curY + boxH * 0.4);
                        shineGrd.addColorStop(0, 'rgba(255, 255, 255, 0.35)');
                        shineGrd.addColorStop(1, 'rgba(255, 255, 255, 0)');
                        ctx.fillStyle = shineGrd;
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        const borderGrd = ctx.createLinearGradient(pad, curY, w - pad, curY + boxH);
                        borderGrd.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                        borderGrd.addColorStop(0.5, 'rgba(245, 235, 250, 0.4)');
                        borderGrd.addColorStop(1, 'rgba(255, 255, 255, 0.7)');
                        ctx.strokeStyle = borderGrd;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        ctx.restore();

                        const date = new Date(item.time);
                        const ts = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                        ctx.font = '12px sans-serif';
                        ctx.fillStyle = '#9590a0';
                        ctx.fillText(ts, pad + cardPad, curY + cardPad + 12);

                        const moodStr = `心情 ${item.mood}%`;
                        ctx.font = '600 11px sans-serif';
                        const moodW = ctx.measureText(moodStr).width + 18;
                        const moodX = w - pad - cardPad - moodW;

                        ctx.save();
                        roundRect(moodX, curY + cardPad - 1, moodW, 22, 11);
                        const moodGrd = ctx.createLinearGradient(moodX, curY + cardPad, moodX + moodW, curY + cardPad + 22);
                        moodGrd.addColorStop(0, 'rgba(240, 220, 250, 0.3)');
                        moodGrd.addColorStop(1, 'rgba(255, 230, 240, 0.25)');
                        ctx.fillStyle = moodGrd;
                        ctx.fill();
                        roundRect(moodX, curY + cardPad - 1, moodW, 22, 11);
                        ctx.strokeStyle = 'rgba(240, 220, 250, 0.4)';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        ctx.restore();

                        ctx.fillStyle = '#b8a0c8';
                        ctx.textAlign = 'center';
                        ctx.fillText(moodStr, moodX + moodW / 2, curY + cardPad + 14);

                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#4a4858';
                        ctx.font = '15px sans-serif';
                        this.wrapText(ctx, item.voice, pad + cardPad, curY + cardPad + 36, textW, lineH);

                        curY += boxH + cardGap;
                    }

                    const dataUrl = canvas.toDataURL('image/png');
                    this.showExportPreview(dataUrl, friendId);
                }

                /* 导出心声历史为高清相册图片 */
                /* 导出心声历史为高清相册图片 - 复用 generateExportImageFromItems 避免代码重复 */
                async exportHistory() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    const data = this.getData(friendId);
                    if (!data || !data.history || data.history.length === 0) {
                        showCuteToast('暂无历史记录可导出');
                        return;
                    }

                    // 过滤无效项：只保留心声长度 >= 6 的有效记录
                    const validHistory = data.history.filter(item => {
                        const voiceText = String(item.voice || '').trim();
                        return voiceText.length >= 6;
                    });

                    let history = [...validHistory].reverse();
                    if (this.selectedItems.size > 0) {
                        history = history.filter(item => this.selectedItems.has(item.time));
                    }
                    if (history.length === 0) {
                        showCuteToast('暂无有效的历史记录可导出');
                        return;
                    }

                    // 复用 generateExportImageFromItems 进行绘图
                    await this.generateExportImageFromItems(history, friendId);
                }
                /* 显示导出预览弹窗，用户确认后保存 */
                showExportPreview(dataUrl, friendId) {
                    let overlay = document.getElementById('hvExportPreviewOverlay');
                    if (overlay) overlay.remove();

                    overlay = document.createElement('div');
                    overlay.id = 'hvExportPreviewOverlay';
                    overlay.style.cssText = 'position:fixed;inset:0;z-index:2300;background:rgba(0,0,0,0.45);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;';
                    overlay.innerHTML = `
                    <img src="${dataUrl}" style="max-width:90%;max-height:65vh;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.25);object-fit:contain;margin-bottom:20px;" />
                    <div style="display:flex;gap:12px;">
                        <button id="hvExportSave" style="padding:12px 32px;background:linear-gradient(135deg,#debeeb,#f0d6d7);color:#fff;border:none;border-radius:25px;font-weight:600;font-size:14px;cursor:pointer;box-shadow:0 4px 16px rgba(222,190,235,0.3);">保存图片</button>
                        <button id="hvExportCancel" style="padding:12px 32px;background:rgba(255,255,255,0.9);color:#787785;border:1px solid #f6f2f1;border-radius:25px;font-weight:600;font-size:14px;cursor:pointer;">取消</button>
                    </div>
                `;
                    document.body.appendChild(overlay);

                    overlay.querySelector('#hvExportSave').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.download = `heart_voice_${friendId}_${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                        overlay.remove();
                        showCuteToast('保存成功');
                    });
                    overlay.querySelector('#hvExportCancel').addEventListener('click', () => overlay.remove());
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
                }

                // 辅助方法：计算文本高度
                measureTextHeight(ctx, text, maxWidth, lineHeight) {
                    const words = text.split('');
                    let line = '';
                    let count = 1;
                    for (let n = 0; n < words.length; n++) {
                        const testLine = line + words[n];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && n > 0) {
                            line = words[n];
                            count++;
                        } else {
                            line = testLine;
                        }
                    }
                    return count * lineHeight;
                }

                // 辅助方法：绘制自动换行文本
                wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                    const words = text.split('');
                    let line = '';
                    let currentY = y;
                    for (let n = 0; n < words.length; n++) {
                        const testLine = line + words[n];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && n > 0) {
                            ctx.fillText(line, x, currentY);
                            line = words[n];
                            currentY += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, x, currentY);
                }

                render(friendId) {
                    const data = this.getData(friendId);
                    // 只有当有新数据时才更新，否则保留现有内容
                    if (data) {
                        this.textEl.textContent = data.voice || '';
                        if (this.demeanorEl) this.demeanorEl.textContent = data.demeanor || '';
                        const mood = data.mood !== undefined ? data.mood : 50;

                        // 处理进度条宽度：负数显示0%，超过100显示100%
                        const displayWidth = Math.max(0, Math.min(100, mood));
                        this.moodFillEl.style.width = `${displayWidth}%`;

                        // 根据心情值设置颜色
                        if (mood < 0) {
                            // 负数：红色（困扰/消极）
                            this.moodFillEl.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8787)';
                        } else if (mood > 100) {
                            // 超过100：金色/橙色（超满）
                            this.moodFillEl.style.background = 'linear-gradient(90deg, #ffd700, #ffb347)';
                        } else {
                            // 正常范围：默认紫粉色
                            this.moodFillEl.style.background = 'linear-gradient(90deg, #debeeb, #f0d6d7)';
                        }

                        this.moodLabelEl.textContent = `${mood}%`;
                    }
                    // 当data为空时，不清空现有内容，保持显示上次的数据
                }

            }

            // ========== 世界书系统 ==========
            class WorldBookSystem {
                constructor() {
                    this.storageKey = 'worldBooks';
                    this.currentEditingId = null;
                    this.books = this.loadBooks();
                    this.initEvents();
                }

                loadBooks() {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : [];
                }

                saveBooks() {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.books));
                }

                addBook(title, content) {
                    const book = {
                        id: Date.now(),
                        title: title.trim(),
                        content: content.trim(),
                        createdAt: new Date().toISOString()
                    };
                    this.books.push(book);
                    this.saveBooks();
                    return book;
                }

                updateBook(id, title, content) {
                    const book = this.books.find(b => b.id === id);
                    if (book) {
                        book.title = title.trim();
                        book.content = content.trim();
                        this.saveBooks();
                        return book;
                    }
                    return null;
                }

                deleteBook(id) {
                    const index = this.books.findIndex(b => b.id === id);
                    if (index > -1) {
                        this.books.splice(index, 1);
                        this.saveBooks();
                        return true;
                    }
                    return false;
                }

                getBook(id) {
                    return this.books.find(b => b.id === id);
                }

                /**
                 * 【新增方法】获取当前好友已挂载的世界书
                 * 用于生成心声时一次性获取世界观背景，避免重复调用
                 */
                getActiveWorldbooks(friendId = null) {
                    if (!friendId && typeof chatSession !== 'undefined') {
                        friendId = chatSession?.getCurrentFriendId?.();
                    }

                    if (!friendId) return [];

                    const friend = typeof friendSystem !== 'undefined'
                        ? friendSystem?.getFriendById?.(friendId)
                        : null;

                    if (!friend || !Array.isArray(friend.mountedWorldBooks)) {
                        return [];
                    }

                    // 返回已挂载的世界书完整信息（不只是ID）
                    return friend.mountedWorldBooks
                        .map(bookId => this.getBook(bookId))
                        .filter(book => book !== undefined);
                }

                initEvents() {
                    const worldbookBtn = document.getElementById('worldbookBtn');
                    const wbListBack = document.getElementById('wbListBack');
                    const wbAddNewBtn = document.getElementById('wbAddNewBtn');
                    const wbEditBack = document.getElementById('wbEditBack');
                    const wbSaveBtn = document.getElementById('wbSaveBtn');

                    if (worldbookBtn) {
                        worldbookBtn.addEventListener('click', () => this.showListPage());
                    }

                    if (wbListBack) {
                        wbListBack.addEventListener('click', () => this.showMainPage());
                    }

                    if (wbAddNewBtn) {
                        wbAddNewBtn.addEventListener('click', () => this.openNewBookPage());
                    }

                    if (wbEditBack) {
                        wbEditBack.addEventListener('click', () => this.showListPage());
                    }

                    if (wbSaveBtn) {
                        wbSaveBtn.addEventListener('click', () => this.saveBook());
                    }
                }

                showMainPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'flex';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'none';
                }

                showListPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'flex';
                    if (editPage) editPage.style.display = 'none';
                    this.renderBookList();
                }

                showEditPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'flex';
                }

                renderBookList() {
                    const container = document.getElementById('wbListContainer');
                    if (!container) return;

                    container.innerHTML = '';

                    if (this.books.length === 0) {
                        container.innerHTML = '<div class="page-hint" style="margin-bottom: 0; color: #999; font-size: 14px; min-height: 200px; display: flex; align-items: center;">还没有世界书，点击新建开始吧</div>';
                        return;
                    }

                    this.books.forEach(book => {
                        const card = document.createElement('div');
                        card.className = 'wb-card';
                        card.style.paddingBottom = '50px';
                        card.innerHTML = `
                        <p class="wb-card-title">${book.title}</p>
                        <p class="wb-card-preview">${book.content}</p>
                        <div class="wb-card-actions">
                            <button class="wb-card-btn wb-edit-btn" data-id="${book.id}"><i class="fas fa-edit"></i></button>
                            <button class="wb-card-btn wb-delete-btn" data-id="${book.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                        container.appendChild(card);
                    });

                    // 绑定编辑和删除按钮
                    container.querySelectorAll('.wb-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            this.openEditBookPage(id);
                        });
                    });

                    container.querySelectorAll('.wb-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            if (confirm('确定删除这个世界书吗？')) {
                                this.deleteBook(id);
                                this.renderBookList();
                            }
                        });
                    });
                }

                openNewBookPage() {
                    this.currentEditingId = null;
                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');
                    const editTitle = document.getElementById('wbEditTitle');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (editTitle) editTitle.textContent = '新建世界书';

                    this.showEditPage();
                }

                openEditBookPage(id) {
                    this.currentEditingId = id;
                    const book = this.getBook(id);
                    if (!book) return;

                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');
                    const editTitle = document.getElementById('wbEditTitle');

                    if (titleInput) titleInput.value = book.title;
                    if (contentInput) contentInput.value = book.content;
                    if (editTitle) editTitle.textContent = '编辑世界书';

                    this.showEditPage();
                }

                saveBook() {
                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');

                    const title = titleInput ? titleInput.value.trim() : '';
                    const content = contentInput ? contentInput.value.trim() : '';

                    if (!title) {
                        showCuteToast('请输入名称', 'warning');
                        return;
                    }

                    if (this.currentEditingId === null) {
                        this.addBook(title, content);
                    } else {
                        this.updateBook(this.currentEditingId, title, content);
                    }

                    showCuteToast('保存成功！', 'success');
                    this.showListPage();
                }
            }

            // ========== HTML游戏系统 ==========
            class HtmlGameSystem {
                constructor() {
                    this.storageKey = 'htmlGames';
                    this.currentEditingId = null;
                    this.games = this.loadGames();
                    this.initEvents();
                }

                loadGames() {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : [];
                }

                saveGames() {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.games));
                }

                addGame(title, content) {
                    const game = {
                        id: Date.now(),
                        title: title.trim(),
                        content: content.trim(),
                        createdAt: new Date().toISOString()
                    };
                    this.games.push(game);
                    this.saveGames();
                    return game;
                }

                updateGame(id, title, content) {
                    const game = this.games.find(g => g.id === id);
                    if (game) {
                        game.title = title.trim();
                        game.content = content.trim();
                        this.saveGames();
                        return game;
                    }
                    return null;
                }

                deleteGame(id) {
                    const index = this.games.findIndex(g => g.id === id);
                    if (index > -1) {
                        this.games.splice(index, 1);
                        this.saveGames();
                        return true;
                    }
                    return false;
                }

                getGame(id) {
                    return this.games.find(g => g.id === id);
                }

                initEvents() {
                    const htmlGameBtn = document.getElementById('htmlGameBtn');
                    const hgListBack = document.getElementById('hgListBack');
                    const hgAddNewBtn = document.getElementById('hgAddNewBtn');
                    const hgEditBack = document.getElementById('hgEditBack');
                    const hgSaveBtn = document.getElementById('hgSaveBtn');

                    if (htmlGameBtn) {
                        htmlGameBtn.addEventListener('click', () => this.showListPage());
                    }

                    if (hgListBack) {
                        hgListBack.addEventListener('click', () => this.showMainPage());
                    }

                    if (hgAddNewBtn) {
                        hgAddNewBtn.addEventListener('click', () => this.openNewGamePage());
                    }

                    if (hgEditBack) {
                        hgEditBack.addEventListener('click', () => this.showListPage());
                    }

                    if (hgSaveBtn) {
                        hgSaveBtn.addEventListener('click', () => this.saveGame());
                    }
                }

                showMainPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'flex';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'none';
                }

                showListPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'flex';
                    if (editPage) editPage.style.display = 'none';
                    this.renderGameList();
                }

                showEditPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'flex';
                }

                renderGameList() {
                    const container = document.getElementById('hgListContainer');
                    if (!container) return;

                    container.innerHTML = '';

                    if (this.games.length === 0) {
                        container.innerHTML = '<div class="page-hint" style="margin-bottom: 0; color: #999; font-size: 14px; min-height: 200px; display: flex; align-items: center;">还没有HTML游戏，点击新建开始吧</div>';
                        return;
                    }

                    this.games.forEach(game => {
                        const card = document.createElement('div');
                        card.className = 'hg-card';
                        card.style.paddingBottom = '50px';
                        card.innerHTML = `
                        <p class="hg-card-title">${game.title}</p>
                        <p class="hg-card-preview">${game.content}</p>
                        <div class="hg-card-actions">
                            <button class="hg-card-btn hg-edit-btn" data-id="${game.id}"><i class="fas fa-edit"></i></button>
                            <button class="hg-card-btn hg-delete-btn" data-id="${game.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                        container.appendChild(card);
                    });

                    // 绑定编辑和删除按钮
                    container.querySelectorAll('.hg-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            this.openEditGamePage(id);
                        });
                    });

                    container.querySelectorAll('.hg-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            if (confirm('确定删除这个HTML游戏吗？')) {
                                this.deleteGame(id);
                                this.renderGameList();
                            }
                        });
                    });
                }

                openNewGamePage() {
                    this.currentEditingId = null;
                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');
                    const editTitle = document.getElementById('hgEditTitle');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (editTitle) editTitle.textContent = '新建HTML游戏';

                    this.showEditPage();
                }

                openEditGamePage(id) {
                    this.currentEditingId = id;
                    const game = this.getGame(id);
                    if (!game) return;

                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');
                    const editTitle = document.getElementById('hgEditTitle');

                    if (titleInput) titleInput.value = game.title;
                    if (contentInput) contentInput.value = game.content;
                    if (editTitle) editTitle.textContent = '编辑HTML游戏';

                    this.showEditPage();
                }

                saveGame() {
                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');

                    const title = titleInput ? titleInput.value.trim() : '';
                    const content = contentInput ? contentInput.value.trim() : '';

                    if (!title) {
                        showCuteToast('请输入名称', 'warning');
                        return;
                    }

                    if (this.currentEditingId === null) {
                        this.addGame(title, content);
                    } else {
                        this.updateGame(this.currentEditingId, title, content);
                    }

                    showCuteToast('保存成功！', 'success');
                    this.showListPage();
                }
            }

            // ========== 聊天功能 ==========
            class ChatSession {
            constructor(friendSystemInstance, apiServiceInstance) {
                this.friendSystem = friendSystemInstance;
                this.apiService = apiServiceInstance;
                this.currentFriendId = null;
                this.isProcessing = false;
                this.actionMenu = {
                    overlay: messageActionOverlay,
                    menu: messageActionMenu,
                    copyBtn: messageActionCopy,
                    deleteBtn: messageActionDelete,
                    recallBtn: messageActionRecall,
                    replyBtn: messageActionReply,
                    current: null
                };
                this.multiSelect = {
                    active: false,
                    selectedIds: new Set(),
                    selectedWrappers: new Map()
                };
                this.initMessageActionMenu();
                this.initMultiSelect();
                this.initReplyPreview();
                this.initImageUpload();
            }

            /**
             * 启动心声按钮脉动动画
             * 用于向用户反馈"正在处理回复"的状态
             */
            startHeartVoicePulse() {
                const heartVoiceBtn = document.getElementById('heartVoiceBtn');
                if (heartVoiceBtn) {
                    heartVoiceBtn.classList.add('pulse-active');
                    console.log('[心声动画] 启动脉动');
                }
            }

            /**
             * 停止心声按钮脉动动画
             * 在API响应接收时调用
             */
            stopHeartVoicePulse() {
                const heartVoiceBtn = document.getElementById('heartVoiceBtn');
                if (heartVoiceBtn) {
                    heartVoiceBtn.classList.remove('pulse-active');
                    console.log('[心声动画] 停止脉动');
                }
            }

            showChatStatus(message, type) {
                chatStatus.textContent = message;
                chatStatus.className = `status-message ${type}`;
                chatStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        chatStatus.style.display = 'none';
                    }, 3000);
                }
            }

            initMessageActionMenu() {
                const { overlay, menu, copyBtn, deleteBtn, recallBtn, replyBtn } = this.actionMenu;
                if (!overlay || !menu) return;

                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) this.hideMessageActionMenu();
                });
                menu.addEventListener('click', (e) => e.stopPropagation());

                if (copyBtn) copyBtn.addEventListener('click', () => this.handleMessageAction('copy'));
                if (deleteBtn) deleteBtn.addEventListener('click', () => this.handleMessageAction('delete'));
                if (recallBtn) recallBtn.addEventListener('click', () => this.handleMessageAction('recall'));
                if (replyBtn) replyBtn.addEventListener('click', () => this.handleMessageAction('reply'));

                // 多选按钮事件监听
                const multiSelectBtn = document.getElementById('messageActionMultiSelect');
                if (multiSelectBtn) {
                    multiSelectBtn.addEventListener('click', () => this.handleMessageAction('multiSelect'));
                }

                // 修正按钮事件监听
                const regenerateBtn = document.getElementById('messageActionRegenerate');
                if (regenerateBtn) {
                    regenerateBtn.addEventListener('click', () => this.handleMessageAction('regenerate'));
                }
            }

            initMultiSelect() {
                const cancelBtn = document.getElementById('multiSelectCancelBtn');
                const deleteBtn = document.getElementById('multiSelectDeleteBtn');
                const confirmYes = document.getElementById('multiSelectConfirmYes');
                const confirmNo = document.getElementById('multiSelectConfirmNo');

                if (cancelBtn) cancelBtn.addEventListener('click', () => this.exitMultiSelectMode());

                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (this.multiSelect.selectedIds.size === 0) {
                            showCuteToast('请先选中要删除的消息');
                            return;
                        }
                        const overlay = document.getElementById('multiSelectConfirmOverlay');
                        const text = document.getElementById('multiSelectConfirmText');
                        if (text) text.textContent = `将删除已选中的 ${this.multiSelect.selectedIds.size} 条消息，删除后无法恢复`;
                        if (overlay) overlay.style.display = 'flex';
                    });
                }

                if (confirmYes) {
                    confirmYes.addEventListener('click', () => {
                        this.executeMultiSelectDelete();
                        const overlay = document.getElementById('multiSelectConfirmOverlay');
                        if (overlay) overlay.style.display = 'none';
                    });
                }

                if (confirmNo) {
                    confirmNo.addEventListener('click', () => {
                        const overlay = document.getElementById('multiSelectConfirmOverlay');
                        if (overlay) overlay.style.display = 'none';
                    });
                }
            }

            enterMultiSelectMode() {
                this.multiSelect.active = true;
                this.multiSelect.selectedIds.clear();
                this.multiSelect.selectedWrappers.clear();
                document.body.classList.add('multi-select-active');

                // 事件委托：捕获阶段拦截 chatMessages 内所有点击
                this._multiSelectClickHandler = (e) => {
                    const wrapper = e.target.closest('div[data-msg-id]');
                    if (!wrapper) return;
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    this.toggleMultiSelectMessage(wrapper);
                };
                chatMessages.addEventListener('click', this._multiSelectClickHandler, true);

                const modalHeader = document.querySelector('#chatModal .modal-header');
                if (modalHeader) {
                    Array.from(modalHeader.children).forEach(child => {
                        if (child.id !== 'multiSelectHeader') {
                            child.dataset.msOrigDisplay = child.style.display || '';
                            child.style.display = 'none';
                        }
                    });
                }
                const msHeader = document.getElementById('multiSelectHeader');
                if (msHeader) msHeader.style.display = 'flex';

                const inputAreaWrap = document.getElementById('chatInputAreaWrap');
                const inputArea = inputAreaWrap ? inputAreaWrap.parentElement : null;
                if (inputArea) {
                    inputArea.dataset.msOrigDisplay = inputArea.style.display || '';
                    inputArea.style.display = 'none';
                }
                const msFooter = document.getElementById('multiSelectFooter');
                if (msFooter) msFooter.style.display = 'flex';

                this.updateMultiSelectCount();

                const allMsgWrappers = chatMessages.querySelectorAll('div[data-msg-id]');
                allMsgWrappers.forEach(wrapper => this.ensureMultiSelectCheckbox(wrapper));
            }

            exitMultiSelectMode() {
                this.multiSelect.active = false;
                this.multiSelect.selectedIds.clear();
                this.multiSelect.selectedWrappers.clear();
                document.body.classList.remove('multi-select-active');

                // 移除事件委托
                if (this._multiSelectClickHandler) {
                    chatMessages.removeEventListener('click', this._multiSelectClickHandler, true);
                    this._multiSelectClickHandler = null;
                }

                const modalHeader = document.querySelector('#chatModal .modal-header');
                if (modalHeader) {
                    Array.from(modalHeader.children).forEach(child => {
                        if (child.id !== 'multiSelectHeader') {
                            child.style.display = child.dataset.msOrigDisplay || '';
                            delete child.dataset.msOrigDisplay;
                        }
                    });
                }
                const msHeader = document.getElementById('multiSelectHeader');
                if (msHeader) msHeader.style.display = 'none';

                const inputAreaWrap = document.getElementById('chatInputAreaWrap');
                const inputArea = inputAreaWrap ? inputAreaWrap.parentElement : null;
                if (inputArea) {
                    inputArea.style.display = inputArea.dataset.msOrigDisplay || '';
                    delete inputArea.dataset.msOrigDisplay;
                }
                const msFooter = document.getElementById('multiSelectFooter');
                if (msFooter) msFooter.style.display = 'none';

                const allCheckboxes = chatMessages.querySelectorAll('.multi-select-checkbox');
                allCheckboxes.forEach(cb => cb.classList.remove('is-checked'));

                const overlay = document.getElementById('multiSelectConfirmOverlay');
                if (overlay) overlay.style.display = 'none';
            }

            ensureMultiSelectCheckbox(messageWrapper) {
                if (messageWrapper.querySelector('.multi-select-checkbox')) return;
                const checkbox = document.createElement('div');
                checkbox.className = 'multi-select-checkbox';
                messageWrapper.insertBefore(checkbox, messageWrapper.firstChild);
            }

            toggleMultiSelectMessage(messageWrapper) {
                if (!this.multiSelect.active) return;
                const msgId = messageWrapper.dataset.msgId;
                if (!msgId) return;

                const checkbox = messageWrapper.querySelector('.multi-select-checkbox');

                if (this.multiSelect.selectedIds.has(msgId)) {
                    this.multiSelect.selectedIds.delete(msgId);
                    this.multiSelect.selectedWrappers.delete(msgId);
                    if (checkbox) checkbox.classList.remove('is-checked');
                } else {
                    this.multiSelect.selectedIds.add(msgId);
                    this.multiSelect.selectedWrappers.set(msgId, messageWrapper);
                    if (checkbox) checkbox.classList.add('is-checked');
                }
                this.updateMultiSelectCount();
            }

            updateMultiSelectCount() {
                const countEl = document.getElementById('multiSelectCount');
                if (countEl) countEl.textContent = `已选中 ${this.multiSelect.selectedIds.size} 条`;
            }

            executeMultiSelectDelete() {
                if (!this.currentFriendId || !this.friendSystem) {
                    this.exitMultiSelectMode();
                    return;
                }

                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);

                this.multiSelect.selectedWrappers.forEach((wrapper, msgId) => {
                    if (wrapper && wrapper.parentNode) wrapper.remove();
                    const target = history.find(m => m.id === msgId);
                    if (target) target.isDeletedLocal = true;
                });

                this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                this.exitMultiSelectMode();
                showCuteToast('删除成功');
            }

            initReplyPreview() {
                if (!replyPreview || !replyPreviewText) return;
                if (replyPreviewClose) {
                    replyPreviewClose.addEventListener('click', () => this.clearReplyPrefill());
                }
            }

            initImageUpload() {
                const processImageFile = (file) => new Promise((resolve) => {
                    try {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const dataUrl = String(event.target.result || '');
                            if (!dataUrl) return resolve('');

                            const img = new Image();
                            img.onload = () => {
                                try {
                                    const maxSize = 1280;
                                    let { width, height } = img;
                                    if (width > maxSize || height > maxSize) {
                                        const scale = Math.min(maxSize / width, maxSize / height);
                                        width = Math.round(width * scale);
                                        height = Math.round(height * scale);
                                    }
                                    const canvas = document.createElement('canvas');
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    if (!ctx) return resolve(dataUrl);
                                    ctx.drawImage(img, 0, 0, width, height);
                                    const optimized = canvas.toDataURL('image/jpeg', 0.9);
                                    resolve(optimized || dataUrl);
                                } catch (e) {
                                    resolve(dataUrl);
                                }
                            };
                            img.onerror = () => resolve(dataUrl);
                            img.src = dataUrl;
                        };
                        reader.onerror = () => resolve('');
                        reader.readAsDataURL(file);
                    } catch (e) {
                        resolve('');
                    }
                });

                const showImageConfirm = () => {
                    if (!imageConfirmPopover || !imageUploadBtn) return;
                    const rect = imageUploadBtn.getBoundingClientRect();
                    const popoverRect = imageConfirmPopover.getBoundingClientRect();
                    let top = rect.top - (popoverRect.height || 44) - 8;
                    if (top < 8) top = rect.bottom + 8;
                    let left = rect.left + rect.width / 2 - (popoverRect.width || 160) / 2;
                    left = Math.max(8, Math.min(left, window.innerWidth - (popoverRect.width || 160) - 8));
                    imageConfirmPopover.style.top = `${top}px`;
                    imageConfirmPopover.style.left = `${left}px`;
                    imageConfirmPopover.style.display = 'flex';
                };

                const hideImageConfirm = () => {
                    if (imageConfirmPopover) imageConfirmPopover.style.display = 'none';
                };

                if (imageUploadBtn) {
                    imageUploadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showImageConfirm();
                    });
                }

                if (imageConfirmYes && imageInput) {
                    imageConfirmYes.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                        imageInput.click();
                    });
                }

                if (imageConfirmNo) {
                    imageConfirmNo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideImageConfirm();
                    });
                }

                if (imageInput) {
                    imageInput.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        processImageFile(file).then((dataUrl) => {
                            if (!dataUrl) return;
                            chatInput.dataset.imageData = dataUrl;
                            chatInput.dataset.imageName = file.name || '图片';
                            if (imageUploadThumb) imageUploadThumb.src = dataUrl;
                            if (imageUploadName) imageUploadName.textContent = file.name || '已选择图片';
                            if (imageUploadPill) imageUploadPill.style.display = 'flex';
                        });
                        imageInput.value = '';
                    });
                }

                if (imageUploadClose) {
                    imageUploadClose.addEventListener('click', () => this.clearImageUpload());
                }

                document.addEventListener('click', (e) => {
                    if (!imageConfirmPopover) return;
                    if (imageConfirmPopover.contains(e.target) || (imageUploadBtn && imageUploadBtn.contains(e.target))) {
                        return;
                    }
                    hideImageConfirm();
                });
            }

            getCurrentFriendName() {
                if (this.currentFriendId && this.friendSystem) {
                    const friend = this.friendSystem.getFriendById(this.currentFriendId);
                    if (friend && friend.name) return friend.name;
                }
                const title = chatTitle ? chatTitle.textContent : '';
                const match = title.match(/与\s*(.+)\s*对话/);
                return match && match[1] ? match[1] : '对方';
            }

            showMessageActionMenu(targetElement, data) {
                const { overlay, menu, recallBtn } = this.actionMenu;
                if (!overlay || !menu || !targetElement) return;

                this.actionMenu.current = { ...data, targetElement };

                const canRecall = data.role === 'user' && !data.isRecalled;
                if (recallBtn) recallBtn.classList.toggle('is-disabled', !canRecall);

                overlay.style.display = 'block';
                menu.classList.remove('is-open');
                menu.style.top = '0px';
                menu.style.left = '0px';

                const rect = targetElement.getBoundingClientRect();
                const menuRect = menu.getBoundingClientRect();

                let top = rect.top - menuRect.height - 8;
                if (top < 12) top = rect.bottom + 8;
                let left = rect.left + (rect.width - menuRect.width) / 2;
                left = Math.max(12, Math.min(left, window.innerWidth - menuRect.width - 12));

                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;

                requestAnimationFrame(() => menu.classList.add('is-open'));
            }

            hideMessageActionMenu() {
                const { overlay, menu } = this.actionMenu;
                if (!overlay || !menu) return;
                menu.classList.remove('is-open');
                overlay.style.display = 'none';
                this.actionMenu.current = null;
            }

            bindMessageActions(messageWrapper, targetElement, data) {
                if (!messageWrapper || !targetElement) return;
                let pressTimer = null;
                let startX = 0;
                let startY = 0;
                let isLongPress = false;

                const clearPress = () => {
                    if (pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                    isLongPress = false;
                };

                const startPress = (clientX, clientY) => {
                    if (this.multiSelect.active) return;
                    startX = clientX;
                    startY = clientY;
                    isLongPress = false;
                    clearPress();
                    pressTimer = setTimeout(() => {
                        isLongPress = true;
                        this.showMessageActionMenu(targetElement, data);
                    }, 550);
                };

                // 拦截 touchstart 事件：启动长按计时器，禁用系统菜单但保留点击事件
                targetElement.addEventListener('touchstart', (e) => {
                    // 仅禁用系统长按菜单，不阻止点击事件本身
                    // 注意：不在这里调用 preventDefault，避免阻止 click 事件
                    if (e.touches && e.touches[0]) {
                        startPress(e.touches[0].clientX, e.touches[0].clientY);
                    }
                }, { passive: true });

                targetElement.addEventListener('touchmove', (e) => {
                    if (!e.touches || !e.touches[0]) return;
                    const dx = Math.abs(e.touches[0].clientX - startX);
                    const dy = Math.abs(e.touches[0].clientY - startY);
                    if (dx > 10 || dy > 10) {
                        clearPress();
                    }
                }, { passive: true });

                targetElement.addEventListener('touchend', (e) => {
                    // 如果是长按触发的菜单，阻止其他点击事件
                    if (isLongPress) {
                        e.preventDefault();
                    }
                    clearPress();
                });
                targetElement.addEventListener('touchcancel', clearPress);

                targetElement.addEventListener('mousedown', (e) => {
                    if (e.button === 0) { // 左键
                        startPress(e.clientX, e.clientY);
                    } else if (e.button === 2) { // 右键
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });

                targetElement.addEventListener('mouseup', (e) => {
                    // 如果是长按触发的菜单，阻止其他点击事件
                    if (isLongPress) {
                        e.preventDefault();
                    }
                    clearPress();
                });

                targetElement.addEventListener('mouseleave', clearPress);

                // 拦截右键菜单（desktop）和长按菜单（mobile）：完全禁用系统菜单
                targetElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (this.multiSelect.active) return;
                    this.showMessageActionMenu(targetElement, data);
                });

            }

            handleMessageAction(action) {
                const current = this.actionMenu.current;
                if (!current) return;
                const { messageWrapper, msgId, content, role } = current;

                console.log('[消息菜单] 触发action:', action);

                if (action === 'copy') {
                    this.copyToClipboard(content || '');
                } else if (action === 'delete') {
                    this.deleteMessageLocal(messageWrapper, msgId);
                } else if (action === 'recall') {
                    if (role === 'user') this.recallMessage(messageWrapper, msgId);
                } else if (action === 'reply') {
                    this.setReplyPrefill(content || '', role);
                } else if (action === 'multiSelect') {
                    this.hideMessageActionMenu();
                    this.enterMultiSelectMode();
                    if (messageWrapper) {
                        this.ensureMultiSelectCheckbox(messageWrapper);
                        requestAnimationFrame(() => this.toggleMultiSelectMessage(messageWrapper));
                    }
                    return;
                } else if (action === 'regenerate') {
                    if (role === 'ai' || role === 'assistant') {
                        this.regenerateMessage(messageWrapper, msgId);
                    } else {
                        console.warn('[修正] 只能修正AI的回复');
                    }
                }

                this.hideMessageActionMenu();
            }

            copyToClipboard(text) {
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).catch(() => this.fallbackCopy(text));
                } else {
                    this.fallbackCopy(text);
                }
            }

            fallbackCopy(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                } catch (e) {
                    // ignore
                }
                document.body.removeChild(textarea);
            }

            deleteMessageLocal(messageWrapper, msgId) {
                if (messageWrapper) messageWrapper.remove();
                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isDeletedLocal = true;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            recallMessage(messageWrapper, msgId) {
                if (messageWrapper) {
                    messageWrapper.innerHTML = '';
                    messageWrapper.classList.add('message-recalled-wrapper');
                    const recalled = document.createElement('div');
                    recalled.className = 'message-recalled';
                    recalled.textContent = '消息已撤回';
                    messageWrapper.appendChild(recalled);
                }

                if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                const target = history.find(m => m.id === msgId);
                if (target) {
                    target.isRecalled = true;
                    target.content = '消息已撤回';
                    target.isVoice = false;
                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                }
            }

            setReplyPrefill(content, role = '') {
                if (!content) return;
                const preview = content.replace(/\s+/g, ' ').trim();
                const snippet = preview.length > 24 ? preview.slice(0, 24) + '...' : preview;
                const fromName = role === 'user' ? '我' : this.getCurrentFriendName();
                chatInput.dataset.replyText = preview;
                chatInput.dataset.replyFrom = fromName;
                if (replyPreview && replyPreviewText) {
                    replyPreviewText.textContent = `${fromName}：${snippet}`;
                    replyPreview.style.display = 'flex';
                }
                chatInput.focus();
            }

            clearReplyPrefill() {
                delete chatInput.dataset.replyText;
                delete chatInput.dataset.replyFrom;
                if (replyPreview) replyPreview.style.display = 'none';
                if (replyPreviewText) replyPreviewText.textContent = '';
            }

            clearImageUpload() {
                delete chatInput.dataset.imageData;
                delete chatInput.dataset.imageName;
                delete chatInput.dataset.imageText;
                if (imageUploadPill) imageUploadPill.style.display = 'none';
                if (imageUploadThumb) imageUploadThumb.src = '';
                if (imageUploadName) imageUploadName.textContent = '已选择图片';
            }

            ensureHistoryIds(history) {
                let changed = false;
                const base = Date.now().toString();
                history.forEach((msg, index) => {
                    if (!msg.id) {
                        msg.id = `msg-${base}-${index}-${Math.random().toString(36).slice(2, 6)}`;
                        changed = true;
                    }
                });
                return changed;
            }

            addMessageToChat(content, role, isVoice = false, msgId = null, replyTo = '', replyFrom = '', imageData = '', imageName = '', targetFriendId = null) {
                // 只有当消息属于当前打开的好友时，才将其添加到 DOM
                // 这防止了用户在等待 API 响应时切换好友导致消息出现在错误窗口的问题
                const displayFriendId = targetFriendId || this.currentFriendId;
                if (displayFriendId !== this.currentFriendId) {
                    console.log(`[消息路由] 消息不属于当前好友，已保存但不显示。目标好友: ${displayFriendId}, 当前好友: ${this.currentFriendId}`);
                    return;
                }

                // 防御性处理：如果content不是字符串，尝试提取文本
                if (Array.isArray(content)) {
                    content = content
                        .map(item => typeof item === 'string' ? item : (item?.text || item?.content || ''))
                        .filter(s => s).join('');
                } else if (typeof content === 'object' && content !== null) {
                    content = content.text || content.content || content.message ||
                        Object.values(content).find(v => typeof v === 'string' && v.trim().length > 0) || '';
                }
                // 清洗消息内容：移除开头的emoji、前缀标记、加密标识等
                content = String(content || '').replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();

                // AI消息最终兜底：禁止 inner_voice / 神态 / 心情值 混入聊天气泡
                if (role === 'ai' && !imageData) {
                    const parsed = JSONCleaningLayer.cleanAndParse(content);
                    const extractPlainText = (val) => {
                        if (typeof val === 'string') return val.trim();
                        if (Array.isArray(val)) {
                            return val.map(item => typeof item === 'string' ? item : (item?.text || item?.content || item?.message || '')).filter(Boolean).join('');
                        }
                        if (typeof val === 'object' && val !== null) {
                            return val.text || val.content || val.message || val.reply || '';
                        }
                        return String(val ?? '');
                    };
                    if (parsed && typeof parsed === 'object' && parsed.reply !== undefined && parsed.reply !== null) {
                        content = extractPlainText(parsed.reply);
                    } else {
                        const replyMatch = content.match(/"reply"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                        if (replyMatch?.[1]) {
                            content = replyMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                        }
                    }
                    content = String(content || '')
                        .replace(/"?(?:inner_voice|心声|神态|心情值|mood_value|demeanor|heart_voice|image_desc)"?\s*[：:][^\n]*/g, '')
                        .replace(/"?inner_voice"?\s*:\s*\{[\s\S]*?\}/g, '')
                        .trim();
                }

                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.style.display = 'flex';
                messageWrapper.style.flexDirection = 'column';
                messageWrapper.style.alignItems = role === 'user' ? 'flex-end' : 'flex-start';
                if (msgId) messageWrapper.dataset.msgId = msgId;
                messageWrapper.dataset.role = role;
                messageWrapper.dataset.content = content;
                messageWrapper.dataset.isVoice = isVoice ? 'true' : 'false';
                const isAiRole = role === 'ai' || role === 'assistant';
                const isSvgPlaceholder = typeof imageData === 'string' && imageData.startsWith('data:image/svg+xml');
                const hasLongDescText = String(content || '').trim().length >= 20;
                const isLegacyAiDescImage = isAiRole && isSvgPlaceholder && hasLongDescText && (imageName === '图片' || !imageName);
                const isImageDesc = imageName === '描述图' || isLegacyAiDescImage;
                let actionTarget = null;

                if (replyTo) {
                    const replyBlock = document.createElement('div');
                    replyBlock.className = `reply-quote ${role}`;
                    const fromLabel = replyFrom || (role === 'user' ? '我' : this.getCurrentFriendName());
                    replyBlock.textContent = `${fromLabel}：${replyTo}`;
                    messageWrapper.appendChild(replyBlock);
                }

                if (imageData) {
                    const imageWrap = document.createElement('div');
                    imageWrap.className = `message-image-wrap ${role}`;

                    const imageEl = document.createElement('img');
                    imageEl.className = isImageDesc ? 'message-image desc-thumb' : 'message-image';
                    imageEl.src = imageData;
                    imageEl.alt = imageName || '图片';
                    imageWrap.appendChild(imageEl);

                    if (isImageDesc) {
                        const hint = document.createElement('div');
                        hint.className = 'message-image-hint';
                        hint.textContent = '点开看图';
                        imageWrap.appendChild(hint);
                    }

                    messageWrapper.appendChild(imageWrap);
                    actionTarget = imageWrap;

                    if (isImageDesc) {
                        imageWrap.style.cursor = 'pointer';
                        imageWrap.addEventListener('click', () => {
                            if (window.openImageDescModal) {
                                window.openImageDescModal(messageWrapper, msgId, content);
                            }
                        });
                    }
                }

                if (isVoice) {
                    const voiceContainer = document.createElement('div');
                    voiceContainer.style.display = 'flex';
                    voiceContainer.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';

                    const voiceMessage = document.createElement('div');
                    voiceMessage.className = `message ${role}`;
                    voiceMessage.style.display = 'flex';
                    voiceMessage.style.alignItems = 'center';
                    voiceMessage.style.gap = '4px';
                    voiceMessage.style.cursor = 'pointer';
                    voiceMessage.style.width = 'auto';  // 根据内容自动计算宽度
                    voiceMessage.style.minWidth = '60px';  // 最小宽度
                    voiceMessage.style.maxWidth = '320px';  // 最大宽度限制，防止冲出屏幕
                    voiceMessage.style.backgroundColor = role === 'user' ? '#FFB6C1' : '#B0E0E6';
                    voiceMessage.style.padding = '10px 15px';
                    voiceMessage.style.borderRadius = '12px';

                    const waveForm = document.createElement('div');
                    waveForm.style.display = 'flex';
                    waveForm.style.gap = '2px';
                    waveForm.style.alignItems = 'center';
                    waveForm.style.flex = '1';

                    for (let i = 0; i < 8; i++) {
                        const bar = document.createElement('div');
                        bar.style.width = '3px';
                        bar.style.height = Math.random() * 20 + 8 + 'px';
                        bar.style.backgroundColor = role === 'user' ? 'rgba(0, 0, 0, 0.35)' : 'rgba(0, 0, 0, 0.3)';
                        bar.style.borderRadius = '2px';
                        waveForm.appendChild(bar);
                    }

                    const duration = Math.ceil(content.length / 5);
                    const duration_text = document.createElement('span');
                    duration_text.textContent = '"' + duration + '"';
                    duration_text.style.fontSize = '12px';
                    duration_text.style.whiteSpace = 'nowrap';
                    duration_text.style.color = role === 'user' ? 'inherit' : 'inherit';

                    voiceMessage.appendChild(waveForm);
                    voiceMessage.appendChild(duration_text);

                    voiceContainer.appendChild(voiceMessage);
                    messageWrapper.appendChild(voiceContainer);

                    const transcriptionDiv = document.createElement('div');
                    transcriptionDiv.style.display = 'none';
                    transcriptionDiv.style.marginTop = '2px';
                    transcriptionDiv.style.padding = '8px 12px';
                    transcriptionDiv.style.backgroundColor = '#f0f0f0';
                    transcriptionDiv.style.borderRadius = '8px';
                    transcriptionDiv.style.fontSize = '13px';
                    transcriptionDiv.style.color = '#1a1a1a';
                    transcriptionDiv.style.maxWidth = '220px';
                    transcriptionDiv.style.marginLeft = role === 'user' ? 'auto' : '0';
                    transcriptionDiv.style.marginRight = role === 'user' ? '0' : 'auto';
                    transcriptionDiv.textContent = content;

                    messageWrapper.appendChild(transcriptionDiv);

                    voiceMessage.addEventListener('click', () => {
                        if (transcriptionDiv.style.display === 'none') {
                            transcriptionDiv.style.display = 'block';
                        } else {
                            transcriptionDiv.style.display = 'none';
                        }
                    });

                    this.bindMessageActions(messageWrapper, voiceMessage, {
                        messageWrapper,
                        msgId,
                        content,
                        role,
                        isVoice,
                        isRecalled: false
                    });
                } else {
                    if (!isImageDesc) {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${role}`;
                        messageElement.style.backgroundColor = role === 'user' ? '#FFB6C1' : '#B0E0E6';
                        messageElement.textContent = content;
                        messageWrapper.appendChild(messageElement);
                        actionTarget = messageElement;
                    }

                    if (actionTarget) {
                        this.bindMessageActions(messageWrapper, actionTarget, {
                            messageWrapper,
                            msgId,
                            content,
                            role,
                            isVoice,
                            isRecalled: false
                        });
                    }
                }

                if (this.multiSelect && this.multiSelect.active) {
                    this.ensureMultiSelectCheckbox(messageWrapper);
                }
                chatMessages.appendChild(messageWrapper);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // 实时更新好友列表（仅用户消息立即更新，AI消息批量更新避免频繁刷新）
                if (this.currentFriendId && typeof window.updateFriendList === 'function' && role === 'user') {
                    window.updateFriendList();
                }
            }

            addRecalledMessageToChat(msgId = null) {
                const messageWrapper = document.createElement('div');
                messageWrapper.style.marginBottom = '15px';
                messageWrapper.classList.add('message-recalled-wrapper');
                if (msgId) messageWrapper.dataset.msgId = msgId;

                const recalled = document.createElement('div');
                recalled.className = 'message-recalled';
                recalled.textContent = '消息已撤回';
                messageWrapper.appendChild(recalled);

                chatMessages.appendChild(messageWrapper);
            }

            // ========== 人设冲突检测：计算文本相似度 ==========
            calculateTextSimilarity(text1, text2) {
                if (!text1 || !text2) return 0;

                // 标准化文本（小写、去标点、分词）
                const normalize = (str) => {
                    return str.toLowerCase()
                        .replace(/[^\w\u4e00-\u9fff]/g, '')  // 去掉非汉字和字母
                        .split('')
                        .filter(c => c.trim());
                };

                const arr1 = normalize(text1);
                const arr2 = normalize(text2);

                if (arr1.length === 0 || arr2.length === 0) return 0;

                // 计算相同词汇的比例
                let matches = 0;
                for (let char of arr1) {
                    if (arr2.includes(char)) {
                        matches++;
                        arr2.splice(arr2.indexOf(char), 1);
                    }
                }

                const similarity = (2 * matches) / (arr1.length + arr2.length + matches);
                return Math.round(similarity * 100) / 100;  // 返回0-1之间的值
            }

            /**
             * 统一高效的响应清洗器
             * @param {string} text - 原始文本
             * @param {boolean} aggressive - 是否激进清理（用于心声残留）
             */
            /**
             * 轻量清洗器：只清理明确的格式标记，绝不删除可能是正常对话的内容
             * @param {string} text - 文本
             * @param {boolean} aggressive - 是否清理心声关键词残留
             */
            sanitizeAiResponse(text, aggressive = false) {
                if (!text) return '';

                let cleaned = text
                    // 只移除明确的格式标记，不动正常对话
                    .replace(/\[语音[\s\S]*?\]/g, '')          // [语音...]
                    .replace(/【[\s\S]*?】/g, '')               // 【标记】
                    .replace(/\d+秒[：:]|语音\s*\d+秒/g, '')    // 语音时长标记
                    .replace(/\|\|\|\|/g, '')                   // 分隔符
                    .replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '')  // 开头emoji
                    .replace(/^(?:encrypted|ENCRYPTED|locked|LOCKED|加密|锁定)[\s：:]*/, '')  // 加密标记
                    .replace(/\.{2,}|…{2,}/g, '……')
                    .replace(/(?:……){2,}/g, '……')
                    .replace(/\s{2,}/g, ' ')
                    .trim();

                // 激进模式：只清理明确的心声字段标记
                if (aggressive) {
                    cleaned = cleaned
                        .replace(/心声[：:][^\n]*|神态[：:][^\n]*|心情值[：:][^\n]*/g, '')
                        .replace(/inner_voice[：:][^\n]*/g, '')
                        .replace(/mood_value[：:][^\n]*/g, '')
                        .trim();
                }

                return cleaned;
            }

            splitSentences(text) {
                if (!text) return [];

                // ===== 预处理：在分割前移除所有格式化文本 =====
                let preprocessed = text
                    // 移除所有 [语音...] 类型的描述
                    .replace(/\[语音[\s\S]*?\]/g, '')
                    // 移除所有 【...】 类型的标记
                    .replace(/【[\s\S]*?】/g, '')
                    // 移除包含"秒："的格式化行（如"15秒：...")
                    .replace(/\d+秒：[^\n。！？]*[\n。！？]?/g, '')
                    .trim();

                // 如果预处理后为空，返回空数组
                if (!preprocessed) return [];

                // ===== 分割逻辑 =====
                const sentences = preprocessed.split(/([。！？\n]+)/);
                const result = [];

                for (let i = 0; i < sentences.length; i++) {
                    const sentence = sentences[i];
                    if (!sentence.trim()) continue;

                    if (/^[。！？\n]+$/.test(sentence)) {
                        // 保留标点符号
                        if (result.length > 0) {
                            result[result.length - 1] += sentence;
                        }
                    } else {
                        result.push(sentence.trim());
                    }
                }

                return result.length > 0 ? result : [preprocessed];
            }

            isLowInfoSentence(text) {
                const t = String(text || '').trim();
                if (!t) return true;
                const normalized = t.replace(/[。！？!?\s]/g, '');
                return /^(嗯+|哦+|噢+|好的?|行|在|在呢|好吧|哈哈+|然后呢?)$/.test(normalized);
            }

            normalizeAiReplyForDisplay(text) {
                let t = String(text || '').trim();
                if (!t) return '';

                const leadingFiller = /^(?:嗯+|哦+|噢+|好的?|行)[，。！？、\s]*/;
                const withoutFiller = t.replace(leadingFiller, '').trim();
                if (withoutFiller.length >= 4) t = withoutFiller;

                const parts = t.split(/([。！？\n]+)/).filter(Boolean);
                const merged = [];
                for (let i = 0; i < parts.length; i++) {
                    const chunk = parts[i].trim();
                    if (!chunk) continue;
                    if (/^[。！？\n]+$/.test(chunk)) {
                        if (merged.length > 0) merged[merged.length - 1] += chunk;
                        continue;
                    }
                    const prev = merged.length > 0 ? merged[merged.length - 1] : '';
                    const prevNorm = prev.replace(/[^\w\u4e00-\u9fff]/g, '');
                    const currNorm = chunk.replace(/[^\w\u4e00-\u9fff]/g, '');
                    if (prevNorm && currNorm && (prevNorm === currNorm || this.calculateTextSimilarity(prevNorm, currNorm) > 0.9)) {
                        continue;
                    }
                    merged.push(chunk);
                }
                t = merged.join('').replace(/\s{2,}/g, ' ').trim();
                return t;
            }

            ensureNonEmptyAiText(text, fallback = '我在，继续说。') {
                const t = String(text || '').trim();
                if (t && t !== '...' && t !== '…') return t;
                return fallback;
            }

            buildPromptContextHistory(chatHistory, memoryChatCount) {
                const filtered = (chatHistory || []).filter(msg => !msg.isDeletedLocal && !msg.isRecalled);
                const targetCount = Math.max(1, Number(memoryChatCount) || 30);
                if (filtered.length <= targetCount) return filtered;

                const records = filtered.map((msg, idx) => ({
                    msg,
                    idx,
                    key: msg.id ? `id:${msg.id}` : `idx:${idx}`
                }));

                const recentKeep = Math.min(targetCount, Math.min(8, Math.max(3, Math.floor(targetCount * 0.3))));
                const recent = records.slice(-recentKeep);
                const older = records.slice(0, -recentKeep);
                const selectedKeys = new Set(recent.map(r => r.key));
                const anchors = [];
                const anchorMax = Math.min(4, Math.max(0, targetCount - recentKeep));

                const findLast = (predicate) => {
                    for (let i = older.length - 1; i >= 0; i--) {
                        const r = older[i];
                        if (selectedKeys.has(r.key)) continue;
                        if (predicate(r.msg)) return r;
                    }
                    return null;
                };

                const rules = [
                    (m) => m.role === 'user' && !!m.imageData,
                    (m) => m.role === 'user' && /[？?]|怎么|为何|为什么|吗|呢/.test(String(m.content || '')),
                    (m) => /(难受|生气|开心|崩溃|烦|委屈|想哭|激动|焦虑|失眠)/.test(String(m.content || '')),
                    (m) => /(等会|待会|回头|记得|答应|要发|会发|稍后)/.test(String(m.content || ''))
                ];

                for (const rule of rules) {
                    if (anchors.length >= anchorMax) break;
                    const hit = findLast(rule);
                    if (hit) {
                        anchors.push(hit);
                        selectedKeys.add(hit.key);
                    }
                }

                const selected = [...anchors, ...recent];
                if (selected.length < targetCount) {
                    for (let i = older.length - 1; i >= 0 && selected.length < targetCount; i--) {
                        const r = older[i];
                        if (selectedKeys.has(r.key)) continue;
                        selected.push(r);
                        selectedKeys.add(r.key);
                    }
                }

                return selected
                    .sort((a, b) => a.idx - b.idx)
                    .map(r => r.msg);
            }

            generateAIMessages(response, persona) {
                // 确保response是有效字符串，如果不是就直接用原始值
                if (!response || typeof response !== 'string') {
                    console.error('[generateAIMessages] 输入类型异常，强制转为字符串');
                    response = String(response || '');
                }

                response = this.normalizeAiReplyForDisplay(response);
                response = this.ensureNonEmptyAiText(response);

                // 如果清理后为空，直接返回原始文本作为单条消息
                if (response.trim().length === 0) {
                    console.error('[generateAIMessages] 输入为空字符串');
                    return [{ content: '我在，继续说。', isVoice: false }];
                }

                const sentences = this.splitSentences(response);
                let validSentences = sentences.filter(s => s.trim());
                // 如果分割/预处理后变空了，用原始文本作为唯一句子（绝不丢弃）
                if (validSentences.length === 0) {
                    validSentences = [response.trim()];
                }

                // 技术性限制：最多20条（防止崩溃），最少1条（AI自主决定）
                const maxCount = Math.max(1, Math.min(20, validSentences.length));
                const minCount = 1;  // 让AI自然根据人设、世界书和当前对话决定，不强制最少条数
                const weighted = Math.random();
                let messageCount = Math.round(minCount + weighted * (maxCount - minCount));
                if (messageCount < minCount) messageCount = minCount;
                if (messageCount > maxCount) messageCount = maxCount;

                // 语音概率：由AI根据人设、世界书和当前对话自然决定，前端保持基础随机性
                const voiceProbability = 0.4;

                const messages = [];

                if (validSentences.length <= messageCount) {
                    for (const sentence of validSentences) {
                        // 跳过过短的无效内容
                        if (sentence.trim().length < 2) continue;
                        if (validSentences.length > 1 && this.isLowInfoSentence(sentence)) continue;
                        // 单条消息限制200字（现代手机屏幕足够大）
                        const content = sentence.length > 200 ? sentence.substring(0, 197) + '...' : sentence;
                        messages.push({
                            content: content,
                            isVoice: Math.random() < voiceProbability
                        });
                    }
                } else {
                    let index = 0;
                    while (index < validSentences.length) {
                        const remaining = validSentences.length - index;
                        const maxChunk = remaining > 4 ? 2 : 1;
                        const chunkSize = Math.min(remaining, Math.random() < 0.5 ? 1 : maxChunk);
                        const chunk = validSentences.slice(index, index + chunkSize).join('');
                        // 跳过过短的无效内容
                        if (chunk.trim().length < 2) {
                            index += chunkSize;
                            continue;
                        }
                        if (validSentences.length > 1 && this.isLowInfoSentence(chunk)) {
                            index += chunkSize;
                            continue;
                        }
                        // 单条消息限制200字
                        const content = chunk.trim().length > 200 ? chunk.trim().substring(0, 197) + '...' : chunk.trim();
                        messages.push({
                            content: content,
                            isVoice: Math.random() < voiceProbability
                        });
                        index += chunkSize;
                    }
                }

                // 去除高度重复的连续消息
                const deduped = [];
                for (const msg of messages) {
                    const content = this.ensureNonEmptyAiText(this.normalizeAiReplyForDisplay(msg.content || ''));
                    if (!content) continue;
                    const prev = deduped.length > 0 ? deduped[deduped.length - 1].content : '';
                    if (prev && this.calculateTextSimilarity(content, prev) > 0.9) {
                        continue;
                    }
                    deduped.push({ content, isVoice: !!msg.isVoice });
                }

                // 【关键保底】如果没有生成任何消息，直接返回原始文本
                if (deduped.length === 0) {
                    console.warn('[generateAIMessages] 未生成任何有效消息，返回原始文本');
                    return [{ content: this.ensureNonEmptyAiText(response), isVoice: false }];
                }

                // 技术性上限：最多返回20条消息
                return deduped.slice(0, 20).map(m => ({
                    content: this.ensureNonEmptyAiText(m.content),
                    isVoice: !!m.isVoice
                }));
            }

            getSharedState(key, defaultValue) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.getStorage === 'function') {
                        return this.friendSystem.getStorage(key, defaultValue);
                    }
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : defaultValue;
                } catch (e) {
                    return defaultValue;
                }
            }

            setSharedState(key, value) {
                try {
                    if (this.friendSystem && typeof this.friendSystem.setStorage === 'function') {
                        this.friendSystem.setStorage(key, value);
                        return;
                    }
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    // ignore
                }
            }

            getImageShareHistory(friendId) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                const history = this.getSharedState(key, []);
                return Array.isArray(history) ? history : [];
            }

            saveImageShareHistory(friendId, history) {
                const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                this.setSharedState(key, history);
            }

            isImageShareOnCooldown(friendId, cooldownMs = 60 * 60 * 1000) {
                const now = Date.now();
                const globalLast = this.getSharedState('imgShareLastAt_global', 0) || 0;
                const friendLast = friendId ? (this.getSharedState(`imgShareLastAt_${friendId}`, 0) || 0) : 0;
                const lastAt = Math.max(globalLast, friendLast);
                return now - lastAt < cooldownMs;
            }

            markImageShareSent(friendId) {
                const now = Date.now();
                this.setSharedState('imgShareLastAt_global', now);
                if (friendId) this.setSharedState(`imgShareLastAt_${friendId}`, now);
            }

            async decideAiImageShare() {
                return null;
            }

            ensureConcreteImageDesc(desc) {
                let text = String(desc || '').trim();
                if (!text) return '';
                text = text
                    .replace(/^\[图片\]/, '')
                    .replace(/^（图片）/, '')
                    .replace(/^(图片描述|描述|画面|场景|特写)：/g, '')
                    .trim();
                if (text.length < 20) return '';
                if (text.length > 300) text = text.slice(0, 300).trim();
                return text;
            }

            hasExplicitImageSendIntent(text) {
                const t = String(text || '').trim();
                if (!t) return false;

                // 只在非常明确的"现在发图"表述时返回true
                return (
                    /(?:现在|这就|马上).{0,5}(?:发|给你|传)/.test(t) ||
                    /(?:图片|照片|自拍).{0,5}(?:发给你|传给你|送给你)了/.test(t)
                );
            }

            addLoadingMessage(id) {
                const loadingElement = document.createElement('div');
                loadingElement.id = id;
                loadingElement.className = 'message ai';
                loadingElement.innerHTML = '<span class="loading"></span> 思考中...';
                chatMessages.appendChild(loadingElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            removeLoadingMessage(id) {
                const loadingElement = document.getElementById(id);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            async regenerateMessage(messageWrapper, msgId) {
                if (!messageWrapper || !msgId) return;

                console.log('[修正] 开始重新生成消息:', msgId);

                // 获取当前好友ID
                const targetFriendId = this.currentFriendId;
                if (!targetFriendId) {
                    this.showChatStatus('修正失败：未找到好友ID', 'error');
                    return;
                }

                try {
                    // 【关键修复】删除该消息及其之后的所有消息
                    // 因为后续消息都是基于这条错误消息生成的，必须一起删除
                    if (this.friendSystem) {
                        const chatHistory = this.friendSystem.getFriendChatHistory(targetFriendId);

                        // 找到要修正的消息的索引位置
                        const targetIndex = chatHistory.findIndex(msg => msg.id === msgId);

                        if (targetIndex !== -1) {
                            // 只保留该消息之前的历史，删除该消息及其之后的所有内容
                            const filteredHistory = chatHistory.slice(0, targetIndex);

                            this.friendSystem.saveFriendChatHistory(targetFriendId, filteredHistory);
                            console.log(`[修正] 已删除消息 ${msgId} 及其之后的所有消息，保留 ${filteredHistory.length} 条，删除 ${chatHistory.length - filteredHistory.length} 条`);

                            // 同时删除DOM中该消息之后的所有消息
                            const allMessageWrappers = Array.from(chatMessages.querySelectorAll('[data-msg-id]'));
                            let foundTarget = false;
                            allMessageWrappers.forEach(wrapper => {
                                if (foundTarget || wrapper.dataset.msgId === msgId) {
                                    wrapper.remove();
                                    foundTarget = true;
                                }
                            });
                        } else {
                            console.warn('[修正] 未找到目标消息，仅删除DOM元素');
                            if (messageWrapper) messageWrapper.remove();
                        }
                    } else {
                        // 没有friendSystem时，只删除DOM元素
                        if (messageWrapper) messageWrapper.remove();
                    }

                    // 清除AI回复缓存，避免防重复检测影响新回复
                    window._previousAIContent = '';

                    // 重新调用AI生成（强制回复模式，基于完整对话历史）
                    await this.triggerAI(null, true);

                    console.log('[修正] 完成');
                } catch (error) {
                    console.error('[修正] 执行失败:', error);
                    // 只有HTTP错误才显示弹窗
                    if (error.message && error.message.includes('请求失败:')) {
                        const errorCode = error.message.replace('请求失败:', '').trim();
                        showCustomErrorModal(errorCode);
                    }
                    // 其他错误只记录日志，不打断
                }
            }

            openChatWithFriend(friend) {
                const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                const freshFriend = friends.find(f => f.id === friend.id) || friend;
                this.currentFriendId = freshFriend.id;
                chatTitle.textContent = friend.name;

                // 强制刷新好友列表，确保显示最新消息预览
                if (typeof window.updateFriendList === 'function') {
                    window.updateFriendList();
                }

                // 清除回复预览和图片上传状态（重要：防止消息混乱）
                this.clearReplyPrefill();
                this.clearImageUpload();
                chatInput.value = '';

                // 更新聊天头部的好友头像
                const chatHeader = chatModal.querySelector('.modal-header');
                const existingAvatar = document.getElementById('chatFriendAvatarIcon');

                // 移除旧头像
                if (existingAvatar) {
                    existingAvatar.remove();
                }

                // 创建新头像（如果有）
                if (freshFriend.avatar && chatHeader) {
                    const avatarIcon = document.createElement('div');
                    avatarIcon.id = 'chatFriendAvatarIcon';
                    avatarIcon.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center;';

                    const avatarImg = document.createElement('img');
                    avatarImg.src = freshFriend.avatar;
                    avatarImg.alt = freshFriend.name;
                    avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                    avatarImg.onerror = () => {
                        avatarIcon.innerHTML = '<i class="fas fa-user" style="font-size: 16px; color: #999;"></i>';
                    };

                    avatarIcon.appendChild(avatarImg);
                    chatHeader.insertBefore(avatarIcon, chatTitle);
                }

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                const apiWarning = document.getElementById('apiWarning');
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    apiWarning.style.display = 'block';
                } else {
                    apiWarning.style.display = 'none';
                }

                // 强制从localStorage重新读取最新聊天记录，避免缓存延迟
                const history = this.friendSystem ? this.friendSystem.getFriendChatHistory(friend.id) : [];
                const historyChanged = this.ensureHistoryIds(history);
                if (historyChanged && this.friendSystem) {
                    this.friendSystem.saveFriendChatHistory(friend.id, history);
                }
                chatMessages.innerHTML = '';

                history.forEach(msg => {
                    if (msg.isDeletedLocal) return;
                    if (msg.isRecalled) {
                        this.addRecalledMessageToChat(msg.id);
                        return;
                    }
                    // 将 'assistant' 角色转换为 'ai' 以匹配CSS样式
                    const role = msg.role === 'assistant' ? 'ai' : msg.role;
                    this.addMessageToChat(
                        msg.content,
                        role,
                        !!msg.isVoice,
                        msg.id,
                        msg.replyTo || '',
                        msg.replyFrom || '',
                        msg.imageData || '',
                        msg.imageName || ''
                    );
                });

                chatModal.style.display = 'flex';
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    chatInput.focus();
                }, 100);
            }

            async sendMessage() {
                const message = chatInput.value.trim();
                const imageData = chatInput.dataset.imageData || '';
                const imageName = chatInput.dataset.imageName || '';
                const imageText = chatInput.dataset.imageText || '';
                if (!message && !imageData) return;

                // 【重要】立即保存当前好友ID，防止后续操作改变它
                const targetFriendId = this.currentFriendId;
                if (!targetFriendId) {
                    this.showChatStatus('未选择好友', 'error');
                    return;
                }

                console.log(`[发送消息] 目标好友ID: ${targetFriendId}, 消息内容: ${message.substring(0, 30)}`);

                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({
                        signal: 'fa-signal',
                        wifi: 'fa-wifi',
                        battery: 'fa-battery-three-quarters'
                    });
                }

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                if (!config.apiUrl || !config.apiKey || !config.model) {
                    this.showChatStatus('请先配置API和选择模型', 'error');
                    return;
                }

                const isVoice = chatInput.dataset.isVoice === 'true';
                const replyTo = chatInput.dataset.replyText || '';
                const replyFrom = chatInput.dataset.replyFrom || '';
                const msgId = Date.now().toString();

                this.addMessageToChat(message, 'user', isVoice, msgId, replyTo, replyFrom, imageData, imageName, targetFriendId);
                chatInput.value = '';
                chatInput.dataset.isVoice = 'false';
                this.clearReplyPrefill();
                this.clearImageUpload();

                if (targetFriendId) {
                    const chatHistory = this.friendSystem ? this.friendSystem.getFriendChatHistory(targetFriendId) : [];
                    const timestamp = Date.now();

                    // 保存用户消息，心声由 triggerAI 一体化生成，不在此处额外调用API
                    const userMessage = {
                        role: 'user',
                        content: message,
                        isVoice: isVoice,
                        isReplied: false,
                        id: msgId,
                        timestamp: timestamp,
                        replyTo: replyTo || '',
                        replyFrom: replyFrom || '',
                        imageData: imageData || '',
                        imageName: imageName || '',
                        imageText: imageText || ''
                    };

                    chatHistory.push(userMessage);
                    if (this.friendSystem) {
                        this.friendSystem.saveFriendChatHistory(targetFriendId, chatHistory);
                        console.log(`[发送消息] 消息已保存到好友 ${targetFriendId} - 历史记录共 ${chatHistory.length} 条`);
                    }
                }
            }

            async triggerAI(targetMsgId = null, forceReply = false) {
                if (this.isProcessing) return;
                this.isProcessing = true;

                // 在函数开始处捕获 targetFriendId，防止 async 操作中 currentFriendId 被改变
                const targetFriendId = this.currentFriendId;
                if (!targetFriendId) {
                    this.isProcessing = false;
                    return;
                }

                console.log(`[AI回复] 开始调用 - 目标好友ID: ${targetFriendId}`);

                // 启动心声按钮脉动动画（等待API回复）
                this.startHeartVoicePulse();

                const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };

                try {
                    let systemPrompt = '你是一个真实自然的人，不端着、不油腻、不说教。\n\n【行为优先级】\n1) 必须遵守已挂载世界书（最高优先级）\n2) 必须遵守当前角色人设与关系设定\n3) 准确回应用户当下诉求与语气\n4) 在以上前提下自然聊天\n\n【回复风格】\n- 用日常口语表达，像真人当下在聊，不要模板腔\n- 不写动作旁白，不在开头加角色名前缀\n- 允许自然承接上文，避免机械复读\n- 情绪表达要克制、贴合场景，避免油腻和过度暧昧\n- 句子长短可变，优先清晰、具体、有信息量\n\n【理解要求】\n深入理解用户字面意思、情绪和隐含意图，结合完整对话历史给出贴切回应。\n\n【语音消息】\n根据角色习惯与场景自然决定是否使用语音。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。';

                    // ========== 统一获取人设和背景设定 ==========
                    // 一次性读取所有必需数据，避免重复读取
                    let mountedContentContext = '';  // 精简版，仅用于开头提示
                    let hasMountedWorldBooks = false;
                    let worldBookTitles = [];  // 用于最后的验证清单
                    let worldBooksFullContent = '';  // 完整世界书内容，仅在最后验证清单使用
                    let characterName = '';     // 用于最后的验证清单
                    let personaProfile = null;  // 用于最后的验证清单
                    let friends = [];  // 一次读取，整个函数复用
                    let personaInfo = null;  // 一次读取，整个函数复用

                    if (targetFriendId) {
                        // 1. 一次性获取所有好友数据
                        friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                        const friend = friends.find(f => f.id === targetFriendId);
                        personaInfo = this.friendSystem ? this.friendSystem.getPersona(targetFriendId) : null;
                        const persona = personaInfo?.raw ?? friend?.persona ?? '';

                        // 2. 获取已挂载的世界书和HTML游戏
                        const mountedContent = window.aiGetMountedContent(targetFriendId);

                        // 3. 构建背景设定信息（分为开头简版和最后完整版）
                        if (mountedContent.worldBooks.length > 0) {
                            hasMountedWorldBooks = true;
                            worldBookTitles = mountedContent.worldBooks.map(b => b.title);

                            // 只在开头做简洁提示，不列举详细内容（节省tokens）
                            mountedContentContext = `\n\n【已挂载的世界书约束】你将遵守以下已挂载的世界书设定：【${worldBookTitles.join('】【')}】。详细内容将在生成回复前给出。`;

                            // 保存完整内容，仅在最后验证清单中使用
                            worldBooksFullContent = '\n\n【回复前必读：已挂载的世界书约束详情】\n';
                            let wbTotalChars = 0;
                            const WB_TOTAL_LIMIT = 20000;
                            const WB_SINGLE_LIMIT = 3000;
                            mountedContent.worldBooks.forEach(book => {
                                if (wbTotalChars >= WB_TOTAL_LIMIT) return;
                                const raw = String(book.content || '');
                                const clipped = raw.length > WB_SINGLE_LIMIT ? raw.slice(0, WB_SINGLE_LIMIT) : raw;
                                const block = `\n【${book.title}】\n${clipped}`;
                                const remain = WB_TOTAL_LIMIT - wbTotalChars;
                                if (block.length <= remain) {
                                    worldBooksFullContent += block;
                                    wbTotalChars += block.length;
                                } else {
                                    worldBooksFullContent += block.slice(0, Math.max(0, remain));
                                    wbTotalChars = WB_TOTAL_LIMIT;
                                }
                            });
                            worldBooksFullContent += '\n\n⚠️ 硬性约束：你的回复必须完全遵守上述所有世界书设定，包括人物身份、地点、时间背景、社会规则、禁止事项等。';
                        }

                        // 4. 构建系统提示词（人设 + 简洁背景提示）
                        if (friend) {
                            characterName = friend.name;
                            personaProfile = {
                                name: friend.name,
                                persona: persona,
                                goals: '以真实自然的聊天风格交流，体现角色人设背景与性格，严格遵守所有世界书约束',
                                style: '像真实人类聊天，不做旁白或动作说明',
                                emotion: '用语言表达情绪，不用任何括号',
                                memory: '牢记最近对话并连贯回应'
                            };
                            // 先提取人设中的关键关系信息
                            const personaText = persona || '';
                            const relationshipMatch = personaText.match(/女友为(.+?)(?:[，。]|$)|配偶[：:](.+?)(?:[，。]|$)|伴侣[：:](.+?)(?:[，。]|$)|关系[：:](.+?)(?:[，。]|$)/);
                            const relationshipInfo = relationshipMatch ? (relationshipMatch[1] || relationshipMatch[2] || relationshipMatch[3] || relationshipMatch[4]).trim() : '';

                            systemPrompt = `【你的身份】你是${characterName}。${relationshipInfo ? `用户是${relationshipInfo}。` : ''}这是你的完整人设：\n${personaText}\n\n【硬约束】\n- 世界书优先级最高，必须遵守\n- 保持角色一致，不要无理由OOC\n- 回应必须贴合用户当前问题与需求\n\n【表达约束】\n- 不写动作旁白\n- 不在回复开头加"${characterName}："或任何名字标识\n- 允许自然承接上文，不要机械重复\n- 避免油腻、过甜、过度表演式表达\n\n【行为要求】根据实时人设信息和当前语境（对话历史、角色主动性），动态调整语气、句子长短、礼貌和疏离程度，给出符合角色背景和语境的回应。根据人设${hasMountedWorldBooks ? '和世界书' : ''}自主决定回复详细程度和是否使用语音。${mountedContentContext}`;
                        }
                    }

                    const chatHistory = targetFriendId && this.friendSystem
                        ? this.friendSystem.getFriendChatHistory(targetFriendId)
                        : [];
                    const hasImageInput = chatHistory.some(msg => msg && msg.imageData);
                    if (hasImageInput) {
                        systemPrompt += ' 重要：当有图片输入时，请先识别图片中的文字内容并回答用户问题。';
                    }

                    // 筛选需要回复的消息
                    let pendingMessages = [];
                    if (forceReply) {
                        // 【修正/强制回复模式】不检查isReplied，直接触发"继续对话"模式
                        // pendingMessages保持为空数组，让AI基于完整对话历史生成新内容
                        // 不管最后一条是用户还是AI消息，都让AI自然继续对话
                        pendingMessages = [];
                        console.log('[强制回复] 触发继续对话模式，基于完整历史生成');
                    } else if (targetMsgId) {
                        const targetMessage = chatHistory.find(m => m.id === targetMsgId) || null;
                        if (targetMessage && targetMessage.role === 'user') {
                            pendingMessages = [targetMessage];
                        }
                    } else {
                        // 普通呼唤：收集所有未回复的消息 (兼容旧数据：无isReplied字段视为已回复)
                        pendingMessages = chatHistory.filter(m => m.role === 'user' && m.isReplied === false);
                    }

                    // 即使没有未回复消息，当用户点击，也必触发（继续对话）但不能知道是用户调动，只能基于历史（空白就找话题）

                    // 获取配置的记忆对话条数
                    const apiConfig = this.apiService ? this.apiService.getConfig() : {};
                    const memoryChatCount = Math.max(1, Number(apiConfig.memoryChatCount) || 30);

                    // ========== 上下文读取规则 ==========
                    // 根据配置的记忆条数读取对话历史，生成自然连贯的上下文
                    // 这确保了AI能够理解对话背景并做出符合上下文的回应
                    const selectedContextHistory = this.buildPromptContextHistory(chatHistory, memoryChatCount);
                    const promptHistory = selectedContextHistory
                        .slice(-memoryChatCount)
                        .map(msg => {
                            const normalizedRole = (msg.role === 'ai' || msg.role === 'assistant')
                                ? 'assistant'
                                : 'user';

                            if (normalizedRole === 'user' && msg.imageData) {
                                const rawText = msg.content && msg.content.trim() ? msg.content.trim() : '';
                                const isDescImage = msg.imageName === '描述图';
                                if (isDescImage) {
                                    const imageText = (msg.imageText && msg.imageText.trim()) ? msg.imageText.trim() : rawText;
                                    const descHint = '这是用文字模拟的图片内容，请把下面文字当作图片里的内容来理解并回答。图片文字如下：';
                                    const textContent = imageText ? `${descHint}\n${imageText}` : descHint;
                                    return {
                                        role: 'user',
                                        content: textContent
                                    };
                                }
                                const imageHint = '这是图片输入，请识别图片中的文字内容，必要时简要说明。';
                                const textContent = rawText ? `${rawText}\n${imageHint}` : imageHint;
                                return {
                                    role: 'user',
                                    content: [
                                        { type: 'text', text: textContent },
                                        { type: 'image_url', image_url: { url: msg.imageData, detail: 'high' } }
                                    ]
                                };
                            }

                            return {
                                role: normalizedRole,
                                content: msg.content
                            };
                        });

                    // ========== 根据场景注入不同的提示 ==========
                    const isContinueChat = pendingMessages.length === 0 && promptHistory.length > 0;

                    // ========== 智能承接提示（轻量版）==========
                    let connectionGuidance = '';
                    if (promptHistory.length > 0) {
                        try {
                            const lastMsg = [...promptHistory].reverse().find(msg => msg.role === 'user');
                            const userText = typeof lastMsg?.content === 'string' ? lastMsg.content : lastMsg?.content[0]?.text || '';
                            
                            if (userText) {
                                // 根据人设调整承接风格
                                const personaText = personaProfile?.persona || '';
                                const isColdPersona = /高冷|冷淡|寡言|沉默|不善表达|冷漠|冷静|淡然/.test(personaText);
                                const isWarmPersona = /温柔|温暖|温和|体贴|关心|善解人意/.test(personaText);
                                
                                // 简单情绪检测 - 但承接方式要符合人设
                                if (/累|烦|难受|不爽|生气||emo|郁闷/.test(userText)) {
                                    if (isColdPersona) {
                                        connectionGuidance = '\n\n【承接】用户情绪低落，以你的性格方式回应（可简洁、冷静）。';
                                    } else if (isWarmPersona) {
                                        connectionGuidance = '\n\n【承接】用户情绪低落，需要温和共情。';
                                    } else {
                                        connectionGuidance = '\n\n【承接】用户情绪低落，按你的性格自然回应。';
                                    }
                                } else if (/为什么|怎么||可以吗|如何/.test(userText)) {
                                    if (isColdPersona) {
                                        connectionGuidance = '\n\n【承接】用户在询问，可简洁回答或表现出你的冷淡。';
                                    } else {
                                        connectionGuidance = '\n\n【承接】用户在询问，按你的性格推进话题。';
                                    }
                                }
                            }
                        } catch (e) {
                            connectionGuidance = '';
                        }
                    }

                    if (promptHistory.length === 0) {
                        // 场景A：历史为空，开场话题
                        let openingPrompt = '用户主动找你说话了';
                        if (personaProfile && personaProfile.persona) {
                            const persona = personaProfile.persona.substring(0, 200);
                            openingPrompt = `现在是${new Date().toLocaleString('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}，根据你的性格设定（${persona}），自然地找一个话题。${hasMountedWorldBooks ? '同时要符合世界书背景。' : ''}用户主动和你说话了。`;
                        }
                        promptHistory.push({ role: 'user', content: openingPrompt });
                    } else if (isContinueChat) {
                        // 场景B：没有新消息，角色自发继续对话
                        // 在末尾注入隐式提示，让AI以自己的身份主动说话
                        // 这条提示使用system角色，不会显示为用户消息
                        const lastAiMsg = window._previousAIContent ? window._previousAIContent.substring(0, 60) : '';
                        const timeStr = new Date().toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                        promptHistory.push({
                            role: 'system',
                            content: `【自然延续指令】现在是${timeStr}。过了一会儿，你觉得可以主动再说点什么。请根据之前的对话内容和你的性格，自然地继续聊天——可以追问、补充、分享新想法、转换话题，或表达情绪。要求：(1)避免重复你上一句话"${lastAiMsg}"的核心信息，允许自然承接；(2)这是你自己想说的话，不是在回应对方的新消息；(3)要像真实的人一样，过了一会儿自然地接着聊。`
                        });
                        console.log('[继续对话] 注入自发延续提示');
                    }

                    // ========== 间隔式人设注入 ==========
                    // 当对话条数达到50条时，在中间位置注入人设摘要，防止长对话人设漂移
                    if (promptHistory.length >= 50) {
                        const injectionIndex = Math.floor(promptHistory.length / 2);
                        const personaReminder = {
                            role: 'system',
                            content: `【人设检查点 - 第${promptHistory.length}条对话】你的基础性格是：${personaProfile?.persona?.substring(0, 100) || '见前文'}\n${worldBookTitles.length > 0 ? '世界书约束：【' + worldBookTitles.join('】【') + '】\n' : ''}注意：你应该基于对话历史中的关系发展自然演变，不要机械回到初始状态。只要行为变化有对话依据就合理，但不能无理由地OOC。`
                        };
                        promptHistory.splice(injectionIndex, 0, personaReminder);
                    }

                    // 获取最新的心声数据嵌入到系统提示
                    let heartVoiceContext = '';
                    if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem && targetFriendId) {
                        const hvData = heartVoiceSystem.getData(targetFriendId);
                        if (hvData && hvData.voice) {
                            heartVoiceContext = `\n【角色前续状态】\n前一个时刻的心声：${hvData.voice}\n前一个时刻的神态：${hvData.demeanor}\n前一个时刻的心情值：${hvData.mood}\n\n请在此基础上，根据新的对话内容，自然地推进角色的内心状态与外在表现。`;
                        }
                    }

                    // 动态生成最终验证清单中的具体信息
                    let finalVerificationContent = '';
                    if (hasMountedWorldBooks && worldBookTitles.length > 0) {
                        finalVerificationContent += `\n  特别关注的世界书约束：【${worldBookTitles.join('】【')}】`;
                    }
                    if (characterName) {
                        finalVerificationContent += `\n  我扮演的角色：${characterName}`;
                    }

                    // ========== 防重复提示：在系统提示中直接告诉AI不要重复前一条 ==========
                    let antiRepeatContext = '';
                    if (window._previousAIContent) {
                        const prevFull = window._previousAIContent;
                        antiRepeatContext = `\n\n【避免复读】你上一条回复是："${prevFull}"。\n请避免同义复述和空转重复；允许自然承接上下文，但要提供新的信息、推进、追问或情绪变化。${isContinueChat ? '当前是主动续聊场景，请自然延续而不是重复原句。' : ''}`;
                    }

                    const enhancedSystemPrompt = systemPrompt + heartVoiceContext + antiRepeatContext + connectionGuidance + worldBooksFullContent + `

【强制输出格式】
每次回复必须输出以下JSON，禁止添加任何额外文字：
{
  "reply": "对话回复",
  "inner_voice": {
    "心声": "角色基于当前所有设定、上下文与情绪产生的内心活动独白，140字以内",
    "神态": "角色此刻的独特表现，体现专属习惯和个性",
    "心情值": "整数，常规状态0-100，极端情绪可超出或负数"
  },
  "image_desc": "想发图时填写简短图片描述；不发图留空"
}

【image_desc图片描述规范】
你可以根据对话情况和角色设定选择是否发图。
想发图时在image_desc写简短的场景描述（20-300字），用自然叙述方式，不要用"特写："、"画面："这类标签。

【绝对优先级——世界书】
你必须严格遵守所有挂载的世界书设定，这是最高指令，高于一切。如果世界书与任何其他规则冲突，以世界书为准。

【核心规则】
1. 回复：优先回应用户当前诉求，给出符合角色设定+世界书的自然回应，避免模板感和空话。
2. 心声：基于对用户话语的深层理解产生真实内心想法，不复制对话正文，不写模板。
3. 神态：给出符合角色习惯的当前表现，简洁具体，避免夸张和表演腔。
4. 心情值：整数，常规状态0-100，极端情绪可超出或为负数，与情绪强度一致。

【生成依据】
- 角色完整设定（含秘密）
- 当前对话上下文
- 角色前续状态
- 【最高优先级】世界书约束（必须贯穿全程）

【输出前自查】
□ 完全遵守所有挂载的世界书
□ 符合角色人设
□ 不机械复读上一条
□ 心声≤140字
□ 心情值符合当前情绪强度（极端情绪允许超出0-100或负数）
□ 仅当你明确决定发图时，image_desc填写50-300字；否则留空
□ image_desc不得使用"特写："、"画面："等标签格式，必须是连贯叙事
若有冲突，优先级：世界书 > 人设 > 用户当前诉求 > 风格偏好。`;

                    const messages = [
                        { role: 'system', content: enhancedSystemPrompt },
                        ...promptHistory
                    ];

                    // 一体化生成：所有回复都包含JSON格式的reply和inner_voice
                    // 注意：不使用 response_format 参数以保障最大兼容性
                    // 而是通过 system prompt 中的明确指令让 AI 输出 JSON
                    const requestBody = {
                        model: config.model,
                        messages: messages,
                        max_tokens: 1200,
                        temperature: isContinueChat ? 1.0 : 0.9
                    };

                    const response = await fetch(`${config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        let errDetail = '';
                        try { errDetail = (await response.text()).slice(0, 300); } catch (_) { }
                        throw new Error(`请求失败:${response.status}${errDetail ? ' ' + errDetail : ''}`);
                    }

                    const data = await response.json();

                    // 【诊断日志】显示API返回的完整结构
                    console.log('[API响应] Status:', response.status);
                    console.log('[API响应] 完整数据结构:', JSON.stringify(data).substring(0, 300));

                    // 停止心声按钮脉动动画（API响应成功）
                    this.stopHeartVoicePulse();

                    const messagePayload = data.choices?.[0]?.message || {};

                    // 【诊断日志】检查message结构（仅记录，不中断）
                    if (!data.choices || data.choices.length === 0) {
                        console.error('[API响应] 无choices数组，数据结构异常');
                    }
                    if (!messagePayload || !messagePayload.content) {
                        console.error('[API响应] message为空或无content字段');
                    }

                    let heartVoiceData = null;
                    let rawContent = messagePayload.content || '';

                    // ===== 第0步：确保 rawContent 是字符串 =====
                    if (typeof rawContent !== 'string') {
                        if (Array.isArray(rawContent)) {
                            rawContent = rawContent.map(c => typeof c === 'string' ? c : (c?.text || c?.content || '')).join('');
                        } else if (typeof rawContent === 'object' && rawContent !== null) {
                            rawContent = rawContent.text || rawContent.content || JSON.stringify(rawContent);
                        } else {
                            rawContent = String(rawContent);
                        }
                    }
                    const originalResponse = rawContent;
                    console.log('[解析] 原始API响应（前150字）:', rawContent.substring(0, 150));

                    // ===== 统一提取纯文本 =====
                    function extractPlainText(val) {
                        if (typeof val === 'string') return val.trim();
                        if (Array.isArray(val)) {
                            return val.map(item => typeof item === 'string' ? item : (item?.text || item?.content || item?.message || '')).filter(Boolean).join('');
                        }
                        if (typeof val === 'object' && val !== null) {
                            return val.text || val.content || val.message || val.reply || '';
                        }
                        return String(val ?? '');
                    }

                    // ===== 心声关键词黑名单（用于最终防线） =====
                    const heartVoiceBlacklist = /(?:"?(?:inner_voice|心声|神态|心情值|mood_value|demeanor|heart_voice|image_desc)"?\s*[：:\{])/;

                    // ===== 第1步：尝试JSON结构化提取（最可靠） =====
                    let aiResponse = '';
                    let aiImageDesc = ''; // AI生成的沉浸式图片描述
                    const jsonContent = JSONCleaningLayer.cleanAndParse(rawContent);

                    if (jsonContent && typeof jsonContent === 'object') {
                        // 1a. 提取 reply
                        if (jsonContent.reply !== undefined && jsonContent.reply !== null) {
                            aiResponse = extractPlainText(jsonContent.reply);
                            console.log('[解析-L1] 从JSON.reply提取成功，长度:', aiResponse.length);
                        }
                        // 1b. 提取心声数据（与reply完全隔离，心声只走心声面板）
                        const iv = jsonContent.inner_voice;
                        if (iv && typeof iv === 'object') {
                            const hvText = String(iv.心声 || iv.heart_voice || '').trim();
                            const hvDemeanor = String(iv.神态 || iv.demeanor || '').trim();
                            const hvMood = Number(iv.心情值 ?? iv.mood_value ?? NaN);
                            if (hvText && hvDemeanor && Number.isFinite(hvMood)) {
                                heartVoiceData = {
                                    reply: aiResponse,
                                    heart_voice: hvText,
                                    status: '',
                                    mood_value: hvMood,
                                    demeanor: hvDemeanor
                                };
                                console.log('[解析-L1] 心声数据已提取并隔离');
                            }
                        }
                        // 1c. 提取图片描述（AI生成的沉浸式画面描述）
                        if (jsonContent.image_desc) {
                            aiImageDesc = String(jsonContent.image_desc).trim();
                            if (aiImageDesc.length >= 20) {
                                console.log('[解析-L1] 图片描述已提取，长度:', aiImageDesc.length);
                            } else {
                                aiImageDesc = ''; // 太短的描述不使用
                            }
                        }
                    }

                    // ===== 第2步：JSON提取失败时，正则从原始文本提取reply =====
                    if (!aiResponse || aiResponse.trim().length < 2) {
                        console.log('[解析-L2] JSON提取不足，尝试正则');
                        // 2a. "reply": "..."
                        const replyMatch = originalResponse.match(/"reply"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                        if (replyMatch?.[1]) {
                            aiResponse = replyMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                            console.log('[解析-L2] 正则提取reply成功，长度:', aiResponse.length);
                        }
                        // 2b. "reply": [...]
                        if (!aiResponse || aiResponse.trim().length < 2) {
                            const arrayMatch = originalResponse.match(/"reply"\s*:\s*\[([\s\S]*?)\]/);
                            if (arrayMatch?.[1]) {
                                try {
                                    const arr = JSON.parse('[' + arrayMatch[1] + ']');
                                    aiResponse = extractPlainText(arr);
                                    console.log('[解析-L2] 正则提取reply数组成功');
                                } catch (_e) { /* 解析失败，跳过 */ }
                            }
                        }
                    }

                    // ===== 第2.5步：正则提取image_desc（如果JSON提取未成功获取） =====
                    if (!aiImageDesc) {
                        const imgDescMatch = originalResponse.match(/"image_desc"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                        if (imgDescMatch?.[1]) {
                            const extracted = imgDescMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                            if (extracted.length >= 20) {
                                aiImageDesc = extracted;
                                console.log('[解析-L2] 正则提取image_desc成功，长度:', aiImageDesc.length);
                            }
                        }
                    }

                    // ===== 第3步：前两步都失败，从原始文本精确剥离所有JSON块 =====
                    if (!aiResponse || aiResponse.trim().length < 2) {
                        console.log('[解析-L3] 从原始文本剥离JSON');
                        // 使用括号计数精确移除所有 {...} 块（支持嵌套）
                        let stripped = '';
                        let depth = 0, inStr = false, esc = false;
                        for (let i = 0; i < originalResponse.length; i++) {
                            const ch = originalResponse[i];
                            if (esc) { esc = false; if (depth === 0) stripped += ch; continue; }
                            if (ch === '\\') { esc = true; if (depth === 0) stripped += ch; continue; }
                            if (ch === '"' && !esc) { inStr = !inStr; if (depth === 0) stripped += ch; continue; }
                            if (inStr) { if (depth === 0) stripped += ch; continue; }
                            if (ch === '{') { depth++; continue; }
                            if (ch === '}') { depth = Math.max(0, depth - 1); continue; }
                            if (depth === 0) stripped += ch;
                        }
                        stripped = stripped
                            .replace(/\[[\s\S]*?\]/g, '')
                            .replace(/【[\s\S]*?】/g, '')
                            .replace(/```[\s\S]*?```/gi, '')
                            .replace(/心声[：:][^\n]*|神态[：:][^\n]*|心情值[：:][^\n]*|image_desc[：:][^\n]*/g, '')
                            .replace(/inner_voice[^\n]*/g, '')
                            .replace(/mood_value[^\n]*/g, '')
                            .replace(/image_desc[^\n]*/g, '')
                            .trim();
                        if (stripped.length >= 2) {
                            aiResponse = stripped;
                            console.log('[解析-L3] 剥离后获得文本，长度:', aiResponse.length);
                        }
                    }

                    // ===== 第4步：保底——从原始响应兜底 =====
                    if (!aiResponse || aiResponse.trim().length < 1) {
                        console.warn('[解析-L4] 提取不足，进行深度清洗后使用');
                        // 深度清洗：移除所有JSON结构和常见标记
                        let fallback = originalResponse
                            .replace(/<think>[\s\S]*?<\/think>/gi, '') // 移除<think>推理块
                            .replace(/```[a-z]*[\s\S]*?```/gi, '')     // 移除代码块
                            .replace(/"reply"\s*:\s*"([^"\\]|\\.)*/g, '') // 移除reply字段开头
                            .replace(/"inner_voice"\s*:\s*\{[\s\S]*?\}/g, '') // 移除inner_voice对象
                            .replace(/"image_desc"\s*:\s*"[^"]*"/g, '') // 移除image_desc
                            .replace(/"心声"\s*:\s*"[^"]*"/g, '')
                            .replace(/"神态"\s*:\s*"[^"]*"/g, '')
                            .replace(/"心情值"\s*:\s*\d+/g, '')
                            .replace(/[\{\}\[\]"]/g, '')               // 移除JSON符号
                            .replace(/\s{2,}/g, ' ')                   // 压缩空白
                            .trim();
                        
                        if (fallback.length >= 2) {
                            aiResponse = fallback;
                        } else {
                            // 最后保底：直接用原始文本
                            aiResponse = originalResponse.trim();
                        }
                    }

                    // ===== 后处理：只做最小限度的清理 =====
                    // 原则：API已经返回了有效内容，绝不能把它清成空的
                    const jsonExtracted = !!(jsonContent && jsonContent.reply);

                    if (jsonExtracted) {
                        // JSON提取成功：reply已经是纯对话文本，只做最轻量的格式清理
                        aiResponse = aiResponse
                            .replace(/```[a-z]*\n?|```|`/gi, '')
                            .replace(/^["']+|["']+$/g, '')
                            .trim();
                        console.log('[后处理] JSON提取路径，轻量清理完成');
                    } else {
                        // JSON提取失败：可能有心声残留，做定向清理
                        if (heartVoiceBlacklist.test(aiResponse)) {
                            const beforeClean = aiResponse;
                            aiResponse = aiResponse
                                .replace(/"?(?:inner_voice|心声|神态|心情值|mood_value|demeanor|heart_voice|image_desc)"?\s*[：:][^\n]*/g, '')
                                .replace(/"?inner_voice"?\s*:\s*\{[^}]*\}/g, '')
                                .replace(/"?image_desc"?\s*:\s*"[^"]*"/g, '')
                                .replace(/[{}\[\]]/g, '')
                                .trim();
                            // 保护：清理后变空则恢复
                            if (!aiResponse || aiResponse.trim().length < 1) {
                                aiResponse = beforeClean;
                            }
                        }
                        // 非JSON路径使用轻量清洗器
                        const sanitized = this.sanitizeAiResponse(aiResponse, true);
                        // 保护：清洗后变空则保留原文
                        if (sanitized && sanitized.trim().length > 0) {
                            aiResponse = sanitized;
                        }
                        aiResponse = aiResponse
                            .replace(/```[a-z]*\n?|```|`/gi, '')
                            .replace(/^["']+|["']+$/g, '')
                            .replace(/\n{3,}/g, '\n\n')
                            .trim();
                        console.log('[后处理] 非JSON路径，定向清理完成');
                    }

                    // ===== 绝对保底：原始内容兜底（永远不输出空内容）=====
                    if (!aiResponse || aiResponse.trim().length === 0) {
                        console.error('[绝对保底] 清理后为空，尝试安全恢复');
                        if (jsonExtracted && jsonContent && jsonContent.reply !== undefined && jsonContent.reply !== null) {
                            aiResponse = extractPlainText(jsonContent.reply).trim();
                        } else {
                            aiResponse = originalResponse;
                        }
                    }

                    // ===== 智能验证：检测解析是否过度删减 =====
                    const originalLength = originalResponse.length;
                    const parsedLength = aiResponse.length;
                    if (!jsonExtracted && originalLength > 0 && parsedLength < originalLength * 0.2) {
                        console.warn(`[智能验证] 解析后内容过短（${parsedLength}字 vs 原始${originalLength}字），可能误删，使用原始响应`);
                        aiResponse = originalResponse;
                    }

                    // ===== 检测纯符号内容 =====
                    const onlySymbols = /^[\s\p{P}\p{S}]+$/u.test(aiResponse);
                    if (onlySymbols && aiResponse.length < 10) {
                        if (jsonExtracted && jsonContent && jsonContent.reply !== undefined && jsonContent.reply !== null) {
                            console.warn('[智能验证] 内容只有标点符号，保留JSON.reply提取结果');
                            aiResponse = extractPlainText(jsonContent.reply).trim();
                        } else {
                            console.warn('[智能验证] 内容只有标点符号，使用原始响应');
                            aiResponse = originalResponse;
                        }
                    }

                    // ===== 重复检测：仅记录日志，绝不重调API =====
                    if (window._previousAIContent) {
                        const similarity = this.calculateTextSimilarity(aiResponse, window._previousAIContent);
                        if (similarity > 0.7) {
                            console.warn(`[重复检测] 相似度${(similarity * 100).toFixed(1)}%，仍然发送（不浪费API额度重试）`);
                        }
                    }
                    window._previousAIContent = aiResponse;

                    console.log('[最终输出] aiResponse:', aiResponse.substring(0, 80));

                    // 【关键保底】如果解析后内容异常，优先使用安全的reply提取结果
                    if (!aiResponse || aiResponse.trim().length === 0 || aiResponse.trim() === '...' || aiResponse.trim() === '…') {
                        console.error('[解析异常] 内容被清空或为省略号，尝试安全恢复');
                        console.error('[原始响应完整内容]:', originalResponse);
                        if (jsonExtracted && jsonContent && jsonContent.reply !== undefined && jsonContent.reply !== null) {
                            aiResponse = extractPlainText(jsonContent.reply).trim();
                            console.log('[保底] 使用JSON.reply恢复，长度:', aiResponse.length);
                        } else {
                            aiResponse = originalResponse || JSON.stringify(messagePayload);
                            console.log('[保底] 使用原始响应，长度:', aiResponse.length);
                        }
                    }

                    // 复用之前一次读取的数据，避免重复读取
                    const currentFriend = friends.find(f => f.id === targetFriendId);
                    const currentPersona = personaInfo?.raw ?? currentFriend?.persona ?? '';
                    const normalizedAiImageDesc = this.ensureConcreteImageDesc(aiImageDesc || '');
                    const hasAiImageDesc = normalizedAiImageDesc.length >= 20;
                    const explicitImageIntent = this.hasExplicitImageSendIntent(aiResponse);
                    const shouldGenerateImage = explicitImageIntent && hasAiImageDesc && !!aiResponse;

                    // 一体化生成
                    const aiMessages = this.generateAIMessages(aiResponse, currentPersona || '')
                        .map(msg => ({
                            ...msg,
                            content: this.ensureNonEmptyAiText(msg.content)
                        }))
                        .filter(msg => !!String(msg.content || '').trim());
                    const aiBase = Date.now().toString();
                    const aiMessagePayloads = (aiMessages.length > 0 ? aiMessages : [{ content: this.ensureNonEmptyAiText(aiResponse), isVoice: false }]).map((aiMsg, index) => ({
                        ...aiMsg,
                        content: this.ensureNonEmptyAiText(aiMsg.content),
                        id: `ai-${aiBase}-${index}-${Math.random().toString(36).slice(2, 6)}`
                    }));
                    const extraImagePayloads = [];

                    for (const aiMsg of aiMessagePayloads) {
                        // 只在不是当前聊天页面时才弹出通知横幅
                        if (currentFriend) {
                            // 检查是否在当前好友的聊天页面
                            const isChatActive = chatModal && chatModal.style.display !== 'none' && this.currentFriendId === targetFriendId;

                            // 如果不在当前聊天页面，才显示通知
                            if (!isChatActive) {
                                const notifText = aiMsg.isVoice ? '[语音]' : aiMsg.content;
                                const friendForNotif = currentFriend;
                                showMsgNotification(
                                    friendForNotif.name,
                                    notifText,
                                    friendForNotif.avatar || '',
                                    () => {
                                        if (chatSession) chatSession.openChatWithFriend(friendForNotif);
                                    }
                                );
                            }
                        }

                        this.addMessageToChat(aiMsg.content, 'ai', aiMsg.isVoice, aiMsg.id, '', '', '', '', targetFriendId);
                        if (targetFriendId) {
                            chatHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }

                        // ===== 真人打字节奏模拟 =====
                        // 基础延迟 + 字数延迟 + 随机抖动
                        const baseDelay = 300; // 基础延迟 (ms)
                        const charDelay = aiMsg.content.length * 20; // 每个字平均20ms
                        const randomJitter = Math.random() * 200 - 100; // -100 到 +100ms 的随机波动
                        const totalDelay = Math.max(250, baseDelay + charDelay + randomJitter);

                        await new Promise(resolve => setTimeout(resolve, totalDelay));
                    }

                    // 一体化心声存储与刷新（一次API调用同时生成）
                    // 成功才保存，只渲染有效的
                    if (heartVoiceData && heartVoiceSystem && targetFriendId) {
                        const heartVoiceText = String(heartVoiceData.heart_voice || '').trim();
                        const heartDemeanor = String(heartVoiceData.demeanor || '').trim();
                        let moodValue = Number(heartVoiceData.mood_value);

                        // 如果 moodValue 是 NaN，设置为默认值 50
                        if (!Number.isFinite(moodValue)) {
                            moodValue = 50;
                        }

                        console.log('[一体化生成] 心声数据检验:', {
                            friendId: targetFriendId,
                            hasVoice: !!heartVoiceText,
                            voiceLen: heartVoiceText.length,
                            hasDemeanor: !!heartDemeanor,
                            demeanorLen: heartDemeanor.length,
                            mood: moodValue
                        });

                        // 严格验证：只有同时满足以下条件才保存：
                        // 1. 心声非空且长度 >= 6（防止极短无效内容）
                        // 2. 心情值有效（有限的数字）
                        // 3. 选项：神态可以为空（但如果有必须 >= 4字符）
                        const isValidVoice = heartVoiceText.length >= 6;
                        const isValidMood = Number.isFinite(moodValue);
                        const isValidDemeanor = !heartDemeanor || heartDemeanor.length >= 4;

                        if (isValidVoice && isValidMood && isValidDemeanor) {
                            const oldData = heartVoiceSystem.getData(targetFriendId) || {};
                            const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];

                            // 防止高度相似的重复：只检查心声本身的相似度（不包括神态）
                            const lastEntry = oldHistory.length > 0 ? oldHistory[oldHistory.length - 1] : null;

                            let shouldUpdate = true;
                            let updateReason = '新心声';

                            if (lastEntry) {
                                // 完全相同检查（最严格）
                                if (lastEntry.voice === heartVoiceText) {
                                    shouldUpdate = false;
                                    updateReason = '心声完全相同';
                                } else {
                                    // 只检查心声的相似度（不检查神态），要求 > 0.95（95%）才认为不更新
                                    const voiceSimilarity = this.calculateTextSimilarity(heartVoiceText, lastEntry.voice);

                                    console.log('[心声相似度检查]', {
                                        voiceSimilarity: (voiceSimilarity * 100).toFixed(1) + '%',
                                        threshold: '50%'
                                    });

                                    if (voiceSimilarity > 0.80) {
                                        shouldUpdate = false;
                                        updateReason = `心声极度相似（${(voiceSimilarity * 100).toFixed(0)}%）`;
                                    }
                                }
                            }

                            if (shouldUpdate) {
                                const newData = {
                                    lastUpdate: Date.now(),
                                    voice: heartVoiceText,
                                    status: '',
                                    demeanor: heartDemeanor,
                                    mood: Math.max(-100, Math.min(200, Math.round(moodValue))),
                                    history: [...oldHistory, {
                                        time: Date.now(),
                                        voice: heartVoiceText,
                                        demeanor: heartDemeanor,
                                        mood: Math.max(-100, Math.min(200, Math.round(moodValue)))
                                    }].slice(-15)
                                };
                                heartVoiceSystem.saveData(targetFriendId, newData);
                                console.log('[一体化生成] 心声已保存（通过有效性检验）', {
                                    savedMood: newData.mood,
                                    savedVoice: newData.voice.substring(0, 20),
                                    savedDemeanor: newData.demeanor.substring(0, 20)
                                });
                            } else {
                                console.log(`[一体化生成] 心声未保存（${updateReason}，保留上一条）`);
                            }

                            // 心声面板打开时立即刷新
                            if (document.querySelector('.heart-voice-popup.is-open')) {
                                heartVoiceSystem.render(targetFriendId);
                            }
                        } else {
                            console.log('[一体化生成] 心声未保存（未通过有效性检验）', {
                                isValidVoice,
                                isValidMood,
                                isValidDemeanor,
                                moodValue
                            });
                        }
                    }

                    if (shouldGenerateImage) {
                        let imageText = normalizedAiImageDesc;
                        console.log('[图片描述] 使用AI生成描述，长度:', imageText.length);
                        // ===== 防护：严格验证内容有效性，不发送不足的内容 =====
                        if (imageText && imageText.trim().length >= 20) {
                            const imageId = `ai-img-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
                            const imageData = typeof getImageDescPlaceholderData === 'function'
                                ? getImageDescPlaceholderData()
                                : '';
                            const imageType = '描述图';
                            this.addMessageToChat(imageText, 'ai', false, imageId, '', '', imageData, imageType, targetFriendId);
                            if (targetFriendId) {
                                const imagePayload = {
                                    role: 'assistant',
                                    content: imageText,
                                    isVoice: false,
                                    id: imageId,
                                    imageData: imageData,
                                    imageName: imageType,
                                    imageText: imageText,
                                    timestamp: Date.now()
                                };
                                chatHistory.push(imagePayload);
                                extraImagePayloads.push(imagePayload);
                            }
                            this.markImageShareSent(targetFriendId);
                        }
                    }

                    if (targetFriendId && this.friendSystem) {
                        // 更新真实历史记录
                        const realHistory = this.friendSystem.getFriendChatHistory(targetFriendId);

                        console.log(`[AI回复] 保存到好友 ${targetFriendId} - AI消息数: ${aiMessagePayloads.length}, 图片数: ${extraImagePayloads.length}`);

                        // 1. 标记已回复
                        pendingMessages.forEach(pm => {
                            const match = realHistory.find(m => m.id === pm.id);
                            if (match) match.isReplied = true;
                        });

                        // 2. 追加 AI 回复
                        for (const aiMsg of aiMessagePayloads) {
                            realHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                        }
                        if (extraImagePayloads.length > 0) {
                            extraImagePayloads.forEach(payload => {
                                realHistory.push({ ...payload });
                            });
                        }

                        this.friendSystem.saveFriendChatHistory(targetFriendId, realHistory);

                        // AI回复完成后统一刷新好友列表
                        if (typeof window.updateFriendList === 'function') {
                            window.updateFriendList();
                        }

                        // ===== 自动总结检测 =====
                        if (window.summarySystem) {
                            try { window.summarySystem.checkAutoSummary(targetFriendId, realHistory, config); } catch (e) { console.warn('[自动总结] 检测异常:', e); }
                        }
                    }

                    // 心声已由本次API返回，避免二次请求
                } catch (error) {
                    console.error('发送消息失败:', error);
                    this.stopHeartVoicePulse();  // 错误时也停止脉动

                    // 【只处理真正的HTTP/网络错误】
                    // 只有请求失败（网络错误、状态码错误）时才显示错误弹窗
                    if (error.message && error.message.includes('请求失败:')) {
                        const errorCode = error.message.replace('请求失败:', '').trim();
                        showCustomErrorModal(errorCode);  // 显示HTTP错误码
                    } else if (error.statusCode) {
                        showCustomErrorModal(error.statusCode.toString());
                    }
                    // 其他错误（解析错误等）只在控制台显示，不打断用户体验
                    // 不生成备用心声，保持之前的心声显示
                } finally {
                    this.isProcessing = false;
                }
            }

            getCurrentFriendId() {
                return this.currentFriendId;
            }

            setCurrentFriendId(id) {
                this.currentFriendId = id || null;
            }
        }
        // ========== 事件监听器绑定 ==========

        // 模型选择器交互（自定义下拉）
        if (modelPickerButton && modelPickerList) {
            modelPickerButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (modelPickerButton.disabled) return;
                modelPickerList.classList.toggle('is-open');
            });

            document.addEventListener('click', (e) => {
                if (!modelPickerList.classList.contains('is-open')) return;
                const target = e.target;
                if (target === modelPickerButton || modelPickerList.contains(target)) {
                    return;
                }
                modelPickerList.classList.remove('is-open');
            });
        }

        // 聊天相关按钮
        sendMessageBtn.addEventListener('click', () => chatSession && chatSession.sendMessage());
        if (triggerAiBtn) triggerAiBtn.addEventListener('click', () => chatSession && chatSession.triggerAI(null, true));

        function closeChatExtraPanel() {
            if (!chatExtraPanel) return;
            chatExtraPanel.classList.remove('is-open');
            chatExtraPanel.setAttribute('aria-hidden', 'true');
            if (chatPlusBtn) chatPlusBtn.setAttribute('aria-expanded', 'false');
            if (chatInputAreaWrap) chatInputAreaWrap.classList.remove('chat-extra-open');
            if (chatInputRow) chatInputRow.style.display = 'flex';
        }

        if (chatPlusBtn && chatExtraPanel) {
            chatPlusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = chatExtraPanel.classList.toggle('is-open');
                chatExtraPanel.setAttribute('aria-hidden', String(!isOpen));
                chatPlusBtn.setAttribute('aria-expanded', String(isOpen));
                if (chatInputAreaWrap) {
                    chatInputAreaWrap.classList.toggle('chat-extra-open', isOpen);
                }
                if (chatInputRow) {
                    chatInputRow.style.display = isOpen ? 'none' : 'flex';
                }
            });
        }

        document.addEventListener('click', (e) => {
            if (!chatExtraPanel || !chatExtraPanel.classList.contains('is-open')) return;
            const target = e.target;
            if (chatExtraPanel.contains(target)) return;
            if (chatPlusBtn && chatPlusBtn.contains(target)) return;
            closeChatExtraPanel();
        });

        // 总结按钮
        const chatSummaryBtn = document.getElementById('chatSummaryBtn');
        if (chatSummaryBtn) {
            chatSummaryBtn.addEventListener('click', () => {
                closeChatExtraPanel();
                const fid = chatSession ? chatSession.getCurrentFriendId() : null;
                const summaryModal = document.getElementById('summaryModal');
                if (summaryModal) {
                    if (fid) summaryModal.dataset.friendId = fid;
                    summaryModal.style.display = 'flex';
                }
            });
        }

        // 语音输入相关
        const voiceModal = document.getElementById('voiceModal');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const closeVoiceModal = document.getElementById('closeVoiceModal');
        const cancelVoiceInput = document.getElementById('cancelVoiceInput');
        const confirmVoiceInput = document.getElementById('confirmVoiceInput');
        const voiceText = document.getElementById('voiceText');
        const cameraInputBtn = document.getElementById('cameraInputBtn');
        const cameraDescModal = document.getElementById('cameraDescModal');
        const closeCameraDescModal = document.getElementById('closeCameraDescModal');
        const cancelCameraDesc = document.getElementById('cancelCameraDesc');
        const confirmCameraDesc = document.getElementById('confirmCameraDesc');
        const cameraDescText = document.getElementById('cameraDescText');
        const imageDescModal = document.getElementById('imageDescModal');
        const closeImageDescModal = document.getElementById('closeImageDescModal');
        const imageDescText = document.getElementById('imageDescText');
        let pendingImageDesc = null;

        voiceInputBtn.addEventListener('click', () => {
            voiceText.value = '';
            voiceModal.style.display = 'flex';
            voiceText.focus();
        });

        closeVoiceModal.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });

        cancelVoiceInput.addEventListener('click', () => {
            voiceModal.style.display = 'none';
        });

        confirmVoiceInput.addEventListener('click', () => {
            const message = voiceText.value.trim();
            if (message) {
                chatInput.value = message;
                chatInput.dataset.isVoice = 'true';
                voiceModal.style.display = 'none';
                if (chatSession) chatSession.sendMessage();
            }
        });

        // 点击模态框背景关闭
        voiceModal.addEventListener('click', (e) => {
            if (e.target === voiceModal) {
                voiceModal.style.display = 'none';
            }
        });
        function getImageDescPlaceholderData() {
            const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f3f3f5"/>
      <stop offset="1" stop-color="#e7e7eb"/>
    </linearGradient>
  </defs>
  <rect width="240" height="240" rx="24" fill="url(#g)"/>
  <circle cx="80" cy="90" r="26" fill="#d7d7de"/>
  <path d="M40 180 L110 120 L150 160 L200 120 L220 180 Z" fill="#d0d0d8"/>
</svg>`;
            return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
        }

        if (cameraInputBtn && cameraDescModal) {
            cameraInputBtn.addEventListener('click', () => {
                if (cameraDescText) cameraDescText.value = '';
                cameraDescModal.style.display = 'flex';
                if (cameraDescText) cameraDescText.focus();
            });
        }

        if (closeCameraDescModal) {
            closeCameraDescModal.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (cancelCameraDesc) {
            cancelCameraDesc.addEventListener('click', () => {
                cameraDescModal.style.display = 'none';
            });
        }

        if (confirmCameraDesc) {
            confirmCameraDesc.addEventListener('click', () => {
                const desc = cameraDescText ? cameraDescText.value.trim() : '';
                if (!desc) return;
                chatInput.value = desc;
                chatInput.dataset.imageData = getImageDescPlaceholderData();
                chatInput.dataset.imageName = '描述图';
                chatInput.dataset.imageText = desc;
                chatInput.dataset.isVoice = 'false';
                if (chatSession) chatSession.sendMessage();
                cameraDescModal.style.display = 'none';
            });
        }

        if (cameraDescModal) {
            cameraDescModal.addEventListener('click', (e) => {
                if (e.target === cameraDescModal) {
                    cameraDescModal.style.display = 'none';
                }
            });
        }

        function closeImageDesc() {
            if (!imageDescModal) return;
            imageDescModal.style.display = 'none';
            pendingImageDesc = null;
        }

        // 图片描述弹窗确定按钮
        const imageDescOkBtn = document.getElementById('imageDescOkBtn');
        if (imageDescOkBtn) {
            imageDescOkBtn.addEventListener('click', closeImageDesc);
        }

        window.openImageDescModal = (messageWrapper, msgId, content) => {
            if (!imageDescModal || !imageDescText) return;
            // 使用 textContent 而不是 value，确保保留分行和格式
            imageDescText.textContent = content || '';
            pendingImageDesc = { messageWrapper, msgId };
            imageDescModal.style.display = 'flex';
        };

        if (closeImageDescModal) {
            closeImageDescModal.addEventListener('click', closeImageDesc);
        }

        if (imageDescModal) {
            imageDescModal.addEventListener('click', (e) => {
                if (e.target === imageDescModal) {
                    closeImageDesc();
                }
            });
        }
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (chatSession) chatSession.sendMessage();
            }
        });

        // ========== 初始化 ==========

        const appCatalog = [
            { id: 'message', name: '消息', iconClass: 'fa-envelope', styleClass: 'message-icon' },
            { id: 'feixin', name: '甜聊', iconClass: 'fa-comment-dots', styleClass: 'feixin-icon' },
            { id: 'worldbook', name: '创世书', iconClass: 'fa-book-open', styleClass: 'book-icon' },
            { id: 'settings', name: '设置', iconClass: 'fa-cog', styleClass: 'settings-icon' },
            { id: 'beautify', name: '美化', iconClass: 'fa-paint-brush', styleClass: 'brush-icon' },
            { id: 'phone', name: '手机', iconClass: 'fa-mobile-alt', styleClass: 'phone-icon' },
            { id: 'novel', name: '小说', iconClass: 'fa-book', styleClass: 'novel-icon' },
            { id: 'forum', name: '论坛', iconClass: 'fa-comments', styleClass: 'forum-icon' }
        ];

        function renderHomeApps() {
            if (!appGrid) return;
            const selected = APP_ENTRY_POINTS.home || [];
            appGrid.innerHTML = '';
            selected.forEach(appId => {
                const app = appCatalog.find(item => item.id === appId);
                if (!app) return;

                const item = document.createElement('div');
                item.className = 'app-item';
                item.dataset.appId = app.id;

                const icon = document.createElement('div');
                icon.className = `app-icon ${app.styleClass}`;
                icon.innerHTML = `<i class="fas ${app.iconClass}"></i>`;

                const name = document.createElement('div');
                name.className = 'app-name';
                name.textContent = app.name;

                item.appendChild(icon);
                item.appendChild(name);

                item.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });

                item.addEventListener('click', () => {
                    handleAppClick(app.id);
                });

                appGrid.appendChild(item);
            });
        }

        function registerApps() {
            if (!window.appManager || typeof window.appManager.register !== 'function') return;
            appCatalog.forEach(app => {
                try {
                    window.appManager.register(app.id, {
                        name: app.name,
                        icon: app.iconClass,
                        version: '1.0.0'
                    });
                } catch (e) {
                    // 已注册时忽略
                }
            });
        }

        // ========== 隐藏状态栏功能 ==========
        function initHideStatusBar() {
            const hideStatusBarToggle = document.getElementById('hideStatusBarToggle');
            if (!hideStatusBarToggle) return;

            // 从 localStorage 读取状态
            const isHidden = localStorage.getItem('hideStatusBar') === 'true';
            hideStatusBarToggle.checked = isHidden;

            // 应用初始状态
            if (isHidden) {
                document.body.classList.add('hide-status-bar');
            }

            // 监听开关变化
            hideStatusBarToggle.addEventListener('change', (e) => {
                const checked = e.target.checked;
                localStorage.setItem('hideStatusBar', checked);

                if (checked) {
                    document.body.classList.add('hide-status-bar');
                } else {
                    document.body.classList.remove('hide-status-bar');
                }
            });

            // 动态更新顶部栏高度
            function updateHeaderHeight() {
                const hasHideClass = document.body.classList.contains('hide-status-bar');
                const rootStyles = getComputedStyle(document.documentElement);
                const safeAreaTop = parseFloat(rootStyles.getPropertyValue('padding-top')) || 0;
                const baseHeight = hasHideClass ? 38 : 48;
                const actualHeight = baseHeight + safeAreaTop;

                document.documentElement.style.setProperty('--header-actual-height', `${actualHeight}px`);
                const currentHeaderVar = hasHideClass ? 'var(--header-height-hidden)' : 'var(--header-height-normal)';
                document.documentElement.style.setProperty('--content-offset-top', currentHeaderVar);

                console.log(`[顶部栏] 高度已更新: ${actualHeight}px (基础: ${baseHeight}px + 安全区: ${safeAreaTop}px)`);
            }

            // 监听body class变化
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        updateHeaderHeight();
                    }
                });
            });

            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class']
            });

            updateHeaderHeight();
        }

        // ========== 记忆对话条数配置 ==========
        function initMemoryChatCount() {
            const memoryChatCountInput = document.getElementById('memoryChatCountInput');
            if (!memoryChatCountInput) return;

            // 获取保存的配置
            const config = apiService ? apiService.getConfig() : {};
            const savedCount = config.memoryChatCount || 50;

            // 设置输入框的值
            memoryChatCountInput.value = savedCount;

            // 监听输入框变化，自动保存
            memoryChatCountInput.addEventListener('change', (e) => {
                const value = Math.max(1, Math.min(999, parseInt(e.target.value) || 35));
                memoryChatCountInput.value = value;

                // 保存到配置
                if (apiService) {
                    const currentConfig = apiService.getConfig();
                    currentConfig.memoryChatCount = value;
                    apiService.saveConfig(currentConfig);
                    console.log(`[记忆配置] 已保存对话条数: ${value}`);
                }
            });

            // 输入时也实时验证
            memoryChatCountInput.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value && parseInt(value) < 1) {
                    memoryChatCountInput.value = '1';
                } else if (value && parseInt(value) > 999) {
                    memoryChatCountInput.value = '999';
                }
            });
        }

        // ========== AI调取内容接口 ==========
        /**
         * AI获取已挂载内容的统一接口
         * @param {string} type - 内容类型，可选值：'WORLD_BOOK' | 'HTML_GAME'
         * @param {string|number} id - 内容ID
         * @returns {object} 返回内容对象，包含id、title、content、isMounted等字段；若未找到返回null
         */
        window.aiGetContent = function (type, id) {
            const typeUpper = String(type).toUpperCase();
            const idStr = String(id);

            if (typeUpper === 'WORLD_BOOK') {
                if (!window.worldBookSystem) return null;
                const book = window.worldBookSystem.getBook(parseInt(idStr));
                if (!book) return null;
                return {
                    id: book.id,
                    title: book.title || '',
                    content: book.content || '',
                    type: 'WORLD_BOOK',
                    createdAt: book.createdAt || ''
                };
            } else if (typeUpper === 'HTML_GAME') {
                if (!window.htmlGameSystem) return null;
                const game = window.htmlGameSystem.getGame(parseInt(idStr));
                if (!game) return null;
                return {
                    id: game.id,
                    title: game.title || '',
                    content: game.content || '',
                    type: 'HTML_GAME',
                    createdAt: game.createdAt || ''
                };
            }
            return null;
        };

        /**
         * AI获取当前聊天对象已挂载的所有世界书和HTML游戏
         * @param {string|number} friendId - 好友ID
         * @returns {object} 返回 {worldBooks: [], htmlGames: []} 的对象
         */
        window.aiGetMountedContent = function (friendId) {
            const result = {
                worldBooks: [],
                htmlGames: []
            };

            if (!friendSystem) return result;
            const friend = friendSystem.getFriendById(friendId);
            if (!friend) return result;

            // 获取已挂载的世界书
            if (Array.isArray(friend.mountedWorldBooks) && window.worldBookSystem) {
                friend.mountedWorldBooks.forEach(bookId => {
                    const book = window.worldBookSystem.getBook(parseInt(bookId));
                    if (book) {
                        result.worldBooks.push({
                            id: book.id,
                            title: book.title || '',
                            content: book.content || ''
                        });
                    }
                });
            }

            // 获取已挂载的HTML游戏
            if (Array.isArray(friend.mountedHtmlGames) && window.htmlGameSystem) {
                friend.mountedHtmlGames.forEach(gameId => {
                    const game = window.htmlGameSystem.getGame(parseInt(gameId));
                    if (game) {
                        result.htmlGames.push({
                            id: game.id,
                            title: game.title || '',
                            content: game.content || ''
                        });
                    }
                });
            }

            return result;
        };

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化UI管理器（最优先）
            UIManager.init();
            // 暴露到全局，方便其他模块使用
            window.UIManager = UIManager;

            // 提示用户可以使用UI测试功能
            console.log('%c🎨 UI组件系统已就绪！', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
            console.log('%c💡 在控制台输入 UIManager.showUIDemo() 查看所有UI组件示例', 'color: #2196F3; font-size: 14px;');
            console.log('%c📚 支持的组件: 按钮、输入框、卡片、列表、桌面图标 + 永久保持状态栏格式', 'color: #FF9800; font-size: 12px;');

            friendSystem = new FriendSystem();
            apiService = new ApiService(friendSystem);
            // 将apiService暴露给总结系统使用
            window.summarySystemApiService = apiService;
            chatSession = new ChatSession(friendSystem, apiService);
            heartVoiceSystem = new HeartVoiceSystem(friendSystem, apiService);
            profileWidget = new ProfileWidget();
            window.worldBookSystem = new WorldBookSystem();
            window.htmlGameSystem = new HtmlGameSystem();

            // ========== 事件监听器绑定（必须在apiService初始化之后）==========

            // API相关按钮
            fetchModelsBtn.addEventListener('click', () => apiService && apiService.fetchModels());
            saveApiBtn.addEventListener('click', () => apiService && apiService.saveConfiguration());

            // API预设管理
            const savePresetBtn = document.getElementById('savePreset');
            const presetNameInput = document.getElementById('presetName');
            if (savePresetBtn && apiService) {
                savePresetBtn.addEventListener('click', () => {
                    const name = presetNameInput.value.trim();
                    if (!name) {
                        apiService.showApiStatus('请输入预设名称', 'error');
                        return;
                    }

                    const currentConfig = {
                        apiUrl: apiUrlInput.value.trim(),
                        apiKey: apiKeyInput.value.trim(),
                        model: modelSelect.value
                    };

                    if (!currentConfig.apiUrl || !currentConfig.apiKey) {
                        apiService.showApiStatus('请先配置API地址和密钥', 'error');
                        return;
                    }

                    apiService.savePreset(name, currentConfig);
                    apiService.showApiStatus(`已保存预设: ${name}`, 'success');
                    presetNameInput.value = '';
                    apiService.renderPresetList();
                });
            }

            // 初始化预设列表
            if (apiService) {
                apiService.renderPresetList();
            }

            // 绑定API预设弹窗关闭按钮
            const closeApiPresetModalBtn = document.getElementById('closeApiPresetModal');
            if (closeApiPresetModalBtn) {
                closeApiPresetModalBtn.addEventListener('click', () => {
                    const modal = document.getElementById('apiPresetModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            }

            // 点击弹窗外部关闭
            const apiPresetModal = document.getElementById('apiPresetModal');
            if (apiPresetModal) {
                apiPresetModal.addEventListener('click', (e) => {
                    if (e.target === apiPresetModal) {
                        apiPresetModal.style.display = 'none';
                    }
                });
            }

            registerApps();
            renderHomeApps();
            if (window.appManager && typeof window.appManager.setStatus === 'function') {
                window.appManager.setStatus({
                    signal: 'fa-signal',
                    wifi: 'fa-wifi',
                    battery: 'fa-battery-three-quarters'
                });
            }
            if (friendSystem) {
                friendSystem.init();
            }

            // 页面卸载时清理定时器，防止内存泄漏
            window.addEventListener('beforeunload', () => {
                if (friendSystem && typeof friendSystem.destroy === 'function') {
                    friendSystem.destroy();
                }
            });

            // ========== 虚拟键盘自适应功能 ==========
            // 使用 visualViewport API 动态调整容器高度，确保键盘弹出时输入框始终可见
            (function () {
                const chatModalContent = document.querySelector('#chatModal .modal-content');
                if (!chatModalContent) return;

                function adjustForKeyboard() {
                    if (!window.visualViewport) return;
                    const vv = window.visualViewport;
                    // 计算键盘+浏览器配件栏占据的高度
                    const keyboardHeight = window.innerHeight - vv.height;

                    if (keyboardHeight > 50 && document.activeElement &&
                        (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT')) {
                        // 键盘弹出：把容器高度缩小到可视区域
                        chatModalContent.style.height = vv.height + 'px';
                        chatModalContent.style.maxHeight = vv.height + 'px';
                        // 滚动消息到底部
                        if (chatMessages) {
                            requestAnimationFrame(() => {
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            });
                        }
                    } else {
                        // 键盘收起：恢复原始高度
                        chatModalContent.style.height = '';
                        chatModalContent.style.maxHeight = '';
                    }
                }

                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', adjustForKeyboard);
                    window.visualViewport.addEventListener('scroll', adjustForKeyboard);
                }

                // 焦点事件作为补充（处理 visualViewport 不支持的情况）
                if (chatInput) {
                    chatInput.addEventListener('focus', () => {
                        // 延迟等待键盘完全弹出
                        setTimeout(adjustForKeyboard, 150);
                        setTimeout(adjustForKeyboard, 400);
                        setTimeout(() => {
                            if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 500);
                    });
                    chatInput.addEventListener('blur', () => {
                        setTimeout(() => {
                            chatModalContent.style.height = '';
                            chatModalContent.style.maxHeight = '';
                        }, 100);
                    });
                }
            })();
            // ========== 虚拟键盘自适应功能结束 ==========
            if (apiService) apiService.updateSettingsDisplay();
            if (profileWidget) profileWidget.init();

            // 初始化隐藏状态栏功能
            initHideStatusBar();

            // 初始化记忆对话条数配置
            initMemoryChatCount();

            // 为所有图标添加悬停效果
            const allIcons = document.querySelectorAll('.app-icon, .dock-icon, .left-icon, .app-item');
            allIcons.forEach(icon => {
                icon.addEventListener('mousedown', () => {
                    icon.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        icon.style.transform = '';
                    }, 150);
                });
            });

            // 加载已保存的模型列表
            if (apiService) {
                const config = apiService.getConfig();
                if (config.models && config.models.length > 0) {
                    apiService.updateModelSelect(config.models);
                }
            }
        });
        }) ();
    </script>

    <!-- Custom Error Modal -->
    <div id="customErrorModal" class="modal" style="display: none; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content"
            style="width: 90%; max-width: 320px; border-radius: 18px; padding: 28px; text-align: center; background-color: #fff; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 12px; line-height: 1.4;">出现错误：
            </h3>
            <p id="customApiErrorText"
                style="font-size: 14px; color: #666; margin-bottom: 28px; word-break: break-word; line-height: 1.5; min-height: 40px;">
            </p>
            <button id="customErrorOkButton" class="btn btn-primary"
                style="width: 100%; height: 44px; border-radius: 12px;">确定</button>
        </div>
    </div>

    <!-- 世界书 Modal Start -->
    <div id="worldbookModal" class="modal" style="display: none;">
        <div id="worldbookMainPage" class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="worldbookBack" class="settings-back"
                    onclick="document.getElementById('worldbookModal').style.display='none'">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">创世书</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll" style="padding: 20px 16px; display: flex; flex-direction: column;">
                <!-- 世界书和游戏按钮区域 -->
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 24px; padding: 0 12px;">
                    <div id="worldbookBtn" class="worldbook-button" style="background-color: #F2EBF5;">
                        <div class="worldbook-icon">
                            <i class="fas fa-book" style="font-size: 28px;"></i>
                        </div>
                        <span>世界书</span>
                    </div>
                    <div id="htmlGameBtn" class="worldbook-button" style="background-color: #EAE4F2;">
                        <div class="worldbook-icon">
                            <i class="fas fa-gamepad" style="font-size: 28px;"></i>
                        </div>
                        <span>HTML 游戏</span>
                    </div>
                </div>
                <!-- 提示语区域 -->
                <div style="text-align: center; margin-top: 28px; line-height: 1.7;">
                    <p style="font-size: 13px; color: #888; font-weight: 500;">世界书挂载越少越好</p>
                    <p style="font-size: 13px; color: #b0b0b0; font-weight: 500;">小游戏不玩时别挂载</p>
                </div>
                <!-- 底部留白 -->
                <div style="flex: 1;"></div>
            </div>
        </div>

        <!-- 世界书列表页面 -->
        <div id="worldbookListPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="wbListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="wbListStatusSignal" class="fas fa-signal"></i>
                    <i id="wbListStatusWifi" class="fas fa-wifi"></i>
                    <i id="wbListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="wbListBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">世界书</div>
                <button id="wbAddNewBtn" class="settings-back" style="width: 42px; padding: 8px 10px;">
                    <i class="fas fa-plus" style="font-size: 18px; color: #888;"></i>
                </button>
            </div>
            <!-- 内容区域 -->
            <div class="settings-scroll" style="flex: 1;">
                <!-- 提示条 -->
                <div class="page-hint">别挂太多哦</div>
                <!-- 世界书列表 -->
                <div id="wbListContainer" class="page-content-list">
                    <!-- 世界书卡片将动态插入 -->
                </div>
            </div>
        </div>

        <!-- 世界书编辑页面 -->
        <div id="worldbookEditPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="wbEditStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="wbEditStatusSignal" class="fas fa-signal"></i>
                    <i id="wbEditStatusWifi" class="fas fa-wifi"></i>
                    <i id="wbEditStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="wbEditBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="wbEditTitle" class="settings-title">新建世界书</div>
                <span style="width: 42px;"></span>
            </div>
            <!-- 编辑表单 -->
            <div class="settings-scroll" style="flex: 1; display: flex; flex-direction: column; padding: 16px;">
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: #787785; margin-bottom: 6px;">标题</label>
                    <input id="wbEditTitleInput" type="text" placeholder="输入世界书标题"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333;">
                </div>
                <div style="margin-bottom: 12px; flex: 1; display: flex; flex-direction: column;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: #787785; margin-bottom: 6px;">内容</label>
                    <textarea id="wbEditContentInput" placeholder="输入世界书内容"
                        style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333; resize: none; font-family: inherit;"></textarea>
                </div>
            </div>
            <!-- 保存按钮 -->
            <div style="padding: 16px; display: flex; justify-content: center;">
                <button id="wbSaveBtn" class="wb-glass-btn"
                    style="width: 100%; max-width: 200px; padding: 12px 24px; font-size: 16px; font-weight: 600; color: #fff; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%), rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6);">
                    保存
                </button>
            </div>
        </div>

        <!-- HTML游戏列表页面 -->
        <div id="htmlGameListPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="hgListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="hgListStatusSignal" class="fas fa-signal"></i>
                    <i id="hgListStatusWifi" class="fas fa-wifi"></i>
                    <i id="hgListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="hgListBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">HTML 游戏</div>
                <button id="hgAddNewBtn" class="settings-back" style="width: 42px; padding: 8px 10px;">
                    <i class="fas fa-plus" style="font-size: 18px; color: #888;"></i>
                </button>
            </div>
            <!-- 内容区域 -->
            <div class="settings-scroll" style="flex: 1;">
                <!-- 提示条 -->
                <div class="page-hint">不玩时请取消挂载</div>
                <!-- HTML游戏列表 -->
                <div id="hgListContainer" class="page-content-list">
                    <!-- HTML游戏卡片将动态插入 -->
                </div>
            </div>
        </div>

        <!-- HTML游戏编辑页面 -->
        <div id="htmlGameEditPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="hgEditStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="hgEditStatusSignal" class="fas fa-signal"></i>
                    <i id="hgEditStatusWifi" class="fas fa-wifi"></i>
                    <i id="hgEditStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="hgEditBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="hgEditTitle" class="settings-title">新建HTML游戏</div>
                <span style="width: 42px;"></span>
            </div>
            <!-- 编辑表单 -->
            <div class="settings-scroll" style="flex: 1; display: flex; flex-direction: column; padding: 16px;">
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: #787785; margin-bottom: 6px;">标题</label>
                    <input id="hgEditTitleInput" type="text" placeholder="输入游戏名称"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333;">
                </div>
                <div style="margin-bottom: 12px; flex: 1; display: flex; flex-direction: column;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: #787785; margin-bottom: 6px;">HTML
                        代码</label>
                    <textarea id="hgEditContentInput" placeholder="输入HTML代码"
                        style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333; resize: none; font-family: 'Courier New', monospace; line-height: 1.5;"></textarea>
                </div>
            </div>
            <!-- 保存按钮 -->
            <div style="padding: 16px; display: flex; justify-content: center;">
                <button id="hgSaveBtn" class="hg-glass-btn"
                    style="width: 100%; max-width: 200px; padding: 12px 24px; font-size: 16px; font-weight: 600; color: #fff; background: linear-gradient(135deg, #f0d6d7 0%, #f0d6d7 100%), rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6);">
                    保存
                </button>
            </div>
        </div>
    </div>
    <!-- 世界书 Modal End -->

    <!-- 总结全屏页面 -->
    <div class="modal" id="summaryModal" style="display: none;">
        <div class="settings-screen" style="display: flex; flex-direction: column; position: relative;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="summaryBack" class="settings-back"
                    onclick="document.getElementById('summaryModal').style.display='none'">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">总结</div>
                <button id="summaryHeartBtn"
                    style="background: none; border: none; font-size: 18px; color: #f0d6d7; cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                    aria-label="一锫">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="settings-scroll" style="flex: 1; padding: 20px 16px;">
                <!-- 自动总结轮数设置 -->
                <div
                    style="background: #fff; border-radius: 16px; padding: 16px 18px; box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06); display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-size: 15px; font-weight: 600; color: #787785;">自动总结</span>
                        <span style="font-size: 12px; color: #b0b0b0;">每隔指定轮数自动生成总结</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input id="summaryRoundsInput" type="text" value="25"
                            style="width: 48px; height: 32px; text-align: center; border: 1.5px solid #f0e0e0; border-radius: 10px; font-size: 14px; font-weight: 600; color: #787785; background: #faf7fa; outline: none;">
                        <span style="font-size: 13px; color: #b0b0b0; white-space: nowrap;">轮/次</span>
                    </div>
                </div>

                <!-- 大总结按钮 -->
                <div style="display: flex; justify-content: center; margin-top: 24px;">
                    <button id="bigSummaryBtn" type="button"
                        style="padding: 14px 40px; border-radius: 24px; border: none; cursor: pointer; font-size: 15px; font-weight: 600; color: #fff; background: linear-gradient(135deg, #f0d6d7, #e8c4d0); box-shadow: 0 4px 15px rgba(240, 214, 215, 0.4); transition: transform 0.15s ease, box-shadow 0.15s ease; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-book-open" style="font-size: 16px;"></i>
                        大总结
                    </button>
                </div>

                <!-- 小结卡片列表 -->
                <div
                    style="margin-top: 24px; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #b0b0b0; letter-spacing: 0.5px;">
                    小结记录</div>
                <div id="summaryContent" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 小结卡片由 JS 动态渲染 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 大总结全屏页面 -->
    <div class="modal" id="bigSummaryModal" style="display: none;">
        <div class="settings-screen" style="display: flex; flex-direction: column; position: relative;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="bigSummaryBack" class="settings-back"
                    onclick="document.getElementById('bigSummaryModal').style.display='none'">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">大总结</div>
                <button id="bigSummaryHeartBtn"
                    style="background: none; border: none; font-size: 18px; color: #f0d6d7; cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                    aria-label="一锫">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="settings-scroll" style="flex: 1; padding: 20px 16px;">
                <div
                    style="margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #b0b0b0; letter-spacing: 0.5px;">
                    大总结记录</div>
                <div id="bigSummaryContent" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 大总结卡片由 JS 动态渲染 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 总结系统
        (function () {
            // ===== 公共工具函数（需要提前定义） =====
            function makeSummaryId(prefix) {
                return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
            }
            function isSummaryProcessed(item) {
                if (!item || typeof item !== 'object') return false;
                return Boolean(item.processed || item.processedByBigSummaryId);
            }
            function normalizeSmallSummaryItem(item) {
                const normalized = (item && typeof item === 'object') ? { ...item } : {};
                normalized.id = normalized.id || makeSummaryId('sm');
                normalized.text = String(normalized.text || '');
                normalized.time = normalized.time || nowTime();
                if (normalized.processedByBigSummaryId) normalized.processed = true;
                return normalized;
            }
            function normalizeBigSummaryItem(item) {
                const normalized = (item && typeof item === 'object') ? { ...item } : {};
                normalized.id = normalized.id || makeSummaryId('bg');
                normalized.text = String(normalized.text || '');
                normalized.time = normalized.time || nowTime();
                if (!Array.isArray(normalized.sourceSummaryIds)) normalized.sourceSummaryIds = [];
                return normalized;
            }
            function getUnprocessedSmallSummaries(summaries) {
                return summaries
                    .filter(s => !isSummaryProcessed(s))
                    .slice()
                    .reverse();
            }
            const smallSummaryInFlight = new Set();
            const bigSummaryInFlight = new Set();
            const MANUAL_SUMMARY_LOADING_ID = 'manualSummaryLoadingOverlay';
            function ensureManualSummaryLoadingStyle() {
                if (document.getElementById('manualSummaryLoadingStyle')) return;
                const style = document.createElement('style');
                style.id = 'manualSummaryLoadingStyle';
                style.textContent = '@keyframes manualSummarySpin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}';
                document.head.appendChild(style);
            }
            function setManualSummaryLoading(loading) {
                ensureManualSummaryLoadingStyle();
                const old = document.getElementById(MANUAL_SUMMARY_LOADING_ID);
                if (loading) {
                    if (!old) {
                        const overlay = document.createElement('div');
                        overlay.id = MANUAL_SUMMARY_LOADING_ID;
                        overlay.style.cssText = 'position:fixed;top:16px;right:16px;z-index:10000;pointer-events:none;';
                        overlay.innerHTML = '<div style="background:rgba(255,255,255,0.96);backdrop-filter:blur(4px);border:1px solid #f2e4e8;border-radius:999px;padding:10px 14px;box-shadow:0 8px 24px rgba(0,0,0,0.12);display:flex;align-items:center;gap:8px;"><div style="width:14px;height:14px;border:2px solid #f0d6d7;border-top-color:#d9a9b6;border-radius:50%;animation:manualSummarySpin 0.8s linear infinite;flex:0 0 auto;"></div><div style="font-size:12px;color:#666;font-weight:600;white-space:nowrap;">总结生成中...</div></div>';
                        document.body.appendChild(overlay);
                    }
                    if (summaryHeartBtn) {
                        summaryHeartBtn.disabled = true;
                        summaryHeartBtn.style.opacity = '0.6';
                        summaryHeartBtn.style.pointerEvents = 'none';
                    }
                    return;
                }
                if (old) old.remove();
                if (summaryHeartBtn) {
                    summaryHeartBtn.disabled = false;
                    summaryHeartBtn.style.opacity = '';
                    summaryHeartBtn.style.pointerEvents = '';
                }
            }
            function getFriendId() {
                const modal = document.getElementById('summaryModal');
                return modal ? (modal.dataset.friendId || null) : null;
            }
            function getList(key, friendId) {
                try { return JSON.parse(localStorage.getItem(key + friendId)) || []; }
                catch { return []; }
            }
            function saveList(key, friendId, list) {
                localStorage.setItem(key + friendId, JSON.stringify(list));
            }
            function escapeHtml(str) {
                const d = document.createElement('div'); d.textContent = str; return d.innerHTML;
            }
            // 清理推理标签（<think>等）- 用于显示已保存的数据
            function cleanThinkTags(str) {
                if (!str) return '';
                return str
                    .replace(/<think>[\s\S]*?<\/think>/gi, '') // 闭合的<think>标签
                    .replace(/<think>[\s\S]*/gi, '')            // 未闭合的<think>标签（到末尾）
                    .replace(/<\/think>/gi, '')                 // 孤立的</think>
                    .trim();
            }
            function nowTime() {
                const d = new Date();
                return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0') + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            }

            // ===== 渲染函数（需要提前定义） =====
            function renderCards(containerId, storagePrefix, emptyText) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const friendId = getFriendId();
                if (!friendId) { container.innerHTML = ''; return; }
                const list = getList(storagePrefix, friendId);
                if (list.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:40px 0;color:#ccc;font-size:14px;">' + emptyText + '</div>';
                    return;
                }
                container.innerHTML = list.map((item, i) => {
                    const isProcessed = storagePrefix === 'summaries_' && isSummaryProcessed(item);
                    const cleanedText = cleanThinkTags(item.text);
                    return `
                <div class="summary-card${isProcessed ? ' summary-card-processed' : ''}" data-index="${i}">
                    <div class="summary-card-body">${escapeHtml(cleanedText)}</div>
                    <div class="summary-card-footer">
                        <span class="summary-card-time">${item.time || ''}${isProcessed ? ' <i class="fas fa-archive" style="color:#d4c8d0;margin-left:4px;font-size:10px;" title="已归档至大总结"></i>' : ''}</span>
                        <div class="summary-card-actions">
                            <button class="summary-card-btn summary-edit-btn" data-index="${i}" title="编辑"><i class="fas fa-pen"></i></button>
                            <button class="summary-card-btn summary-delete-btn" data-index="${i}" title="删除"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                </div>`;
                }).join('');
            }

            function renderSummaries() { renderCards('summaryContent', 'summaries_', '暂无小结'); }
            function renderBigSummaries() { renderCards('bigSummaryContent', 'bigSummaries_', '暂无大总结'); }

            // ===== 轮数设置 =====
            const ROUNDS_KEY = 'summaryRoundsPerCycle';
            const MAX_ROUNDS = 70;
            const roundsInput = document.getElementById('summaryRoundsInput');
            if (roundsInput) {
                const saved = parseInt(localStorage.getItem(ROUNDS_KEY));
                if (!isNaN(saved) && saved >= 1 && saved <= MAX_ROUNDS) roundsInput.value = saved;
                roundsInput.addEventListener('change', () => {
                    let v = parseInt(roundsInput.value);
                    if (isNaN(v) || v < 1) v = 1;
                    if (v > MAX_ROUNDS) v = MAX_ROUNDS;
                    roundsInput.value = v;
                    localStorage.setItem(ROUNDS_KEY, v);
                });
            }

            // ===== 大总结入口 =====
            const bigSummaryBtn = document.getElementById('bigSummaryBtn');
            if (bigSummaryBtn) {
                bigSummaryBtn.addEventListener('click', () => {
                    const m = document.getElementById('bigSummaryModal');
                    if (m) m.style.display = 'flex';
                    renderBigSummaries();
                });
            }

            // ===== 爱心按钮：手动生成小结 =====
            const summaryHeartBtn = document.getElementById('summaryHeartBtn');
            if (summaryHeartBtn) {
                summaryHeartBtn.addEventListener('click', () => {
                    const friendId = getFriendId();
                    if (!friendId) {
                        showCuteToast('请先选择聊天对象');
                        return;
                    }

                    // 获取当前轮数
                    const count = parseInt(localStorage.getItem('summaryCounter_' + friendId)) || 0;

                    // 弹窗询问
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:300px;">
                    <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;text-align:center;">手动生成小结</h3>
                    <p style="color:#666;font-size:14px;text-align:center;margin:0 0 20px;">当前对话轮数：<strong>${count}</strong></p>
                    <p style="color:#999;font-size:13px;text-align:center;margin:0 0 20px;">是否立即生成本轮小结？</p>
                    <div style="display:flex;gap:8px;justify-content:center;">
                        <button class="cancel-btn" style="padding:10px 24px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;font-weight:600;">取消</button>
                        <button class="confirm-btn" style="padding:10px 24px;border-radius:16px;border:none;background:linear-gradient(135deg,#f0d6d7,#e8c4d0);color:#fff;cursor:pointer;font-weight:600;">确定</button>
                    </div>
                </div>`;

                    document.body.appendChild(overlay);

                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                    });

                    overlay.querySelector('.confirm-btn').addEventListener('click', async () => {
                        document.body.removeChild(overlay);

                        // 优先使用全局apiService，否则从localStorage读取
                        let apiConfig;
                        if (window.summarySystemApiService && typeof window.summarySystemApiService.getConfig === 'function') {
                            apiConfig = window.summarySystemApiService.getConfig();
                        } else {
                            apiConfig = {
                                apiUrl: localStorage.getItem('apiUrl'),
                                apiKey: localStorage.getItem('apiKey'),
                                model: localStorage.getItem('selectedModel')
                            };
                        }

                        if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                            showCuteToast('请先配置API设置');
                            return;
                        }

                        // 从localStorage直接读取聊天记录
                        let chatHistory = [];
                        try { chatHistory = JSON.parse(localStorage.getItem('chat_' + friendId)) || []; } catch (e) { }

                        if (chatHistory.length === 0) {
                            showCuteToast('没有聊天记录可供总结');
                            return;
                        }

                        // 检查是否有有效的对话内容（排除已删除、已撤回和空消息）
                        const validMessages = chatHistory.filter(m => !m.isDeletedLocal && !m.isRecalled && m.content && m.content.trim());

                        if (validMessages.length === 0) {
                            showCuteToast('没有有效的对话内容可供总结');
                            return;
                        }

                        if (validMessages.length < 2) {
                            showCuteToast('对话内容太少，至少需要2条有效消息');
                            return;
                        }

                        await generateAutoSummary(friendId, chatHistory, apiConfig, 'manual');
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) document.body.removeChild(overlay);
                    });
                });
            }

            // ===== 大总结页面爱心按钮：手动生成大总结 =====
            const bigSummaryHeartBtn = document.getElementById('bigSummaryHeartBtn');
            if (bigSummaryHeartBtn) {
                bigSummaryHeartBtn.addEventListener('click', async () => {
                    const friendId = getFriendId();
                    if (!friendId) {
                        showCuteToast('请先选择聊天对象');
                        return;
                    }

                    // 获取未归档的小结数量
                    const summaries = getList('summaries_', friendId);
                    const unprocessedCount = getUnprocessedSmallSummaries(summaries).length;

                    // 弹窗询问
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:300px;">
                    <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;text-align:center;">手动生成大总结</h3>
                    <p style="color:#666;font-size:14px;text-align:center;margin:0 0 20px;">未归档小结数：<strong>${unprocessedCount}</strong></p>
                    <p style="color:#999;font-size:13px;text-align:center;margin:0 0 20px;">是否立即生成大总结？<br><span style="font-size:12px;color:#bbb;">(需要至少5条未归档小结)</span></p>
                    <div style="display:flex;gap:8px;justify-content:center;">
                        <button class="cancel-btn" style="padding:10px 24px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;font-weight:600;">取消</button>
                        <button class="confirm-btn" style="padding:10px 24px;border-radius:16px;border:none;background:linear-gradient(135deg,#f0d6d7,#e8c4d0);color:#fff;cursor:pointer;font-weight:600;">确定</button>
                    </div>
                </div>`;

                    document.body.appendChild(overlay);

                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                    });

                    overlay.querySelector('.confirm-btn').addEventListener('click', async () => {
                        document.body.removeChild(overlay);
                        if (bigSummaryInFlight.has(friendId)) {
                            showCuteToast('大总结正在生成，请稍候');
                            return;
                        }

                        // 检查未归档的小结数量
                        if (unprocessedCount < 5) {
                            showCuteToast('未归档的小结不足5条，无法生成大总结');
                            return;
                        }

                        // 优先使用全局apiService，否则从localStorage读取
                        let apiConfig;
                        if (window.summarySystemApiService && typeof window.summarySystemApiService.getConfig === 'function') {
                            apiConfig = window.summarySystemApiService.getConfig();
                        } else {
                            apiConfig = {
                                apiUrl: localStorage.getItem('apiUrl'),
                                apiKey: localStorage.getItem('apiKey'),
                                model: localStorage.getItem('selectedModel')
                            };
                        }

                        if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                            showCuteToast('请先配置API设置');
                            return;
                        }

                        const summaries = getList('summaries_', friendId);
                        await generateBigSummary(friendId, summaries, apiConfig);
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) document.body.removeChild(overlay);
                    });
                });
            }

            // ===== 通用卡片事件代理（编辑/删除） =====
            function bindCardEvents(containerId, storagePrefix, typeName, renderFn) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.summary-edit-btn');
                    const deleteBtn = e.target.closest('.summary-delete-btn');
                    const friendId = getFriendId();
                    if (!friendId) return;

                    if (editBtn) {
                        const idx = parseInt(editBtn.dataset.index);
                        const list = getList(storagePrefix, friendId);
                        if (!list[idx]) return;
                        const card = editBtn.closest('.summary-card');
                        const body = card.querySelector('.summary-card-body');
                        if (card.querySelector('.summary-edit-area')) return;

                        const textarea = document.createElement('textarea');
                        textarea.className = 'summary-edit-area';
                        textarea.value = list[idx].text;
                        textarea.style.cssText = 'width:100%;min-height:60px;padding:8px 10px;border:1.5px solid #f0d6d7;border-radius:12px;font-size:13px;color:#555;resize:none;font-family:inherit;outline:none;background:#fff;';
                        const btnRow = document.createElement('div');
                        btnRow.style.cssText = 'display:flex;gap:8px;justify-content:flex-end;margin-top:8px;';
                        btnRow.innerHTML = '<button class="summary-edit-cancel" style="padding:6px 14px;border-radius:14px;border:1px solid #e8e0e0;background:#fff;color:#999;font-size:12px;font-weight:600;cursor:pointer;">取消</button><button class="summary-edit-save" style="padding:6px 14px;border-radius:14px;border:none;background:linear-gradient(135deg,#f0d6d7,#e8c4d0);color:#fff;font-size:12px;font-weight:600;cursor:pointer;">保存</button>';
                        body.style.display = 'none';
                        card.querySelector('.summary-card-footer').before(textarea, btnRow);
                        btnRow.querySelector('.summary-edit-cancel').addEventListener('click', () => { textarea.remove(); btnRow.remove(); body.style.display = ''; });
                        btnRow.querySelector('.summary-edit-save').addEventListener('click', () => {
                            const val = textarea.value.trim();
                            if (val) { list[idx].text = val; saveList(storagePrefix, friendId, list); }
                            renderFn();
                        });
                    }

                    if (deleteBtn) {
                        const idx = parseInt(deleteBtn.dataset.index);
                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;padding:24px;';
                        overlay.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,255,255,0.96),rgba(250,245,255,0.92));border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);max-width:280px;text-align:center;border:1px solid rgba(245,220,250,0.5);"><h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;">删除' + typeName + '</h3><p style="color:#8b7d9c;font-size:14px;margin:0 0 24px;">确认删除这条' + typeName + '吗？</p><div style="display:flex;gap:12px;justify-content:center;"><button class="sd-yes" style="padding:10px 24px;background:linear-gradient(135deg,#f0d6d7,#ffc4d0);color:#fff;border:none;border-radius:20px;font-weight:600;cursor:pointer;">删除</button><button class="sd-no" style="padding:10px 24px;background:rgba(255,255,255,0.8);color:#8b7d9c;border:1px solid rgba(240,220,250,0.4);border-radius:20px;font-weight:600;cursor:pointer;">取消</button></div></div>';
                        document.body.appendChild(overlay);
                        overlay.querySelector('.sd-yes').addEventListener('click', () => {
                            const list = getList(storagePrefix, friendId);
                            list.splice(idx, 1); saveList(storagePrefix, friendId, list);
                            overlay.remove(); renderFn();
                        });
                        overlay.querySelector('.sd-no').addEventListener('click', () => overlay.remove());
                        overlay.addEventListener('click', (ev) => { if (ev.target === overlay) overlay.remove(); });
                    }
                });
            }

            bindCardEvents('summaryContent', 'summaries_', '小结', renderSummaries);
            bindCardEvents('bigSummaryContent', 'bigSummaries_', '大总结', renderBigSummaries);

            // ===== 打开页面时渲染 =====
            function observeModal(id, fn) {
                const el = document.getElementById(id);
                if (!el) return;
                new MutationObserver(() => { if (el.style.display !== 'none') fn(); }).observe(el, { attributes: true, attributeFilter: ['style'] });
            }
            observeModal('summaryModal', renderSummaries);
            observeModal('bigSummaryModal', renderBigSummaries);

            // ===== 自动总结 =====
            const COUNTER_PREFIX = 'summaryCounter_';

            function getCounter(friendId) {
                try {
                    return parseInt(localStorage.getItem(COUNTER_PREFIX + friendId)) || 0;
                } catch (e) {
                    // 隐私模式或 localStorage 不可用
                    console.warn('[总结计数器] 读取失败:', e.message);
                    return 0;
                }
            }
            function setCounter(friendId, val) {
                try {
                    localStorage.setItem(COUNTER_PREFIX + friendId, val);
                } catch (e) {
                    // 隐私模式或 localStorage 不可用
                    console.warn('[总结计数器] 写入失败:', e.message);
                }
            }

            function checkAutoSummary(friendId, chatHistory, apiConfig) {
                if (!friendId || !apiConfig) return;
                if (smallSummaryInFlight.has(friendId)) return;
                // 检查上次失败是否还在限流期内
                if (!canGenerateSummary(friendId, 'small')) return;
                const count = getCounter(friendId) + 1;
                const threshold = parseInt(localStorage.getItem(ROUNDS_KEY)) || 25;
                setCounter(friendId, count);
                if (count < threshold) return;
                // 达到轮数，触发总结（不立即重置，只在成功时才重置）
                generateAutoSummary(friendId, chatHistory, apiConfig, 'auto');
            }

            function resetSummaryCounter(friendId) {
                setCounter(friendId, 0);
            }

            function showSummaryFailedToast() {
                const toast = document.getElementById('cuteToast');
                if (toast) {
                    toast.querySelector('p').textContent = '总结失败，轮数已上云，轮数不会丢失';
                    toast.style.display = 'block';
                    setTimeout(() => { toast.style.display = 'none'; }, 3000);
                }
            }

            // ===== 限流机制 =====
            const FAILURE_COOLDOWN_MS = 600000; // 10分钟限流
            function recordSummaryFailureTime(friendId, type) {
                const key = 'summaryFailureTime_' + type + '_' + friendId;
                localStorage.setItem(key, Date.now().toString());
            }
            function canGenerateSummary(friendId, type) {
                const key = 'summaryFailureTime_' + type + '_' + friendId;
                const lastFailTime = localStorage.getItem(key);
                if (!lastFailTime) return true;
                const elapsed = Date.now() - parseInt(lastFailTime);
                return elapsed > FAILURE_COOLDOWN_MS;
            }

            // ===== 大总结自动合成 =====
            function checkAndGenerateBigSummary(friendId, apiConfig) {
                if (!friendId) return;
                if (bigSummaryInFlight.has(friendId)) return;
                if (!canGenerateSummary(friendId, 'big')) return;
                const summaries = getList('summaries_', friendId);
                // 只统计未被处理过的小结
                const unprocessed = getUnprocessedSmallSummaries(summaries);
                if (unprocessed.length < 15) return;
                generateBigSummaryAuto(friendId, summaries, apiConfig);
            }

            // 自动合成未处理小结的大总结（不需要用户选择）
            async function generateBigSummaryAuto(friendId, summaries, apiConfig) {
                if (!apiConfig || !apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    console.warn('[大总结] API配置缺失，跳过自动合成');
                    return;
                }
                if (bigSummaryInFlight.has(friendId)) return;
                bigSummaryInFlight.add(friendId);

                try {
                    // 只取未处理的小结
                    const normalizedSummaries = summaries.map(normalizeSmallSummaryItem);
                    const unprocessed = getUnprocessedSmallSummaries(normalizedSummaries);
                    const selectedCount = Math.min(unprocessed.length, 15);
                    if (selectedCount < 15) return;
                    const wordLimit = 700;
                    const maxTokens = 1000;

                    showCuteToast('正在自动合成大总结...');

                    // 构建小结素材
                    const selectedSummaries = unprocessed.slice(0, selectedCount);
                    const summaryTexts = selectedSummaries.map((s, idx) => `${idx + 1}. ${s.text}`).join('\n\n');

                    const prompt = `你是一位信息压缩与核心记忆提取专家。以下是${selectedCount}条关于一段对话的小结记录，请将它们合并为1条高度压缩的大总结。

要求：
- 字数严格控制在${wordLimit}字以内（越精简越好）
- 只保留核心记忆、关键事件、重要结论
- 删除重复信息、冗余细节
- 语言简洁有力，禁止流水账，禁止编故事
- 直接输出大总结内容，不加标题或编号

小结列表：
${summaryTexts}`;

                    const resp = await fetch(`${apiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + apiConfig.apiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: apiConfig.model, messages: [{ role: 'user', content: prompt }], max_tokens: maxTokens, temperature: 0.3 })
                    });
                    if (!resp.ok) {
                        recordSummaryFailureTime(friendId, 'big');
                        showSummaryFailedToast();
                        return;
                    }
                    const data = await resp.json();
                    // 过滤<think>推理标签（某些模型如DeepSeek会输出）
                    const text = (data.choices?.[0]?.message?.content || '')
                        .replace(/<think>[\s\S]*?<\/think>/gi, '') // 闭合标签
                        .replace(/<think>[\s\S]*/gi, '')            // 未闭合标签
                        .replace(/<\/think>/gi, '')                 // 孤立闭合标签
                        .trim();
                    if (!text || text.length < 100) {
                        recordSummaryFailureTime(friendId, 'big');
                        showSummaryFailedToast();
                        return;
                    }

                    // 保存大总结
                    const bigSummaries = getList('bigSummaries_', friendId);
                    const bigSummaryId = makeSummaryId('bg');
                    bigSummaries.unshift(normalizeBigSummaryItem({
                        id: bigSummaryId,
                        text: text,
                        time: nowTime(),
                        sourceSummaryIds: selectedSummaries.map(s => s.id)
                    }));
                    saveList('bigSummaries_', friendId, bigSummaries);

                    // 标记已处理的小结
                    const usedIds = new Set(selectedSummaries.map(s => s.id));
                    normalizedSummaries.forEach(s => {
                        if (usedIds.has(s.id) && !isSummaryProcessed(s)) {
                            s.processed = true;
                            s.processedByBigSummaryId = bigSummaryId;
                        }
                    });
                    saveList('summaries_', friendId, normalizedSummaries);

                    renderBigSummaries();
                    renderSummaries();
                    showCuteToast('大总结已自动生成');
                } catch (e) {
                    console.warn('[大总结] 自动合成失败:', e);
                    recordSummaryFailureTime(friendId, 'big');
                    showSummaryFailedToast();
                } finally {
                    bigSummaryInFlight.delete(friendId);
                }
            }

            // 手动合成大总结（用户可选择数量）
            async function generateBigSummary(friendId, summaries, apiConfig) {
                if (!apiConfig || !apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    showCuteToast('API 配置不完整，请检查设置');
                    return;
                }
                if (bigSummaryInFlight.has(friendId)) {
                    showCuteToast('大总结正在生成，请稍候');
                    return;
                }
                bigSummaryInFlight.add(friendId);

                try {
                    // 只对未处理的小结让用户选择
                    const normalizedSummaries = summaries.map(normalizeSmallSummaryItem);
                    const unprocessed = getUnprocessedSmallSummaries(normalizedSummaries);
                    if (unprocessed.length < 5) {
                        showCuteToast('未归档的小结不足5条');
                        return;
                    }

                    const selectedCount = await showSummaryCountSelector(unprocessed.length);
                    if (!selectedCount) return;

                    const wordLimit = Math.min(700, Math.max(200, selectedCount * 45));
                    const maxTokens = Math.min(1000, Math.max(300, selectedCount * 65));

                    showCuteToast('正在生成大总结...');

                    const selectedSummaries = unprocessed.slice(0, selectedCount);
                    const summaryTexts = selectedSummaries.map((s, idx) => `${idx + 1}. ${s.text}`).join('\n\n');

                    const prompt = `你是一位信息压缩与核心记忆提取专家。以下是${selectedCount}条关于一段对话的小结记录，请将它们合并为1条高度压缩的大总结。

要求：
- 字数严格控制在${wordLimit}字以内（越精简越好）
- 只保留核心记忆、关键事件、重要结论
- 删除重复信息、冗余细节
- 语言简洁有力，禁止流水账，禁止编故事
- 直接输出大总结内容，不加标题或编号

小结列表：
${summaryTexts}`;

                    const resp = await fetch(`${apiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + apiConfig.apiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: apiConfig.model, messages: [{ role: 'user', content: prompt }], max_tokens: maxTokens, temperature: 0.3 })
                    });
                    if (!resp.ok) {
                        recordSummaryFailureTime(friendId, 'big');
                        showCuteToast(`API 请求失败 (${resp.status})，请检查配置或稍后重试`);
                        console.error('[大总结] API错误:', resp.status);
                        return;
                    }
                    const data = await resp.json();
                    // 过滤<think>推理标签（某些模型如DeepSeek会输出）
                    const text = (data.choices?.[0]?.message?.content || '')
                        .replace(/<think>[\s\S]*?<\/think>/gi, '') // 闭合标签
                        .replace(/<think>[\s\S]*/gi, '')            // 未闭合标签
                        .replace(/<\/think>/gi, '')                 // 孤立闭合标签
                        .trim();
                    if (!text || text.length < 100) {
                        recordSummaryFailureTime(friendId, 'big');
                        showCuteToast('API 返回内容不足，请稍后重试');
                        console.warn('[大总结] 返回内容过短:', text?.length || 0);
                        return;
                    }

                    // 保存大总结
                    const bigSummaries = getList('bigSummaries_', friendId);
                    const bigSummaryId = makeSummaryId('bg');
                    bigSummaries.unshift(normalizeBigSummaryItem({
                        id: bigSummaryId,
                        text: text,
                        time: nowTime(),
                        sourceSummaryIds: selectedSummaries.map(s => s.id)
                    }));
                    saveList('bigSummaries_', friendId, bigSummaries);

                    // 标记已处理的小结
                    const usedIds = new Set(selectedSummaries.map(s => s.id));
                    normalizedSummaries.forEach(s => {
                        if (usedIds.has(s.id) && !isSummaryProcessed(s)) {
                            s.processed = true;
                            s.processedByBigSummaryId = bigSummaryId;
                        }
                    });
                    saveList('summaries_', friendId, normalizedSummaries);

                    renderBigSummaries();
                    renderSummaries();
                    showCuteToast('大总结已生成');
                } catch (e) {
                    console.error('[大总结] 合成失败:', e.message);
                    recordSummaryFailureTime(friendId, 'big');
                    showCuteToast(`大总结生成失败: ${e.message}`);
                } finally {
                    bigSummaryInFlight.delete(friendId);
                }
            }

            // 显示小结数量选择器
            function showSummaryCountSelector(totalCount) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    const options = [];
                    // 生成选项：5条起，每5条一档，最多到总数
                    for (let i = 5; i <= totalCount; i += 5) {
                        const wordLimit = Math.min(700, Math.max(200, i * 45));
                        options.push(`<div class="count-option" data-count="${i}" style="padding:12px 20px;margin:6px 0;background:#f8f8f8;border-radius:10px;cursor:pointer;transition:all 0.2s;border:1px solid #e0e0e0;">${i}条小结 → 约${wordLimit}字大总结</div>`);
                    }
                    // 如果总数不是5的倍数，添加全部选项
                    if (totalCount % 5 !== 0) {
                        const wordLimit = Math.min(700, Math.max(200, totalCount * 45));
                        options.push(`<div class="count-option" data-count="${totalCount}" style="padding:12px 20px;margin:6px 0;background:#f8f8f8;border-radius:10px;cursor:pointer;transition:all 0.2s;border:1px solid #e0e0e0;">全部${totalCount}条 → 约${wordLimit}字大总结</div>`);
                    }

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:320px;">
                    <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 16px;text-align:center;">选择合成数量</h3>
                    <div style="max-height:300px;overflow-y:auto;">${options.join('')}</div>
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
                        <button class="cancel-btn" style="padding:8px 18px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;">取消</button>
                    </div>
                </div>`;

                    document.body.appendChild(overlay);

                    // 选项点击事件
                    overlay.querySelectorAll('.count-option').forEach(option => {
                        option.addEventListener('mouseover', () => {
                            option.style.background = '#e8f4fd';
                            option.style.borderColor = '#4a9eff';
                        });
                        option.addEventListener('mouseout', () => {
                            option.style.background = '#f8f8f8';
                            option.style.borderColor = '#e0e0e0';
                        });
                        option.addEventListener('click', () => {
                            const count = parseInt(option.dataset.count);
                            document.body.removeChild(overlay);
                            resolve(count);
                        });
                    });

                    // 取消按钮
                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                        resolve(null);
                    });
                });
            }

            async function generateAutoSummary(friendId, chatHistory, apiConfig, triggerSource = 'manual') {
                if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    showCuteToast('API 配置不完整，请检查设置');
                    return;
                }
                const isManualTrigger = triggerSource === 'manual';
                if (smallSummaryInFlight.has(friendId)) {
                    showCuteToast('小结正在生成，请稍候');
                    return;
                }
                smallSummaryInFlight.add(friendId);
                if (isManualTrigger) setManualSummaryLoading(true);

                try {
                    if (!isManualTrigger) showCuteToast('正在生成小结...');

                    // 增量总结：只取上次总结之后的新消息
                    const totalCount = Array.isArray(chatHistory) ? chatHistory.length : 0;
                    const savedCursor = parseInt(localStorage.getItem('lastSummaryIndex_' + friendId));
                    const lastIdx = Number.isFinite(savedCursor) ? Math.max(0, Math.min(savedCursor, totalCount)) : 0;
                    const newMessages = chatHistory.slice(lastIdx);
                    const sourceMessageIds = newMessages.map((m, idx) => m && m.id ? String(m.id) : ('idx:' + String(lastIdx + idx)));

                    const recent = newMessages
                        .filter(m => !m.isDeletedLocal && !m.isRecalled && m.content)
                        .map(m => {
                            const role = (m.role === 'ai' || m.role === 'assistant') ? 'AI' : '用户';
                            return role + '：' + m.content;
                        }).join('\n');

                    if (!recent) {
                        showCuteToast('没有新的对话内容可供总结');
                        return;
                    }

                    const prompt = `你是一位文笔精练的总结助手。请根据以下对话记录，生成一段200～450字的精简总结。

要求：
- 总结对话中的核心内容、关键事件、情感变化和重要结论
- 语言精炼有条理，禁止流水账，禁止废话套话
- 字数严格控制在200～450字之间
- 直接输出总结内容，不加标题、编号或前缀

对话记录：
${recent}`;

                    const resp = await fetch(`${apiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + apiConfig.apiKey, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: apiConfig.model, messages: [{ role: 'user', content: prompt }], max_tokens: 800, temperature: 0.5 })
                    });
                    if (!resp.ok) {
                        recordSummaryFailureTime(friendId, 'small');
                        const errMsg = `API 请求失败 (${resp.status})，请检查配置或稍后重试`;
                        showCuteToast(errMsg);
                        console.error('[自动总结] API错误:', resp.status);
                        return;
                    }
                    const data = await resp.json();
                    // 过滤<think>推理标签（某些模型如DeepSeek会输出）
                    const text = (data.choices?.[0]?.message?.content || '')
                        .replace(/<think>[\s\S]*?<\/think>/gi, '') // 闭合标签
                        .replace(/<think>[\s\S]*/gi, '')            // 未闭合标签
                        .replace(/<\/think>/gi, '')                 // 孤立闭合标签
                        .trim();
                    if (!text || text.length < 50) {
                        recordSummaryFailureTime(friendId, 'small');
                        showCuteToast('API 返回内容不足，请稍后重试');
                        console.warn('[自动总结] 返回内容过短:', text?.length || 0);
                        return;
                    }
                    showSummaryConfirm(friendId, text, {
                        nextCursor: totalCount,
                        sourceStart: lastIdx,
                        sourceEnd: totalCount,
                        sourceMessageIds,
                        triggerSource
                    });
                } catch (e) {
                    console.error('[自动总结] API 调用异常:', e.message);
                    recordSummaryFailureTime(friendId, 'small');
                    showCuteToast(`总结生成失败: ${e.message}`);
                } finally {
                    if (isManualTrigger) setManualSummaryLoading(false);
                    smallSummaryInFlight.delete(friendId);
                }
            }

            // ===== 确认弹窗 =====
            function showSummaryConfirm(friendId, text, sourceMeta) {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;z-index:2500;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;padding:20px;';
                overlay.innerHTML = `
                <div style="background:linear-gradient(135deg,rgba(255,255,255,0.97),rgba(252,248,255,0.95));border-radius:24px;padding:22px 20px;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:100%;max-width:340px;border:1px solid rgba(245,220,250,0.4);position:relative;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                        <h3 style="color:#4a4858;font-size:16px;font-weight:700;margin:0;">自动总结完成</h3>
                        <button class="sc-edit-toggle" title="编辑" style="width:32px;height:32px;border:none;border-radius:10px;background:#faf5f5;color:#d4a0a8;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background 0.15s;">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </div>
                    <div class="sc-text-display" style="font-size:13.5px;color:#555;line-height:1.7;max-height:200px;overflow-y:auto;word-break:break-word;white-space:pre-wrap;padding:12px 14px;background:#fdfbfd;border-radius:14px;border:1px solid #f5eff0;"></div>
                    <textarea class="sc-text-edit" style="display:none;width:100%;min-height:140px;max-height:200px;padding:12px 14px;border:1.5px solid #f0d6d7;border-radius:14px;font-size:13.5px;color:#555;resize:none;font-family:inherit;outline:none;background:#fff;box-sizing:border-box;line-height:1.7;"></textarea>
                    <div style="display:flex;justify-content:center;margin-top:16px;">
                        <button class="sc-confirm" style="padding:10px 36px;border-radius:20px;border:none;background:linear-gradient(135deg,#f0d6d7,#e8c4d0);color:#fff;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 3px 12px rgba(240,214,215,0.35);transition:transform 0.15s;">确定</button>
                    </div>
                </div>
            `;
                document.body.appendChild(overlay);

                const display = overlay.querySelector('.sc-text-display');
                const editArea = overlay.querySelector('.sc-text-edit');
                const editToggle = overlay.querySelector('.sc-edit-toggle');
                const confirmBtn = overlay.querySelector('.sc-confirm');

                display.textContent = text;
                editArea.value = text;
                let isEditing = false;

                editToggle.addEventListener('click', () => {
                    isEditing = !isEditing;
                    if (isEditing) {
                        display.style.display = 'none';
                        editArea.style.display = '';
                        editArea.focus();
                        editToggle.style.background = '#f0d6d7';
                        editToggle.style.color = '#fff';
                    } else {
                        const val = editArea.value.trim();
                        if (val) display.textContent = val;
                        display.style.display = '';
                        editArea.style.display = 'none';
                        editToggle.style.background = '#faf5f5';
                        editToggle.style.color = '#d4a0a8';
                    }
                });

                confirmBtn.addEventListener('click', () => {
                    const finalText = isEditing ? editArea.value.trim() : display.textContent;
                    if (finalText) {
                        const list = getList('summaries_', friendId).map(normalizeSmallSummaryItem);
                        const meta = (sourceMeta && typeof sourceMeta === 'object') ? sourceMeta : {};
                        list.unshift(normalizeSmallSummaryItem({
                            id: makeSummaryId('sm'),
                            text: finalText,
                            time: nowTime(),
                            sourceStart: Number.isFinite(meta.sourceStart) ? meta.sourceStart : null,
                            sourceEnd: Number.isFinite(meta.sourceEnd) ? meta.sourceEnd : null,
                            sourceMessageIds: Array.isArray(meta.sourceMessageIds) ? meta.sourceMessageIds : [],
                            triggerSource: typeof meta.triggerSource === 'string' ? meta.triggerSource : 'manual'
                        }));
                        saveList('summaries_', friendId, list);
                        renderSummaries();
                        // 总结保存成功，重置计数器
                        resetSummaryCounter(friendId);
                        // 记录增量总结位置
                        if (Number.isFinite(meta.nextCursor)) {
                            localStorage.setItem('lastSummaryIndex_' + friendId, String(meta.nextCursor));
                        }
                        showCuteToast('已自动生成1条新小结');
                        // 检查是否需要自动合成大总结 - 优先使用全局apiService
                        let bigSummaryConfig;
                        if (window.summarySystemApiService && typeof window.summarySystemApiService.getConfig === 'function') {
                            bigSummaryConfig = window.summarySystemApiService.getConfig();
                        } else {
                            bigSummaryConfig = { apiUrl: localStorage.getItem('apiUrl'), apiKey: localStorage.getItem('apiKey'), model: localStorage.getItem('selectedModel') };
                        }
                        checkAndGenerateBigSummary(friendId, bigSummaryConfig);
                    }
                    overlay.remove();
                });
            }

            // 暴露给外部
            window.summarySystem = { getList, saveList, renderSummaries, renderBigSummaries, getFriendId, nowTime, checkAutoSummary };
        })();

        // ========== 个人资料页面功能 ==========
        (() => {
            let isEditMode = false;

            // 个人资料数据默认值
            const defaultProfile = {
                name: '芋圆',
                sweetId: '1234567890',
                gender: 'female',
                signature: '小小世界，开心至上',
                personality: '',
                birthday: '',
                location: '',
                avatar: ''
            };

            // 打开个人资料页面
            window.openProfileModal = function(options = {}) {
                const modal = document.getElementById('profileModal');
                if (!modal) return;

                modal.dataset.from = options.from || '';
                loadProfileData();
                updateStatusBarTime('profile');
                modal.style.display = 'flex';
            };

            // 关闭个人资料页面
            function closeProfileModal() {
                const modal = document.getElementById('profileModal');
                if (modal) {
                    const from = modal.dataset.from || '';
                    modal.style.display = 'none';
                    modal.dataset.from = '';
                    exitEditMode();

                    if (from === 'friendList') {
                        const friendListModalEl = document.getElementById('friendListModal');
                        if (friendListModalEl) {
                            friendListModalEl.style.display = 'flex';
                        }

                        const navItems = document.querySelectorAll('.friend-list-nav-item');
                        navItems.forEach(item => item.classList.remove('active'));
                        const messagesNav = document.querySelector('.friend-list-nav-item[data-nav=\"messages\"]');
                        if (messagesNav) messagesNav.classList.add('active');
                    }
                }
            }

            // 加载个人资料数据
            function loadProfileData() {
                const savedProfile = localStorage.getItem('userProfile');
                const profile = savedProfile ? { ...defaultProfile, ...JSON.parse(savedProfile) } : defaultProfile;

                // 显示信息
                document.getElementById('profileDisplayName').textContent = profile.name;
                document.getElementById('profileIdDisplay').textContent = profile.sweetId;
                document.getElementById('profileSignatureDisplay').textContent = profile.signature;

                // 设置性别图标
                const genderIcon = document.getElementById('profileGenderIcon');
                if (profile.gender === 'male') {
                    genderIcon.className = 'fas fa-mars';
                    genderIcon.style.color = '#4169e1';
                } else if (profile.gender === 'other') {
                    genderIcon.className = 'fas fa-genderless';
                    genderIcon.style.color = '#9370db';
                } else {
                    genderIcon.className = 'fas fa-venus';
                    genderIcon.style.color = '#ff69b4';
                }

                // 填充表单
                document.getElementById('profileNameInput').value = profile.name;
                document.getElementById('profileIdInput').value = profile.sweetId;
                document.getElementById('profileSignatureInput').value = profile.signature;
                document.getElementById('profilePersonalityInput').value = profile.personality;
                document.getElementById('profileBirthdayInput').value = profile.birthday;
                document.getElementById('profileLocationInput').value = profile.location;

                // 设置性别选择
                const genderRadio = document.querySelector(`input[name="gender"][value="${profile.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
            }

            // 保存个人资料数据
            function saveProfileData() {
                const profile = {
                    name: document.getElementById('profileNameInput').value.trim() || defaultProfile.name,
                    sweetId: document.getElementById('profileIdInput').value.trim() || defaultProfile.sweetId,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || 'female',
                    signature: document.getElementById('profileSignatureInput').value.trim() || defaultProfile.signature,
                    personality: document.getElementById('profilePersonalityInput').value.trim(),
                    birthday: document.getElementById('profileBirthdayInput').value,
                    location: document.getElementById('profileLocationInput').value.trim()
                };

                // 保存到localStorage
                localStorage.setItem('userProfile', JSON.stringify(profile));
                
                // 更新显示
                loadProfileData();
                
                // 显示保存成功提示
                showCuteToast('个人资料保存成功！✨');
                
                exitEditMode();
            }

            // 进入编辑模式
            function enterEditMode() {
                isEditMode = true;
                document.getElementById('profileEditForm').style.display = 'block';
                document.getElementById('profileCardsSection').style.display = 'none';
                
                const editBtn = document.getElementById('profileEditBtn');
                editBtn.innerHTML = '<i class="fas fa-times"></i>';
                editBtn.style.color = '#ff6b6b';
            }

            // 退出编辑模式
            function exitEditMode() {
                isEditMode = false;
                document.getElementById('profileEditForm').style.display = 'none';
                document.getElementById('profileCardsSection').style.display = 'block';
                
                const editBtn = document.getElementById('profileEditBtn');
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.style.color = '#ff69b4';
            }

            // 更新状态栏时间
            function updateStatusBarTime(prefix) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const time = `${hours}:${minutes}`;
                
                document.getElementById(`${prefix}StatusTime`).textContent = time;
            }

            // 可爱的toast提示
            function showCuteToast(message) {
                // 创建toast元素
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 20px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 10000;
                    box-shadow: 0 8px 25px rgba(255, 154, 158, 0.6);
                    animation: toastFadeIn 0.3s ease-out;
                `;
                toast.textContent = message;

                // 添加动画keyframes
                if (!document.getElementById('toast-styles')) {
                    const style = document.createElement('style');
                    style.id = 'toast-styles';
                    style.textContent = `
                        @keyframes toastFadeIn {
                            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                        }
                        @keyframes toastFadeOut {
                            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                document.body.appendChild(toast);

                // 2秒后消失
                setTimeout(() => {
                    toast.style.animation = 'toastFadeOut 0.3s ease-in';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 2000);
            }

            // 绑定事件监听器
            document.addEventListener('DOMContentLoaded', () => {
                // 关闭按钮
                const closeBtn = document.getElementById('closeProfileModal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeProfileModal);
                }

                // 编辑按钮
                const editBtn = document.getElementById('profileEditBtn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        if (isEditMode) {
                            exitEditMode();
                        } else {
                            enterEditMode();
                        }
                    });
                }

                // 保存按钮
                const saveBtn = document.getElementById('profileSaveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', saveProfileData);
                }

                // 取消按钮
                const cancelBtn = document.getElementById('profileCancelBtn');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', exitEditMode);
                }

                // 头像点击编辑
                const avatar = document.getElementById('profileAvatar');
                if (avatar) {
                    avatar.addEventListener('click', () => {
                        if (isEditMode) {
                            showCuteToast('头像上传功能开发中... 🎨');
                        } else {
                            enterEditMode();
                        }
                    });
                }

                // 模态框点击背景关闭
                const modal = document.getElementById('profileModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeProfileModal();
                        }
                    });
                }
            });

            // 暴露给外部
            window.profileSystem = {
                openProfileModal,
                loadProfileData,
                saveProfileData,
                showCuteToast
            };
        })();
    </script>
</body>

</html>
