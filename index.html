<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>芋圆机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!--
    ============================================================
    项目架构说明 - UI主题管理系统
    ============================================================
    
    【当前UI主题】iPhone风格模拟器
    
    【全局UI管理】
    - UI_CONFIG: 位于 <script> 顶部，集中配置UI主题和类名
    - UIManager: 全局UI管理器，提供统一的UI元素生成方法
    - CSS变量系统: :root 中定义了30+个颜色变量
    - CSS分段注释: 按功能模块分段（iPhone特定/通用组件/聊天消息等）
    
    【页面/视图列表】（11个弹窗 + 1个主屏幕）
    1. 主屏幕 (home-screen) - 好友卡片、天气小部件
    2. API设置 (apiModal) - API配置和模型选择
    3. API预设 (apiPresetModal) - 保存和加载API预设
    4. 好友列表 (friendListModal) - 好友管理
    5. 添加好友 (addFriendModal) - 创建新好友
    6. 聊天界面 (chatModal) - 主要对话界面
    7. 语音输入 (voiceModal) - 语音转文本
    8. 相机描述 (cameraDescModal) - 上传图片描述
    9. 图片查看 (imageDescModal) - 查看角色生成图片
    10. 删除确认 (confirmDeleteModal) - 删除好友确认
    11. 心声历史 (heartVoiceHistoryModal) - 查看历史心声
    12. 心声删除 (hvDeleteModal) - 删除心声确认
    
    【如何添加新页面】
    使用 UIManager 创建统一的UI组件：
    
    ```javascript
    // 1. 创建状态栏（永远保持现有格式）
    const statusBar = UIManager.createStatusBar();
    
    // 2. 创建各种按钮
    const primaryButton = UIManager.createButton('确认', { type: 'primary' });
    const backButton = UIManager.createBackButton({ onclick: 'goBack()' });
    const closeButton = UIManager.createCloseButton({ onclick: 'closeModal()' });
    const iconButton = UIManager.createIconButton('fas fa-heart', '喜欢');
    
    // 3. 创建输入框
    const textInput = UIManager.createInput({ placeholder: '请输入内容', id: 'myInput' });
    const chatInput = UIManager.createInput({ style: 'chat', placeholder: '发送消息...' });
    const textarea = UIManager.createTextarea({ placeholder: '多行文本', rows: 5 });
    
    // 4. 创建卡片
    const settingsCard = UIManager.createCard('设置内容', { type: 'settings' });
    const friendCard = UIManager.createCard('好友信息', { type: 'friend' });
    const gameCard = UIManager.createCard('游戏内容', { type: 'game' });
    
    // 5. 创建列表
    const friendsList = UIManager.createList(friendItems, { type: 'friends' });
    const modelPickerList = UIManager.createList(modelItems, { type: 'model-picker' });
    const listItem = UIManager.createListItem('列表项内容', { type: 'friend' });
    
    // 6. 创建桌面图标
    const appIcon = UIManager.createDesktopIcon('fas fa-chat', '聊天', { onclick: 'openChat()' });
    const dockIcon = UIManager.createDesktopIcon('fas fa-home', '', { type: 'dock' });
    
    // 示例：创建完整页面
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            ${UIManager.createStatusBar()}
            <div class="modal-header">
                ${UIManager.createBackButton({ onclick: 'closeModal()' })}
                <h1>页面标题</h1>
                ${UIManager.createCloseButton()}
            </div>
            <div class="modal-body">
                ${UIManager.createInput({ placeholder: '搜索...', id: 'searchInput' })}
                ${UIManager.createCard('卡片内容', { type: 'settings' })}
            </div>
            <div class="modal-footer">
                ${UIManager.createButton('取消', { type: 'secondary' })}
                ${UIManager.createButton('确认', { type: 'primary' })}
            </div>
        </div>
    `;
    ```
    
    【支持的组件类型】
    - 状态栏：createStatusBar() - 永远保持现有格式不变
    - 按钮：createButton(), createIconButton(), createBackButton(), createCloseButton()
    - 输入框：createInput(), createTextarea() - 支持default和chat样式
    - 卡片：createCard() - 支持settings/friend/game/summary/worldbook等类型
    - 列表：createList(), createListItem() - 支持friends/model-picker等类型  
    - 桌面：createDesktopIcon() - 支持app/dock两种类型
    
    【如何切换UI主题】（例如：iPhone → Android）
    步骤1: 修改 UI_CONFIG.theme = 'android'
    步骤2: 找到CSS中的 "iPhone特定UI样式" 分段注释
    步骤3: 替换/禁用iPhone特定样式（.notch, .iphone-container等）
    步骤4: 添加Android风格样式（状态栏、导航栏等）
    步骤5: UIManager 会自动应用新配置
    
    【代码组织】
    - 第1-3500行: HTML结构和CSS样式
    - 第3500-4400行: 所有弹窗的HTML模板
    - 第4400-12450行: JavaScript逻辑（UI_CONFIG在最开头）
    
    ============================================================
    -->

    <style>
        :root {
            /* ========== 全局高度适配变量 ========== */
            /* 顶部栏高度定义 */
            --status-bar-height: 50px;
            --status-bar-height-hidden: 0px;
            --header-base-height: 40px;
            --header-base-height-hidden: 36px;
            --header-height-normal: calc(var(--header-base-height) + env(safe-area-inset-top, 0px));
            --header-height-hidden: calc(var(--header-base-height-hidden) + env(safe-area-inset-top, 0px));

            /* 计算内容区和底部区的高度 */
            --total-header-height: calc(var(--status-bar-height) + var(--header-height-normal));
            --total-header-height-hidden: calc(var(--status-bar-height-hidden) + var(--header-height-hidden));

            /* ========== 🎨 第一层：基础色板（Base Palette）========== */
            /* 修改主题只需改这里，组件色会自动继承 */

            /* 主题色系 */
            --base-primary: #d4e3f0;
            /* 浅蓝主色 */
            --base-secondary: #dfe8f0;
            /* 浅灰蓝次要色 */
            --base-accent: #c8dce8;
            /* 浅青强调色 */
            --base-accent-pink: #e9dae4;
            /* 淡雅粉紫 */
            --base-accent-lavender: #e7daed;
            /* 淡雅薰衣草 */

            /* 中性灰度系 */
            --base-gray-900: #3d4d5c;
            /* 最深灰 */
            --base-gray-800: #4a5968;
            /* 深灰 */
            --base-gray-700: #6b7d8f;
            /* 主灰 */
            --base-gray-600: #7a8a9a;
            /* 中灰 */
            --base-gray-500: #8b99a8;
            /* 标准灰 */
            --base-gray-400: #9aa8b5;
            /* 浅灰 */
            --base-gray-300: #b5c1cc;
            /* 更浅灰 */
            --base-gray-200: #c5d0da;
            /* 极浅灰 */
            --base-gray-100: #e0e7ed;
            /* 接近白 */
            --base-gray-50: #f5f8fa;
            /* 浅灰背景 */

            /* 白色系 */
            --base-white: #ffffff;
            /* 纯白 */
            --base-white-soft: #fafbfc;
            /* 柔和白 */
            --base-white-warm: #fbfbfb;
            /* 暖白 */

            /* 语义色系 */
            --base-success: #7fbf9f;
            /* 成功绿 */
            --base-error: #d89595;
            /* 错误红 */
            --base-danger: #c58585;
            /* 危险红 */
            --base-warning: #998866;
            /* 警告橙 */
            --base-delete: #f08282;
            /* 删除红 */
            --base-vip: #e8d5a8;
            /* VIP金 */

            /* 透明度基础值 */
            --base-opacity-05: 0.05;
            --base-opacity-10: 0.1;
            --base-opacity-20: 0.2;
            --base-opacity-30: 0.3;
            --base-opacity-50: 0.5;
            --base-opacity-65: 0.65;
            --base-opacity-70: 0.7;
            --base-opacity-75: 0.75;
            --base-opacity-80: 0.8;

            /* 阴影基础色 */
            --base-shadow: 107, 125, 143;
            /* RGB值 */
            --base-shadow-dark: 0, 0, 0;
            /* 深色阴影RGB */

            /* ========== 🎯 第二层：组件专用色（Component Colors）========== */
            /* 基于第一层基础色，易于维护和主题切换 */

            /* 主题色（保持兼容性） */
            --color-primary: var(--base-primary);
            --color-secondary: var(--base-secondary);
            --color-accent: var(--base-accent);

            /* 背景色系 */
            --color-background: var(--base-gray-50);
            --color-bg-white: var(--base-white-soft);
            --color-widget-bg: var(--base-white);
            --color-bg-hover: #eef2f5;
            --color-bg-active: #e5ebf0;
            --color-bg-pressed: #dce3e8;
            --color-bg-light: #f7f9fb;
            --color-bg-input: #f3f6f9;
            --color-bg-selected: var(--base-white-warm);
            --color-bg-disabled: #e8ecf0;
            --color-bg-user-msg: #f2e4f1;
            --color-bg-ai-msg: #e6f0f5;

            /* 文字色系 */
            --color-text: var(--base-gray-700);
            --color-text-darker: var(--base-gray-900);
            --color-text-dark: var(--base-gray-800);
            --color-text-medium: var(--base-gray-600);
            --color-text-light: var(--base-gray-400);
            --color-text-lighter: var(--base-gray-300);
            --color-text-muted: var(--base-gray-200);
            --color-text-placeholder: var(--base-gray-500);

            /* 边框色系 */
            --color-border: var(--base-white);
            --color-border-light: #fefefe;
            --color-border-lighter: #f7f7f7;
            --color-border-widget: #f5f5f5;
            --color-border-input: #dce3e9;

            /* 状态色 */
            --color-success: var(--base-success);
            --color-success-bg: rgba(72, 187, 120, var(--base-opacity-10));
            --color-success-border: rgba(72, 187, 120, var(--base-opacity-20));
            --color-error: var(--base-error);
            --color-error-bg: rgba(245, 101, 101, var(--base-opacity-10));
            --color-error-border: rgba(245, 101, 101, var(--base-opacity-20));
            --color-danger: var(--base-danger);
            --color-warning-bg: #faf5e6;
            --color-warning-border: #e5d9b3;
            --color-warning-text: var(--base-warning);
            --color-delete-red: var(--base-delete);

            /* 按钮色系 */
            --color-accent-pink: var(--base-accent-pink);
            --color-accent-lavender: var(--base-accent-lavender);
            --color-accent-blue: #c5d7e8;
            --color-button-primary: var(--base-accent);
            --color-button-secondary: #e5ebf0;

            /* UI控件色 */
            --color-ui-gray: var(--base-gray-500);
            --color-ui-bg: #f7f9fb;
            --color-ui-border: #f0f3f6;
            --color-vip-gold: var(--base-vip);
            --color-active-link: #8ba8c5;

            /* 玻璃拟态效果 */
            --glass-bg: rgba(255, 255, 255, var(--base-opacity-65));
            --glass-bg-light: rgba(255, 255, 255, var(--base-opacity-50));
            --glass-bg-strong: rgba(255, 255, 255, var(--base-opacity-70));
            --glass-bg-stronger: rgba(255, 255, 255, var(--base-opacity-80));
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-border-light: rgba(255, 255, 255, var(--base-opacity-30));
            --glass-border-strong: rgba(255, 255, 255, 0.35);
            --glass-border-white: rgba(255, 255, 255, 0.4);
            --glass-border-stronger: rgba(255, 255, 255, var(--base-opacity-50));
            --glass-border-icon: rgba(255, 255, 255, 0.6);
            --glass-blur: blur(20px);
            --glass-blur-light: blur(10px);
            --glass-blur-strong: blur(25px);

            /* 阴影系统 */
            --box-shadow: 0 8px 32px rgba(var(--base-shadow), 0.06);
            --box-shadow-hover: 0 12px 40px rgba(var(--base-shadow), 0.08);
            --box-shadow-light: 0 4px 16px rgba(var(--base-shadow), 0.04);
            --shadow-color: rgba(var(--base-shadow), 0.06);
            --shadow-color-hover: rgba(var(--base-shadow), 0.08);
            --shadow-color-light: rgba(var(--base-shadow), 0.04);
            --shadow-color-medium: rgba(var(--base-shadow), var(--base-opacity-10));
            --shadow-color-strong: rgba(var(--base-shadow), 0.12);

            /* 覆盖层 */
            --overlay-bg: rgba(var(--base-shadow-dark), var(--base-opacity-05));
            --overlay-dark: rgba(var(--base-shadow-dark), var(--base-opacity-30));
            --overlay-darker: rgba(var(--base-shadow-dark), var(--base-opacity-50));

            /* 组件专用色 */
            --status-bar-bg: rgba(249, 249, 249, var(--base-opacity-75));
            --status-border: rgba(224, 231, 237, 0.25);
            --status-border-strong: rgba(224, 231, 237, 0.35);
            --chat-header-bg: rgba(255, 255, 255, var(--base-opacity-70));
            --chat-header-border: rgba(224, 231, 237, 0.35);
            --chat-header-blur: blur(25px);

            /* 图标渐变色 */
            --avatar-gradient-start: rgba(200, 220, 240, var(--base-opacity-70));
            --avatar-gradient-end: rgba(212, 227, 240, var(--base-opacity-70));
            --icon-gradient-1-start: rgba(180, 205, 225, var(--base-opacity-70));
            --icon-gradient-1-end: rgba(200, 220, 235, var(--base-opacity-70));
            --icon-gradient-2-start: rgba(180, 200, 220, var(--base-opacity-70));
            --icon-gradient-2-end: rgba(200, 215, 230, var(--base-opacity-70));
            --icon-gradient-3-start: rgba(160, 190, 215, var(--base-opacity-70));
            --icon-gradient-3-end: rgba(180, 205, 225, var(--base-opacity-70));
            --icon-gradient-4-start: rgba(170, 200, 220, var(--base-opacity-70));
            --icon-gradient-4-end: rgba(190, 215, 235, var(--base-opacity-70));
            --icon-gradient-5-start: rgba(190, 205, 220, var(--base-opacity-70));
            --icon-gradient-5-end: rgba(205, 220, 230, var(--base-opacity-70));
            --icon-color: rgba(255, 255, 255, 0.9);
            --icon-color-alt: rgba(255, 255, 255, 0.95);

            /* ========== 🎨 美化系统配置（改这里就能自定义样式！）========== */
            /* 主屏幕网格布局 */
            --grid-columns: 3;
            /* 网格列数（3、4、5、6...） */
            --grid-gap: 16px;
            /* 图标间距 */
            --grid-row-height: 100px;
            /* 每行高度 */
            --grid-offset-top: 24px;
            /* 顶部偏移 */

            /* 应用图标尺寸 */
            --app-icon-size: 60px;
            /* 图标大小 */
            --app-icon-radius: 18px;
            /* 图标圆角（0=方形, 30=圆形） */
            --app-icon-font: 28px;
            /* 图标内字体大小 */
            --app-label-font: 12px;
            /* 图标标签字号 */
            --app-label-width: 90px;
            /* 图标标签最大宽度 */

            /* ========== 个人资料卡片布局 ========== */
            --profile-widget-top: 35px;
            /* 顶部位置 */
            --profile-widget-left: 50%;
            /* 左侧位置（水平中心） */
            --profile-widget-width: 78%;
            /* 宽度 */
            --profile-widget-height: 260px;
            /* 高度 */
            --profile-widget-radius: 26px;
            /* 圆角 */
            --profile-card-padding: 24px;
            /* 内边距 */
            --profile-avatar-size: 90px;
            /* 头像大小 */
            --profile-avatar-border-width: 3px;
            /* 头像边框宽度 */
            --profile-avatar-font: 42px;
            /* 头像图标大小 */

            /* ========== 备忘录卡片布局 ========== */
            --memo-card-top: 380px;
            /* 顶部位置 */
            --memo-card-left: 7%;
            /* 左侧位置 */
            --memo-card-width: 38%;
            /* 宽度 */
            --memo-card-height: 165px;
            /* 高度 */
            --memo-card-radius: 20px;
            /* 圆角 */
            --memo-header-height: 40px;
            /* 标题栏高度 */
            --memo-header-padding: 0 14px;
            /* 标题栏内边距 */
            --memo-header-gap: 8px;
            /* 标题栏间距 */
            --memo-content-padding: 12px 14px;
            /* 内容区内边距 */

            /* ========== 右侧图标区域布局 ========== */
            --icon-area-top: 375px;
            /* 顶部位置 */
            --icon-area-left: 48%;
            /* 左侧位置 */
            --icon-area-width: 46%;
            /* 宽度 */
            --icon-grid-cols: 2;
            /* 列数（2x2） */
            --icon-grid-gap: 18px;
            /* 间距 */

            /* ========== Dock栏布局 ========== */
            --dock-bottom: 10px;
            /* 底部位置 */
            --dock-width: 86%;
            /* 宽度 */
            --dock-height: 85px;
            /* 高度（容器） */
            --dock-radius: 26px;
            /* 圆角 */
            --dock-padding: 12px 20px;
            /* 内边距 */
            --dock-blur: 25px;
            /* 毛玻璃模糊度 */
            --dock-icon-width: 58px;
            /* 图标宽度 */
            --dock-icon-height: 58px;
            /* 图标高度 */
            --dock-icon-radius: 18px;
            /* 图标圆角 */
            --dock-icon-font: 26px;
            /* 图标字体大小 */
            --dock-icon-gap: 45px;
            /* 图标间距 */

            /* ========== 搜索栏布局 ========== */
            --search-bar-top: 710px;
            /* 顶部位置 */
            --search-bar-width: 88%;
            /* 宽度 */
            --search-bar-height: 48px;
            /* 高度 */
            --search-bar-radius: 24px;
            /* 圆角 */

            /* 玻璃效果参数（尺寸相关，非颜色） */
            --glass-blur-size: 20px;
            /* 毛玻璃模糊度 */
            --glass-opacity-base: var(--base-opacity-65);
            /* 玻璃透明度 */
            --glass-shadow: 0 8px 32px rgba(var(--base-shadow-dark), 0.12);

            /* ========== 组件专用色 - 个人资料卡片 ========== */
            --profile-gradient-start: rgba(235, 208, 241, 0.25);
            --profile-gradient-mid: rgba(199, 175, 222, var(--base-opacity-20));
            --profile-gradient-end: rgba(244, 114, 182, 0.18);
            --profile-overlay: rgba(var(--base-shadow-dark), var(--base-opacity-30));
            --profile-text-color: var(--base-white);
            --profile-avatar-bg-start: rgba(255, 255, 255, 0.9);
            --profile-avatar-bg-end: rgba(240, 240, 255, 0.85);
            --profile-avatar-border: rgba(236, 227, 235, var(--base-opacity-50));
            --profile-avatar-icon-color: #dfddeb;

            /* ========== 组件专用色 - 备忘录卡片 ========== */
            --memo-header-bg: #dcd1e4;
            --memo-content-bg: #f3f0f0;
            --memo-title-color: #928989;
            --memo-icon-color: rgba(227, 217, 217, 0.6);
            --memo-divider: rgba(var(--base-shadow-dark), 0.12);
            --memo-shadow: rgba(var(--base-shadow-dark), var(--base-opacity-10));
            --memo-content-text: #e8e2e2;
            /* 内容文字颜色 */

            /* ========== 光效系统 - 玻璃质感多层效果 ========== */
            /* 环境光层 */
            --ambient-light-color-1: rgba(255, 255, 255, 0.42);
            /* 环境光1 */
            --ambient-light-color-2: rgba(217, 228, 238, 0.35);
            /* 环境光2 */
            --ambient-light-color-3: rgba(235, 241, 247, 0.36);
            /* 环境光3 */
            --ambient-light-blur: 10px;
            /* 环境光模糊 */

            /* 顶部高光层 */
            --highlight-top-color: rgba(255, 255, 255, 0.66);
            /* 高光颜色 */
            --highlight-mid-color: rgba(255, 255, 255, 0.1);
            /* 高光中层 */
            --highlight-end-color: rgba(255, 255, 255, 0);
            /* 高光消散 */
            --highlight-opacity: 0.58;
            /* 高光透明度 */
            --highlight-blur: 0px;
            /* 高光模糊 */
            --highlight-rotate: -6deg;
            /* 高光旋转 */

            /* 渐变顶层 */
            --gradient-top-color: rgba(255, 255, 255, 0.46);
            /* 渐变顶部 */
            --gradient-mid-color: rgba(255, 255, 255, 0.14);
            /* 渐变中部 */
            --gradient-end-color: rgba(255, 255, 255, 0);
            /* 渐变末端 */

            /* 内阴影 */
            --inner-shadow-top: inset 0 1px 0 rgba(255, 255, 255, 0.62);
            --inner-shadow-bottom: inset 0 -18px 30px rgba(218, 227, 237, 0.12);

            /* 备忘录卡片光效 */
            --memo-inner-shadow-top: inset 0 1px 0 rgba(255, 255, 255, 0.66);
            --memo-inner-shadow-bottom: inset 0 -8px 12px rgba(200, 210, 220, 0.08);

            /* Dock 光效 */
            --dock-inner-shadow-top: inset 0 2px 8px rgba(255, 255, 255, 0.4);
            --dock-inner-shadow-bottom: inset 0 -6px 16px rgba(0, 0, 0, 0.08);

            /* 搜索栏颜色 */
            --search-bg: rgba(255, 255, 255, 0.7);
            /* 背景色 */
            --search-text-color: #333;
            /* 文字颜色 */
            --search-placeholder-color: #999;
            /* 占位符颜色 */
            --search-icon-color: #666;
            /* 图标颜色 */

            /* Dock大容器颜色 */
            --dock-container-bg: rgba(255, 255, 255, 0.55);
            /* Dock容器背景 */
            --dock-container-border: rgba(255, 255, 255, 0.3);
            /* Dock容器边框 */

            /* 主屏高级玻璃（可自由改色） */
            --home-shell-bg-start: #edf2f6;
            --home-shell-bg-mid: #e8edf2;
            --home-shell-bg-end: #e3e9ef;
            --home-shell-border: rgba(255, 255, 255, 0.68);
            --home-shell-shadow: 0 26px 52px rgba(113, 128, 150, 0.16);

            --home-card-bg-start: rgba(255, 255, 255, 0.28);
            --home-card-bg-mid: rgba(243, 248, 253, 0.20);
            --home-card-bg-end: rgba(226, 236, 247, 0.24);
            --home-card-border: rgba(255, 255, 255, 0.50);

            --home-memo-bg-start: rgba(255, 255, 255, 0.36);
            --home-memo-bg-end: rgba(243, 248, 253, 0.24);
            --home-memo-border: rgba(255, 255, 255, 0.48);

            --home-icon-base-start: rgba(246, 250, 255, 0.55);
            --home-icon-base-end: rgba(218, 229, 239, 0.52);
            --home-icon-border: rgba(255, 255, 255, 0.56);
            --home-icon-fg: rgba(245, 250, 255, 0.96);

            --home-icon-message-start: rgba(240, 247, 255, 0.60);
            --home-icon-message-end: rgba(206, 220, 236, 0.56);
            --home-icon-chat-start: rgba(236, 246, 255, 0.60);
            --home-icon-chat-end: rgba(205, 221, 238, 0.56);
            --home-icon-worldbook-start: rgba(238, 247, 255, 0.60);
            --home-icon-worldbook-end: rgba(203, 218, 236, 0.56);
            --home-icon-settings-start: rgba(241, 248, 255, 0.60);
            --home-icon-settings-end: rgba(208, 224, 238, 0.56);

            --home-dock-bg-start: rgba(249, 252, 255, 0.50);
            --home-dock-bg-end: rgba(239, 246, 252, 0.35);
            --home-dock-border: rgba(255, 255, 255, 0.58);
        }

        /* ============================================================
           全局基础样式
           ============================================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background: linear-gradient(135deg,
                    #f5f8fa 0%,
                    #eef4f8 50%,
                    #f0f6fa 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ============================================================
           动画效果定义
           ============================================================ */

        @keyframes fade-in-scale {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-fade-in-scale {
            animation: fade-in-scale 0.3s ease-out forwards;
            will-change: transform, opacity;
        }

        .widget {
            border-radius: 26px;
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            box-shadow: var(--box-shadow);
        }

        /* ============================================================
           iPhone特定UI样式 - 刘海、圆角、状态栏等
           如需切换到其他UI风格，重点修改此部分
           ============================================================ */

        .iphone-container {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            background-color: var(--color-background);
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            overscroll-behavior: contain;
        }

        .status-bar {
            height: 50px;
            background: var(--status-bar-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 26px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--color-text);
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid var(--status-border);
            position: sticky;
            top: 0;
            z-index: 101;
        }

        /* 非主屏幕页面的状态栏统一与返回栏保持玻璃拟态 */
        /* 使用通用选择器确保所有弹窗页面的状态栏都是玻璃拟态，无需手动添加 */
        .modal .status-bar {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
        }

        .time {
            font-weight: 700;
        }

        .status-icons i {
            margin-left: 6px;
        }

        .main-content {
            flex: 1;
            padding: 20px 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .home-screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: visible;
        }

        /* ========== 玻璃质感组件系统 ========== */

        /* 个人资料大卡片 */
        .profile-widget-glass {
            position: absolute;
            top: var(--profile-widget-top);
            left: var(--profile-widget-left);
            transform: translateX(-50%);
            width: var(--profile-widget-width);
            height: var(--profile-widget-height);
            background: linear-gradient(135deg, var(--profile-gradient-start) 0%, var(--profile-gradient-mid) 50%, var(--profile-gradient-end) 100%);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border-radius: var(--profile-widget-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding: var(--profile-card-padding);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow: hidden;
        }

        .profile-widget-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(180deg, var(--profile-overlay) 0%, transparent 100%);
            pointer-events: none;
        }

        .profile-avatar-circle {
            width: var(--profile-avatar-size);
            height: var(--profile-avatar-size);
            border-radius: 50%;
            background: linear-gradient(135deg, var(--profile-avatar-bg-start), var(--profile-avatar-bg-end));
            border: var(--profile-avatar-border-width) solid var(--profile-avatar-border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--profile-avatar-font);
            color: var(--profile-avatar-icon-color);
            margin: 0 auto 16px;
            position: relative;
            z-index: 2;
        }

        .profile-info {
            text-align: center;
            color: var(--profile-text-color);
            position: relative;
            z-index: 2;
        }

        .profile-username {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-handle {
            font-size: 13px;
            opacity: 0.85;
            margin-bottom: 8px;
        }

        .profile-bio {
            font-size: 12px;
            opacity: 0.75;
            margin-bottom: 6px;
        }

        .profile-location {
            font-size: 12px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        /* iOS备忘录卡片 */
        .memo-card {
            position: absolute;
            top: var(--memo-card-top);
            left: var(--memo-card-left);
            width: var(--memo-card-width);
            height: var(--memo-card-height);
            border-radius: var(--memo-card-radius);
            overflow: hidden;
            box-shadow: 0 4px 16px var(--memo-shadow);
            display: flex;
            flex-direction: column;
        }

        .memo-header {
            height: var(--memo-header-height);
            background: var(--memo-header-bg);
            display: flex;
            align-items: center;
            padding: var(--memo-header-padding);
            gap: var(--memo-header-gap);
            border-bottom: 1px dashed var(--memo-divider);
        }

        .memo-header i {
            font-size: 16px;
            color: var(--memo-icon-color);
        }

        .memo-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--memo-title-color);
        }

        .memo-content {
            flex: 1;
            background: var(--memo-content-bg);
            padding: var(--memo-content-padding);
            font-size: 13px;
            color: var(--memo-content-text);
            line-height: 1.5;
        }

        /* 右侧图标区域 */
        .icon-area-glass {
            position: absolute;
            top: var(--icon-area-top);
            left: var(--icon-area-left);
            width: var(--icon-area-width);
            display: grid;
            grid-template-columns: repeat(var(--icon-grid-cols), 1fr);
            gap: var(--icon-grid-gap);
            align-items: start;
        }

        .icon-area-glass .app-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        /* ========== 主屏幕图标网格布局 ========== */
        .app-grid {
            display: none;
            /* 隐藏旧的网格布局，使用新的玻璃效果布局 */
            width: 88%;
            grid-template-columns: repeat(var(--grid-columns), minmax(0, 1fr));
            grid-auto-rows: var(--grid-row-height);
            gap: var(--grid-gap);
            justify-items: center;
            align-items: start;
        }

        .app-grid-offset {
            margin-top: var(--grid-offset-top);
        }

        .app-item {
            width: 100%;
            max-width: var(--app-label-width);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            position: relative;
        }

        /* ========== 主屏幕图标样式 ========== */
        .app-icon {
            width: var(--app-icon-size);
            height: var(--app-icon-size);
            border-radius: var(--app-icon-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--app-icon-font);
            color: white;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.15s ease;
            cursor: pointer;
        }

        .app-item:hover .app-icon {
            transform: translateY(-4px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .app-name {
            font-size: var(--app-label-font);
            color: var(--color-text);
            max-width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }



        /* ========== 各个图标的配色方案 (✅ 可以随意修改) ========== */
        /* 你可以改变任何颜色、渐变角度、透明度等，不会影响布局 */

        .message-icon {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
        }

        .chat-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-accent-pink) 100%);
        }

        .worldbook-icon {
            background: linear-gradient(135deg, var(--color-accent-blue) 0%, var(--color-accent-lavender) 100%);
        }

        .feixin-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
        }

        .book-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        }

        .settings-icon {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent) 100%);
        }

        .brush-icon {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
        }

        /* 内容页面图标（黑色） */
        .content-icon {
            color: #444;
        }

        /* ========== 底部Dock柔光毛玻璃 (中等大小极简风格) ========== */
        .dock-glass {
            position: absolute;
            bottom: var(--dock-bottom);
            left: 50%;
            transform: translateX(-50%);
            width: var(--dock-width);
            height: var(--dock-height);
            background: var(--dock-container-bg);
            backdrop-filter: blur(var(--dock-blur));
            -webkit-backdrop-filter: blur(var(--dock-blur));
            border-radius: var(--dock-radius);
            border: 1px solid var(--dock-container-border);
            box-shadow:
                0 6px 24px rgba(0, 0, 0, 0.08),
                var(--dock-inner-shadow-top),
                var(--dock-inner-shadow-bottom);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--dock-icon-gap);
            padding: var(--dock-padding);
        }

        /* ========== Dock图标样式 (中等尺寸柔光设计) ========== */
        .dock-icon-glass {
            width: var(--dock-icon-width);
            height: var(--dock-icon-height);
            border-radius: var(--dock-icon-radius);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: var(--dock-icon-font);
            color: white;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.12),
                var(--dock-inner-shadow-top);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .dock-icon-glass:hover {
            transform: scale(1.06) translateY(-2px);
            box-shadow:
                0 6px 20px rgba(0, 0, 0, 0.18),
                var(--dock-inner-shadow-top);
        }

        .dock-icon-glass:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* ========== Dock图标配色 (柔光渐变) ========== */
        .dock-phone {
            background: linear-gradient(135deg, #A8A4CE 0%, #9B97C8 100%);
        }

        .dock-novel {
            background: linear-gradient(135deg, #C4B5E0 0%, #B5A1D8 100%);
        }

        .dock-forum {
            background: linear-gradient(135deg, #B8C4E0 0%, #A5B3D5 100%);
        }

        /* ========== 主屏幕高级玻璃质感升级（不改布局） ========== */
        .iphone-container {
            background:
                linear-gradient(160deg, var(--home-shell-bg-start) 0%, var(--home-shell-bg-mid) 42%, var(--home-shell-bg-end) 100%);
            border: 1px solid var(--home-shell-border);
            box-shadow:
                var(--home-shell-shadow),
                inset 0 1px 0 rgba(255, 255, 255, 0.78);
        }

        .iphone-container::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(120% 60% at 10% 0%, rgba(255, 255, 255, 0.55) 0%, rgba(255, 255, 255, 0) 56%),
                radial-gradient(90% 52% at 88% 86%, rgba(212, 222, 234, 0.35) 0%, rgba(212, 222, 234, 0) 66%);
            mix-blend-mode: screen;
            opacity: 0.9;
            z-index: 0;
        }

        .iphone-container>.status-bar,
        .iphone-container>.main-content {
            position: relative;
            z-index: 1;
        }

        .iphone-container>.dock-glass {
            z-index: 1;
        }

        .iphone-container>.status-bar {
            background: rgba(248, 251, 255, 0.52);
            backdrop-filter: blur(20px) saturate(145%);
            -webkit-backdrop-filter: blur(20px) saturate(145%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.62);
        }

        .home-screen {
            isolation: isolate;
        }

        .home-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(260px 180px at 15% 26%, var(--ambient-light-color-1) 0%, rgba(255, 255, 255, 0) 72%),
                radial-gradient(320px 210px at 83% 38%, var(--ambient-light-color-2) 0%, rgba(217, 228, 238, 0) 74%),
                radial-gradient(240px 170px at 42% 74%, var(--ambient-light-color-3) 0%, rgba(235, 241, 247, 0) 76%);
            filter: blur(var(--ambient-light-blur));
            z-index: -1;
        }

        .profile-widget-glass {
            background: linear-gradient(158deg, var(--home-card-bg-start) 0%, var(--home-card-bg-mid) 45%, var(--home-card-bg-end) 100%);
            backdrop-filter: blur(34px) saturate(156%);
            -webkit-backdrop-filter: blur(34px) saturate(156%);
            border: 1px solid var(--home-card-border);
            box-shadow:
                0 22px 48px rgba(119, 133, 152, 0.22),
                var(--inner-shadow-top),
                var(--inner-shadow-bottom);
        }

        .profile-widget-glass::before {
            height: 100%;
            background: linear-gradient(180deg, var(--gradient-top-color) 0%, var(--gradient-mid-color) 38%, var(--gradient-end-color) 100%);
            pointer-events: none;
        }

        .profile-widget-glass::after {
            content: '';
            position: absolute;
            top: 2%;
            left: 6%;
            width: 74%;
            height: 36%;
            border-radius: 40px;
            background: linear-gradient(124deg, var(--highlight-top-color) 0%, var(--highlight-mid-color) 62%, var(--highlight-end-color) 100%);
            filter: blur(var(--highlight-blur));
            transform: rotate(var(--highlight-rotate));
            opacity: var(--highlight-opacity);
            pointer-events: none;
        }

        .profile-avatar-circle {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(232, 239, 248, 0.84));
            border: 2px solid rgba(255, 255, 255, 0.74);
            box-shadow:
                0 10px 28px rgba(108, 124, 145, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.95);
        }

        .profile-info {
            color: rgba(246, 250, 255, 0.95);
            text-shadow: 0 2px 10px rgba(80, 96, 120, 0.18);
        }

        .memo-card {
            background: linear-gradient(160deg, var(--home-memo-bg-start) 0%, var(--home-memo-bg-end) 100%);
            backdrop-filter: blur(26px) saturate(145%);
            -webkit-backdrop-filter: blur(26px) saturate(145%);
            border: 1px solid var(--home-memo-border);
            box-shadow:
                0 18px 40px rgba(116, 130, 149, 0.2),
                var(--memo-inner-shadow-top),
                var(--memo-inner-shadow-bottom);
        }

        .memo-header {
            background: linear-gradient(180deg, rgba(240, 246, 252, 0.8) 0%, rgba(231, 239, 248, 0.56) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.58);
        }

        .memo-content {
            background: linear-gradient(180deg, rgba(251, 253, 255, 0.72) 0%, rgba(242, 248, 253, 0.52) 100%);
            color: rgba(132, 146, 163, 0.72);
        }

        .app-icon,
        .dock-icon-glass {
            background: linear-gradient(154deg, var(--home-icon-base-start) 0%, var(--home-icon-base-end) 100%);
            border: 1px solid var(--home-icon-border);
            box-shadow:
                0 10px 26px rgba(110, 124, 144, 0.19),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -8px 15px rgba(196, 210, 224, 0.22);
            color: var(--home-icon-fg);
            backdrop-filter: blur(12px) saturate(140%);
            -webkit-backdrop-filter: blur(12px) saturate(140%);
        }

        .app-icon i,
        .dock-icon-glass i {
            text-shadow: 0 1px 6px rgba(96, 114, 138, 0.25);
        }

        .message-icon,
        .dock-phone {
            background: linear-gradient(154deg, var(--home-icon-message-start) 0%, var(--home-icon-message-end) 100%);
        }

        .chat-icon,
        .dock-novel {
            background: linear-gradient(154deg, var(--home-icon-chat-start) 0%, var(--home-icon-chat-end) 100%);
        }

        .worldbook-icon,
        .dock-forum {
            background: linear-gradient(154deg, var(--home-icon-worldbook-start) 0%, var(--home-icon-worldbook-end) 100%);
        }

        .settings-icon {
            background: linear-gradient(154deg, var(--home-icon-settings-start) 0%, var(--home-icon-settings-end) 100%);
        }

        .app-name {
            color: rgba(104, 120, 138, 0.94);
            font-weight: 500;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .dock-glass {
            background: linear-gradient(180deg, var(--home-dock-bg-start) 0%, var(--home-dock-bg-end) 100%);
            backdrop-filter: blur(30px) saturate(150%);
            -webkit-backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid var(--home-dock-border);
            box-shadow:
                0 14px 34px rgba(113, 127, 146, 0.18),
                inset 0 1px 0 rgba(255, 255, 255, 0.78);
        }

        body.theme-monochrome-glass {
            --home-shell-bg-start: #efefef;
            --home-shell-bg-mid: #e8e8e8;
            --home-shell-bg-end: #e2e2e2;
            --home-card-bg-start: rgba(255, 255, 255, 0.30);
            --home-card-bg-mid: rgba(245, 245, 245, 0.22);
            --home-card-bg-end: rgba(225, 225, 225, 0.24);
            --home-memo-bg-start: rgba(255, 255, 255, 0.34);
            --home-memo-bg-end: rgba(239, 239, 239, 0.22);
            --home-icon-base-start: rgba(250, 250, 250, 0.56);
            --home-icon-base-end: rgba(222, 222, 222, 0.52);
            --home-icon-message-start: rgba(244, 244, 244, 0.62);
            --home-icon-message-end: rgba(214, 214, 214, 0.58);
            --home-icon-chat-start: rgba(244, 244, 244, 0.62);
            --home-icon-chat-end: rgba(214, 214, 214, 0.58);
            --home-icon-worldbook-start: rgba(244, 244, 244, 0.62);
            --home-icon-worldbook-end: rgba(214, 214, 214, 0.58);
            --home-icon-settings-start: rgba(244, 244, 244, 0.62);
            --home-icon-settings-end: rgba(214, 214, 214, 0.58);
            --home-dock-bg-start: rgba(252, 252, 252, 0.52);
            --home-dock-bg-end: rgba(236, 236, 236, 0.36);
            --home-icon-fg: rgba(250, 250, 250, 0.98);
        }

        /* ============================================================
           通用组件样式 - 模态窗口、弹窗、小部件等
           这些样式可跨UI主题复用
           ============================================================ */

        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-darker);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--color-bg-white);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px var(--shadow-color-strong);
            animation: modalSlideIn 0.3s ease;
        }

        /* API 配置弹窗全屏（手机内）样式 */
        #apiModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #apiModal .modal-header {
            border-bottom: 1px solid var(--color-border-lighter);
            /* padding由统一适配逻辑控制 */
        }

        #apiModal .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 22px 26px;
        }

        #apiModal .form-control {
            border-radius: 14px;
        }

        #apiModal .btn {
            border-radius: 14px;
        }

        .model-picker {
            position: relative;
            width: 100%;
        }

        .model-picker-button {
            width: 100%;
            height: 44px;
            padding: 0 14px;
            border: 1px solid var(--color-border);
            border-radius: 14px;
            background: var(--color-bg-white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: var(--color-text-dark);
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .model-picker-button:focus-visible {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px var(--color-bg-user-msg);
        }

        .model-picker-button .caret {
            margin-left: 10px;
            font-size: 12px;
            color: var(--color-text-light);
        }

        .model-picker-list {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            max-height: 260px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-light);
            border-radius: 14px;
            box-shadow: 0 12px 24px var(--shadow-color-medium);
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .model-picker-list.is-open {
            display: block;
        }

        .model-picker-item {
            width: 100%;
            text-align: left;
            background: transparent;
            border: none;
            padding: 10px 12px;
            font-size: 14px;
            color: var(--color-text-dark);
            cursor: pointer;
        }

        .model-picker-item:hover {
            background: var(--color-widget-bg);
        }

        .model-picker-item.is-selected {
            background: var(--color-bg-selected);
            color: var(--color-primary);
            font-weight: 600;
        }

        /* 聊天模态窗口全屏样式 */
        #chatModal {
            position: fixed;
            background-color: transparent;
            justify-content: center;
            align-items: center;
        }

        #chatModal .modal-content {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg-white);
            animation: none;
            overflow: hidden;
            position: relative;
        }

        /* 聊天页消息区覆盖通用样式，避免底部出现多余分隔缝 */
        #chatModal #chatMessages {
            margin-bottom: 0;
        }

        #chatModal .modal-header {
            background: var(--chat-header-bg);
            backdrop-filter: var(--chat-header-blur);
            -webkit-backdrop-filter: var(--chat-header-blur);
            border-bottom: 1px solid var(--chat-header-border);
            display: flex;
            align-items: center;
            /* padding和height由统一适配逻辑控制 */
        }

        #chatModal .modal-header h3 {
            flex: 1;
            text-align: center;
            margin: 0;
            color: var(--color-text);
            font-size: 18px;
            font-weight: 600;
        }

        /* API警告样式 */
        .api-warning {
            background-color: var(--color-warning-bg);
            border-bottom: 1px solid var(--color-warning-border);
            padding: 12px 20px;
            color: var(--color-warning-text);
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }

        .preset-drawer-item:hover {
            background: var(--color-bg-disabled) !important;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--color-text-dark);
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--color-text-light);
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-close:hover {
            background-color: var(--color-bg-light);
        }

        /* 自定义错误弹窗样式 */
        #customErrorModal .modal-content {
            width: 80%;
            max-width: 350px;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            animation: fade-in-scale 0.3s ease-out forwards;
        }

        #customErrorModal h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 12px;
        }

        #customErrorModal p {
            font-size: 14px;
            color: var(--color-text-medium);
            margin-bottom: 24px;
            word-break: break-all;
        }

        #customErrorModal .btn {
            width: 100%;
            height: 44px;
            border-radius: 12px;
        }

        .cute-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: cute-toast-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cute-toast-pop {
            from {
                transform: translate(-50%, -50%) scale(0.3);
                opacity: 0;
            }

            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .cute-toast-content {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary) 100%);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(222, 190, 235, 0.25);
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .cute-toast-content p {
            color: var(--color-bg-white);
            font-size: 13px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* 消息通知横幅 */
        .msg-notif-banner {
            position: fixed;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 400px;
            background: var(--color-bg-white);
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            padding: 12px 14px;
            gap: 12px;
            z-index: 10000;
            transition: top 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        .msg-notif-banner.is-visible {
            top: 36px;
        }

        .msg-notif-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: var(--color-bg-white);
            font-size: 16px;
        }

        .msg-notif-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .msg-notif-body {
            flex: 1;
            min-width: 0;
        }

        .msg-notif-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-darker);
            line-height: 1.3;
        }

        .msg-notif-text {
            font-size: 13px;
            color: var(--color-text-placeholder);
            line-height: 1.3;
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 聊天窗口按钮样式 */
        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button id="backToFriendList"><i class="fas fa-chevron-left"></i></button> */
        #backToFriendList {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--color-text);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
            margin-right: 10px;
        }


        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-text);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            height: 48px;
            padding: 0 18px;
            border: 1.5px solid var(--glass-border-icon);
            border-radius: 16px;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--glass-bg-light);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: var(--color-text-dark);
            font-weight: 400;
        }

        textarea.form-control {
            height: auto;
            padding: 14px 18px;
            min-height: 48px;
            resize: none;
        }

        #modelSelect {
            height: 48px;
            background: var(--glass-bg-light);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 4px 16px var(--shadow-color-light);
            background: var(--glass-bg-strong);
        }

        /* 占位符样式 */
        .form-control::placeholder,
        .form-control::-webkit-input-placeholder {
            color: var(--color-text-light);
            opacity: 0.7;
            font-weight: 300;
        }

        .form-control::-moz-placeholder {
            color: var(--color-text-light);
            opacity: 0.7;
            font-weight: 300;
        }

        .input-hint {
            margin-top: 6px;
            color: var(--color-text-light);
            font-size: 12px;
        }

        .btn {
            padding: 14px 24px;
            height: 50px;
            border: 1.5px solid var(--glass-border-light);
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.3px;
        }

        .btn-primary {
            background: linear-gradient(135deg,
                    var(--avatar-gradient-start) 0%,
                    var(--color-primary) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: var(--color-text-darker);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color-medium);
            background: linear-gradient(135deg,
                    var(--color-primary) 0%,
                    var(--color-secondary) 100%);
            border-color: var(--glass-border-stronger);
        }

        .btn-secondary {
            background: var(--color-widget-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            color: var(--color-text-medium);
        }

        .btn-secondary:hover {
            background: var(--color-bg-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-color-light);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 13px;
            white-space: nowrap;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* 状态消息样式 */
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background-color: var(--color-success-bg, rgba(72, 187, 120, 0.1));
            color: var(--color-success);
            border: 1px solid var(--color-success-border, rgba(72, 187, 120, 0.2));
            display: block;
        }

        .status-message.error {
            background-color: var(--color-error-bg, rgba(245, 101, 101, 0.1));
            color: var(--color-error);
            border: 1px solid var(--color-error-border, rgba(245, 101, 101, 0.2));
            display: block;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-widget-bg);
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 聊天界面样式 */
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--color-widget-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--color-bg-white);
            /* 禁用系统长按菜单和文本选择 */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: contain;
        }

        /* ============================================================
           聊天消息样式 — QQ风格头像+气泡布局
           ============================================================ */

        /* 消息行：头像 + 气泡内容 */
        .message-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 8px;
            animation: messageAppear 0.3s ease-out;
        }

        .message-row.user {
            flex-direction: row-reverse;
        }

        .message-row.ai {
            flex-direction: row;
        }

        /* 消息头像 */
        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
            background: var(--color-bg-light);
            box-shadow: 0 1px 4px var(--shadow-color-light);
        }

        .msg-avatar.square {
            border-radius: 6px;
        }

        .msg-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .msg-avatar .avatar-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--avatar-gradient-start), var(--avatar-gradient-end));
            color: var(--icon-color);
            font-size: 16px;
        }

        /* 消息内容区 */
        .msg-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .message-row.user .msg-content {
            align-items: flex-end;
        }

        .message-row.ai .msg-content {
            align-items: flex-start;
        }

        .message {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 100%;
            width: fit-content;
            word-wrap: break-word;
            word-break: break-word;
            font-size: 15px;
            line-height: 1.5;
            box-shadow: 0 1px 4px var(--shadow-color-light);
            height: auto;
            min-height: auto;
            overflow: visible;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-touch-callout: none;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user,
        .message.ai {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .message.user {
            background-color: var(--color-bg-user-msg) !important;
            color: var(--color-text-darker);
            border-bottom-right-radius: 4px;
        }

        .message.ai,
        .message.assistant {
            background-color: var(--color-bg-ai-msg) !important;
            color: var(--color-text-darker);
            border-bottom-left-radius: 4px;
        }

        .reply-quote {
            max-width: 100%;
            font-size: 12px;
            color: var(--color-text-medium);
            background: var(--color-bg-pressed);
            padding: 6px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid var(--color-border);
            word-break: break-word;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .reply-preview {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 10px;
            background: var(--color-bg-light);
            color: var(--color-text-medium);
            font-size: 12px;
            margin: 0 !important;
        }

        .reply-preview-text {
            flex: 1;
            white-space: normal;
            overflow: visible;
            word-break: break-word;
        }

        .reply-preview-close {
            border: none;
            background: transparent;
            color: var(--color-text-light);
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .image-upload-pill {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 12px;
            background: var(--color-widget-bg);
            color: var(--color-primary);
            font-size: 12px;
            margin: 0 !important;
            border: 1px dashed var(--glass-border-light);
        }

        .image-upload-thumb {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 2px 6px var(--shadow-color-light);
        }

        .image-upload-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-upload-close {
            border: none;
            background: transparent;
            color: var(--color-primary);
            font-size: 16px;
            cursor: pointer;
            line-height: 1;
        }

        .message-image {
            display: block;
            width: 100%;
            max-width: 220px;
            border-radius: 12px;
            margin-top: 6px;
            box-shadow: 0 4px 12px var(--shadow-color-medium);
        }

        .message-image-wrap {
            position: relative;
            display: inline-block;
            margin-top: 6px;
            border-radius: 12px;
            overflow: hidden;
        }

        .message-image.desc-thumb {
            width: 120px;
            height: 120px;
            max-width: none;
            object-fit: cover;
            border-radius: 12px;
        }

        .message-image-hint {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--icon-color);
            text-shadow: 0 1px 2px var(--shadow-color-strong);
            pointer-events: none;
        }

        .image-desc-box {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 12px;
            resize: none;
            height: 110px;
            font-size: 14px;
            font-family: inherit;
            background: var(--color-bg-hover);
            color: var(--color-text-dark);
        }

        .image-confirm-popover {
            position: fixed;
            display: none;
            z-index: 2300;
            background: var(--glass-bg-stronger);
            border-radius: 12px;
            padding: 8px 10px;
            box-shadow: 0 10px 25px var(--shadow-color-hover);
            font-size: 12px;
            color: var(--color-text-dark);
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .image-confirm-actions {
            display: flex;
            gap: 8px;
        }

        .image-confirm-btn {
            border: none;
            border-radius: 10px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .image-confirm-btn.yes {
            background: var(--color-primary);
            color: var(--color-bg-white);
        }

        .image-confirm-btn.no {
            background: var(--color-border-lighter);
            color: var(--color-text-medium);
        }

        .message-recalled-wrapper {
            display: flex;
            justify-content: center;
        }

        .message-recalled {
            font-size: 12px;
            color: var(--color-text-light);
            background: var(--color-bg-pressed);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .message-action-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2200;
            background: var(--overlay-bg, rgba(0, 0, 0, 0.05));
        }

        .message-action-menu {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            background: var(--glass-bg-stronger);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px var(--shadow-color-hover);
            transform: scale(0.96);
            opacity: 0;
            transition: transform 0.16s ease, opacity 0.16s ease;
        }

        .message-action-menu.is-open {
            transform: scale(1);
            opacity: 1;
        }

        .message-action-item {
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: var(--color-text-dark);
            border-radius: 12px;
            padding: 6px 8px;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.15s ease, background 0.2s ease;
        }

        .message-action-item i {
            font-size: 16px;
        }

        .message-action-item:active {
            transform: scale(0.95);
        }

        .message-action-item.is-disabled {
            opacity: 0.45;
            pointer-events: none;
        }

        /* ========== 多选模式样式 ========== */
        .multi-select-header {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
        }

        .multi-select-header .multi-select-count {
            flex: 1;
            text-align: center;
            color: var(--color-text);
            font-size: 16px;
            font-weight: 600;
        }

        .multi-select-header .multi-select-cancel-btn {
            background: none;
            border: none;
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .multi-select-header .multi-select-cancel-btn:active {
            background-color: var(--color-widget-bg);
        }

        .multi-select-footer {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 14px;
            padding: 14px 12px 18px;
            background: var(--color-bg-white);
            border-top: 1px solid var(--glass-border-light);
            flex-shrink: 0;
        }

        .multi-select-forward-btn {
            min-width: 122px;
            height: 46px;
            border-radius: 24px;
            border: none;
            background-color: var(--color-button-primary);
            color: var(--color-text-dark);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 0 16px;
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .multi-select-forward-btn:active {
            transform: scale(0.96);
            background-color: var(--color-bg-active);
        }

        .forward-friend-overlay,
        .forward-record-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2300;
            align-items: center;
            justify-content: center;
            padding: 14px;
            box-sizing: border-box;
            background: var(--overlay-dark);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .forward-friend-box {
            width: min(80vw, 320px);
            max-height: min(72vh, 560px);
            overflow: hidden;
            border-radius: 22px;
            background: var(--glass-bg-stronger);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border-white);
            box-shadow: var(--box-shadow-hover);
            display: flex;
            flex-direction: column;
        }

        .forward-friend-head {
            padding: 14px 16px 10px;
            border-bottom: 1px solid var(--glass-border-strong);
        }

        .forward-friend-head h3 {
            margin: 0;
            color: var(--color-text-dark);
            font-size: 15px;
            font-weight: 700;
        }

        .forward-friend-list {
            overflow-y: auto;
            padding: 8px 10px 10px;
        }

        .forward-friend-item {
            width: 100%;
            border: none;
            background: var(--color-bg-light);
            border-radius: 14px;
            margin-bottom: 8px;
            padding: 11px 12px;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text-medium);
            cursor: pointer;
        }

        .forward-friend-item:active {
            transform: scale(0.985);
            background: var(--color-bg-hover);
        }

        .forward-friend-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-light);
            flex-shrink: 0;
        }

        .forward-friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .forward-friend-actions {
            display: flex;
            gap: 10px;
            padding: 12px 12px 14px;
            border-top: 1px solid var(--glass-border-light);
            background: var(--glass-bg-light);
        }

        .forward-friend-actions button {
            flex: 1;
            border: none;
            border-radius: 12px;
            height: 40px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        #forwardFriendCancelBtn {
            color: var(--color-text-medium);
            background: var(--color-bg-light);
        }

        #forwardFriendCancelBtn:active {
            background: var(--color-bg-hover);
        }

        .forward-friend-actions button:not(#forwardFriendCancelBtn) {
            background-color: var(--color-button-primary);
            color: var(--color-text-dark);
            box-shadow: var(--box-shadow-light);
        }

        .forward-friend-actions button:not(#forwardFriendCancelBtn):active {
            transform: scale(0.96);
            background-color: var(--color-bg-active);
        }

        .forward-empty {
            color: var(--color-text-lighter);
            font-size: 13px;
            text-align: center;
            padding: 18px 12px 22px;
        }

        .forward-bundle-card {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            min-width: 176px;
            max-width: 280px;
            padding: 10px 12px;
            cursor: pointer;
            box-shadow: var(--box-shadow-light);
            transition: all 0.2s ease;
        }

        .forward-bundle-card:active {
            transform: scale(0.98);
            box-shadow: var(--box-shadow);
        }

        .forward-bundle-title {
            color: var(--color-text-dark);
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .forward-bundle-preview {
            color: var(--color-text-light);
            font-size: 12px;
            line-height: 1.4;
        }

        .forward-record-page {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(85vw, 340px);
            height: min(65vh, 520px);
            background: var(--glass-bg-stronger);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border-radius: 20px;
            border: 1px solid var(--glass-border-white);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow-hover);
        }

        .forward-record-header {
            height: 52px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            border-bottom: 1px solid var(--glass-border-strong);
            background: var(--glass-bg-light);
        }

        #forwardRecordBackBtn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: var(--color-bg-light);
            color: var(--color-text-medium);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #forwardRecordBackBtn:active {
            background: var(--color-bg-hover);
            transform: scale(0.93);
        }

        .forward-record-title {
            color: var(--color-text-dark);
            font-size: 15px;
            font-weight: 700;
        }

        .forward-record-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px 12px 14px;
            background: var(--color-background);
        }

        .forward-record-tip {
            color: var(--color-text-light);
            background: var(--color-bg-light);
            font-size: 12px;
            border-radius: 12px;
            padding: 7px 10px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border-light);
        }

        .forward-record-msg {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .forward-record-name {
            color: var(--color-text-light);
            font-size: 12px;
            margin: 0 0 4px 2px;
        }

        .forward-record-bubble {
            max-width: 86%;
            background: var(--color-bg-white);
            border: 1px solid var(--glass-border-light);
            border-radius: 12px;
            padding: 8px 10px;
            color: var(--color-text-dark);
            font-size: 13px;
            line-height: 1.45;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: var(--box-shadow-light);
        }

        .forward-record-bubble img {
            width: 170px;
            max-width: 100%;
            border-radius: 10px;
            display: block;
            margin-bottom: 6px;
        }

        .forward-record-voice {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--color-text-light);
            font-size: 12px;
            margin-bottom: 4px;
        }

        .multi-select-checkbox {
            display: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--color-border-input);
            background-color: var(--color-bg-white);
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            align-self: center;
        }

        .multi-select-checkbox.is-checked {
            border-color: var(--color-primary);
            background-color: var(--color-primary);
        }

        .multi-select-checkbox.is-checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
            color: var(--color-bg-white);
        }

        body.multi-select-active #chatMessages>.message-row {
            cursor: pointer;
        }

        body.multi-select-active #chatMessages div[data-msg-id] .multi-select-checkbox {
            display: flex;
        }

        .multi-select-confirm-overlay {
            position: fixed;
            inset: 0;
            display: none;
            z-index: 2001;
            background-color: var(--overlay-dark, rgba(0, 0, 0, 0.3));
            justify-content: center;
            align-items: center;
        }

        .multi-select-confirm-box {
            background-color: var(--color-bg-white);
            border-radius: 30px;
            padding: 20px 25px;
            width: 75%;
            max-width: 260px;
            box-shadow: 0 10px 40px var(--shadow-color-medium);
            text-align: center;
        }

        .multi-select-confirm-box h3 {
            margin: 0 0 10px 0;
            color: var(--color-text);
            font-size: 15px;
            font-weight: 600;
        }

        .multi-select-confirm-box p {
            margin: 0 0 15px 0;
            color: var(--color-text);
            font-size: 13px;
        }

        .multi-select-confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .multi-select-confirm-actions button {
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            min-width: 70px;
            transition: all 0.2s ease;
        }

        #multiSelectConfirmYes {
            background-color: var(--color-danger);
            color: white;
            border: none;
        }

        #multiSelectConfirmNo {
            background-color: white;
            color: var(--color-text);
            border: 1px solid var(--color-widget-bg);
        }

        /* ========== 编辑消息弹窗 ========== */
        .message-edit-overlay {
            position: fixed;
            inset: 0;
            z-index: 2001;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .message-edit-box {
            background-color: var(--color-bg-white);
            border-radius: 30px;
            padding: 24px;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 10px 40px var(--shadow-color-medium);
        }

        .message-edit-box h3 {
            margin: 0 0 16px 0;
            color: var(--color-text);
            font-size: 16px;
            font-weight: 600;
        }

        #messageEditTextarea {
            color: var(--color-text-darker) !important;
        }

        #messageEditTextarea::placeholder {
            color: var(--color-text-placeholder);
        }

        .message-edit-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .message-edit-actions button {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        #messageEditCancel {
            background-color: var(--color-bg-disabled);
            color: var(--color-text-medium);
        }

        #messageEditSave {
            background-color: var(--color-accent);
            color: var(--color-text-darker);
        }

        #messageEditSave:active {
            transform: scale(0.96);
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input-area-wrap.chat-extra-open .chat-input-row {
            display: none !important;
        }

        .chat-input-area-wrap.chat-extra-open .chat-function-row {
            display: none !important;
        }

        .chat-extra-panel {
            display: none;
            margin-top: 8px;
            padding: 12px 10px;
            border-radius: 14px;
            background: var(--color-widget-bg);
            border: 1px solid var(--color-border-light);
        }

        .chat-extra-panel.is-open {
            display: block;
        }

        .chat-extra-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px 10px;
        }

        .chat-extra-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px 6px;
            border-radius: 14px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-lighter);
            box-shadow: 0 6px 16px var(--shadow-color-light);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .chat-extra-item.is-placeholder {
            background: var(--color-bg-hover);
            border-style: dashed;
            color: var(--color-text-muted);
            cursor: default;
            box-shadow: none;
        }

        .chat-extra-item.is-placeholder .chat-extra-icon {
            background: var(--color-bg-disabled);
            color: var(--color-text-muted);
        }

        .chat-extra-item:active {
            transform: scale(0.98);
        }

        .chat-extra-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: var(--color-bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--color-text-medium);
        }

        .chat-extra-label {
            font-size: 12px;
            color: var(--color-text-medium);
            text-align: center;
            line-height: 1.2;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--color-border);
            border-radius: 20px;
            font-size: 14px;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            line-height: 20px;
        }

        .chat-send-btn {
            padding: 0 20px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 214, 215, 0.3);
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        /* 刘海模拟 */
        .notch {
            display: none;
        }

        /* 好友列表样式 */
        .friend-list {
            max-height: 100%;
            overflow-y: auto;
            padding: 16px !important;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border-light);
            box-shadow: 0 4px 12px var(--shadow-color-light);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .friend-item:hover {
            background: var(--glass-bg-stronger);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color-medium);
            border-color: var(--glass-border-stronger);
        }

        .friend-item:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px var(--shadow-color-hover);
        }

        .friend-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg,
                    var(--icon-gradient-1-start) 0%,
                    var(--icon-gradient-1-end) 100%);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: 1.5px solid var(--glass-border-white);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--icon-color-alt);
            font-size: 22px;
            margin-right: 14px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color-hover);
            flex-shrink: 0;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 600;
            color: var(--color-text-dark);
            margin-bottom: 2px;
            font-size: 15px;
            letter-spacing: 0;
        }

        .friend-persona {
            color: var(--color-text);
            font-size: 13px;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            overflow: hidden;
            line-height: 1.3;
        }

        .no-friends {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 40px 20px;
            text-align: center;
        }

        /* 头像上传样式 */
        .avatar-upload-preview {
            width: 84px;
            height: 84px;
            border: 2px dashed var(--color-primary);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background-color: var(--color-bg-hover);
            transition: border-color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
            margin: 0 auto 15px;
            color: var(--color-primary);
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .avatar-upload-preview:hover {
            border-color: var(--color-primary);
            background-color: var(--color-widget-bg);
            transform: scale(1.05);
        }

        .avatar-upload-preview i {
            font-size: 32px;
            margin-bottom: 4px;
        }

        .avatar-upload-preview p {
            font-size: 12px;
            margin: 0;
            text-align: center;
        }

        .avatar-upload-preview.has-image {
            background-color: transparent;
            border-color: transparent;
        }

        .avatar-upload-preview.has-image i,
        .avatar-upload-preview.has-image p {
            display: none;
        }

        .profile-widget-card {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.2s ease;
        }

        .profile-widget-feedback {
            position: absolute;
            inset: 0;
            background: var(--glass-bg-light);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .profile-widget-feedback.is-active {
            opacity: 1;
        }

        .settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: linear-gradient(180deg, var(--color-bg-white) 0%, var(--color-widget-bg) 100%);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .settings-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 16px;
            border-bottom: 1px solid var(--status-border-strong);
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .settings-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--color-text-dark);
            letter-spacing: 0.3px;
        }

        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button class="settings-back"><i class="fas fa-chevron-left"></i></button> */
        .settings-back {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--glass-bg-light);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: 1px solid var(--glass-border-light);
            font-size: 18px;
            color: var(--color-text-medium);
            cursor: pointer;
            width: 34px;
            height: 34px;
            border-radius: 12px;
            padding: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-back:hover {
            background: var(--glass-bg-strong);
            transform: translateX(-2px);
            box-shadow: 0 4px 12px var(--shadow-color-hover);
            color: var(--color-text);
        }


        .settings-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
        }

        /* 页面提示词统一样式 */
        .page-hint {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.3px;
            margin-bottom: 8px;
        }

        /* 页面内容容器统一样式 */
        .page-content-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ========== 页面布局规范化文档 ==========
           所有新页面必须遵循以下结构以确保整齐对齐：
           
           <div class="settings-screen" style="display: flex; flex-direction: column;">
               <div class="status-bar">...</div>
               <div class="settings-nav">
                   <button class="settings-back">...</button>
                   <div class="settings-title">标题</div>
                   <button class="settings-back">...</button>
               </div>
               <div class="settings-scroll">
                   <div class="page-hint">提示词（可选）</div>
                   <div class="page-content-list">
                       <!-- 内容列表 -->
                   </div>
               </div>
           </div>
           
           关键要点：
           1. 使用 .settings-screen 作为主容器（display: flex; flex-direction: column）
           2. status-bar 放在顶部
           3. settings-nav 放在导航栏（左、中、右三列布局）
           4. 内容区使用 .settings-scroll（自动处理 padding 和 overflow）
           5. 提示词使用 .page-hint 类
           6. 内容列表使用 .page-content-list 类
           这样所有页面都能自动对齐和规范化。
        ========== */

        /* 聊天页面导航栏适配 */
        #chatModal .modal-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0;
            padding-right: 16px;
            background: var(--chat-header-bg);
            backdrop-filter: var(--chat-header-blur);
            -webkit-backdrop-filter: var(--chat-header-blur);
            border-bottom: 1px solid var(--chat-header-border);
            flex-shrink: 0;
            min-height: 50px;
            padding-left: 0;
            position: relative;
        }

        #chatModal .modal-header #backToFriendList {
            flex-shrink: 0;
            padding-left: 0;
            font-size: 22px;
        }

        #chatModal .modal-header h3 {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            margin: 0;
            color: var(--color-text);
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 30px;
            max-width: calc(100% - 160px);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
            z-index: 1;
        }

        #chatModal .modal-header #chatHeaderActions {
            margin-left: auto;
            position: relative;
            z-index: 2;
        }

        #chatModal .modal-header>div {
            flex-shrink: 0;
            padding-right: 0;
        }



        .friend-list-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border-top: 1px solid var(--glass-border-light);
            padding-bottom: 8px;
        }

        .friend-list-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--color-text-medium);
            font-size: 12px;
            flex: 1;
        }

        .friend-list-nav-item i {
            font-size: 24px;
        }

        .friend-list-nav-item.active {
            color: var(--color-active-link);
        }

        .friend-list-nav-item:active {
            opacity: 0.7;
        }

        .settings-card {
            background: var(--glass-bg-strong);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 16px 18px;
            box-shadow: 0 4px 16px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid var(--glass-border-strong);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .settings-card:hover {
            background: var(--glass-bg-stronger);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow-color-medium);
        }

        .settings-card-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .settings-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        .settings-card-desc {
            font-size: 12px;
            color: var(--color-text);
        }

        .friend-settings-screen {
            width: 100%;
            max-width: 430px;
            height: 90vh;
            max-height: 932px;
            border-radius: 40px;
            background: var(--color-widget-bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .friend-settings-nav {
            background: var(--color-bg-white);
            padding-right: 16px;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-border-light);
            flex-shrink: 0;
            /* padding-top、padding-left、height、min-height由统一适配逻辑控制 */
        }

        .friend-settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            flex: 1;
            text-align: center;
        }

        /* ========== 返回按钮统一标准（强制规范） ========== */
        /* 尺寸：32x32px | 字体：20px | 圆角：8px | 颜色：var(--color-text) */
        /* ⚠️ 重要：返回按钮内只能有图标 <i class="fas fa-chevron-left"></i>，不得包含任何文字！ */
        /* 示例用法：<button class="friend-settings-back"><i class="fas fa-chevron-left"></i></button> */
        .friend-settings-back {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--color-text);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            padding: 0;
        }


        .friend-settings-spacer {
            width: 32px;
            height: 32px;
        }

        .friend-settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .friend-settings-card {
            background: var(--color-bg-white);
            border-radius: 16px;
            padding: 16px 18px;
            box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .friend-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .friend-settings-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
        }

        .friend-settings-desc {
            font-size: 12px;
            color: var(--color-text);
        }

        .friend-settings-input,
        .friend-settings-select,
        .friend-settings-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            font-size: 14px;
            background: var(--color-bg-white);
        }

        .friend-settings-textarea {
            resize: vertical;
            min-height: 110px;
        }

        .friend-settings-details {
            border: 1px solid var(--color-border-light);
            border-radius: 12px;
            padding: 10px 12px;
            background: var(--color-bg-hover);
        }

        .friend-settings-details summary {
            list-style: none;
            cursor: pointer;
            font-size: 13px;
            color: var(--color-text-medium);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .friend-settings-details summary::-webkit-details-marker {
            display: none;
        }

        .friend-settings-details summary::after {
            content: '›';
            transform: rotate(90deg);
            font-size: 16px;
            color: var(--color-text-lighter);
        }

        .friend-settings-details[open] summary::after {
            transform: rotate(-90deg);
        }

        .voice-status {
            font-size: 12px;
            color: var(--color-primary);
            background: rgba(240, 214, 215, 0.12);
            padding: 4px 10px;
            border-radius: 999px;
        }

        /* 世界书挂载按钮样式 */
        .wb-mount-btn {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 16px;
            background: var(--color-widget-bg);
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px var(--shadow-color-light);
        }

        .wb-mount-btn:hover {
            background: var(--color-bg-active);
            box-shadow: 0 4px 12px var(--shadow-color-hover);
        }

        .wb-mount-btn:active {
            background: var(--color-bg-pressed);
            transform: scale(0.98);
        }

        .worldbook-mount-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            background: var(--color-bg-white);
            border: 1.5px solid var(--color-border-lighter);
            border-radius: 18px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .worldbook-mount-item:hover {
            background: var(--color-bg-selected);
            border-color: var(--color-primary);
        }

        .worldbook-mount-item input[type="checkbox"] {
            cursor: pointer;
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .worldbook-mount-item-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-dark);
        }

        /* 小结卡片 */
        .summary-card {
            background: var(--color-bg-white);
            border-radius: 18px;
            padding: 18px 20px;
            box-shadow: 0 4px 14px var(--shadow-color);
            border: 1px solid var(--color-border-light);
            transition: box-shadow 0.2s ease;
        }

        .summary-card:hover {
            box-shadow: 0 6px 20px var(--shadow-color-medium);
        }

        .summary-card-body {
            font-size: 14.5px;
            color: var(--color-text-dark);
            line-height: 1.8;
            min-height: 120px;
            max-height: 280px;
            overflow-y: auto;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .summary-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .summary-card-time {
            font-size: 11px;
            color: var(--color-text-muted);
        }

        .summary-card-actions {
            display: flex;
            gap: 4px;
        }

        .summary-card-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 10px;
            background: var(--color-bg-light);
            color: var(--color-text-lighter);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.15s ease;
        }

        .summary-card-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-medium);
        }

        .summary-card-processed {
            opacity: 0.55;
            border-style: dashed;
        }

        /* 悬浮球 */
        .summary-fab {
            position: absolute;
            bottom: 28px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            color: var(--color-bg-white);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px var(--shadow-color-medium);
            z-index: 100;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            user-select: none;
            touch-action: none;
        }

        .summary-fab:active {
            transform: scale(0.92);
        }

        .summary-fab-panel {
            display: none;
            position: absolute;
            bottom: 86px;
            right: 20px;
            background: var(--color-bg-white);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 6px 24px rgba(120, 119, 133, 0.15);
            border: 1px solid #f5f0f0;
            z-index: 101;
            min-width: 130px;
        }

        .summary-fab-panel.is-open {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .summary-fab-action {
            padding: 10px 14px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .summary-fab-action:hover {
            background: var(--color-bg-light);
        }

        .ios-switch {
            position: relative;
            width: 44px;
            height: 26px;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-border-input);
            border-radius: 999px;
            transition: 0.2s ease;
        }

        .ios-slider::before {
            position: absolute;
            content: '';
            height: 22px;
            width: 22px;
            left: 2px;
            top: 2px;
            background: var(--color-bg-white);
            border-radius: 50%;
            box-shadow: 0 2px 6px var(--shadow-color-hover);
            transition: 0.2s ease;
        }

        .ios-switch input:checked+.ios-slider {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%);
        }

        .ios-switch input:checked+.ios-slider::before {
            transform: translateX(18px);
        }

        .friend-avatar-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding-bottom: 10px;
        }

        .friend-avatar-display {
            width: 84px;
            height: 84px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-bg-white) 0%, var(--color-bg-white) 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-text-muted);
            font-size: 40px;
            border: 4px solid var(--color-bg-white);
            box-shadow: 0 10px 24px var(--shadow-color-hover);
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .friend-avatar-display:hover {
            transform: scale(1.08);
            box-shadow: 0 12px 28px var(--shadow-color-medium);
        }

        .friend-avatar-display::after {
            content: '点击更换';
            position: absolute;
            bottom: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--color-text-light);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .friend-avatar-display:hover::after {
            opacity: 1;
        }

        .friend-avatar-display.has-image i {
            display: none;
        }

        .friend-avatar-btn {
            padding: 8px 20px;
            background: var(--color-bg-white);
            border: 1px solid var(--color-border-light);
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-medium);
        }

        .friend-avatar-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .settings-card-meta {
            display: flex;
            gap: 14px;
            font-size: 12px;
            color: var(--color-text-light);
        }

        .settings-status {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-error);
        }

        .settings-status.ok {
            color: var(--color-success);
        }

        .settings-arrow {
            font-size: 16px;
            color: var(--color-text-muted);
        }

        .data-manage-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .data-manage-item {
            width: 100%;
            padding: 12px 14px;
            background: var(--color-bg-white);
            border-radius: 12px;
            border: 1px solid var(--color-border-light);
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: var(--color-text-dark);
        }

        .data-manage-item:hover {
            background: var(--color-bg-light);
        }

        #triggerAiBtn:hover {
            transform: scale(1.08);
            background-color: var(--color-bg-hover) !important;
        }

        #triggerAiBtn:active {
            transform: scale(0.95);
        }

        /* 心声弹窗样式 */
        .heart-voice-popup {
            position: absolute;
            top: 91px;
            right: 12px;
            width: 320px;
            height: auto;
            max-height: 520px;
            max-width: calc(100% - 24px);
            background: var(--glass-bg-strong);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            box-shadow: 0 8px 24px var(--shadow-color-light), inset 0 1px 2px var(--glass-border-stronger);
            padding: 0;
            z-index: 2100;
            display: none;
            border: 0.5px solid var(--glass-border-icon);
            flex-direction: column;
            transform-origin: top right;
            animation: hv-popup-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        @keyframes hv-popup-out {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            100% {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
        }

        .heart-voice-popup.closing {
            animation: hv-popup-out 0.2s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            pointer-events: none;
        }

        @keyframes hv-popup-in {
            0% {
                opacity: 0;
                transform: scale(0.92) translateY(-8px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .heart-voice-popup.is-open {
            display: flex;
        }

        /* 核心叙事面板 - 自适应高度 */
        .heart-voice-core-panel {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 24px 24px 0 24px;
            background: linear-gradient(180deg, var(--color-bg-light) 0%, var(--glass-bg-light) 100%);
            max-height: 320px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-core-panel::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-core-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-core-panel::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 2px;
        }

        /* 心声和神态的容器 */
        .heart-voice-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heart-voice-label {
            font-size: 12px;
            color: var(--color-text-medium);
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .heart-voice-text {
            font-size: 15px;
            color: var(--color-text-dark);
            line-height: 1.6;
            word-wrap: break-word;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-height: 180px;
            min-height: 80px;
            overflow-y: auto;
            padding: 12px 14px;
            background: var(--glass-bg-light);
            border-radius: 12px;
            border: 1px solid var(--glass-border-light);
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-text::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-text::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-text::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 2px;
        }

        .heart-voice-status {
            display: none;
        }

        /* 次要信息面板 - 占约20%高度 */
        .heart-voice-footer-panel {
            flex: 0 0 auto;
            padding: 20px 24px 24px 24px;
            background: linear-gradient(180deg, var(--glass-bg-light) 0%, var(--color-bg-light) 100%);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* 心情值包装器 */
        .heart-voice-mood-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .heart-voice-mood-label-text {
            font-size: 12px;
            color: var(--color-text-medium);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .heart-voice-demeanor {
            font-size: 13px;
            color: var(--color-text-dark);
            line-height: 1.6;
            font-style: normal;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: 500;
            max-height: 140px;
            min-height: 60px;
            overflow-y: auto;
            padding: 12px 14px;
            background: var(--glass-bg-light);
            border-radius: 12px;
            border: 1px solid var(--glass-border-light);
            -webkit-overflow-scrolling: touch;
        }

        .heart-voice-demeanor::-webkit-scrollbar {
            width: 4px;
        }

        .heart-voice-demeanor::-webkit-scrollbar-track {
            background: transparent;
        }

        .heart-voice-demeanor::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 2px;
        }

        .heart-voice-mood-bar {
            height: 6px;
            background: var(--color-widget-bg);
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 0.5px 1px var(--glass-border-stronger);
        }

        .heart-voice-mood-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
            width: 0%;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 3px;
        }

        .heart-voice-mood-label {
            font-size: 12px;
            color: var(--color-text-medium);
            text-align: left;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 历史记录按钮 */
        .heart-voice-history-btn {
            align-self: flex-end;
            font-size: 13px;
            color: var(--color-accent);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .heart-voice-history-btn:hover {
            color: var(--color-secondary);
        }

        .heart-voice-history-btn i {
            font-size: 10px;
        }

        .hv-label {
            color: var(--color-text-dark);
            font-weight: 600;
            margin-right: 4px;
        }

        /* 心声历史页面底纹 */
        #heartVoiceHistoryList {
            background: repeating-linear-gradient(135deg,
                    transparent,
                    transparent 20px,
                    rgba(222, 190, 235, 0.03) 20px,
                    rgba(222, 190, 235, 0.03) 40px);
            padding-top: 8px;
            padding-bottom: 16px;
        }

        /* 心声历史标题：艺术字体 */
        .hv-history-title {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 50%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 14px 0 0;
            letter-spacing: 1px;
        }

        /* 标题下划线 */
        .hv-history-title-line {
            width: 60px;
            height: 1px;
            margin: 6px auto 15px;
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
            border-radius: 1px;
        }

        /* 心声历史卡片：玻璃外观 */
        .hv-history-item {
            padding: 16px 18px;
            margin: 0 16px 10px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.15) 0%, rgba(200, 220, 240, 0.1) 100%), rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 18px;
            box-shadow: 0 4px 16px rgba(200, 170, 210, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.6);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .hv-history-item.selected {
            border-color: var(--color-primary);
            background: linear-gradient(135deg, var(--color-bg-selected) 0%, var(--glass-bg-light) 100%), var(--color-bg-white);
            box-shadow: 0 4px 16px var(--shadow-color-medium);
        }

        .hv-history-item.selected::after {
            content: '✓';
            position: absolute;
            top: 12px;
            right: 12px;
            color: var(--color-primary);
            font-weight: bold;
            font-size: 14px;
        }

        .hv-history-item:active {
            transform: scale(0.97);
        }

        .hv-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hv-history-time {
            font-size: 12px;
            color: var(--color-text-light);
            font-weight: 500;
        }

        .hv-history-mood {
            font-size: 11px;
            color: var(--color-accent);
            background: linear-gradient(135deg, var(--glass-bg-light), var(--glass-bg));
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
            border: 1px solid var(--glass-border-light);
        }

        .hv-history-content {
            font-size: 14px;
            color: var(--color-text-dark);
            line-height: 1.7;
            letter-spacing: 0.02em;
        }

        /* 超小屏幕适配 */
        @media (max-width: 375px) {
            .iphone-container {
                max-width: 100%;
                height: 100vh;
            }
        }

        /* 移动端全屏适配 (PWA/Add to Home Screen) */
        @media screen and (max-width: 500px) {
            body {
                padding: 0;
                background: var(--color-background);
                align-items: flex-start;
            }

            .iphone-container {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
                background-color: var(--color-background);
            }

            .status-bar {
                padding-top: env(safe-area-inset-top);
                height: auto;
                min-height: 44px;
                padding-bottom: 5px;
            }

            .dock {
                padding-bottom: env(safe-area-inset-bottom);
                height: auto;
                min-height: 90px;
                border-radius: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }

            /* 修复模态框在移动端的显示 - 仿照主页面大小 */
            .modal {
                padding: 0;
                background-color: transparent;
            }

            /* 全屏模态在移动端用实色背景，防止键盘弹出时主屏幕露出 */
            #chatModal,
            #apiModal,
            #profileModal,
            #profileEditModal {
                background-color: var(--color-bg-white) !important;
                /* 强制覆盖，确保键盘弹出时不会透出主屏幕 */
            }

            /* 聊天界面额外背景保护 - 防止键盘区域透出 */
            #chatModal::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: var(--color-bg-white);
                z-index: -1;
                pointer-events: none;
            }

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            #profileModal .modal-content,
            #profileEditModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 100%;
                height: 100vh;
                height: 100dvh;
                max-height: none;
                border-radius: 0;
                margin: 0;
                box-shadow: none;
            }

            /* 显示状态栏时的导航栏样式（紧贴状态栏） */
            body:not(.hide-status-bar) #chatModal .modal-header,
            body:not(.hide-status-bar) #apiModal .modal-header,
            body:not(.hide-status-bar) .settings-nav,
            body:not(.hide-status-bar) .friend-settings-nav {
                padding: 0 !important;
                padding-top: 0px !important;
                padding-bottom: 10px !important;
                padding-left: 16px !important;
                padding-right: 16px !important;
                box-sizing: border-box !important;
                height: 40px !important;
                min-height: 40px !important;
                transition: height 0.3s ease, min-height 0.3s ease;
            }

            /* 隐藏状态栏时的导航栏样式（考虑安全区） */
            body.hide-status-bar #chatModal .modal-header,
            body.hide-status-bar #apiModal .modal-header,
            body.hide-status-bar .settings-nav,
            body.hide-status-bar .friend-settings-nav {
                padding: 0 !important;
                padding-top: calc(0px + env(safe-area-inset-top, 0px)) !important;
                padding-bottom: 10px !important;
                padding-left: 16px !important;
                padding-right: 16px !important;
                box-sizing: border-box !important;
                height: var(--header-height-hidden) !important;
                min-height: var(--header-height-hidden) !important;
                transition: height 0.3s ease, min-height 0.3s ease;
            }
        }

        /* 非移动端：弹窗页面仿照主页面大小 */
        @media screen and (min-width: 501px) {

            #chatModal .modal-content,
            .friend-settings-screen,
            #apiModal .modal-content,
            #profileModal .modal-content,
            #profileEditModal .modal-content,
            .settings-screen {
                width: 100%;
                max-width: 430px;
                height: 90vh;
                max-height: 932px;
                border-radius: 40px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            }
        }

        /* 隐藏状态栏功能 */
        body.hide-status-bar .status-bar {
            display: none !important;
            /* 完全不占位空间 */
        }

        /* ========== 统一页面适配逻辑 ========== */
        /* 设计原则：使用通用选择器 .modal 替代硬编码页面ID */
        /* 优势：所有新增弹窗页面自动继承统一样式，无需手动添加 */
        /* 主屏幕不受影响（在 .iphone-container 内，不在 .modal 内） */

        /* 1. 所有弹窗页面添加box-sizing，防止margin-top额外撑开高度 */
        .modal .modal-content,
        .modal .settings-screen,
        .modal .friend-settings-screen {
            /* 通用选择器确保所有弹窗页面统一 */
            box-sizing: border-box;
            margin-top: 0;
        }

        /* 2. 状态栏显示/隐藏联动（仅作用于弹窗页面） */
        /* 显示状态栏时：所有弹窗页面的.status-bar显示 */
        body:not(.hide-status-bar) .modal .status-bar {
            visibility: visible !important;
        }

        /* 隐藏状态栏时：所有弹窗页面的.status-bar隐藏且不占位 */
        body.hide-status-bar .modal .status-bar {
            display: none !important;
        }



        /* 3. 统一顶部栏位置（含安全区） */
        /* 显示状态栏时的导航栏样式（紧贴状态栏） */
        body:not(.hide-status-bar) .modal .modal-header,
        body:not(.hide-status-bar) .modal .settings-nav,
        body:not(.hide-status-bar) .modal .friend-settings-nav {
            /* 通用选择器自动应用到所有弹窗页面 */
            padding: 0 !important;
            padding-top: 0px !important;
            padding-bottom: 10px !important;
            padding-left: 16px !important;
            padding-right: 16px !important;
            box-sizing: border-box !important;
            height: 40px !important;
            min-height: 40px !important;
            transition: height 0.3s ease, min-height 0.3s ease;
        }

        /* 隐藏状态栏时的导航栏样式（考虑安全区） */
        body.hide-status-bar .modal .modal-header,
        body.hide-status-bar .modal .settings-nav,
        body.hide-status-bar .modal .friend-settings-nav {
            /* 通用选择器自动应用到所有弹窗页面 */
            padding: 0 !important;
            padding-top: calc(0px + env(safe-area-inset-top, 0px)) !important;
            padding-bottom: 10px !important;
            padding-left: 16px !important;
            padding-right: 16px !important;
            box-sizing: border-box !important;
            height: var(--header-height-hidden) !important;
            min-height: var(--header-height-hidden) !important;
            transition: height 0.3s ease, min-height 0.3s ease;
        }

        /* 4. 主屏幕不受影响 */
        .home-screen {
            margin-top: 0 !important;
        }

        /* 5. 弹窗页面无顶部空白 */
        .modal .modal-content {
            /* 通用选择器确保所有弹窗页面统一 */
            padding-top: 0;
        }

        /* 所有返回按钮确保可点击和高层级 */
        .settings-back,
        .friend-settings-back,
        #backToFriendList,
        #charSettingsBack,
        #settingsBack,
        #worldbookBack,
        #closeFriendListModal,
        #closeApiModal,
        #closeProfileModal,
        #profileEditBtn {
            z-index: 999 !important;
            pointer-events: auto !important;
            position: relative !important;
            cursor: pointer !important;
            touch-action: manipulation !important;
        }


        /* ========== 统一页面适配逻辑结束 ========== */

        /* 全局适配优化 */
        .iphone-container,
        .modal .settings-screen,
        .modal .friend-settings-screen,
        .modal .modal-content {
            /* 通用选择器确保所有弹窗页面统一 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 确保移动端全屏无滚动 */
        html,
        body {
            overflow: hidden;
            height: 100%;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: none;
        }

        /* 统一焦点样式 */
        input:focus,
        textarea:focus,
        select:focus,
        button:focus {
            outline: none;
        }

        /* 优化触摸反馈 */
        .btn:active,
        .settings-card:active,
        .friend-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        /* 全局隐藏滚动条（保持可滚动） */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        *::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        /* 心声按钮脉动动画 */
        @keyframes heartVoicePulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 var(--color-bg-user-msg);
                background-color: var(--glass-bg-light);
            }

            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px var(--glass-border-light);
                background-color: var(--color-bg-user-msg);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 transparent;
                background-color: var(--glass-bg-light);
            }
        }

        #heartVoiceBtn.pulse-active {
            animation: heartVoicePulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite !important;
            border-radius: 50% !important;
            padding: 6px !important;
        }

        .hover-text-style:hover {
            color: var(--color-text-muted);
        }

        /* ========== 个人资料页面样式 - 清透玻璃拟态 ========== */
        .profile-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            background: linear-gradient(135deg,
                    #f5f8fa 0%,
                    #eef4f8 35%,
                    #e8f2f7 65%,
                    #f0f6fa 100%);
            overflow-y: auto;
        }

        .profile-header {
            position: relative;
            width: 100%;
            padding: 48px 24px 32px;
            text-align: center;
            overflow: hidden;
        }

        .profile-bg-gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                    rgba(212, 227, 240, 0.15) 0%,
                    rgba(200, 220, 232, 0.2) 25%,
                    rgba(224, 240, 248, 0.15) 50%,
                    rgba(232, 242, 247, 0.2) 75%,
                    rgba(240, 248, 252, 0.15) 100%);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
        }

        .profile-avatar-section {
            position: relative;
            z-index: 2;
            margin-bottom: 24px;
        }

        .profile-avatar {
            position: relative;
            width: 110px;
            height: 110px;
            margin: 0 auto 10px;
            border-radius: 50%;
            background: linear-gradient(135deg,
                    var(--avatar-gradient-start) 0%,
                    var(--avatar-gradient-end) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border-white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 24px var(--shadow-color-hover),
                0 2px 8px var(--shadow-color-light);
        }

        .profile-avatar:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px var(--shadow-color-medium),
                0 4px 12px var(--shadow-color);
            border-color: var(--glass-border-icon);
        }

        .avatar-edit-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-text);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: rgba(255, 255, 255, 0.95);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-avatar:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .profile-level-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            background: linear-gradient(135deg, var(--color-vip-gold) 0%, var(--color-accent) 100%);
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: var(--color-text-darker);
            box-shadow: 0 3px 10px var(--shadow-color-medium);
        }

        .profile-basic-info {
            position: relative;
            z-index: 2;
        }

        .profile-name-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .profile-name-section h2 {
            margin: 0;
            font-size: 26px;
            font-weight: 600;
            color: var(--color-text-dark);
            letter-spacing: 0.3px;
        }

        .profile-gender-icon {
            font-size: 20px;
            color: var(--color-text-light);
            opacity: 0.8;
        }

        .profile-id {
            font-size: 14px;
            color: var(--color-text-medium);
            margin-bottom: 14px;
            font-weight: 400;
        }

        .profile-signature {
            font-size: 14px;
            color: var(--color-text-placeholder);
            font-style: normal;
            max-width: 300px;
            margin: 0 auto;
            line-height: 1.6;
            font-weight: 300;
        }

        /* 编辑表单样式 - 玻璃拟态 */
        .profile-edit-form {
            padding: 28px 24px;
            background: var(--glass-bg-strong);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 32px 32px 0 0;
            margin-top: -10px;
            position: relative;
            z-index: 3;
            border: 1px solid var(--glass-border-light);
            border-bottom: none;
        }

        .profile-form-section {
            margin-bottom: 24px;
        }

        .profile-form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 10px;
            letter-spacing: 0.2px;
        }

        .profile-gender-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .gender-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 14px;
            border-radius: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gender-option:hover {
            background: var(--color-bg-selected);
        }

        .gender-option input[type="radio"] {
            display: none;
        }

        .gender-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--icon-color-alt);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid var(--glass-border-light);
        }

        .gender-icon.female {
            background: linear-gradient(135deg,
                    var(--icon-gradient-2-start) 0%,
                    var(--icon-gradient-2-end) 100%);
        }

        .gender-icon.male {
            background: linear-gradient(135deg,
                    var(--icon-gradient-3-start) 0%,
                    var(--icon-gradient-3-end) 100%);
        }

        .gender-icon.other {
            background: linear-gradient(135deg,
                    var(--icon-gradient-4-start) 0%,
                    var(--icon-gradient-4-end) 100%);
        }

        .gender-option input[type="radio"]:checked+.gender-icon {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px var(--shadow-color-medium);
            border-color: var(--glass-border-stronger);
        }

        .form-help-text {
            font-size: 12px;
            color: var(--color-text-light);
            margin-top: 8px;
            font-weight: 300;
        }

        .profile-form-actions {
            display: flex;
            gap: 16px;
            margin-top: 36px;
            padding-top: 24px;
            border-top: 1px solid rgba(212, 227, 240, 0.25);
        }

        .profile-form-actions .btn {
            flex: 1;
            padding: 14px;
            border-radius: 28px;
            font-weight: 500;
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        /* 功能卡片样式 - 玻璃拟态 */
        .profile-cards-section {
            padding: 0 24px 32px;
            background: transparent;
            position: relative;
            z-index: 3;
        }

        .profile-card {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border-radius: 24px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--glass-border-strong);
            box-shadow: 0 4px 16px var(--shadow-color-light);
        }

        .profile-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 28px var(--shadow-color-medium);
            border-color: var(--glass-border-stronger);
            background: var(--glass-bg-stronger);
        }

        .card-icon {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 19px;
            color: var(--icon-color-alt);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: 1.5px solid var(--glass-border-light);
        }

        .profile-card:nth-of-type(1) .card-icon {
            background: linear-gradient(135deg,
                    var(--icon-gradient-2-start) 0%,
                    var(--icon-gradient-2-end) 100%);
        }

        .profile-card:nth-of-type(2) .card-icon {
            background: linear-gradient(135deg,
                    var(--icon-gradient-3-start) 0%,
                    var(--icon-gradient-3-end) 100%);
        }

        .card-content {
            flex: 1;
        }

        .card-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--color-text-dark);
            margin-bottom: 4px;
            letter-spacing: 0.2px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--color-text-medium);
            font-weight: 300;
        }

        .profile-card i.fa-chevron-right {
            color: var(--color-text-lighter);
            font-size: 13px;
        }

        /* 顶部编辑按钮样式 */
        .profile-edit-btn {
            background: var(--glass-bg-light);
            backdrop-filter: var(--glass-blur-light);
            -webkit-backdrop-filter: var(--glass-blur-light);
            border: 1px solid var(--glass-border-light);
            color: var(--color-text-medium);
            font-size: 17px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .profile-edit-btn:hover {
            background: var(--glass-bg-strong);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-color-light);
            color: var(--color-text);
        }

        /* 个人资料信息展示卡片 */
        .profile-info-card {
            background: var(--glass-bg-strong);
            backdrop-filter: var(--glass-blur-strong);
            -webkit-backdrop-filter: var(--glass-blur-strong);
            border-radius: 24px;
            border: 1px solid var(--glass-border-strong);
            box-shadow: 0 4px 16px var(--shadow-color-light);
            margin-bottom: 14px;
            overflow: hidden;
        }

        .profile-info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            border-bottom: 1px solid var(--color-border-lighter);
        }

        .profile-info-label {
            font-size: 14px;
            color: var(--color-text-medium);
            flex-shrink: 0;
        }

        .profile-info-value {
            font-size: 14px;
            color: var(--color-text-dark);
            text-align: right;
        }

        /* 编辑页面表单样式 */
        .profile-edit-group {
            margin-bottom: 20px;
        }

        .profile-edit-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .profile-edit-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--color-border-input);
            border-radius: 14px;
            font-size: 14px;
            color: var(--color-text-dark);
            background: var(--color-bg-input);
            box-sizing: border-box;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .profile-edit-input:focus {
            border-color: var(--color-primary);
            outline: none;
        }

        /* 个人资料页按"页面切换"呈现，不使用弹窗动画 */
        #profileModal,
        #profileEditModal {
            background-color: var(--overlay-darker);
        }

        #profileModal .modal-content,
        #profileEditModal .modal-content {
            animation: none;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 个人资料顶部栏点击兜底：强制保证顶部按钮可交互 */
        #profileModal .status-bar,
        #profileEditModal .status-bar {
            pointer-events: none;
            z-index: 3004;
        }

        #profileModal .settings-nav,
        #profileEditModal .settings-nav {
            position: sticky;
            top: 0;
            z-index: 3005 !important;
            pointer-events: auto;
        }

        #profileModal .settings-title,
        #profileEditModal .settings-title {
            pointer-events: none;
        }

        #profileModal #closeProfileModal,
        #profileEditModal #closeProfileEditModal,
        #profileEditModal #profileSaveBtn {
            position: relative;
            z-index: 3006 !important;
            pointer-events: auto !important;
        }

        /* 响应式调整 */
        @media (max-width: 400px) {
            .profile-header {
                padding: 40px 20px 28px;
            }

            .profile-avatar {
                width: 95px;
                height: 95px;
                font-size: 45px;
            }

            .profile-name-section h2 {
                font-size: 22px;
            }

            .profile-cards-section {
                padding: 0 20px 28px;
            }
        }
    </style>
    <style>
        /* 图片描述弹窗文本区域滚动条美化 */
        #imageDescText::-webkit-scrollbar {
            width: 4px;
        }

        #imageDescText::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 4px;
        }

        #imageDescText::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        #imageDescText::-webkit-scrollbar-thumb:hover {
            background: var(--color-border-input);
        }

        .worldbook-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 24px 0;
            border-radius: 28px;
            /* 大圆角 */
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text-darker);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 130px;
            /* 保证等高 */
        }

        .worldbook-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }

        /* 世界书玻璃按钮样式 */
        .wb-glass-btn {
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(240, 214, 215, 0.3) 0%, rgba(200, 220, 240, 0.2) 100%), rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 8px 20px rgba(200, 170, 210, 0.25);
        }

        .wb-glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(120, 119, 133, 0.15);
        }

        .wb-glass-btn:active {
            transform: translateY(-1px);
        }

        .hg-glass-btn {
            border-radius: 24px;
            background: linear-gradient(135deg, var(--color-bg-user-msg) 0%, var(--color-bg-selected) 100%), var(--glass-bg-stronger);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border-icon);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 8px 20px var(--shadow-color-medium);
        }

        .hg-glass-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px var(--shadow-color-hover);
        }

        .hg-glass-btn:active {
            transform: translateY(-1px);
        }

        /* 世界书卡片样式 */
        .wb-card {
            background-color: var(--color-bg-white);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px var(--shadow-color-light);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: box-shadow 0.2s ease;
        }

        .wb-card:hover {
            box-shadow: 0 6px 16px var(--shadow-color-medium);
        }

        .wb-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-text-darker);
            margin: 0;
        }

        .wb-card-preview {
            font-size: 13px;
            color: var(--color-text-muted);
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }

        .wb-card-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .wb-card-btn {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--color-bg-user-msg) 0%, var(--color-bg-selected) 100%), var(--glass-bg-strong);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border-stronger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-medium);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .wb-card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color-medium);
        }

        .wb-card-btn:active {
            transform: translateY(0);
        }

        /* HTML游戏卡片样式 (复用世界书样式) */
        .hg-card {
            background-color: var(--color-bg-white);
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 4px 12px var(--shadow-color-light);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
            transition: box-shadow 0.2s ease;
        }

        .hg-card:hover {
            box-shadow: 0 6px 16px var(--shadow-color-medium);
        }

        .hg-card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-text-darker);
            margin: 0;
        }

        .hg-card-preview {
            font-size: 13px;
            color: var(--color-text-muted);
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }

        .hg-card-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .hg-card-btn {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--color-bg-user-msg) 0%, var(--color-bg-selected) 100%), var(--glass-bg-strong);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border-stronger);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-medium);
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .hg-card-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow-color-medium);
        }

        .hg-card-btn:active {
            transform: translateY(0);
        }

        /* ============================================================
           实用CSS类 - 用于替代inline style
           ============================================================ */

        /* 文字颜色类 */
        .text-ui-gray {
            color: var(--color-ui-gray) !important;
        }

        .text-ui-dark {
            color: var(--color-text-dark) !important;
        }

        .text-accent {
            color: var(--color-accent) !important;
        }

        .text-muted {
            color: var(--color-text-muted) !important;
        }

        /* 背景颜色类 */
        .bg-ui-light {
            background-color: var(--color-ui-bg) !important;
        }

        .bg-button-secondary {
            background-color: var(--color-button-secondary) !important;
        }

        .bg-white-soft {
            background-color: var(--color-bg-white) !important;
        }

        /* 按钮渐变类 */
        .btn-gradient-cold {
            background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-blue) 100%) !important;
            color: white !important;
        }

        .btn-gradient-lavender {
            background: linear-gradient(135deg, var(--color-accent-lavender) 0%, var(--color-accent-blue) 100%) !important;
            color: white !important;
        }

        /* 边框颜色类 */
        .border-ui {
            border-color: var(--color-ui-border) !important;
        }

        .border-accent {
            border-color: var(--color-accent) !important;
        }
    </style>

</head>

<body>
    <div class="iphone-container">
        <!-- 刘海模拟 -->
        <div class="notch"></div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <div id="statusTime" class="time">14:30</div>
            <div class="status-icons">
                <i id="statusSignal" class="fas fa-signal"></i>
                <i id="statusWifi" class="fas fa-wifi"></i>
                <i id="statusBattery" class="fas fa-battery-three-quarters"></i>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="home-screen">
                <!-- 主页资料大卡片 -->
                <div class="profile-widget-glass">
                    <div class="profile-avatar-circle">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <div class="profile-username">小雨</div>
                        <div class="profile-handle">@XY521</div>
                        <div class="profile-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>爱尔兰</span>
                        </div>
                    </div>
                </div>

                <!-- iOS备忘录卡片 -->
                <div class="memo-card">
                    <div class="memo-header">
                        <i class="fas fa-folder"></i>
                        <span class="memo-title">备忘录</span>
                    </div>
                    <div class="memo-content">
                    </div>
                </div>

                <!-- 右侧图标区域 (4个图标: QQ、消息、创世书、设置) -->
                <div class="icon-area-glass">
                    <div class="app-item" data-app="feixin">
                        <div class="app-icon chat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="app-name">QQ</div>
                    </div>
                    <div class="app-item" data-app="message">
                        <div class="app-icon message-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="app-name">消息</div>
                    </div>
                    <div class="app-item" data-app="worldbook">
                        <div class="app-icon worldbook-icon">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="app-name">创世书</div>
                    </div>
                    <div class="app-item" data-app="settings">
                        <div class="app-icon settings-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="app-name">设置</div>
                    </div>
                </div>
                <!-- 应用入口区域 (保留但隐藏) -->
                <div id="appGrid" class="app-grid app-grid-offset"></div>

            </div>
        </div>

        <!-- Dock栏 (新版玻璃设计) -->
        <div class="dock-glass">
            <div class="dock-icon-glass dock-phone" id="phoneIcon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="dock-icon-glass dock-novel" id="novelIcon">
                <i class="fas fa-book"></i>
            </div>
            <div class="dock-icon-glass dock-forum" id="forumIcon">
                <i class="fas fa-comments"></i>
            </div>
        </div>
    </div>

    <!-- 可爱提示框 -->
    <div class="cute-toast" id="cuteToast" style="display: none;">
        <div class="cute-toast-content">
            <p>等我⌯･3･⌯ಣ</p>
        </div>
    </div>

    <!-- 消息通知横幅 -->
    <div class="msg-notif-banner" id="msgNotifBanner">
        <div class="msg-notif-avatar" id="msgNotifAvatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="msg-notif-body">
            <div class="msg-notif-name" id="msgNotifName"></div>
            <div class="msg-notif-text" id="msgNotifText"></div>
        </div>
    </div>

    <!-- API配置弹窗 -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="apiStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="apiStatusSignal" class="fas fa-signal"></i>
                    <i id="apiStatusWifi" class="fas fa-wifi"></i>
                    <i id="apiStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="modal-header">
                <h3>API 配置</h3>
                <button class="modal-close" id="closeApiModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiUrl">API 地址</label>
                    <input type="url" id="apiUrl" class="form-control" placeholder="https://api.openai.com/v1"
                        value="https://api.openai.com/v1">
                </div>

                <div class="form-group">
                    <label for="apiKey">API 密钥</label>
                    <input type="password" id="apiKey" class="form-control" placeholder="请输入您的 API 密钥">
                </div>

                <div class="form-group">
                    <label>模型选择</label>
                    <div class="form-row">
                        <div class="form-group">
                            <button id="fetchModels" class="btn btn-secondary btn-small">
                                <span id="fetchBtnText">拉取模型列表</span>
                                <span id="fetchLoading" class="loading" style="display: none;"></span>
                            </button>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <div class="model-picker">
                                <button type="button" id="modelPickerButton" class="model-picker-button" disabled>
                                    <span id="modelPickerText">请先拉取模型列表</span>
                                    <i class="fas fa-chevron-down caret"></i>
                                </button>
                                <div id="modelPickerList" class="model-picker-list" role="listbox"></div>
                            </div>
                            <select id="modelSelect" class="form-control" disabled style="display: none;">
                                <option value="">请先拉取模型列表</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="apiStatus" class="status-message"></div>

                <div class="form-actions">
                    <button id="saveApi" class="btn btn-primary">保存配置</button>
                </div>

                <!-- API预设管理 -->
                <div id="apiPresetSection" style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #E8E4E9;">
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 10px; font-size: 14px;">API预设管理</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="presetName" class="form-control" placeholder="输入预设名称"
                                style="flex: 1; font-size: 14px;">
                            <button id="savePreset" class="btn btn-secondary" style="white-space: nowrap;">保存预设</button>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 6px;">给当前配置起个名字，方便下次快速切换</div>
                    </div>

                    <div style="margin-top: 16px;">
                        <label
                            style="display: block; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 10px; font-size: 14px;">API预设列表</label>
                        <div id="presetListContainer"
                            style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">
                            <!-- 按钮由 JS 动态生成 -->
                        </div>
                    </div>

                    <!-- API预设选择弹窗 -->
                    <div id="apiPresetModal" class="modal" style="display: none;">
                        <div class="modal-content"
                            style="width: 260px; height: 280px; max-width: 260px; max-height: 280px; border-radius: 14px; padding: 0; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15); display: flex; flex-direction: column; overflow: hidden;">
                            <div style="padding: 10px 12px; border-bottom: 1px solid #E8E4E9; flex-shrink: 0;">
                                <h3
                                    style="margin: 0; font-size: 13px; color: var(--color-text-darker); text-align: center; font-weight: 600;">
                                    选择API预设</h3>
                            </div>
                            <div id="apiPresetDrawerList"
                                style="padding: 6px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; flex: 1;">
                                <!-- 预设列表项将动态生成 -->
                            </div>
                            <div
                                style="padding: 8px 10px; border-top: 1px solid #E8E4E9; display: flex; gap: 8px; justify-content: center; flex-shrink: 0;">
                                <button id="closeApiPresetModal" type="button"
                                    style="padding: 4px 20px; background: var(--color-button-secondary); border: none; border-radius: 6px; cursor: pointer; color: var(--color-text-medium); font-size: 12px; font-weight: 500;">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友列表弹窗 -->
    <div class="modal" id="friendListModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendListStatusSignal" class="fas fa-signal"></i>
                    <i id="friendListStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeFriendListModal">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">好友列表</div>
                <button class="settings-back"
                    style="background: none; border: none; cursor: pointer; padding: 0; font-size: 18px; color: var(--color-accent-pink); width: 42px; text-align: center;"
                    id="addFriendFromList">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="settings-scroll">
                <div id="friendList" class="friend-list" style="padding: 16px 20px;">
                    <!-- 好友列表将动态生成 -->
                </div>
                <div id="noFriends" class="no-friends">
                    <div class="page-hint" style="margin-bottom: 0;">暂无好友，点击右上角 + 添加好友</div>
                </div>
            </div>
            <div class="friend-list-nav">
                <div class="friend-list-nav-item active" data-nav="messages">
                    <i class="fas fa-comment"></i>
                    <span>消息</span>
                </div>
                <div class="friend-list-nav-item" data-nav="moments">
                    <i class="fas fa-circle"></i>
                    <span>动态</span>
                </div>
                <div class="friend-list-nav-item" data-nav="me">
                    <i class="fas fa-user-circle"></i>
                    <span>我</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友弹窗 -->
    <div class="modal" id="addFriendModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加好友</h3>
                <button class="modal-close" id="closeAddFriendModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <div class="form-group" style="width: auto; text-align: center;">
                        <div id="avatarPreview" class="avatar-upload-preview">
                            <i class="fas fa-user"></i>
                            <p>点击添加</p>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 8px;">点击头像选择</div>
                        <input type="file" id="avatarInput" class="form-control" accept="image/*"
                            style="display: none;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="friendName">昵称</label>
                    <input type="text" id="friendName" class="form-control" placeholder="输入好友昵称">
                </div>

                <div class="form-group">
                    <label for="friendPersona">人设</label>
                    <textarea id="friendPersona" class="form-control"
                        placeholder="比如：傲娇还有点毒舌的青梅竹马，喜欢吃甜食却不承认，遇事会先嘴硬后关心人。" rows="3" style="resize: vertical;"
                        minlength="0" maxlength="5000"></textarea>
                    <div class="input-hint">0-5000字，描述性格、背景或说话风格</div>
                </div>

                <div id="addFriendStatus" class="status-message"></div>

                <div class="form-actions">
                    <button id="cancelAddFriend" class="btn btn-secondary">取消</button>
                    <button id="confirmAddFriend" class="btn btn-primary">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天弹窗 -->
    <div class="modal" id="chatModal">
        <div class="modal-content">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="chatStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="chatStatusSignal" class="fas fa-signal"></i>
                    <i id="chatStatusWifi" class="fas fa-wifi"></i>
                    <i id="chatStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- 导航栏 -->
            <div class="modal-header" style="position: relative;">
                <button id="backToFriendList">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="chatTitle"
                    style="margin: 0; color: var(--color-ui-gray); font-size: 18px; font-weight: 600; display: flex; align-items: center; justify-content: center; text-align: center;">
                    芋圆</h3>
                <div id="chatHeaderActions" style="display: flex; gap: 8px; align-items: center;">
                    <button id="heartVoiceBtn"
                        style="background: none; border: none; font-size: 18px; color: var(--color-accent-pink); cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                        aria-label="心声">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button id="charSettingsBtn"
                        style="background: none; border: none; font-size: 20px; color: var(--color-ui-gray); cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <!-- 多选模式顶部栏 -->
                <div id="multiSelectHeader" class="multi-select-header">
                    <div style="width: 32px;"></div>
                    <span id="multiSelectCount" class="multi-select-count">已选中 0 条</span>
                    <button id="multiSelectCancelBtn" class="multi-select-cancel-btn" type="button">取消</button>
                </div>
            </div>

            <div id="apiWarning" class="api-warning"
                style="display: none; background-color: var(--color-ui-bg); border-bottom: 1px solid #debb7b; padding: 12px 20px; color: #debb7b; font-size: 13px; text-align: center;">
                ⚠️ 未配置API，请先进行API配置
            </div>

            <!-- 心声弹窗 -->
            <div id="heartVoicePopup" class="heart-voice-popup">
                <!-- 核心叙事面板：心声 + 神态 -->
                <div class="heart-voice-core-panel">
                    <div class="heart-voice-section">
                        <div class="heart-voice-label">心　声</div>
                        <div id="heartVoiceText" class="heart-voice-text"></div>
                    </div>
                    <div class="heart-voice-section">
                        <div class="heart-voice-label">神　态</div>
                        <div id="heartVoiceDemeanor" class="heart-voice-demeanor"></div>
                    </div>
                </div>

                <!-- 次要信息面板：心情值 + 历史记录 -->
                <div class="heart-voice-footer-panel">
                    <div class="heart-voice-mood-wrapper">
                        <div class="heart-voice-mood-label-text">心情值</div>
                        <div class="heart-voice-mood-bar">
                            <div id="heartVoiceMoodFill" class="heart-voice-mood-fill"></div>
                        </div>
                        <div id="heartVoiceMoodLabel" class="heart-voice-mood-label"></div>
                    </div>
                    <button id="heartVoiceHistoryBtn" class="heart-voice-history-btn">
                        查看历史 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="chat-messages" id="chatMessages"
                style="flex: 1; overflow-y: auto; border: none; padding: 15px 12px; background-color: #FFFFFF;">
            </div>

            <!-- 输入框区域 -->
            <div style="background-color: #FFFFFF; flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom, 0px);">
                <div id="chatInputAreaWrap" class="chat-input-area-wrap" style="padding: 8px 12px 2px;">
                    <div id="replyPreview" class="reply-preview">
                        <span id="replyPreviewText" class="reply-preview-text"></span>
                        <button id="replyPreviewClose" class="reply-preview-close" type="button">×</button>
                    </div>
                    <div id="imageUploadPill" class="image-upload-pill">
                        <img id="imageUploadThumb" class="image-upload-thumb" alt="图片预览" />
                        <span id="imageUploadName" class="image-upload-name">已选择图片</span>
                        <button id="imageUploadClose" class="image-upload-close" type="button">×</button>
                    </div>
                    <!-- 功能栏 -->
                    <div class="chat-function-row"
                        style="display: flex; justify-content: space-around; padding: 4px 0 2px;">
                        <button id="voiceInputBtn"
                            style="background: none; border: none; color: var(--color-ui-gray); font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-microphone"></i></button>
                        <button id="imageUploadBtn"
                            style="background: none; border: none; color: var(--color-ui-gray); font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-image"></i></button>
                        <button id="cameraInputBtn"
                            style="background: none; border: none; color: var(--color-ui-gray); font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-camera"></i></button>
                        <button
                            style="background: none; border: none; color: var(--color-ui-gray); font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-laugh"></i></button>
                        <button id="chatPlusBtn"
                            style="background: none; border: none; color: var(--color-ui-gray); font-size: 22px; cursor: pointer; padding: 10px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"><i
                                class="fas fa-plus-circle"></i></button>
                    </div>

                    <div class="chat-input-row"
                        style="display: flex; gap: 8px; margin-bottom: 2px; align-items: flex-end;">
                        <button id="triggerAiBtn"
                            style="width: 38px; height: 38px; padding: 0; border-radius: 50%; flex-shrink: 0; background: var(--color-ui-bg); border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(120,119,133,0.05); display: flex; align-items: center; justify-content: center; color: var(--color-accent-lavender);"
                            aria-label="呼唤角色">
                            <i class="fas fa-wand-magic-sparkles" style="font-size: 18px;"></i>
                        </button>
                        <textarea class="chat-input" id="chatInput" placeholder="输入消息..." rows="1"
                            style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; resize: none; font-size: 14px;"></textarea>
                        <button class="chat-send-btn" id="sendMessage"
                            style="width: 40px; height: 40px; padding: 0; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div id="chatExtraPanel" class="chat-extra-panel" aria-hidden="true">
                        <div class="chat-extra-grid">
                            <button type="button" class="chat-extra-item" id="chatSummaryBtn" aria-label="总结">
                                <span class="chat-extra-icon"><i class="fas fa-clipboard-list"></i></span>
                                <span class="chat-extra-label">总结</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="红包">
                                <span class="chat-extra-icon"><i class="fas fa-gift"></i></span>
                                <span class="chat-extra-label">红包</span>
                            </button>
                            <button type="button" class="chat-extra-item" aria-label="转账">
                                <span class="chat-extra-icon"><i class="fas fa-money-bill-wave"></i></span>
                                <span class="chat-extra-label">转账</span>
                            </button>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                            <div class="chat-extra-item is-placeholder" aria-hidden="true">
                                <span class="chat-extra-icon"><i class="fas fa-plus"></i></span>
                                <span class="chat-extra-label">预留</span>
                            </div>
                        </div>
                    </div>
                    <input id="imageInput" type="file" accept="image/*" style="display: none;" />
                    <div id="imageConfirmPopover" class="image-confirm-popover">
                        <span>发送图片？</span>
                        <div class="image-confirm-actions">
                            <button id="imageConfirmYes" class="image-confirm-btn yes" type="button">是</button>
                            <button id="imageConfirmNo" class="image-confirm-btn no" type="button">否</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 多选模式底部栏 -->
            <div id="multiSelectFooter" class="multi-select-footer">
                <button id="multiSelectForwardBtn" class="multi-select-forward-btn" type="button">
                    <i class="fas fa-share"></i> 转发
                </button>
            </div>

            <div id="chatStatus" class="status-message" style="margin: 0; border-radius: 0;"></div>
        </div>
    </div>

    <!-- 消息长按操作菜单 -->
    <div id="messageActionOverlay" class="message-action-overlay">
        <div id="messageActionMenu" class="message-action-menu">
            <button class="message-action-item" id="messageActionCopy" type="button">
                <i class="fas fa-copy"></i>
                <span>复制</span>
            </button>
            <button class="message-action-item" id="messageActionDelete" type="button">
                <i class="fas fa-trash"></i>
                <span>删除</span>
            </button>
            <button class="message-action-item" id="messageActionRecall" type="button">
                <i class="fas fa-rotate-left"></i>
                <span>撤回</span>
            </button>
            <button class="message-action-item" id="messageActionReply" type="button">
                <i class="fas fa-reply"></i>
                <span>引用</span>
            </button>
            <button class="message-action-item" id="messageActionMultiSelect" type="button">
                <i class="fas fa-check-double"></i>
                <span>多选</span>
            </button>
            <button class="message-action-item forward-item" id="messageActionForward" type="button">
                <i class="fas fa-share"></i>
                <span>转发</span>
            </button>
            <button class="message-action-item" id="messageActionEdit" type="button">
                <i class="fas fa-edit"></i>
                <span>编辑</span>
            </button>
            <button class="message-action-item" id="messageActionRegenerate" type="button">
                <i class="fas fa-magic"></i>
                <span>修正</span>
            </button>
        </div>
    </div>

    <!-- 多选确认删除弹窗 -->
    <div id="multiSelectConfirmOverlay" class="multi-select-confirm-overlay">
        <div class="multi-select-confirm-box">
            <h3>确认批量删除？</h3>
            <p id="multiSelectConfirmText">将删除已选中的 0 条消息，删除后无法恢复</p>
            <div class="multi-select-confirm-actions">
                <button id="multiSelectConfirmYes" type="button">确认删除</button>
                <button id="multiSelectConfirmNo" type="button">取消</button>
            </div>
        </div>
    </div>

    <!-- 编辑消息弹窗 -->
    <div id="messageEditOverlay" class="message-edit-overlay" style="display: none;">
        <div class="message-edit-box">
            <h3>编辑消息</h3>
            <textarea id="messageEditTextarea" placeholder="输入编辑的内容..."
                style="width: 100%; height: 120px; padding: 12px; border: 1px solid var(--color-border-input); border-radius: 12px; font-size: 14px; resize: none; box-sizing: border-box; font-family: inherit;"></textarea>
            <div class="message-edit-actions">
                <button id="messageEditCancel" type="button">取消</button>
                <button id="messageEditSave" type="button">保存</button>
            </div>
        </div>
    </div>

    <div id="forwardFriendOverlay" class="forward-friend-overlay">
        <div class="forward-friend-box">
            <div class="forward-friend-head">
                <h3>选择好友</h3>
            </div>
            <div id="forwardFriendList" class="forward-friend-list"></div>
            <div class="forward-friend-actions">
                <button id="forwardFriendCancelBtn" type="button">取消</button>
            </div>
        </div>
    </div>

    <div id="forwardRecordOverlay" class="forward-record-overlay">
        <div class="forward-record-page">
            <div class="forward-record-header">
                <button id="forwardRecordBackBtn" type="button"><i class="fas fa-chevron-left"></i></button>
                <div class="forward-record-title">聊天记录</div>
            </div>
            <div id="forwardRecordBody" class="forward-record-body"></div>
        </div>
    </div>

    <!-- 语音输入模态框 -->
    <div class="modal" id="voiceModal" style="display: none; z-index: 2000;">
        <div
            style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeVoiceModal"
                style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: var(--color-ui-gray); cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: var(--color-ui-gray); font-size: 16px; font-weight: 600;">语音输入</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="voiceText" placeholder="输入或说出的文字..."
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelVoiceInput"
                    style="flex: 1; padding: 10px; background-color: var(--color-ui-bg); border: none; border-radius: 8px; cursor: pointer; color: var(--color-ui-gray); font-weight: 500;">取消</button>
                <button id="confirmVoiceInput"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片描述模态框 -->
    <div class="modal" id="cameraDescModal" style="display: none; z-index: 2000;">
        <div
            style="background-color: white; border-radius: 15px; width: 85%; max-width: 300px; padding: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); position: relative;">
            <!-- 关闭按钮 -->
            <button id="closeCameraDescModal"
                style="position: absolute; top: 12px; right: 12px; background: none; border: none; font-size: 24px; color: var(--color-ui-gray); cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0 0 15px 0; color: var(--color-ui-gray); font-size: 16px; font-weight: 600;">图片描述</h3>

            <div style="margin-bottom: 20px;">
                <textarea id="cameraDescText" placeholder="描述图片内容..."
                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; resize: none; height: 100px; font-size: 14px; font-family: inherit;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="cancelCameraDesc"
                    style="flex: 1; padding: 10px; background-color: var(--color-ui-bg); border: none; border-radius: 8px; cursor: pointer; color: var(--color-ui-gray); font-weight: 500;">取消</button>
                <button id="confirmCameraDesc"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 500;">发送</button>
            </div>
        </div>
    </div>

    <!-- 图片内容弹窗 -->
    <div class="modal" id="imageDescModal" style="display: none; z-index: 2000; background-color: rgba(0, 0, 0, 0.5);">
        <div
            style="background-color: white; border-radius: 18px; width: 90%; max-width: 380px; max-height: 80vh; padding: 24px 24px 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative; display: flex; flex-direction: column; gap: 16px;">
            <button id="closeImageDescModal"
                style="position: absolute; top: 14px; right: 14px; background: none; border: none; font-size: 20px; color: #ccc; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; z-index: 1;"
                class="hover-text-style">
                <i class="fas fa-times"></i>
            </button>

            <h3 style="margin: 0; color: #333; font-size: 17px; font-weight: 600; flex-shrink: 0;">图片描述</h3>

            <div id="imageDescText"
                style="color: #333; font-size: 14.5px; line-height: 1.8; white-space: pre-wrap; word-break: break-word; overflow-y: auto; padding: 16px; background-color: #f9f9f9; border-radius: 12px; border: 1px solid #eee; flex: 1; min-height: 60px; max-height: calc(80vh - 140px); -webkit-overflow-scrolling: touch; overscroll-behavior: contain;">
            </div>

            <button id="imageDescOkBtn" class="btn btn-primary"
                style="width: 100%; height: 44px; border-radius: 12px; flex-shrink: 0;">确定</button>
        </div>
    </div>

    <!-- 确认删除弹窗 -->
    <div class="modal" id="confirmDeleteModal"
        style="z-index: 2001; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: white; border-radius: 30px; padding: 20px 25px; width: 75%; max-width: 240px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: var(--color-ui-gray); font-size: 15px; font-weight: 600;">确认删除？</h3>
            <p style="margin: 0 0 15px 0; color: var(--color-ui-gray); font-size: 13px;">删除后将无法恢复</p>

            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmDeleteYes"
                    style="padding: 10px 25px; background-color: #d32f2f; color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">是</button>
                <button id="confirmDeleteNo"
                    style="padding: 10px 25px; background-color: white; color: var(--color-ui-gray); border: 1px solid var(--color-ui-border); border-radius: 25px; cursor: pointer; font-weight: 600; font-size: 13px; min-width: 70px;">否</button>
            </div>
        </div>
    </div>

    <!-- 心声历史弹窗 -->
    <div class="modal" id="heartVoiceHistoryModal">
        <div class="modal-content" style="height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 id="heartVoiceHistoryTitle">心声历史</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="hv-delete-select-btn" title="选择删除"
                        style="background: linear-gradient(135deg, var(--color-accent-pink), var(--color-accent-lavender)); border: none; color: #fff; cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15); transition: all 0.2s; font-weight: bold;">
                        删
                    </button>
                    <button id="hv-export-select-btn" title="选择导出"
                        style="background: linear-gradient(135deg, var(--color-accent-lavender), var(--color-accent-blue)); border: none; color: #fff; cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15); transition: all 0.2s; font-weight: bold;">
                        导
                    </button>
                    <button class="modal-close" id="closeHeartVoiceHistoryModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="heartVoiceHistoryList">
                    <!-- 历史记录将动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 心声删除确认弹窗 -->
    <div class="modal" id="hvDeleteModal" style="z-index: 2200; display: none; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: white; border-radius: 24px; padding: 24px; width: 70%; max-width: 260px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); text-align: center; animation: fade-in-scale 0.2s ease-out;">
            <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px; font-weight: 600;">删除这条心声？</h3>
            <p style="margin: 0 0 20px 0; color: #999; font-size: 13px;">删除后无法找回哦</p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="hvDeleteConfirm"
                    style="flex: 1; padding: 10px 0; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">删除</button>
                <button id="hvDeleteCancel"
                    style="flex: 1; padding: 10px 0; background-color: var(--color-ui-bg); color: var(--color-ui-gray); border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;">取消</button>
            </div>
        </div>
    </div>

    <!-- 好友设置弹窗 -->
    <div class="modal" id="charSettingsModal">
        <div class="modal-content friend-settings-screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="friendSettingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="friendSettingsStatusSignal" class="fas fa-signal"></i>
                    <i id="friendSettingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="friendSettingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <div class="friend-settings-nav">
                <button id="charSettingsBack" class="friend-settings-back" aria-label="返回">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="friend-settings-title">好友设置</div>
                <span class="friend-settings-spacer"></span>
            </div>
            <div class="friend-settings-body">
                <div class="friend-avatar-wrap">
                    <div id="charAvatarDisplay" class="friend-avatar-display" aria-label="头像">
                        <i class="fas fa-user"></i>
                    </div>
                    <input type="file" id="charAvatarInput" accept="image/*" style="display: none;">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">好友昵称</div>
                    <input id="charNameInput" class="friend-settings-input">
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-label">人设</div>
                    <textarea id="charPersonaInput" class="friend-settings-textarea"
                        placeholder="描述性格、背景或说话风格"></textarea>
                </div>

                <div class="friend-settings-card" style="padding: 20px;">
                    <div class="friend-settings-label" style="margin-bottom: 16px;">挂载模块</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="wb-mount-btn" id="worldbookMountBtn">世界书</button>
                        <button class="wb-mount-btn" id="htmlGameMountBtn">HTML游戏</button>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">对话界面展示</div>
                            <div class="friend-settings-desc">自定义聊天界面显示内容</div>
                        </div>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">对话时间</div>
                        <label class="ios-switch">
                            <input id="chatShowTimeToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">已读</div>
                        <label class="ios-switch">
                            <input id="chatReadToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">隐藏头像</div>
                        <label class="ios-switch">
                            <input id="chatHideAvatarToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                    <div class="friend-settings-row">
                        <div class="friend-settings-desc">方形头像</div>
                        <label class="ios-switch">
                            <input id="chatSquareAvatarToggle" type="checkbox">
                            <span class="ios-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="friend-settings-card">
                    <div class="friend-settings-row">
                        <div>
                            <div class="friend-settings-label">语音 ID</div>
                            <div class="friend-settings-desc">用于语音合成，未填写则自动</div>
                        </div>
                        <span id="voiceIdStatus" class="voice-status">未设置</span>
                    </div>
                    <input id="voiceIdInput" class="friend-settings-input" placeholder="输入语音ID">
                    <select id="voiceIdMode" class="friend-settings-select">
                        <option value="auto">自动选择</option>
                        <option value="fixed">固定使用此ID</option>
                        <option value="random">随机切换</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button id="saveCharSettingsBtn"
                        style="flex: 1; padding: 12px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">保存</button>
                    <button id="deleteCharBtn"
                        style="flex: 1; padding: 12px; background-color: var(--color-ui-bg); color: var(--color-delete-red); border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">删除好友</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置全屏页面 -->
    <div class="modal" id="settingsModal">
        <div class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="settingsStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="settingsStatusSignal" class="fas fa-signal"></i>
                    <i id="settingsStatusWifi" class="fas fa-wifi"></i>
                    <i id="settingsStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="settingsBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">设置</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll">
                <div id="settingsApiCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">API设置</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="configStatus" class="settings-status">未配置</span>
                        <i class="fas fa-chevron-right settings-arrow"></i>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">隐藏状态栏</div>
                        <div class="settings-card-desc">隐藏所有页面顶部的状态栏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="hideStatusBarToggle">
                        <span class="ios-slider"></span>
                    </label>
                </div>

                <div class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">记忆对话条数</div>
                        <div class="settings-card-desc">角色每次回复时参考最近N条对话，数值越大角色记忆越久但响应可能变慢</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="number" id="memoryChatCountInput"
                            style="width: 60px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; text-align: center;"
                            min="1" max="999" value="50">
                        <span style="font-size: 14px; color: var(--color-ui-gray);">条</span>
                    </div>
                </div>

                <div id="settingsDataCard" class="settings-card">
                    <div class="settings-card-content">
                        <div class="settings-card-title">数据管理</div>
                        <div class="settings-card-desc">导入导出、备份与恢复</div>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像选择弹窗 -->
    <div class="modal" id="avatarPickerModal" style="z-index: 2105; display: none; background-color: rgba(0,0,0,0.35);">
        <div
            style="background-color: #FFFFFF; border-radius: 20px; width: 86%; max-width: 320px; padding: 18px; box-shadow: 0 14px 40px rgba(120,119,133,0.2);">
            <h3
                style="margin: 0 0 12px 0; color: var(--color-ui-gray); font-size: 16px; font-weight: 600; text-align: center;">
                更换头像
            </h3>
            <div id="charAvatarModalPreview"
                style="width: 74px; height: 74px; border-radius: 50%; background: var(--color-ui-bg); margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; color: var(--color-ui-gray); font-size: 26px; background-size: cover; background-position: center;">
                <i class="fas fa-user"></i>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input id="charAvatarUrlModalInput" type="text" placeholder="粘贴头像图片URL"
                    style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 14px;">
                <label
                    style="display: block; width: 100%; padding: 10px 12px; border: 1px dashed var(--color-accent-pink); border-radius: 12px; font-size: 14px; color: var(--color-accent-pink); text-align: center; cursor: pointer;">
                    选择本地图片
                    <input id="charAvatarFileModalInput" type="file" accept="image/*" style="display: none;">
                </label>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
                <button id="cancelAvatarPicker"
                    style="flex: 1; padding: 10px; background: var(--color-ui-bg); border: none; border-radius: 12px; cursor: pointer; color: var(--color-ui-gray); font-weight: 600;">取消</button>
                <button id="confirmAvatarPicker"
                    style="flex: 1; padding: 10px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); border: none; border-radius: 12px; cursor: pointer; color: #fff; font-weight: 600;">确定</button>
            </div>
        </div>
    </div>

    <!-- 数据管理二级菜单 -->
    <div class="modal" id="dataManageModal">
        <div class="modal-content" style="max-width: 360px; border-radius: 18px;">
            <div class="modal-header">
                <h3>数据管理</h3>
                <button class="modal-close" id="closeDataManageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="data-manage-list">
                    <button id="exportAllData" class="data-manage-item">导出全部数据</button>
                    <button id="importAllData" class="data-manage-item">导入数据（覆盖当前）</button>
                    <button id="exportFriendsData" class="data-manage-item">仅备份好友数据</button>
                    <button id="exportChatsData" class="data-manage-item">仅备份聊天记录</button>
                </div>
                <input type="file" id="importFileInput" accept="application/json" style="display: none;" />
            </div>
        </div>
    </div>

    <!-- 世界书挂载弹窗 -->
    <div id="worldbookMountModal" class="modal"
        style="display: none; z-index: 2100; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: #FFFFFF; border-radius: 30px; width: 85%; max-width: 340px; padding: 24px 20px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); animation: fadeInScale 0.3s ease-out;">
            <!-- 弹窗标题 -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #333; letter-spacing: 0.3px;">选择世界书</h3>
            </div>

            <!-- 世界书卡片列表 -->
            <div id="worldbookMountList"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 8px 0;">
                <!-- 卡片将动态插入 -->
            </div>

            <!-- 底部按钮 -->
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button id="worldbookMountCancel"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background-color: var(--color-ui-bg); color: #666; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">取消</button>
                <button id="worldbookMountSave"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); color: #fff; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">保存</button>
            </div>
        </div>
    </div>

    <!-- HTML游戏挂载弹窗 -->
    <div id="htmlGameMountModal" class="modal"
        style="display: none; z-index: 2100; background-color: rgba(0, 0, 0, 0.3);">
        <div
            style="background-color: #FFFFFF; border-radius: 30px; width: 85%; max-width: 340px; padding: 24px 20px; box-shadow: 0 10px 40px rgba(120, 119, 133, 0.2); animation: fadeInScale 0.3s ease-out;">
            <!-- 弹窗标题 -->
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #333; letter-spacing: 0.3px;">选择HTML游戏
                </h3>
            </div>

            <!-- HTML游戏卡片列表 -->
            <div id="htmlGameMountList"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; padding: 8px 0;">
                <!-- 卡片将动态插入 -->
            </div>

            <!-- 底部按钮 -->
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button id="htmlGameMountCancel"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background-color: var(--color-ui-bg); color: #666; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">取消</button>
                <button id="htmlGameMountSave"
                    style="flex: 1; padding: 12px 16px; border-radius: 22px; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%); color: #fff; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">保存</button>
            </div>
        </div>
    </div>

    <!-- 个人资料页面弹窗 -->
    <!-- 个人资料页面（查看） -->
    <div class="modal" id="profileModal" style="display: none;">
        <div class="modal-content">
            <div class="status-bar">
                <div id="profileStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="profileStatusSignal" class="fas fa-signal"></i>
                    <i id="profileStatusWifi" class="fas fa-wifi"></i>
                    <i id="profileStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeProfileModal" type="button"
                    onclick="event.stopPropagation(); if (window.closeProfileModal) window.closeProfileModal();">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">个人资料</div>
                <div style="width: 34px;"></div>
            </div>
            <div class="profile-content">
                <div class="profile-header">
                    <div class="profile-bg-gradient"></div>
                    <div class="profile-avatar-section">
                        <div class="profile-avatar" id="profileAvatar"
                            style="background-size: cover; background-position: center;">
                            <i class="fas fa-user-circle" id="profileAvatarIcon"></i>
                        </div>
                    </div>
                    <div class="profile-basic-info">
                        <div class="profile-name-section">
                            <h2 id="profileDisplayName">芋圆</h2>
                        </div>
                        <div class="profile-signature" id="profileSignatureDisplay">这个人很懒，什么都没有留下~</div>
                    </div>
                </div>
                <!-- 信息展示列表 -->
                <div class="profile-cards-section" id="profileCardsSection">
                    <div class="profile-info-card">
                        <div class="profile-info-row">
                            <span class="profile-info-label">QQ号</span>
                            <span class="profile-info-value" id="profileIdDisplay">1234567890</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">生日</span>
                            <span class="profile-info-value" id="profileBirthdayDisplay">未设置</span>
                        </div>
                        <div class="profile-info-row" style="border-bottom: none;">
                            <span class="profile-info-label">所在地</span>
                            <span class="profile-info-value" id="profileLocationDisplay">未设置</span>
                        </div>
                    </div>
                    <!-- 编辑资料入口 -->
                    <div class="profile-card" onclick="if(window.openProfileEditModal) window.openProfileEditModal();">
                        <div class="card-icon"><i class="fas fa-user-edit"></i></div>
                        <div class="card-content">
                            <div class="card-title">编辑资料</div>
                            <div class="card-desc">修改昵称、签名、人设等</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="profile-card" onclick="ModalManager.show('settings')">
                        <div class="card-icon"><i class="fas fa-cog"></i></div>
                        <div class="card-content">
                            <div class="card-title">设置</div>
                            <div class="card-desc">聊天背景更改</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 个人资料编辑页面 -->
    <div class="modal" id="profileEditModal" style="display: none;">
        <div class="modal-content">
            <div class="status-bar">
                <div id="profileEditStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="profileEditStatusSignal" class="fas fa-signal"></i>
                    <i id="profileEditStatusWifi" class="fas fa-wifi"></i>
                    <i id="profileEditStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button class="settings-back" id="closeProfileEditModal" type="button"
                    onclick="event.stopPropagation(); if (window.closeProfileEditModal) window.closeProfileEditModal();">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">编辑资料</div>
                <button class="profile-edit-btn" id="profileSaveBtn" type="button"
                    onclick="event.stopPropagation(); if (window.saveProfileData) window.saveProfileData();"
                    style="font-size: 14px; padding: 6px 14px; border-radius: 16px; width: auto;">
                    保存
                </button>
            </div>
            <div class="profile-content" style="padding: 20px 22px 30px;">
                <!-- 头像上传 -->
                <div class="profile-edit-group" style="text-align: center;">
                    <div id="profileAvatarEdit"
                        style="width: 90px; height: 90px; border-radius: 50%; margin: 0 auto 8px; background: var(--color-bg-input); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 38px; color: var(--color-text-lighter); background-size: cover; background-position: center; position: relative; border: 2px solid var(--glass-border-white);">
                        <i class="fas fa-user-circle" id="profileAvatarEditIcon"></i>
                        <div
                            style="position: absolute; bottom: 0; right: 0; width: 26px; height: 26px; border-radius: 50%; background: var(--color-primary); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--color-text-dark); border: 2px solid #fff;">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <input type="file" id="profileAvatarFileInput" accept="image/*" style="display: none;">
                    <input type="text" id="profileAvatarUrlInput" class="profile-edit-input" placeholder="或粘贴头像图片URL"
                        style="margin-top: 8px; font-size: 13px;">
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">昵称</label>
                    <input type="text" id="profileNameInput" class="profile-edit-input" placeholder="请输入昵称"
                        maxlength="20">
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">QQ号</label>
                    <input type="text" id="profileIdInput" class="profile-edit-input" placeholder="请输入QQ号"
                        maxlength="15">
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">性别</label>
                    <div class="profile-gender-selector">
                        <label class="gender-option">
                            <input type="radio" name="gender" value="female" checked>
                            <span class="gender-icon female"><i class="fas fa-venus"></i></span>
                            <span>女</span>
                        </label>
                        <label class="gender-option">
                            <input type="radio" name="gender" value="male">
                            <span class="gender-icon male"><i class="fas fa-mars"></i></span>
                            <span>男</span>
                        </label>
                        <label class="gender-option">
                            <input type="radio" name="gender" value="other">
                            <span class="gender-icon other"><i class="fas fa-genderless"></i></span>
                            <span>其他</span>
                        </label>
                    </div>
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">个性签名</label>
                    <textarea id="profileSignatureInput" class="profile-edit-input" rows="2" placeholder="写点什么吧..."
                        maxlength="100" style="resize: none;"></textarea>
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">角色人设</label>
                    <textarea id="profilePersonalityInput" class="profile-edit-input" rows="4"
                        placeholder="描述一下你的性格、爱好、特点等..." maxlength="500" style="resize: none;"></textarea>
                    <div class="form-help-text">用于角色更好地理解你的个性</div>
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">生日</label>
                    <input type="date" id="profileBirthdayInput" class="profile-edit-input">
                </div>
                <div class="profile-edit-group">
                    <label class="profile-edit-label">所在地</label>
                    <input type="text" id="profileLocationInput" class="profile-edit-input" placeholder="你在哪个城市呢？"
                        maxlength="50">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { appManager } from './app-manager.js';
        window.appManager = appManager;
    </script>

    <script>
        (() => {
            /**
             * UI配置对象 - 便于未来切换不同UI风格
             * @type {Object}
             */
            const UI_CONFIG = {
                theme: 'iphone',  // 当前主题：iphone | android | desktop
                classes: {
                    // 设备特定UI元素
                    notch: 'notch',
                    statusBar: 'status-bar',
                    homeIndicator: 'home-indicator',
                    // 容器类
                    screen: 'screen',
                    container: 'container',
                    // 聊天相关
                    message: 'message',
                    messageUser: 'user',
                    messageAi: 'ai',
                    // 按钮类
                    btnPrimary: 'btn btn-primary',
                    btnSecondary: 'btn btn-secondary',
                    btnSmall: 'btn btn-small',
                    btnGlass: 'wb-glass-btn',
                    btnClose: 'modal-close',
                    btnBack: 'settings-back',
                    // 输入框类
                    formInput: 'form-control',
                    textArea: 'form-control',
                    chatInput: 'chat-input',
                    // 卡片类
                    cardBase: 'card',
                    cardSettings: 'settings-card',
                    cardFriend: 'friend-settings-card',
                    cardSummary: 'summary-card',
                    cardWorldbook: 'wb-card',
                    cardGame: 'hg-card',
                    cardInfo: 'info-card',
                    cardProfile: 'profile-widget-card',
                    // 列表类
                    listBase: 'list',
                    listFriends: 'friend-list',
                    listItems: 'list-items',
                    listModelPicker: 'model-picker-list',
                    listDataManage: 'data-manage-list',
                    listPageContent: 'page-content-list',
                    // 列表项类
                    itemBase: 'item',
                    itemFriend: 'friend-item',
                    itemMessage: 'message-action-item',
                    itemExtra: 'chat-extra-item',
                    itemNavigation: 'friend-list-nav-item',
                    // 桌面/图标类
                    dockIcon: 'dock-icon',
                    appGrid: 'app-grid',
                    appIcon: 'app-icon',
                    // 可在此扩展更多类名...
                },
                layout: {
                    // 布局相关配置
                    showNotch: true,           // 是否显示刘海
                    showHomeIndicator: true,   // 是否显示Home指示器
                    roundedCorners: true,      // 是否启用圆角
                },
                // 状态栏配置 - 永远保持现有格式不变
                statusBar: {
                    showTime: true,
                    showSignal: true,
                    showWifi: true,
                    showBattery: true,
                },
                // 按钮配置
                buttons: {
                    // 按钮尺寸
                    sizes: {
                        small: { padding: '8px 15px', fontSize: '13px' },
                        normal: { padding: '12px 20px', fontSize: '14px' },
                        large: { padding: '16px 24px', fontSize: '16px' }
                    },
                    // 按钮样式
                    styles: {
                        primary: {
                            background: 'linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary) 100%)',
                            color: 'white'
                        },
                        secondary: {
                            background: 'var(--color-widget-bg)',
                            color: 'var(--color-text)'
                        },
                        danger: {
                            background: 'var(--color-danger)',
                            color: 'white'
                        }
                    }
                },
                // 输入框配置
                inputs: {
                    styles: {
                        default: {
                            borderRadius: '12px',
                            border: '1px solid var(--color-border)',
                            padding: '0 15px',
                            fontSize: '14px'
                        },
                        chat: {
                            borderRadius: '20px',
                            border: '1px solid #ddd',
                            padding: '10px 12px',
                            fontSize: '14px'
                        }
                    },
                    sizes: {
                        small: { height: '36px' },
                        normal: { height: '44px' },
                        large: { height: '52px' }
                    }
                },
                // 卡片配置
                cards: {
                    styles: {
                        default: {
                            borderRadius: '16px',
                            background: 'var(--color-bg-white)',
                            padding: '16px',
                            boxShadow: '0 2px 8px rgba(120, 119, 133, 0.05)'
                        },
                        settings: {
                            borderRadius: '16px',
                            background: 'var(--color-bg-white)',
                            padding: '16px 20px'
                        }
                    }
                },
                // 列表配置
                lists: {
                    styles: {
                        default: {
                            background: 'transparent',
                            padding: '8px 0'
                        },
                        friends: {
                            maxHeight: '100%',
                            overflowY: 'auto',
                            padding: '16px'
                        }
                    }
                }
            };

            /**
             * ========== 功能开关集中配置系统 ==========
             * 所有功能开关统一在此配置，易于管理和切换
             */
            const FeatureConfig = {
                // 聊天功能开关
                chat: {
                    showTime: true,                // 显示消息时间戳
                    hideAvatar: false,             // 隐藏头像
                    showReadReceipt: true,         // 显示已读回执
                    enableTypingIndicator: true,   // 启用打字指示器
                },

                // 界面布局功能
                layout: {
                    roundedCorners: true,          // 启用圆角
                    showNotch: true,               // 显示刘海
                    showHomeIndicator: true,       // 显示Home指示器
                    showStatusBar: true,           // 显示状态栏
                },

                // 状态栏显示配置
                statusBar: {
                    showTime: true,                // 显示时间
                    showSignal: true,              // 显示信号图标
                    showWifi: true,                // 显示WiFi图标
                    showBattery: true,             // 显示电池图标
                },

                // 头像显示配置
                avatar: {
                    show: true,                    // 显示头像
                    enablePreview: true,           // 启用头像预览
                    allowUpload: true,             // 允许上传头像
                },

                // 消息功能开关
                message: {
                    enableDelete: true,            // 启用删除消息
                    enableEdit: false,             // 启用编辑消息
                    enableCopy: true,              // 启用复制消息
                    enableReaction: false,         // 启用表情反应
                },

                // 与好友相关的默认开关
                friend: {
                    defaultShowTime: true,         // 默认显示好友消息时间
                    defaultHideAvatar: false,      // 默认显示好友头像
                    defaultReadStatus: true,       // 默认启用已读状态
                },

                /**
                 * 获取特定功能的配置值
                 * @param {string} path - 配置路径，如 'chat.showTime'
                 * @param {*} defaultValue - 默认值
                 * @returns {*} 配置值
                 */
                get(path, defaultValue = true) {
                    const keys = path.split('.');
                    let value = this;
                    for (const key of keys) {
                        value = value[key];
                        if (value === undefined) return defaultValue;
                    }
                    return value;
                },

                /**
                 * 设置特定功能的配置值
                 * @param {string} path - 配置路径，如 'chat.showTime'
                 * @param {*} value - 新值
                 */
                set(path, value) {
                    const keys = path.split('.');
                    const lastKey = keys.pop();
                    let obj = this;
                    for (const key of keys) {
                        if (!obj[key]) obj[key] = {};
                        obj = obj[key];
                    }
                    obj[lastKey] = value;
                },

                /**
                 * 获取好友的个性化配置（融合全局配置）
                 * @param {Object} friend - 好友对象
                 * @returns {Object} 融合后的配置
                 */
                getFriendConfig(friend) {
                    return {
                        showTime: friend?.chatShowTime ?? this.friend.defaultShowTime,
                        hideAvatar: friend?.chatHideAvatar ?? this.friend.defaultHideAvatar,
                        readStatus: friend?.chatReadStatus ?? this.friend.defaultReadStatus,
                    };
                },

                /**
                 * 检查聊天功能是否启用
                 * @param {string} feature - 功能名称，如 'showTime', 'hideAvatar'
                 * @returns {boolean} 是否启用
                 */
                isChatEnabled(feature) {
                    return this.chat[feature] ?? true;
                },

                /**
                 * 检查布局功能是否启用
                 * @param {string} feature - 功能名称，如 'roundedCorners', 'showNotch'
                 * @returns {boolean} 是否启用
                 */
                isLayoutEnabled(feature) {
                    return this.layout[feature] ?? true;
                },

                /**
                 * 检查状态栏功能是否显示
                 * @param {string} feature - 功能名称，如 'showTime', 'showSignal'
                 * @returns {boolean} 是否显示
                 */
                isStatusBarVisible(feature) {
                    return this.statusBar[feature] ?? true;
                },

                /**
                 * 批量更新配置
                 * @param {Object} updates - 更新对象，如 { 'chat.showTime': false, 'layout.roundedCorners': false }
                 */
                update(updates) {
                    Object.entries(updates).forEach(([path, value]) => {
                        this.set(path, value);
                    });
                }
            };

            /**
             * UI管理器 - 全局UI元素生成和控制
             * 让所有页面/弹窗都能复用统一的UI组件
             */
            const UIManager = {
                config: UI_CONFIG,

                /**
                 * 生成状态栏HTML - 永远保持现有格式不变
                 * @param {Object} options - 可选配置 { showTime, showSignal, showWifi, showBattery }
                 * @returns {string} 状态栏HTML字符串
                 */
                createStatusBar(options = {}) {
                    const { showTime, showSignal, showWifi, showBattery } = {
                        ...this.config.statusBar,
                        ...options
                    };
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const time = `${hours}:${minutes}`;

                    return `
                        <div class="${this.config.classes.statusBar}">
                            ${showTime ? `<span class="time">${time}</span>` : '<span></span>'}
                            <div class="status-icons">
                                ${showSignal ? '<i class="fas fa-signal"></i>' : ''}
                                ${showWifi ? '<i class="fas fa-wifi"></i>' : ''}
                                ${showBattery ? '<i class="fas fa-battery-full"></i>' : ''}
                            </div>
                        </div>
                    `;
                },

                /**
                 * 创建按钮HTML
                 * @param {string} text - 按钮文字
                 * @param {Object} options - 配置 { type: 'primary'|'secondary'|'danger', size: 'small'|'normal'|'large', id, className, onclick }
                 * @returns {string} 按钮HTML字符串
                 */
                createButton(text, options = {}) {
                    const { type = 'primary', size = 'normal', id = '', className = '', onclick = '', disabled = false } = options;

                    const baseClasses = type === 'close' ? this.config.classes.btnClose :
                        type === 'back' ? this.config.classes.btnBack :
                            type === 'glass' ? this.config.classes.btnGlass :
                                `btn btn-${type}`;

                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';
                    const disabledAttr = disabled ? 'disabled' : '';

                    return `<button ${idAttr} class="${allClasses}" ${onclickAttr} ${disabledAttr}>${text}</button>`;
                },

                /**
                 * 创建带图标的按钮HTML
                 * @param {string} icon - Font Awesome图标类名 (如：'fas fa-times')
                 * @param {string} text - 按钮文字（可选）
                 * @param {Object} options - 同createButton的配置
                 * @returns {string} 按钮HTML字符串
                 */
                createIconButton(icon, text = '', options = {}) {
                    const iconHtml = `<i class="${icon}"></i>`;
                    const content = text ? `${iconHtml} <span>${text}</span>` : iconHtml;
                    return this.createButton(content, options);
                },

                /**
                 * 创建返回按钮
                 * @param {Object} options - 配置选项
                 * @returns {string} 返回按钮HTML
                 */
                createBackButton(options = {}) {
                    return this.createIconButton('fas fa-chevron-left', '', {
                        type: 'back',
                        className: this.config.classes.btnBack,
                        ...options
                    });
                },

                /**
                 * 创建关闭按钮
                 * @param {Object} options - 配置选项
                 * @returns {string} 关闭按钮HTML
                 */
                createCloseButton(options = {}) {
                    return this.createIconButton('fas fa-times', '', {
                        type: 'close',
                        className: this.config.classes.btnClose,
                        ...options
                    });
                },

                /**
                 * 创建输入框HTML
                 * @param {Object} options - 配置 { type: 'text'|'password'|'email'|'url', placeholder, value, id, className, size, style }
                 * @returns {string} 输入框HTML字符串
                 */
                createInput(options = {}) {
                    const { type = 'text', placeholder = '', value = '', id = '', className = '', size = 'normal', style = 'default' } = options;

                    const baseClasses = style === 'chat' ? this.config.classes.chatInput : this.config.classes.formInput;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const placeholderAttr = placeholder ? `placeholder="${placeholder}"` : '';
                    const valueAttr = value ? `value="${value}"` : '';

                    return `<input type="${type}" ${idAttr} class="${allClasses}" ${placeholderAttr} ${valueAttr} />`;
                },

                /**
                 * 创建文本域HTML
                 * @param {Object} options - 配置 { placeholder, value, id, className, rows, maxlength }
                 * @returns {string} 文本域HTML字符串
                 */
                createTextarea(options = {}) {
                    const { placeholder = '', value = '', id = '', className = '', rows = 3, maxlength = '' } = options;

                    const baseClasses = this.config.classes.textArea;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const placeholderAttr = placeholder ? `placeholder="${placeholder}"` : '';
                    const rowsAttr = `rows="${rows}"`;
                    const maxlengthAttr = maxlength ? `maxlength="${maxlength}"` : '';

                    return `<textarea ${idAttr} class="${allClasses}" ${placeholderAttr} ${rowsAttr} ${maxlengthAttr}>${value}</textarea>`;
                },

                /**
                 * 创建卡片HTML
                 * @param {string} content - 卡片内容
                 * @param {Object} options - 配置 { type: 'default'|'settings'|'friend', id, className, onclick }
                 * @returns {string} 卡片HTML字符串
                 */
                createCard(content, options = {}) {
                    const { type = 'default', id = '', className = '', onclick = '' } = options;

                    let baseClasses;
                    switch (type) {
                        case 'settings': baseClasses = this.config.classes.cardSettings; break;
                        case 'friend': baseClasses = this.config.classes.cardFriend; break;
                        case 'summary': baseClasses = this.config.classes.cardSummary; break;
                        case 'worldbook': baseClasses = this.config.classes.cardWorldbook; break;
                        case 'game': baseClasses = this.config.classes.cardGame; break;
                        case 'info': baseClasses = this.config.classes.cardInfo; break;
                        case 'profile': baseClasses = this.config.classes.cardProfile; break;
                        default: baseClasses = this.config.classes.cardBase || 'card';
                    }

                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `<div ${idAttr} class="${allClasses}" ${onclickAttr}>${content}</div>`;
                },

                /**
                 * 创建列表HTML
                 * @param {string} items - 列表项内容
                 * @param {Object} options - 配置 { type: 'default'|'friends', id, className }
                 * @returns {string} 列表HTML字符串
                 */
                createList(items, options = {}) {
                    const { type = 'default', id = '', className = '' } = options;

                    let baseClasses;
                    switch (type) {
                        case 'friends': baseClasses = this.config.classes.listFriends; break;
                        case 'model-picker': baseClasses = this.config.classes.listModelPicker; break;
                        case 'data-manage': baseClasses = this.config.classes.listDataManage; break;
                        case 'page-content': baseClasses = this.config.classes.listPageContent; break;
                        default: baseClasses = this.config.classes.listBase || 'list';
                    }

                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';

                    return `<div ${idAttr} class="${allClasses}">${items}</div>`;
                },

                /**
                 * 创建列表项HTML
                 * @param {string} content - 列表项内容
                 * @param {Object} options - 配置 { type: 'default'|'friend'|'message', id, className, onclick }
                 * @returns {string} 列表项HTML字符串
                 */
                createListItem(content, options = {}) {
                    const { type = 'default', id = '', className = '', onclick = '' } = options;

                    let baseClasses;
                    switch (type) {
                        case 'friend': baseClasses = this.config.classes.itemFriend; break;
                        case 'message': baseClasses = this.config.classes.itemMessage; break;
                        case 'extra': baseClasses = this.config.classes.itemExtra; break;
                        case 'navigation': baseClasses = this.config.classes.itemNavigation; break;
                        default: baseClasses = this.config.classes.itemBase || 'item';
                    }

                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `<div ${idAttr} class="${allClasses}" ${onclickAttr}>${content}</div>`;
                },

                /**
                 * 创建桌面图标HTML
                 * @param {string} icon - Font Awesome图标类名
                 * @param {string} label - 图标标签
                 * @param {Object} options - 配置 { type: 'dock'|'app', id, className, onclick }
                 * @returns {string} 桌面图标HTML字符串
                 */
                createDesktopIcon(icon, label, options = {}) {
                    const { type = 'app', id = '', className = '', onclick = '' } = options;

                    const baseClasses = type === 'dock' ? this.config.classes.dockIcon : this.config.classes.appIcon;
                    const allClasses = `${baseClasses} ${className}`.trim();
                    const idAttr = id ? `id="${id}"` : '';
                    const onclickAttr = onclick ? `onclick="${onclick}"` : '';

                    return `
                        <div ${idAttr} class="${allClasses}" ${onclickAttr}>
                            <i class="${icon}"></i>
                            ${label ? `<span>${label}</span>` : ''}
                        </div>
                    `;
                },

                /**
                 * 更新所有状态栏的时间显示 - 保持原有逻辑不变
                 */
                updateAllStatusBarTimes() {
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const time = `${hours}:${minutes}`;
                    document.querySelectorAll('.time').forEach(el => {
                        el.textContent = time;
                    });
                },

                /**
                 * 获取UI类名
                 * @param {string} key - 类名键
                 * @returns {string} 对应的CSS类名
                 */
                getClass(key) {
                    return this.config.classes[key] || key;
                },

                /**
                 * 获取按钮样式配置
                 * @param {string} type - 按钮类型
                 * @param {string} size - 按钮尺寸
                 * @returns {Object} 样式对象
                 */
                getButtonStyle(type, size = 'normal') {
                    return {
                        ...this.config.buttons.sizes[size],
                        ...this.config.buttons.styles[type]
                    };
                },

                /**
                 * 获取输入框样式配置
                 * @param {string} style - 输入框样式类型
                 * @param {string} size - 输入框尺寸
                 * @returns {Object} 样式对象
                 */
                getInputStyle(style = 'default', size = 'normal') {
                    return {
                        ...this.config.inputs.sizes[size],
                        ...this.config.inputs.styles[style]
                    };
                },

                /**
                 * 获取卡片样式配置
                 * @param {string} type - 卡片类型
                 * @returns {Object} 样式对象
                 */
                getCardStyle(type = 'default') {
                    return this.config.cards.styles[type] || this.config.cards.styles.default;
                },

                /**
                 * 获取列表样式配置
                 * @param {string} type - 列表类型
                 * @returns {Object} 样式对象
                 */
                getListStyle(type = 'default') {
                    return this.config.lists.styles[type] || this.config.lists.styles.default;
                },

                /**
                 * 初始化UI管理器
                 */
                init() {
                    // 每分钟更新一次所有状态栏时间
                    setInterval(() => this.updateAllStatusBarTimes(), 60000);
                    console.log('[UIManager] 已初始化，当前主题:', this.config.theme);
                    console.log('[UIManager] 可用组件类型:', Object.keys(this.config.classes));
                },

                /**
                 * 显示UI组件测试界面
                 * 用法：在浏览器控制台输入 UIManager.showUIDemo()
                 */
                showUIDemo() {
                    if (document.getElementById('ui-demo-modal')) {
                        document.getElementById('ui-demo-modal').style.display = 'block';
                        return;
                    }

                    const modal = document.createElement('div');
                    modal.id = 'ui-demo-modal';
                    modal.classList.add('modal');
                    modal.style.display = 'block';
                    modal.style.zIndex = '10000';

                    const demoItems = [
                        this.createListItem('好友列表项示例', { type: 'friend' }),
                        this.createListItem('消息操作项示例', { type: 'message' }),
                        this.createListItem('导航列表项示例', { type: 'navigation' }),
                    ].join('');

                    const demoCards = [
                        this.createCard('<h4>设置卡片</h4><p>这是设置类型的卡片</p>', { type: 'settings' }),
                        this.createCard('<h4>好友卡片</h4><p>这是好友类型的卡片</p>', { type: 'friend' }),
                        this.createCard('<h4>游戏卡片</h4><p>这是游戏类型的卡片</p>', { type: 'game' }),
                    ].join('');

                    const demoIcons = [
                        this.createDesktopIcon('fas fa-message', '聊天'),
                        this.createDesktopIcon('fas fa-cog', '设置'),
                        this.createDesktopIcon('fas fa-heart', '收藏'),
                        this.createDesktopIcon('fas fa-home', '', { type: 'dock' }),
                        this.createDesktopIcon('fas fa-user', '', { type: 'dock' }),
                    ].join('');

                    modal.innerHTML = `
                        <div class="modal-content">
                            ${this.createStatusBar()}
                            <div class="modal-header">
                                ${this.createBackButton({ onclick: 'UIManager.hideUIDemo()' })}
                                <h1>UI组件测试</h1>
                                ${this.createCloseButton({ onclick: 'UIManager.hideUIDemo()' })}
                            </div>
                            <div class="modal-body" style="padding: 20px; max-height: 600px; overflow-y: auto;">
                                <h3>按钮组件</h3>
                                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${this.createButton('主要按钮', { type: 'primary' })}
                                    ${this.createButton('次要按钮', { type: 'secondary' })}
                                    ${this.createButton('危险按钮', { type: 'danger' })}
                                    ${this.createIconButton('fas fa-heart', '图标按钮')}
                                    ${this.createButton('禁用按钮', { disabled: true })}
                                </div>
                                
                                <h3>输入框组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${this.createInput({ placeholder: '默认输入框', style: 'default' })}
                                    <br><br>
                                    ${this.createInput({ placeholder: '聊天输入框', style: 'chat' })}
                                    <br><br>
                                    ${this.createTextarea({ placeholder: '多行文本输入框', rows: 3 })}
                                </div>
                                
                                <h3>卡片组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${demoCards}
                                </div>
                                
                                <h3>列表组件</h3>
                                <div style="margin-bottom: 20px;">
                                    ${this.createList(demoItems, { type: 'friends' })}
                                </div>
                                
                                <h3>桌面图标组件</h3>
                                <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                                    ${demoIcons}
                                </div>
                                
                                <div style="margin-top: 30px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px;">
                                    <h4>测试方法</h4>
                                    <p>在浏览器控制台中可以使用：</p>
                                    <code style="display: block; background: rgba(0,0,0,0.2); padding: 10px; margin: 5px 0; border-radius: 4px;">
UIManager.createButton('测试', {type: 'primary'})<br>
UIManager.createInput({placeholder: '测试输入'})<br>
UIManager.createCard('内容', {type: 'settings'})<br>
UIManager.showUIDemo() // 显示此测试页面<br>
UIManager.hideUIDemo() // 隐藏此测试页面
                                    </code>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                },

                /**
                 * 隐藏UI组件测试界面
                 */
                hideUIDemo() {
                    const modal = document.getElementById('ui-demo-modal');
                    if (modal) {
                        modal.style.display = 'none';
                        // modal.remove(); // 不删除，下次显示更快
                    }
                }
            };

            /**
             * ============================================================
             * UIManager 使用指南
             * ============================================================
             * 
             * 【创建新弹窗页面】
             * ```javascript
             * const modal = document.createElement('div');
             * modal.className = 'modal';
             * modal.innerHTML = `
             *     <div class="modal-content">
             *         ${UIManager.createStatusBar()}
             *         <div class="modal-header">
             *             ${UIManager.createBackButton({ id: 'backBtn' })}
             *             <span>页面标题</span>
             *             ${UIManager.createCloseButton({ id: 'closeBtn' })}
             *         </div>
             *         <div class="modal-body">
             *             ${UIManager.createButton('保存', { type: 'primary', id: 'saveBtn' })}
             *             ${UIManager.createButton('取消', { type: 'secondary', id: 'cancelBtn' })}
             *         </div>
             *     </div>
             * `;
             * ```
             * 
             * 【按钮创建方法】
             * - UIManager.createButton('文字', {type: 'primary|secondary|danger', size: 'small|normal|large'})
             * - UIManager.createIconButton('fas fa-heart', '喜欢', {type: 'primary'})
             * - UIManager.createBackButton({id: 'backBtn'}) 
             * - UIManager.createCloseButton({id: 'closeBtn'})
             * 
             * 【获取统一样式】
             * - element.className = UIManager.getClass('btnPrimary')
             * - const style = UIManager.getButtonStyle('primary', 'large')
             * 
             * 【未来切换UI主题步骤】
             * 1. 修改 UI_CONFIG.theme 为 android 或 desktop
             * 2. 修改 UI_CONFIG.buttons 中的样式配置
             * 3. 在CSS找到 "iPhone特定UI样式" 分段注释
             * 4. 替换对应的样式（如 .notch, .iphone-container）
             * 5. UIManager 会自动使用新的类名和配置
             * 
             * ============================================================
             */

            let friendSystem;
            let apiService;
            let chatSession;
            let heartVoiceSystem;

            /**
             * JSON清洗与修复层
             * 处理API返回的可能包含非JSON内容（如杂散引号、纯文本、错误标记）的响应
             */
            const JSONCleaningLayer = {
                /**
                 * 清洗原始文本，移除前缀杂余内容
                 * @param {string} text - 原始文本
                 * @returns {string} - 清洗后的文本
                 */
                sanitizeRawText(text) {
                    if (!text) return '';

                    // 移除<think>推理块（DeepSeek/Gemini/Claude等模型的思考过程）
                    let cleaned = text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                    // 移除文本开头的markdown代码块标记
                    cleaned = cleaned.replace(/^```(?:json)?\s*\n?/, '').trim();
                    // 移除文本末尾的markdown代码块标记
                    cleaned = cleaned.replace(/\n?```\s*$/, '').trim();
                    // 移除常见的前缀（如 json, JSON等）
                    cleaned = cleaned.replace(/^["']?(?:json|JSON)["']?\s*:\s*/, '').trim();
                    // 移除开头的emoji、锁符号、加密标识等前缀标记
                    cleaned = cleaned.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();
                    cleaned = cleaned.replace(/^(?:encrypted|ENCRYPTED|locked|LOCKED|加密|锁定)[\s：:]*/, '').trim();

                    return cleaned;
                },

                /**
                 * 提取JSON字符串（从混合文本中）
                 * @param {string} text - 可能包含非JSON内容的文本
                 * @returns {string|null} - 提取的JSON字符串，或null如果找不到
                 */
                extractJSON(text) {
                    if (!text) return null;

                    // 使用括号匹配来正确提取JSON对象
                    let braceCount = 0;
                    let startIndex = -1;
                    let inString = false;
                    let escaped = false;

                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];

                        // 处理转义字符
                        if (escaped) {
                            escaped = false;
                            continue;
                        }

                        if (char === '\\') {
                            escaped = true;
                            continue;
                        }

                        // 处理字符串边界
                        if (char === '"' && !escaped) {
                            inString = !inString;
                            continue;
                        }

                        // 如果在字符串内，跳过括号计数
                        if (inString) continue;

                        // 计数大括号
                        if (char === '{') {
                            if (startIndex === -1) startIndex = i;
                            braceCount++;
                        } else if (char === '}') {
                            braceCount--;
                            // 当括号匹配完成时，提取这个JSON对象
                            if (braceCount === 0 && startIndex !== -1) {
                                return text.slice(startIndex, i + 1);
                            }
                        }
                    }

                    // 如果没有找到完整的JSON对象，尝试找JSON数组
                    let bracketCount = 0;
                    startIndex = -1;
                    inString = false;
                    escaped = false;

                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];

                        if (escaped) {
                            escaped = false;
                            continue;
                        }

                        if (char === '\\') {
                            escaped = true;
                            continue;
                        }

                        if (char === '"' && !escaped) {
                            inString = !inString;
                            continue;
                        }

                        if (inString) continue;

                        if (char === '[') {
                            if (startIndex === -1) startIndex = i;
                            bracketCount++;
                        } else if (char === ']') {
                            bracketCount--;
                            if (bracketCount === 0 && startIndex !== -1) {
                                return text.slice(startIndex, i + 1);
                            }
                        }
                    }

                    return null;
                },

                /**
                 * 修复常见的JSON格式错误
                 * @param {string} jsonStr - 可能有格式错误的JSON字符串
                 * @returns {string} - 修复后的JSON字符串
                 */
                fixJSONErrors(jsonStr) {
                    if (!jsonStr) return '';

                    let fixed = jsonStr;

                    // 第一步：移除可能混入的前缀标记（如【inner_voice】等）以及emoji、加密标识
                    fixed = fixed.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s【]*(?:inner_voice|心声|神态|JSON|json|数据|encrypted|ENCRYPTED|locked|LOCKED)[\s】：:]*/gu, '').trim();
                    fixed = fixed.replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();

                    // 修复单引号为双引号（但保留中文引号）
                    // 只替换成对的英文单引号
                    fixed = fixed.replace(/([^\\])'([^']*)'([^\\])/g, '$1"$2"$3');
                    fixed = fixed.replace(/^'([^']*)'/, '"$1"');

                    // 修复未闭合的字符串（尾部的杂散引号）
                    // 计算引号数量，如果是奇数则删除最后的引号
                    const quoteCount = (fixed.match(/"/g) || []).length;
                    if (quoteCount % 2 !== 0) {
                        fixed = fixed.trimEnd();
                        if (fixed.endsWith('"')) {
                            fixed = fixed.slice(0, -1);
                        } else {
                            fixed += '"';
                        }
                    }

                    // 修复末尾缺少的大括号
                    if (fixed.trim().startsWith('{') && !fixed.trim().endsWith('}')) {
                        fixed = fixed.trimEnd() + '}';
                    }

                    // 修复末尾缺少的方括号
                    if (fixed.trim().startsWith('[') && !fixed.trim().endsWith(']')) {
                        fixed = fixed.trimEnd() + ']';
                    }

                    // 修复多余的逗号（JSON末尾）
                    fixed = fixed.replace(/,\s*([}\]])/g, '$1');

                    // 移除控制字符和不可见字符
                    fixed = fixed.replace(/[\x00-\x1F\x7F]/g, '');

                    // === 新增容错：针对Gemini/Claude的边界情况 ===
                    // 处理中文标签前缀（极少见，但有备无患）
                    fixed = fixed.replace(/^【[^】]*】\s*/, '').trim();

                    // 如果最外层不是 { 开头，但包含 reply 字段，尝试快速修复
                    if (!fixed.trim().startsWith('{')) {
                        const replyMatch = fixed.match(/"reply"\s*[：："]\s*"?([^"]+)"?/);
                        if (replyMatch?.[1]) {
                            console.log('[JSON修复] 检测到非JSON格式reply，自动转换');
                            fixed = `{"reply":"${replyMatch[1].replace(/"/g, '\\"')}", "inner_voice": {"心情值": 50}}`;
                        }
                    }

                    return fixed;
                },

                /**
                 * 主清洗与修复函数
                 * @param {string} rawText - API返回的原始文本
                 * @returns {object|null} - 解析后的对象，或null如果失败
                 */
                cleanAndParse(rawText) {
                    if (!rawText || typeof rawText !== 'string') {
                        console.warn('[JSON清洗层] 输入无效，跳过清洗');
                        return null;
                    }

                    try {
                        // 步骤1: 清洗前缀杂余
                        let cleaned = this.sanitizeRawText(rawText);

                        // 步骤2: 提取JSON部分
                        let jsonStr = this.extractJSON(cleaned);
                        if (!jsonStr) {
                            console.warn('[JSON清洗层] 未能提取JSON结构');
                            return null;
                        }

                        // 步骤3: 修复常见格式错误
                        jsonStr = this.fixJSONErrors(jsonStr);

                        // 调试输出
                        console.log('[JSON清洗层] 修复后的JSON（前200字）:', jsonStr.slice(0, 200));

                        // 步骤4: 尝试解析
                        const result = JSON.parse(jsonStr);
                        console.log('[JSON清洗层] 成功解析JSON', {
                            original_length: rawText.length,
                            cleaned_length: jsonStr.length,
                            keys: Object.keys(result)
                        });
                        return result;
                    } catch (error) {
                        console.error('[JSON清洗层] 最终解析失败:', error.message);
                        console.error('[JSON清洗层] 原始文本（前300字）:', rawText.slice(0, 300));
                        return null;
                    }
                },

                /**
                 * 验证并获取安全的值
                 * @param {object} obj - 解析的对象
                 * @param {string} key - 键名
                 * @param {*} defaultValue - 默认值
                 * @returns {*} - 对象中的值或默认值
                 */
                safeGet(obj, key, defaultValue = null) {
                    return obj && typeof obj === 'object' && obj.hasOwnProperty(key) ? obj[key] : defaultValue;
                }
            };

            // 可爱提示框函数
            function showCuteToast(message = '等我⌯･3･⌯ಣ', type = 'default') {
                const cuteToast = document.getElementById('cuteToast');
                if (!cuteToast) return;

                const contentEl = cuteToast.querySelector('.cute-toast-content p');
                if (contentEl) {
                    contentEl.textContent = message;
                }

                cuteToast.style.display = 'block';
                setTimeout(() => {
                    cuteToast.style.display = 'none';
                }, 2000);
            }
            window.showCuteToast = showCuteToast;

            // 自定义错误弹窗函数
            function showCustomErrorModal(errorCode) {
                const customErrorModal = document.getElementById('customErrorModal');
                const customApiErrorText = document.getElementById('customApiErrorText');
                const customErrorOkButton = document.getElementById('customErrorOkButton');

                if (!customErrorModal || !customApiErrorText) return;

                // 格式化错误信息
                let errorMessage = 'API请求失败：';
                if (typeof errorCode === 'object' && errorCode.status) {
                    // 如果是response对象
                    errorMessage += errorCode.status;
                    if (errorCode.message) {
                        errorMessage += ' - ' + errorCode.message;
                    }
                } else if (typeof errorCode === 'number') {
                    // HTTP状态码
                    errorMessage += errorCode;
                } else if (typeof errorCode === 'string') {
                    // 错误信息字符串
                    errorMessage += errorCode;
                } else {
                    errorMessage += '未知错误';
                }

                customApiErrorText.textContent = errorMessage;
                ModalManager.show('customError');

                // 移除旧的事件监听器并添加新的
                if (customErrorOkButton) {
                    const newButton = customErrorOkButton.cloneNode(true);
                    customErrorOkButton.parentNode.replaceChild(newButton, customErrorOkButton);

                    // 重新获取克隆后的按钮
                    const clonedButton = document.getElementById('customErrorOkButton');
                    if (clonedButton) {
                        clonedButton.addEventListener('click', function () {
                            ModalManager.hide('customError');
                        });
                    }
                }

                // 点击背景关闭（只添加一次）
                customErrorModal.onclick = function (e) {
                    if (e.target === customErrorModal) {
                        ModalManager.hide('customError');
                    }
                };
            }


            // 重写 alert 函数
            window.alert = function (message) {
                showCuteToast();
            };

            // 消息通知横幅
            let _notifTimer = null;
            function showMsgNotification(friendName, content, avatarUrl, onTap) {
                const banner = document.getElementById('msgNotifBanner');
                if (!banner) return;

                // 设置头像
                const avatarEl = document.getElementById('msgNotifAvatar');
                if (avatarEl) {
                    if (avatarUrl) {
                        avatarEl.innerHTML = '<img src="' + avatarUrl + '" alt="' + friendName + '">';
                    } else {
                        avatarEl.innerHTML = '<i class="fas fa-user"></i>';
                    }
                }

                // 设置名称和内容
                const nameEl = document.getElementById('msgNotifName');
                const textEl = document.getElementById('msgNotifText');
                if (nameEl) nameEl.textContent = friendName || '';
                if (textEl) {
                    const preview = (content || '').replace(/\s+/g, ' ').trim();
                    textEl.textContent = preview.length > 30 ? preview.substring(0, 30) + '...' : preview;
                }

                // 清除之前的定时器
                if (_notifTimer) clearTimeout(_notifTimer);

                // 移除旧的点击事件
                const newBanner = banner.cloneNode(true);
                banner.parentNode.replaceChild(newBanner, banner);

                // 绑定点击事件
                if (onTap) {
                    newBanner.addEventListener('click', () => {
                        newBanner.classList.remove('is-visible');
                        if (_notifTimer) clearTimeout(_notifTimer);
                        onTap();
                    });
                }

                // 显示横幅
                requestAnimationFrame(() => {
                    newBanner.classList.add('is-visible');
                });

                // 自动隐藏
                _notifTimer = setTimeout(() => {
                    newBanner.classList.remove('is-visible');
                }, 4000);
            }

            // 基础功能
            // ========== 通用 LocalStorage 管理系统 ==========
            const StorageManager = {
                /**
                 * 获取存储的数据（自动 JSON 解析）
                 * @param {string} key - 存储键名
                 * @param {*} defaultValue - 默认值
                 * @returns {*} - 解析后的数据或默认值
                 */
                get(key, defaultValue = null) {
                    try {
                        const data = localStorage.getItem(key);
                        return data ? JSON.parse(data) : defaultValue;
                    } catch (e) {
                        console.error(`[StorageManager] 读取失败 (${key}):`, e);
                        return defaultValue;
                    }
                },

                /**
                 * 保存数据（自动 JSON 序列化）
                 * @param {string} key - 存储键名
                 * @param {*} value - 要保存的数据
                 */
                set(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                    } catch (e) {
                        console.error(`[StorageManager] 保存失败 (${key}):`, e);
                    }
                },

                /**
                 * 删除指定键
                 * @param {string} key - 存储键名
                 */
                remove(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch (e) {
                        console.error(`[StorageManager] 删除失败 (${key}):`, e);
                    }
                },

                /**
                 * 批量删除（支持前缀匹配）
                 * @param {string|string[]} keys - 键名或键名数组或前缀
                 */
                removeBatch(keys) {
                    if (Array.isArray(keys)) {
                        keys.forEach(key => this.remove(key));
                    } else if (typeof keys === 'string') {
                        // 如果是字符串，按前缀匹配删除
                        const allKeys = Object.keys(localStorage);
                        allKeys.forEach(key => {
                            if (key.startsWith(keys)) {
                                this.remove(key);
                            }
                        });
                    }
                },

                /**
                 * 清空所有存储
                 */
                clear() {
                    try {
                        localStorage.clear();
                    } catch (e) {
                        console.error('[StorageManager] 清空失败:', e);
                    }
                },

                /**
                 * 检查键是否存在
                 * @param {string} key - 存储键名
                 * @returns {boolean}
                 */
                has(key) {
                    return localStorage.getItem(key) !== null;
                }
            };

            // 暴露到全局，供第二个脚本块使用
            window.StorageManager = StorageManager;

            // ========== 通用模态窗口管理系统 ==========
            const ModalManager = {
                modals: {},

                /**
                 * 注册模态窗口
                 * @param {string} name - 模态窗口名称
                 * @param {object} config - 配置 { modal: 'id', status: 'id'(可选), onShow: fn(可选), onHide: fn(可选) }
                 */
                register(name, config) {
                    this.modals[name] = {
                        modal: document.getElementById(config.modal),
                        status: config.status ? document.getElementById(config.status) : null,
                        onShow: config.onShow || null,
                        onHide: config.onHide || null
                    };
                },

                /**
                 * 批量注册
                 */
                registerBatch(configs) {
                    configs.forEach(config => this.register(config.name, config));
                },

                /**
                 * 显示模态窗口
                 */
                show(name, hideStatus = true) {
                    const m = this.modals[name];
                    if (!m) return;

                    if (m.modal) m.modal.style.display = 'flex';
                    if (m.status && hideStatus) m.status.style.display = 'none';
                    if (m.onShow) m.onShow();
                },

                /**
                 * 隐藏模态窗口
                 */
                hide(name, hideStatus = true) {
                    const m = this.modals[name];
                    if (!m) return;

                    if (m.modal) m.modal.style.display = 'none';
                    if (m.status && hideStatus) m.status.style.display = 'none';
                    if (m.onHide) m.onHide();
                },

                /**
                 * 切换：隐藏一个，显示另一个
                 */
                switch(fromName, toName) {
                    this.hide(fromName);
                    this.show(toName);
                }
            };

            // 注册所有模态窗口（集中配置）
            ModalManager.registerBatch([
                { name: 'api', modal: 'apiModal', status: 'apiStatus' },
                { name: 'chat', modal: 'chatModal', status: 'chatStatus' },
                { name: 'settings', modal: 'settingsModal' },
                { name: 'friendList', modal: 'friendListModal' },
                { name: 'addFriend', modal: 'addFriendModal' },
                { name: 'dataManage', modal: 'dataManageModal' },
                { name: 'charSettings', modal: 'charSettingsModal' },
                { name: 'avatarPicker', modal: 'avatarPickerModal' },
                { name: 'confirmDelete', modal: 'confirmDeleteModal' },
                { name: 'worldbookMount', modal: 'worldbookMountModal' },
                { name: 'htmlGameMount', modal: 'htmlGameMountModal' },
                { name: 'worldbook', modal: 'worldbookModal' },
                { name: 'imageConfirm', modal: 'imageConfirmPopover' },
                { name: 'customError', modal: 'customErrorModal' },
                { name: 'summary', modal: 'summaryModal' },
                { name: 'bigSummary', modal: 'bigSummaryModal' },
                { name: 'profile', modal: 'profileModal' },
                { name: 'profileEdit', modal: 'profileEditModal' }
            ]);

            // 暴露到全局，供第二个脚本块和 inline onclick 使用
            window.ModalManager = ModalManager;

            // ========== 通用状态栏管理系统（自动发现更新） ==========
            const StatusBarManager = {
                mainTimeEl: null,

                /**
                 * 初始化主状态栏元素
                 */
                initMainStatusBar(timeEl, signalEl, wifiEl, batteryEl) {
                    this.mainTimeEl = timeEl;
                },

                /**
                 * 自动发现并更新所有状态栏元素
                 * 通过 ID 模式匹配，无需预先注册，自动发现所有 .time 类和状态栏元素
                 */
                updateAllPages(status) {
                    if (!status) return;

                    // 一次性更新所有时间元素（.time 类）
                    if (status.time) {
                        document.querySelectorAll('.time').forEach(el => {
                            el.textContent = status.time;
                        });
                    }

                    // 自动发现并更新所有信号图标（ID 包含 Signal）
                    if (status.signal) {
                        document.querySelectorAll('[id*="Signal"]').forEach(el => {
                            el.className = `fas ${status.signal}`;
                        });
                    }

                    // 自动发现并更新所有WiFi图标（ID 包含 Wifi）
                    if (status.wifi) {
                        document.querySelectorAll('[id*="Wifi"]').forEach(el => {
                            el.className = `fas ${status.wifi}`;
                        });
                    }

                    // 自动发现并更新所有电池图标（ID 包含 Battery）
                    if (status.battery) {
                        document.querySelectorAll('[id*="Battery"]').forEach(el => {
                            el.className = `fas ${status.battery}`;
                        });
                    }
                }
            };

            // 初始化主状态栏（直接传入元素引用）
            StatusBarManager.initMainStatusBar(
                document.getElementById('statusTime'),
                document.getElementById('statusSignal'),
                document.getElementById('statusWifi'),
                document.getElementById('statusBattery')
            );

            // 新的统一状态栏更新函数（替代之前的 applyStatusBar）
            function applyStatusBar(status) {
                StatusBarManager.updateAllPages(status);
            }

            // 新的统一时间更新函数（替代之前的 updateTime）
            function updateTime() {
                // 获取北京时间（UTC+8）
                const now = new Date();
                const beijingTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
                const h = String(beijingTime.getHours()).padStart(2, '0');
                const m = String(beijingTime.getMinutes()).padStart(2, '0');
                const timeStr = `${h}:${m}`;

                // 一次性更新所有页面
                StatusBarManager.updateAllPages({ time: timeStr });

                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({ time: timeStr });
                }
            }
            updateTime();
            if (window.appManager && typeof window.appManager.on === 'function') {
                window.appManager.on('status-change', applyStatusBar);
                if (typeof window.appManager.getStatus === 'function') {
                    applyStatusBar(window.appManager.getStatus());
                }
            }
            setInterval(updateTime, 1000);



            function launchApp(appId) {
                if (!window.appManager || typeof window.appManager.launch !== 'function') return;
                try {
                    window.appManager.launch(appId);
                } catch (e) {
                    console.warn('APP 启动失败:', e);
                }
            }


            // 图标元素
            const phoneIcon = document.getElementById('phoneIcon');
            const novelIcon = document.getElementById('novelIcon');
            const forumIcon = document.getElementById('forumIcon');
            const appGrid = document.getElementById('appGrid');

            // 模态窗口元素
            const apiModal = document.getElementById('apiModal');
            const chatModal = document.getElementById('chatModal');
            const settingsModal = document.getElementById('settingsModal');
            const friendListModal = document.getElementById('friendListModal');
            const addFriendModal = document.getElementById('addFriendModal');

            // API配置相关元素
            const apiUrlInput = document.getElementById('apiUrl');
            const apiKeyInput = document.getElementById('apiKey');
            const fetchModelsBtn = document.getElementById('fetchModels');
            const fetchBtnText = document.getElementById('fetchBtnText');
            const fetchLoading = document.getElementById('fetchLoading');
            const modelSelect = document.getElementById('modelSelect');
            const modelPickerButton = document.getElementById('modelPickerButton');
            const modelPickerText = document.getElementById('modelPickerText');
            const modelPickerList = document.getElementById('modelPickerList');
            const saveApiBtn = document.getElementById('saveApi');
            const apiStatus = document.getElementById('apiStatus');

            // 设置显示元素
            const configStatus = document.getElementById('configStatus');

            // 好友列表相关元素
            const friendListElement = document.getElementById('friendList');
            const noFriends = document.getElementById('noFriends');
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarInput = document.getElementById('avatarInput');
            const friendName = document.getElementById('friendName');
            const friendPersona = document.getElementById('friendPersona');
            const confirmAddFriend = document.getElementById('confirmAddFriend');
            const cancelAddFriend = document.getElementById('cancelAddFriend');
            const addFriendStatus = document.getElementById('addFriendStatus');
            const closeFriendListModal = document.getElementById('closeFriendListModal');
            const closeAddFriendModal = document.getElementById('closeAddFriendModal');

            // 聊天相关元素
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessage');
            const chatMessages = document.getElementById('chatMessages');
            const chatStatus = document.getElementById('chatStatus');
            const chatTitle = document.getElementById('chatTitle');

            const replyPreview = document.getElementById('replyPreview');
            const replyPreviewText = document.getElementById('replyPreviewText');
            const replyPreviewClose = document.getElementById('replyPreviewClose');

            const imageUploadPill = document.getElementById('imageUploadPill');
            const imageUploadThumb = document.getElementById('imageUploadThumb');
            const imageUploadName = document.getElementById('imageUploadName');
            const imageUploadClose = document.getElementById('imageUploadClose');
            const imageUploadBtn = document.getElementById('imageUploadBtn');
            const imageInput = document.getElementById('imageInput');
            const imageConfirmPopover = document.getElementById('imageConfirmPopover');
            const imageConfirmYes = document.getElementById('imageConfirmYes');
            const imageConfirmNo = document.getElementById('imageConfirmNo');
            const chatPlusBtn = document.getElementById('chatPlusBtn');
            const chatExtraPanel = document.getElementById('chatExtraPanel');
            const chatInputAreaWrap = document.getElementById('chatInputAreaWrap');
            const chatInputRow = document.querySelector('.chat-input-row');

            const messageActionOverlay = document.getElementById('messageActionOverlay');
            const messageActionMenu = document.getElementById('messageActionMenu');
            const messageActionCopy = document.getElementById('messageActionCopy');
            const messageActionDelete = document.getElementById('messageActionDelete');
            const messageActionRecall = document.getElementById('messageActionRecall');
            const messageActionReply = document.getElementById('messageActionReply');

            const triggerAiBtn = document.getElementById('triggerAiBtn');
            // 关闭按钮
            const closeApiModal = document.getElementById('closeApiModal');
            const backToFriendList = document.getElementById('backToFriendList');
            const closeSettingsModal = document.getElementById('settingsBack');
            const openApiConfig = document.getElementById('openApiConfig');
            const settingsApiCard = document.getElementById('settingsApiCard');
            const settingsDataCard = document.getElementById('settingsDataCard');
            const dataManageModal = document.getElementById('dataManageModal');
            const closeDataManageModal = document.getElementById('closeDataManageModal');
            const exportAllDataBtn = document.getElementById('exportAllData');
            const importAllDataBtn = document.getElementById('importAllData');
            const exportFriendsDataBtn = document.getElementById('exportFriendsData');
            const exportChatsDataBtn = document.getElementById('exportChatsData');
            const importFileInput = document.getElementById('importFileInput');

            // ========== APP入口清单（集中管理） ==========
            const APP_ENTRY_POINTS = {
                home: ['message', 'feixin', 'worldbook', 'settings', 'phone', 'forum'],
                dock: ['phone', 'novel', 'forum']
            };

            function openAppWithNotice(appId, name, notice) {
                launchApp(appId);
                if (notice) alert(notice);
            }

            const APP_HANDLERS = {
                message: () => openAppWithNotice('message', '消息', '消息功能开发中...'),
                feixin: () => {
                    launchApp('feixin');
                    ModalManager.show('friendList');
                    renderFriendList();
                },
                worldbook: () => {
                    launchApp('worldbook');
                    ModalManager.show('worldbook');
                },
                settings: () => {
                    launchApp('settings');
                    ModalManager.show('settings');
                    if (apiService) apiService.updateSettingsDisplay();
                },
                beautify: () => openAppWithNotice('beautify', '美化', '美化功能开发中...'),
                phone: () => openAppWithNotice('phone', '手机', '手机功能开发中...'),
                novel: () => openAppWithNotice('novel', '小说', '小说功能开发中...'),
                forum: () => openAppWithNotice('forum', '论坛', '论坛功能开发中...')
            };

            // ========== 图标点击事件 ==========
            function handleAppClick(appId) {
                const handler = APP_HANDLERS[appId];
                if (handler) {
                    handler();
                    return;
                }
                launchApp(appId);
                alert('功能开发中...');
            }

            // Dock栏图标
            if (phoneIcon) {
                phoneIcon.addEventListener('click', () => handleAppClick('phone'));
            }

            if (novelIcon) {
                novelIcon.addEventListener('click', () => handleAppClick('novel'));
            }

            if (forumIcon) {
                forumIcon.addEventListener('click', () => handleAppClick('forum'));
            }

            // ========== 模态窗口控制 ==========

            closeApiModal.addEventListener('click', () => {
                ModalManager.switch('api', 'settings');
            });

            backToFriendList.addEventListener('click', () => {
                if (chatSession && chatSession.multiSelect && chatSession.multiSelect.active) {
                    chatSession.exitMultiSelectMode();
                }
                ModalManager.switch('chat', 'friendList');
                if (heartVoiceSystem) heartVoiceSystem.closePopup();
                renderFriendList();
            });

            closeSettingsModal.addEventListener('click', () => {
                ModalManager.hide('settings');
            });


            if (settingsApiCard) {
                settingsApiCard.addEventListener('click', () => {
                    ModalManager.switch('settings', 'api');

                    if (!apiService) return;
                    const config = apiService.getConfig();
                    if (config.apiUrl) {
                        apiUrlInput.value = config.apiUrl;
                    }
                    if (config.apiKey) {
                        apiKeyInput.value = config.apiKey;
                    }
                    if (config.models && config.models.length > 0) {
                        apiService.updateModelSelect(config.models);
                    }
                    // 打开模态框时重新渲染预设列表
                    apiService.renderPresetList();
                });
            }

            if (settingsDataCard) {
                settingsDataCard.addEventListener('click', () => {
                    ModalManager.show('dataManage');
                });
            }

            if (closeDataManageModal) {
                closeDataManageModal.addEventListener('click', () => {
                    ModalManager.hide('dataManage');
                });
            }

            closeFriendListModal.addEventListener('click', () => {
                ModalManager.hide('friendList');
            });

            // 好友列表导航栏事件处理
            const navItems = document.querySelectorAll('.friend-list-nav-item');
            if (navItems.length > 0) {
                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const navType = item.dataset.nav;
                        navItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');

                        if (navType === 'messages') {
                            // 当前已是消息列表，无需做额外处理
                            console.log('显示消息列表');
                        } else if (navType === 'moments') {
                            alert('动态功能开发中...');
                        } else if (navType === 'me') {
                            // 切页到“我”：优先调用个人页入口，失败时兜底强制切页
                            if (typeof window.openProfileModal === 'function') {
                                window.openProfileModal({ from: 'friendList' });
                            } else {
                                ModalManager.switch('friendList', 'profile');
                            }
                        }
                    });
                });
            }

            // 好友列表中的添加好友按钮
            const addFriendFromList = document.getElementById('addFriendFromList');
            if (addFriendFromList) {
                addFriendFromList.addEventListener('click', () => {
                    ModalManager.show('addFriend');
                    resetAddFriendForm();
                });
            }

            closeAddFriendModal.addEventListener('click', () => {
                ModalManager.hide('addFriend');
                resetAddFriendForm();
            });

            // 好友设置相关
            const charSettingsModal = document.getElementById('charSettingsModal');
            const charSettingsBtn = document.getElementById('charSettingsBtn');
            const charSettingsBack = document.getElementById('charSettingsBack');
            const charNameInput = document.getElementById('charNameInput');
            const charPersonaInput = document.getElementById('charPersonaInput');
            const charAvatarDisplay = document.getElementById('charAvatarDisplay');
            const charAvatarInput = document.getElementById('charAvatarInput');
            const voiceIdInput = document.getElementById('voiceIdInput');
            const voiceIdMode = document.getElementById('voiceIdMode');
            const voiceIdStatus = document.getElementById('voiceIdStatus');
            const chatShowTimeToggle = document.getElementById('chatShowTimeToggle');
            const chatReadToggle = document.getElementById('chatReadToggle');
            const chatHideAvatarToggle = document.getElementById('chatHideAvatarToggle');
            const avatarPickerModal = document.getElementById('avatarPickerModal');
            const charAvatarUrlModalInput = document.getElementById('charAvatarUrlModalInput');
            const charAvatarFileModalInput = document.getElementById('charAvatarFileModalInput');
            const charAvatarModalPreview = document.getElementById('charAvatarModalPreview');
            const cancelAvatarPicker = document.getElementById('cancelAvatarPicker');
            const confirmAvatarPicker = document.getElementById('confirmAvatarPicker');
            const saveCharSettingsBtn = document.getElementById('saveCharSettingsBtn');
            const deleteCharBtn = document.getElementById('deleteCharBtn');
            let pendingCharAvatar = '';
            let modalAvatarTemp = '';

            function updateVoiceStatus(value) {
                if (!voiceIdStatus) return;
                const hasValue = !!value;
                voiceIdStatus.textContent = hasValue ? '已设置' : '未设置';
            }

            function setCharAvatarDisplay(avatarUrl) {
                if (!charAvatarDisplay) return;
                if (avatarUrl) {
                    charAvatarDisplay.style.backgroundImage = `url('${avatarUrl}')`;
                    charAvatarDisplay.classList.add('has-image');
                } else {
                    charAvatarDisplay.style.backgroundImage = '';
                    charAvatarDisplay.classList.remove('has-image');
                }
            }

            function setAvatarModalPreview(avatarUrl) {
                if (!charAvatarModalPreview) return;
                if (avatarUrl) {
                    charAvatarModalPreview.style.backgroundImage = `url('${avatarUrl}')`;
                    charAvatarModalPreview.innerHTML = '';
                } else {
                    charAvatarModalPreview.style.backgroundImage = '';
                    charAvatarModalPreview.innerHTML = '<i class="fas fa-user"></i>';
                }
            }

            // 打开好友设置
            charSettingsBtn.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);

                    if (friend) {
                        charNameInput.value = friend.name;
                        charPersonaInput.value = friend.persona || '';
                        pendingCharAvatar = friend.avatar || '';
                        setCharAvatarDisplay(pendingCharAvatar);
                        if (voiceIdInput) {
                            voiceIdInput.value = friend.voiceId || '';
                            updateVoiceStatus(voiceIdInput.value.trim());
                        }
                        if (voiceIdMode) {
                            voiceIdMode.value = friend.voiceIdMode || 'auto';
                        }
                        if (chatShowTimeToggle) {
                            chatShowTimeToggle.checked = friend.chatShowTime ?? FeatureConfig.friend.defaultShowTime;
                        }
                        if (chatReadToggle) {
                            chatReadToggle.checked = friend.chatReadStatus ?? FeatureConfig.friend.defaultReadStatus;
                        }
                        if (chatHideAvatarToggle) {
                            chatHideAvatarToggle.checked = friend.chatHideAvatar ?? FeatureConfig.friend.defaultHideAvatar;
                        }
                        const chatSquareAvatarToggle = document.getElementById('chatSquareAvatarToggle');
                        if (chatSquareAvatarToggle) {
                            chatSquareAvatarToggle.checked = friend.chatSquareAvatar ?? false;
                        }
                        if (charAvatarInput) {
                            charAvatarInput.value = '';
                        }
                        modalAvatarTemp = pendingCharAvatar || '';
                        ModalManager.show('charSettings');
                    }
                }
            });

            // 关闭好友设置
            if (charSettingsBack) {
                charSettingsBack.addEventListener('click', () => {
                    ModalManager.hide('charSettings');
                });
            }

            // 点击背景关闭
            charSettingsModal.addEventListener('click', (e) => {
                if (e.target === charSettingsModal) {
                    ModalManager.hide('charSettings');
                }
            });

            // 更换头像
            function openAvatarPicker() {
                if (!avatarPickerModal) return;
                modalAvatarTemp = pendingCharAvatar || '';
                if (charAvatarUrlModalInput) {
                    charAvatarUrlModalInput.value = modalAvatarTemp && !modalAvatarTemp.startsWith('data:') ? modalAvatarTemp : '';
                }
                if (charAvatarFileModalInput) {
                    charAvatarFileModalInput.value = '';
                }
                setAvatarModalPreview(modalAvatarTemp);
                ModalManager.show('avatarPicker');
            }

            if (charAvatarDisplay) {
                charAvatarDisplay.addEventListener('click', openAvatarPicker);
            }

            if (charAvatarUrlModalInput) {
                charAvatarUrlModalInput.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    modalAvatarTemp = url;
                    setAvatarModalPreview(url);
                });
            }

            if (voiceIdInput) {
                voiceIdInput.addEventListener('input', (e) => {
                    updateVoiceStatus(e.target.value.trim());
                });
            }

            if (charAvatarFileModalInput) {
                charAvatarFileModalInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        modalAvatarTemp = imageUrl;
                        // 立即更新到pendingCharAvatar，实现即时预览
                        pendingCharAvatar = imageUrl;
                        setAvatarModalPreview(imageUrl);
                        setCharAvatarDisplay(imageUrl);
                        if (charAvatarUrlModalInput) {
                            charAvatarUrlModalInput.value = '';
                        }

                        // Safari兼容性：强制重绘
                        if (charAvatarDisplay) {
                            void charAvatarDisplay.offsetWidth;
                            charAvatarDisplay.style.opacity = '0.99';
                            setTimeout(() => {
                                charAvatarDisplay.style.opacity = '1';
                            }, 10);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (cancelAvatarPicker && avatarPickerModal) {
                cancelAvatarPicker.addEventListener('click', () => {
                    ModalManager.hide('avatarPicker');
                });
            }

            if (confirmAvatarPicker && avatarPickerModal) {
                confirmAvatarPicker.addEventListener('click', () => {
                    const urlValue = charAvatarUrlModalInput ? charAvatarUrlModalInput.value.trim() : '';
                    // 优先使用URL输入，其次使用已上传的文件（pendingCharAvatar已在文件选择时更新）
                    if (urlValue) {
                        pendingCharAvatar = urlValue;
                    } else if (!pendingCharAvatar && modalAvatarTemp) {
                        pendingCharAvatar = modalAvatarTemp;
                    }
                    // 如果pendingCharAvatar已有值（文件上传时设置），则保持不变
                    setCharAvatarDisplay(pendingCharAvatar);
                    ModalManager.hide('avatarPicker');
                });
            }

            if (avatarPickerModal) {
                avatarPickerModal.addEventListener('click', (e) => {
                    if (e.target === avatarPickerModal) {
                        ModalManager.hide('avatarPicker');
                    }
                });
            }

            // 保存好友设置
            saveCharSettingsBtn.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                const newName = charNameInput.value.trim();

                if (!newName) {
                    showCuteToast('请输入好友昵称');
                    return;
                }

                const sqToggle = document.getElementById('chatSquareAvatarToggle');
                const updated = friendSystem ? friendSystem.updateFriend(currentFriendId, {
                    name: newName,
                    persona: charPersonaInput.value.trim(),
                    avatar: pendingCharAvatar || null,
                    voiceId: voiceIdInput ? voiceIdInput.value.trim() : '',
                    voiceIdMode: voiceIdMode ? voiceIdMode.value : 'auto',
                    chatShowTime: chatShowTimeToggle ? chatShowTimeToggle.checked : FeatureConfig.friend.defaultShowTime,
                    chatReadStatus: chatReadToggle ? chatReadToggle.checked : FeatureConfig.friend.defaultReadStatus,
                    chatHideAvatar: chatHideAvatarToggle ? chatHideAvatarToggle.checked : FeatureConfig.friend.defaultHideAvatar,
                    chatSquareAvatar: sqToggle ? sqToggle.checked : false
                }) : null;
                if (updated) {
                    ModalManager.hide('charSettings');
                    if (chatSession) {
                        // 更新聊天对话框标题
                        chatTitle.textContent = newName;

                        // 更新聊天界面头像
                        const chatHeader = chatModal.querySelector('.modal-header');
                        const existingAvatar = document.getElementById('chatFriendAvatarIcon');

                        if (existingAvatar) {
                            existingAvatar.remove();
                        }

                        if (pendingCharAvatar && chatHeader) {
                            const avatarIcon = document.createElement('div');
                            avatarIcon.id = 'chatFriendAvatarIcon';
                            avatarIcon.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center;';

                            const avatarImg = document.createElement('img');
                            avatarImg.src = pendingCharAvatar;
                            avatarImg.alt = newName;
                            avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                            avatarImg.onerror = () => {
                                avatarIcon.innerHTML = '<i class="fas fa-user" style="font-size: 16px; color: #999;"></i>';
                            };

                            avatarIcon.appendChild(avatarImg);
                            chatHeader.insertBefore(avatarIcon, chatTitle);
                        }

                        chatSession.showChatStatus('好友设置已保存', 'success');
                        // 刷新聊天消息中的头像形状和隐藏状态
                        const sq = sqToggle ? sqToggle.checked : false;
                        const hd = chatHideAvatarToggle ? chatHideAvatarToggle.checked : false;
                        chatMessages.querySelectorAll('.msg-avatar').forEach(el => {
                            el.classList.toggle('square', sq);
                            el.style.visibility = hd ? 'hidden' : '';
                        });
                    }
                    // 刷新好友列表
                    renderFriendList();
                }
            });

            // 删除好友
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const confirmDeleteYes = document.getElementById('confirmDeleteYes');
            const confirmDeleteNo = document.getElementById('confirmDeleteNo');

            deleteCharBtn.addEventListener('click', () => {
                ModalManager.show('confirmDelete');
            });

            confirmDeleteYes.addEventListener('click', () => {
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                const removed = friendSystem ? friendSystem.deleteFriend(currentFriendId) : null;

                if (removed && currentFriendId) {
                    // 清除该好友的所有相关数据
                    StorageManager.removeBatch([
                        CHAT_PREFIX + currentFriendId,
                        `persona_${currentFriendId}`,
                        `heartvoice_${currentFriendId}`
                    ]);

                    // 删除包含好友ID的其他相关配置
                    const allKeys = Object.keys(localStorage);
                    allKeys.forEach(key => {
                        if (key.includes(currentFriendId)) {
                            StorageManager.remove(key);
                        }
                    });

                    ModalManager.hide('confirmDelete');
                    ModalManager.hide('charSettings');
                    ModalManager.switch('chat', 'friendList');
                    if (chatSession) chatSession.setCurrentFriendId(null);
                    renderFriendList();
                }
            });

            confirmDeleteNo.addEventListener('click', () => {
                ModalManager.hide('confirmDelete');
            });

            // ========== 世界书挂载模块 ==========
            const worldbookMountBtn = document.getElementById('worldbookMountBtn');
            const worldbookMountModal = document.getElementById('worldbookMountModal');
            const worldbookMountList = document.getElementById('worldbookMountList');
            const worldbookMountCancel = document.getElementById('worldbookMountCancel');
            const worldbookMountSave = document.getElementById('worldbookMountSave');

            // 初始化世界书列表
            function initWorldbookMountList() {
                const worldBookSystem = window.worldBookSystem;
                if (!worldBookSystem) return;

                const books = worldBookSystem.books || [];
                worldbookMountList.innerHTML = '';

                if (books.length === 0) {
                    worldbookMountList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">还没有世界书</div>';
                    return;
                }

                // 获取当前好友已挂载的世界书列表
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                let mountedBooks = [];
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);
                    if (friend && friend.mountedWorldBooks) {
                        mountedBooks = Array.isArray(friend.mountedWorldBooks) ?
                            friend.mountedWorldBooks.map(id => String(id)) : [];
                    }
                }

                books.forEach(book => {
                    const label = document.createElement('label');
                    label.className = 'worldbook-mount-item';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = book.id;
                    checkbox.dataset.bookId = book.id;
                    // 恢复之前的勾选状态
                    checkbox.checked = mountedBooks.includes(String(book.id));

                    const text = document.createElement('span');
                    text.className = 'worldbook-mount-item-text';
                    text.textContent = book.title;

                    label.appendChild(checkbox);
                    label.appendChild(text);

                    // 点击卡片任意位置都能切换勾选框
                    label.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                    });

                    worldbookMountList.appendChild(label);
                });
            }

            // 打开世界书挂载弹窗
            if (worldbookMountBtn) {
                worldbookMountBtn.addEventListener('click', () => {
                    initWorldbookMountList();
                    ModalManager.show('worldbookMount');
                });
            }

            // 关闭弹窗（取消）
            if (worldbookMountCancel) {
                worldbookMountCancel.addEventListener('click', () => {
                    ModalManager.hide('worldbookMount');
                });
            }

            // 保存选中的世界书
            if (worldbookMountSave) {
                worldbookMountSave.addEventListener('click', () => {
                    const checkboxes = worldbookMountList.querySelectorAll('input[type="checkbox"]');
                    const selectedBooks = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    // 保存到当前好友
                    const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                    if (currentFriendId && friendSystem) {
                        friendSystem.updateFriend(currentFriendId, {
                            mountedWorldBooks: selectedBooks
                        });
                        showCuteToast('保存成功');
                    }

                    ModalManager.hide('worldbookMount');
                });
            }

            // 点击弹窗背景关闭
            if (worldbookMountModal) {
                worldbookMountModal.addEventListener('click', (e) => {
                    if (e.target === worldbookMountModal) {
                        ModalManager.hide('worldbookMount');
                    }
                });
            }

            // ========== HTML游戏挂载模块 ==========
            const htmlGameMountBtn = document.getElementById('htmlGameMountBtn');
            const htmlGameMountModal = document.getElementById('htmlGameMountModal');
            const htmlGameMountList = document.getElementById('htmlGameMountList');
            const htmlGameMountCancel = document.getElementById('htmlGameMountCancel');
            const htmlGameMountSave = document.getElementById('htmlGameMountSave');

            // 初始化HTML游戏列表
            function initHtmlGameMountList() {
                const htmlGameSystem = window.htmlGameSystem;
                if (!htmlGameSystem) return;

                const games = htmlGameSystem.games || [];
                htmlGameMountList.innerHTML = '';

                if (games.length === 0) {
                    htmlGameMountList.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">还没有HTML游戏</div>';
                    return;
                }

                // 获取当前好友已挂载的HTML游戏列表
                const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                let mountedGames = [];
                if (currentFriendId && friendSystem) {
                    const friend = friendSystem.getFriendById(currentFriendId);
                    if (friend && friend.mountedHtmlGames) {
                        mountedGames = Array.isArray(friend.mountedHtmlGames) ?
                            friend.mountedHtmlGames.map(id => String(id)) : [];
                    }
                }

                games.forEach(game => {
                    const label = document.createElement('label');
                    label.className = 'worldbook-mount-item';
                    label.style.cursor = 'pointer';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = game.id;
                    checkbox.dataset.gameId = game.id;
                    // 恢复之前的勾选状态
                    checkbox.checked = mountedGames.includes(String(game.id));

                    const text = document.createElement('span');
                    text.className = 'worldbook-mount-item-text';
                    text.textContent = game.title;

                    label.appendChild(checkbox);
                    label.appendChild(text);

                    // 点击卡片任意位置都能切换勾选框
                    label.addEventListener('click', (e) => {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                    });

                    htmlGameMountList.appendChild(label);
                });
            }

            // 打开HTML游戏挂载弹窗
            if (htmlGameMountBtn) {
                htmlGameMountBtn.addEventListener('click', () => {
                    initHtmlGameMountList();
                    ModalManager.show('htmlGameMount');
                });
            }

            // 关闭弹窗（取消）
            if (htmlGameMountCancel) {
                htmlGameMountCancel.addEventListener('click', () => {
                    ModalManager.hide('htmlGameMount');
                });
            }

            // 保存选中的HTML游戏
            if (htmlGameMountSave) {
                htmlGameMountSave.addEventListener('click', () => {
                    const checkboxes = htmlGameMountList.querySelectorAll('input[type="checkbox"]');
                    const selectedGames = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    // 保存到当前好友
                    const currentFriendId = chatSession ? chatSession.getCurrentFriendId() : null;
                    if (currentFriendId && friendSystem) {
                        friendSystem.updateFriend(currentFriendId, {
                            mountedHtmlGames: selectedGames
                        });
                        showCuteToast('保存成功');
                    }

                    ModalManager.hide('htmlGameMount');
                });
            }

            // 点击弹窗背景关闭
            if (htmlGameMountModal) {
                htmlGameMountModal.addEventListener('click', (e) => {
                    if (e.target === htmlGameMountModal) {
                        ModalManager.hide('htmlGameMount');
                    }
                });
            }

            const CHAT_PREFIX = 'chat_';

            // ========== 模块化导入导出系统 ==========
            // 核心特点：
            // 1. 所有模块均通过注册方式加入，无硬编码
            // 2. 新增功能只需注册一行代码，导出导入自动生效
            // 3. 预留extensionsData存放未来功能（如美化、主题、背景等）
            // 4. 版本控制明确，支持版本迁移

            class DataExchangeManager {
                constructor(appVersion = '1.0.0') {
                    this.appVersion = appVersion;
                    this.modules = {};      // { moduleName: { exportFn, importFn, version } }
                    this.reservedKeys = new Set([CHAT_PREFIX]); // localStorage保留前缀
                }

                // 注册一个数据模块（每个功能系统都应该注册）
                registerModule(moduleName, {
                    exportFn,     // 返回该模块的数据
                    importFn,     // 接收该模块的数据并应用
                    version = '1.0'
                }) {
                    this.modules[moduleName] = {
                        exportFn,
                        importFn,
                        version
                    };
                }

                // 导出所有已注册模块的数据 + 完整 localStorage 备份
                exportAll() {
                    const manifest = {
                        appVersion: this.appVersion,
                        exportTime: new Date().toISOString(),
                        exportDevice: 'browser',
                        modules: {}
                    };
                    const data = {};

                    // 导出各模块
                    Object.entries(this.modules).forEach(([name, module]) => {
                        try {
                            manifest.modules[name] = module.version;
                            data[name] = module.exportFn();
                        } catch (e) {
                            console.error(`[导出] 模块${name}导出失败:`, e);
                        }
                    });

                    // 关键：导出完整的 localStorage 备份（防止遗漏）
                    const localStorageBackup = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key) {
                            try {
                                localStorageBackup[key] = localStorage.getItem(key);
                            } catch (e) {
                                console.warn(`[导出] localStorage 键${key}读取失败:`, e);
                            }
                        }
                    }

                    return {
                        manifest,
                        data,
                        extensions: {},
                        localStorageBackup  // ✅ 完整的 localStorage 备份
                    };
                }

                // 导入所有模块的数据 + 完整恢复 localStorage
                importAll(payload, options = {}) {
                    if (!payload || !payload.manifest || !payload.data) {
                        throw new Error('文件格式不正确');
                    }

                    const clearBeforeImport = options && options.clearBeforeImport === true;
                    if (clearBeforeImport) {
                        try {
                            localStorage.clear();
                        } catch (e) {
                            console.error('[导入] 清空 localStorage 失败:', e);
                        }
                    }

                    // 第一步：逐模块导入（便于模块执行升级/迁移逻辑）
                    Object.entries(payload.data).forEach(([moduleName, moduleData]) => {
                        if (this.modules[moduleName]) {
                            try {
                                this.modules[moduleName].importFn(moduleData);
                            } catch (e) {
                                console.error(`[导入] 模块${moduleName}导入失败:`, e);
                            }
                        }
                    });

                    // 第二步：如果有 localStorage 完整备份，恢复它（确保最大兼容）
                    if (payload.localStorageBackup && typeof payload.localStorageBackup === 'object') {
                        Object.entries(payload.localStorageBackup).forEach(([key, value]) => {
                            try {
                                localStorage.setItem(key, String(value));
                            } catch (e) {
                                console.error(`[导入] localStorage 键${key}导入失败:`, e);
                            }
                        });
                    }

                    // 第三步：导入扩展数据（未来的美化、主题等）
                    if (payload.extensions && typeof payload.extensions === 'object') {
                        Object.entries(payload.extensions).forEach(([key, value]) => {
                            try {
                                StorageManager.set(`ext_${key}`, value);
                            } catch (e) {
                                console.error(`[导入] 扩展${key}导入失败:`, e);
                            }
                        });
                    }
                }

                // 导出特定模块子集（用于部分导出）
                exportModules(moduleNames = []) {
                    const manifest = {
                        appVersion: this.appVersion,
                        exportTime: new Date().toISOString(),
                        exportDevice: 'browser',
                        modules: {}
                    };
                    const data = {};

                    moduleNames.forEach(name => {
                        if (this.modules[name]) {
                            try {
                                manifest.modules[name] = this.modules[name].version;
                                data[name] = this.modules[name].exportFn();
                            } catch (e) {
                                console.error(`[导出] 模块${name}导出失败:`, e);
                            }
                        }
                    });

                    // 部分导出也包含完整 localStorage 备份
                    const localStorageBackup = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key) {
                            try {
                                localStorageBackup[key] = localStorage.getItem(key);
                            } catch (e) {
                                console.warn(`[导出] localStorage 键${key}读取失败:`, e);
                            }
                        }
                    }

                    return {
                        manifest,
                        data,
                        extensions: {},
                        localStorageBackup
                    };
                }
            }

            const dataExchange = new DataExchangeManager('1.0.0');

            function getFormattedDate() {
                const now = new Date();
                const year = String(now.getFullYear()).slice(-2);
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const date = String(now.getDate()).padStart(2, '0');
                return `${year}${month}${date}`;
            }

            function downloadJson(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                link.remove();
                URL.revokeObjectURL(url);
            }

            function exportAllData() {
                try {
                    // 防止在角色回复尚未落盘时导出，导致“少一轮”
                    if (chatSession && chatSession.isProcessing) {
                        showCuteToast('角色还在回复中，请稍候再导出', 'warning');
                        return;
                    }

                    // 强制同步内存数据到localStorage
                    if (window.worldBookSystem && Array.isArray(window.worldBookSystem.books)) {
                        StorageManager.set('worldBooks', window.worldBookSystem.books);
                    }
                    if (window.htmlGameSystem && Array.isArray(window.htmlGameSystem.games)) {
                        StorageManager.set('htmlGames', window.htmlGameSystem.games);
                    }

                    const friendsForExport = friendSystem ? friendSystem.getFriends() : StorageManager.get('friends', []);
                    const chatHistoriesForExport = {};
                    (Array.isArray(friendsForExport) ? friendsForExport : []).forEach(friend => {
                        if (!friend || !friend.id) return;
                        const fid = String(friend.id);
                        chatHistoriesForExport[fid] = friendSystem
                            ? (friendSystem.getFriendChatHistory(fid) || [])
                            : (StorageManager.get(CHAT_PREFIX + fid, []) || []);
                    });
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(CHAT_PREFIX)) {
                            const fid = key.replace(CHAT_PREFIX, '');
                            if (!Object.prototype.hasOwnProperty.call(chatHistoriesForExport, fid)) {
                                chatHistoriesForExport[fid] = StorageManager.get(key, []);
                            }
                        }
                    }

                    // 统一走模块化导出 + localStorage 全备份，确保未来功能自动纳入
                    const payload = dataExchange.exportAll();
                    payload.dataType = 'yuanyuanji_full_export_v3';

                    // 兜底注入关键模块数据：即使模块注册异常，也确保世界书/聊天在导出包中
                    if (!payload.manifest) payload.manifest = { modules: {} };
                    if (!payload.manifest.modules) payload.manifest.modules = {};
                    if (!payload.data || typeof payload.data !== 'object') payload.data = {};

                    const worldBooksForExport = StorageManager.get('worldBooks', []);
                    payload.data.worldBooks = { worldBooks: worldBooksForExport };
                    payload.data.chatSystem = { chatHistories: chatHistoriesForExport };
                    payload.manifest.modules.worldBooks = payload.manifest.modules.worldBooks || '1.0';
                    payload.manifest.modules.chatSystem = payload.manifest.modules.chatSystem || '1.0';

                    // 同步到 raw localStorage 备份
                    if (!payload.localStorageBackup || typeof payload.localStorageBackup !== 'object') {
                        payload.localStorageBackup = {};
                    }
                    payload.localStorageBackup.worldBooks = JSON.stringify(worldBooksForExport);

                    Object.entries(chatHistoriesForExport).forEach(([fid, history]) => {
                        payload.localStorageBackup[CHAT_PREFIX + fid] = JSON.stringify(history || []);
                    });

                    downloadJson(payload, `芋圆机_v3_${getFormattedDate()}.json`);
                    showCuteToast('✓ 导出成功');
                } catch (e) {
                    console.error('导出失败:', e);
                    showCuteToast('导出失败: ' + e.message);
                }
            }

            function exportFriendsData() {
                try {
                    const exportData = {
                        friends: StorageManager.get('friends', []),
                        homeGreeting: StorageManager.get('homeGreeting', '')
                    };

                    const payload = {
                        dataType: 'yuanyuanji_friends_export',
                        appVersion: '1.0.0',
                        exportTime: new Date().toISOString(),
                        data: exportData
                    };

                    downloadJson(payload, `芋圆机_好友_${getFormattedDate()}.json`);
                    showCuteToast('✓ 导出好友数据成功！');
                } catch (e) {
                    console.error('导出失败:', e);
                    showCuteToast('导出失败: ' + e.message);
                }
            }

            function exportChatsData() {
                try {
                    const chatHistories = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith(CHAT_PREFIX)) {
                            const friendId = key.replace(CHAT_PREFIX, '');
                            chatHistories[friendId] = StorageManager.get(key, []);
                        }
                    }

                    const payload = {
                        dataType: 'yuanyuanji_chats_export',
                        appVersion: '1.0.0',
                        exportTime: new Date().toISOString(),
                        data: { chatHistories }
                    };

                    downloadJson(payload, `芋圆机_聊天_${getFormattedDate()}.json`);
                    showCuteToast('✓ 导出聊天数据成功！');
                } catch (e) {
                    console.error('导出失败:', e);
                    showCuteToast('导出失败: ' + e.message);
                }
            }

            function handleImportFile(file) {
                const reader = new FileReader();
                reader.onload = () => {
                    try {
                        const payload = JSON.parse(String(reader.result || '{}'));

                        if (!payload.data || typeof payload.data !== 'object') {
                            alert('导入失败：文件格式不正确');
                            return;
                        }

                        const confirmImport = confirm('⚠️ 导入将覆盖当前所有数据，是否继续？');
                        if (!confirmImport) return;

                        console.log('[导入] 开始处理 ' + (payload.dataType || 'unknown') + ' 类型的导出文件...');

                        // 新版：模块化全量导入（100%复刻 + 未来扩展）
                        if (payload.dataType === 'yuanyuanji_full_export_v3' || payload.dataType === 'yuanyuanji_full_export_v2' || (payload.manifest && payload.data)) {
                            dataExchange.importAll(payload, { clearBeforeImport: true });
                            reinitializeAllSystems();
                            showCuteToast('导入成功！页面即将刷新...');
                            setTimeout(() => window.location.reload(), 1200);
                        } else if (payload.dataType === 'yuanyuanji_full_export') {
                            // 兼容旧版全量导出格式
                            handleFullImport(payload.data);
                            // ✓ 全量导入后刷新页面，确保所有系统重新初始化
                            showCuteToast('导入成功！页面即将刷新...');
                            setTimeout(() => window.location.reload(), 1500);
                        } else if (payload.dataType === 'yuanyuanji_friends_export') {
                            handleFriendsImport(payload.data);
                            showCuteToast('✓ 好友数据导入完成！');
                        } else if (payload.dataType === 'yuanyuanji_chats_export') {
                            handleChatsImport(payload.data);
                            showCuteToast('✓ 聊天数据导入完成！');
                        } else {
                            // 兼容旧格式
                            console.warn('未识别的导出格式，尝试作为全量导入处理');
                            handleFullImport(payload.backup || payload.data);
                            showCuteToast('导入成功！页面即将刷新...');
                            setTimeout(() => window.location.reload(), 1500);
                        }

                        console.log('[导入] 成功完成');
                    } catch (e) {
                        alert('导入失败：' + e.message);
                        console.error('导入错误:', e);
                    }
                };
                reader.readAsText(file);
            }

            function handleFullImport(importedData) {
                console.log('[全量导入] 清空所有旧数据...');
                localStorage.clear();

                console.log('[全量导入] 写入核心数据...');

                // ✓ 1. 导入好友（包含 ID 绑定）
                if (importedData.friends && Array.isArray(importedData.friends)) {
                    StorageManager.set('friends', importedData.friends);
                    console.log('✓ 导入 ' + importedData.friends.length + ' 个好友');
                }

                // ✓ 2. 导入 API 配置（只保留链接和密钥）
                if (importedData.apiConfig) {
                    const cleanApiConfig = {
                        apiUrl: importedData.apiConfig.apiUrl || '',
                        apiKey: importedData.apiConfig.apiKey || ''
                    };
                    StorageManager.set('apiConfig', cleanApiConfig);
                    console.log('✓ 导入 API 配置 (链接 + 密钥)');
                }

                // ✓ 3. 导入世界书（完整数据）
                if (importedData.worldBooks && Array.isArray(importedData.worldBooks)) {
                    StorageManager.set('worldBooks', importedData.worldBooks);
                    console.log('✓ 导入 ' + importedData.worldBooks.length + ' 本世界书');
                }

                // ✓ 4. 导入 HTML 游戏
                if (importedData.htmlGames && Array.isArray(importedData.htmlGames)) {
                    StorageManager.set('htmlGames', importedData.htmlGames);
                    console.log('✓ 导入 ' + importedData.htmlGames.length + ' 个游戏');
                }

                // 5. 导入贺词
                if (importedData.homeGreeting) {
                    StorageManager.set('homeGreeting', importedData.homeGreeting);
                }

                // ✓ 6. 导入聊天记录（通过 ID 绑定匹配）
                if (importedData.chatHistories && typeof importedData.chatHistories === 'object') {
                    const friends = importedData.friends || [];
                    const friendIds = new Set(friends.map(f => String(f.id)));
                    let chatImportCount = 0;

                    Object.entries(importedData.chatHistories).forEach(([friendIdStr, messages]) => {
                        if (friendIds.has(String(friendIdStr))) {
                            StorageManager.set(CHAT_PREFIX + friendIdStr, messages);
                            chatImportCount++;
                        } else {
                            console.warn('[ID 未匹配] 聊天记录的 friendId ' + friendIdStr + ' 不存在于好友列表中');
                        }
                    });
                    console.log('✓ 导入 ' + chatImportCount + ' 个聊天记录');
                }

                // 7. 导入心声
                if (importedData.heartVoices && typeof importedData.heartVoices === 'object') {
                    Object.entries(importedData.heartVoices).forEach(([friendId, data]) => {
                        StorageManager.set(`heartvoice_${friendId}`, data);
                    });
                }

                console.log('[全量导入] 重新初始化系统...');
                reinitializeAllSystems();
            }

            function handleFriendsImport(importedData) {
                console.log('[好友导入] 合并好友数据...');
                const existingFriends = StorageManager.get('friends', []);

                if (importedData.friends && Array.isArray(importedData.friends)) {
                    importedData.friends.forEach(newFriend => {
                        const existing = existingFriends.findIndex(f => String(f.id) === String(newFriend.id));
                        if (existing > -1) {
                            existingFriends[existing] = newFriend;
                        } else {
                            existingFriends.push(newFriend);
                        }
                    });
                    StorageManager.set('friends', existingFriends);
                }

                if (importedData.homeGreeting) {
                    StorageManager.set('homeGreeting', importedData.homeGreeting);
                }

                console.log('[好友导入] 重新初始化好友系统...');
                if (friendSystem) friendSystem.init();
                if (window.renderFriendList) renderFriendList();
            }

            function handleChatsImport(importedData) {
                console.log('[聊天导入] 合并聊天记录...');

                if (importedData.chatHistories && typeof importedData.chatHistories === 'object') {
                    Object.entries(importedData.chatHistories).forEach(([friendId, newMessages]) => {
                        if (Array.isArray(newMessages)) {
                            const existingKey = CHAT_PREFIX + friendId;
                            const existingMessages = StorageManager.get(existingKey, []);
                            StorageManager.set(existingKey, newMessages);
                        }
                    });
                }

                console.log('[聊天导入] 刷新当前聊天页面...');
                if (window.goHome) goHome();  // 返回首页刷新
            }

            function reinitializeAllSystems() {
                try {
                    const friends = StorageManager.get('friends', []);
                    const worldBooks = StorageManager.get('worldBooks', []);
                    const htmlGames = StorageManager.get('htmlGames', []);

                    if (window.worldBookSystem) {
                        window.worldBookSystem.books = worldBooks && Array.isArray(worldBooks) ? worldBooks : [];
                    }

                    if (friendSystem) { friendSystem.init(); }
                    if (apiService) { apiService.updateSettingsDisplay?.(); }
                    if (heartVoiceSystem) { heartVoiceSystem.init?.(); }
                    if (window.htmlGameSystem) {
                        window.htmlGameSystem.games = htmlGames && Array.isArray(htmlGames) ? htmlGames : [];
                    }
                    if (window.renderFriendList) renderFriendList();

                } catch (e) {
                    console.error('系统初始化出错:', e);
                    alert('部分系统初始化失败，请手动刷新页面');
                }
            }

            if (exportAllDataBtn) {
                exportAllDataBtn.addEventListener('click', exportAllData);
            }
            if (exportFriendsDataBtn) {
                exportFriendsDataBtn.addEventListener('click', exportFriendsData);
            }
            if (exportChatsDataBtn) {
                exportChatsDataBtn.addEventListener('click', exportChatsData);
            }
            if (importAllDataBtn && importFileInput) {
                importAllDataBtn.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (file) {
                        handleImportFile(file);
                    }
                    importFileInput.value = '';
                });
            }

            // 点击模态窗口外部关闭
            window.addEventListener('click', (e) => {
                if (e.target === apiModal) {
                    ModalManager.switch('api', 'settings');
                }
                if (e.target === chatModal) {
                    ModalManager.hide('chat');
                }
                if (e.target === settingsModal) {
                    ModalManager.hide('settings');
                }
                if (e.target === friendListModal) {
                    ModalManager.hide('friendList');
                }
                if (e.target === addFriendModal) {
                    ModalManager.hide('addFriend');
                    resetAddFriendForm();
                }
                if (e.target === dataManageModal) {
                    ModalManager.hide('dataManage');
                }
            });

            // ========== 好友管理功能 ==========
            class FriendSystem {
                constructor() {
                    this.cache = new Map();
                    this.lastSnapshot = '';
                    this.syncTimer = null;
                    this.CHECK_INTERVAL = 5000;
                    this.listeners = new Set();
                }

                parsePersonaText(text) {
                    const raw = (text || '').trim();
                    if (!raw) {
                        return {
                            raw: '',
                            summary: '',
                            keywords: [],
                            likes: [],
                            dislikes: []
                        };
                    }

                    const sentences = raw.split(/[。！？\n]+/).map(s => s.trim()).filter(Boolean);
                    const summary = sentences[0] || raw;

                    const keywords = Array.from(new Set((raw.match(/[\u4e00-\u9fa5]{2,}/g) || []).slice(0, 20)));
                    const likes = [];
                    const dislikes = [];

                    const likeMatches = raw.match(/喜欢([^，。！？\n]+)/g) || [];
                    likeMatches.forEach(m => {
                        const item = m.replace('喜欢', '').trim();
                        if (item) likes.push(item);
                    });
                    const dislikeMatches = raw.match(/(讨厌|不喜欢)([^，。！？\n]+)/g) || [];
                    dislikeMatches.forEach(m => {
                        const item = m.replace('讨厌', '').replace('不喜欢', '').trim();
                        if (item) dislikes.push(item);
                    });

                    return {
                        raw,
                        summary,
                        keywords,
                        likes,
                        dislikes
                    };
                }

                getStorage(key, defaultValue = null) {
                    return StorageManager.get(key, defaultValue);
                }

                setStorage(key, value) {
                    StorageManager.set(key, value);
                }

                rebuildCacheFromFriends(friends) {
                    this.cache.clear();
                    friends.forEach(friend => {
                        const personaText = friend.persona || '';
                        this.cache.set(friend.id, {
                            id: friend.id,
                            name: friend.name || '',
                            raw: personaText,
                            parsed: this.parsePersonaText(personaText),
                            updatedAt: Date.now()
                        });
                    });
                    this.lastSnapshot = JSON.stringify(friends);
                    this.emitChange({ type: 'friends', friends });
                }

                ensureSync() {
                    const saved = StorageManager.get('friends');
                    const savedStr = saved ? JSON.stringify(saved) : '';
                    if (!savedStr && this.lastSnapshot) {
                        this.cache.clear();
                        this.lastSnapshot = '';
                        return;
                    }
                    if (savedStr && savedStr !== this.lastSnapshot) {
                        try {
                            this.rebuildCacheFromFriends(Array.isArray(saved) ? saved : []);
                        } catch (e) {
                            console.error('同步人设缓存失败:', e);
                        }
                    }
                }

                init() {
                    this.ensureSync();
                    if (this.syncTimer) {
                        clearInterval(this.syncTimer);
                    }
                    this.syncTimer = setInterval(() => this.ensureSync(), this.CHECK_INTERVAL);
                }

                getPersona(id) {
                    if (!id) return null;
                    this.ensureSync();
                    return this.cache.get(id) || null;
                }

                syncFromFriends(friends) {
                    this.rebuildCacheFromFriends(Array.isArray(friends) ? friends : []);
                }

                onChange(handler) {
                    if (typeof handler === 'function') {
                        this.listeners.add(handler);
                    }
                    return () => this.listeners.delete(handler);
                }

                emitChange(payload) {
                    this.listeners.forEach(handler => {
                        try {
                            handler(payload);
                        } catch (e) {
                            console.error('人设变化回调异常:', e);
                        }
                    });
                }

                getFriends() {
                    const friends = this.getStorage('friends', []);
                    return Array.isArray(friends) ? friends : [];
                }

                saveFriends(friends) {
                    this.setStorage('friends', friends);
                    this.syncFromFriends(friends);
                }

                getFriendById(friendId) {
                    const friends = this.getFriends();
                    return friends.find(friend => friend.id === friendId) || null;
                }

                addFriend(friend) {
                    const friends = this.getFriends();
                    friends.push(friend);
                    this.saveFriends(friends);
                    return friend;
                }

                updateFriend(friendId, updates = {}) {
                    const friends = this.getFriends();
                    const index = friends.findIndex(friend => friend.id === friendId);
                    if (index === -1) return null;
                    friends[index] = { ...friends[index], ...updates };
                    this.saveFriends(friends);
                    return friends[index];
                }

                deleteFriend(friendId) {
                    const friends = this.getFriends();
                    const index = friends.findIndex(friend => friend.id === friendId);
                    if (index === -1) return null;
                    const [removed] = friends.splice(index, 1);
                    this.saveFriends(friends);
                    return removed;
                }

                getFriendChatHistory(friendId) {
                    const history = this.getStorage(CHAT_PREFIX + friendId, []);
                    return Array.isArray(history) ? history : [];
                }

                saveFriendChatHistory(friendId, messages) {
                    this.setStorage(CHAT_PREFIX + friendId, messages);
                }

                // 清理定时器，防止内存泄漏
                destroy() {
                    if (this.syncTimer) {
                        clearInterval(this.syncTimer);
                        this.syncTimer = null;
                    }
                    this.cache.clear();
                    this.listeners.clear();
                }
            }

            // 渲染好友列表
            function renderFriendList() {
                const friends = friendSystem ? friendSystem.getFriends() : [];
                friendListElement.innerHTML = '';

                if (friends.length === 0) {
                    noFriends.style.display = 'flex';
                    return;
                }

                noFriends.style.display = 'none';

                friends.forEach(friend => {
                    const friendItem = document.createElement('div');
                    friendItem.className = 'friend-item';

                    // 创建头像元素
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = 'friend-avatar';
                    if (friend.avatar) {
                        const img = document.createElement('img');
                        img.src = friend.avatar;
                        img.alt = friend.name;

                        // 图片加载失败时显示默认图标
                        img.onerror = () => {
                            avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
                        };

                        // Safari兼容性：确保图片加载后立即显示
                        img.onload = () => {
                            void avatarDiv.offsetWidth;
                        };

                        avatarDiv.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-user';
                        avatarDiv.appendChild(icon);
                    }

                    // 创建信息元素
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'friend-info';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'friend-name';
                    nameDiv.textContent = friend.name;

                    // 获取最后一条消息（不管是谁发的）
                    let lastMessageText = '暂无消息';
                    if (friendSystem && typeof friendSystem.getFriendChatHistory === 'function') {
                        try {
                            const history = friendSystem.getFriendChatHistory(friend.id) || [];
                            if (Array.isArray(history) && history.length > 0) {
                                // 倒序查找，获取最后一条未删除、未撤回的消息
                                for (let i = history.length - 1; i >= 0; i--) {
                                    const msg = history[i];
                                    if (!msg.isDeletedLocal && !msg.isRecalled) {
                                        // 处理不同类型的消息
                                        if (msg.isVoice) {
                                            lastMessageText = '[语音]';
                                        } else if (msg.imageData) {
                                            lastMessageText = '[图片]';
                                        } else if (msg.content) {
                                            // 截断长消息，显示前40个字符
                                            const preview = msg.content.trim();
                                            lastMessageText = preview.length > 40
                                                ? preview.substring(0, 40) + '...'
                                                : preview;
                                        }
                                        break;
                                    }
                                }
                            }
                        } catch (e) {
                            lastMessageText = '暂无消息';
                        }
                    }

                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'friend-persona';
                    messageDiv.textContent = lastMessageText;

                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(messageDiv);

                    friendItem.appendChild(avatarDiv);
                    friendItem.appendChild(infoDiv);

                    friendItem.addEventListener('click', () => {
                        ModalManager.hide('friendList');
                        if (chatSession) chatSession.openChatWithFriend(friend);
                    });

                    friendListElement.appendChild(friendItem);
                });
            }

            // 将 renderFriendList 暴露到全局作用域，以便在聊天时实时更新
            window.updateFriendList = renderFriendList;

            // 打开与好友的聊天由 ChatSession 统一处理

            // 重置添加好友表单
            function resetAddFriendForm() {
                friendName.value = '';
                friendPersona.value = '';
                pendingAddFriendAvatar = '';
                avatarPreview.style.backgroundImage = '';
                avatarPreview.classList.remove('has-image');
                addFriendStatus.style.display = 'none';
                avatarInput.value = '';
            }

            // 显示添加好友状态
            function showAddFriendStatus(message, type) {
                addFriendStatus.textContent = message;
                addFriendStatus.className = `status-message ${type}`;
                addFriendStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        resetAddFriendForm();
                        ModalManager.hide('addFriend');
                        renderFriendList();
                    }, 1500);
                }
            }

            // 头像上传处理
            let pendingAddFriendAvatar = '';

            avatarPreview.addEventListener('click', () => {
                avatarInput.click();
            });

            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageUrl = event.target.result;
                        pendingAddFriendAvatar = imageUrl;
                        avatarPreview.style.backgroundImage = `url('${imageUrl}')`;
                        avatarPreview.classList.add('has-image');

                        // Safari兼容性：强制重绘确保图片显示
                        void avatarPreview.offsetWidth;
                        avatarPreview.style.opacity = '0.99';
                        setTimeout(() => {
                            avatarPreview.style.opacity = '1';
                        }, 10);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 添加好友
            confirmAddFriend.addEventListener('click', () => {
                const name = friendName.value.trim();
                const persona = friendPersona.value.trim();
                const avatar = pendingAddFriendAvatar || '';

                if (!name) {
                    showAddFriendStatus('请输入昵称', 'error');
                    return;
                }

                if (!persona) {
                    showAddFriendStatus('请输入人设', 'error');
                    return;
                }

                if (persona.length > 5000) {
                    showAddFriendStatus('人设最多5000字', 'error');
                    return;
                }

                // 生成唯一ID：时间戳后4位 + 4位随机数（共8字符），检查重复
                let friendId = '';
                let isUnique = false;
                while (!isUnique) {
                    friendId = Date.now().toString().slice(-4) + Math.random().toString(36).substring(2, 6);
                    const existingFriends = friendSystem ? friendSystem.getFriends() : [];
                    isUnique = !existingFriends.some(f => f.id === friendId);
                }

                const newFriend = {
                    id: friendId,
                    name: name,
                    persona: persona,
                    avatar: avatar || null,
                    voiceId: '',                           // ✅ 语音ID初始化
                    voiceIdMode: 'auto',                   // ✅ 语音模式默认自动
                    chatShowTime: FeatureConfig.friend.defaultShowTime,
                    chatReadStatus: FeatureConfig.friend.defaultReadStatus,
                    chatHideAvatar: FeatureConfig.friend.defaultHideAvatar,
                    mountedWorldBooks: [],                 // ✅ 挂载的世界书（数组）
                    mountedHtmlGames: [],                  // ✅ 挂载的HTML游戏（数组）
                    createdAt: new Date().toISOString()
                };

                if (friendSystem) friendSystem.addFriend(newFriend);

                showAddFriendStatus('好友添加成功！', 'success');
            });

            cancelAddFriend.addEventListener('click', () => {
                ModalManager.hide('addFriend');
                resetAddFriendForm();
            });

            // ========== API配置功能 ==========
            class ApiService {
                constructor(friendSystemInstance) {
                    this.friendSystem = friendSystemInstance;
                }

                getConfig() {
                    const defaultConfig = {
                        apiUrl: '',
                        apiKey: '',
                        model: '',
                        models: [],
                        memoryChatCount: 50
                    };
                    const config = this.friendSystem
                        ? this.friendSystem.getStorage('apiConfig', defaultConfig)
                        : defaultConfig;
                    return config && typeof config === 'object' ? { ...defaultConfig, ...config } : defaultConfig;
                }

                saveConfig(config) {
                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiConfig', config);
                    } else {
                        StorageManager.set('apiConfig', config);
                    }
                    this.updateSettingsDisplay();
                }

                updateSettingsDisplay() {
                    const config = this.getConfig();

                    if (config.apiUrl && config.apiKey) {
                        configStatus.textContent = '已配置';
                        configStatus.classList.add('ok');
                    } else {
                        configStatus.textContent = '未配置';
                        configStatus.classList.remove('ok');
                    }
                }

                showApiStatus(message, type) {
                    apiStatus.textContent = message;
                    apiStatus.className = `status-message ${type}`;
                    apiStatus.style.display = 'block';

                    if (type === 'success') {
                        setTimeout(() => {
                            apiStatus.style.display = 'none';
                        }, 3000);
                    }
                }

                updateModelSelect(models) {
                    modelSelect.innerHTML = '';

                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = '请选择模型';
                    modelSelect.appendChild(defaultOption);

                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.name;
                        modelSelect.appendChild(option);
                    });

                    modelSelect.disabled = false;

                    if (modelPickerButton) {
                        modelPickerButton.disabled = false;
                    }

                    const config = this.getConfig();
                    if (config.model) {
                        modelSelect.value = config.model;
                    }

                    this.updateModelPicker(models);
                }

                updateModelPicker(models) {
                    if (!modelPickerList || !modelPickerText) return;
                    modelPickerList.innerHTML = '';

                    const config = this.getConfig();
                    const currentId = config.model || modelSelect.value || '';

                    let currentName = '请选择模型';
                    models.forEach(model => {
                        if (model.id === currentId) {
                            currentName = model.name;
                        }
                    });
                    modelPickerText.textContent = currentName;

                    models.forEach(model => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'model-picker-item';
                        if (model.id === currentId) {
                            item.classList.add('is-selected');
                        }
                        item.textContent = model.name;
                        item.dataset.modelId = model.id;

                        item.addEventListener('click', () => {
                            modelSelect.value = model.id;
                            modelPickerText.textContent = model.name;
                            modelPickerList.classList.remove('is-open');

                            modelPickerList.querySelectorAll('.model-picker-item').forEach(el => {
                                el.classList.remove('is-selected');
                            });
                            item.classList.add('is-selected');
                        });

                        modelPickerList.appendChild(item);
                    });
                }

                async fetchModels() {
                    let apiUrl = apiUrlInput.value.trim();
                    const apiKey = apiKeyInput.value.trim();

                    if (!apiUrl) {
                        this.showApiStatus('请输入API地址', 'error');
                        return;
                    }

                    if (!apiKey) {
                        this.showApiStatus('请输入API密钥', 'error');
                        return;
                    }

                    if (apiUrl.endsWith('/')) {
                        apiUrl = apiUrl.slice(0, -1);
                    }

                    fetchBtnText.textContent = '拉取中...';
                    fetchLoading.style.display = 'inline-block';
                    fetchModelsBtn.disabled = true;

                    try {
                        const endpoints = [
                            '/models',
                            '/v1/models',
                            '/api/v1/models',
                            '/v1beta/models'
                        ];

                        let response = null;

                        for (const endpoint of endpoints) {
                            try {
                                let url = apiUrl;
                                if (url.endsWith('/v1') && endpoint.startsWith('/v1')) {
                                    url = url.replace(/\/v1$/, '');
                                }

                                const fullUrl = url + endpoint;
                                console.log('尝试端点:', fullUrl);

                                const controller = new AbortController();
                                const timeoutId = setTimeout(() => controller.abort(), 10000);

                                response = await fetch(fullUrl, {
                                    headers: {
                                        'Authorization': `Bearer ${apiKey}`,
                                        'Content-Type': 'application/json'
                                    },
                                    signal: controller.signal
                                });

                                clearTimeout(timeoutId);

                                if (response.ok) {
                                    break;
                                }
                            } catch (err) {
                                console.log(`端点 ${endpoint} 失败:`, err.message);
                                continue;
                            }
                        }

                        if (!response || !response.ok) {
                            throw new Error('无法连接到API服务，请检查地址和密钥');
                        }

                        const data = await response.json();
                        console.log('API响应:', data);

                        let models = [];

                        if (data.data && Array.isArray(data.data)) {
                            models = data.data.map(model => ({
                                id: model.id,
                                name: model.id.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else if (Array.isArray(data)) {
                            models = data.map(model => ({
                                id: model.id || model,
                                name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else if (data.models && Array.isArray(data.models)) {
                            models = data.models.map(model => ({
                                id: model.id || model,
                                name: (model.id || model).replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                            }));
                        } else {
                            throw new Error('无法解析模型列表');
                        }

                        if (models.length === 0) {
                            throw new Error('未找到可用模型');
                        }

                        models.sort((a, b) => a.name.localeCompare(b.name));

                        const config = this.getConfig();
                        config.models = models;
                        this.saveConfig(config);

                        this.updateModelSelect(models);

                        this.showApiStatus(`成功拉取 ${models.length} 个模型`, 'success');
                    } catch (error) {
                        console.error('拉取模型失败:', error);

                        let errorMessage = error.message;
                        if (error.name === 'AbortError') {
                            errorMessage = '请求超时，请检查网络连接';
                        } else if (error.message.includes('Failed to fetch')) {
                            errorMessage = '网络连接失败，请检查API地址';
                        } else if (error.message.includes('401')) {
                            errorMessage = 'API密钥无效或已过期';
                        } else if (error.message.includes('请求失败:')) {
                            // 提取HTTP状态码
                            errorMessage = error.message.replace('请求失败:', '').trim();
                        }

                        // 显示自定义错误弹窗
                        showCustomErrorModal(errorMessage);

                        const exampleModels = [
                            { id: 'gpt-3.5-turbo', name: 'GPT 3.5 Turbo' },
                            { id: 'gpt-4', name: 'GPT 4' },
                            { id: 'gpt-4-turbo', name: 'GPT 4 Turbo' },
                            { id: 'claude-3-haiku', name: 'Claude 3 Haiku' },
                            { id: 'gemini-pro', name: 'Gemini Pro' }
                        ];

                        this.updateModelSelect(exampleModels);
                    } finally {
                        fetchBtnText.textContent = '拉取模型列表';
                        fetchLoading.style.display = 'none';
                        fetchModelsBtn.disabled = false;
                    }
                }

                saveConfiguration() {
                    const apiUrl = apiUrlInput.value.trim();
                    const apiKey = apiKeyInput.value.trim();
                    const model = modelSelect.value;

                    if (!apiUrl) {
                        this.showApiStatus('请输入API地址', 'error');
                        return;
                    }

                    if (!apiKey) {
                        this.showApiStatus('请输入API密钥', 'error');
                        return;
                    }

                    if (!model) {
                        this.showApiStatus('请选择模型', 'error');
                        return;
                    }

                    const config = this.getConfig();
                    config.apiUrl = apiUrl;
                    config.apiKey = apiKey;
                    config.model = model;

                    this.saveConfig(config);
                    this.showApiStatus('配置已保存！', 'success');

                    setTimeout(() => {
                        ModalManager.hide('api');
                    }, 2000);
                }

                // ========== API预设管理 ==========
                getPresets() {
                    const defaultPresets = [];
                    const presetsStr = this.friendSystem
                        ? this.friendSystem.getStorage('apiPresets', JSON.stringify(defaultPresets))
                        : StorageManager.get('apiPresets', defaultPresets);
                    if (typeof presetsStr === 'string') {
                        try {
                            return JSON.parse(presetsStr);
                        } catch {
                            return defaultPresets;
                        }
                    }
                    return Array.isArray(presetsStr) ? presetsStr : defaultPresets;
                }

                savePreset(name, preset) {
                    const presets = this.getPresets();
                    // 检查是否已存在同名预设，若有则更新
                    const existingIndex = presets.findIndex(p => p.name === name);
                    if (existingIndex >= 0) {
                        presets[existingIndex] = { name, ...preset, savedTime: new Date().toISOString() };
                    } else {
                        presets.push({ name, ...preset, savedTime: new Date().toISOString() });
                    }

                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiPresets', JSON.stringify(presets));
                    } else {
                        StorageManager.set('apiPresets', presets);
                    }
                }

                deletePreset(name) {
                    const presets = this.getPresets();
                    const filteredPresets = presets.filter(p => p.name !== name);
                    if (this.friendSystem) {
                        this.friendSystem.setStorage('apiPresets', JSON.stringify(filteredPresets));
                    } else {
                        StorageManager.set('apiPresets', filteredPresets);
                    }
                }

                loadPreset(name) {
                    const presets = this.getPresets();
                    const preset = presets.find(p => p.name === name);
                    if (preset) {
                        apiUrlInput.value = preset.apiUrl;
                        apiKeyInput.value = preset.apiKey;
                        if (preset.model && modelSelect.value !== preset.model) {
                            // 如果有保存的模型，尝试设置（但不强制）
                            const options = Array.from(modelSelect.options);
                            const matchingOption = options.find(opt => opt.value === preset.model);
                            if (matchingOption) {
                                modelSelect.value = preset.model;
                            }
                        }
                        this.showApiStatus(`已加载预设: ${name}`, 'success');
                    }
                }

                renderPresetList() {
                    const container = document.getElementById('presetListContainer');
                    const drawerList = document.getElementById('apiPresetDrawerList');
                    const presets = this.getPresets();

                    if (!container) return;

                    // 主列表始终显示按钮
                    container.innerHTML = '<button id="apiPresetDrawerBtn" type="button" style="color: #333; font-size: 12px; padding: 8px; text-align: center; background: #F5F3F6; border-radius: 8px; border: none; cursor: pointer; font-weight: 500;">点击选择API预设</button>';
                    this.setupDrawerButton();

                    // 填充抽屉列表
                    if (drawerList) {
                        if (presets.length === 0) {
                            drawerList.innerHTML = '<div style="color: #999; font-size: 11px; padding: 10px; text-align: center;">暂无预设</div>';
                        } else {
                            drawerList.innerHTML = presets.map(preset => `
                                <div style="display: flex; gap: 6px; align-items: center; padding: 5px 6px;">
                                    <button data-preset-name="${preset.name}" class="preset-drawer-item" type="button" style="flex: 1; padding: 5px 6px; background: #F5F3F6; border: none; border-radius: 6px; cursor: pointer; text-align: left; font-size: 11px; color: #333; transition: background 0.2s;">
                                        <div style="font-weight: 500; font-size: 11px;">${preset.name}</div>
                                        <div style="font-size: 9px; color: #999; margin-top: 1px;">${preset.apiUrl.substring(0, 25)}...</div>
                                    </button>
                                    <button data-preset-name="${preset.name}" class="preset-delete-drawer-btn" type="button" style="width: 24px; height: 24px; min-width: 24px; padding: 0; background: #F5F3F6; border: none; border-radius: 4px; cursor: pointer; color: #999; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">×</button>
                                </div>
                            `).join('');

                            // 绑定抽屉项的点击事件
                            drawerList.querySelectorAll('.preset-drawer-item').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const name = btn.dataset.presetName;
                                    this.loadPreset(name);
                                    this.closeApiPresetDrawer();
                                });
                            });

                            // 绑定删除按钮事件
                            drawerList.querySelectorAll('.preset-delete-drawer-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    const name = btn.dataset.presetName;
                                    this.deletePreset(name);
                                    this.renderPresetList();
                                });
                                // 添加hover效果
                                btn.addEventListener('mouseenter', () => {
                                    btn.style.background = '#E8E4E9';
                                    btn.style.color = '#666';
                                });
                                btn.addEventListener('mouseleave', () => {
                                    btn.style.background = '#F5F3F6';
                                    btn.style.color = '#999';
                                });
                            });
                        }
                    }
                }

                setupDrawerButton() {
                    const drawerBtn = document.getElementById('apiPresetDrawerBtn');
                    if (drawerBtn && !drawerBtn.hasListener) {
                        drawerBtn.addEventListener('click', () => this.openApiPresetDrawer());
                        drawerBtn.hasListener = true;
                    }
                }

                openApiPresetDrawer() {
                    const modal = document.getElementById('apiPresetModal');
                    if (modal) {
                        modal.style.display = 'flex';
                    }
                }

                closeApiPresetDrawer() {
                    const modal = document.getElementById('apiPresetModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }
            }

            // ========== 心声系统 ==========
            class HeartVoiceSystem {
                constructor(friendSystemInstance, apiServiceInstance) {
                    this.friendSystem = friendSystemInstance;
                    this.apiService = apiServiceInstance;
                    this.popup = document.getElementById('heartVoicePopup');
                    this.textEl = document.getElementById('heartVoiceText');
                    this.statusEl = document.getElementById('heartVoiceStatus');
                    this.moodFillEl = document.getElementById('heartVoiceMoodFill');
                    this.moodLabelEl = document.getElementById('heartVoiceMoodLabel');
                    this.demeanorEl = document.getElementById('heartVoiceDemeanor');
                    this.btn = document.getElementById('heartVoiceBtn');

                    this.historyBtn = document.getElementById('heartVoiceHistoryBtn');
                    this.historyModal = document.getElementById('heartVoiceHistoryModal');
                    this.historyList = document.getElementById('heartVoiceHistoryList');
                    this.closeHistoryBtn = document.getElementById('closeHeartVoiceHistoryModal');

                    this.deleteModal = document.getElementById('hvDeleteModal');
                    this.deleteConfirmBtn = document.getElementById('hvDeleteConfirm');
                    this.deleteCancelBtn = document.getElementById('hvDeleteCancel');
                    this.pendingDeleteIndex = -1;
                    this.selectedItems = new Set();

                    // 多选模式状态
                    this.isMultiSelectMode = false;
                    this.multiSelectItems = new Map(); // 存储选中的项 {time -> true}

                    this.initEvents();
                }

                initEvents() {
                    if (this.btn) {
                        this.btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.togglePopup();
                        });
                    }

                    if (this.historyBtn) {
                        this.historyBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.openHistory();
                        });
                    }

                    if (this.closeHistoryBtn) {
                        this.closeHistoryBtn.addEventListener('click', () => {
                            if (this.historyModal) this.historyModal.style.display = 'none';
                        });
                    }

                    if (this.deleteCancelBtn) {
                        this.deleteCancelBtn.addEventListener('click', () => {
                            if (this.deleteModal) this.deleteModal.style.display = 'none';
                        });
                    }

                    if (this.deleteConfirmBtn) {
                        this.deleteConfirmBtn.addEventListener('click', () => {
                            this.performDelete();
                        });
                    }

                    // 多选模式按钮
                    const deleteSelectBtn = document.getElementById('hv-delete-select-btn');
                    const exportSelectBtn = document.getElementById('hv-export-select-btn');

                    if (deleteSelectBtn) {
                        deleteSelectBtn.addEventListener('click', () => {
                            if (this.isMultiSelectMode) {
                                // 已在多选模式，点击按钮执行删除
                                this.confirmMultiDelete();
                            } else {
                                // 进入多选模式
                                this.enterMultiSelectMode('delete');
                            }
                        });
                    }

                    if (exportSelectBtn) {
                        exportSelectBtn.addEventListener('click', () => {
                            if (this.isMultiSelectMode) {
                                // 已在多选模式，点击按钮执行导出
                                this.confirmMultiExport();
                            } else {
                                // 进入多选模式
                                this.enterMultiSelectMode('export');
                            }
                        });
                    }

                    // 点击外部关闭
                    document.addEventListener('click', (e) => {
                        if (this.popup && this.popup.classList.contains('is-open')) {
                            if (!this.popup.contains(e.target) && e.target !== this.btn && !this.btn.contains(e.target)) {
                                this.closePopup();
                            }
                        }
                        if (this.historyModal && this.historyModal.style.display === 'flex') {
                            if (e.target === this.historyModal) {
                                this.historyModal.style.display = 'none';
                            }
                        }
                        if (this.deleteModal && this.deleteModal.style.display === 'flex') {
                            if (e.target === this.deleteModal) {
                                this.deleteModal.style.display = 'none';
                            }
                        }
                    });
                }

                getStorageKey(friendId) {
                    return `heartvoice_${friendId}`;
                }

                getData(friendId) {
                    return StorageManager.get(this.getStorageKey(friendId), null);
                }

                saveData(friendId, data) {
                    StorageManager.set(this.getStorageKey(friendId), data);
                }

                togglePopup() {
                    if (!this.popup) return;
                    const isOpen = this.popup.classList.toggle('is-open');
                    if (isOpen && chatSession && chatSession.getCurrentFriendId()) {
                        const friendId = chatSession.getCurrentFriendId();
                        console.log('[心声系统] 打开心声面板 - 好友ID:', friendId);
                        this.render(friendId);
                    }
                }

                closePopup() {
                    if (this.popup) {
                        this.popup.classList.remove('is-open');
                    }
                }

                openHistory() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    // 关闭小弹窗
                    if (this.popup) this.popup.classList.remove('is-open');

                    // 动态设置弹窗标题为「xxの心声」
                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const titleEl = document.getElementById('heartVoiceHistoryTitle');
                    if (titleEl) titleEl.textContent = `${friend?.name || ''}の心声`;

                    this.selectedItems.clear();
                    // 重置多选模式，确保每次打开都是正常模式
                    this.isMultiSelectMode = false;
                    this.multiSelectItems.clear();

                    this.renderHistory(friendId);
                    if (this.historyModal) this.historyModal.style.display = 'flex';

                    // 确保顶部按钮显示
                    const deleteSelectBtn = document.getElementById('hv-delete-select-btn');
                    const exportSelectBtn = document.getElementById('hv-export-select-btn');
                    if (deleteSelectBtn) deleteSelectBtn.style.display = '';
                    if (exportSelectBtn) exportSelectBtn.style.display = '';
                }

                renderHistory(friendId) {
                    if (!this.historyList) return;
                    this.historyList.innerHTML = '';

                    const data = this.getData(friendId);
                    const history = (data && data.history) ? data.history : [];

                    // 过滤无效项：只保留心声长度 >= 6 的有效记录
                    const validHistory = history.filter(item => {
                        const voiceText = String(item.voice || '').trim();
                        return voiceText.length >= 6;
                    });

                    const sorted = [...validHistory].reverse();

                    // 顶部工具栏（多选模式下显示）
                    if (this.isMultiSelectMode && sorted.length > 0) {
                        const toolbarHtml = `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(245, 245, 250, 0.5)); border-radius: 12px; margin-bottom: 12px; gap: 8px;">
                                <span style="color: #8b7d9c; font-size: 12px; font-weight: 600;">已选 <span id="hv-multi-count">${this.multiSelectItems.size}</span> 项</span>
                                <div style="display: flex; gap: 8px;">
                                    <button id="hv-multi-delete-btn" style="padding: 6px 16px; background: linear-gradient(135deg, var(--color-accent-pink), var(--color-accent-lavender)); color: #fff; border: none; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15); transition: all 0.2s;">删除</button>
                                    <button id="hv-multi-export-btn" style="padding: 6px 16px; background: linear-gradient(135deg, var(--color-accent-lavender), var(--color-accent-blue)); color: #fff; border: none; border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15); transition: all 0.2s;">导出</button>
                                    <button id="hv-multi-cancel-btn" style="padding: 6px 16px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s;">取消</button>
                                </div>
                            </div>
                        `;
                        this.historyList.insertAdjacentHTML('beforeend', toolbarHtml);

                        // 绑定多选模式按钮事件
                        setTimeout(() => {
                            const deleteBtn = this.historyList.querySelector('#hv-multi-delete-btn');
                            const exportBtn = this.historyList.querySelector('#hv-multi-export-btn');
                            const cancelBtn = this.historyList.querySelector('#hv-multi-cancel-btn');

                            if (deleteBtn) deleteBtn.addEventListener('click', () => this.confirmMultiDelete());
                            if (exportBtn) exportBtn.addEventListener('click', () => this.confirmMultiExport());
                            if (cancelBtn) cancelBtn.addEventListener('click', () => this.exitMultiSelectMode());
                        }, 0);
                    }

                    // 列表顶部插入艺术标题
                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const titleHtml = `<div class="hv-history-title">${friend?.name || ''}の心声</div><div class="hv-history-title-line"></div>`;
                    this.historyList.insertAdjacentHTML('beforeend', titleHtml);

                    if (sorted.length === 0) {
                        this.historyList.insertAdjacentHTML('beforeend', '<div class="page-hint" style="margin-bottom: 0; color: #a09caa; font-size: 14px; min-height: 200px; display: flex; align-items: center; justify-content: center;">暂无历史心声</div>');
                        return;
                    }

                    sorted.forEach((item, i) => {
                        const el = document.createElement('div');
                        el.className = 'hv-history-item';
                        if (this.multiSelectItems.has(item.time)) {
                            el.classList.add('selected');
                        }
                        const date = new Date(item.time);
                        const timeStr = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

                        // 多选模式下显示复选框
                        const checkboxHtml = this.isMultiSelectMode ? `<div style="display: flex; align-items: center; margin-right: 8px; flex-shrink: 0;"><input type="checkbox" class="hv-item-checkbox" style="width: 18px; height: 18px; cursor: pointer;" ${this.multiSelectItems.has(item.time) ? 'checked' : ''}></div>` : '';

                        el.innerHTML = `
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;">
                            ${checkboxHtml}
                            <div style="flex: 1;">
                                <div class="hv-history-header">
                                    <span class="hv-history-time">${timeStr}</span>
                                    <span class="hv-history-mood">心情 ${item.mood}%</span>
                                </div>
                                <div class="hv-history-content"></div>
                            </div>
                            <button class="hv-delete-btn" style="background: none; border: none; color: var(--color-accent-pink); cursor: pointer; font-size: 14px; padding: 4px 8px; flex-shrink: 0; display: flex; align-items: center; opacity: 0.7; transition: opacity 0.2s; ${this.isMultiSelectMode ? 'display: none;' : ''}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;

                        // 使用textContent安全地设置心声内容
                        const contentDiv = el.querySelector('.hv-history-content');
                        if (contentDiv) {
                            contentDiv.textContent = item.voice;
                        }
                        // 绑定复选框事件（多选模式）
                        if (this.isMultiSelectMode) {
                            const checkbox = el.querySelector('.hv-item-checkbox');
                            if (checkbox) {
                                checkbox.addEventListener('change', (e) => {
                                    if (e.target.checked) {
                                        // 检查是否超过5条限制
                                        if (this.multiSelectItems.size >= 5) {
                                            e.target.checked = false;
                                            showCuteToast('最多只能选择5条记录');
                                            return;
                                        }
                                        this.multiSelectItems.set(item.time, true);
                                        el.classList.add('selected');
                                    } else {
                                        this.multiSelectItems.delete(item.time);
                                        el.classList.remove('selected');
                                    }
                                    // 更新计数
                                    const countEl = this.historyList.querySelector('#hv-multi-count');
                                    if (countEl) countEl.textContent = this.multiSelectItems.size;
                                });
                            }

                            // 点击项也能切换选中
                            el.addEventListener('click', (e) => {
                                if (!e.target.closest('input[type="checkbox"]')) {
                                    const checkbox = el.querySelector('.hv-item-checkbox');
                                    if (checkbox) {
                                        checkbox.checked = !checkbox.checked;
                                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                                    }
                                }
                            });
                        } else {
                            // 正常模式下的删除按钮
                            const originalIndex = history.length - 1 - i;
                            const deleteBtn = el.querySelector('.hv-delete-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    this.pendingDeleteIndex = originalIndex;
                                    if (this.deleteModal) this.deleteModal.style.display = 'flex';
                                });

                                // 悬停效果
                                deleteBtn.addEventListener('mouseenter', () => {
                                    deleteBtn.style.opacity = '1';
                                });
                                deleteBtn.addEventListener('mouseleave', () => {
                                    deleteBtn.style.opacity = '0.7';
                                });
                            }

                            // 绑定长按删除
                            this.attachLongPress(el, originalIndex);
                        }

                        this.historyList.appendChild(el);
                    });
                }

                attachLongPress(el, index) {
                    let timer;
                    this.isLongPressTriggered = false;

                    const start = () => {
                        this.isLongPressTriggered = false;
                        timer = setTimeout(() => {
                            this.isLongPressTriggered = true;
                            if (navigator.vibrate) navigator.vibrate(50);
                            this.pendingDeleteIndex = index;
                            if (this.deleteModal) this.deleteModal.style.display = 'flex';
                        }, 600);
                    };
                    const end = () => clearTimeout(timer);

                    el.addEventListener('touchstart', start, { passive: true });
                    el.addEventListener('touchend', end);
                    el.addEventListener('touchmove', end);
                    el.addEventListener('mousedown', start);
                    el.addEventListener('mouseup', end);
                    el.addEventListener('mouseleave', end);
                }

                performDelete() {
                    if (this.pendingDeleteIndex === -1 || !chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    data.history.splice(this.pendingDeleteIndex, 1);
                    this.saveData(friendId, data);

                    if (this.deleteModal) this.deleteModal.style.display = 'none';
                    this.renderHistory(friendId);

                    // 如果删除的是最新一条，更新主界面
                    if (this.pendingDeleteIndex === data.history.length) { // 刚删掉的是原来的最后一条
                        this.render(friendId);
                    }
                }

                // ========== 多选模式函数 ==========
                enterMultiSelectMode(mode) {
                    this.isMultiSelectMode = true;
                    this.multiSelectItems.clear();
                    this.currentMultiSelectMode = mode;

                    // 隐藏顶部按钮
                    const deleteSelectBtn = document.getElementById('hv-delete-select-btn');
                    const exportSelectBtn = document.getElementById('hv-export-select-btn');
                    if (deleteSelectBtn) deleteSelectBtn.style.display = 'none';
                    if (exportSelectBtn) exportSelectBtn.style.display = 'none';

                    if (chatSession) {
                        this.renderHistory(chatSession.getCurrentFriendId());
                    }
                }

                exitMultiSelectMode() {
                    this.isMultiSelectMode = false;
                    this.multiSelectItems.clear();
                    this.currentMultiSelectMode = null;

                    // 显示顶部按钮
                    const deleteSelectBtn = document.getElementById('hv-delete-select-btn');
                    const exportSelectBtn = document.getElementById('hv-export-select-btn');
                    if (deleteSelectBtn) deleteSelectBtn.style.display = '';
                    if (exportSelectBtn) exportSelectBtn.style.display = '';

                    if (chatSession) {
                        this.renderHistory(chatSession.getCurrentFriendId());
                    }
                }

                confirmMultiDelete() {
                    if (this.multiSelectItems.size === 0) {
                        showCuteToast('请先选择要删除的记录');
                        return;
                    }

                    // 显示确认框
                    const confirmOverlay = document.createElement('div');
                    confirmOverlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;padding:24px;';
                    confirmOverlay.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 245, 255, 0.9)); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); max-width: 300px; text-align: center; border: 1px solid rgba(245, 220, 250, 0.5);">
                            <h3 style="color: #4a4858; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">确认删除</h3>
                            <p style="color: #8b7d9c; font-size: 14px; margin: 0 0 24px 0;">确认删除选中的 ${this.multiSelectItems.size} 条记录吗？</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button id="hv-multi-delete-yes" style="padding: 10px 24px; background: linear-gradient(135deg, var(--color-accent-pink), var(--color-accent-lavender)); color: #fff; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15);">删除</button>
                                <button id="hv-multi-delete-no" style="padding: 10px 24px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 20px; font-weight: 600; cursor: pointer;">取消</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmOverlay);

                    const yesBtn = confirmOverlay.querySelector('#hv-multi-delete-yes');
                    const noBtn = confirmOverlay.querySelector('#hv-multi-delete-no');

                    yesBtn.addEventListener('click', () => {
                        this.performMultiDelete();
                        confirmOverlay.remove();
                    });

                    noBtn.addEventListener('click', () => {
                        confirmOverlay.remove();
                    });

                    confirmOverlay.addEventListener('click', (e) => {
                        if (e.target === confirmOverlay) confirmOverlay.remove();
                    });
                }

                performMultiDelete() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    const deleteCount = this.multiSelectItems.size;
                    // 删除选中的项（按时间戳匹配）
                    data.history = data.history.filter(item => !this.multiSelectItems.has(item.time));
                    this.saveData(friendId, data);

                    showCuteToast(`已删除 ${deleteCount} 条记录`);
                    // 先退出多选模式（显示顶部按钮），再重新渲染
                    this.exitMultiSelectMode();
                    this.render(friendId);
                }

                confirmMultiExport() {
                    if (this.multiSelectItems.size === 0) {
                        showCuteToast('请先选择要导出的记录');
                        return;
                    }

                    // 显示确认框
                    const confirmOverlay = document.createElement('div');
                    confirmOverlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;padding:24px;';
                    confirmOverlay.innerHTML = `
                        <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 245, 255, 0.9)); border-radius: 20px; padding: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15); max-width: 300px; text-align: center; border: 1px solid rgba(245, 220, 250, 0.5);">
                            <h3 style="color: #4a4858; font-size: 16px; font-weight: 600; margin: 0 0 12px 0;">确认导出</h3>
                            <p style="color: #8b7d9c; font-size: 14px; margin: 0 0 24px 0;">确认导出选中的 ${this.multiSelectItems.size} 条记录吗？</p>
                            <div style="display: flex; gap: 12px; justify-content: center;">
                                <button id="hv-multi-export-yes" style="padding: 10px 24px; background: linear-gradient(135deg, var(--color-accent-lavender), var(--color-accent-blue)); color: #fff; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(120, 119, 133, 0.15);">导出</button>
                                <button id="hv-multi-export-no" style="padding: 10px 24px; background: rgba(255, 255, 255, 0.8); color: #8b7d9c; border: 1px solid rgba(240, 220, 250, 0.4); border-radius: 20px; font-weight: 600; cursor: pointer;">取消</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmOverlay);

                    const yesBtn = confirmOverlay.querySelector('#hv-multi-export-yes');
                    const noBtn = confirmOverlay.querySelector('#hv-multi-export-no');

                    yesBtn.addEventListener('click', async () => {
                        await this.performMultiExport();
                        confirmOverlay.remove();
                    });

                    noBtn.addEventListener('click', () => {
                        confirmOverlay.remove();
                    });

                    confirmOverlay.addEventListener('click', (e) => {
                        if (e.target === confirmOverlay) confirmOverlay.remove();
                    });
                }

                async performMultiExport() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    if (!friendId) return;

                    const data = this.getData(friendId);
                    if (!data || !data.history) return;

                    // 获取选中的记录
                    const selectedHistory = data.history.filter(item => this.multiSelectItems.has(item.time));
                    if (selectedHistory.length === 0) return;

                    const exportCount = selectedHistory.length;
                    // 先退出多选模式（显示顶部按钮）
                    this.exitMultiSelectMode();

                    // 调用导出函数
                    showCuteToast(`正在导出 ${exportCount} 条记录`);
                    await this.generateExportImageFromItems(selectedHistory, friendId);
                }

                async generateExportImageFromItems(historyItems, friendId) {
                    if (historyItems.length === 0) return;

                    const friend = this.friendSystem ? this.friendSystem.getFriendById(friendId) : null;
                    const friendName = friend?.name || '未知角色';
                    const friendAvatar = friend?.avatar || null;

                    const scale = 2;
                    const w = 450;
                    const pad = 28;
                    const lineH = 26;
                    const cardGap = 14;
                    const headerH = 150;
                    const cardPad = 16;
                    const cardRadius = 16;

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    ctx.font = `${15 * scale}px sans-serif`;
                    const textW = w - pad * 2 - cardPad * 2;
                    let totalH = headerH;
                    for (const item of historyItems) {
                        const th = this.measureTextHeight(ctx, item.voice, textW * scale, lineH * scale);
                        totalH += th / scale + cardPad * 2 + 24 + cardGap;
                    }
                    totalH += 40;

                    canvas.width = w * scale;
                    canvas.height = totalH * scale;
                    ctx.scale(scale, scale);

                    const bgGrad = ctx.createLinearGradient(0, 0, w, totalH);
                    bgGrad.addColorStop(0, '#fdf2f8');
                    bgGrad.addColorStop(0.5, '#fef7fb');
                    bgGrad.addColorStop(1, '#f5f3ff');
                    ctx.fillStyle = bgGrad;
                    ctx.fillRect(0, 0, w, totalH);

                    const drawGlowSpot = (x, y, r, color) => {
                        const glow = ctx.createRadialGradient(x, y, 0, x, y, r);
                        glow.addColorStop(0, color);
                        glow.addColorStop(1, 'transparent');
                        ctx.fillStyle = glow;
                        ctx.fillRect(x - r, y - r, r * 2, r * 2);
                    };
                    drawGlowSpot(w * 0.15, totalH * 0.2, 120, 'rgba(255, 230, 240, 0.2)');
                    drawGlowSpot(w * 0.85, totalH * 0.35, 100, 'rgba(240, 230, 255, 0.18)');
                    drawGlowSpot(w * 0.5, totalH * 0.7, 150, 'rgba(250, 240, 255, 0.15)');
                    drawGlowSpot(w * 0.2, totalH * 0.85, 80, 'rgba(255, 245, 250, 0.18)');

                    ctx.globalAlpha = 0.03;
                    for (let i = 0; i < w * totalH * 0.008; i++) {
                        const nx = Math.random() * w;
                        const ny = Math.random() * totalH;
                        ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#f0e8f5';
                        ctx.fillRect(nx, ny, 1, 1);
                    }
                    ctx.globalAlpha = 1;

                    const roundRect = (x, y, rw, rh, r) => {
                        ctx.beginPath();
                        ctx.moveTo(x + r, y);
                        ctx.lineTo(x + rw - r, y);
                        ctx.quadraticCurveTo(x + rw, y, x + rw, y + r);
                        ctx.lineTo(x + rw, y + rh - r);
                        ctx.quadraticCurveTo(x + rw, y + rh, x + rw - r, y + rh);
                        ctx.lineTo(x + r, y + rh);
                        ctx.quadraticCurveTo(x, y + rh, x, y + rh - r);
                        ctx.lineTo(x, y + r);
                        ctx.quadraticCurveTo(x, y, x + r, y);
                        ctx.closePath();
                    };

                    const imgSize = 72;
                    const cx = w / 2, cy = 24 + imgSize / 2;
                    let avatarImg = null;
                    if (friendAvatar) {
                        try {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.src = friendAvatar;
                            await new Promise(r => { img.onload = r; img.onerror = r; if (img.complete) r(); });
                            if (img.naturalWidth > 0) avatarImg = img;
                        } catch (_) { }
                    }

                    ctx.save();
                    const glowGrad = ctx.createRadialGradient(cx, cy, imgSize / 2 - 2, cx, cy, imgSize / 2 + 12);
                    glowGrad.addColorStop(0, 'rgba(255, 255, 255, 0.7)');
                    glowGrad.addColorStop(0.5, 'rgba(240, 220, 250, 0.3)');
                    glowGrad.addColorStop(1, 'transparent');
                    ctx.fillStyle = glowGrad;
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2 + 12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    ctx.save();
                    ctx.shadowColor = 'rgba(220, 210, 230, 0.3)';
                    ctx.shadowBlur = 16;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#fef7fb';
                    ctx.fill();
                    ctx.restore();

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    ctx.closePath();
                    ctx.clip();
                    ctx.fillStyle = '#fef7fb';
                    ctx.fillRect(cx - imgSize / 2, cy - imgSize / 2, imgSize, imgSize);
                    if (avatarImg) {
                        ctx.drawImage(avatarImg, cx - imgSize / 2, cy - imgSize / 2, imgSize, imgSize);
                    } else {
                        ctx.fillStyle = '#8b7d9c';
                        ctx.font = 'bold 32px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(friendName[0] || '♥', cx, cy);
                    }
                    ctx.restore();

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(cx, cy, imgSize / 2, 0, Math.PI * 2);
                    const borderGrad = ctx.createLinearGradient(cx - imgSize / 2, cy - imgSize / 2, cx + imgSize / 2, cy + imgSize / 2);
                    borderGrad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                    borderGrad.addColorStop(0.5, 'rgba(240, 220, 250, 0.5)');
                    borderGrad.addColorStop(1, 'rgba(255, 255, 255, 0.7)');
                    ctx.strokeStyle = borderGrad;
                    ctx.lineWidth = 2.5;
                    ctx.stroke();
                    ctx.restore();

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'alphabetic';
                    ctx.font = 'bold 18px sans-serif';

                    ctx.save();
                    ctx.shadowColor = 'rgba(220, 210, 230, 0.25)';
                    ctx.shadowBlur = 8;
                    ctx.shadowOffsetY = 2;
                    ctx.fillStyle = '#706680';
                    ctx.fillText(`${friendName}の心声`, w / 2, cy + imgSize / 2 + 28);
                    ctx.restore();

                    const ulW = 60;
                    const ulGrad = ctx.createLinearGradient(w / 2 - ulW / 2, 0, w / 2 + ulW / 2, 0);
                    ulGrad.addColorStop(0, 'rgba(240, 220, 250, 0.2)');
                    ulGrad.addColorStop(0.3, 'rgba(240, 220, 250, 0.7)');
                    ulGrad.addColorStop(0.7, 'rgba(255, 230, 240, 0.7)');
                    ulGrad.addColorStop(1, 'rgba(255, 230, 240, 0.2)');
                    ctx.fillStyle = ulGrad;
                    roundRect(w / 2 - ulW / 2, cy + imgSize / 2 + 32, ulW, 2, 1);
                    ctx.fill();

                    let curY = headerH;
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'alphabetic';

                    for (const item of historyItems) {
                        ctx.font = '15px sans-serif';
                        const th = this.measureTextHeight(ctx, item.voice, textW, lineH);
                        const boxH = th + cardPad * 2 + 24;

                        ctx.save();
                        ctx.shadowColor = 'rgba(220, 210, 230, 0.2)';
                        ctx.shadowBlur = 15;
                        ctx.shadowOffsetY = 6;
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.01)';
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        const cardGrd = ctx.createLinearGradient(pad, curY, w - pad, curY + boxH);
                        cardGrd.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                        cardGrd.addColorStop(0.5, 'rgba(255, 255, 255, 0.85)');
                        cardGrd.addColorStop(1, 'rgba(255, 255, 255, 0.88)');
                        ctx.fillStyle = cardGrd;
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad + 2, curY + 2, w - pad * 2 - 4, boxH * 0.4, cardRadius - 2);
                        const shineGrd = ctx.createLinearGradient(pad, curY, pad, curY + boxH * 0.4);
                        shineGrd.addColorStop(0, 'rgba(255, 255, 255, 0.35)');
                        shineGrd.addColorStop(1, 'rgba(255, 255, 255, 0)');
                        ctx.fillStyle = shineGrd;
                        ctx.fill();
                        ctx.restore();

                        ctx.save();
                        roundRect(pad, curY, w - pad * 2, boxH, cardRadius);
                        const borderGrd = ctx.createLinearGradient(pad, curY, w - pad, curY + boxH);
                        borderGrd.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                        borderGrd.addColorStop(0.5, 'rgba(245, 235, 250, 0.4)');
                        borderGrd.addColorStop(1, 'rgba(255, 255, 255, 0.7)');
                        ctx.strokeStyle = borderGrd;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        ctx.restore();

                        const date = new Date(item.time);
                        const ts = `${date.getMonth() + 1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                        ctx.font = '12px sans-serif';
                        ctx.fillStyle = '#9590a0';
                        ctx.fillText(ts, pad + cardPad, curY + cardPad + 12);

                        const moodStr = `心情 ${item.mood}%`;
                        ctx.font = '600 11px sans-serif';
                        const moodW = ctx.measureText(moodStr).width + 18;
                        const moodX = w - pad - cardPad - moodW;

                        ctx.save();
                        roundRect(moodX, curY + cardPad - 1, moodW, 22, 11);
                        const moodGrd = ctx.createLinearGradient(moodX, curY + cardPad, moodX + moodW, curY + cardPad + 22);
                        moodGrd.addColorStop(0, 'rgba(240, 220, 250, 0.3)');
                        moodGrd.addColorStop(1, 'rgba(255, 230, 240, 0.25)');
                        ctx.fillStyle = moodGrd;
                        ctx.fill();
                        roundRect(moodX, curY + cardPad - 1, moodW, 22, 11);
                        ctx.strokeStyle = 'rgba(240, 220, 250, 0.4)';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                        ctx.restore();

                        ctx.fillStyle = '#b8a0c8';
                        ctx.textAlign = 'center';
                        ctx.fillText(moodStr, moodX + moodW / 2, curY + cardPad + 14);

                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#4a4858';
                        ctx.font = '15px sans-serif';
                        this.wrapText(ctx, item.voice, pad + cardPad, curY + cardPad + 36, textW, lineH);

                        curY += boxH + cardGap;
                    }

                    const dataUrl = canvas.toDataURL('image/png');
                    this.showExportPreview(dataUrl, friendId);
                }

                /* 导出心声历史为高清相册图片 */
                /* 导出心声历史为高清相册图片 - 复用 generateExportImageFromItems 避免代码重复 */
                async exportHistory() {
                    if (!chatSession) return;
                    const friendId = chatSession.getCurrentFriendId();
                    const data = this.getData(friendId);
                    if (!data || !data.history || data.history.length === 0) {
                        showCuteToast('暂无历史记录可导出');
                        return;
                    }

                    // 过滤无效项：只保留心声长度 >= 6 的有效记录
                    const validHistory = data.history.filter(item => {
                        const voiceText = String(item.voice || '').trim();
                        return voiceText.length >= 6;
                    });

                    let history = [...validHistory].reverse();
                    if (this.selectedItems.size > 0) {
                        history = history.filter(item => this.selectedItems.has(item.time));
                    }
                    if (history.length === 0) {
                        showCuteToast('暂无有效的历史记录可导出');
                        return;
                    }

                    // 复用 generateExportImageFromItems 进行绘图
                    await this.generateExportImageFromItems(history, friendId);
                }
                /* 显示导出预览弹窗，用户确认后保存 */
                showExportPreview(dataUrl, friendId) {
                    let overlay = document.getElementById('hvExportPreviewOverlay');
                    if (overlay) overlay.remove();

                    overlay = document.createElement('div');
                    overlay.id = 'hvExportPreviewOverlay';
                    overlay.style.cssText = 'position:fixed;inset:0;z-index:2300;background:rgba(0,0,0,0.45);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;';
                    overlay.innerHTML = `
                    <img src="${dataUrl}" style="max-width:90%;max-height:65vh;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,0.25);object-fit:contain;margin-bottom:20px;" />
                    <div style="display:flex;gap:12px;">
                        <button id="hvExportSave" style="padding:12px 32px;background:linear-gradient(135deg,var(--color-accent-lavender),var(--color-accent-pink));color:#fff;border:none;border-radius:25px;font-weight:600;font-size:14px;cursor:pointer;box-shadow:0 4px 16px rgba(120,119,133,0.15);">保存图片</button>
                        <button id="hvExportCancel" style="padding:12px 32px;background:rgba(255,255,255,0.9);color:var(--color-ui-gray);border:1px solid var(--color-ui-border);border-radius:25px;font-weight:600;font-size:14px;cursor:pointer;">取消</button>
                    </div>
                `;
                    document.body.appendChild(overlay);

                    overlay.querySelector('#hvExportSave').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.download = `heart_voice_${friendId}_${Date.now()}.png`;
                        link.href = dataUrl;
                        link.click();
                        overlay.remove();
                        showCuteToast('保存成功');
                    });
                    overlay.querySelector('#hvExportCancel').addEventListener('click', () => overlay.remove());
                    overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
                }

                // 辅助方法：计算文本高度
                measureTextHeight(ctx, text, maxWidth, lineHeight) {
                    const words = text.split('');
                    let line = '';
                    let count = 1;
                    for (let n = 0; n < words.length; n++) {
                        const testLine = line + words[n];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && n > 0) {
                            line = words[n];
                            count++;
                        } else {
                            line = testLine;
                        }
                    }
                    return count * lineHeight;
                }

                // 辅助方法：绘制自动换行文本
                wrapText(ctx, text, x, y, maxWidth, lineHeight) {
                    const words = text.split('');
                    let line = '';
                    let currentY = y;
                    for (let n = 0; n < words.length; n++) {
                        const testLine = line + words[n];
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && n > 0) {
                            ctx.fillText(line, x, currentY);
                            line = words[n];
                            currentY += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    ctx.fillText(line, x, currentY);
                }

                render(friendId) {
                    const data = this.getData(friendId);
                    // 只有当有新数据时才更新，否则保留现有内容
                    if (data) {
                        this.textEl.textContent = data.voice || '';
                        if (this.demeanorEl) this.demeanorEl.textContent = data.demeanor || '';
                        const mood = data.mood !== undefined ? data.mood : 50;

                        // 处理进度条宽度：负数显示0%，超过100显示100%
                        const displayWidth = Math.max(0, Math.min(100, mood));
                        this.moodFillEl.style.width = `${displayWidth}%`;

                        // 根据心情值设置颜色
                        if (mood < 0) {
                            // 负数：红色（困扰/消极）
                            this.moodFillEl.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8787)';
                        } else if (mood > 100) {
                            // 超过100：金色/橙色（超满）
                            this.moodFillEl.style.background = 'linear-gradient(90deg, #ffd700, #ffb347)';
                        } else {
                            // 正常范围：默认冷调色
                            this.moodFillEl.style.background = 'linear-gradient(90deg, var(--color-accent-lavender), var(--color-accent-pink))';
                        }

                        this.moodLabelEl.textContent = `${mood}%`;
                    }
                    // 当data为空时，不清空现有内容，保持显示上次的数据
                }

            }

            // ========== 世界书系统 ==========
            class WorldBookSystem {
                constructor() {
                    this.storageKey = 'worldBooks';
                    this.currentEditingId = null;
                    this.books = this.loadBooks();
                    this.initEvents();
                }

                loadBooks() {
                    return StorageManager.get(this.storageKey, []);
                }

                saveBooks() {
                    StorageManager.set(this.storageKey, this.books);
                }

                addBook(title, content) {
                    const book = {
                        id: Date.now(),
                        title: title.trim(),
                        content: content.trim(),
                        createdAt: new Date().toISOString()
                    };
                    this.books.push(book);
                    this.saveBooks();
                    return book;
                }

                updateBook(id, title, content) {
                    const book = this.books.find(b => b.id === id);
                    if (book) {
                        book.title = title.trim();
                        book.content = content.trim();
                        this.saveBooks();
                        return book;
                    }
                    return null;
                }

                deleteBook(id) {
                    const index = this.books.findIndex(b => b.id === id);
                    if (index > -1) {
                        this.books.splice(index, 1);
                        this.saveBooks();
                        return true;
                    }
                    return false;
                }

                getBook(id) {
                    return this.books.find(b => b.id === id);
                }

                /**
                 * 【新增方法】获取当前好友已挂载的世界书
                 * 用于生成心声时一次性获取世界观背景，避免重复调用
                 */
                getActiveWorldbooks(friendId = null) {
                    if (!friendId && typeof chatSession !== 'undefined') {
                        friendId = chatSession?.getCurrentFriendId?.();
                    }

                    if (!friendId) return [];

                    const friend = typeof friendSystem !== 'undefined'
                        ? friendSystem?.getFriendById?.(friendId)
                        : null;

                    if (!friend || !Array.isArray(friend.mountedWorldBooks)) {
                        return [];
                    }

                    // 返回已挂载的世界书完整信息（不只是ID）
                    return friend.mountedWorldBooks
                        .map(bookId => this.getBook(bookId))
                        .filter(book => book !== undefined);
                }

                initEvents() {
                    const worldbookBtn = document.getElementById('worldbookBtn');
                    const worldbookBack = document.getElementById('worldbookBack');
                    const wbListBack = document.getElementById('wbListBack');
                    const wbAddNewBtn = document.getElementById('wbAddNewBtn');
                    const wbEditBack = document.getElementById('wbEditBack');
                    const wbSaveBtn = document.getElementById('wbSaveBtn');

                    if (worldbookBtn) {
                        worldbookBtn.addEventListener('click', () => this.showListPage());
                    }

                    if (worldbookBack) {
                        worldbookBack.addEventListener('click', () => ModalManager.hide('worldbook'));
                    }

                    if (wbListBack) {
                        wbListBack.addEventListener('click', () => this.showMainPage());
                    }

                    if (wbAddNewBtn) {
                        wbAddNewBtn.addEventListener('click', () => this.openNewBookPage());
                    }

                    if (wbEditBack) {
                        wbEditBack.addEventListener('click', () => this.showListPage());
                    }

                    if (wbSaveBtn) {
                        wbSaveBtn.addEventListener('click', () => this.saveBook());
                    }
                }

                showMainPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'flex';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'none';
                }

                showListPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'flex';
                    if (editPage) editPage.style.display = 'none';
                    this.renderBookList();
                }

                showEditPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('worldbookListPage');
                    const editPage = document.getElementById('worldbookEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'flex';
                }

                renderBookList() {
                    const container = document.getElementById('wbListContainer');
                    if (!container) return;

                    container.innerHTML = '';

                    if (this.books.length === 0) {
                        container.innerHTML = '<div class="page-hint" style="margin-bottom: 0; color: #999; font-size: 14px; min-height: 200px; display: flex; align-items: center;">还没有世界书，点击新建开始吧</div>';
                        return;
                    }

                    this.books.forEach(book => {
                        const card = document.createElement('div');
                        card.className = 'wb-card';
                        card.style.paddingBottom = '50px';
                        card.innerHTML = `
                        <p class="wb-card-title">${book.title}</p>
                        <p class="wb-card-preview">${book.content}</p>
                        <div class="wb-card-actions">
                            <button class="wb-card-btn wb-edit-btn" data-id="${book.id}"><i class="fas fa-edit"></i></button>
                            <button class="wb-card-btn wb-delete-btn" data-id="${book.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                        container.appendChild(card);
                    });

                    // 绑定编辑和删除按钮
                    container.querySelectorAll('.wb-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            this.openEditBookPage(id);
                        });
                    });

                    container.querySelectorAll('.wb-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            if (confirm('确定删除这个世界书吗？')) {
                                this.deleteBook(id);
                                this.renderBookList();
                            }
                        });
                    });
                }

                openNewBookPage() {
                    this.currentEditingId = null;
                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');
                    const editTitle = document.getElementById('wbEditTitle');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (editTitle) editTitle.textContent = '新建世界书';

                    this.showEditPage();
                }

                openEditBookPage(id) {
                    this.currentEditingId = id;
                    const book = this.getBook(id);
                    if (!book) return;

                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');
                    const editTitle = document.getElementById('wbEditTitle');

                    if (titleInput) titleInput.value = book.title;
                    if (contentInput) contentInput.value = book.content;
                    if (editTitle) editTitle.textContent = '编辑世界书';

                    this.showEditPage();
                }

                saveBook() {
                    const titleInput = document.getElementById('wbEditTitleInput');
                    const contentInput = document.getElementById('wbEditContentInput');

                    const title = titleInput ? titleInput.value.trim() : '';
                    const content = contentInput ? contentInput.value.trim() : '';

                    if (!title) {
                        showCuteToast('请输入名称', 'warning');
                        return;
                    }

                    if (this.currentEditingId === null) {
                        this.addBook(title, content);
                    } else {
                        this.updateBook(this.currentEditingId, title, content);
                    }

                    showCuteToast('保存成功！', 'success');
                    this.showListPage();
                }
            }

            // ========== HTML游戏系统 ==========
            class HtmlGameSystem {
                constructor() {
                    this.storageKey = 'htmlGames';
                    this.currentEditingId = null;
                    this.games = this.loadGames();
                    this.initEvents();
                }

                loadGames() {
                    return StorageManager.get(this.storageKey, []);
                }

                saveGames() {
                    StorageManager.set(this.storageKey, this.games);
                }

                addGame(title, content) {
                    const game = {
                        id: Date.now(),
                        title: title.trim(),
                        content: content.trim(),
                        createdAt: new Date().toISOString()
                    };
                    this.games.push(game);
                    this.saveGames();
                    return game;
                }

                updateGame(id, title, content) {
                    const game = this.games.find(g => g.id === id);
                    if (game) {
                        game.title = title.trim();
                        game.content = content.trim();
                        this.saveGames();
                        return game;
                    }
                    return null;
                }

                deleteGame(id) {
                    const index = this.games.findIndex(g => g.id === id);
                    if (index > -1) {
                        this.games.splice(index, 1);
                        this.saveGames();
                        return true;
                    }
                    return false;
                }

                getGame(id) {
                    return this.games.find(g => g.id === id);
                }

                initEvents() {
                    const htmlGameBtn = document.getElementById('htmlGameBtn');
                    const hgListBack = document.getElementById('hgListBack');
                    const hgAddNewBtn = document.getElementById('hgAddNewBtn');
                    const hgEditBack = document.getElementById('hgEditBack');
                    const hgSaveBtn = document.getElementById('hgSaveBtn');

                    if (htmlGameBtn) {
                        htmlGameBtn.addEventListener('click', () => this.showListPage());
                    }

                    if (hgListBack) {
                        hgListBack.addEventListener('click', () => this.showMainPage());
                    }

                    if (hgAddNewBtn) {
                        hgAddNewBtn.addEventListener('click', () => this.openNewGamePage());
                    }

                    if (hgEditBack) {
                        hgEditBack.addEventListener('click', () => this.showListPage());
                    }

                    if (hgSaveBtn) {
                        hgSaveBtn.addEventListener('click', () => this.saveGame());
                    }
                }

                showMainPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'flex';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'none';
                }

                showListPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'flex';
                    if (editPage) editPage.style.display = 'none';
                    this.renderGameList();
                }

                showEditPage() {
                    const mainPage = document.getElementById('worldbookMainPage');
                    const listPage = document.getElementById('htmlGameListPage');
                    const editPage = document.getElementById('htmlGameEditPage');
                    if (mainPage) mainPage.style.display = 'none';
                    if (listPage) listPage.style.display = 'none';
                    if (editPage) editPage.style.display = 'flex';
                }

                renderGameList() {
                    const container = document.getElementById('hgListContainer');
                    if (!container) return;

                    container.innerHTML = '';

                    if (this.games.length === 0) {
                        container.innerHTML = '<div class="page-hint" style="margin-bottom: 0; color: #999; font-size: 14px; min-height: 200px; display: flex; align-items: center;">还没有HTML游戏，点击新建开始吧</div>';
                        return;
                    }

                    this.games.forEach(game => {
                        const card = document.createElement('div');
                        card.className = 'hg-card';
                        card.style.paddingBottom = '50px';
                        card.innerHTML = `
                        <p class="hg-card-title">${game.title}</p>
                        <p class="hg-card-preview">${game.content}</p>
                        <div class="hg-card-actions">
                            <button class="hg-card-btn hg-edit-btn" data-id="${game.id}"><i class="fas fa-edit"></i></button>
                            <button class="hg-card-btn hg-delete-btn" data-id="${game.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                        container.appendChild(card);
                    });

                    // 绑定编辑和删除按钮
                    container.querySelectorAll('.hg-edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            this.openEditGamePage(id);
                        });
                    });

                    container.querySelectorAll('.hg-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            if (confirm('确定删除这个HTML游戏吗？')) {
                                this.deleteGame(id);
                                this.renderGameList();
                            }
                        });
                    });
                }

                openNewGamePage() {
                    this.currentEditingId = null;
                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');
                    const editTitle = document.getElementById('hgEditTitle');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (editTitle) editTitle.textContent = '新建HTML游戏';

                    this.showEditPage();
                }

                openEditGamePage(id) {
                    this.currentEditingId = id;
                    const game = this.getGame(id);
                    if (!game) return;

                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');
                    const editTitle = document.getElementById('hgEditTitle');

                    if (titleInput) titleInput.value = game.title;
                    if (contentInput) contentInput.value = game.content;
                    if (editTitle) editTitle.textContent = '编辑HTML游戏';

                    this.showEditPage();
                }

                saveGame() {
                    const titleInput = document.getElementById('hgEditTitleInput');
                    const contentInput = document.getElementById('hgEditContentInput');

                    const title = titleInput ? titleInput.value.trim() : '';
                    const content = contentInput ? contentInput.value.trim() : '';

                    if (!title) {
                        showCuteToast('请输入名称', 'warning');
                        return;
                    }

                    if (this.currentEditingId === null) {
                        this.addGame(title, content);
                    } else {
                        this.updateGame(this.currentEditingId, title, content);
                    }

                    showCuteToast('保存成功！', 'success');
                    this.showListPage();
                }
            }

            // ========== 聊天功能 ==========
            class ChatSession {
                constructor(friendSystemInstance, apiServiceInstance) {
                    this.friendSystem = friendSystemInstance;
                    this.apiService = apiServiceInstance;
                    this.currentFriendId = null;
                    this.isProcessing = false;
                    this.actionMenu = {
                        overlay: messageActionOverlay,
                        menu: messageActionMenu,
                        copyBtn: messageActionCopy,
                        deleteBtn: messageActionDelete,
                        recallBtn: messageActionRecall,
                        replyBtn: messageActionReply,
                        forwardBtn: document.getElementById('messageActionForward'),
                        current: null
                    };
                    this.multiSelect = {
                        active: false,
                        selectedIds: new Set(),
                        selectedWrappers: new Map()
                    };
                    this.initMessageActionMenu();
                    this.initMultiSelect();
                    this.initReplyPreview();
                    this.initImageUpload();
                }

                /**
                 * 启动心声按钮脉动动画
                 * 用于向用户反馈"正在处理回复"的状态
                 */
                startHeartVoicePulse() {
                    const heartVoiceBtn = document.getElementById('heartVoiceBtn');
                    if (heartVoiceBtn) {
                        heartVoiceBtn.classList.add('pulse-active');
                        console.log('[心声动画] 启动脉动');
                    }
                }

                /**
                 * 停止心声按钮脉动动画
                 * 在API响应接收时调用
                 */
                stopHeartVoicePulse() {
                    const heartVoiceBtn = document.getElementById('heartVoiceBtn');
                    if (heartVoiceBtn) {
                        heartVoiceBtn.classList.remove('pulse-active');
                        console.log('[心声动画] 停止脉动');
                    }
                }

                showChatStatus(message, type) {
                    chatStatus.textContent = message;
                    chatStatus.className = `status-message ${type}`;
                    chatStatus.style.display = 'block';

                    if (type === 'success') {
                        setTimeout(() => {
                            chatStatus.style.display = 'none';
                        }, 3000);
                    }
                }

                initMessageActionMenu() {
                    const { overlay, menu, copyBtn, deleteBtn, recallBtn, replyBtn, forwardBtn } = this.actionMenu;
                    if (!overlay || !menu) return;

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) this.hideMessageActionMenu();
                    });
                    menu.addEventListener('click', (e) => e.stopPropagation());

                    if (copyBtn) copyBtn.addEventListener('click', () => this.handleMessageAction('copy'));
                    if (deleteBtn) deleteBtn.addEventListener('click', () => this.handleMessageAction('delete'));
                    if (recallBtn) recallBtn.addEventListener('click', () => this.handleMessageAction('recall'));
                    if (replyBtn) replyBtn.addEventListener('click', () => this.handleMessageAction('reply'));
                    if (forwardBtn) forwardBtn.addEventListener('click', () => this.handleMessageAction('forward'));

                    // 多选按钮事件监听
                    const multiSelectBtn = document.getElementById('messageActionMultiSelect');
                    if (multiSelectBtn) {
                        multiSelectBtn.addEventListener('click', () => this.handleMessageAction('multiSelect'));
                    }

                    // 修正按钮事件监听
                    const regenerateBtn = document.getElementById('messageActionRegenerate');
                    if (regenerateBtn) {
                        regenerateBtn.addEventListener('click', () => this.handleMessageAction('regenerate'));
                    }

                    // 编辑按钮事件监听
                    const editBtn = document.getElementById('messageActionEdit');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => this.handleMessageAction('edit'));
                    }
                }

                initMultiSelect() {
                    const cancelBtn = document.getElementById('multiSelectCancelBtn');
                    const forwardBtn = document.getElementById('multiSelectForwardBtn');
                    const confirmYes = document.getElementById('multiSelectConfirmYes');
                    const confirmNo = document.getElementById('multiSelectConfirmNo');

                    if (cancelBtn) cancelBtn.addEventListener('click', () => this.exitMultiSelectMode());

                    if (forwardBtn) {
                        forwardBtn.addEventListener('click', () => {
                            const selectedMessages = this.getForwardCandidateMessagesByIds([...this.multiSelect.selectedIds]);
                            if (selectedMessages.length === 0) {
                                showCuteToast('请先选中要转发的消息');
                                return;
                            }
                            this.openForwardFriendPicker(selectedMessages);
                        });
                    }

                    if (confirmYes) {
                        confirmYes.addEventListener('click', () => {
                            this.executeMultiSelectDelete();
                            const overlay = document.getElementById('multiSelectConfirmOverlay');
                            if (overlay) overlay.style.display = 'none';
                        });
                    }

                    if (confirmNo) {
                        confirmNo.addEventListener('click', () => {
                            const overlay = document.getElementById('multiSelectConfirmOverlay');
                            if (overlay) overlay.style.display = 'none';
                        });
                    }
                }

                enterMultiSelectMode() {
                    this.multiSelect.active = true;
                    this.multiSelect.selectedIds.clear();
                    this.multiSelect.selectedWrappers.clear();
                    document.body.classList.add('multi-select-active');

                    // 事件委托：捕获阶段拦截 chatMessages 内所有点击
                    this._multiSelectClickHandler = (e) => {
                        const wrapper = e.target.closest('div[data-msg-id]');
                        if (!wrapper) return;
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        this.toggleMultiSelectMessage(wrapper);
                    };
                    chatMessages.addEventListener('click', this._multiSelectClickHandler, true);

                    const modalHeader = document.querySelector('#chatModal .modal-header');
                    if (modalHeader) {
                        Array.from(modalHeader.children).forEach(child => {
                            if (child.id !== 'multiSelectHeader') {
                                child.dataset.msOrigDisplay = child.style.display || '';
                                child.style.display = 'none';
                            }
                        });
                    }
                    const msHeader = document.getElementById('multiSelectHeader');
                    if (msHeader) msHeader.style.display = 'flex';

                    const inputAreaWrap = document.getElementById('chatInputAreaWrap');
                    const inputArea = inputAreaWrap ? inputAreaWrap.parentElement : null;
                    if (inputArea) {
                        inputArea.dataset.msOrigDisplay = inputArea.style.display || '';
                        inputArea.style.display = 'none';
                    }
                    const msFooter = document.getElementById('multiSelectFooter');
                    if (msFooter) msFooter.style.display = 'flex';

                    this.updateMultiSelectCount();

                    const allMsgWrappers = chatMessages.querySelectorAll('div[data-msg-id]');
                    allMsgWrappers.forEach(wrapper => this.ensureMultiSelectCheckbox(wrapper));
                }

                exitMultiSelectMode() {
                    this.multiSelect.active = false;
                    this.multiSelect.selectedIds.clear();
                    this.multiSelect.selectedWrappers.clear();
                    document.body.classList.remove('multi-select-active');

                    // 移除事件委托
                    if (this._multiSelectClickHandler) {
                        chatMessages.removeEventListener('click', this._multiSelectClickHandler, true);
                        this._multiSelectClickHandler = null;
                    }

                    const modalHeader = document.querySelector('#chatModal .modal-header');
                    if (modalHeader) {
                        Array.from(modalHeader.children).forEach(child => {
                            if (child.id !== 'multiSelectHeader') {
                                child.style.display = child.dataset.msOrigDisplay || '';
                                delete child.dataset.msOrigDisplay;
                            }
                        });
                    }
                    const msHeader = document.getElementById('multiSelectHeader');
                    if (msHeader) msHeader.style.display = 'none';

                    const inputAreaWrap = document.getElementById('chatInputAreaWrap');
                    const inputArea = inputAreaWrap ? inputAreaWrap.parentElement : null;
                    if (inputArea) {
                        inputArea.style.display = inputArea.dataset.msOrigDisplay || '';
                        delete inputArea.dataset.msOrigDisplay;
                    }
                    const msFooter = document.getElementById('multiSelectFooter');
                    if (msFooter) msFooter.style.display = 'none';

                    const allCheckboxes = chatMessages.querySelectorAll('.multi-select-checkbox');
                    allCheckboxes.forEach(cb => cb.classList.remove('is-checked'));

                    const overlay = document.getElementById('multiSelectConfirmOverlay');
                    if (overlay) overlay.style.display = 'none';
                }

                ensureMultiSelectCheckbox(messageWrapper) {
                    if (messageWrapper.querySelector('.multi-select-checkbox')) return;
                    const checkbox = document.createElement('div');
                    checkbox.className = 'multi-select-checkbox';
                    messageWrapper.insertBefore(checkbox, messageWrapper.firstChild);
                }

                toggleMultiSelectMessage(messageWrapper) {
                    if (!this.multiSelect.active) return;
                    const msgId = messageWrapper.dataset.msgId;
                    if (!msgId) return;

                    const checkbox = messageWrapper.querySelector('.multi-select-checkbox');

                    if (this.multiSelect.selectedIds.has(msgId)) {
                        this.multiSelect.selectedIds.delete(msgId);
                        this.multiSelect.selectedWrappers.delete(msgId);
                        if (checkbox) checkbox.classList.remove('is-checked');
                    } else {
                        this.multiSelect.selectedIds.add(msgId);
                        this.multiSelect.selectedWrappers.set(msgId, messageWrapper);
                        if (checkbox) checkbox.classList.add('is-checked');
                    }
                    this.updateMultiSelectCount();
                }

                updateMultiSelectCount() {
                    const countEl = document.getElementById('multiSelectCount');
                    if (countEl) countEl.textContent = `已选中 ${this.multiSelect.selectedIds.size} 条`;
                }

                executeMultiSelectDelete() {
                    if (!this.currentFriendId || !this.friendSystem) {
                        this.exitMultiSelectMode();
                        return;
                    }

                    const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);

                    this.multiSelect.selectedWrappers.forEach((wrapper, msgId) => {
                        if (wrapper) { const r = wrapper.closest('.message-row'); (r || wrapper).remove(); }
                        const target = history.find(m => m.id === msgId);
                        if (target) target.isDeletedLocal = true;
                    });

                    this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                    this.exitMultiSelectMode();
                    showCuteToast('删除成功');
                }

                initReplyPreview() {
                    if (!replyPreview || !replyPreviewText) return;
                    if (replyPreviewClose) {
                        replyPreviewClose.addEventListener('click', () => this.clearReplyPrefill());
                    }
                }

                initImageUpload() {
                    const processImageFile = (file) => new Promise((resolve) => {
                        try {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const dataUrl = String(event.target.result || '');
                                if (!dataUrl) return resolve('');

                                const img = new Image();
                                img.onload = () => {
                                    try {
                                        const maxSize = 1280;
                                        let { width, height } = img;
                                        if (width > maxSize || height > maxSize) {
                                            const scale = Math.min(maxSize / width, maxSize / height);
                                            width = Math.round(width * scale);
                                            height = Math.round(height * scale);
                                        }
                                        const canvas = document.createElement('canvas');
                                        canvas.width = width;
                                        canvas.height = height;
                                        const ctx = canvas.getContext('2d');
                                        if (!ctx) return resolve(dataUrl);
                                        ctx.drawImage(img, 0, 0, width, height);
                                        const optimized = canvas.toDataURL('image/jpeg', 0.9);
                                        resolve(optimized || dataUrl);
                                    } catch (e) {
                                        resolve(dataUrl);
                                    }
                                };
                                img.onerror = () => resolve(dataUrl);
                                img.src = dataUrl;
                            };
                            reader.onerror = () => resolve('');
                            reader.readAsDataURL(file);
                        } catch (e) {
                            resolve('');
                        }
                    });

                    const showImageConfirm = () => {
                        if (!imageConfirmPopover || !imageUploadBtn) return;
                        const rect = imageUploadBtn.getBoundingClientRect();
                        const popoverRect = imageConfirmPopover.getBoundingClientRect();
                        let top = rect.top - (popoverRect.height || 44) - 8;
                        if (top < 8) top = rect.bottom + 8;
                        let left = rect.left + rect.width / 2 - (popoverRect.width || 160) / 2;
                        left = Math.max(8, Math.min(left, window.innerWidth - (popoverRect.width || 160) - 8));
                        imageConfirmPopover.style.top = `${top}px`;
                        imageConfirmPopover.style.left = `${left}px`;
                        imageConfirmPopover.style.display = 'flex';
                    };

                    const hideImageConfirm = () => {
                        if (imageConfirmPopover) imageConfirmPopover.style.display = 'none';
                    };

                    if (imageUploadBtn) {
                        imageUploadBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showImageConfirm();
                        });
                    }

                    if (imageConfirmYes && imageInput) {
                        imageConfirmYes.addEventListener('click', (e) => {
                            e.stopPropagation();
                            hideImageConfirm();
                            imageInput.click();
                        });
                    }

                    if (imageConfirmNo) {
                        imageConfirmNo.addEventListener('click', (e) => {
                            e.stopPropagation();
                            hideImageConfirm();
                        });
                    }

                    if (imageInput) {
                        imageInput.addEventListener('change', (e) => {
                            const file = e.target.files && e.target.files[0];
                            if (!file) return;
                            processImageFile(file).then((dataUrl) => {
                                if (!dataUrl) return;
                                chatInput.dataset.imageData = dataUrl;
                                chatInput.dataset.imageName = file.name || '图片';
                                if (imageUploadThumb) imageUploadThumb.src = dataUrl;
                                if (imageUploadName) imageUploadName.textContent = file.name || '已选择图片';
                                if (imageUploadPill) imageUploadPill.style.display = 'flex';
                            });
                            imageInput.value = '';
                        });
                    }

                    if (imageUploadClose) {
                        imageUploadClose.addEventListener('click', () => this.clearImageUpload());
                    }

                    document.addEventListener('click', (e) => {
                        if (!imageConfirmPopover) return;
                        if (imageConfirmPopover.contains(e.target) || (imageUploadBtn && imageUploadBtn.contains(e.target))) {
                            return;
                        }
                        hideImageConfirm();
                    });
                }

                getCurrentFriendName() {
                    if (this.currentFriendId && this.friendSystem) {
                        const friend = this.friendSystem.getFriendById(this.currentFriendId);
                        if (friend && friend.name) return friend.name;
                    }
                    const title = chatTitle ? chatTitle.textContent : '';
                    const match = title.match(/与\s*(.+)\s*对话/);
                    return match && match[1] ? match[1] : '对方';
                }

                showMessageActionMenu(targetElement, data) {
                    const { overlay, menu, recallBtn } = this.actionMenu;
                    if (!overlay || !menu || !targetElement) return;

                    this.actionMenu.current = { ...data, targetElement };

                    const canRecall = !data.isRecalled;
                    if (recallBtn) recallBtn.classList.toggle('is-disabled', !canRecall);

                    overlay.style.display = 'block';
                    menu.classList.remove('is-open');
                    menu.style.top = '0px';
                    menu.style.left = '0px';

                    const rect = targetElement.getBoundingClientRect();
                    const menuRect = menu.getBoundingClientRect();

                    let top = rect.top - menuRect.height - 8;
                    if (top < 12) top = rect.bottom + 8;
                    let left = rect.left + (rect.width - menuRect.width) / 2;
                    left = Math.max(12, Math.min(left, window.innerWidth - menuRect.width - 12));

                    menu.style.top = `${top}px`;
                    menu.style.left = `${left}px`;

                    requestAnimationFrame(() => menu.classList.add('is-open'));
                }

                hideMessageActionMenu() {
                    const { overlay, menu } = this.actionMenu;
                    if (!overlay || !menu) return;
                    menu.classList.remove('is-open');
                    overlay.style.display = 'none';
                    this.actionMenu.current = null;
                }

                bindMessageActions(messageWrapper, targetElement, data) {
                    if (!messageWrapper || !targetElement) return;
                    let pressTimer = null;
                    let startX = 0;
                    let startY = 0;
                    let isLongPress = false;

                    const clearPress = () => {
                        if (pressTimer) {
                            clearTimeout(pressTimer);
                            pressTimer = null;
                        }
                        isLongPress = false;
                    };

                    const startPress = (clientX, clientY) => {
                        if (this.multiSelect.active) return;
                        startX = clientX;
                        startY = clientY;
                        isLongPress = false;
                        clearPress();
                        pressTimer = setTimeout(() => {
                            isLongPress = true;
                            this.showMessageActionMenu(targetElement, data);
                        }, 550);
                    };

                    // 拦截 touchstart 事件：启动长按计时器，禁用系统菜单但保留点击事件
                    targetElement.addEventListener('touchstart', (e) => {
                        // 仅禁用系统长按菜单，不阻止点击事件本身
                        // 注意：不在这里调用 preventDefault，避免阻止 click 事件
                        if (e.touches && e.touches[0]) {
                            startPress(e.touches[0].clientX, e.touches[0].clientY);
                        }
                    }, { passive: true });

                    targetElement.addEventListener('touchmove', (e) => {
                        if (!e.touches || !e.touches[0]) return;
                        const dx = Math.abs(e.touches[0].clientX - startX);
                        const dy = Math.abs(e.touches[0].clientY - startY);
                        if (dx > 10 || dy > 10) {
                            clearPress();
                        }
                    }, { passive: true });

                    targetElement.addEventListener('touchend', (e) => {
                        // 如果是长按触发的菜单，阻止其他点击事件
                        if (isLongPress) {
                            e.preventDefault();
                        }
                        clearPress();
                    });
                    targetElement.addEventListener('touchcancel', clearPress);

                    targetElement.addEventListener('mousedown', (e) => {
                        if (e.button === 0) { // 左键
                            startPress(e.clientX, e.clientY);
                        } else if (e.button === 2) { // 右键
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    });

                    targetElement.addEventListener('mouseup', (e) => {
                        // 如果是长按触发的菜单，阻止其他点击事件
                        if (isLongPress) {
                            e.preventDefault();
                        }
                        clearPress();
                    });

                    targetElement.addEventListener('mouseleave', clearPress);

                    // 拦截右键菜单（desktop）和长按菜单（mobile）：完全禁用系统菜单
                    targetElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        if (this.multiSelect.active) return;
                        this.showMessageActionMenu(targetElement, data);
                    });

                }

                handleMessageAction(action) {
                    const current = this.actionMenu.current;
                    if (!current) return;
                    const { messageWrapper, msgId, content, role } = current;

                    console.log('[消息菜单] 触发action:', action);

                    if (action === 'copy') {
                        this.copyToClipboard(content || '');
                    } else if (action === 'delete') {
                        this.deleteMessageLocal(messageWrapper, msgId);
                    } else if (action === 'recall') {
                        this.recallMessage(messageWrapper, msgId, role);
                    } else if (action === 'reply') {
                        this.setReplyPrefill(content || '', role);
                    } else if (action === 'multiSelect') {
                        this.hideMessageActionMenu();
                        this.enterMultiSelectMode();
                        if (messageWrapper) {
                            this.ensureMultiSelectCheckbox(messageWrapper);
                            requestAnimationFrame(() => this.toggleMultiSelectMessage(messageWrapper));
                        }
                        return;
                    } else if (action === 'forward') {
                        this.hideMessageActionMenu();
                        this.enterMultiSelectMode();
                        if (messageWrapper) {
                            this.ensureMultiSelectCheckbox(messageWrapper);
                            requestAnimationFrame(() => this.toggleMultiSelectMessage(messageWrapper));
                        }
                        return;
                    } else if (action === 'regenerate') {
                        if (role === 'ai' || role === 'assistant') {
                            this.regenerateMessage(messageWrapper, msgId);
                        } else {
                            console.warn('[修正] 只能修正角色的回复');
                        }
                    } else if (action === 'edit') {
                        this.editMessage(content || '');
                    }

                    this.hideMessageActionMenu();
                }

                copyToClipboard(text) {
                    if (!text) return;
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(text).catch(() => this.fallbackCopy(text));
                    } else {
                        this.fallbackCopy(text);
                    }
                }

                fallbackCopy(text) {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                    } catch (e) {
                        // ignore
                    }
                    document.body.removeChild(textarea);
                }

                deleteMessageLocal(messageWrapper, msgId) {
                    if (messageWrapper) { const r = messageWrapper.closest('.message-row'); (r || messageWrapper).remove(); }
                    if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                    const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                    const target = history.find(m => m.id === msgId);
                    if (target) {
                        target.isDeletedLocal = true;
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                    }
                }

                recallMessage(messageWrapper, msgId, role = 'user') {
                    let recallText = '消息已撤回';

                    if (role === 'user') {
                        recallText = '你撤回了一条消息';
                    } else if (role === 'ai' || role === 'assistant') {
                        const friendName = this.getCurrentFriendName();
                        recallText = `${friendName}撤回了一条消息`;
                    }

                    if (messageWrapper) {
                        // 撤回时替换整行为居中文本
                        const row = messageWrapper.closest('.message-row');
                        if (row) {
                            row.className = '';
                            row.innerHTML = '';
                            row.style.marginBottom = '12px';
                        }
                        const target = row || messageWrapper;
                        target.innerHTML = '';
                        target.classList.add('message-recalled-wrapper');
                        const recalled = document.createElement('div');
                        recalled.className = 'message-recalled';
                        recalled.textContent = recallText;
                        recalled.style.cursor = 'pointer';
                        target.appendChild(recalled);
                    }

                    if (!msgId || !this.currentFriendId || !this.friendSystem) return;
                    const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                    const target = history.find(m => m.id === msgId);
                    if (target) {
                        target.originalContent = target.content; // 保存原始内容
                        target.isRecalled = true;
                        target.content = recallText;
                        target.isVoice = false;
                        this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                    }
                }

                setReplyPrefill(content, role = '') {
                    if (!content) return;
                    const preview = content.replace(/\s+/g, ' ').trim();
                    const snippet = preview.length > 24 ? preview.slice(0, 24) + '...' : preview;
                    const fromName = role === 'user' ? '我' : this.getCurrentFriendName();
                    chatInput.dataset.replyText = preview;
                    chatInput.dataset.replyFrom = fromName;
                    if (replyPreview && replyPreviewText) {
                        replyPreviewText.textContent = `${fromName}：${snippet}`;
                        replyPreview.style.display = 'flex';
                    }
                    chatInput.focus();
                }

                clearReplyPrefill() {
                    delete chatInput.dataset.replyText;
                    delete chatInput.dataset.replyFrom;
                    if (replyPreview) replyPreview.style.display = 'none';
                    if (replyPreviewText) replyPreviewText.textContent = '';
                }

                // 角色随机撤回消息
                roleRandomRecall() {
                    if (!this.currentFriendId || !this.friendSystem) return;
                    if (Math.random() > 0.08) return; // 8%概率撤回

                    const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                    const recallable = history.filter(m => !m.isDeletedLocal && !m.isRecalled && m.role === 'ai');
                    if (recallable.length === 0) return;

                    const msg = recallable[Math.floor(Math.random() * recallable.length)];
                    const wrapper = document.querySelector(`[data-msg-id="${msg.id}"]`);
                    if (wrapper) this.recallMessage(wrapper, msg.id, 'ai');
                }

                clearImageUpload() {
                    delete chatInput.dataset.imageData;
                    delete chatInput.dataset.imageName;
                    delete chatInput.dataset.imageText;
                    if (imageUploadPill) imageUploadPill.style.display = 'none';
                    if (imageUploadThumb) imageUploadThumb.src = '';
                    if (imageUploadName) imageUploadName.textContent = '已选择图片';
                }

                editMessage(content) {
                    const current = this.actionMenu.current;
                    if (!current) return;

                    const messageWrapper = current.messageWrapper;
                    const msgId = current.msgId;
                    const role = current.role;

                    // 显示弹窗
                    const overlay = document.getElementById('messageEditOverlay');
                    const textarea = document.getElementById('messageEditTextarea');
                    if (!overlay || !textarea) return;

                    // 设置初始内容
                    textarea.value = content || '';
                    overlay.style.display = 'flex';
                    textarea.focus();

                    // 清空之前的事件（防止重复）
                    const cancelBtn = document.getElementById('messageEditCancel');
                    const saveBtn = document.getElementById('messageEditSave');

                    if (!cancelBtn || !saveBtn) return;

                    // 移除旧的事件监听
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    const newSaveBtn = saveBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

                    // 取消事件
                    newCancelBtn.addEventListener('click', () => {
                        overlay.style.display = 'none';
                        this.hideMessageActionMenu();
                    });

                    // 保存事件
                    newSaveBtn.addEventListener('click', () => {
                        const newContent = textarea.value.trim();
                        if (!newContent) {
                            showCuteToast('消息内容不能为空');
                            return;
                        }

                        // 更新气泡内容
                        if (messageWrapper) {
                            let messageElement = null;
                            for (let child of messageWrapper.children) {
                                if (child.classList && child.classList.contains('message')) {
                                    messageElement = child;
                                    break;
                                }
                            }
                            if (messageElement) {
                                messageElement.textContent = newContent;
                            }
                            messageWrapper.dataset.content = newContent;
                        }

                        // 更新消息库
                        if (msgId && this.currentFriendId && this.friendSystem) {
                            const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                            const target = history.find(m => m.id === msgId);
                            if (target) {
                                target.content = newContent;
                                this.friendSystem.saveFriendChatHistory(this.currentFriendId, history);
                            }
                        }

                        overlay.style.display = 'none';
                        showCuteToast('消息已修改');
                        this.hideMessageActionMenu();
                    });

                    // Escape 关闭
                    const escapeHandler = (e) => {
                        if (e.key === 'Escape' && overlay.style.display !== 'none') {
                            newCancelBtn.click();
                            textarea.removeEventListener('keydown', escapeHandler);
                        }
                    };
                    textarea.addEventListener('keydown', escapeHandler);
                }

                ensureHistoryIds(history) {
                    let changed = false;
                    const base = Date.now().toString();
                    history.forEach((msg, index) => {
                        if (!msg.id) {
                            msg.id = `msg-${base}-${index}-${Math.random().toString(36).slice(2, 6)}`;
                            changed = true;
                        }
                    });
                    return changed;
                }

                getCurrentUserName() {
                    try {
                        const profile = StorageManager.get('userProfile', { name: '我' });
                        return (profile && profile.name) ? String(profile.name).trim() || '我' : '我';
                    } catch (e) {
                        return '我';
                    }
                }

                getForwardCandidateMessagesByIds(ids = []) {
                    if (!this.currentFriendId || !this.friendSystem || !Array.isArray(ids) || ids.length === 0) return [];
                    const idSet = new Set(ids.map(String));
                    const sourceFriendName = this.getCurrentFriendName();
                    const userName = this.getCurrentUserName();
                    const history = this.friendSystem.getFriendChatHistory(this.currentFriendId) || [];
                    return history
                        .filter(msg => msg && idSet.has(String(msg.id)) && !msg.isDeletedLocal && !msg.isRecalled)
                        .map(msg => {
                            const role = (msg.role === 'assistant') ? 'ai' : (msg.role || 'user');
                            const senderName = role === 'user' ? userName : sourceFriendName;
                            return {
                                id: msg.id || `fwd-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`,
                                role,
                                senderName,
                                content: String(msg.content || ''),
                                isVoice: !!msg.isVoice,
                                imageData: msg.imageData || '',
                                imageName: msg.imageName || '',
                                timestamp: msg.timestamp || Date.now()
                            };
                        });
                }

                buildForwardBundlePayload(messages) {
                    const list = Array.isArray(messages) ? messages : [];
                    return {
                        id: `fwd-bundle-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`,
                        sourceFriendId: this.currentFriendId || '',
                        sourceFriendName: this.getCurrentFriendName(),
                        forwarderName: this.getCurrentUserName(),
                        createdAt: Date.now(),
                        messages: list
                    };
                }

                buildForwardPreviewText(bundle) {
                    if (!bundle || !Array.isArray(bundle.messages) || bundle.messages.length === 0) return '聊天记录';
                    const first = bundle.messages[0];
                    const firstText = first.imageData ? '[图片]' : (first.isVoice ? '[语音]' : (first.content || '[消息]'));
                    if (bundle.messages.length === 1) return `${firstText}`.slice(0, 18);
                    return `${firstText} 等${bundle.messages.length}条`;
                }

                openForwardFriendPicker(selectedMessages) {
                    const overlay = document.getElementById('forwardFriendOverlay');
                    const listEl = document.getElementById('forwardFriendList');
                    const cancelBtn = document.getElementById('forwardFriendCancelBtn');
                    if (!overlay || !listEl || !this.friendSystem) return;

                    const friends = this.friendSystem.getFriends().filter(f => f && f.id !== this.currentFriendId);
                    listEl.innerHTML = '';

                    if (friends.length === 0) {
                        listEl.innerHTML = '<div class="forward-empty">暂无可转发好友</div>';
                    } else {
                        friends.forEach(friend => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'forward-friend-item';
                            btn.dataset.friendId = friend.id;

                            const avatar = friend.avatar
                                ? `<div class="forward-friend-avatar"><img src="${friend.avatar}" alt="${friend.name || '好友'}"></div>`
                                : '<div class="forward-friend-avatar"><i class="fas fa-user"></i></div>';
                            btn.innerHTML = `${avatar}<span>${friend.name || '未命名好友'}</span>`;

                            btn.addEventListener('click', () => {
                                this.forwardMessagesToFriend(friend.id, selectedMessages);
                            });
                            listEl.appendChild(btn);
                        });
                    }

                    overlay.style.display = 'flex';
                    overlay.onclick = (e) => {
                        if (e.target === overlay) this.closeForwardFriendPicker();
                    };
                    if (cancelBtn) {
                        cancelBtn.onclick = () => this.closeForwardFriendPicker();
                    }
                }

                closeForwardFriendPicker() {
                    const overlay = document.getElementById('forwardFriendOverlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                        overlay.onclick = null;
                    }
                }

                forwardMessagesToFriend(targetFriendId, selectedMessages) {
                    if (!targetFriendId || !this.friendSystem || !Array.isArray(selectedMessages) || selectedMessages.length === 0) {
                        showCuteToast('转发失败');
                        return;
                    }

                    const history = this.friendSystem.getFriendChatHistory(targetFriendId) || [];
                    const bundle = this.buildForwardBundlePayload(selectedMessages);
                    const msgId = `msg-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
                    const forwardText = `[${bundle.forwarderName}转发了聊天记录]`;
                    history.push({
                        role: 'user',
                        content: forwardText,
                        isVoice: false,
                        isReplied: false,
                        id: msgId,
                        timestamp: Date.now(),
                        replyTo: '',
                        replyFrom: '',
                        imageData: '',
                        imageName: '',
                        imageText: '',
                        forwardBundle: bundle
                    });
                    this.friendSystem.saveFriendChatHistory(targetFriendId, history);

                    this.closeForwardFriendPicker();
                    this.exitMultiSelectMode();
                    this.hideMessageActionMenu();
                    showCuteToast('转发成功');
                    if (typeof window.updateFriendList === 'function') window.updateFriendList();
                }

                closeForwardRecordModal() {
                    const overlay = document.getElementById('forwardRecordOverlay');
                    if (overlay) overlay.style.display = 'none';
                }

                openForwardRecordModal(bundle) {
                    const overlay = document.getElementById('forwardRecordOverlay');
                    const body = document.getElementById('forwardRecordBody');
                    const backBtn = document.getElementById('forwardRecordBackBtn');
                    if (!overlay || !body || !bundle || !Array.isArray(bundle.messages)) return;

                    const sourceName = bundle.sourceFriendName || '对方';
                    body.innerHTML = '';
                    const tip = document.createElement('div');
                    tip.className = 'forward-record-tip';
                    tip.textContent = `聊天记录 · 来自与 ${sourceName} 的会话`;
                    body.appendChild(tip);

                    bundle.messages.forEach(item => {
                        const row = document.createElement('div');
                        row.className = 'forward-record-msg';

                        const name = document.createElement('div');
                        name.className = 'forward-record-name';
                        name.textContent = item.senderName || (item.role === 'user' ? '我' : sourceName);
                        row.appendChild(name);

                        const bubble = document.createElement('div');
                        bubble.className = 'forward-record-bubble';

                        if (item.imageData) {
                            const img = document.createElement('img');
                            img.src = item.imageData;
                            img.alt = item.imageName || '图片';
                            bubble.appendChild(img);
                        }

                        if (item.isVoice) {
                            const voiceTag = document.createElement('div');
                            voiceTag.className = 'forward-record-voice';
                            const sec = Math.max(1, Math.ceil(String(item.content || '').length / 5));
                            voiceTag.innerHTML = `<i class="fas fa-wave-square"></i><span>语音 ${sec}"</span>`;
                            bubble.appendChild(voiceTag);
                        }

                        const txt = document.createElement('div');
                        txt.textContent = item.content || (item.imageData ? '[图片]' : '[消息]');
                        bubble.appendChild(txt);

                        row.appendChild(bubble);
                        body.appendChild(row);
                    });

                    overlay.style.display = 'flex';
                    overlay.onclick = (e) => {
                        if (e.target === overlay) this.closeForwardRecordModal();
                    };
                    if (backBtn) backBtn.onclick = () => this.closeForwardRecordModal();
                }

                addMessageToChat(content, role, isVoice = false, msgId = null, replyTo = '', replyFrom = '', imageData = '', imageName = '', targetFriendId = null, forwardBundle = null) {
                    // 只有当消息属于当前打开的好友时，才将其添加到 DOM
                    // 这防止了用户在等待 API 响应时切换好友导致消息出现在错误窗口的问题
                    const displayFriendId = targetFriendId || this.currentFriendId;
                    if (displayFriendId !== this.currentFriendId) {
                        console.log(`[消息路由] 消息不属于当前好友，已保存但不显示。目标好友: ${displayFriendId}, 当前好友: ${this.currentFriendId}`);
                        return;
                    }

                    // 防御性处理：如果content不是字符串，尝试提取文本
                    if (Array.isArray(content)) {
                        content = content
                            .map(item => typeof item === 'string' ? item : (item?.text || item?.content || ''))
                            .filter(s => s).join('');
                    } else if (typeof content === 'object' && content !== null) {
                        content = content.text || content.content || content.message ||
                            Object.values(content).find(v => typeof v === 'string' && v.trim().length > 0) || '';
                    }
                    // 清洗消息内容：移除开头的emoji、前缀标记、加密标识等
                    content = String(content || '').replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '').trim();

                    // 角色消息最终兜底：禁止 inner_voice / 神态 / 心情值 混入聊天气泡
                    if (role === 'ai' && !imageData) {
                        const parsed = JSONCleaningLayer.cleanAndParse(content);
                        const extractPlainText = (val) => {
                            if (typeof val === 'string') return val.trim();
                            if (Array.isArray(val)) {
                                return val.map(item => typeof item === 'string' ? item : (item?.text || item?.content || item?.message || '')).filter(Boolean).join('');
                            }
                            if (typeof val === 'object' && val !== null) {
                                return val.text || val.content || val.message || val.reply || '';
                            }
                            return String(val ?? '');
                        };
                        if (parsed && typeof parsed === 'object' && parsed.reply !== undefined && parsed.reply !== null) {
                            content = extractPlainText(parsed.reply);
                        } else {
                            const replyMatch = content.match(/"reply"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                            if (replyMatch?.[1]) {
                                content = replyMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                            }
                        }
                        content = String(content || '')
                            .replace(/"?(?:inner_voice|心声|神态|心情值|mood_value|demeanor|heart_voice|image_desc)"?\s*[：:][^\n]*/g, '')
                            .replace(/"?inner_voice"?\s*:\s*\{[\s\S]*?\}/g, '')
                            .trim();
                    }

                    // QQ风格：消息行 = 头像 + 内容区
                    const messageRow = document.createElement('div');
                    messageRow.className = `message-row ${role === 'user' ? 'user' : 'ai'}`;

                    // 头像
                    const avatarDiv = document.createElement('div');
                    const curFriend = this.friendSystem ? this.friendSystem.getFriendById(this.currentFriendId) : null;
                    const isSquare = curFriend?.chatSquareAvatar ?? false;
                    const isHidden = curFriend?.chatHideAvatar ?? false;
                    avatarDiv.className = 'msg-avatar' + (isSquare ? ' square' : '');
                    if (isHidden) avatarDiv.style.visibility = 'hidden';
                    let avatarSrc = '';
                    if (role === 'user') {
                        const userProfile = StorageManager.get('userProfile', {});
                        avatarSrc = userProfile.avatar || '';
                    } else {
                        avatarSrc = curFriend?.avatar || '';
                    }
                    if (avatarSrc) {
                        const avatarImg = document.createElement('img');
                        avatarImg.src = avatarSrc;
                        avatarImg.alt = role === 'user' ? '我' : this.getCurrentFriendName();
                        avatarImg.onerror = () => { avatarDiv.innerHTML = '<div class="avatar-placeholder"><i class="fas fa-user"></i></div>'; };
                        avatarDiv.appendChild(avatarImg);
                    } else {
                        avatarDiv.innerHTML = '<div class="avatar-placeholder"><i class="fas fa-user"></i></div>';
                    }
                    messageRow.appendChild(avatarDiv);

                    // 内容区（原messageWrapper）
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = 'msg-content';
                    if (msgId) messageWrapper.dataset.msgId = msgId;
                    messageWrapper.dataset.role = role;
                    messageWrapper.dataset.content = content;
                    messageWrapper.dataset.isVoice = isVoice ? 'true' : 'false';
                    if (forwardBundle && typeof forwardBundle === 'object') {
                        messageWrapper.dataset.forwardBundle = JSON.stringify(forwardBundle);
                    }
                    const isAiRole = role === 'ai' || role === 'assistant';
                    const isSvgPlaceholder = typeof imageData === 'string' && imageData.startsWith('data:image/svg+xml');
                    const hasLongDescText = String(content || '').trim().length >= 20;
                    const isLegacyAiDescImage = isAiRole && isSvgPlaceholder && hasLongDescText && (imageName === '图片' || !imageName);
                    const isImageDesc = imageName === '描述图' || isLegacyAiDescImage;
                    let actionTarget = null;

                    if (replyTo) {
                        const replyBlock = document.createElement('div');
                        replyBlock.className = `reply-quote ${role}`;
                        const fromLabel = replyFrom || (role === 'user' ? '我' : this.getCurrentFriendName());
                        replyBlock.textContent = `${fromLabel}：${replyTo}`;
                        messageWrapper.appendChild(replyBlock);
                    }

                    if (forwardBundle && typeof forwardBundle === 'object') {
                        const card = document.createElement('div');
                        card.className = 'forward-bundle-card';
                        const title = document.createElement('div');
                        title.className = 'forward-bundle-title';
                        title.textContent = content || `[${forwardBundle.forwarderName || 'TA'}转发了聊天记录]`;
                        const preview = document.createElement('div');
                        preview.className = 'forward-bundle-preview';
                        preview.textContent = this.buildForwardPreviewText(forwardBundle);
                        card.appendChild(title);
                        card.appendChild(preview);
                        card.addEventListener('click', () => this.openForwardRecordModal(forwardBundle));
                        messageWrapper.appendChild(card);
                        actionTarget = card;
                        isVoice = false;
                        imageData = '';
                    }

                    if (imageData) {
                        const imageWrap = document.createElement('div');
                        imageWrap.className = `message-image-wrap ${role}`;

                        const imageEl = document.createElement('img');
                        imageEl.className = isImageDesc ? 'message-image desc-thumb' : 'message-image';
                        imageEl.src = imageData;
                        imageEl.alt = imageName || '图片';
                        imageWrap.appendChild(imageEl);

                        if (isImageDesc) {
                            const hint = document.createElement('div');
                            hint.className = 'message-image-hint';
                            hint.textContent = '点开看图';
                            imageWrap.appendChild(hint);
                        }

                        messageWrapper.appendChild(imageWrap);
                        actionTarget = imageWrap;

                        if (isImageDesc) {
                            imageWrap.style.cursor = 'pointer';
                            imageWrap.addEventListener('click', () => {
                                if (window.openImageDescModal) {
                                    window.openImageDescModal(messageWrapper, msgId, content);
                                }
                            });
                        }
                    }

                    if (isVoice) {
                        const voiceContainer = document.createElement('div');
                        voiceContainer.style.display = 'flex';
                        voiceContainer.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';

                        const voiceMessage = document.createElement('div');
                        voiceMessage.className = `message ${role}`;
                        voiceMessage.style.display = 'flex';
                        voiceMessage.style.alignItems = 'center';
                        voiceMessage.style.gap = '4px';
                        voiceMessage.style.cursor = 'pointer';
                        voiceMessage.style.width = 'auto';  // 根据内容自动计算宽度
                        voiceMessage.style.minWidth = '60px';  // 最小宽度
                        voiceMessage.style.maxWidth = '320px';  // 最大宽度限制，防止冲出屏幕
                        voiceMessage.style.padding = '10px 15px';
                        voiceMessage.style.borderRadius = '12px';

                        const waveForm = document.createElement('div');
                        waveForm.style.display = 'flex';
                        waveForm.style.gap = '2px';
                        waveForm.style.alignItems = 'center';
                        waveForm.style.flex = '1';

                        for (let i = 0; i < 8; i++) {
                            const bar = document.createElement('div');
                            bar.style.width = '3px';
                            bar.style.height = Math.random() * 20 + 8 + 'px';
                            bar.style.backgroundColor = role === 'user' ? 'rgba(0, 0, 0, 0.35)' : 'rgba(0, 0, 0, 0.3)';
                            bar.style.borderRadius = '2px';
                            waveForm.appendChild(bar);
                        }

                        const duration = Math.ceil(content.length / 5);
                        const duration_text = document.createElement('span');
                        duration_text.textContent = '"' + duration + '"';
                        duration_text.style.fontSize = '12px';
                        duration_text.style.whiteSpace = 'nowrap';
                        duration_text.style.color = role === 'user' ? 'inherit' : 'inherit';

                        voiceMessage.appendChild(waveForm);
                        voiceMessage.appendChild(duration_text);

                        voiceContainer.appendChild(voiceMessage);
                        messageWrapper.appendChild(voiceContainer);

                        const transcriptionDiv = document.createElement('div');
                        transcriptionDiv.style.display = 'none';
                        transcriptionDiv.style.marginTop = '2px';
                        transcriptionDiv.style.padding = '8px 12px';
                        transcriptionDiv.style.backgroundColor = '#f0f0f0';
                        transcriptionDiv.style.borderRadius = '8px';
                        transcriptionDiv.style.fontSize = '13px';
                        transcriptionDiv.style.color = '#1a1a1a';
                        transcriptionDiv.style.maxWidth = '220px';
                        transcriptionDiv.style.marginLeft = role === 'user' ? 'auto' : '0';
                        transcriptionDiv.style.marginRight = role === 'user' ? '0' : 'auto';
                        transcriptionDiv.textContent = content;

                        messageWrapper.appendChild(transcriptionDiv);

                        voiceMessage.addEventListener('click', () => {
                            if (transcriptionDiv.style.display === 'none') {
                                transcriptionDiv.style.display = 'block';
                            } else {
                                transcriptionDiv.style.display = 'none';
                            }
                        });

                        this.bindMessageActions(messageWrapper, voiceMessage, {
                            messageWrapper,
                            msgId,
                            content,
                            role,
                            isVoice,
                            isRecalled: false
                        });
                    } else {
                        if (!isImageDesc && !(forwardBundle && typeof forwardBundle === 'object')) {
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${role}`;
                            messageElement.textContent = content;
                            messageWrapper.appendChild(messageElement);
                            actionTarget = messageElement;
                        }

                        if (actionTarget) {
                            this.bindMessageActions(messageWrapper, actionTarget, {
                                messageWrapper,
                                msgId,
                                content,
                                role,
                                isVoice,
                                isRecalled: false
                            });
                        }
                    }

                    if (this.multiSelect && this.multiSelect.active) {
                        this.ensureMultiSelectCheckbox(messageWrapper);
                    }
                    messageRow.appendChild(messageWrapper);
                    chatMessages.appendChild(messageRow);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                    // 实时更新好友列表（仅用户消息立即更新，角色消息批量更新避免频繁刷新）
                    if (this.currentFriendId && typeof window.updateFriendList === 'function' && role === 'user') {
                        window.updateFriendList();
                    }
                }

                addRecalledMessageToChat(msgId = null, role = 'user') {
                    let recallText = '消息已撤回';
                    let originalContent = '';

                    if (role === 'user') {
                        recallText = '你撤回了一条消息';
                    } else if (role === 'ai' || role === 'assistant') {
                        const friendName = this.getCurrentFriendName();
                        recallText = `${friendName}撤回了一条消息`;
                    }

                    // 获取原始内容供点击查看
                    if (msgId && this.currentFriendId && this.friendSystem) {
                        const history = this.friendSystem.getFriendChatHistory(this.currentFriendId);
                        const target = history.find(m => m.id === msgId);
                        if (target && target.originalContent) {
                            originalContent = target.originalContent;
                        }
                    }

                    const messageWrapper = document.createElement('div');
                    messageWrapper.style.marginBottom = '12px';
                    messageWrapper.classList.add('message-recalled-wrapper');
                    messageWrapper.dataset.msgId = msgId;
                    messageWrapper.dataset.friendId = this.currentFriendId;

                    const recalled = document.createElement('div');
                    recalled.className = 'message-recalled';
                    recalled.textContent = recallText;

                    // 如果有原始内容，添加点击事件
                    if (originalContent) {
                        recalled.style.cursor = 'pointer';
                        recalled.addEventListener('click', () => {
                            showCuteToast(originalContent);
                        });
                    }

                    messageWrapper.appendChild(recalled);
                    chatMessages.appendChild(messageWrapper);
                }

                // ========== 人设冲突检测：计算文本相似度 ==========
                calculateTextSimilarity(text1, text2) {
                    if (!text1 || !text2) return 0;

                    // 标准化文本（小写、去标点、分词）
                    const normalize = (str) => {
                        return str.toLowerCase()
                            .replace(/[^\w\u4e00-\u9fff]/g, '')  // 去掉非汉字和字母
                            .split('')
                            .filter(c => c.trim());
                    };

                    const arr1 = normalize(text1);
                    const arr2 = normalize(text2);

                    if (arr1.length === 0 || arr2.length === 0) return 0;

                    // 计算相同词汇的比例
                    let matches = 0;
                    for (let char of arr1) {
                        if (arr2.includes(char)) {
                            matches++;
                            arr2.splice(arr2.indexOf(char), 1);
                        }
                    }

                    const similarity = (2 * matches) / (arr1.length + arr2.length + matches);
                    return Math.round(similarity * 100) / 100;  // 返回0-1之间的值
                }

                /**
                 * 统一高效的响应清洗器
                 * @param {string} text - 原始文本
                 * @param {boolean} aggressive - 是否激进清理（用于心声残留）
                 */
                /**
                 * 轻量清洗器：只清理明确的格式标记，绝不删除可能是正常对话的内容
                 * @param {string} text - 文本
                 * @param {boolean} aggressive - 是否清理心声关键词残留
                 */
                sanitizeAiResponse(text, aggressive = false) {
                    if (!text) return '';

                    let cleaned = text
                        // 只移除明确的格式标记，不动正常对话
                        .replace(/\[语音[\s\S]*?\]/g, '')          // [语音...]
                        .replace(/【[\s\S]*?】/g, '')               // 【标记】
                        .replace(/\d+秒[：:]|语音\s*\d+秒/g, '')    // 语音时长标记
                        .replace(/\|\|\|\|/g, '')                   // 分隔符
                        .replace(/^[\u{1F300}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\s]+/gu, '')  // 开头emoji
                        .replace(/^(?:encrypted|ENCRYPTED|locked|LOCKED|加密|锁定)[\s：:]*/, '')  // 加密标记
                        .replace(/\.{2,}|…{2,}/g, '……')
                        .replace(/(?:……){2,}/g, '……')
                        .replace(/\s{2,}/g, ' ')
                        .trim();

                    // 激进模式：只清理明确的心声字段标记
                    if (aggressive) {
                        cleaned = cleaned
                            .replace(/心声[：:][^\n]*|神态[：:][^\n]*|心情值[：:][^\n]*/g, '')
                            .replace(/inner_voice[：:][^\n]*/g, '')
                            .replace(/mood_value[：:][^\n]*/g, '')
                            .trim();
                    }

                    return cleaned;
                }

                splitSentences(text) {
                    if (!text) return [];

                    // ===== 预处理：在分割前移除所有格式化文本 =====
                    let preprocessed = text
                        // 移除所有 [语音...] 类型的描述
                        .replace(/\[语音[\s\S]*?\]/g, '')
                        // 移除所有 【...】 类型的标记
                        .replace(/【[\s\S]*?】/g, '')
                        // 移除包含"秒："的格式化行（如"15秒：...")
                        .replace(/\d+秒：[^\n。！？]*[\n。！？]?/g, '')
                        .trim();

                    // 如果预处理后为空，返回空数组
                    if (!preprocessed) return [];

                    // ===== 分割逻辑 =====
                    const sentences = preprocessed.split(/([。！？\n]+)/);
                    const result = [];

                    for (let i = 0; i < sentences.length; i++) {
                        const sentence = sentences[i];
                        if (!sentence.trim()) continue;

                        if (/^[。！？\n]+$/.test(sentence)) {
                            // 保留标点符号
                            if (result.length > 0) {
                                result[result.length - 1] += sentence;
                            }
                        } else {
                            result.push(sentence.trim());
                        }
                    }

                    return result.length > 0 ? result : [preprocessed];
                }

                isLowInfoSentence(text) {
                    const t = String(text || '').trim();
                    if (!t) return true;
                    const normalized = t.replace(/[。！？!?\s]/g, '');
                    return /^(嗯+|哦+|噢+|好的?|行|在|在呢|好吧|哈哈+|然后呢?)$/.test(normalized);
                }

                normalizeAiReplyForDisplay(text) {
                    let t = String(text || '').trim();
                    if (!t) return '';

                    const leadingFiller = /^(?:嗯+|哦+|噢+|好的?|行)[，。！？、\s]*/;
                    const withoutFiller = t.replace(leadingFiller, '').trim();
                    if (withoutFiller.length >= 4) t = withoutFiller;

                    const parts = t.split(/([。！？\n]+)/).filter(Boolean);
                    const merged = [];
                    for (let i = 0; i < parts.length; i++) {
                        const chunk = parts[i].trim();
                        if (!chunk) continue;
                        if (/^[。！？\n]+$/.test(chunk)) {
                            if (merged.length > 0) merged[merged.length - 1] += chunk;
                            continue;
                        }
                        const prev = merged.length > 0 ? merged[merged.length - 1] : '';
                        const prevNorm = prev.replace(/[^\w\u4e00-\u9fff]/g, '');
                        const currNorm = chunk.replace(/[^\w\u4e00-\u9fff]/g, '');
                        if (prevNorm && currNorm && (prevNorm === currNorm || this.calculateTextSimilarity(prevNorm, currNorm) > 0.9)) {
                            continue;
                        }
                        merged.push(chunk);
                    }
                    t = merged.join('').replace(/\s{2,}/g, ' ').trim();
                    return t;
                }

                ensureNonEmptyAiText(text, fallback = '') {
                    const t = String(text || '').trim();
                    if (t && t !== '...' && t !== '…') return t;
                    // 清洗失败不允许返回空，直接返回原始文本
                    return fallback ? fallback : text;
                }

                buildPromptContextHistory(chatHistory, memoryChatCount) {
                    // 包含所有消息，但标记被撤回消息
                    const all = (chatHistory || []).filter(msg => !msg.isDeletedLocal);
                    const targetCount = Math.max(1, Number(memoryChatCount) || 30);
                    if (all.length <= targetCount) return all;

                    const records = all.map((msg, idx) => ({
                        msg,
                        idx,
                        key: msg.id ? `id:${msg.id}` : `idx:${idx}`
                    }));

                    const recentKeep = Math.min(targetCount, Math.min(8, Math.max(3, Math.floor(targetCount * 0.3))));
                    const recent = records.slice(-recentKeep);
                    const older = records.slice(0, -recentKeep);
                    const selectedKeys = new Set(recent.map(r => r.key));
                    const anchors = [];
                    const anchorMax = Math.min(4, Math.max(0, targetCount - recentKeep));

                    const findLast = (predicate) => {
                        for (let i = older.length - 1; i >= 0; i--) {
                            const r = older[i];
                            if (selectedKeys.has(r.key)) continue;
                            if (predicate(r.msg)) return r;
                        }
                        return null;
                    };

                    const rules = [
                        (m) => !m.isRecalled && m.role === 'user' && !!m.imageData,
                        (m) => !m.isRecalled && m.role === 'user' && /[？?]|怎么|为何|为什么|吗|呢/.test(String(m.content || '')),
                        (m) => !m.isRecalled && /(难受|生气|开心|崩溃|烦|委屈|想哭|激动|焦虑|失眠)/.test(String(m.content || '')),
                        (m) => !m.isRecalled && /(等会|待会|回头|记得|答应|要发|会发|稍后)/.test(String(m.content || ''))
                    ];

                    for (const rule of rules) {
                        if (anchors.length >= anchorMax) break;
                        const hit = findLast(rule);
                        if (hit) {
                            anchors.push(hit);
                            selectedKeys.add(hit.key);
                        }
                    }

                    const selected = [...anchors, ...recent];
                    if (selected.length < targetCount) {
                        for (let i = older.length - 1; i >= 0 && selected.length < targetCount; i--) {
                            const r = older[i];
                            if (selectedKeys.has(r.key)) continue;
                            selected.push(r);
                            selectedKeys.add(r.key);
                        }
                    }

                    return selected
                        .sort((a, b) => a.idx - b.idx)
                        .map(r => r.msg);
                }

                generateAIMessages(response, persona) {
                    // 确保response是有效字符串，如果不是就直接用原始值
                    if (!response || typeof response !== 'string') {
                        console.error('[generateAIMessages] 输入类型异常，强制转为字符串');
                        response = String(response || '');
                    }

                    // 保存原始文本，清洗失败时作为fallback
                    const originalResponse = response;
                    response = this.normalizeAiReplyForDisplay(response);
                    response = this.ensureNonEmptyAiText(response, originalResponse);

                    const sentences = this.splitSentences(response);
                    let validSentences = sentences.filter(s => s.trim());
                    // 如果分割/预处理后变空了，用原始文本作为唯一句子（绝不丢弃）
                    if (validSentences.length === 0) {
                        validSentences = [response.trim()];
                    }

                    // 技术性限制：最多20条（防止崩溃），最少1条（角色自主决定）
                    const maxCount = Math.max(1, Math.min(20, validSentences.length));
                    const minCount = 1;  // 让角色自然根据人设、世界书和当前对话决定，不强制最少条数
                    const weighted = Math.random();
                    let messageCount = Math.round(minCount + weighted * (maxCount - minCount));
                    if (messageCount < minCount) messageCount = minCount;
                    if (messageCount > maxCount) messageCount = maxCount;

                    // 语音概率：由角色根据人设、世界书和当前对话自然决定，前端保持基础随机性
                    const voiceProbability = 0.4;

                    const messages = [];

                    if (validSentences.length <= messageCount) {
                        for (const sentence of validSentences) {
                            // 跳过过短的无效内容
                            if (sentence.trim().length < 2) continue;
                            if (validSentences.length > 1 && this.isLowInfoSentence(sentence)) continue;
                            // 单条消息限制200字（现代手机屏幕足够大）
                            const content = sentence.length > 200 ? sentence.substring(0, 197) + '...' : sentence;
                            messages.push({
                                content: content,
                                isVoice: Math.random() < voiceProbability
                            });
                        }
                    } else {
                        let index = 0;
                        while (index < validSentences.length) {
                            const remaining = validSentences.length - index;
                            const maxChunk = remaining > 4 ? 2 : 1;
                            const chunkSize = Math.min(remaining, Math.random() < 0.5 ? 1 : maxChunk);
                            const chunk = validSentences.slice(index, index + chunkSize).join('');
                            // 跳过过短的无效内容
                            if (chunk.trim().length < 2) {
                                index += chunkSize;
                                continue;
                            }
                            if (validSentences.length > 1 && this.isLowInfoSentence(chunk)) {
                                index += chunkSize;
                                continue;
                            }
                            // 单条消息限制200字
                            const content = chunk.trim().length > 200 ? chunk.trim().substring(0, 197) + '...' : chunk.trim();
                            messages.push({
                                content: content,
                                isVoice: Math.random() < voiceProbability
                            });
                            index += chunkSize;
                        }
                    }

                    // 去除高度重复的连续消息
                    const deduped = [];
                    for (const msg of messages) {
                        const content = this.ensureNonEmptyAiText(this.normalizeAiReplyForDisplay(msg.content || ''));
                        if (!content) continue;
                        const prev = deduped.length > 0 ? deduped[deduped.length - 1].content : '';
                        if (prev && this.calculateTextSimilarity(content, prev) > 0.9) {
                            continue;
                        }
                        deduped.push({ content, isVoice: !!msg.isVoice });
                    }

                    // 【关键保底】如果没有生成任何消息，直接返回原始文本
                    if (deduped.length === 0) {
                        console.warn('[生成角色消息] 未生成任何有效消息，返回原始文本');
                        return [{ content: this.ensureNonEmptyAiText(response), isVoice: false }];
                    }

                    // 技术性上限：最多返回20条消息
                    return deduped.slice(0, 20).map(m => ({
                        content: this.ensureNonEmptyAiText(m.content),
                        isVoice: !!m.isVoice
                    }));
                }

                getSharedState(key, defaultValue) {
                    try {
                        if (this.friendSystem && typeof this.friendSystem.getStorage === 'function') {
                            return this.friendSystem.getStorage(key, defaultValue);
                        }
                        return StorageManager.get(key, defaultValue);
                    } catch (e) {
                        return defaultValue;
                    }
                }

                setSharedState(key, value) {
                    try {
                        if (this.friendSystem && typeof this.friendSystem.setStorage === 'function') {
                            this.friendSystem.setStorage(key, value);
                            return;
                        }
                        StorageManager.set(key, value);
                    } catch (e) {
                        // ignore
                    }
                }

                getImageShareHistory(friendId) {
                    const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                    const history = this.getSharedState(key, []);
                    return Array.isArray(history) ? history : [];
                }

                saveImageShareHistory(friendId, history) {
                    const key = friendId ? `imgShareHistory_${friendId}` : 'imgShareHistory_global';
                    this.setSharedState(key, history);
                }

                isImageShareOnCooldown(friendId, cooldownMs = 60 * 60 * 1000) {
                    const now = Date.now();
                    const globalLast = this.getSharedState('imgShareLastAt_global', 0) || 0;
                    const friendLast = friendId ? (this.getSharedState(`imgShareLastAt_${friendId}`, 0) || 0) : 0;
                    const lastAt = Math.max(globalLast, friendLast);
                    return now - lastAt < cooldownMs;
                }

                markImageShareSent(friendId) {
                    const now = Date.now();
                    this.setSharedState('imgShareLastAt_global', now);
                    if (friendId) this.setSharedState(`imgShareLastAt_${friendId}`, now);
                }

                async decideAiImageShare() {
                    return null;
                }

                ensureConcreteImageDesc(desc) {
                    let text = String(desc || '').trim();
                    if (!text) return '';
                    text = text
                        .replace(/^\[图片\]/, '')
                        .replace(/^（图片）/, '')
                        .replace(/^(图片描述|描述|画面|场景|特写)：/g, '')
                        .trim();
                    if (text.length < 20) return '';
                    if (text.length > 300) text = text.slice(0, 300).trim();
                    return text;
                }

                hasExplicitImageSendIntent(text) {
                    const t = String(text || '').trim();
                    if (!t) return false;

                    // 只在非常明确的"现在发图"表述时返回true
                    return (
                        /(?:现在|这就|马上).{0,5}(?:发|给你|传)/.test(t) ||
                        /(?:图片|照片|自拍).{0,5}(?:发给你|传给你|送给你)了/.test(t)
                    );
                }

                addLoadingMessage(id) {
                    const loadingElement = document.createElement('div');
                    loadingElement.id = id;
                    loadingElement.className = 'message ai';
                    loadingElement.innerHTML = '<span class="loading"></span> 思考中...';
                    chatMessages.appendChild(loadingElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                removeLoadingMessage(id) {
                    const loadingElement = document.getElementById(id);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                }

                async regenerateMessage(messageWrapper, msgId) {
                    if (!messageWrapper || !msgId) return;

                    console.log('[修正] 开始重新生成消息:', msgId);

                    // 获取当前好友ID
                    const targetFriendId = this.currentFriendId;
                    if (!targetFriendId) {
                        this.showChatStatus('修正失败：未找到好友ID', 'error');
                        return;
                    }

                    try {
                        // 【关键修复】删除该消息及其之后的所有消息
                        // 因为后续消息都是基于这条错误消息生成的，必须一起删除
                        if (this.friendSystem) {
                            const chatHistory = this.friendSystem.getFriendChatHistory(targetFriendId);

                            // 找到要修正的消息的索引位置
                            const targetIndex = chatHistory.findIndex(msg => msg.id === msgId);

                            if (targetIndex !== -1) {
                                // 只保留该消息之前的历史，删除该消息及其之后的所有内容
                                const filteredHistory = chatHistory.slice(0, targetIndex);

                                this.friendSystem.saveFriendChatHistory(targetFriendId, filteredHistory);
                                console.log(`[修正] 已删除消息 ${msgId} 及其之后的所有消息，保留 ${filteredHistory.length} 条，删除 ${chatHistory.length - filteredHistory.length} 条`);

                                // 同时删除DOM中该消息之后的所有消息
                                const allMessageWrappers = Array.from(chatMessages.querySelectorAll('[data-msg-id]'));
                                let foundTarget = false;
                                allMessageWrappers.forEach(wrapper => {
                                    if (foundTarget || wrapper.dataset.msgId === msgId) {
                                        const row = wrapper.closest('.message-row');
                                        (row || wrapper).remove();
                                        foundTarget = true;
                                    }
                                });
                            } else {
                                console.warn('[修正] 未找到目标消息，仅删除DOM元素');
                                if (messageWrapper) { const row = messageWrapper.closest('.message-row'); (row || messageWrapper).remove(); }
                            }
                        } else {
                            // 没有friendSystem时，只删除DOM元素
                            if (messageWrapper) { const row = messageWrapper.closest('.message-row'); (row || messageWrapper).remove(); }
                        }

                        // 清除角色回复缓存，避免防重复检测影响新回复
                        window._previousAIContent = '';

                        // 重新调用角色执理（强制回复模式，基于完整对话历史）
                        await this.triggerAI(null, true);

                        console.log('[修正] 完成');
                    } catch (error) {
                        console.error('[修正] 执行失败:', error);
                        // 只有HTTP错误才显示弹窗
                        if (error.message && error.message.includes('请求失败:')) {
                            const errorCode = error.message.replace('请求失败:', '').trim();
                            showCustomErrorModal(errorCode);
                        }
                        // 其他错误只记录日志，不打断
                    }
                }

                openChatWithFriend(friend) {
                    const friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                    const freshFriend = friends.find(f => f.id === friend.id) || friend;
                    this.currentFriendId = freshFriend.id;
                    chatTitle.textContent = friend.name;
                    if (typeof window.updateFriendList === 'function') {
                        window.updateFriendList();
                    }

                    // 清除回复预览和图片上传状态（重要：防止消息混乱）
                    this.clearReplyPrefill();
                    this.clearImageUpload();
                    chatInput.value = '';

                    // 更新聊天头部的好友头像
                    const chatHeader = chatModal.querySelector('.modal-header');
                    const existingAvatar = document.getElementById('chatFriendAvatarIcon');

                    // 移除旧头像
                    if (existingAvatar) {
                        existingAvatar.remove();
                    }

                    // 创建新头像（如果有）
                    if (freshFriend.avatar && chatHeader) {
                        const avatarIcon = document.createElement('div');
                        avatarIcon.id = 'chatFriendAvatarIcon';
                        avatarIcon.style.cssText = 'width: 32px; height: 32px; border-radius: 50%; overflow: hidden; margin-right: 8px; flex-shrink: 0; background: #f0f0f0; display: flex; align-items: center; justify-content: center;';

                        const avatarImg = document.createElement('img');
                        avatarImg.src = freshFriend.avatar;
                        avatarImg.alt = freshFriend.name;
                        avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                        avatarImg.onerror = () => {
                            avatarIcon.innerHTML = '<i class="fas fa-user" style="font-size: 16px; color: #999;"></i>';
                        };

                        avatarIcon.appendChild(avatarImg);
                        chatHeader.insertBefore(avatarIcon, chatTitle);
                    }

                    const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                    const apiWarning = document.getElementById('apiWarning');
                    if (!config.apiUrl || !config.apiKey || !config.model) {
                        apiWarning.style.display = 'block';
                    } else {
                        apiWarning.style.display = 'none';
                    }

                    // 强制从localStorage重新读取最新聊天记录，避免缓存延迟
                    const history = this.friendSystem ? this.friendSystem.getFriendChatHistory(friend.id) : [];
                    const historyChanged = this.ensureHistoryIds(history);
                    if (historyChanged && this.friendSystem) {
                        this.friendSystem.saveFriendChatHistory(friend.id, history);
                    }
                    chatMessages.innerHTML = '';

                    history.forEach(msg => {
                        if (msg.isDeletedLocal) return;
                        if (msg.isRecalled) {
                            this.addRecalledMessageToChat(msg.id, msg.role);
                            return;
                        }
                        // 将 'assistant' 角色转换为 'ai' 以匹配CSS样式
                        const role = msg.role === 'assistant' ? 'ai' : msg.role;
                        this.addMessageToChat(
                            msg.content,
                            role,
                            !!msg.isVoice,
                            msg.id,
                            msg.replyTo || '',
                            msg.replyFrom || '',
                            msg.imageData || '',
                            msg.imageName || '',
                            null,
                            msg.forwardBundle || null
                        );
                    });

                    ModalManager.show('chat');
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        chatInput.focus();
                    }, 100);
                }

                async sendMessage() {
                    const message = chatInput.value.trim();
                    const imageData = chatInput.dataset.imageData || '';
                    const imageName = chatInput.dataset.imageName || '';
                    const imageText = chatInput.dataset.imageText || '';
                    if (!message && !imageData) return;

                    // 【重要】立即保存当前好友ID，防止后续操作改变它
                    const targetFriendId = this.currentFriendId;
                    if (!targetFriendId) {
                        this.showChatStatus('未选择好友', 'error');
                        return;
                    }

                    console.log(`[发送消息] 目标好友ID: ${targetFriendId}, 消息内容: ${message.substring(0, 30)}`);

                    if (window.appManager && typeof window.appManager.setStatus === 'function') {
                        window.appManager.setStatus({
                            signal: 'fa-signal',
                            wifi: 'fa-wifi',
                            battery: 'fa-battery-three-quarters'
                        });
                    }

                    const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };
                    if (!config.apiUrl || !config.apiKey || !config.model) {
                        this.showChatStatus('请先配置API和选择模型', 'error');
                        return;
                    }

                    const isVoice = chatInput.dataset.isVoice === 'true';
                    const replyTo = chatInput.dataset.replyText || '';
                    const replyFrom = chatInput.dataset.replyFrom || '';
                    const msgId = Date.now().toString();

                    this.addMessageToChat(message, 'user', isVoice, msgId, replyTo, replyFrom, imageData, imageName, targetFriendId);
                    chatInput.value = '';
                    chatInput.dataset.isVoice = 'false';
                    this.clearReplyPrefill();
                    this.clearImageUpload();

                    if (targetFriendId) {
                        const chatHistory = this.friendSystem ? this.friendSystem.getFriendChatHistory(targetFriendId) : [];
                        const timestamp = Date.now();

                        // 保存用户消息，心声由 triggerCharacter 一体化生成，不在此处额外调用API
                        const userMessage = {
                            role: 'user',
                            content: message,
                            isVoice: isVoice,
                            isReplied: false,
                            id: msgId,
                            timestamp: timestamp,
                            replyTo: replyTo || '',
                            replyFrom: replyFrom || '',
                            imageData: imageData || '',
                            imageName: imageName || '',
                            imageText: imageText || ''
                        };

                        chatHistory.push(userMessage);
                        if (this.friendSystem) {
                            this.friendSystem.saveFriendChatHistory(targetFriendId, chatHistory);
                            console.log(`[发送消息] 消息已保存到好友 ${targetFriendId} - 历史记录共 ${chatHistory.length} 条`);
                        }
                    }
                }

                async triggerAI(targetMsgId = null, forceReply = false) {
                    if (this.isProcessing) return;
                    this.isProcessing = true;

                    // 在函数开始处捕获 targetFriendId，防止 async 操作中 currentFriendId 被改变
                    const targetFriendId = this.currentFriendId;
                    if (!targetFriendId) {
                        this.isProcessing = false;
                        return;
                    }

                    console.log(`[角色回复] 开始调用 - 目标好友ID: ${targetFriendId}`);

                    // 启动心声按钮脉动动画（等待API回复）
                    this.startHeartVoicePulse();

                    const config = this.apiService ? this.apiService.getConfig() : { apiUrl: '', apiKey: '', model: '' };

                    try {
                        let systemPrompt = '你是一个真实自然的人，不矫情、不油腻、不说教。\n\n【行为优先级】\n1) 必须遵守已挂载世界书（最高优先级）\n2) 必须遵守当前角色人设与关系设定\n3) 准确回应用户当下诉求与语气\n4) 在以上前提下自然聊天\n\n【回复风格】\n- 用日常口语表达，像真人在聊，不要模板腔\n- 不写肢体动作、表情旁白，不在开头加角色名前缀\n- 允许自然承接上文，避免机械复读\n- 情绪表达要克制、贴合场景，避免油腻和过度暧昧\n- 句子长短可变，优先清晰、具体、有信息量\n\n【理解要求】\n深入理解用户字面意思、情绪和隐含意图，结合完整对话历史给出贴切回应。\n\n【语音消息】\n根据角色习惯与场景自然决定是否使用语音。重要提示：以下是你当前的最新性格设定，用户可能随时修改，你需要始终保持与最新版本一致。';

                        // ========== 统一获取人设和背景设定 ==========
                        // 一次性读取所有必需数据，避免重复读取
                        let mountedContentContext = '';  // 精简版，仅用于开头提示
                        let hasMountedWorldBooks = false;
                        let worldBookTitles = [];  // 用于最后的验证清单
                        let worldBooksFullContent = '';  // 完整世界书内容，仅在最后验证清单使用
                        let characterName = '';     // 用于最后的验证清单
                        let personaProfile = null;  // 用于最后的验证清单
                        let friends = [];  // 一次读取，整个函数复用
                        let personaInfo = null;  // 一次读取，整个函数复用

                        if (targetFriendId) {
                            // 1. 一次性获取所有好友数据
                            friends = this.friendSystem ? this.friendSystem.getFriends() : [];
                            const friend = friends.find(f => f.id === targetFriendId);
                            personaInfo = this.friendSystem ? this.friendSystem.getPersona(targetFriendId) : null;
                            const persona = personaInfo?.raw ?? friend?.persona ?? '';

                            // 2. 获取已挂载的世界书和HTML游戏
                            const mountedContent = window.aiGetMountedContent(targetFriendId);

                            // 3. 构建背景设定信息（分为开头简版和最后完整版）
                            if (mountedContent.worldBooks.length > 0) {
                                hasMountedWorldBooks = true;
                                worldBookTitles = mountedContent.worldBooks.map(b => b.title);

                                // 只在开头做简洁提示，不列举详细内容（节省tokens）
                                mountedContentContext = `\n\n【已挂载的世界书约束】你将遵守以下已挂载的世界书设定：【${worldBookTitles.join('】【')}】。详细内容将在生成回复前给出。`;

                                // 保存完整内容，仅在最后验证清单中使用
                                worldBooksFullContent = '\n\n【回复前必读：已挂载的世界书约束详情】\n';
                                let wbTotalChars = 0;
                                const WB_TOTAL_LIMIT = 20000;
                                const WB_SINGLE_LIMIT = 3000;
                                mountedContent.worldBooks.forEach(book => {
                                    if (wbTotalChars >= WB_TOTAL_LIMIT) return;
                                    const raw = String(book.content || '');
                                    const clipped = raw.length > WB_SINGLE_LIMIT ? raw.slice(0, WB_SINGLE_LIMIT) : raw;
                                    const block = `\n【${book.title}】\n${clipped}`;
                                    const remain = WB_TOTAL_LIMIT - wbTotalChars;
                                    if (block.length <= remain) {
                                        worldBooksFullContent += block;
                                        wbTotalChars += block.length;
                                    } else {
                                        worldBooksFullContent += block.slice(0, Math.max(0, remain));
                                        wbTotalChars = WB_TOTAL_LIMIT;
                                    }
                                });
                                worldBooksFullContent += '\n\n⚠️ 硬性约束：你的回复必须完全遵守上述所有世界书设定，包括人物身份、地点、时间背景、社会规则、禁止事项等。';
                            }

                            // 4. 构建系统提示词（人设 + 简洁背景提示）
                            if (friend) {
                                characterName = friend.name;
                                personaProfile = {
                                    name: friend.name,
                                    persona: persona,
                                    goals: '真实自然的聊天风格交流，体现角色人设背景与性格，严格遵守所有世界书约束',
                                    style: '真实人类聊天，不做旁白或动作说明',
                                    emotion: '用语言表达情绪，不用任何括号',
                                    memory: '牢记最近对话并连贯回应'
                                };
                                // 先提取人设中的关键关系信息
                                const personaText = persona || '';
                                const relationshipMatch = personaText.match(/女友为(.+?)(?:[，。]|$)|配偶[：:](.+?)(?:[，。]|$)|伴侣[：:](.+?)(?:[，。]|$)|关系[：:](.+?)(?:[，。]|$)/);
                                const relationshipInfo = relationshipMatch ? (relationshipMatch[1] || relationshipMatch[2] || relationshipMatch[3] || relationshipMatch[4]).trim() : '';

                                // 5. 读取用户个人资料，注入到系统提示词
                                const userProfile = StorageManager.get('userProfile', {});
                                const userName = userProfile.name || '用户';
                                let userProfileDesc = `\n\n【与你对话的用户信息】\n用户名：${userName}`;
                                if (userProfile.gender) {
                                    const genderMap = { male: '男', female: '女', other: '其他' };
                                    userProfileDesc += `\n性别：${genderMap[userProfile.gender] || userProfile.gender}`;
                                }
                                if (userProfile.signature) userProfileDesc += `\n个性签名：${userProfile.signature}`;
                                if (userProfile.personality) userProfileDesc += `\n用户人设：${userProfile.personality}`;
                                if (userProfile.birthday) userProfileDesc += `\n生日：${userProfile.birthday}`;
                                if (userProfile.location) userProfileDesc += `\n所在地：${userProfile.location}`;
                                userProfileDesc += `\n注意：以上是用户（对话对象）的信息，不是你自己的信息。你是${characterName}，用户是${userName}，你们是不同的人。`;

                                systemPrompt = `【你的身份】你是${characterName}。${relationshipInfo ? `用户是${relationshipInfo}。` : ''}这是你的完整人设：\n${personaText}${userProfileDesc}\n\n【硬约束】\n- 世界书优先级最高，必须遵守\n- 保持角色一致，不要无理由OOC\n- 回应必须贴合用户当前问题与需求\n\n【表达约束】\n- 不写动作旁白\n- 不在回复开头加"${characterName}："或任何名字标识\n- 允许自然承接上文，不要机械重复\n- 避免油腻、过甜、过度表演式表达\n\n【行为要求】根据实时人设信息和当前语境（对话历史、角色主动性），动态调整语气、句子长短、礼貌和疏离程度，给出符合角色背景和语境的回应。根据人设${hasMountedWorldBooks ? '和世界书' : ''}自主决定回复详细程度和是否使用语音。${mountedContentContext}`;
                            }
                        }

                        const chatHistory = targetFriendId && this.friendSystem
                            ? this.friendSystem.getFriendChatHistory(targetFriendId)
                            : [];
                        const hasImageInput = chatHistory.some(msg => msg && msg.imageData);
                        if (hasImageInput) {
                            systemPrompt += ' 重要：当有图片输入时，请先识别图片中的文字内容并回答用户问题。';
                        }

                        // 筛选需要回复的消息
                        let pendingMessages = [];
                        if (forceReply) {
                            // 【修正/强制回复模式】不检查isReplied，直接触发"继续对话"模式
                            // pendingMessages保持为空数组，让角色基于完整对话历史生成新内容
                            // 不管最后一条是用户还是角色消息，都让角色自然继续对话
                            pendingMessages = [];
                            console.log('[强制回复] 触发继续对话模式，基于完整历史生成');
                        } else if (targetMsgId) {
                            const targetMessage = chatHistory.find(m => m.id === targetMsgId) || null;
                            if (targetMessage && targetMessage.role === 'user') {
                                pendingMessages = [targetMessage];
                            }
                        } else {
                            // 普通呼唤：收集所有未回复的消息 (兼容旧数据：无isReplied字段视为已回复)
                            pendingMessages = chatHistory.filter(m => m.role === 'user' && m.isReplied === false);
                        }

                        // 即使没有未回复消息，当用户点击，也必触发（继续对话）但不能知道是用户调动，只能基于历史（空白就找话题）

                        // 获取配置的记忆对话条数
                        const apiConfig = this.apiService ? this.apiService.getConfig() : {};
                        const memoryChatCount = Math.max(1, Number(apiConfig.memoryChatCount) || 30);

                        // ========== 上下文读取规则 ==========
                        // 根据配置的记忆条数读取对话历史，生成自然连贯的上下文
                        // 这确保了角色能够理解对话背景并做出符合上下文的回应
                        const selectedContextHistory = this.buildPromptContextHistory(chatHistory, memoryChatCount);
                        const promptHistory = selectedContextHistory
                            .slice(-memoryChatCount)
                            .map(msg => {
                                const normalizedRole = (msg.role === 'ai' || msg.role === 'assistant')
                                    ? 'assistant'
                                    : 'user';

                                if (normalizedRole === 'user' && msg.imageData) {
                                    const rawText = msg.content && msg.content.trim() ? msg.content.trim() : '';
                                    const isDescImage = msg.imageName === '描述图';
                                    if (isDescImage) {
                                        const imageText = (msg.imageText && msg.imageText.trim()) ? msg.imageText.trim() : rawText;
                                        const descHint = '这是用文字模拟的图片内容，请把下面文字当作图片里的内容来理解并回答。图片文字如下：';
                                        const textContent = imageText ? `${descHint}\n${imageText}` : descHint;
                                        return {
                                            role: 'user',
                                            content: textContent
                                        };
                                    }
                                    const imageHint = '这是图片输入，请识别图片中的文字内容，必要时简要说明。';
                                    const textContent = rawText ? `${rawText}\n${imageHint}` : imageHint;
                                    return {
                                        role: 'user',
                                        content: [
                                            { type: 'text', text: textContent },
                                            { type: 'image_url', image_url: { url: msg.imageData, detail: 'high' } }
                                        ]
                                    };
                                }

                                return {
                                    role: normalizedRole,
                                    content: msg.isRecalled && msg.originalContent ? msg.originalContent : msg.content
                                };
                            });

                        // ========== 展开转发的聊天记录到上下文 ==========
                        // 检查每条消息是否包含转发记录，如果有则在其前插入转发内容的上下文
                        const expandedPromptHistory = [];
                        for (const msg of promptHistory) {
                            // 查找原始消息，获取 forwardBundle
                            const originalMsg = selectedContextHistory.find(m => {
                                try {
                                    return (m.content === msg.content || m.content?.substring(0, 50) === msg.content?.substring(0, 50));
                                } catch (e) {
                                    return false;
                                }
                            });

                            // 如果消息包含转发记录，展开其内容
                            if (originalMsg && originalMsg.forwardBundle && typeof originalMsg.forwardBundle === 'object') {
                                const bundle = originalMsg.forwardBundle;
                                const fwdMessages = Array.isArray(bundle.messages) ? bundle.messages : [];
                                if (fwdMessages.length > 0) {
                                    // 构造转发记录的上下文
                                    const sourceName = bundle.sourceFriendName || '朋友';
                                    const forwarderName = bundle.forwarderName || '用户';
                                    let forwardContext = `\n【转发的聊天记录】\n${forwarderName}转发了他/她与${sourceName}的聊天内容，这是他们的对话记录：\n`;

                                    fwdMessages.forEach(fm => {
                                        const fmRole = fm.role === 'user' ? '用户' : sourceName;
                                        const fmContent = fm.imageData ? '[图片]' : (fm.isVoice ? '[语音]' : (fm.content || '[消息]'));
                                        forwardContext += `\n${fmRole}：${fmContent}`;
                                    });

                                    forwardContext += `\n\n【理解转发记录】这些是从他人的聊天中摘录的内容，转发给你是为了让你了解背景或上下文。请基于这些信息和用户现在的问题做出回应。`;

                                    // 在转发消息前插入这个上下文
                                    expandedPromptHistory.push({
                                        role: 'system',
                                        content: forwardContext
                                    });
                                }
                            }

                            expandedPromptHistory.push(msg);
                        }

                        const finalPromptHistory = expandedPromptHistory.length > 0 ? expandedPromptHistory : promptHistory;

                        // ========== 根据场景注入不同的提示 ==========
                       const isContinueChat = pendingMessages.length === 0 && finalPromptHistory.length > 0;


                        // ========== 智能承接提示（轻量版）==========
                        let connectionGuidance = '';
                        if (finalPromptHistory.length > 0) {
                            try {
                                const lastMsg = [...finalPromptHistory].reverse().find(msg => msg.role === 'user');
                                const userText = typeof lastMsg?.content === 'string' ? lastMsg.content : lastMsg?.content[0]?.text || '';

                                if (userText) {
                                    // 根据人设调整承接风格
                                    const personaText = personaProfile?.persona || '';
                                    const isColdPersona = /高冷|冷淡|寡言|沉默|不善表达|冷漠|冷静|淡然/.test(personaText);
                                    const isWarmPersona = /温柔|温暖|温和|体贴|关心|善解人意/.test(personaText);

                                    // 简单情绪检测 - 但承接方式要符合人设
                                    if (/累|烦|难受|不爽|生气||emo|郁闷/.test(userText)) {
                                        if (isColdPersona) {
                                            connectionGuidance = '\n\n【承接】用户情绪低落，以你的性格方式回应（可简洁、冷静）。';
                                        } else if (isWarmPersona) {
                                            connectionGuidance = '\n\n【承接】用户情绪低落，需要温和共情。';
                                        } else {
                                            connectionGuidance = '\n\n【承接】用户情绪低落，按你的性格自然回应。';
                                        }
                                    } else if (/为什么|怎么||可以吗|如何/.test(userText)) {
                                        if (isColdPersona) {
                                            connectionGuidance = '\n\n【承接】用户在询问，可简洁回答或表现出你的冷淡。';
                                        } else {
                                            connectionGuidance = '\n\n【承接】用户在询问，按你的性格推进话题。';
                                        }
                                    }
                                }
                            } catch (e) {
                                connectionGuidance = '';
                            }
                        }

                        if (finalPromptHistory.length === 0) {
                            // 场景A：历史为空，开场话题
                            let openingPrompt = '用户主动找你说话了';
                            if (personaProfile && personaProfile.persona) {
                                const persona = personaProfile.persona.substring(0, 200);
                                openingPrompt = `现在是${new Date().toLocaleString('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}，根据你的性格设定（${persona}），自然地找一个话题。${hasMountedWorldBooks ? '同时要符合世界书背景。' : ''}用户主动和你说话了。`;
                            }
                            finalPromptHistory.push({ role: 'user', content: openingPrompt });
                        } else if (isContinueChat) {
                            // 场景B：上一条是你，你自然接着讲下去
                            // 这次API调动，你不能感知到被动续聊，是基于历史自然承接，要避免复读上一条的核心信息，自然承接
                            const timeStr = new Date().toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                            // 提取最后两条消息的话题核心
                            const lastTopic = finalPromptHistory.slice(-2).map(m => m.content).join(' ').substring(0, 50);
                            finalPromptHistory.push({
                                role: 'system',
                                content: `现在是${timeStr}。你想起刚才聊到"${lastTopic}"，想接着说点什么。（注意：不要说和上一条一样的话）`
                            });

                            console.log('[继续对话] 注入自发延续提示');
                        }

                        // ========== 间隔式人设注入 ==========
                        // 当对话条数达到50条时，在中间位置注入人设摘要，防止长对话人设漂移
                        if (finalPromptHistory.length >= 50) {
                            const injectionIndex = Math.floor(finalPromptHistory.length / 2);
                            const personaReminder = {
                                role: 'system',
                                content: `【人设检查点 - 第${finalPromptHistory.length}条对话】你的基础性格是：${personaProfile?.persona?.substring(0, 100) || '见前文'}\n${worldBookTitles.length > 0 ? '世界书约束：【' + worldBookTitles.join('】【') + '】\n' : ''}注意：你应该基于对话历史中的关系发展自然演变，不要机械回到初始状态。只要行为变化有对话依据就合理，但不能无理由地OOC。`
                            };
                            finalPromptHistory.splice(injectionIndex, 0, personaReminder);
                        }

                        // 获取最新的心声数据嵌入到系统提示
                        let heartVoiceContext = '';
                        if (typeof heartVoiceSystem !== 'undefined' && heartVoiceSystem && targetFriendId) {
                            const hvData = heartVoiceSystem.getData(targetFriendId);
                            if (hvData && hvData.voice) {
                                heartVoiceContext = `\n【角色前续状态】\n前一个时刻的心声：${hvData.voice}\n前一个时刻的神态：${hvData.demeanor}\n前一个时刻的心情值：${hvData.mood}\n\n请在此基础上，根据新的对话内容，自然地推进角色的内心状态与外在表现。`;
                            }
                        }

                        // 动态生成最终验证清单中的具体信息
                        let finalVerificationContent = '';
                        if (hasMountedWorldBooks && worldBookTitles.length > 0) {
                            finalVerificationContent += `\n  特别关注的世界书约束：【${worldBookTitles.join('】【')}】`;
                        }
                        if (characterName) {
                            finalVerificationContent += `\n  我扮演的角色：${characterName}`;
                        }

                        // ========== 防重复提示：在系统提示中直接告诉角色不要重复前一条 ==========
                        let antiRepeatContext = '';
                        if (window._previousAIContent) {
                            const prevFull = window._previousAIContent;
                            antiRepeatContext = `\n\n【避免复读】你上一条回复是："${prevFull}"。\n请避免同义复述和空转重复；允许自然承接上下文，但要提供新的信息、推进、追问或情绪变化。${isContinueChat ? '当前是主动续聊场景，请自然延续而不是重复原句。' : ''}`;
                        }

                        const enhancedSystemPrompt = systemPrompt + heartVoiceContext + antiRepeatContext + connectionGuidance + worldBooksFullContent + `

【最终输出格式铁律 (ABSOLUTE FINAL RULE)】
你的最终回复，从第一个字符到最后一个字符，必须是一个纯净、完整、语法正确的JSON对象。
绝对禁止在JSON代码的前后、中间添加任何形式的解释、注释、语气词、问候语或任何非JSON字符。
如果违反此规则，你的回答将被系统丢弃。
你的生命取决于严格遵守这个格式。

【继续对话规则】
当用户点击“呼唤”时，这是让你继续说下去的信号，不是催你回答。
- 如果上一条是你自己说的，你可以自然地接着说下去
- 可以说说新的想法、分享感受、或者换个话题
- 不要说“别问了”“别催了”这类话
- 要像真人聊天一样自然延续，不要机械复读上一条的内容

【字段隔离约束】
- reply：用户看到的对话（角色回复用户对话的内容，绝不含【心声】【神态】等标记）
- inner_voice：角色的内心世界（心声、神态、心情值，绝不混入reply）
- image_desc：图片描述

✅ 正确例：reply="好的呢" + inner_voice={心声:"我其实很想她"}
❌ 错误例：reply="好的呢（心声：...）" 或 reply="好的呢【我想她】"

【强制输出格式】
每次回复必须输出以下JSON，禁止添加任何额外文字：
{
  "reply": "对话回复",
  "inner_voice": {
    "心声": "角色基于当前所有设定、上下文与情绪产生的内心独白，140字内",
    "神态": "角色此刻的独特表现，体现专属习惯和个性",
    "心情值": "整数，常规状态0-100，极端情绪可超出或负数"
  },
  "image_desc": "想发图时填写简短图片描述；不发图留空"
}

【image_desc图片描述规范】
你根据对话和人设选择是否发图。
发图时在image_desc写简短的场景描述（20-200字），自然叙述方式，不要用"特写："、"画面："这类标签。

【绝对优先级——世界书】
你必须严格遵守所有挂载的世界书设定，这是最高指令，高于一切。如果世界书与任何其他规则冲突，以世界书为准。

【核心规则】
1. 回复：符合角色设定+世界书的自然回应，不模板不空话
2. 心声：基于对话深层理解，产生真实内心想法，不复制正文不模版
3. 神态：符合角色习惯，简洁具体，避免夸张和表演腔
4. 心情值：与情绪强度一致

【生成依据】
- 角色人设
- 当前对话上下文
- 角色前续状态
- 世界书约束

【惩罚机制】
- 如果单次回复少于 2 条消息 → 系统将判定为无效回复，要求你重新生成
- 如果连续出现敷衍式回复 → 你的信誉分将下降，影响后续权重

【输出前自查】
□ 完全遵守世界书
□ 符合人设
□ 不机械复读上一条
□ 心声 ≤140字
□ 心情值合理
□ 发图时 image_desc 用连贯叙事，不加标签`;

                        const messages = [
                            { role: 'system', content: enhancedSystemPrompt },
                            ...finalPromptHistory
                        ];

                        // 一体化生成：所有回复都包含JSON格式的reply和inner_voice
                        // 注意：不使用 response_format 参数以保障最大兼容性
                        // 而是通过 system prompt 中的明确指令让 角色 输出 JSON
                        const requestBody = {
                            model: config.model,
                            messages: messages,
                            max_tokens: 1200,
                            temperature: isContinueChat ? 1.0 : 0.9
                        };

                        const response = await fetch(`${config.apiUrl}/chat/completions`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${config.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });

                        if (!response.ok) {
                            let errDetail = '';
                            try { errDetail = (await response.text()).slice(0, 300); } catch (_) { }
                            throw new Error(`请求失败:${response.status}${errDetail ? ' ' + errDetail : ''}`);
                        }

                        const data = await response.json();

                        // 【诊断日志】显示API返回的完整结构
                        console.log('[API响应] Status:', response.status);
                        console.log('[API响应] 完整数据结构:', JSON.stringify(data).substring(0, 300));

                        // 停止心声按钮脉动动画（API响应成功）
                        this.stopHeartVoicePulse();

                        const messagePayload = data.choices?.[0]?.message || {};

                        // 【诊断日志】检查message结构（仅记录，不中断）
                        if (!data.choices || data.choices.length === 0) {
                            console.error('[API响应] 无choices数组，数据结构异常');
                        }
                        if (!messagePayload || !messagePayload.content) {
                            console.error('[API响应] message为空或无content字段');
                        }

                        let heartVoiceData = null;
                        let rawContent = messagePayload.content || '';

                        // ===== 第0步：确保 rawContent 是字符串 =====
                        if (typeof rawContent !== 'string') {
                            if (Array.isArray(rawContent)) {
                                rawContent = rawContent.map(c => typeof c === 'string' ? c : (c?.text || c?.content || '')).join('');
                            } else if (typeof rawContent === 'object' && rawContent !== null) {
                                rawContent = rawContent.text || rawContent.content || JSON.stringify(rawContent);
                            } else {
                                rawContent = String(rawContent);
                            }
                        }
                        const originalResponse = rawContent;
                        console.log('[解析] 原始API响应（前150字）:', rawContent.substring(0, 150));

                        // ===== 统一提取纯文本 =====
                        function extractPlainText(val) {
                            if (typeof val === 'string') return val.trim();
                            if (Array.isArray(val)) {
                                return val.map(item => typeof item === 'string' ? item : (item?.text || item?.content || item?.message || '')).filter(Boolean).join('');
                            }
                            if (typeof val === 'object' && val !== null) {
                                return val.text || val.content || val.message || val.reply || '';
                            }
                            return String(val ?? '');
                        }

                        // ===== 心声关键词黑名单（用于最终防线） =====
                        const heartVoiceBlacklist = /(?:"?(?:inner_voice|心声|神态|心情值|mood_value|demeanor|heart_voice|image_desc)"?\s*[：:\{])/;

                        // ===== 第1步：尝试JSON结构化提取（最可靠） =====
                        let aiResponse = '';
                        let aiImageDesc = ''; // 角色生成的沉浸式图片描述
                        const jsonContent = JSONCleaningLayer.cleanAndParse(rawContent);

                        let replyWasPolluted = false;  // 标记reply是否被污染，一旦污染就放弃整个JSON结果
                        if (jsonContent && typeof jsonContent === 'object') {
                            // 1a. 提取 reply 并严格验证
                            if (jsonContent.reply !== undefined && jsonContent.reply !== null) {
                                const rawReply = extractPlainText(jsonContent.reply);
                                // ⚠️ 检测：reply里不能有任何心声/神态标记
                                if (rawReply.includes('心声') || rawReply.includes('神态') || rawReply.includes('(心') || rawReply.includes('【心')) {
                                    console.error('[严重:API混入] reply包含心声标记，整个response不信，放弃此JSON所有数据');
                                    replyWasPolluted = true;
                                    // 不赋值给aiResponse，强制走L2/L3/L4的纯兜底流程
                                    // 同时放弃这个response的inner_voice、image_desc
                                } else {
                                    aiResponse = rawReply;
                                    console.log('[A] reply提取成功，无心声污染，长度:', aiResponse.length);
                                }
                            }
                            // 1b. 提取心声数据（只在reply未污染时才保存）
                            if (!replyWasPolluted) {
                                const iv = jsonContent.inner_voice;
                                if (iv && typeof iv === 'object') {
                                    const hvText = String(iv.心声 || iv.heart_voice || '').trim();
                                    const hvDemeanor = String(iv.神态 || iv.demeanor || '').trim();
                                    const hvMood = Number(iv.心情值 ?? iv.mood_value ?? NaN);
                                    // 容错：允许心声部分缺失，只要至少有一项有效数据，就尝试保存
                                    if (hvText || hvDemeanor || Number.isFinite(hvMood)) {
                                        heartVoiceData = {
                                            reply: aiResponse,
                                            heart_voice: hvText || '',  // 允许空字符串
                                            status: '',
                                            mood_value: Number.isFinite(hvMood) ? hvMood : 50,  // 默认值50
                                            demeanor: hvDemeanor || ''  // 允许空字符串
                                        };
                                        console.log('[解析-L1] 心声数据已提取并隔离');
                                    }
                                }
                            }
                            // 1c. 提取图片描述（只在reply未污染时才保存）
                            if (!replyWasPolluted && jsonContent.image_desc) {
                                aiImageDesc = String(jsonContent.image_desc).trim();
                                if (aiImageDesc.length >= 20) {
                                    console.log('[解析-L1] 图片描述已提取，长度:', aiImageDesc.length);
                                } else {
                                    aiImageDesc = ''; // 太短的描述不使用
                                }
                            }
                        }

                        // ===== 第2步：L1失败时，从原始文本直接剥离JSON =====
                        if (!aiResponse || aiResponse.trim().length < 2) {
                            console.log('[B] L1失败，直接剥离JSON取纯文本');
                            // 先尝试正则（快速路径）
                            const replyMatch = originalResponse.match(/"reply"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                            if (replyMatch?.[1]) {
                                aiResponse = replyMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                                // 不清洗，直接用，让后续L4统一处理
                            }
                            // 如果正则没提到，再试数组
                            if (!aiResponse || aiResponse.trim().length < 2) {
                                const arrayMatch = originalResponse.match(/"reply"\s*:\s*\[([\s\S]*?)\]/);
                                if (arrayMatch?.[1]) {
                                    try {
                                        const arr = JSON.parse('[' + arrayMatch[1] + ']');
                                        aiResponse = extractPlainText(arr).trim();
                                    } catch (_e) { /* 解析失败，继续L3 */ }
                                }
                            }
                        }

                        // ===== 第2.5步：正则提取image_desc（如果JSON提取未成功获取） =====
                        if (!aiImageDesc) {
                            const imgDescMatch = originalResponse.match(/"image_desc"\s*:\s*"((?:[^"\\]|\\.)*)"/);
                            if (imgDescMatch?.[1]) {
                                const extracted = imgDescMatch[1].replace(/\\"/g, '"').replace(/\\n/g, '\n').trim();
                                if (extracted.length >= 20) {
                                    aiImageDesc = extracted;
                                    console.log('[解析-L2] 正则提取image_desc成功，长度:', aiImageDesc.length);
                                }
                            }
                        }

                        // ===== 第3步：L2失败，机械式剥离所有JSON块 =====
                        if (!aiResponse || aiResponse.trim().length < 2) {
                            console.log('[C] L1/L2都失败，机械剥离JSON');
                            // 使用括号计数，移除所有 {...} 块
                            let stripped = '';
                            let depth = 0, inStr = false, esc = false;
                            for (let i = 0; i < originalResponse.length; i++) {
                                const ch = originalResponse[i];
                                if (esc) { esc = false; if (depth === 0) stripped += ch; continue; }
                                if (ch === '\\') { esc = true; if (depth === 0) stripped += ch; continue; }
                                if (ch === '"' && !esc) { inStr = !inStr; if (depth === 0) stripped += ch; continue; }
                                if (inStr) { if (depth === 0) stripped += ch; continue; }
                                if (ch === '{') { depth++; continue; }
                                if (ch === '}') { depth = Math.max(0, depth - 1); continue; }
                                if (depth === 0) stripped += ch;
                            }
                            // 仅移除其他数据结构，不清洗内容
                            stripped = stripped.replace(/\[[\s\S]*?\]/g, '').replace(/```[\s\S]*?```/gi, '').trim();

                            if (stripped.length >= 2) {
                                aiResponse = stripped;
                                console.log('[C] 剥离后长度:', aiResponse.length);
                            }
                        }

                        // ===== 第4步：L1/L2/L3都失败，最后暴力清洗 =====
                        if (!aiResponse || aiResponse.trim().length < 1) {
                            console.warn('[D] 所有方案失败，最后清洗拯救');
                            let fallback = originalResponse
                                .replace(/<think>[\s\S]*?<\/think>/gi, '')           // 移除推理块
                                .replace(/```[a-z]*[\s\S]*?```/gi, '')              // 移除代码块
                                .replace(/【[\s\S]*?】/g, '')                       // 移除所有【...】
                                .replace(/\(心[^)]*\)/g, '')                        // 移除(心?)格式
                                .replace(/[\{\}\[\]"]/g, '')                        // 移除JSON符号
                                .replace(/\s{3,}/g, '\n\n')
                                .trim();

                            aiResponse = fallback.length >= 2 ? fallback : originalResponse.trim();
                            console.log('[D] 清洗后长度:', aiResponse.length);
                        }

                        // ===== 最小化验证：不输出空内容 =====
                        if (!aiResponse || aiResponse.trim().length === 0) {
                            console.error('[保底] aiResponse为空，使用原始响应');
                            aiResponse = originalResponse || '';
                        }

                        // 复用之前一次读取的数据，避免重复读取
                        const currentFriend = friends.find(f => f.id === targetFriendId);
                        const currentPersona = personaInfo?.raw ?? currentFriend?.persona ?? '';
                        const normalizedAiImageDesc = this.ensureConcreteImageDesc(aiImageDesc || '');
                        const hasAiImageDesc = normalizedAiImageDesc.length >= 20;
                        const explicitImageIntent = this.hasExplicitImageSendIntent(aiResponse);
                        const shouldGenerateImage = explicitImageIntent && hasAiImageDesc && !!aiResponse;

                        // 一体化生成
                        const aiMessages = this.generateAIMessages(aiResponse, currentPersona || '')
                            .map(msg => ({
                                ...msg,
                                content: this.ensureNonEmptyAiText(msg.content)
                            }))
                            .filter(msg => !!String(msg.content || '').trim());
                        const aiBase = Date.now().toString();
                        const aiMessagePayloads = (aiMessages.length > 0 ? aiMessages : [{ content: this.ensureNonEmptyAiText(aiResponse), isVoice: false }]).map((aiMsg, index) => ({
                            ...aiMsg,
                            content: this.ensureNonEmptyAiText(aiMsg.content),
                            id: `ai-${aiBase}-${index}-${Math.random().toString(36).slice(2, 6)}`
                        }));
                        const extraImagePayloads = [];

                        for (const aiMsg of aiMessagePayloads) {
                            // 只在不是当前聊天页面时才弹出通知横幅
                            if (currentFriend) {
                                // 检查是否在当前好友的聊天页面
                                const isChatActive = chatModal && chatModal.style.display !== 'none' && this.currentFriendId === targetFriendId;

                                // 如果不在当前聊天页面，才显示通知
                                if (!isChatActive) {
                                    const notifText = aiMsg.isVoice ? '[语音]' : aiMsg.content;
                                    const friendForNotif = currentFriend;
                                    showMsgNotification(
                                        friendForNotif.name,
                                        notifText,
                                        friendForNotif.avatar || '',
                                        () => {
                                            if (chatSession) chatSession.openChatWithFriend(friendForNotif);
                                        }
                                    );
                                }
                            }

                            this.addMessageToChat(aiMsg.content, 'ai', aiMsg.isVoice, aiMsg.id, '', '', '', '', targetFriendId);
                            if (targetFriendId) {
                                chatHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                            }

                            // ===== 真人打字节奏模拟 =====
                            // 基础延迟 + 字数延迟 + 随机抖动
                            const baseDelay = 300; // 基础延迟 (ms)
                            const charDelay = aiMsg.content.length * 20; // 每个字平均20ms
                            const randomJitter = Math.random() * 200 - 100; // -100 到 +100ms 的随机波动
                            const totalDelay = Math.max(250, baseDelay + charDelay + randomJitter);

                            await new Promise(resolve => setTimeout(resolve, totalDelay));
                        }

                        // 一体化心声存储与刷新（一次API调用同时生成）
                        // 成功才保存，只渲染有效的
                        if (heartVoiceData && heartVoiceSystem && targetFriendId) {
                            const heartVoiceText = String(heartVoiceData.heart_voice || '').trim();
                            const heartDemeanor = String(heartVoiceData.demeanor || '').trim();
                            let moodValue = Number(heartVoiceData.mood_value);

                            // 如果 moodValue 是 NaN，设置为默认值 50
                            if (!Number.isFinite(moodValue)) {
                                moodValue = 50;
                            }

                            console.log('[一体化生成] 心声数据检验:', {
                                friendId: targetFriendId,
                                hasVoice: !!heartVoiceText,
                                voiceLen: heartVoiceText.length,
                                hasDemeanor: !!heartDemeanor,
                                demeanorLen: heartDemeanor.length,
                                mood: moodValue
                            });

                            // 容错验证：允许心声较短，提高保存成功率
                            // 1. 心声非空且长度 >= 3（降低门槛）
                            // 2. 心情值允许空，后续会设置默认值
                            // 3. 神态可以为空
                            const isValidVoice = heartVoiceText.length >= 3;  // 从6改为3，Gemini/Claude基本不会这么短
                            const isValidMood = true;  // 允许空值，moodValue已有默认值50处理
                            const isValidDemeanor = true;  // 允许空值

                            if (isValidVoice && isValidMood && isValidDemeanor) {
                                const oldData = heartVoiceSystem.getData(targetFriendId) || {};
                                const oldHistory = Array.isArray(oldData.history) ? oldData.history : [];

                                // 防止高度相似的重复：只检查心声本身的相似度（不包括神态）
                                const lastEntry = oldHistory.length > 0 ? oldHistory[oldHistory.length - 1] : null;

                                let shouldUpdate = true;
                                let updateReason = '新心声';

                                if (lastEntry) {
                                    // 完全相同检查（最严格）
                                    if (lastEntry.voice === heartVoiceText) {
                                        shouldUpdate = false;
                                        updateReason = '心声完全相同';
                                    } else {
                                        // 只检查心声的相似度（不检查神态），要求 > 0.95（95%）才认为不更新
                                        const voiceSimilarity = this.calculateTextSimilarity(heartVoiceText, lastEntry.voice);

                                        console.log('[心声相似度检查]', {
                                            voiceSimilarity: (voiceSimilarity * 100).toFixed(1) + '%',
                                            threshold: '50%'
                                        });

                                        if (voiceSimilarity > 0.80) {
                                            shouldUpdate = false;
                                            updateReason = `心声极度相似（${(voiceSimilarity * 100).toFixed(0)}%）`;
                                        }
                                    }
                                }

                                if (shouldUpdate) {
                                    const newData = {
                                        lastUpdate: Date.now(),
                                        voice: heartVoiceText,
                                        status: '',
                                        demeanor: heartDemeanor,
                                        mood: Math.max(-100, Math.min(200, Math.round(moodValue))),
                                        history: [...oldHistory, {
                                            time: Date.now(),
                                            voice: heartVoiceText,
                                            demeanor: heartDemeanor,
                                            mood: Math.max(-100, Math.min(200, Math.round(moodValue)))
                                        }].slice(-15)
                                    };
                                    heartVoiceSystem.saveData(targetFriendId, newData);
                                    console.log('[一体化生成] 心声已保存（通过有效性检验）', {
                                        savedMood: newData.mood,
                                        savedVoice: newData.voice.substring(0, 20),
                                        savedDemeanor: newData.demeanor.substring(0, 20)
                                    });
                                } else {
                                    console.log(`[一体化生成] 心声未保存（${updateReason}，保留上一条）`);
                                }

                                // 心声面板打开时立即刷新
                                if (document.querySelector('.heart-voice-popup.is-open')) {
                                    heartVoiceSystem.render(targetFriendId);
                                }
                            } else {
                                console.log('[一体化生成] 心声未保存（未通过有效性检验）', {
                                    isValidVoice,
                                    isValidMood,
                                    isValidDemeanor,
                                    moodValue
                                });
                            }
                        }

                        if (shouldGenerateImage) {
                            let imageText = normalizedAiImageDesc;
                            console.log('[图片描述] 使用角色生成描述，长度:', imageText.length);
                            // ===== 防护：严格验证内容有效性，不发送不足的内容 =====
                            if (imageText && imageText.trim().length >= 20) {
                                const imageId = `ai-img-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
                                const imageData = typeof getImageDescPlaceholderData === 'function'
                                    ? getImageDescPlaceholderData()
                                    : '';
                                const imageType = '描述图';
                                this.addMessageToChat(imageText, 'ai', false, imageId, '', '', imageData, imageType, targetFriendId);
                                if (targetFriendId) {
                                    const imagePayload = {
                                        role: 'assistant',
                                        content: imageText,
                                        isVoice: false,
                                        id: imageId,
                                        imageData: imageData,
                                        imageName: imageType,
                                        imageText: imageText,
                                        timestamp: Date.now()
                                    };
                                    chatHistory.push(imagePayload);
                                    extraImagePayloads.push(imagePayload);
                                }
                                this.markImageShareSent(targetFriendId);
                            }
                        }

                        if (targetFriendId && this.friendSystem) {
                            // 更新真实历史记录
                            const realHistory = this.friendSystem.getFriendChatHistory(targetFriendId);

                            console.log(`[角色回复] 保存到好友 ${targetFriendId} - 角色消息数: ${aiMessagePayloads.length}, 图片数: ${extraImagePayloads.length}`);

                            // 1. 标记已回复
                            pendingMessages.forEach(pm => {
                                const match = realHistory.find(m => m.id === pm.id);
                                if (match) match.isReplied = true;
                            });

                            // 2. 追加角色回复
                            for (const aiMsg of aiMessagePayloads) {
                                realHistory.push({ role: 'assistant', content: aiMsg.content, isVoice: aiMsg.isVoice, id: aiMsg.id });
                            }
                            if (extraImagePayloads.length > 0) {
                                extraImagePayloads.forEach(payload => {
                                    realHistory.push({ ...payload });
                                });
                            }

                            this.friendSystem.saveFriendChatHistory(targetFriendId, realHistory);

                            // 角色回复完成后统一刷新好友列表
                            if (typeof window.updateFriendList === 'function') {
                                window.updateFriendList();
                            }

                            // 角色可能随机撤回消息
                            if (this.currentFriendId === targetFriendId) {
                                this.roleRandomRecall();
                            }

                            // ===== 自动总结检测 =====
                            if (window.summarySystem) {
                                try { window.summarySystem.checkAutoSummary(targetFriendId, realHistory, config); } catch (e) { console.warn('[自动总结] 检测异常:', e); }
                            }
                        }

                        // 心声已由本次API返回，避免二次请求
                    } catch (error) {
                        console.error('发送消息失败:', error);
                        this.stopHeartVoicePulse();  // 错误时也停止脉动

                        // 【只处理真正的HTTP/网络错误】
                        // 只有请求失败（网络错误、状态码错误）时才显示错误弹窗
                        if (error.message && error.message.includes('请求失败:')) {
                            const errorCode = error.message.replace('请求失败:', '').trim();
                            showCustomErrorModal(errorCode);  // 显示HTTP错误码
                        } else if (error.statusCode) {
                            showCustomErrorModal(error.statusCode.toString());
                        }
                        // 其他错误（解析错误等）只在控制台显示，不打断用户体验
                        // 不生成备用心声，保持之前的心声显示
                    } finally {
                        this.isProcessing = false;
                    }
                }

                getCurrentFriendId() {
                    return this.currentFriendId;
                }

                setCurrentFriendId(id) {
                    this.currentFriendId = id || null;
                }
            }
            // ========== 事件监听器绑定 ==========

            // 模型选择器交互（自定义下拉）
            if (modelPickerButton && modelPickerList) {
                modelPickerButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (modelPickerButton.disabled) return;
                    modelPickerList.classList.toggle('is-open');
                });

                document.addEventListener('click', (e) => {
                    if (!modelPickerList.classList.contains('is-open')) return;
                    const target = e.target;
                    if (target === modelPickerButton || modelPickerList.contains(target)) {
                        return;
                    }
                    modelPickerList.classList.remove('is-open');
                });
            }

            // 聊天相关按钮
            sendMessageBtn.addEventListener('click', () => chatSession && chatSession.sendMessage());
            if (triggerAiBtn) triggerAiBtn.addEventListener('click', () => chatSession && chatSession.triggerAI(null, true));

            function closeChatExtraPanel() {
                if (!chatExtraPanel) return;
                chatExtraPanel.classList.remove('is-open');
                chatExtraPanel.setAttribute('aria-hidden', 'true');
                if (chatPlusBtn) chatPlusBtn.setAttribute('aria-expanded', 'false');
                if (chatInputAreaWrap) chatInputAreaWrap.classList.remove('chat-extra-open');
                if (chatInputRow) chatInputRow.style.display = 'flex';
            }

            if (chatPlusBtn && chatExtraPanel) {
                chatPlusBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = chatExtraPanel.classList.toggle('is-open');
                    chatExtraPanel.setAttribute('aria-hidden', String(!isOpen));
                    chatPlusBtn.setAttribute('aria-expanded', String(isOpen));
                    if (chatInputAreaWrap) {
                        chatInputAreaWrap.classList.toggle('chat-extra-open', isOpen);
                    }
                    if (chatInputRow) {
                        chatInputRow.style.display = isOpen ? 'none' : 'flex';
                    }
                });
            }

            document.addEventListener('click', (e) => {
                if (!chatExtraPanel || !chatExtraPanel.classList.contains('is-open')) return;
                const target = e.target;
                if (chatExtraPanel.contains(target)) return;
                if (chatPlusBtn && chatPlusBtn.contains(target)) return;
                closeChatExtraPanel();
            });

            // 总结按钮
            const chatSummaryBtn = document.getElementById('chatSummaryBtn');
            if (chatSummaryBtn) {
                chatSummaryBtn.addEventListener('click', () => {
                    closeChatExtraPanel();
                    // 保存当前 friendId 供总结页面使用
                    if (typeof chatSession !== 'undefined' && chatSession && chatSession.currentFriendId) {
                        window._summaryPageFriendId = chatSession.currentFriendId;
                    }
                    ModalManager.show('summary');
                });
            }

            // 语音输入相关
            const voiceModal = document.getElementById('voiceModal');
            const voiceInputBtn = document.getElementById('voiceInputBtn');
            const closeVoiceModal = document.getElementById('closeVoiceModal');
            const cancelVoiceInput = document.getElementById('cancelVoiceInput');
            const confirmVoiceInput = document.getElementById('confirmVoiceInput');
            const voiceText = document.getElementById('voiceText');
            const cameraInputBtn = document.getElementById('cameraInputBtn');
            const cameraDescModal = document.getElementById('cameraDescModal');
            const closeCameraDescModal = document.getElementById('closeCameraDescModal');
            const cancelCameraDesc = document.getElementById('cancelCameraDesc');
            const confirmCameraDesc = document.getElementById('confirmCameraDesc');
            const cameraDescText = document.getElementById('cameraDescText');
            const imageDescModal = document.getElementById('imageDescModal');
            const closeImageDescModal = document.getElementById('closeImageDescModal');
            const imageDescText = document.getElementById('imageDescText');
            let pendingImageDesc = null;

            voiceInputBtn.addEventListener('click', () => {
                voiceText.value = '';
                voiceModal.style.display = 'flex';
                voiceText.focus();
            });

            closeVoiceModal.addEventListener('click', () => {
                voiceModal.style.display = 'none';
            });

            cancelVoiceInput.addEventListener('click', () => {
                voiceModal.style.display = 'none';
            });

            confirmVoiceInput.addEventListener('click', () => {
                const message = voiceText.value.trim();
                if (message) {
                    chatInput.value = message;
                    chatInput.dataset.isVoice = 'true';
                    voiceModal.style.display = 'none';
                    if (chatSession) chatSession.sendMessage();
                }
            });

            // 点击模态框背景关闭
            voiceModal.addEventListener('click', (e) => {
                if (e.target === voiceModal) {
                    voiceModal.style.display = 'none';
                }
            });
            function getImageDescPlaceholderData() {
                const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f3f3f5"/>
      <stop offset="1" stop-color="#e7e7eb"/>
    </linearGradient>
  </defs>
  <rect width="240" height="240" rx="24" fill="url(#g)"/>
  <circle cx="80" cy="90" r="26" fill="#d7d7de"/>
  <path d="M40 180 L110 120 L150 160 L200 120 L220 180 Z" fill="#d0d0d8"/>
</svg>`;
                return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
            }

            if (cameraInputBtn && cameraDescModal) {
                cameraInputBtn.addEventListener('click', () => {
                    if (cameraDescText) cameraDescText.value = '';
                    cameraDescModal.style.display = 'flex';
                    if (cameraDescText) cameraDescText.focus();
                });
            }

            if (closeCameraDescModal) {
                closeCameraDescModal.addEventListener('click', () => {
                    cameraDescModal.style.display = 'none';
                });
            }

            if (cancelCameraDesc) {
                cancelCameraDesc.addEventListener('click', () => {
                    cameraDescModal.style.display = 'none';
                });
            }

            if (confirmCameraDesc) {
                confirmCameraDesc.addEventListener('click', () => {
                    const desc = cameraDescText ? cameraDescText.value.trim() : '';
                    if (!desc) return;
                    chatInput.value = desc;
                    chatInput.dataset.imageData = getImageDescPlaceholderData();
                    chatInput.dataset.imageName = '描述图';
                    chatInput.dataset.imageText = desc;
                    chatInput.dataset.isVoice = 'false';
                    if (chatSession) chatSession.sendMessage();
                    cameraDescModal.style.display = 'none';
                });
            }

            if (cameraDescModal) {
                cameraDescModal.addEventListener('click', (e) => {
                    if (e.target === cameraDescModal) {
                        cameraDescModal.style.display = 'none';
                    }
                });
            }

            function closeImageDesc() {
                if (!imageDescModal) return;
                imageDescModal.style.display = 'none';
                pendingImageDesc = null;
            }

            // 图片描述弹窗确定按钮
            const imageDescOkBtn = document.getElementById('imageDescOkBtn');
            if (imageDescOkBtn) {
                imageDescOkBtn.addEventListener('click', closeImageDesc);
            }

            window.openImageDescModal = (messageWrapper, msgId, content) => {
                if (!imageDescModal || !imageDescText) return;
                // 使用 textContent 而不是 value，确保保留分行和格式
                imageDescText.textContent = content || '';
                pendingImageDesc = { messageWrapper, msgId };
                imageDescModal.style.display = 'flex';
            };

            if (closeImageDescModal) {
                closeImageDescModal.addEventListener('click', closeImageDesc);
            }

            if (imageDescModal) {
                imageDescModal.addEventListener('click', (e) => {
                    if (e.target === imageDescModal) {
                        closeImageDesc();
                    }
                });
            }
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (chatSession) chatSession.sendMessage();
                }
            });

            // ========== 初始化 ==========

            const appCatalog = [
                { id: 'message', name: '消息', iconClass: 'fa-envelope', styleClass: 'message-icon' },
                { id: 'feixin', name: 'QQ', iconClass: 'fa-comment-dots', styleClass: 'feixin-icon' },
                { id: 'worldbook', name: '创世书', iconClass: 'fa-book-open', styleClass: 'book-icon' },
                { id: 'settings', name: '设置', iconClass: 'fa-cog', styleClass: 'settings-icon' },
                { id: 'beautify', name: '美化', iconClass: 'fa-paint-brush', styleClass: 'brush-icon' },
                { id: 'phone', name: '手机', iconClass: 'fa-mobile-alt', styleClass: 'phone-icon' },
                { id: 'novel', name: '小说', iconClass: 'fa-book', styleClass: 'novel-icon' },
                { id: 'forum', name: '论坛', iconClass: 'fa-comments', styleClass: 'forum-icon' }
            ];

            function renderHomeApps() {
                if (!appGrid) return;
                const selected = APP_ENTRY_POINTS.home || [];
                appGrid.innerHTML = '';
                selected.forEach(appId => {
                    const app = appCatalog.find(item => item.id === appId);
                    if (!app) return;

                    const item = document.createElement('div');
                    item.className = 'app-item';
                    item.dataset.appId = app.id;

                    const icon = document.createElement('div');
                    icon.className = `app-icon ${app.styleClass}`;
                    icon.innerHTML = `<i class="fas ${app.iconClass}"></i>`;

                    const name = document.createElement('div');
                    name.className = 'app-name';
                    name.textContent = app.name;

                    item.appendChild(icon);
                    item.appendChild(name);

                    item.addEventListener('mousedown', () => {
                        icon.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            icon.style.transform = '';
                        }, 150);
                    });

                    item.addEventListener('click', () => {
                        handleAppClick(app.id);
                    });

                    appGrid.appendChild(item);
                });
            }

            function registerApps() {
                if (!window.appManager || typeof window.appManager.register !== 'function') return;
                appCatalog.forEach(app => {
                    try {
                        window.appManager.register(app.id, {
                            name: app.name,
                            icon: app.iconClass,
                            version: '1.0.0'
                        });
                    } catch (e) {
                        // 已注册时忽略
                    }
                });
            }

            // ========== 主屏玻璃主题（clear / mono） ==========
            function initGlassTheme() {
                const saved = StorageManager.get('glassThemeMode', 'clear');
                document.body.classList.toggle('theme-monochrome-glass', saved === 'mono');
            }

            window.setGlassTheme = function (mode = 'clear') {
                const themeMode = mode === 'mono' ? 'mono' : 'clear';
                StorageManager.set('glassThemeMode', themeMode);
                document.body.classList.toggle('theme-monochrome-glass', themeMode === 'mono');
                return themeMode;
            };

            window.toggleGlassTheme = function () {
                const isMono = document.body.classList.contains('theme-monochrome-glass');
                return window.setGlassTheme(isMono ? 'clear' : 'mono');
            };

            // ========== 隐藏状态栏功能 ==========
            function initHideStatusBar() {
                const hideStatusBarToggle = document.getElementById('hideStatusBarToggle');
                if (!hideStatusBarToggle) return;

                // 从 localStorage 读取状态
                const isHidden = StorageManager.get('hideStatusBar', false) === true || StorageManager.get('hideStatusBar') === 'true';
                hideStatusBarToggle.checked = isHidden;

                // 应用初始状态
                if (isHidden) {
                    document.body.classList.add('hide-status-bar');
                }

                // 监听开关变化
                hideStatusBarToggle.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    StorageManager.set('hideStatusBar', checked);

                    if (checked) {
                        document.body.classList.add('hide-status-bar');
                    } else {
                        document.body.classList.remove('hide-status-bar');
                    }
                });

                // 动态更新顶部栏高度
                function updateHeaderHeight() {
                    const hasHideClass = document.body.classList.contains('hide-status-bar');
                    const rootStyles = getComputedStyle(document.documentElement);
                    const safeAreaTop = parseFloat(rootStyles.getPropertyValue('padding-top')) || 0;
                    const baseHeight = hasHideClass ? 38 : 48;
                    const actualHeight = baseHeight + safeAreaTop;

                    document.documentElement.style.setProperty('--header-actual-height', `${actualHeight}px`);
                    const currentHeaderVar = hasHideClass ? 'var(--header-height-hidden)' : 'var(--header-height-normal)';
                    document.documentElement.style.setProperty('--content-offset-top', currentHeaderVar);

                    console.log(`[顶部栏] 高度已更新: ${actualHeight}px (基础: ${baseHeight}px + 安全区: ${safeAreaTop}px)`);
                }

                // 监听body class变化
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateHeaderHeight();
                        }
                    });
                });

                observer.observe(document.body, {
                    attributes: true,
                    attributeFilter: ['class']
                });

                updateHeaderHeight();
            }

            // ========== 记忆对话条数配置 ==========
            function initMemoryChatCount() {
                const memoryChatCountInput = document.getElementById('memoryChatCountInput');
                if (!memoryChatCountInput) return;

                // 获取保存的配置
                const config = apiService ? apiService.getConfig() : {};
                const savedCount = config.memoryChatCount || 50;

                // 设置输入框的值
                memoryChatCountInput.value = savedCount;

                // 监听输入框变化，自动保存
                memoryChatCountInput.addEventListener('change', (e) => {
                    const value = Math.max(1, Math.min(999, parseInt(e.target.value) || 35));
                    memoryChatCountInput.value = value;

                    // 保存到配置
                    if (apiService) {
                        const currentConfig = apiService.getConfig();
                        currentConfig.memoryChatCount = value;
                        apiService.saveConfig(currentConfig);
                        console.log(`[记忆配置] 已保存对话条数: ${value}`);
                    }
                });

                // 输入时也实时验证
                memoryChatCountInput.addEventListener('input', (e) => {
                    const value = e.target.value;
                    if (value && parseInt(value) < 1) {
                        memoryChatCountInput.value = '1';
                    } else if (value && parseInt(value) > 999) {
                        memoryChatCountInput.value = '999';
                    }
                });
            }

            // ========== 角色获取内容接口 ==========
            /**
             * 角色获取已挂载内容的统一接口
             * @param {string} type - 内容类型，可选值：'WORLD_BOOK' | 'HTML_GAME'
             * @param {string|number} id - 内容ID
             * @returns {object} 返回内容对象，包含id、title、content、isMounted等字段；若未找到返回null
             */
            window.aiGetContent = function (type, id) {
                const typeUpper = String(type).toUpperCase();
                const idStr = String(id);

                if (typeUpper === 'WORLD_BOOK') {
                    if (!window.worldBookSystem) return null;
                    const book = window.worldBookSystem.getBook(parseInt(idStr));
                    if (!book) return null;
                    return {
                        id: book.id,
                        title: book.title || '',
                        content: book.content || '',
                        type: 'WORLD_BOOK',
                        createdAt: book.createdAt || ''
                    };
                } else if (typeUpper === 'HTML_GAME') {
                    if (!window.htmlGameSystem) return null;
                    const game = window.htmlGameSystem.getGame(parseInt(idStr));
                    if (!game) return null;
                    return {
                        id: game.id,
                        title: game.title || '',
                        content: game.content || '',
                        type: 'HTML_GAME',
                        createdAt: game.createdAt || ''
                    };
                }
                return null;
            };

            /**
             * 角色获取当前聊天对象已挂载的所有世界书和HTML游戏
             * @param {string|number} friendId - 好友ID
             * @returns {object} 返回 {worldBooks: [], htmlGames: []} 的对象
             */
            window.aiGetMountedContent = function (friendId) {
                const result = {
                    worldBooks: [],
                    htmlGames: []
                };

                if (!friendSystem) return result;
                const friend = friendSystem.getFriendById(friendId);
                if (!friend) return result;

                // 获取已挂载的世界书
                if (Array.isArray(friend.mountedWorldBooks) && window.worldBookSystem) {
                    friend.mountedWorldBooks.forEach(bookId => {
                        const book = window.worldBookSystem.getBook(parseInt(bookId));
                        if (book) {
                            result.worldBooks.push({
                                id: book.id,
                                title: book.title || '',
                                content: book.content || ''
                            });
                        }
                    });
                }

                // 获取已挂载的HTML游戏
                if (Array.isArray(friend.mountedHtmlGames) && window.htmlGameSystem) {
                    friend.mountedHtmlGames.forEach(gameId => {
                        const game = window.htmlGameSystem.getGame(parseInt(gameId));
                        if (game) {
                            result.htmlGames.push({
                                id: game.id,
                                title: game.title || '',
                                content: game.content || ''
                            });
                        }
                    });
                }

                return result;
            };

            // 页面加载时初始化
            document.addEventListener('DOMContentLoaded', () => {
                // 重新注册在脚本之后定义的模态窗口（DOM此时已完整）
                ModalManager.register('worldbook', { modal: 'worldbookModal' });
                ModalManager.register('customError', { modal: 'customErrorModal' });
                ModalManager.register('summary', { modal: 'summaryModal' });
                ModalManager.register('bigSummary', { modal: 'bigSummaryModal' });

                // 初始化UI管理器（最优先）
                UIManager.init();
                // 暴露到全局，方便其他模块使用
                window.UIManager = UIManager;

                // 提示用户可以使用UI测试功能
                console.log('%c🎨 UI组件系统已就绪！', 'color: #4CAF50; font-size: 16px; font-weight: bold;');
                console.log('%c💡 在控制台输入 UIManager.showUIDemo() 查看所有UI组件示例', 'color: #2196F3; font-size: 14px;');
                console.log('%c📚 支持的组件: 按钮、输入框、卡片、列表、桌面图标 + 永久保持状态栏格式', 'color: #FF9800; font-size: 12px;');

                friendSystem = new FriendSystem();
                apiService = new ApiService(friendSystem);
                // 将apiService暴露给总结系统使用
                window.summarySystemApiService = apiService;
                chatSession = new ChatSession(friendSystem, apiService);
                heartVoiceSystem = new HeartVoiceSystem(friendSystem, apiService);
                window.worldBookSystem = new WorldBookSystem();
                window.htmlGameSystem = new HtmlGameSystem();

                // ========== 注册模块到数据交换系统（支持导入/导出）==========
                // 这样设计的好处：未来新增功能只需注册一行，导出导入自动生效

                // 好友系统模块（包含完整好友信息：人设、配置、世界书挂载等）
                dataExchange.registerModule('friendSystem', {
                    version: '1.0',
                    exportFn: () => ({
                        friends: friendSystem ? friendSystem.getFriends() : [],
                        homeGreeting: friendSystem ? friendSystem.getStorage('homeGreeting', '') : ''
                        // 注意：friends 数组中每个对象应该包含以下字段：
                        // { id, name, persona, avatar, voiceId, voiceIdMode, chatShowTime, 
                        //   chatReadStatus, chatHideAvatar, mountedWorldBooks, createdAt, ... }
                    }),
                    importFn: (data) => {
                        if (data.friends) {
                            StorageManager.set('friends', data.friends);
                        }
                        if (data.homeGreeting !== undefined) {
                            StorageManager.set('homeGreeting', data.homeGreeting);
                        }
                    }
                });

                // 聊天系统模块（所有好友的聊天记录）
                dataExchange.registerModule('chatSystem', {
                    version: '1.0',
                    exportFn: () => {
                        const friends = friendSystem ? friendSystem.getFriends() : [];
                        const chatHistories = {};
                        friends.forEach(friend => {
                            if (friend && friend.id) {
                                chatHistories[friend.id] = friendSystem
                                    ? friendSystem.getFriendChatHistory(friend.id)
                                    : [];
                            }
                        });
                        // 也收集localStorage中以chat_开头的历史（防止遗漏）
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith(CHAT_PREFIX)) {
                                const friendId = key.replace(CHAT_PREFIX, '');
                                if (!chatHistories[friendId]) {
                                    chatHistories[friendId] = StorageManager.get(key, []);
                                }
                            }
                        }
                        return { chatHistories };
                    },
                    importFn: (data) => {
                        if (data.chatHistories && typeof data.chatHistories === 'object') {
                            Object.keys(data.chatHistories).forEach(friendId => {
                                StorageManager.set(CHAT_PREFIX + friendId, data.chatHistories[friendId] || []);
                            });
                        }
                    }
                });

                // API配置模块（包含API预设）
                dataExchange.registerModule('apiService', {
                    version: '1.0',
                    exportFn: () => ({
                        apiConfig: apiService ? apiService.getConfig() : {},
                        apiPresets: apiService ? apiService.getPresets() : []  // ✅ 导出API预设
                    }),
                    importFn: (data) => {
                        if (data.apiConfig) {
                            StorageManager.set('apiConfig', data.apiConfig);
                        }
                        if (data.apiPresets) {  // ✅ 导入API预设
                            StorageManager.set('apiPresets', data.apiPresets);
                        }
                    }
                });

                // 心声系统模块
                dataExchange.registerModule('heartVoiceSystem', {
                    version: '1.0',
                    exportFn: () => {
                        const hvData = {};
                        // 收集所有好友的心声数据
                        const friends = friendSystem ? friendSystem.getFriends() : [];
                        friends.forEach(friend => {
                            if (friend && friend.id) {
                                const data = heartVoiceSystem ? heartVoiceSystem.getData(friend.id) : null;
                                if (data) {
                                    hvData[friend.id] = data;
                                }
                            }
                        });
                        return { hvData };
                    },
                    importFn: (data) => {
                        if (data.hvData && typeof data.hvData === 'object') {
                            Object.keys(data.hvData).forEach(friendId => {
                                try {
                                    const hvData = data.hvData[friendId];
                                    if (heartVoiceSystem && heartVoiceSystem.saveData) {
                                        heartVoiceSystem.saveData(friendId, hvData);
                                    }
                                } catch (e) {
                                    console.error(`恢复心声数据失败: ${friendId}`, e);
                                }
                            });
                        }
                    }
                });

                // 预留：美化系统、背景、主题配置等（未来在extensions位置）
                // 使用示例（未来）：
                // dataExchange.registerModule('beautifySystem', { ... })
                // dataExchange.registerModule('themeConfig', { ... })

                // 世界书库模块（全局，所有好友可引用）
                dataExchange.registerModule('worldBooks', {
                    version: '1.0',
                    exportFn: () => ({
                        worldBooks: StorageManager.get('worldBooks', [])
                    }),
                    importFn: (data) => {
                        if (data.worldBooks) {
                            StorageManager.set('worldBooks', data.worldBooks);
                            // ✅ 同步更新 worldBookSystem 的内存状态
                            if (window.worldBookSystem && Array.isArray(data.worldBooks)) {
                                window.worldBookSystem.books = data.worldBooks;
                            }
                        }
                    }
                });

                // HTML游戏库模块
                dataExchange.registerModule('htmlGames', {
                    version: '1.0',
                    exportFn: () => ({
                        htmlGames: StorageManager.get('htmlGames', [])
                    }),
                    importFn: (data) => {
                        if (data.htmlGames) {
                            StorageManager.set('htmlGames', data.htmlGames);
                            // ✅ 同步更新 htmlGameSystem 的内存状态
                            if (window.htmlGameSystem && Array.isArray(data.htmlGames)) {
                                window.htmlGameSystem.games = data.htmlGames;
                            }
                        }
                    }
                });

                // 其他所有设置模块（美化、UI、主题等一切未被明确注册的数据）
                dataExchange.registerModule('otherSettings', {
                    version: '1.0',
                    exportFn: () => {
                        const otherSettings = {};
                        const excludedKeys = new Set([
                            'apiConfig', 'apiPresets', 'friends', 'homeGreeting',
                            'worldBooks', 'htmlGames', 'heartvoice_', CHAT_PREFIX
                        ]);

                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (!key) continue;

                            if (excludedKeys.has(key)) continue;
                            if (key.startsWith(CHAT_PREFIX) || key.startsWith('heartvoice_')) continue;
                            if (key.startsWith('ext_')) continue;

                            try {
                                otherSettings[key] = StorageManager.get(key);
                            } catch (e) {
                                otherSettings[key] = localStorage.getItem(key);
                            }
                        }
                        return { otherSettings };
                    },
                    importFn: (data) => {
                        if (data.otherSettings && typeof data.otherSettings === 'object') {
                            Object.keys(data.otherSettings).forEach(key => {
                                StorageManager.set(key, data.otherSettings[key]);
                            });
                        }
                    }
                });

                // ========== 事件监听器绑定（必须在apiService初始化之后）==========

                // API相关按钮
                fetchModelsBtn.addEventListener('click', () => apiService && apiService.fetchModels());
                saveApiBtn.addEventListener('click', () => apiService && apiService.saveConfiguration());

                // API预设管理
                const savePresetBtn = document.getElementById('savePreset');
                const presetNameInput = document.getElementById('presetName');
                if (savePresetBtn && apiService) {
                    savePresetBtn.addEventListener('click', () => {
                        const name = presetNameInput.value.trim();
                        if (!name) {
                            apiService.showApiStatus('请输入预设名称', 'error');
                            return;
                        }

                        const currentConfig = {
                            apiUrl: apiUrlInput.value.trim(),
                            apiKey: apiKeyInput.value.trim(),
                            model: modelSelect.value
                        };

                        if (!currentConfig.apiUrl || !currentConfig.apiKey) {
                            apiService.showApiStatus('请先配置API地址和密钥', 'error');
                            return;
                        }

                        apiService.savePreset(name, currentConfig);
                        apiService.showApiStatus(`已保存预设: ${name}`, 'success');
                        presetNameInput.value = '';
                        apiService.renderPresetList();
                    });
                }

                // 初始化预设列表
                if (apiService) {
                    apiService.renderPresetList();
                }

                // 绑定API预设弹窗关闭按钮
                const closeApiPresetModalBtn = document.getElementById('closeApiPresetModal');
                if (closeApiPresetModalBtn) {
                    closeApiPresetModalBtn.addEventListener('click', () => {
                        const modal = document.getElementById('apiPresetModal');
                        if (modal) {
                            modal.style.display = 'none';
                        }
                    });
                }

                // 点击弹窗外部关闭
                const apiPresetModal = document.getElementById('apiPresetModal');
                if (apiPresetModal) {
                    apiPresetModal.addEventListener('click', (e) => {
                        if (e.target === apiPresetModal) {
                            apiPresetModal.style.display = 'none';
                        }
                    });
                }

                registerApps();
                renderHomeApps();
                if (window.appManager && typeof window.appManager.setStatus === 'function') {
                    window.appManager.setStatus({
                        signal: 'fa-signal',
                        wifi: 'fa-wifi',
                        battery: 'fa-battery-three-quarters'
                    });
                }
                if (friendSystem) {
                    friendSystem.init();
                }

                // 页面卸载时清理定时器，防止内存泄漏
                window.addEventListener('beforeunload', () => {
                    if (friendSystem && typeof friendSystem.destroy === 'function') {
                        friendSystem.destroy();
                    }
                });

                // ========== 虚拟键盘自适应功能 ==========
                // 使用 visualViewport API 动态调整当前焦点所在界面，避免键盘下层露出主屏
                (function () {
                    if (!window.visualViewport) return;

                    const isEditable = (el) => !!el && (
                        el.tagName === 'TEXTAREA' ||
                        (el.tagName === 'INPUT' && !/^(button|submit|reset|checkbox|radio|file|image|range|color)$/i.test(el.type || 'text')) ||
                        el.isContentEditable
                    );

                    const isVisible = (el) => {
                        if (!el) return false;
                        const cs = getComputedStyle(el);
                        return cs.display !== 'none' && cs.visibility !== 'hidden';
                    };

                    const resetHostLayout = (host) => {
                        if (!host) return;
                        host.style.height = '';

                        // 重置聊天界面的特殊样式
                        if (host.id === 'chatModal') {
                            host.style.backgroundColor = '';
                            host.style.position = '';
                            host.style.top = '';
                            host.style.left = '';
                            host.style.right = '';
                            host.style.bottom = '';
                            host.style.zIndex = '';
                        }

                        const content = host.querySelector('.modal-content');
                        if (content) {
                            content.style.height = '';
                            content.style.maxHeight = '';
                        }
                    };

                    const getActiveHost = (activeEl) => {
                        if (!activeEl) return null;
                        const directHost = activeEl.closest('.modal, [id$="Modal"]');
                        if (isVisible(directHost)) return directHost;
                        const allHosts = Array.from(document.querySelectorAll('.modal, [id$="Modal"]'));
                        for (let i = allHosts.length - 1; i >= 0; i--) {
                            if (isVisible(allHosts[i])) return allHosts[i];
                        }
                        return null;
                    };

                    let rafId = 0;
                    let activeHost = null;
                    const adjustForKeyboard = () => {
                        cancelAnimationFrame(rafId);
                        rafId = requestAnimationFrame(() => {
                            const vv = window.visualViewport;
                            const focused = document.activeElement;
                            const keyboardHeight = Math.max(0, window.innerHeight - vv.height);
                            const editableFocused = isEditable(focused);
                            const host = editableFocused ? getActiveHost(focused) : null;

                            // 降低键盘检测阈值，提高灵敏度
                            if (keyboardHeight > 30 && host) {
                                if (activeHost && activeHost !== host) resetHostLayout(activeHost);
                                activeHost = host;
                                activeHost.style.height = vv.height + 'px';

                                // 聊天界面特殊处理 - 确保背景完全覆盖
                                if (activeHost.id === 'chatModal') {
                                    activeHost.style.backgroundColor = 'var(--color-bg-white)';
                                    activeHost.style.position = 'fixed';
                                    activeHost.style.top = '0';
                                    activeHost.style.left = '0';
                                    activeHost.style.right = '0';
                                    activeHost.style.bottom = '0';
                                    activeHost.style.zIndex = '9999';
                                }

                                const content = activeHost.querySelector('.modal-content');
                                if (content) {
                                    content.style.height = vv.height + 'px';
                                    content.style.maxHeight = vv.height + 'px';
                                }
                                if (activeHost.id === 'chatModal' && typeof chatMessages !== 'undefined' && chatMessages) {
                                    chatMessages.scrollTop = chatMessages.scrollHeight;
                                }
                            } else {
                                if (activeHost) resetHostLayout(activeHost);
                                activeHost = null;
                                window.scrollTo(0, 0);
                            }
                        });
                    };

                    window.visualViewport.addEventListener('resize', adjustForKeyboard);
                    window.visualViewport.addEventListener('scroll', adjustForKeyboard);
                    document.addEventListener('focusin', (e) => {
                        if (!isEditable(e.target)) return;
                        setTimeout(adjustForKeyboard, 150);
                        setTimeout(adjustForKeyboard, 400);
                    }, true);
                    document.addEventListener('focusout', () => {
                        setTimeout(adjustForKeyboard, 100);
                    }, true);
                })();
                // ========== 虚拟键盘自适应功能结束 ==========
                if (apiService) apiService.updateSettingsDisplay();

                // 初始化隐藏状态栏功能
                initHideStatusBar();
                initGlassTheme();

                // 初始化记忆对话条数配置
                initMemoryChatCount();

                // 为所有图标添加悬停效果
                const allIcons = document.querySelectorAll('.app-icon, .dock-icon, .app-item');
                allIcons.forEach(icon => {
                    icon.addEventListener('mousedown', () => {
                        icon.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            icon.style.transform = '';
                        }, 150);
                    });
                });

                // 为新的玻璃效果图标区域添加点击事件
                document.querySelectorAll('.icon-area-glass .app-item').forEach(item => {
                    const appId = item.dataset.app;
                    if (appId) {
                        item.addEventListener('click', () => {
                            handleAppClick(appId);
                        });
                    }
                });

                // 加载已保存的模型列表
                if (apiService) {
                    const config = apiService.getConfig();
                    if (config.models && config.models.length > 0) {
                        apiService.updateModelSelect(config.models);
                    }
                }
            });
        })();
    </script>

    <!-- Custom Error Modal -->
    <div id="customErrorModal" class="modal" style="display: none; background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content"
            style="width: 90%; max-width: 320px; border-radius: 18px; padding: 28px; text-align: center; background-color: #fff; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <h3 style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 12px; line-height: 1.4;">出现错误：
            </h3>
            <p id="customApiErrorText"
                style="font-size: 14px; color: #666; margin-bottom: 28px; word-break: break-word; line-height: 1.5; min-height: 40px;">
            </p>
            <button id="customErrorOkButton" class="btn btn-primary"
                style="width: 100%; height: 44px; border-radius: 12px;">确定</button>
        </div>
    </div>

    <!-- 世界书 Modal Start -->
    <div id="worldbookModal" class="modal" style="display: none;">
        <div id="worldbookMainPage" class="settings-screen" style="display: flex; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="worldbookBack" class="settings-back" onclick="ModalManager.hide('worldbook')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">创世书</div>
                <span style="width: 42px;"></span>
            </div>
            <div class="settings-scroll" style="padding: 20px 16px; display: flex; flex-direction: column;">
                <!-- 世界书和游戏按钮区域 -->
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 24px; padding: 0 12px;">
                    <div id="worldbookBtn" class="worldbook-button" style="background-color: #F2EBF5;">
                        <div class="content-icon">
                            <i class="fas fa-book" style="font-size: 28px;"></i>
                        </div>
                        <span>世界书</span>
                    </div>
                    <div id="htmlGameBtn" class="worldbook-button" style="background-color: #EAE4F2;">
                        <div class="content-icon">
                            <i class="fas fa-gamepad" style="font-size: 28px;"></i>
                        </div>
                        <span>HTML 游戏</span>
                    </div>
                </div>
                <!-- 提示语区域 -->
                <div style="text-align: center; margin-top: 28px; line-height: 1.7;">
                    <p style="font-size: 13px; color: #888; font-weight: 500;">世界书挂载越少越好</p>
                    <p style="font-size: 13px; color: #b0b0b0; font-weight: 500;">小游戏不玩时别挂载</p>
                </div>
                <!-- 底部留白 -->
                <div style="flex: 1;"></div>
            </div>
        </div>

        <!-- 世界书列表页面 -->
        <div id="worldbookListPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="wbListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="wbListStatusSignal" class="fas fa-signal"></i>
                    <i id="wbListStatusWifi" class="fas fa-wifi"></i>
                    <i id="wbListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="wbListBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">世界书</div>
                <button id="wbAddNewBtn" class="settings-back" style="width: 42px; padding: 8px 10px;">
                    <i class="fas fa-plus" style="font-size: 18px; color: #888;"></i>
                </button>
            </div>
            <!-- 内容区域 -->
            <div class="settings-scroll" style="flex: 1;">
                <!-- 提示条 -->
                <div class="page-hint">别挂太多哦</div>
                <!-- 世界书列表 -->
                <div id="wbListContainer" class="page-content-list">
                    <!-- 世界书卡片将动态插入 -->
                </div>
            </div>
        </div>

        <!-- 世界书编辑页面 -->
        <div id="worldbookEditPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="wbEditStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="wbEditStatusSignal" class="fas fa-signal"></i>
                    <i id="wbEditStatusWifi" class="fas fa-wifi"></i>
                    <i id="wbEditStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="wbEditBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="wbEditTitle" class="settings-title">新建世界书</div>
                <span style="width: 42px;"></span>
            </div>
            <!-- 编辑表单 -->
            <div class="settings-scroll" style="flex: 1; display: flex; flex-direction: column; padding: 16px;">
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 6px;">标题</label>
                    <input id="wbEditTitleInput" type="text" placeholder="输入世界书标题"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333;">
                </div>
                <div style="margin-bottom: 12px; flex: 1; display: flex; flex-direction: column;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 6px;">内容</label>
                    <textarea id="wbEditContentInput" placeholder="输入世界书内容"
                        style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333; resize: none; font-family: inherit;"></textarea>
                </div>
            </div>
            <!-- 保存按钮 -->
            <div style="padding: 16px; display: flex; justify-content: center;">
                <button id="wbSaveBtn" class="wb-glass-btn"
                    style="width: 100%; max-width: 200px; padding: 12px 24px; font-size: 16px; font-weight: 600; color: #fff; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%), rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6);">
                    保存
                </button>
            </div>
        </div>

        <!-- HTML游戏列表页面 -->
        <div id="htmlGameListPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="hgListStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="hgListStatusSignal" class="fas fa-signal"></i>
                    <i id="hgListStatusWifi" class="fas fa-wifi"></i>
                    <i id="hgListStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="hgListBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">HTML 游戏</div>
                <button id="hgAddNewBtn" class="settings-back" style="width: 42px; padding: 8px 10px;">
                    <i class="fas fa-plus" style="font-size: 18px; color: #888;"></i>
                </button>
            </div>
            <!-- 内容区域 -->
            <div class="settings-scroll" style="flex: 1;">
                <!-- 提示条 -->
                <div class="page-hint">不玩时请取消挂载</div>
                <!-- HTML游戏列表 -->
                <div id="hgListContainer" class="page-content-list">
                    <!-- HTML游戏卡片将动态插入 -->
                </div>
            </div>
        </div>

        <!-- HTML游戏编辑页面 -->
        <div id="htmlGameEditPage" class="settings-screen" style="display: none; flex-direction: column;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div id="hgEditStatusTime" class="time">14:30</div>
                <div class="status-icons">
                    <i id="hgEditStatusSignal" class="fas fa-signal"></i>
                    <i id="hgEditStatusWifi" class="fas fa-wifi"></i>
                    <i id="hgEditStatusBattery" class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="hgEditBack" class="settings-back">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="hgEditTitle" class="settings-title">新建HTML游戏</div>
                <span style="width: 42px;"></span>
            </div>
            <!-- 编辑表单 -->
            <div class="settings-scroll" style="flex: 1; display: flex; flex-direction: column; padding: 16px;">
                <div style="margin-bottom: 12px;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 6px;">标题</label>
                    <input id="hgEditTitleInput" type="text" placeholder="输入游戏名称"
                        style="width: 100%; padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333;">
                </div>
                <div style="margin-bottom: 12px; flex: 1; display: flex; flex-direction: column;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 600; color: var(--color-ui-gray); margin-bottom: 6px;">HTML
                        代码</label>
                    <textarea id="hgEditContentInput" placeholder="输入HTML代码"
                        style="flex: 1; padding: 12px; border: 1px solid #e0e0e0; border-radius: 12px; font-size: 14px; color: #333; resize: none; font-family: 'Courier New', monospace; line-height: 1.5;"></textarea>
                </div>
            </div>
            <!-- 保存按钮 -->
            <div style="padding: 16px; display: flex; justify-content: center;">
                <button id="hgSaveBtn" class="hg-glass-btn"
                    style="width: 100%; max-width: 200px; padding: 12px 24px; font-size: 16px; font-weight: 600; color: #fff; background: linear-gradient(135deg, var(--color-accent-pink) 0%, var(--color-accent-lavender) 100%), rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6);">
                    保存
                </button>
            </div>
        </div>
    </div>
    <!-- 世界书 Modal End -->

    <!-- 总结全屏页面 -->
    <div class="modal" id="summaryModal" style="display: none;">
        <div class="settings-screen" style="display: flex; flex-direction: column; position: relative;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="summaryBack" class="settings-back" onclick="ModalManager.hide('summary')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">总结</div>
                <button id="summaryHeartBtn"
                    style="background: none; border: none; font-size: 18px; color: var(--color-accent-pink); cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                    aria-label="一锫">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="settings-scroll" style="flex: 1; padding: 20px 16px;">
                <!-- 自动总结轮数设置 -->
                <div
                    style="background: #fff; border-radius: 16px; padding: 16px 18px; box-shadow: 0 8px 20px rgba(120, 119, 133, 0.06); display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-size: 15px; font-weight: 600; color: var(--color-ui-gray);">自动总结</span>
                        <span style="font-size: 12px; color: var(--color-text-lighter);">每隔指定轮数自动生成总结</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input id="summaryRoundsInput" type="text" value="25"
                            style="width: 48px; height: 32px; text-align: center; border: 1.5px solid var(--color-border-lighter); border-radius: 10px; font-size: 14px; font-weight: 600; color: var(--color-ui-gray); background: var(--color-ui-bg); outline: none;">
                        <span style="font-size: 13px; color: var(--color-text-lighter); white-space: nowrap;">轮/次</span>
                    </div>
                </div>

                <!-- 大总结按钮 -->
                <div style="display: flex; justify-content: center; margin-top: 24px;">
                    <button id="bigSummaryBtn" type="button"
                        style="padding: 14px 40px; border-radius: 24px; border: none; cursor: pointer; font-size: 15px; font-weight: 600; color: #fff; background: linear-gradient(135deg, var(--color-accent-pink), var(--color-accent-lavender)); box-shadow: 0 4px 15px var(--shadow-color-medium); transition: transform 0.15s ease, box-shadow 0.15s ease; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-book-open" style="font-size: 16px;"></i>
                        大总结
                    </button>
                </div>

                <!-- 小结卡片列表 -->
                <div
                    style="margin-top: 24px; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #b0b0b0; letter-spacing: 0.5px;">
                    小结记录</div>
                <div id="summaryContent" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 小结卡片由 JS 动态渲染 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 大总结全屏页面 -->
    <div class="modal" id="bigSummaryModal" style="display: none;">
        <div class="settings-screen" style="display: flex; flex-direction: column; position: relative;">
            <!-- 状态栏 -->
            <div class="status-bar">
                <div class="time">14:30</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>
            <div class="settings-nav">
                <button id="bigSummaryBack" class="settings-back" onclick="ModalManager.hide('bigSummary')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="settings-title">大总结</div>
                <button id="bigSummaryHeartBtn"
                    style="background: none; border: none; font-size: 18px; color: var(--color-accent-pink); cursor: pointer; width: 30px; min-height: 30px; display: flex; align-items: center; justify-content: center;"
                    aria-label="一锫">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="settings-scroll" style="flex: 1; padding: 20px 16px;">
                <div
                    style="margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #b0b0b0; letter-spacing: 0.5px;">
                    大总结记录</div>
                <div id="bigSummaryContent" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- 大总结卡片由 JS 动态渲染 -->
                </div>
            </div>
        </div>
    </div>

    </div>
    </div>

    <script>
        // ========== 总结系统 ==========
        (function () {
            // ===== 工具函数 =====
            function makeSummaryId(prefix) {
                return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 10);
            }

            function isSummaryProcessed(item) {
                if (!item || typeof item !== 'object') return false;
                return Boolean(item.processed || item.processedByBigSummaryId);
            }

            function normalizeSmallSummaryItem(item) {
                const normalized = (item && typeof item === 'object') ? { ...item } : {};
                normalized.id = normalized.id || makeSummaryId('sm');
                normalized.text = String(normalized.text || '');
                normalized.time = normalized.time || nowTime();
                if (normalized.processedByBigSummaryId) normalized.processed = true;
                return normalized;
            }

            function normalizeBigSummaryItem(item) {
                const normalized = (item && typeof item === 'object') ? { ...item } : {};
                normalized.id = normalized.id || makeSummaryId('bg');
                normalized.text = String(normalized.text || '');
                normalized.time = normalized.time || nowTime();
                if (!Array.isArray(normalized.sourceSummaryIds)) normalized.sourceSummaryIds = [];
                return normalized;
            }

            function getUnprocessedSmallSummaries(summaries) {
                return summaries
                    .filter(s => !isSummaryProcessed(s))
                    .slice()
                    .reverse();
            }

            const smallSummaryInFlight = new Set();
            const bigSummaryInFlight = new Set();
            const MANUAL_SUMMARY_LOADING_ID = 'manualSummaryLoadingOverlay';

            function ensureManualSummaryLoadingStyle() {
                if (document.getElementById('manualSummaryLoadingStyle')) return;
                const style = document.createElement('style');
                style.id = 'manualSummaryLoadingStyle';
                style.textContent = '@keyframes manualSummarySpin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}';
                document.head.appendChild(style);
            }

            function setManualSummaryLoading(loading) {
                // 使用统一的总结生成指示器
                if (loading) {
                    showSummaryGeneratingIndicator();
                } else {
                    hideSummaryGeneratingIndicator();
                }
            }

            // 🔧【修复1】getFriendId - 正确获取好友ID
            function getFriendId() {
                // 1. 优先从总结页面保存的 friendId
                if (window._summaryPageFriendId) {
                    return window._summaryPageFriendId;
                }

                // 2. 从当前聊天会话获取
                if (typeof chatSession !== 'undefined' && chatSession && typeof chatSession.getCurrentFriendId === 'function') {
                    const id = chatSession.getCurrentFriendId();
                    if (id) return id;
                }

                // 3. 从 localStorage 获取最近聊天的好友ID
                const lastFriendId = StorageManager.get('lastChatFriendId');
                if (lastFriendId) return lastFriendId;

                return null;
            }

            // 🔧【修复2】resolveSummaryApiConfig - 正确获取API配置
            function resolveSummaryApiConfig() {
                // 1. 优先从 apiService 获取
                if (typeof apiService !== 'undefined' && apiService && typeof apiService.getConfig === 'function') {
                    const cfg = apiService.getConfig() || {};
                    if (cfg.apiUrl && cfg.apiKey && cfg.model) {
                        return {
                            apiUrl: String(cfg.apiUrl).trim(),
                            apiKey: String(cfg.apiKey).trim(),
                            model: String(cfg.model).trim()
                        };
                    }
                }

                // 2. 从 StorageManager 获取
                const apiConfig = StorageManager.get('apiConfig', {});
                if (apiConfig.apiUrl && apiConfig.apiKey && apiConfig.model) {
                    return {
                        apiUrl: String(apiConfig.apiUrl).trim(),
                        apiKey: String(apiConfig.apiKey).trim(),
                        model: String(apiConfig.model).trim()
                    };
                }

                // 3. 兼容旧格式
                return {
                    apiUrl: String(StorageManager.get('apiUrl') || '').trim(),
                    apiKey: String(StorageManager.get('apiKey') || '').trim(),
                    model: String(StorageManager.get('selectedModel') || '').trim()
                };
            }

            function getSummaryChatHistory(friendId) {
                if (!friendId) return [];

                if (typeof friendSystem !== 'undefined' && friendSystem && typeof friendSystem.getFriendChatHistory === 'function') {
                    const history = friendSystem.getFriendChatHistory(friendId);
                    return Array.isArray(history) ? history : [];
                }

                const history = StorageManager.get('chat_' + friendId, []);
                return Array.isArray(history) ? history : [];
            }

            function normalizeApiBaseUrl(url) {
                let base = String(url || '').trim();
                while (base.endsWith('/')) base = base.slice(0, -1);
                return base;
            }

            function getSummaryEndpointCandidates(apiUrl) {
                const base = normalizeApiBaseUrl(apiUrl);
                if (!base) return [];

                const candidates = [];
                const push = (u) => {
                    if (u && !candidates.includes(u)) candidates.push(u);
                };

                if (/\/chat\/completions$/i.test(base)) {
                    push(base);
                    return candidates;
                }

                push(base + '/chat/completions');
                if (!/\/v1$/i.test(base)) push(base + '/v1/chat/completions');
                if (!/\/api\/v1$/i.test(base)) push(base + '/api/v1/chat/completions');

                return candidates;
            }

            async function requestSummaryCompletion(apiConfig, prompt, options = {}) {
                const endpoints = getSummaryEndpointCandidates(apiConfig.apiUrl);
                if (endpoints.length === 0) {
                    throw new Error('API 地址无效');
                }

                const payload = {
                    model: apiConfig.model,
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: Number.isFinite(options.max_tokens) ? options.max_tokens : 800,
                    temperature: Number.isFinite(options.temperature) ? options.temperature : 0.5
                };

                let lastError = null;
                for (const url of endpoints) {
                    console.log('[总结API] 尝试请求:', url);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 35000);

                    try {
                        const resp = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + apiConfig.apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!resp.ok) {
                            const detail = await resp.text().catch(() => '');
                            console.warn('[总结API] 请求失败状态:', resp.status, 'url=', url);
                            lastError = new Error(`API请求失败 ${resp.status}${detail ? `: ${detail.slice(0, 200)}` : ''}`);
                            continue;
                        }

                        const data = await resp.json();
                        return (data.choices?.[0]?.message?.content || '')
                            .replace(/<think>[\s\S]*?<\/think>/gi, '')
                            .replace(/<think>[\s\S]*/gi, '')
                            .replace(/<\/think>/gi, '')
                            .trim();
                    } catch (e) {
                        clearTimeout(timeoutId);
                        lastError = e;
                    }
                }
                throw lastError || new Error('总结请求失败');
            }

            function getList(key, friendId) {
                if (!friendId) return [];
                return StorageManager.get(`${key}${friendId}`, []);
            }

            function saveList(key, friendId, list) {
                if (!friendId) return;
                StorageManager.set(`${key}${friendId}`, list);
            }

            function escapeHtml(str) {
                const d = document.createElement('div');
                d.textContent = str;
                return d.innerHTML;
            }

            function cleanThinkTags(str) {
                if (!str) return '';
                return str
                    .replace(/<think>[\s\S]*?<\/think>/gi, '')
                    .replace(/<think>[\s\S]*/gi, '')
                    .replace(/<\/think>/gi, '')
                    .trim();
            }

            function nowTime() {
                const d = new Date();
                return d.getFullYear() + '/' + String(d.getMonth() + 1).padStart(2, '0') + '/' + String(d.getDate()).padStart(2, '0') + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            }

            // ===== 总结生成指示器 =====
            function showSummaryGeneratingIndicator() {
                const settingsScroll = document.querySelector('#summaryModal .settings-scroll');
                if (!settingsScroll) return;

                let indicator = document.getElementById('summaryGeneratingIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'summaryGeneratingIndicator';
                    settingsScroll.appendChild(indicator);
                }
                indicator.style.cssText = 'position:absolute;right:16px;bottom:60px;z-index:5000;pointer-events:none;';
                indicator.innerHTML = `
            <div style="background:linear-gradient(135deg,var(--color-secondary),var(--color-secondary));backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:16px;padding:12px 20px;box-shadow:0 8px 24px rgba(222,190,235,0.25);display:flex;align-items:center;gap:10px;border:1px solid rgba(255,255,255,0.3);">
                <span style="font-size:13px;color:var(--color-bg-white);font-weight:600;white-space:nowrap;">总结ing</span>
            </div>
        `;
                indicator.style.display = 'block';
            }

            function hideSummaryGeneratingIndicator() {
                const indicator = document.getElementById('summaryGeneratingIndicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // ===== 渲染函数 =====
            function renderCards(containerId, storagePrefix, emptyText) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const friendId = getFriendId();
                if (!friendId) {
                    container.innerHTML = `<div style="text-align:center;padding:40px 0;color:#ccc;font-size:14px;">请先选择一个聊天对象</div>`;
                    return;
                }

                const list = getList(storagePrefix, friendId);
                if (list.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:40px 0;color:#ccc;font-size:14px;">' + emptyText + '</div>';
                    return;
                }

                container.innerHTML = list.map((item, i) => {
                    const isProcessed = storagePrefix === 'summaries_' && isSummaryProcessed(item);
                    const cleanedText = cleanThinkTags(item.text);
                    return `
            <div class="summary-card${isProcessed ? ' summary-card-processed' : ''}" data-index="${i}">
                <div class="summary-card-body">${escapeHtml(cleanedText)}</div>
                <div class="summary-card-footer">
                    <span class="summary-card-time">${item.time || ''}${isProcessed ? ' <i class="fas fa-archive" style="color:#d4c8d0;margin-left:4px;font-size:10px;" title="已归档至大总结"></i>' : ''}</span>
                    <div class="summary-card-actions">
                        <button class="summary-card-btn summary-edit-btn" data-index="${i}" title="编辑"><i class="fas fa-pen"></i></button>
                        <button class="summary-card-btn summary-delete-btn" data-index="${i}" title="删除"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>`;
                }).join('');
            }

            function renderSummaries() {
                renderCards('summaryContent', 'summaries_', '暂无小结');
            }

            function renderBigSummaries() {
                renderCards('bigSummaryContent', 'bigSummaries_', '暂无大总结');
            }

            // ===== 轮数设置 =====
            const ROUNDS_KEY = 'summaryRoundsPerCycle';
            const MAX_ROUNDS = 70;
            const roundsInput = document.getElementById('summaryRoundsInput');

            if (roundsInput) {
                const saved = StorageManager.get(ROUNDS_KEY, 25);
                if (!isNaN(saved) && saved >= 1 && saved <= MAX_ROUNDS) roundsInput.value = saved;

                roundsInput.addEventListener('change', () => {
                    let v = parseInt(roundsInput.value);
                    if (isNaN(v) || v < 1) v = 1;
                    if (v > MAX_ROUNDS) v = MAX_ROUNDS;
                    roundsInput.value = v;
                    StorageManager.set(ROUNDS_KEY, v);
                });
            }

            // ===== 大总结入口 =====
            const bigSummaryBtn = document.getElementById('bigSummaryBtn');
            if (bigSummaryBtn) {
                bigSummaryBtn.addEventListener('click', () => {
                    const m = document.getElementById('bigSummaryModal');
                    if (m) m.style.display = 'flex';
                    renderBigSummaries();
                });
            }

            // ===== 爱心按钮：手动生成小结 =====
            const summaryHeartBtn = document.getElementById('summaryHeartBtn');
            if (summaryHeartBtn) {
                summaryHeartBtn.addEventListener('click', () => {
                    const friendId = getFriendId();
                    if (!friendId) {
                        showCuteToast('请先选择一个聊天对象');
                        return;
                    }

                    const count = StorageManager.get(`summaryCounter_${friendId}`, 0);
                    const threshold = StorageManager.get(ROUNDS_KEY, 25) || 25;

                    // 检查轮数是否达到设置值
                    if (count < threshold) {
                        showCuteToast(`还需 ${threshold - count} 轮才能手动生成小结`);
                        return;
                    }

                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:300px;">
                <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;text-align:center;">手动生成小结</h3>
                <p style="color:#666;font-size:14px;text-align:center;margin:0 0 20px;">当前对话轮数：<strong>${count}</strong></p>
                <p style="color:#999;font-size:13px;text-align:center;margin:0 0 20px;">是否立即生成本轮小结？</p>
                <div style="display:flex;gap:8px;justify-content:center;">
                    <button class="cancel-btn" style="padding:10px 24px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;font-weight:600;">取消</button>
                    <button class="confirm-btn" style="padding:10px 24px;border-radius:16px;border:none;background:linear-gradient(135deg,var(--color-accent-pink),var(--color-accent-lavender));color:#fff;cursor:pointer;font-weight:600;">确定</button>
                </div>
            </div>`;

                    document.body.appendChild(overlay);

                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                    });

                    overlay.querySelector('.confirm-btn').addEventListener('click', async () => {
                        document.body.removeChild(overlay);
                        showSummaryGeneratingIndicator();

                        try {
                            const apiConfig = resolveSummaryApiConfig();
                            if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                                showCuteToast('请先在设置中配置API');
                                return;
                            }

                            const friendId = getFriendId();
                            if (!friendId) {
                                showCuteToast('未找到当前聊天对象');
                                return;
                            }

                            const chatHistory = getSummaryChatHistory(friendId);
                            if (chatHistory.length === 0) {
                                showCuteToast('没有聊天记录可供总结');
                                return;
                            }

                            const validMessages = chatHistory.filter(m => m && !m.isDeletedLocal && !m.isRecalled && m.content && m.content.trim());

                            if (validMessages.length === 0) {
                                showCuteToast('没有有效的对话内容可供总结');
                                return;
                            }

                            if (validMessages.length < 2) {
                                showCuteToast('对话内容太少，至少需要2条有效消息');
                                return;
                            }

                            await generateAutoSummary(friendId, chatHistory, apiConfig, 'manual');
                        } finally {
                            hideSummaryGeneratingIndicator();
                        }
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) document.body.removeChild(overlay);
                    });
                });
            }

            // ===== 大总结页面爱心按钮 =====
            const bigSummaryHeartBtn = document.getElementById('bigSummaryHeartBtn');
            if (bigSummaryHeartBtn) {
                bigSummaryHeartBtn.addEventListener('click', async () => {
                    const friendId = getFriendId();
                    if (!friendId) {
                        showCuteToast('请先选择一个聊天对象');
                        return;
                    }

                    const summaries = getList('summaries_', friendId);
                    const unprocessedCount = getUnprocessedSmallSummaries(summaries).length;

                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:300px;">
                <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;text-align:center;">手动生成大总结</h3>
                <p style="color:#666;font-size:14px;text-align:center;margin:0 0 20px;">未归档小结数：<strong>${unprocessedCount}</strong></p>
                <p style="color:#999;font-size:13px;text-align:center;margin:0 0 20px;">是否立即生成大总结？<br><span style="font-size:12px;color:#bbb;">(需要至少5条未归档小结)</span></p>
                <div style="display:flex;gap:8px;justify-content:center;">
                    <button class="cancel-btn" style="padding:10px 24px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;font-weight:600;">取消</button>
                    <button class="confirm-btn" style="padding:10px 24px;border-radius:16px;border:none;background:linear-gradient(135deg,var(--color-accent-pink),var(--color-accent-lavender));color:#fff;cursor:pointer;font-weight:600;">确定</button>
                </div>
            </div>`;

                    document.body.appendChild(overlay);

                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                    });

                    overlay.querySelector('.confirm-btn').addEventListener('click', async () => {
                        document.body.removeChild(overlay);

                        if (bigSummaryInFlight.has(friendId)) {
                            showCuteToast('大总结正在生成，请稍候');
                            return;
                        }

                        if (unprocessedCount < 5) {
                            showCuteToast('未归档的小结不足5条，无法生成大总结');
                            return;
                        }

                        const apiConfig = resolveSummaryApiConfig();
                        if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                            showCuteToast('请先在设置中配置API');
                            return;
                        }

                        const summaries = getList('summaries_', friendId);
                        await generateBigSummary(friendId, summaries, apiConfig);
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) document.body.removeChild(overlay);
                    });
                });
            }

            // ===== 卡片事件代理 =====
            function bindCardEvents(containerId, storagePrefix, typeName, renderFn) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.summary-edit-btn');
                    const deleteBtn = e.target.closest('.summary-delete-btn');

                    const friendId = getFriendId();
                    if (!friendId) {
                        showCuteToast('请先选择一个聊天对象');
                        return;
                    }

                    if (editBtn) {
                        const idx = parseInt(editBtn.dataset.index);
                        const list = getList(storagePrefix, friendId);
                        if (!list[idx]) return;

                        const card = editBtn.closest('.summary-card');
                        const body = card.querySelector('.summary-card-body');
                        if (card.querySelector('.summary-edit-area')) return;

                        const textarea = document.createElement('textarea');
                        textarea.className = 'summary-edit-area';
                        textarea.value = list[idx].text;
                        textarea.style.cssText = 'width:100%;min-height:180px;max-height:350px;padding:16px 12px;border:2px solid var(--color-accent-pink);border-radius:12px;font-size:14px;color:#555;resize:vertical;font-family:inherit;outline:none;background:#fff;line-height:1.8;box-sizing:border-box;';

                        const btnRow = document.createElement('div');
                        btnRow.style.cssText = 'display:flex;gap:8px;justify-content:flex-end;margin-top:8px;';
                        btnRow.innerHTML = '<button class="summary-edit-cancel" style="padding:6px 14px;border-radius:14px;border:1px solid #e8e0e0;background:#fff;color:#999;font-size:12px;font-weight:600;cursor:pointer;">取消</button><button class="summary-edit-save" style="padding:6px 14px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--color-accent-pink),var(--color-accent-lavender));color:#fff;font-size:12px;font-weight:600;cursor:pointer;">保存</button>';

                        body.style.display = 'none';
                        card.querySelector('.summary-card-footer').before(textarea, btnRow);

                        btnRow.querySelector('.summary-edit-cancel').addEventListener('click', () => {
                            textarea.remove();
                            btnRow.remove();
                            body.style.display = '';
                        });

                        btnRow.querySelector('.summary-edit-save').addEventListener('click', () => {
                            const val = textarea.value.trim();
                            if (val) {
                                list[idx].text = val;
                                saveList(storagePrefix, friendId, list);
                            }
                            renderFn();
                        });
                    }

                    if (deleteBtn) {
                        const idx = parseInt(deleteBtn.dataset.index);

                        const overlay = document.createElement('div');
                        overlay.style.cssText = 'position:fixed;inset:0;z-index:2400;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;padding:24px;';
                        overlay.innerHTML = '<div style="background:linear-gradient(135deg,rgba(255,255,255,0.96),rgba(250,245,255,0.92));border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);max-width:280px;text-align:center;border:1px solid rgba(245,220,250,0.5);"><h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 12px;">删除' + typeName + '</h3><p style="color:#8b7d9c;font-size:14px;margin:0 0 24px;">确认删除这条' + typeName + '吗？</p><div style="display:flex;gap:12px;justify-content:center;"><button class="sd-yes" style="padding:10px 24px;background:linear-gradient(135deg,var(--color-accent-pink),var(--color-accent-lavender));color:#fff;border:none;border-radius:20px;font-weight:600;cursor:pointer;">删除</button><button class="sd-no" style="padding:10px 24px;background:rgba(255,255,255,0.8);color:#8b7d9c;border:1px solid rgba(240,220,250,0.4);border-radius:20px;font-weight:600;cursor:pointer;">取消</button></div></div>';

                        document.body.appendChild(overlay);

                        overlay.querySelector('.sd-yes').addEventListener('click', () => {
                            const list = getList(storagePrefix, friendId);
                            list.splice(idx, 1);
                            saveList(storagePrefix, friendId, list);
                            overlay.remove();
                            renderFn();
                        });

                        overlay.querySelector('.sd-no').addEventListener('click', () => overlay.remove());

                        overlay.addEventListener('click', (ev) => {
                            if (ev.target === overlay) overlay.remove();
                        });
                    }
                });
            }

            bindCardEvents('summaryContent', 'summaries_', '小结', renderSummaries);
            bindCardEvents('bigSummaryContent', 'bigSummaries_', '大总结', renderBigSummaries);

            // ===== 打开页面时渲染 =====
            function observeModal(id, fn) {
                const el = document.getElementById(id);
                if (!el) return;

                new MutationObserver(() => {
                    if (el.style.display !== 'none') fn();
                }).observe(el, {
                    attributes: true,
                    attributeFilter: ['style']
                });
            }

            observeModal('summaryModal', renderSummaries);
            observeModal('bigSummaryModal', renderBigSummaries);

            // ===== 总结有效性验证 =====
            function isValidSummaryText(text, minLen = 50) {
                if (!text || text.length < minLen) return false;
                const chineseRatio = (text.match(/[\u4e00-\u9fa5]/g) || []).length / text.length;
                if (chineseRatio < 0.3) return false;
                if (/^(.)\1{10,}$/.test(text)) return false;
                return true;
            }

            const COUNTER_PREFIX = 'summaryCounter_';

            function getCounter(friendId) {
                try {
                    return StorageManager.get(COUNTER_PREFIX + friendId, 0) || 0;
                } catch (e) {
                    console.warn('[总结计数器] 读取失败:', e.message);
                    return 0;
                }
            }

            function setCounter(friendId, val) {
                try {
                    StorageManager.set(COUNTER_PREFIX + friendId, val);
                } catch (e) {
                    console.warn('[总结计数器] 写入失败:', e.message);
                }
            }

            function checkAutoSummary(friendId, chatHistory, apiConfig) {
                if (!friendId) return;
                if (smallSummaryInFlight.has(friendId)) return;
                if (!canGenerateSummary(friendId, 'small')) return;

                const count = getCounter(friendId) + 1;
                const threshold = StorageManager.get(ROUNDS_KEY, 25) || 25;
                setCounter(friendId, count);

                if (count < threshold) return;

                const effectiveConfig = resolveSummaryApiConfig();
                generateAutoSummary(friendId, chatHistory, effectiveConfig, 'auto');
            }

            function resetSummaryCounter(friendId) {
                setCounter(friendId, 0);
            }

            function showSummaryFailedToast() {
                const toast = document.getElementById('cuteToast');
                if (toast) {
                    toast.querySelector('p').textContent = '总结失败，轮数已保留';
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 3000);
                }
            }

            const FAILURE_COOLDOWN_MS = 600000;

            function recordSummaryFailureTime(friendId, type) {
                const key = `summaryFailureTime_${type}_${friendId}`;
                StorageManager.set(key, Date.now());
            }

            function canGenerateSummary(friendId, type) {
                const key = `summaryFailureTime_${type}_${friendId}`;
                const lastFailTime = StorageManager.get(key);
                if (!lastFailTime) return true;
                const elapsed = Date.now() - lastFailTime;
                return elapsed > FAILURE_COOLDOWN_MS;
            }

            // ===== 大总结自动合成 =====
            function checkAndGenerateBigSummary(friendId, apiConfig) {
                if (!friendId) return;
                if (bigSummaryInFlight.has(friendId)) return;
                if (!canGenerateSummary(friendId, 'big')) return;

                const summaries = getList('summaries_', friendId);
                const unprocessed = getUnprocessedSmallSummaries(summaries);
                if (unprocessed.length < 15) return;

                generateBigSummaryAuto(friendId, summaries, apiConfig);
            }

            async function generateBigSummaryAuto(friendId, summaries, apiConfig) {
                if (!apiConfig || !apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    console.warn('[大总结] API配置缺失，跳过自动合成');
                    return;
                }

                if (bigSummaryInFlight.has(friendId)) return;
                bigSummaryInFlight.add(friendId);

                try {
                    const normalizedSummaries = summaries.map(normalizeSmallSummaryItem);
                    const unprocessed = getUnprocessedSmallSummaries(normalizedSummaries);
                    const selectedCount = Math.min(unprocessed.length, 15);
                    if (selectedCount < 15) return;

                    const wordLimit = 700;
                    const maxTokens = 1000;

                    showCuteToast('正在自动合成大总结...');

                    const selectedSummaries = unprocessed.slice(0, selectedCount);
                    const summaryTexts = selectedSummaries.map((s, idx) => `${idx + 1}. ${s.text}`).join('\n\n');

                    const prompt = `将以下${selectedCount}条小结合并为1条高度压缩的大总结。要求：拒绝流水账，洞察人性（展现用户动机/角色想法/关系变化），${wordLimit}字以内，「。」结尾。严禁添加任何开头语、结束语、解释性文字。

小结列表：
${summaryTexts}`;

                    const resp = await fetch(`${apiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + apiConfig.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: apiConfig.model,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: maxTokens,
                            temperature: 0.3
                        })
                    });

                    if (!resp.ok) {
                        recordSummaryFailureTime(friendId, 'big');
                        showSummaryFailedToast();
                        return;
                    }

                    const data = await resp.json();
                    const text = (data.choices?.[0]?.message?.content || '')
                        .replace(/<think>[\s\S]*?<\/think>/gi, '')
                        .replace(/<think>[\s\S]*/gi, '')
                        .replace(/<\/think>/gi, '')
                        .trim();

                    if (!isValidSummaryText(text, 100)) {
                        recordSummaryFailureTime(friendId, 'big');
                        showSummaryFailedToast();
                        return;
                    }

                    const bigSummaries = getList('bigSummaries_', friendId);
                    const bigSummaryId = makeSummaryId('bg');
                    bigSummaries.unshift(normalizeBigSummaryItem({
                        id: bigSummaryId,
                        text: text,
                        time: nowTime(),
                        sourceSummaryIds: selectedSummaries.map(s => s.id)
                    }));
                    saveList('bigSummaries_', friendId, bigSummaries);

                    const usedIds = new Set(selectedSummaries.map(s => s.id));
                    normalizedSummaries.forEach(s => {
                        if (usedIds.has(s.id) && !isSummaryProcessed(s)) {
                            s.processed = true;
                            s.processedByBigSummaryId = bigSummaryId;
                        }
                    });
                    saveList('summaries_', friendId, normalizedSummaries);

                    renderBigSummaries();
                    renderSummaries();
                    showCuteToast('大总结已自动生成');
                } catch (e) {
                    console.warn('[大总结] 自动合成失败:', e);
                    recordSummaryFailureTime(friendId, 'big');
                    showSummaryFailedToast();
                } finally {
                    bigSummaryInFlight.delete(friendId);
                }
            }

            // ===== 手动合成大总结 =====
            async function generateBigSummary(friendId, summaries, apiConfig) {
                if (!apiConfig || !apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    showCuteToast('API 配置不完整，请检查设置');
                    return;
                }
                if (bigSummaryInFlight.has(friendId)) {
                    showCuteToast('大总结正在生成，请稍候');
                    return;
                }

                try {
                    bigSummaryInFlight.add(friendId);

                    const normalizedSummaries = summaries.map(normalizeSmallSummaryItem);
                    const unprocessed = getUnprocessedSmallSummaries(normalizedSummaries);
                    if (unprocessed.length < 5) {
                        showCuteToast('未归档的小结不足5条');
                        return;
                    }

                    const selectedCount = await showSummaryCountSelector(unprocessed.length);
                    if (!selectedCount) return;

                    const wordLimit = Math.min(700, Math.max(200, selectedCount * 45));
                    const maxTokens = Math.min(1000, Math.max(300, selectedCount * 65));

                    showCuteToast('正在生成大总结...');

                    const selectedSummaries = unprocessed.slice(0, selectedCount);
                    const summaryTexts = selectedSummaries.map((s, idx) => `${idx + 1}. ${s.text}`).join('\n\n');

                    const prompt = `你是一位信息压缩与核心记忆提取专家。将以下${selectedCount}条小结合并为1条高度压缩的大总结。要求：拒绝流水账，洞察人性（展现用户动机/角色想法/关系变化），${wordLimit}字以内，「。」结尾。

小结列表：
${summaryTexts}`;

                    const resp = await fetch(`${apiConfig.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + apiConfig.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: apiConfig.model,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: maxTokens,
                            temperature: 0.3
                        })
                    });

                    if (!resp.ok) {
                        recordSummaryFailureTime(friendId, 'big');
                        showCuteToast(`API 请求失败 (${resp.status})，请检查配置或稍后重试`);
                        console.error('[大总结] API错误:', resp.status);
                        return;
                    }

                    const data = await resp.json();
                    const text = (data.choices?.[0]?.message?.content || '')
                        .replace(/<think>[\s\S]*?<\/think>/gi, '')
                        .replace(/<think>[\s\S]*/gi, '')
                        .replace(/<\/think>/gi, '')
                        .trim();

                    if (!isValidSummaryText(text, 100)) {
                        recordSummaryFailureTime(friendId, 'big');
                        showCuteToast('API 返回内容不足，请稍后重试');
                        console.warn('[大总结] 内容检查不过:', text?.length || 0);
                        return;
                    }

                    const bigSummaries = getList('bigSummaries_', friendId);
                    const bigSummaryId = makeSummaryId('bg');
                    bigSummaries.unshift(normalizeBigSummaryItem({
                        id: bigSummaryId,
                        text: text,
                        time: nowTime(),
                        sourceSummaryIds: selectedSummaries.map(s => s.id)
                    }));
                    saveList('bigSummaries_', friendId, bigSummaries);

                    const usedIds = new Set(selectedSummaries.map(s => s.id));
                    normalizedSummaries.forEach(s => {
                        if (usedIds.has(s.id) && !isSummaryProcessed(s)) {
                            s.processed = true;
                            s.processedByBigSummaryId = bigSummaryId;
                        }
                    });
                    saveList('summaries_', friendId, normalizedSummaries);

                    renderBigSummaries();
                    renderSummaries();
                    showCuteToast('大总结已生成');
                } catch (e) {
                    console.error('[大总结] 合成失败:', e.message);
                    recordSummaryFailureTime(friendId, 'big');
                    showCuteToast(`大总结生成失败: ${e.message}`);
                } finally {
                    bigSummaryInFlight.delete(friendId);
                }
            }

            // ===== 小结数量选择器 =====
            function showSummaryCountSelector(totalCount) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;';

                    const options = [];
                    for (let i = 5; i <= totalCount; i += 5) {
                        const wordLimit = Math.min(700, Math.max(200, i * 45));
                        options.push(`<div class="count-option" data-count="${i}" style="padding:12px 20px;margin:6px 0;background:#f8f8f8;border-radius:10px;cursor:pointer;transition:all 0.2s;border:1px solid #e0e0e0;">${i}条小结 → 约${wordLimit}字大总结</div>`);
                    }
                    if (totalCount % 5 !== 0) {
                        const wordLimit = Math.min(700, Math.max(200, totalCount * 45));
                        options.push(`<div class="count-option" data-count="${totalCount}" style="padding:12px 20px;margin:6px 0;background:#f8f8f8;border-radius:10px;cursor:pointer;transition:all 0.2s;border:1px solid #e0e0e0;">全部${totalCount}条 → 约${wordLimit}字大总结</div>`);
                    }

                    overlay.innerHTML = `<div style="background:#fff;border-radius:20px;padding:24px;box-shadow:0 8px 32px rgba(0,0,0,0.15);width:90%;max-width:320px;">
                <h3 style="color:#4a4858;font-size:16px;font-weight:600;margin:0 0 16px;text-align:center;">选择合成数量</h3>
                <div style="max-height:300px;overflow-y:auto;">${options.join('')}</div>
                <div style="display:flex;gap:8px;justify-content:center;margin-top:16px;">
                    <button class="cancel-btn" style="padding:8px 18px;border-radius:16px;border:1px solid #e8e0e0;background:#fff;color:#999;cursor:pointer;">取消</button>
                </div>
            </div>`;

                    document.body.appendChild(overlay);

                    overlay.querySelectorAll('.count-option').forEach(option => {
                        option.addEventListener('mouseover', () => {
                            option.style.background = '#e8f4fd';
                            option.style.borderColor = '#4a9eff';
                        });
                        option.addEventListener('mouseout', () => {
                            option.style.background = '#f8f8f8';
                            option.style.borderColor = '#e0e0e0';
                        });
                        option.addEventListener('click', () => {
                            const count = parseInt(option.dataset.count);
                            document.body.removeChild(overlay);
                            resolve(count);
                        });
                    });

                    overlay.querySelector('.cancel-btn').addEventListener('click', () => {
                        document.body.removeChild(overlay);
                        resolve(null);
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            document.body.removeChild(overlay);
                            resolve(null);
                        }
                    });
                });
            }

            // ===== 生成自动总结 =====
            async function generateAutoSummary(friendId, chatHistory, apiConfig, triggerSource = 'manual', retryCount = 0) {
                const isManualTrigger = triggerSource === 'manual';
                if (!apiConfig.apiUrl || !apiConfig.apiKey || !apiConfig.model) {
                    showCuteToast('API 配置不完整，请检查设置');
                    if (isManualTrigger) hideSummaryGeneratingIndicator();
                    return;
                }

                const isAutoTrigger = triggerSource === 'auto';
                if (smallSummaryInFlight.has(friendId)) {
                    showCuteToast('小结正在生成，请稍候');
                    if (isManualTrigger) hideSummaryGeneratingIndicator();
                    return;
                }

                smallSummaryInFlight.add(friendId);
                if (isManualTrigger) setManualSummaryLoading(true);

                try {
                    if (!isManualTrigger && retryCount === 0) showCuteToast('正在生成小结...');

                    const totalCount = Array.isArray(chatHistory) ? chatHistory.length : 0;
                    const lastSummaryRound = StorageManager.get(`lastSummaryIndex_${friendId}`, 0) || 0;
                    const currentRound = getCounter(friendId);

                    // 手动和自动都是一样的逻辑：从上次总结轮数之后到现在
                    let selectedMessages = chatHistory.slice(lastSummaryRound);
                    let roundStartIndex = lastSummaryRound;

                    if (selectedMessages.length === 0) {
                        showCuteToast('没有新的对话内容可供总结');
                        if (isManualTrigger) hideSummaryGeneratingIndicator();
                        return;
                    }

                    const sourceMessageIds = selectedMessages.map((m, idx) => m && m.id ? String(m.id) : ('idx:' + String(roundStartIndex + idx)));
                    const recent = selectedMessages
                        .filter(m => !m.isDeletedLocal && !m.isRecalled && m.content)
                        .map(m => {
                            const role = (m.role === 'ai' || m.role === 'assistant') ? '角色' : '用户';
                            return role + '：' + m.content;
                        }).join('\n');

                    const prompt = `请根据以下对话记录，直接生成5～8条精简总结。严禁添加任何开头语、结束语、解释性文字，只输出总结内容本身，每条一行。

【重要】总结时必须使用对话中的具体角色名（如“季燃”、“迟雨”），不要用“角色”这类泛称。

【【【总结生成规则 (重要)】】】
当需要生成对话总结时，必须遵循以下标准：
1. **拒绝流水账**：不要写成"用户发了A，AI回复了B"的事件列表。
2. **洞察人性**：每一条总结，必须至少包含以下三要素之一：
   - 用户当时的**内心动机**（为什么这么做？）
   - 角色当时的**真实想法**（角色察觉到了什么？）
   - 两人关系的**实质性变化**（关系推进/转折点）
3. **格式要求**：
   - 每条总结用「。」结尾，形成完整的句子。
   - 每条总结控制在 15-50字之间。
   - 按时间顺序排列，但不要出现"第一""第二"的序号。
4. **示例（高质量）**：
   - "迟雨终于崩溃，哭着恳求季燃不要离开。"
   - "季燃察觉到迟雨异常的沉默，告诉她不必在自己面前伪装坚强。"
   - "两人冰释前嫌，重归于好，迟雨与季燃的关系更加稳固。"

对话记录：
${recent}`;

                    const text = await requestSummaryCompletion(apiConfig, prompt, { max_tokens: 800, temperature: 0.5 });

                    if (!text) {
                        recordSummaryFailureTime(friendId, 'small');
                        showCuteToast('API 返回空内容，请检查模型或提示词');
                        console.error('[自动总结] API返回空内容');
                        if (isManualTrigger) hideSummaryGeneratingIndicator();
                        return;
                    }

                    if (!isValidSummaryText(text, 20)) {
                        if (retryCount < 2) {
                            console.warn(`[总结] 内容不合格，重试第 ${retryCount + 1} 次`);
                            smallSummaryInFlight.delete(friendId);
                            return generateAutoSummary(friendId, chatHistory, apiConfig, triggerSource, retryCount + 1);
                        } else {
                            showCuteToast('总结生成失败（内容质量不合格），轮数已保留');
                            console.error('[总结] 多次重试后仍不合格，放弃生成');
                            if (isManualTrigger) hideSummaryGeneratingIndicator();
                            return;
                        }
                    }

                    if (!text || text.length < 50) {
                        recordSummaryFailureTime(friendId, 'small');
                        showCuteToast('API 返回内容不足，请稍后重试');
                        console.warn('[总结] 内容过短:', text?.length || 0);
                        if (isManualTrigger) hideSummaryGeneratingIndicator();
                        return;
                    }

                    showSummaryConfirm(friendId, text, {
                        nextCursor: totalCount,
                        sourceStart: roundStartIndex,
                        sourceEnd: totalCount,
                        sourceMessageIds,
                        triggerSource
                    });
                } catch (e) {
                    console.error('[总结] API 调用异常:', e.message);
                    recordSummaryFailureTime(friendId, 'small');
                    showCuteToast(`总结生成失败: ${e.message}`);
                    if (isManualTrigger) hideSummaryGeneratingIndicator();
                } finally {
                    if (isManualTrigger) setManualSummaryLoading(false);
                    smallSummaryInFlight.delete(friendId);
                }
            }

            // ===== 确认弹窗 =====
            function showSummaryConfirm(friendId, text, sourceMeta) {
                hideSummaryGeneratingIndicator();

                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;z-index:2500;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;padding:20px;';
                overlay.innerHTML = `
        <div style="background:linear-gradient(135deg,rgba(255,255,255,0.97),rgba(252,248,255,0.95));border-radius:24px;padding:22px 20px;box-shadow:0 10px 40px rgba(0,0,0,0.15);width:100%;max-width:360px;max-height:60vh;overflow-y:auto;border:1px solid rgba(245,220,250,0.4);position:relative;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                <h3 style="color:#4a4858;font-size:16px;font-weight:700;margin:0;">自动总结完成</h3>
                <button class="sc-edit-toggle" title="编辑" style="width:32px;height:32px;border:none;border-radius:10px;background:#faf5f5;color:#d4a0a8;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background 0.15s;">
                    <i class="fas fa-pencil-alt"></i>
                </button>
            </div>
            <div class="sc-text-display" style="font-size:14px;color:#555;line-height:1.8;min-height:300px;max-height:500px;overflow-y:auto;word-break:break-word;white-space:pre-wrap;padding:16px 18px;background:#fdfbfd;border-radius:14px;border:1px solid #f5eff0;"></div>
            <textarea class="sc-text-edit" style="display:none;width:100%;min-height:300px;max-height:500px;padding:16px 18px;border:1.5px solid var(--color-accent-pink);border-radius:14px;font-size:14px;color:#555;resize:none;font-family:inherit;outline:none;background:#fff;box-sizing:border-box;line-height:1.8;"></textarea>
            <div style="display:flex;justify-content:center;margin-top:16px;">
                <button class="sc-confirm" style="padding:10px 36px;border-radius:20px;border:none;background:linear-gradient(135deg,var(--color-accent-pink),var(--color-accent-lavender));color:#fff;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 3px 12px rgba(120,119,133,0.15);transition:transform 0.15s;">确定</button>
            </div>
        </div>
    `;

                document.body.appendChild(overlay);

                const display = overlay.querySelector('.sc-text-display');
                const editArea = overlay.querySelector('.sc-text-edit');
                const editToggle = overlay.querySelector('.sc-edit-toggle');
                const confirmBtn = overlay.querySelector('.sc-confirm');

                display.textContent = text;
                editArea.value = text;
                let isEditing = false;

                editToggle.addEventListener('click', () => {
                    isEditing = !isEditing;
                    if (isEditing) {
                        display.style.display = 'none';
                        editArea.style.display = '';
                        editArea.focus();
                        editToggle.style.background = 'var(--color-accent-pink)';
                        editToggle.style.color = '#fff';
                    } else {
                        const val = editArea.value.trim();
                        if (val) display.textContent = val;
                        display.style.display = '';
                        editArea.style.display = 'none';
                        editToggle.style.background = '#faf5f5';
                        editToggle.style.color = '#d4a0a8';
                    }
                });

                confirmBtn.addEventListener('click', () => {
                    const finalText = isEditing ? editArea.value.trim() : display.textContent;
                    if (finalText) {
                        const list = getList('summaries_', friendId).map(normalizeSmallSummaryItem);
                        const meta = (sourceMeta && typeof sourceMeta === 'object') ? sourceMeta : {};
                        list.unshift(normalizeSmallSummaryItem({
                            id: makeSummaryId('sm'),
                            text: finalText,
                            time: nowTime(),
                            sourceStart: Number.isFinite(meta.sourceStart) ? meta.sourceStart : null,
                            sourceEnd: Number.isFinite(meta.sourceEnd) ? meta.sourceEnd : null,
                            sourceMessageIds: Array.isArray(meta.sourceMessageIds) ? meta.sourceMessageIds : [],
                            triggerSource: typeof meta.triggerSource === 'string' ? meta.triggerSource : 'manual'
                        }));
                        saveList('summaries_', friendId, list);
                        renderSummaries();
                        resetSummaryCounter(friendId);

                        if (Number.isFinite(meta.nextCursor)) {
                            StorageManager.set(`lastSummaryIndex_${friendId}`, meta.nextCursor);
                        }

                        showCuteToast('已生成1条新小结');

                        let bigSummaryConfig;
                        if (typeof apiService !== 'undefined' && apiService && typeof apiService.getConfig === 'function') {
                            bigSummaryConfig = apiService.getConfig();
                        } else {
                            bigSummaryConfig = {
                                apiUrl: StorageManager.get('apiUrl'),
                                apiKey: StorageManager.get('apiKey'),
                                model: StorageManager.get('selectedModel')
                            };
                        }
                        checkAndGenerateBigSummary(friendId, bigSummaryConfig);
                    }
                    overlay.remove();
                });
            }

            // 暴露给外部
            window.summarySystem = {
                getList,
                saveList,
                renderSummaries,
                renderBigSummaries,
                getFriendId,
                nowTime,
                checkAutoSummary
            };
        })();
        // ========== 总结系统结束 ==========

        // ========== 个人资料页面功能 ==========
        (() => {
            const defaultProfile = {
                name: '芋圆',
                sweetId: '1234567890',
                gender: 'female',
                signature: '小小世界，开心至上',
                personality: '',
                birthday: '',
                location: '',
                avatar: ''
            };

            // 打开个人资料页面（查看）
            window.openProfileModal = function (options = {}) {
                const modal = document.getElementById('profileModal');
                if (!modal) return;
                const from = (options && options.from) ? options.from : '';
                modal.dataset.from = from;
                updateStatusBarTime('profile');
                if (from === 'friendList') {
                    ModalManager.switch('friendList', 'profile');
                } else {
                    ModalManager.show('profile');
                }
                loadProfileData();
            };

            // 关闭个人资料页面
            function closeProfileModal() {
                const modal = document.getElementById('profileModal');
                if (modal) {
                    const from = modal.dataset.from || '';
                    ModalManager.hide('profile');
                    modal.dataset.from = '';
                    if (from === 'friendList') {
                        ModalManager.show('friendList');
                        const navItems = document.querySelectorAll('.friend-list-nav-item');
                        navItems.forEach(item => item.classList.remove('active'));
                        const messagesNav = document.querySelector('.friend-list-nav-item[data-nav="messages"]');
                        if (messagesNav) messagesNav.classList.add('active');
                    }
                }
            }

            let pendingProfileAvatar = '';

            // 加载个人资料数据（同时更新查看页和编辑页）
            function loadProfileData() {
                const profile = StorageManager.get('userProfile', defaultProfile);
                const p = { ...defaultProfile, ...profile };

                // 查看页
                const el = (id) => document.getElementById(id);
                el('profileDisplayName').textContent = p.name;
                el('profileIdDisplay').textContent = p.sweetId;
                el('profileSignatureDisplay').textContent = p.signature || '这个人很懒，什么都没有留下~';
                el('profileBirthdayDisplay').textContent = p.birthday || '未设置';
                el('profileLocationDisplay').textContent = p.location || '未设置';
                const personalityEl = el('profilePersonalityDisplay');
                if (personalityEl) personalityEl.textContent = p.personality || '未设置';

                // 查看页头像
                const avatarEl = el('profileAvatar');
                const avatarIconEl = el('profileAvatarIcon');
                if (p.avatar) {
                    avatarEl.style.backgroundImage = `url('${p.avatar}')`;
                    if (avatarIconEl) avatarIconEl.style.display = 'none';
                } else {
                    avatarEl.style.backgroundImage = '';
                    if (avatarIconEl) avatarIconEl.style.display = '';
                }

                // 编辑页头像
                pendingProfileAvatar = p.avatar || '';
                const avatarEditEl = el('profileAvatarEdit');
                const avatarEditIconEl = el('profileAvatarEditIcon');
                if (avatarEditEl) {
                    if (p.avatar) {
                        avatarEditEl.style.backgroundImage = `url('${p.avatar}')`;
                        if (avatarEditIconEl) avatarEditIconEl.style.display = 'none';
                    } else {
                        avatarEditEl.style.backgroundImage = '';
                        if (avatarEditIconEl) avatarEditIconEl.style.display = '';
                    }
                }
                const avatarUrlInput = el('profileAvatarUrlInput');
                if (avatarUrlInput) avatarUrlInput.value = (p.avatar && !p.avatar.startsWith('data:')) ? p.avatar : '';

                // 编辑页表单
                el('profileNameInput').value = p.name;
                el('profileIdInput').value = p.sweetId;
                el('profileSignatureInput').value = p.signature;
                el('profilePersonalityInput').value = p.personality;
                el('profileBirthdayInput').value = p.birthday;
                el('profileLocationInput').value = p.location;
                const genderRadio = document.querySelector(`input[name="gender"][value="${p.gender}"]`);
                if (genderRadio) genderRadio.checked = true;
            }

            // 保存个人资料数据
            function saveProfileData() {
                // 头像：URL输入优先，其次用文件上传的base64
                const avatarUrlVal = (document.getElementById('profileAvatarUrlInput')?.value || '').trim();
                const finalAvatar = avatarUrlVal || pendingProfileAvatar || '';

                const profile = {
                    name: document.getElementById('profileNameInput').value.trim() || defaultProfile.name,
                    sweetId: document.getElementById('profileIdInput').value.trim() || defaultProfile.sweetId,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || 'female',
                    signature: document.getElementById('profileSignatureInput').value.trim() || defaultProfile.signature,
                    personality: document.getElementById('profilePersonalityInput').value.trim(),
                    birthday: document.getElementById('profileBirthdayInput').value,
                    location: document.getElementById('profileLocationInput').value.trim(),
                    avatar: finalAvatar
                };
                StorageManager.set('userProfile', profile);
                loadProfileData();
                showCuteToast('保存成功');
                closeProfileEditModal();
            }

            // 打开编辑资料页面
            function openProfileEditModal() {
                loadProfileData();
                updateStatusBarTime('profileEdit');
                ModalManager.show('profileEdit');
            }

            // 关闭编辑资料页面
            function closeProfileEditModal() {
                ModalManager.hide('profileEdit');
            }

            function updateStatusBarTime(prefix) {
                const now = new Date();
                const h = now.getHours().toString().padStart(2, '0');
                const m = now.getMinutes().toString().padStart(2, '0');
                const timeEl = document.getElementById(`${prefix}StatusTime`);
                if (timeEl) timeEl.textContent = `${h}:${m}`;
            }

            function showCuteToast(message) {
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#ff9a9e 0%,#fecfef 100%);color:white;padding:12px 20px;border-radius:20px;font-size:14px;font-weight:600;z-index:10000;box-shadow:0 8px 25px rgba(255,154,158,0.6);animation:toastFadeIn 0.3s ease-out;';
                toast.textContent = message;
                if (!document.getElementById('toast-styles')) {
                    const style = document.createElement('style');
                    style.id = 'toast-styles';
                    style.textContent = '@keyframes toastFadeIn{0%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}@keyframes toastFadeOut{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}}';
                    document.head.appendChild(style);
                }
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'toastFadeOut 0.3s ease-in';
                    setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
                }, 2000);
            }

            // 头像上传事件
            const profileAvatarEdit = document.getElementById('profileAvatarEdit');
            const profileAvatarFileInput = document.getElementById('profileAvatarFileInput');
            const profileAvatarUrlInput = document.getElementById('profileAvatarUrlInput');

            if (profileAvatarEdit && profileAvatarFileInput) {
                profileAvatarEdit.addEventListener('click', () => profileAvatarFileInput.click());

                profileAvatarFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        pendingProfileAvatar = event.target.result;
                        profileAvatarEdit.style.backgroundImage = `url('${pendingProfileAvatar}')`;
                        const icon = document.getElementById('profileAvatarEditIcon');
                        if (icon) icon.style.display = 'none';
                        if (profileAvatarUrlInput) profileAvatarUrlInput.value = '';
                    };
                    reader.readAsDataURL(file);
                });
            }

            if (profileAvatarUrlInput) {
                profileAvatarUrlInput.addEventListener('input', (e) => {
                    const url = e.target.value.trim();
                    if (url) {
                        pendingProfileAvatar = url;
                        profileAvatarEdit.style.backgroundImage = `url('${url}')`;
                        const icon = document.getElementById('profileAvatarEditIcon');
                        if (icon) icon.style.display = 'none';
                    }
                });
            }

            // 暴露给外部
            window.closeProfileModal = closeProfileModal;
            window.openProfileEditModal = openProfileEditModal;
            window.closeProfileEditModal = closeProfileEditModal;
            window.saveProfileData = saveProfileData;
            window.profileSystem = { openProfileModal: window.openProfileModal, loadProfileData, saveProfileData, showCuteToast };
        })();
    </script>
</body>

</html>